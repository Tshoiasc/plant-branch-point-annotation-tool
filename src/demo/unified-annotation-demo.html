<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿä¸€æ ‡æ³¨ç³»ç»Ÿæ¼”ç¤º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .demo-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .status {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .demo-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .unified-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            margin: 20px 0;
        }
        
        .unified-info h4 {
            margin-top: 0;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ç»Ÿä¸€æ ‡æ³¨ç³»ç»Ÿæ¼”ç¤º</h1>
            <p>æ¼”ç¤ºè‡ªå®šä¹‰æ ‡æ³¨ä¸å¸¸è§„æ ‡æ³¨çš„ç»Ÿä¸€ç®¡ç†</p>
        </div>
        
        <div class="unified-info">
            <h4>ğŸ”„ ç»Ÿä¸€æ ‡æ³¨ç³»ç»Ÿç‰¹æ€§</h4>
            <ul>
                <li>è‡ªå®šä¹‰æ ‡æ³¨ä¸å¸¸è§„æ ‡æ³¨å­˜å‚¨åœ¨åŒä¸€ä¸ª <code>keypoints</code> æ•°ç»„ä¸­</li>
                <li>é€šè¿‡ <code>annotationType</code> å­—æ®µåŒºåˆ†æ ‡æ³¨ç±»å‹ï¼ˆ'regular' æˆ– 'custom'ï¼‰</li>
                <li>è‡ªå®šä¹‰æ ‡æ³¨åŒ…å« <code>customTypeId</code> å­—æ®µå…³è”ç±»å‹å®šä¹‰</li>
                <li>åŒºåŸŸæ ‡æ³¨åŒ…å« <code>width</code> å’Œ <code>height</code> å­—æ®µ</li>
                <li>ç»Ÿä¸€çš„åºå·ç³»ç»Ÿã€åˆ é™¤ã€æ¸…ç†å’ŒæŒä¹…åŒ–</li>
            </ul>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
            <div id="system-status" class="status">æ­£åœ¨åˆå§‹åŒ–...</div>
            <div id="keypoints-count" class="demo-results">æ€»æ ‡æ³¨æ•°: 0</div>
        </div>
        
        <div class="demo-section">
            <h3>â• åˆ›å»ºæ ‡æ³¨</h3>
            <button onclick="createRegularAnnotation()">åˆ›å»ºå¸¸è§„æ ‡æ³¨</button>
            <button onclick="createCustomPointAnnotation()">åˆ›å»ºè‡ªå®šä¹‰ç‚¹æ ‡æ³¨</button>
            <button onclick="createCustomRegionAnnotation()">åˆ›å»ºè‡ªå®šä¹‰åŒºåŸŸæ ‡æ³¨</button>
            <div id="create-results" class="demo-results">ç­‰å¾…æ“ä½œ...</div>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ—‘ï¸ åˆ é™¤æ ‡æ³¨</h3>
            <button onclick="deleteLastAnnotation()">åˆ é™¤æœ€åä¸€ä¸ªæ ‡æ³¨</button>
            <button onclick="clearAllAnnotations()">æ¸…é™¤æ‰€æœ‰æ ‡æ³¨</button>
            <div id="delete-results" class="demo-results">ç­‰å¾…æ“ä½œ...</div>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ“‹ æ ‡æ³¨åˆ—è¡¨</h3>
            <button onclick="updateAnnotationList()">åˆ·æ–°åˆ—è¡¨</button>
            <div id="annotation-list" class="demo-results">ç‚¹å‡»åˆ·æ–°æŸ¥çœ‹æ ‡æ³¨åˆ—è¡¨...</div>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
            <button onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
            <button onclick="testPersistence()">æµ‹è¯•æŒä¹…åŒ–</button>
            <div id="data-results" class="demo-results">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script type="module">
        import { AnnotationTool } from '../core/AnnotationTool.js';
        import { CustomAnnotationManager } from '../core/CustomAnnotationManager.js';
        
        // å…¨å±€å˜é‡
        let annotationTool;
        let customAnnotationManager;
        let customTypes = new Map();
        
        // æ¨¡æ‹Ÿ DOM å’Œå…¨å±€ç¯å¢ƒ
        function setupMockEnvironment() {
            // åˆ›å»ºæ¨¡æ‹Ÿçš„ canvas å…ƒç´ 
            const canvas = document.createElement('canvas');
            canvas.id = 'demo-canvas';
            canvas.width = 800;
            canvas.height = 600;
            canvas.style.display = 'none';
            document.body.appendChild(canvas);
            
            // æ¨¡æ‹Ÿå…¨å±€ç¯å¢ƒ
            window.PlantAnnotationTool = {
                appState: {
                    currentImage: { id: 'demo-image-1', name: 'demo.jpg' },
                    currentPlant: { id: 'demo-plant-1', name: 'Demo Plant' }
                }
            };
        }
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            try {
                setupMockEnvironment();
                
                // åˆ›å»ºè‡ªå®šä¹‰æ ‡æ³¨ç®¡ç†å™¨
                customAnnotationManager = new CustomAnnotationManager();
                
                // åˆ›å»ºæ ‡æ³¨å·¥å…·
                annotationTool = new AnnotationTool('demo-canvas');
                annotationTool.customAnnotationManager = customAnnotationManager;
                
                // åˆ›å»ºæµ‹è¯•ç”¨çš„è‡ªå®šä¹‰ç±»å‹
                const pointType = customAnnotationManager.createCustomType({
                    id: 'demo-point',
                    name: 'æ¼”ç¤ºç‚¹',
                    type: 'point',
                    color: '#ff6b6b'
                });
                
                const regionType = customAnnotationManager.createCustomType({
                    id: 'demo-region',
                    name: 'æ¼”ç¤ºåŒºåŸŸ',
                    type: 'region',
                    color: '#4ecdc4'
                });
                
                customTypes.set('point', pointType);
                customTypes.set('region', regionType);
                
                updateStatus('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ âœ…', 'success');
                updateKeypointsCount();
                
            } catch (error) {
                updateStatus('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('system-status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // æ›´æ–°æ ‡æ³¨è®¡æ•°
        function updateKeypointsCount() {
            const count = annotationTool ? annotationTool.keypoints.length : 0;
            const regularCount = annotationTool ? annotationTool.keypoints.filter(kp => kp.annotationType === 'regular').length : 0;
            const customCount = annotationTool ? annotationTool.keypoints.filter(kp => kp.annotationType === 'custom').length : 0;
            
            document.getElementById('keypoints-count').textContent = 
                `æ€»æ ‡æ³¨æ•°: ${count} (å¸¸è§„: ${regularCount}, è‡ªå®šä¹‰: ${customCount})`;
        }
        
        // åˆ›å»ºå¸¸è§„æ ‡æ³¨
        window.createRegularAnnotation = function() {
            try {
                const x = Math.random() * 700 + 50;
                const y = Math.random() * 500 + 50;
                const direction = Math.random() * 360;
                
                const keypoint = annotationTool.addKeypointWithDirection(x, y, direction);
                
                document.getElementById('create-results').textContent = 
                    `âœ… åˆ›å»ºå¸¸è§„æ ‡æ³¨æˆåŠŸ:\n` +
                    `ID: ${keypoint.id}\n` +
                    `ä½ç½®: (${x.toFixed(1)}, ${y.toFixed(1)})\n` +
                    `æ–¹å‘: ${direction.toFixed(1)}Â°\n` +
                    `åºå·: ${keypoint.order}\n` +
                    `ç±»å‹: ${keypoint.annotationType}`;
                
                updateKeypointsCount();
                
            } catch (error) {
                document.getElementById('create-results').textContent = 
                    `âŒ åˆ›å»ºå¸¸è§„æ ‡æ³¨å¤±è´¥: ${error.message}`;
            }
        };
        
        // åˆ›å»ºè‡ªå®šä¹‰ç‚¹æ ‡æ³¨
        window.createCustomPointAnnotation = function() {
            try {
                const x = Math.random() * 700 + 50;
                const y = Math.random() * 500 + 50;
                const pointType = customTypes.get('point');
                
                const keypoint = annotationTool.addCustomPointAnnotation(x, y, pointType.id);
                
                document.getElementById('create-results').textContent = 
                    `âœ… åˆ›å»ºè‡ªå®šä¹‰ç‚¹æ ‡æ³¨æˆåŠŸ:\n` +
                    `ID: ${keypoint.id}\n` +
                    `ä½ç½®: (${x.toFixed(1)}, ${y.toFixed(1)})\n` +
                    `ç±»å‹: ${keypoint.annotationType}\n` +
                    `è‡ªå®šä¹‰ç±»å‹: ${pointType.name} (${pointType.color})\n` +
                    `åºå·: ${keypoint.order}`;
                
                updateKeypointsCount();
                
            } catch (error) {
                document.getElementById('create-results').textContent = 
                    `âŒ åˆ›å»ºè‡ªå®šä¹‰ç‚¹æ ‡æ³¨å¤±è´¥: ${error.message}`;
            }
        };
        
        // åˆ›å»ºè‡ªå®šä¹‰åŒºåŸŸæ ‡æ³¨
        window.createCustomRegionAnnotation = function() {
            try {
                const x = Math.random() * 600 + 50;
                const y = Math.random() * 400 + 50;
                const width = Math.random() * 100 + 50;
                const height = Math.random() * 100 + 50;
                const regionType = customTypes.get('region');
                
                const keypoint = annotationTool.addCustomRegionAnnotation(x, y, width, height, regionType.id);
                
                document.getElementById('create-results').textContent = 
                    `âœ… åˆ›å»ºè‡ªå®šä¹‰åŒºåŸŸæ ‡æ³¨æˆåŠŸ:\n` +
                    `ID: ${keypoint.id}\n` +
                    `ä½ç½®: (${x.toFixed(1)}, ${y.toFixed(1)})\n` +
                    `å°ºå¯¸: ${width.toFixed(1)} Ã— ${height.toFixed(1)}\n` +
                    `ç±»å‹: ${keypoint.annotationType}\n` +
                    `è‡ªå®šä¹‰ç±»å‹: ${regionType.name} (${regionType.color})\n` +
                    `åºå·: ${keypoint.order}`;
                
                updateKeypointsCount();
                
            } catch (error) {
                document.getElementById('create-results').textContent = 
                    `âŒ åˆ›å»ºè‡ªå®šä¹‰åŒºåŸŸæ ‡æ³¨å¤±è´¥: ${error.message}`;
            }
        };
        
        // åˆ é™¤æœ€åä¸€ä¸ªæ ‡æ³¨
        window.deleteLastAnnotation = function() {
            try {
                if (annotationTool.keypoints.length === 0) {
                    document.getElementById('delete-results').textContent = 
                        `âš ï¸ æ²¡æœ‰æ ‡æ³¨å¯åˆ é™¤`;
                    return;
                }
                
                const lastKeypoint = annotationTool.keypoints[annotationTool.keypoints.length - 1];
                const info = `ID: ${lastKeypoint.id}, åºå·: ${lastKeypoint.order}, ç±»å‹: ${lastKeypoint.annotationType}`;
                
                annotationTool.removeKeypoint(lastKeypoint);
                
                document.getElementById('delete-results').textContent = 
                    `âœ… åˆ é™¤æ ‡æ³¨æˆåŠŸ:\n${info}`;
                
                updateKeypointsCount();
                
            } catch (error) {
                document.getElementById('delete-results').textContent = 
                    `âŒ åˆ é™¤æ ‡æ³¨å¤±è´¥: ${error.message}`;
            }
        };
        
        // æ¸…é™¤æ‰€æœ‰æ ‡æ³¨
        window.clearAllAnnotations = function() {
            try {
                const count = annotationTool.keypoints.length;
                annotationTool.clearKeypoints();
                
                document.getElementById('delete-results').textContent = 
                    `âœ… æ¸…é™¤æ‰€æœ‰æ ‡æ³¨æˆåŠŸï¼Œå…±åˆ é™¤ ${count} ä¸ªæ ‡æ³¨`;
                
                updateKeypointsCount();
                
            } catch (error) {
                document.getElementById('delete-results').textContent = 
                    `âŒ æ¸…é™¤æ ‡æ³¨å¤±è´¥: ${error.message}`;
            }
        };
        
        // æ›´æ–°æ ‡æ³¨åˆ—è¡¨
        window.updateAnnotationList = function() {
            try {
                const keypoints = annotationTool.keypoints;
                if (keypoints.length === 0) {
                    document.getElementById('annotation-list').textContent = 'å½“å‰æ²¡æœ‰æ ‡æ³¨';
                    return;
                }
                
                let listText = 'æ ‡æ³¨åˆ—è¡¨:\n';
                keypoints.forEach((kp, index) => {
                    listText += `${index + 1}. åºå·:${kp.order} ID:${kp.id} `;
                    listText += `ä½ç½®:(${kp.x.toFixed(1)}, ${kp.y.toFixed(1)}) `;
                    listText += `ç±»å‹:${kp.annotationType}`;
                    
                    if (kp.annotationType === 'custom') {
                        const customType = customAnnotationManager.getCustomType(kp.customTypeId);
                        listText += ` è‡ªå®šä¹‰ç±»å‹:${customType?.name || 'Unknown'}`;
                        if (kp.width && kp.height) {
                            listText += ` å°ºå¯¸:${kp.width.toFixed(1)}Ã—${kp.height.toFixed(1)}`;
                        }
                    } else {
                        listText += ` æ–¹å‘:${kp.direction}Â°`;
                    }
                    
                    listText += '\n';
                });
                
                document.getElementById('annotation-list').textContent = listText;
                
            } catch (error) {
                document.getElementById('annotation-list').textContent = 
                    `âŒ æ›´æ–°åˆ—è¡¨å¤±è´¥: ${error.message}`;
            }
        };
        
        // å¯¼å‡ºæ•°æ®
        window.exportData = function() {
            try {
                const data = annotationTool.getAnnotationData();
                const jsonData = JSON.stringify(data, null, 2);
                
                document.getElementById('data-results').textContent = 
                    `âœ… å¯¼å‡ºæ•°æ®æˆåŠŸ:\n${jsonData}`;
                
            } catch (error) {
                document.getElementById('data-results').textContent = 
                    `âŒ å¯¼å‡ºæ•°æ®å¤±è´¥: ${error.message}`;
            }
        };
        
        // æµ‹è¯•æŒä¹…åŒ–
        window.testPersistence = function() {
            try {
                // ä¿å­˜å½“å‰æ•°æ®
                const originalData = annotationTool.getAnnotationData();
                const originalCount = originalData.keypoints.length;
                
                // æ¸…ç©ºæ ‡æ³¨
                annotationTool.clearKeypoints();
                
                // é‡æ–°åŠ è½½æ•°æ®
                annotationTool.loadAnnotationData(originalData);
                
                const restoredCount = annotationTool.keypoints.length;
                
                document.getElementById('data-results').textContent = 
                    `âœ… æŒä¹…åŒ–æµ‹è¯•æˆåŠŸ:\n` +
                    `åŸå§‹æ ‡æ³¨æ•°: ${originalCount}\n` +
                    `æ¢å¤æ ‡æ³¨æ•°: ${restoredCount}\n` +
                    `æ•°æ®å®Œæ•´æ€§: ${originalCount === restoredCount ? 'é€šè¿‡' : 'å¤±è´¥'}`;
                
                updateKeypointsCount();
                
            } catch (error) {
                document.getElementById('data-results').textContent = 
                    `âŒ æŒä¹…åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        };
        
        // åˆå§‹åŒ–
        initializeSystem();
    </script>
</body>
</html>