<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰€æœ‰ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-section { margin: 30px 0; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        .test-image { max-width: 150px; max-height: 150px; border: 2px solid #ccc; margin: 5px; }
        .fix-summary { background: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ğŸ‰ æ‰€æœ‰ä¿®å¤éªŒè¯æµ‹è¯•</h1>
    
    <div class="fix-summary">
        <h3>ä¿®å¤æ‘˜è¦</h3>
        <ul>
            <li>âœ… <strong>é—®é¢˜1</strong>: ä¿®å¤äº†ç‰¹å®šç¼–å·é¢„è§ˆçš„æ¸²æŸ“é”™è¯¯</li>
            <li>âœ… <strong>é—®é¢˜2</strong>: ä¼˜åŒ–äº†å³ä¾§æ“ä½œåŒºå¸ƒå±€ï¼Œé¿å…æŒ¤å‹</li>
            <li>âœ… <strong>é—®é¢˜3</strong>: æ·»åŠ äº†å…¨å±åŠ è½½æŒ‡ç¤ºå™¨å’Œè‡ªåŠ¨è¿æ¥åŠŸèƒ½</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”§ ä¿®å¤1: é¢„è§ˆå›¾æ¸²æŸ“æµ‹è¯•</h2>
        <p>æµ‹è¯•BranchPointPreviewManagerä¸­çš„renderSpecificOrderPreviewæ–¹æ³•</p>
        <button onclick="testPreviewRendering()">æµ‹è¯•é¢„è§ˆå›¾æ¸²æŸ“</button>
        <div id="preview-results"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“ ä¿®å¤2: å¸ƒå±€æµ‹è¯•</h2>
        <p>éªŒè¯CSSå¸ƒå±€ä¼˜åŒ–ï¼Œç¡®ä¿æ“ä½œåŒºå†…å®¹ä¸ä¼šæŒ¤å‹</p>
        <button onclick="testLayoutOptimization()">æ£€æŸ¥å¸ƒå±€è®¾ç½®</button>
        <div id="layout-results"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸš€ ä¿®å¤3: è‡ªåŠ¨è¿æ¥æµ‹è¯•</h2>
        <p>éªŒè¯å…¨å±åŠ è½½æŒ‡ç¤ºå™¨å’Œè‡ªåŠ¨è¿æ¥åŠŸèƒ½</p>
        <button onclick="testAutoConnection()">æµ‹è¯•è‡ªåŠ¨è¿æ¥é€»è¾‘</button>
        <div id="autoconnect-results"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸŒ åç«¯çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkBackendStatus()">æ£€æŸ¥åç«¯æœåŠ¡</button>
        <div id="backend-status"></div>
    </div>

    <script type="module">
        import { HttpFileSystemManager } from './src/core/HttpFileSystemManager.js';
        import { PlantDataManager } from './src/core/PlantDataManager.js';
        
        window.fileSystemManager = new HttpFileSystemManager();
        window.plantDataManager = new PlantDataManager();
        
        window.testPreviewRendering = async function() {
            const resultsDiv = document.getElementById('preview-results');
            resultsDiv.innerHTML = '<div class="status info">æµ‹è¯•é¢„è§ˆå›¾æ¸²æŸ“é€»è¾‘...</div>';
            
            try {
                await window.plantDataManager.initialize();
                
                // è·å–æ¤ç‰©æ•°æ®
                const plants = await window.plantDataManager.fileSystemManager.traversePlantDirectories();
                if (plants.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°æ¤ç‰©æ•°æ®');
                }
                
                const firstPlant = plants[0];
                const imagesByView = await window.plantDataManager.fileSystemManager.readPlantImages(firstPlant.id);
                
                let testResults = '<div class="status success">âœ… æˆåŠŸè·å–æ¤ç‰©å›¾åƒæ•°æ®</div>';
                
                // æµ‹è¯•å›¾åƒURLç”Ÿæˆï¼ˆè¿™æ˜¯é¢„è§ˆæ¸²æŸ“çš„æ ¸å¿ƒï¼‰
                for (const [viewAngle, images] of Object.entries(imagesByView)) {
                    if (images.length > 0) {
                        const testImage = images[0];
                        
                        try {
                            // æ¨¡æ‹ŸBranchPointPreviewManagerä¸­çš„URLç”Ÿæˆé€»è¾‘
                            let imageURL;
                            
                            // æµ‹è¯•æ–°çš„ä¼˜å…ˆçº§é¡ºåº
                            if (testImage.url) {
                                imageURL = testImage.url;
                                testResults += '<div class="status success">âœ… æ–¹å¼1: ä½¿ç”¨ç°æœ‰URL</div>';
                            } else {
                                imageURL = await window.fileSystemManager.createImageURL(testImage);
                                testResults += '<div class="status success">âœ… æ–¹å¼2: é€šè¿‡FileSystemManageråˆ›å»ºURL</div>';
                            }
                            
                            testResults += `<div class="status info">ç”Ÿæˆçš„URL: ${imageURL}</div>`;
                            
                            // éªŒè¯URLå¯è®¿é—®æ€§
                            const response = await fetch(imageURL, { method: 'HEAD' });
                            if (response.ok) {
                                testResults += '<div class="status success">âœ… é¢„è§ˆå›¾URLå¯è®¿é—®ï¼Œæ¸²æŸ“é”™è¯¯å·²ä¿®å¤</div>';
                            } else {
                                testResults += `<div class="status error">âŒ URLä¸å¯è®¿é—® (${response.status})</div>`;
                            }
                            
                        } catch (error) {
                            testResults += `<div class="status error">âŒ URLç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
                        }
                        break;
                    }
                }
                
                resultsDiv.innerHTML = testResults;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">âŒ é¢„è§ˆæ¸²æŸ“æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        window.testLayoutOptimization = function() {
            const resultsDiv = document.getElementById('layout-results');
            
            // æ£€æŸ¥CSSç±»æ˜¯å¦æ­£ç¡®åº”ç”¨
            const checks = [
                {
                    name: 'instruction-panel å‹ç¼©é—´è·',
                    selector: '.instruction-panel',
                    property: 'padding',
                    expected: /var\(--spacing-sm\)|8px|0.5rem/,
                    description: 'æ“ä½œé¢æ¿åº”ä½¿ç”¨å‹ç¼©é—´è·'
                },
                {
                    name: 'instructions-section å¼¹æ€§å¸ƒå±€',
                    selector: '.instructions-section',
                    property: 'flex',
                    expected: /0 1 auto/,
                    description: 'æŒ‡ä»¤éƒ¨åˆ†åº”å…è®¸æ”¶ç¼©é¿å…æŒ¤å‹'
                },
                {
                    name: 'direction-legend å›ºå®šä½ç½®',
                    selector: '.direction-legend',
                    property: 'margin-top',
                    expected: /auto/,
                    description: 'å›¾ä¾‹åº”æ¨åˆ°å¯ç”¨ç©ºé—´åº•éƒ¨'
                },
                {
                    name: 'å…¨å±åŠ è½½å™¨æ ·å¼',
                    selector: '.fullscreen-loading',
                    property: 'position',
                    expected: /fixed/,
                    description: 'å…¨å±åŠ è½½å™¨åº”è¦†ç›–æ•´ä¸ªå±å¹•'
                }
            ];
            
            let results = '<div class="status info">æ£€æŸ¥CSSå¸ƒå±€ä¼˜åŒ–...</div>';
            let passCount = 0;
            
            checks.forEach(check => {
                try {
                    // åˆ›å»ºä¸´æ—¶å…ƒç´ æ¥æµ‹è¯•æ ·å¼
                    const tempElement = document.createElement('div');
                    tempElement.className = check.selector.replace('.', '');
                    document.body.appendChild(tempElement);
                    
                    const computedStyle = window.getComputedStyle(tempElement);
                    const actualValue = computedStyle.getPropertyValue(check.property);
                    
                    const passed = check.expected.test(actualValue) || actualValue.includes('var(--spacing-sm)');
                    
                    if (passed) {
                        results += `<div class="status success">âœ… ${check.name}: ${actualValue}</div>`;
                        passCount++;
                    } else {
                        results += `<div class="status error">âŒ ${check.name}: æœŸæœ› ${check.expected}, å®é™… ${actualValue}</div>`;
                    }
                    
                    document.body.removeChild(tempElement);
                } catch (error) {
                    results += `<div class="status error">âŒ ${check.name}: æ£€æŸ¥å¤±è´¥ - ${error.message}</div>`;
                }
            });
            
            const successRate = (passCount / checks.length * 100).toFixed(0);
            results += `<div class="status info">å¸ƒå±€ä¼˜åŒ–æ£€æŸ¥å®Œæˆ: ${passCount}/${checks.length} é¡¹é€šè¿‡ (${successRate}%)</div>`;
            
            if (passCount === checks.length) {
                results += '<div class="status success">ğŸ‰ æ‰€æœ‰å¸ƒå±€ä¼˜åŒ–å‡å·²æ­£ç¡®åº”ç”¨ï¼</div>';
            }
            
            resultsDiv.innerHTML = results;
        };
        
        window.testAutoConnection = function() {
            const resultsDiv = document.getElementById('autoconnect-results');
            
            let results = '<div class="status info">æ£€æŸ¥è‡ªåŠ¨è¿æ¥åŠŸèƒ½...</div>';
            
            // æ£€æŸ¥å…¨å±åŠ è½½å™¨å…ƒç´ 
            const fullscreenLoader = document.getElementById('fullscreen-loading');
            if (fullscreenLoader) {
                results += '<div class="status success">âœ… å…¨å±åŠ è½½å™¨å…ƒç´ å­˜åœ¨</div>';
                
                // æ£€æŸ¥CSSæ ·å¼
                const style = window.getComputedStyle(fullscreenLoader);
                if (style.position === 'fixed') {
                    results += '<div class="status success">âœ… å…¨å±åŠ è½½å™¨æ ·å¼æ­£ç¡®</div>';
                } else {
                    results += '<div class="status error">âŒ å…¨å±åŠ è½½å™¨æ ·å¼ä¸æ­£ç¡®</div>';
                }
            } else {
                results += '<div class="status error">âŒ å…¨å±åŠ è½½å™¨å…ƒç´ ä¸å­˜åœ¨</div>';
            }
            
            // æ£€æŸ¥header-controlsæ˜¯å¦è¢«éšè—
            const headerControls = document.querySelector('.header-controls');
            if (headerControls) {
                const style = window.getComputedStyle(headerControls);
                if (style.display === 'none') {
                    results += '<div class="status success">âœ… æ•°æ®é›†é€‰æ‹©æŒ‰é’®å·²éšè—</div>';
                } else {
                    results += '<div class="status error">âŒ æ•°æ®é›†é€‰æ‹©æŒ‰é’®æœªéšè—</div>';
                }
            }
            
            // æ£€æŸ¥å¿…è¦çš„JavaScriptå‡½æ•°
            const functions = ['updateFullscreenLoading', 'hideFullscreenLoading', 'autoConnectDataset'];
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    results += `<div class="status success">âœ… ${funcName} å‡½æ•°å­˜åœ¨</div>`;
                } else {
                    results += `<div class="status error">âŒ ${funcName} å‡½æ•°ä¸å­˜åœ¨</div>`;
                }
            });
            
            results += '<div class="status info">ğŸ’¡ åœ¨ä¸»åº”ç”¨ä¸­ï¼Œé¡µé¢å°†è‡ªåŠ¨è¿æ¥æ•°æ®é›†å¹¶æ˜¾ç¤ºåŠ è½½è¿›åº¦</div>';
            
            resultsDiv.innerHTML = results;
        };
        
        window.checkBackendStatus = async function() {
            const resultsDiv = document.getElementById('backend-status');
            resultsDiv.innerHTML = '<div class="status info">æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€...</div>';
            
            try {
                const endpoints = [
                    { name: 'å¥åº·æ£€æŸ¥', url: 'http://localhost:3003/api/health' },
                    { name: 'æ¤ç‰©ç›®å½•', url: 'http://localhost:3003/api/plant-directories' },
                    { name: 'è·³è¿‡ä¿¡æ¯', url: 'http://localhost:3003/api/skip-info' },
                    { name: 'æ•°æ®é›†ä¿¡æ¯', url: 'http://localhost:3003/api/dataset-info' }
                ];
                
                let results = '';
                let successCount = 0;
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint.url);
                        const data = await response.json();
                        
                        if (data.success) {
                            results += `<div class="status success">âœ… ${endpoint.name}: æ­£å¸¸</div>`;
                            successCount++;
                        } else {
                            results += `<div class="status error">âŒ ${endpoint.name}: ${data.error}</div>`;
                        }
                    } catch (error) {
                        results += `<div class="status error">âŒ ${endpoint.name}: è¿æ¥å¤±è´¥</div>`;
                    }
                }
                
                const healthRate = (successCount / endpoints.length * 100).toFixed(0);
                results += `<div class="status info">åç«¯å¥åº·çŠ¶æ€: ${successCount}/${endpoints.length} ç«¯ç‚¹æ­£å¸¸ (${healthRate}%)</div>`;
                
                if (successCount === endpoints.length) {
                    results += '<div class="status success">ğŸ‰ åç«¯æœåŠ¡å®Œå…¨æ­£å¸¸ï¼Œæ‰€æœ‰ä¿®å¤åŠŸèƒ½å¯ç”¨ï¼</div>';
                }
                
                resultsDiv.innerHTML = results;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">âŒ åç«¯çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        };
    </script>
</body>
</html>