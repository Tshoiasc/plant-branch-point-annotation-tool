<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能测试 - 缩略图和跳过信息</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        .image-test { margin: 20px 0; }
        .thumbnail { max-width: 150px; max-height: 150px; margin: 5px; border: 1px solid #ccc; }
        .image-info { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>功能测试 - 缩略图和跳过信息</h1>
    
    <div class="test-section">
        <h2>后端连接测试</h2>
        <button onclick="testConnection()">测试连接</button>
        <div id="connection-results"></div>
    </div>
    
    <div class="test-section">
        <h2>跳过信息测试</h2>
        <button onclick="testSkipInfo()">获取跳过信息</button>
        <div id="skip-results"></div>
    </div>
    
    <div class="test-section">
        <h2>缩略图测试</h2>
        <button onclick="testThumbnails()">测试缩略图加载</button>
        <div id="thumbnail-results"></div>
    </div>

    <script type="module">
        import { HttpFileSystemManager } from './src/core/HttpFileSystemManager.js';
        import { PlantDataManager } from './src/core/PlantDataManager.js';
        
        window.fileSystemManager = new HttpFileSystemManager();
        window.plantDataManager = new PlantDataManager();
        
        window.testConnection = async function() {
            const resultsDiv = document.getElementById('connection-results');
            resultsDiv.innerHTML = '<div class="status info">测试后端连接...</div>';
            
            try {
                await window.fileSystemManager.initialize();
                const health = await fetch('http://localhost:3003/api/health');
                const healthData = await health.json();
                
                resultsDiv.innerHTML = `
                    <div class="status success">✅ 后端连接成功!</div>
                    <pre>${JSON.stringify(healthData, null, 2)}</pre>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">❌ 后端连接失败: ${error.message}</div>`;
            }
        };
        
        window.testSkipInfo = async function() {
            const resultsDiv = document.getElementById('skip-results');
            resultsDiv.innerHTML = '<div class="status info">获取跳过信息...</div>';
            
            try {
                const skipInfo = await window.fileSystemManager.getAllSkipInfo();
                
                resultsDiv.innerHTML = `
                    <div class="status success">✅ 跳过信息获取成功!</div>
                    <div class="status info">找到 ${Object.keys(skipInfo).length} 个跳过的植物:</div>
                    <pre>${JSON.stringify(skipInfo, null, 2)}</pre>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">❌ 获取跳过信息失败: ${error.message}</div>`;
            }
        };
        
        window.testThumbnails = async function() {
            const resultsDiv = document.getElementById('thumbnail-results');
            resultsDiv.innerHTML = '<div class="status info">测试缩略图加载...</div>';
            
            try {
                // 初始化植物数据管理器
                await window.plantDataManager.initialize();
                
                // 获取植物列表
                const plants = await window.plantDataManager.fileSystemManager.traversePlantDirectories();
                
                if (plants.length === 0) {
                    resultsDiv.innerHTML = '<div class="status error">❌ 未找到植物数据</div>';
                    return;
                }
                
                // 获取第一个植物的图像
                const firstPlant = plants[0];
                const imagesByView = await window.plantDataManager.fileSystemManager.readPlantImages(firstPlant.id);
                
                let html = `<div class="status success">✅ 找到 ${plants.length} 个植物</div>`;
                html += `<div class="status info">测试植物: ${firstPlant.id}</div>`;
                
                // 测试第一个视角的前3张图像
                for (const [viewAngle, images] of Object.entries(imagesByView)) {
                    if (images.length > 0) {
                        html += `<div class="image-test">`;
                        html += `<h3>视角: ${viewAngle} (${images.length} 张图像)</h3>`;
                        
                        // 测试前3张图像
                        const testImages = images.slice(0, 3);
                        
                        for (const imageData of testImages) {
                            try {
                                const imageUrl = await window.plantDataManager.fileSystemManager.createImageURL(imageData);
                                
                                html += `<div style="display: inline-block; margin: 10px;">`;
                                html += `<img src="${imageUrl}" class="thumbnail" onload="this.style.border='2px solid green'" onerror="this.style.border='2px solid red'">`;
                                html += `<div class="image-info">`;
                                html += `ID: ${imageData.id}<br>`;
                                html += `URL: ${imageUrl}<br>`;
                                html += `Size: ${imageData.size} bytes`;
                                html += `</div>`;
                                html += `</div>`;
                            } catch (error) {
                                html += `<div class="status error">❌ 图像URL生成失败: ${error.message}</div>`;
                                console.error('图像URL生成失败:', error, imageData);
                            }
                        }
                        
                        html += `</div>`;
                        break; // 只测试第一个视角
                    }
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">❌ 缩略图测试失败: ${error.message}</div>`;
                console.error('缩略图测试失败:', error);
            }
        };
    </script>
</body>
</html>