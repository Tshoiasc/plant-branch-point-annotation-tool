System.register([],function(t,n){"use strict";return{execute:function(){t("CustomAnnotationRenderer",class{constructor(t,n){this.annotationTool=t,this.customAnnotationManager=n,this.ctx=t.ctx,this.canvas=t.canvas,this.config={basePointRadius:8,minPointRadius:4,maxPointRadius:20,pointScaleFactor:.8,pointBorderColor:"#ffffff",pointBorderWidth:2,regionBorderWidth:2,regionFillAlpha:.2,baseLabelFontSize:12,labelOffset:16,labelThresholdScale:.6,tinyThresholdScale:.3,hoverAlpha:.8,selectedAlpha:.9},this.hoveredAnnotation=null,this.selectedAnnotation=null,this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,console.log("CustomAnnotationRenderer initialized")}getCustomAnnotationDisplayStrategy(){const t=this.annotationTool.state.scale;let n;if(t>=1.5){const i=Math.max(10,Math.min(16,12*t)),o=Math.max(8,.7*i),e=Math.min(12,8+2*(t-1.5));n=Math.min(o,e),n=Math.max(8,n)}else n=3+1.5*(t-.1),n=Math.max(3,Math.min(6,n));return{scale:t,radius:n,showInternalLabel:t>=1.5,showExternalLabel:t>=this.config.tinyThresholdScale,showMinimalMode:t<this.config.tinyThresholdScale,fontSize:Math.max(10,Math.min(16,12*t)),directionFontSize:Math.max(8,Math.min(12,10*t)),labelOffset:Math.max(8,this.config.labelOffset*Math.min(t,1.5)),borderWidth:Math.max(1,Math.min(3,this.config.pointBorderWidth*t))}}renderCustomAnnotations(t){if(!t)return;const n=this.customAnnotationManager.getAnnotationsByImageId(t);if(0===n.length&&!this.annotationTool.state.isCustomRegionDragging)return;const i=this.getCustomAnnotationDisplayStrategy(),o=n.filter(t=>{const n=this.customAnnotationManager.getCustomType(t.typeId);return"point"===n?.type});n.filter(t=>{const n=this.customAnnotationManager.getCustomType(t.typeId);return"region"===n?.type}).forEach(t=>{this.renderRegionAnnotation(t,i)}),o.forEach(t=>{this.renderPointAnnotation(t,i)}),this.renderDragPreview(i)}renderPointAnnotation(t,n){const i=this.customAnnotationManager.getCustomType(t.typeId);if(!i)return;const o=this.annotationTool.imageToScreen(t.x,t.y);let e=1;this.hoveredAnnotation===t?e=this.config.hoverAlpha:this.selectedAnnotation===t&&(e=this.config.selectedAlpha),this.ctx.save(),this.ctx.globalAlpha=e,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n.radius,0,2*Math.PI),this.ctx.fillStyle=i.color,this.ctx.fill(),this.ctx.strokeStyle=this.config.pointBorderColor,this.ctx.lineWidth=n.borderWidth,this.ctx.stroke(),n.showInternalLabel?(this.ctx.fillStyle=this.config.pointBorderColor,this.ctx.font=`bold ${n.fontSize}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.order.toString(),o.x,o.y)):n.showExternalLabel?this.renderPointLabel(t,o,i,e,n):n.showMinimalMode&&this.hoveredAnnotation===t&&this.createTooltip(o.x,o.y,t.order,i,t,n),this.ctx.restore()}renderRegionAnnotation(t,n){const i=this.customAnnotationManager.getCustomType(t.typeId);if(!i)return;const o=this.annotationTool.imageToScreen(t.x,t.y),e=this.annotationTool.imageToScreen(t.x+t.width,t.y+t.height),s=e.x-o.x,a=e.y-o.y;let r=1;this.hoveredAnnotation===t?r=this.config.hoverAlpha:this.selectedAnnotation===t&&(r=this.config.selectedAlpha),this.ctx.save(),this.ctx.globalAlpha=r,this.ctx.fillStyle=i.color,this.ctx.globalAlpha=r*this.config.regionFillAlpha,this.ctx.fillRect(o.x,o.y,s,a),this.ctx.globalAlpha=r,this.ctx.strokeStyle=i.color,this.ctx.lineWidth=n.borderWidth,this.ctx.strokeRect(o.x,o.y,s,a);const h=o.x+s/2,l=o.y+a/2;n.showInternalLabel&&Math.min(s,a)>20&&(this.ctx.fillStyle=i.color,this.ctx.font=`bold ${n.fontSize}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.order.toString(),h,l)),n.showExternalLabel&&this.renderRegionLabel(t,{x:h,y:o.y},i,r,n),this.ctx.restore()}renderPointLabel(t,n,i,o,e){const s=n.y-e.radius-e.labelOffset;this.ctx.save(),this.ctx.globalAlpha=o;const a=`${i.name} #${t.order}`;this.ctx.font=`${e.fontSize}px Arial`;const r=this.ctx.measureText(a).width;this.ctx.fillStyle=i.color,this.ctx.fillRect(n.x-r/2-4,s-e.fontSize/2-4,r+8,e.fontSize+8),this.ctx.fillStyle="#ffffff",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,n.x,s),this.ctx.restore()}renderRegionLabel(t,n,i,o,e){const s=n.y-e.labelOffset;this.ctx.save(),this.ctx.globalAlpha=o;const a=`${i.name} #${t.order}`;this.ctx.font=`${e.fontSize}px Arial`;const r=this.ctx.measureText(a).width;this.ctx.fillStyle=i.color,this.ctx.fillRect(n.x-r/2-4,s-e.fontSize/2-4,r+8,e.fontSize+8),this.ctx.fillStyle="#ffffff",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,n.x,s),this.ctx.restore()}getCustomAnnotationAt(t,n){if(!n)return null;const i=this.customAnnotationManager.getAnnotationsByImageId(n),o=i.filter(t=>{const n=this.customAnnotationManager.getCustomType(t.typeId);return"point"===n?.type}),e=i.filter(t=>{const n=this.customAnnotationManager.getCustomType(t.typeId);return"region"===n?.type});for(const s of o)if(this.isPointInAnnotation(t,s))return s;for(const s of e)if(this.isPointInAnnotation(t,s))return s;return null}isPointInAnnotation(t,n){const i=this.customAnnotationManager.getCustomType(n.typeId);if(!i)return!1;const o=this.getCustomAnnotationDisplayStrategy();if("point"===i.type){const i=this.annotationTool.imageToScreen(n.x,n.y);return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))<=o.radius+5}if("region"===i.type){const i=this.annotationTool.imageToScreen(n.x,n.y),o=this.annotationTool.imageToScreen(n.x+n.width,n.y+n.height);return t.x>=i.x&&t.x<=o.x&&t.y>=i.y&&t.y<=o.y}return!1}setHoveredAnnotation(t){this.hoveredAnnotation=t}setSelectedAnnotation(t){this.selectedAnnotation=t}getHoveredAnnotation(){return this.hoveredAnnotation}getSelectedAnnotation(){return this.selectedAnnotation}clearHover(){this.hoveredAnnotation=null}clearSelection(){this.selectedAnnotation=null}createTooltip(t,n,i,o,e,s){const a=this.canvas,r=a.parentElement,h=r.querySelector(".custom-annotation-tooltip");h&&h.remove();const l=document.createElement("div");l.className="custom-annotation-tooltip",l.style.cssText="\n      position: absolute;\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      padding: 6px 10px;\n      border-radius: 4px;\n      font-size: 12px;\n      z-index: 1000;\n      pointer-events: none;\n      white-space: nowrap;\n    ";const c=`(${Math.round(e.x)}, ${Math.round(e.y)})`;l.innerHTML=`\n      <div>${o.name} #${i}</div>\n      <div style="font-size: 10px; opacity: 0.8;">Position: ${c}</div>\n    `;const g=a.getBoundingClientRect(),d=r.getBoundingClientRect(),x=g.left-d.left,f=g.top-d.top;l.style.left=x+t-60+"px",l.style.top=f+n-60+"px",r.appendChild(l),setTimeout(()=>{l.parentElement&&l.remove()},2e3)}renderDragPreview(t){if(!this.annotationTool.state.isCustomRegionDragging)return;const n=this.annotationTool.state.customRegionStartPoint,i=this.annotationTool.state.customRegionCurrentPoint;if(!n||!i)return;const o=this.customAnnotationManager.getCurrentCustomType();if(!o||"region"!==o.type)return;const e=Math.min(n.x,i.x),s=Math.min(n.y,i.y),a=Math.abs(i.x-n.x),r=Math.abs(i.y-n.y);this.ctx.save(),this.ctx.globalAlpha=.5,this.ctx.fillStyle=o.color,this.ctx.fillRect(e,s,a,r),this.ctx.strokeStyle=o.color,this.ctx.lineWidth=t?t.borderWidth:2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(e,s,a,r),this.ctx.globalAlpha=.8,this.ctx.fillStyle="#000000",this.ctx.font=`${t?t.fontSize:12}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle";const h=`${Math.round(a)}x${Math.round(r)}`;this.ctx.fillText(h,e+a/2,s+r/2),this.ctx.restore()}renderPointPreview(t,n){n&&"point"===n.type&&(this.ctx.save(),this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,this.config.pointRadius,0,2*Math.PI),this.ctx.fillStyle=n.color,this.ctx.fill(),this.ctx.strokeStyle=this.config.pointBorderColor,this.ctx.lineWidth=this.config.pointBorderWidth,this.ctx.setLineDash([3,3]),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle=this.config.pointBorderColor,this.ctx.font=`bold ${this.config.labelFontSize}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("?",t.x,t.y),this.ctx.restore())}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}startDrag(t,n){this.draggedAnnotation=t,this.dragStartPosition={screen:n,annotation:{x:t.x,y:t.y,...t.width&&{width:t.width},...t.height&&{height:t.height}}},this.dragCurrentPosition=n,this.isDragging=!0,console.log("Started dragging custom annotation:",t.id)}updateDrag(t){if(!this.isDragging||!this.draggedAnnotation||!this.dragStartPosition)return!1;this.dragCurrentPosition=t;const n=t.x-this.dragStartPosition.screen.x,i=t.y-this.dragStartPosition.screen.y,o=n/this.annotationTool.state.scale,e=i/this.annotationTool.state.scale;return this.draggedAnnotation.x=this.dragStartPosition.annotation.x+o,this.draggedAnnotation.y=this.dragStartPosition.annotation.y+e,this.constrainAnnotationPosition(this.draggedAnnotation),!0}finishDrag(){if(!this.isDragging||!this.draggedAnnotation)return null;const t=this.draggedAnnotation,n=this.dragStartPosition,i=Math.abs(t.x-n.annotation.x)>1||Math.abs(t.y-n.annotation.y)>1;return this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,console.log("Finished dragging custom annotation:",t.id,"Moved:",i),{annotation:t,moved:i,startPosition:n.annotation}}cancelDrag(){this.isDragging&&this.draggedAnnotation&&this.dragStartPosition&&(this.draggedAnnotation.x=this.dragStartPosition.annotation.x,this.draggedAnnotation.y=this.dragStartPosition.annotation.y,this.dragStartPosition.annotation.width&&(this.draggedAnnotation.width=this.dragStartPosition.annotation.width),this.dragStartPosition.annotation.height&&(this.draggedAnnotation.height=this.dragStartPosition.annotation.height),this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,console.log("Cancelled dragging custom annotation"))}constrainAnnotationPosition(t){if(!this.annotationTool.imageElement)return;const n=this.annotationTool.imageElement.width,i=this.annotationTool.imageElement.height;t.x=Math.max(0,Math.min(n,t.x)),t.y=Math.max(0,Math.min(i,t.y)),t.width&&t.height&&(t.width=Math.min(t.width,n-t.x),t.height=Math.min(t.height,i-t.y))}isDraggingAnnotation(){return this.isDragging}getDraggedAnnotation(){return this.draggedAnnotation}renderDragPreview(t){if(!this.isDragging||!this.draggedAnnotation)return;const n=this.customAnnotationManager.getCustomType(this.draggedAnnotation.typeId);n&&(this.ctx.save(),this.ctx.globalAlpha=.6,"point"===n.type?this.renderPointAnnotation(this.draggedAnnotation,t):"region"===n.type&&this.renderRegionAnnotation(this.draggedAnnotation,t),this.ctx.restore())}})}}});
//# sourceMappingURL=CustomAnnotationRenderer-legacy-BimQP5Wt.js.map
