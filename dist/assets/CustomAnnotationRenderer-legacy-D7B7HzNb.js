System.register([],function(t,i){"use strict";return{execute:function(){t("CustomAnnotationRenderer",class{constructor(t,i){this.annotationTool=t,this.customAnnotationManager=i,this.ctx=t.ctx,this.canvas=t.canvas,this.config={basePointRadius:8,minPointRadius:4,maxPointRadius:20,pointScaleFactor:.8,pointBorderColor:"#ffffff",pointBorderWidth:2,regionBorderWidth:2,regionFillAlpha:.2,baseLabelFontSize:12,labelOffset:16,labelThresholdScale:.6,tinyThresholdScale:.3,hoverAlpha:.8,selectedAlpha:.9},this.hoveredAnnotation=null,this.selectedAnnotation=null,this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,this.dragMode="move",this.dragHandle=null,console.log("CustomAnnotationRenderer initialized")}getCustomAnnotationDisplayStrategy(){const t=this.annotationTool.state.scale;let i;if(t>=1.5){const n=Math.max(10,Math.min(16,12*t)),o=Math.max(8,.7*n),e=Math.min(12,8+2*(t-1.5));i=Math.min(o,e),i=Math.max(8,i)}else i=3+1.5*(t-.1),i=Math.max(3,Math.min(6,i));return{scale:t,radius:i,showInternalLabel:t>=1.5,showExternalLabel:t>=this.config.tinyThresholdScale,showMinimalMode:t<this.config.tinyThresholdScale,fontSize:Math.max(10,Math.min(16,12*t)),directionFontSize:Math.max(8,Math.min(12,10*t)),labelOffset:Math.max(8,this.config.labelOffset*Math.min(t,1.5)),borderWidth:Math.max(1,Math.min(3,this.config.pointBorderWidth*t))}}renderCustomAnnotations(t){if(!t)return;const i=this.customAnnotationManager.getAnnotationsByImageId(t);if(0===i.length&&!this.annotationTool.state.isCustomRegionDragging)return;const n=this.getCustomAnnotationDisplayStrategy(),o=i.filter(t=>{const i=this.customAnnotationManager.getCustomType(t.typeId||t.customTypeId);return"point"===i?.type});i.filter(t=>{const i=this.customAnnotationManager.getCustomType(t.typeId||t.customTypeId);return"region"===i?.type}).forEach(t=>{this.renderRegionAnnotation(t,n)}),o.forEach(t=>{this.renderPointAnnotation(t,n)}),this.renderDragPreview(n)}renderPointAnnotation(t,i){const n=t.typeId||t.customTypeId,o=this.customAnnotationManager.getCustomType(n);if(!o)return;const e=this.annotationTool.imageToScreen(t.x,t.y);let a=1;this.hoveredAnnotation===t?a=this.config.hoverAlpha:this.selectedAnnotation===t&&(a=this.config.selectedAlpha),this.ctx.save(),this.ctx.globalAlpha=a,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i.radius,0,2*Math.PI),this.ctx.fillStyle=o.color,this.ctx.fill(),this.ctx.strokeStyle=this.config.pointBorderColor,this.ctx.lineWidth=i.borderWidth,this.ctx.stroke(),i.showInternalLabel?(this.ctx.fillStyle=this.config.pointBorderColor,this.ctx.font=`bold ${i.fontSize}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.order.toString(),e.x,e.y)):i.showExternalLabel?this.renderPointLabel(t,e,o,a,i):i.showMinimalMode&&this.hoveredAnnotation===t&&this.createTooltip(e.x,e.y,t.order,o,t,i),this.ctx.restore()}renderRegionAnnotation(t,i){const n=t.typeId||t.customTypeId,o=this.customAnnotationManager.getCustomType(n);if(!o)return;const e=this.annotationTool.imageToScreen(t.x,t.y),a=this.annotationTool.imageToScreen(t.x+t.width,t.y+t.height),s=a.x-e.x,h=a.y-e.y;let r=1;this.hoveredAnnotation===t?r=this.config.hoverAlpha:this.selectedAnnotation===t&&(r=this.config.selectedAlpha),this.ctx.save(),this.ctx.globalAlpha=r,this.ctx.fillStyle=o.color,this.ctx.globalAlpha=r*this.config.regionFillAlpha,this.ctx.fillRect(e.x,e.y,s,h),this.ctx.globalAlpha=r,this.ctx.strokeStyle=o.color,this.ctx.lineWidth=i.borderWidth,this.ctx.strokeRect(e.x,e.y,s,h);const l=e.x+s/2,c=e.y+h/2;if(i.showInternalLabel&&Math.min(s,h)>20&&(this.ctx.fillStyle=o.color,this.ctx.font=`bold ${i.fontSize}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.order.toString(),l,c)),i.showExternalLabel&&this.renderRegionLabel(t,{x:l,y:e.y},o,r,i),this.ctx.restore(),this.selectedAnnotation===t){const t=Math.max(8,Math.min(14,10*(i?.scale||1))),n=t/2,a=[{x:e.x,y:e.y},{x:e.x+s,y:e.y},{x:e.x,y:e.y+h},{x:e.x+s,y:e.y+h}],r=[{x:e.x+s/2,y:e.y},{x:e.x+s/2,y:e.y+h},{x:e.x,y:e.y+h/2},{x:e.x+s,y:e.y+h/2}];this.ctx.save(),this.ctx.fillStyle="#ffffff",this.ctx.strokeStyle=o.color,this.ctx.lineWidth=1.5,a.forEach(i=>{this.ctx.fillRect(i.x-n,i.y-n,t,t),this.ctx.strokeRect(i.x-n,i.y-n,t,t)}),r.forEach(i=>{this.ctx.fillRect(i.x-n,i.y-n,t,t),this.ctx.strokeRect(i.x-n,i.y-n,t,t)}),this.ctx.restore()}}getRegionHandleAt(t,i){const n=i.typeId||i.customTypeId,o=this.customAnnotationManager.getCustomType(n);if(!o||"region"!==o.type)return null;const e=this.annotationTool.imageToScreen(i.x,i.y),a=this.annotationTool.imageToScreen(i.x+i.width,i.y+i.height),s={x:(e.x+a.x)/2,y:(e.y+a.y)/2},h=this.annotationTool.state.scale||1,r=Math.max(8,Math.min(14,10*h))/2;function l(i){return Math.abs(t.x-i.x)<=r&&Math.abs(t.y-i.y)<=r}return l(e)?"nw":l({x:a.x,y:e.y})?"ne":l({x:e.x,y:a.y})?"sw":l(a)?"se":l({x:s.x,y:e.y})?"n":l({x:s.x,y:a.y})?"s":l({x:e.x,y:s.y})?"w":l({x:a.x,y:s.y})?"e":null}renderPointLabel(t,i,n,o,e){const a=i.y-e.radius-e.labelOffset;this.ctx.save(),this.ctx.globalAlpha=o;const s=`${n.name} #${t.order}`;this.ctx.font=`${e.fontSize}px Arial`;const h=this.ctx.measureText(s).width;this.ctx.fillStyle=n.color,this.ctx.fillRect(i.x-h/2-4,a-e.fontSize/2-4,h+8,e.fontSize+8),this.ctx.fillStyle="#ffffff",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(s,i.x,a),this.ctx.restore()}renderRegionLabel(t,i,n,o,e){const a=i.y-e.labelOffset;this.ctx.save(),this.ctx.globalAlpha=o;const s=`${n.name} #${t.order}`;this.ctx.font=`${e.fontSize}px Arial`;const h=this.ctx.measureText(s).width;this.ctx.fillStyle=n.color,this.ctx.fillRect(i.x-h/2-4,a-e.fontSize/2-4,h+8,e.fontSize+8),this.ctx.fillStyle="#ffffff",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(s,i.x,a),this.ctx.restore()}getCustomAnnotationAt(t,i){if(!i)return null;const n=this.customAnnotationManager.getAnnotationsByImageId(i),o=n.filter(t=>{const i=this.customAnnotationManager.getCustomType(t.typeId);return"point"===i?.type}),e=n.filter(t=>{const i=this.customAnnotationManager.getCustomType(t.typeId);return"region"===i?.type});for(const a of o)if(this.isPointInAnnotation(t,a))return a;for(const a of e)if(this.isPointInAnnotation(t,a))return a;return null}isPointInAnnotation(t,i){const n=i.typeId||i.customTypeId,o=this.customAnnotationManager.getCustomType(n);if(!o)return!1;const e=this.getCustomAnnotationDisplayStrategy();if("point"===o.type){const n=this.annotationTool.imageToScreen(i.x,i.y);return Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))<=e.radius+5}if("region"===o.type){const n=this.annotationTool.imageToScreen(i.x,i.y),o=this.annotationTool.imageToScreen(i.x+i.width,i.y+i.height);return t.x>=n.x&&t.x<=o.x&&t.y>=n.y&&t.y<=o.y}return!1}setHoveredAnnotation(t){this.hoveredAnnotation=t}setSelectedAnnotation(t){this.selectedAnnotation=t}getHoveredAnnotation(){return this.hoveredAnnotation}getSelectedAnnotation(){return this.selectedAnnotation}clearHover(){this.hoveredAnnotation=null}clearSelection(){this.selectedAnnotation=null}createTooltip(t,i,n,o,e,a){const s=this.canvas,h=s.parentElement,r=h.querySelector(".custom-annotation-tooltip");r&&r.remove();const l=document.createElement("div");l.className="custom-annotation-tooltip",l.style.cssText="\n      position: absolute;\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      padding: 6px 10px;\n      border-radius: 4px;\n      font-size: 12px;\n      z-index: 1000;\n      pointer-events: none;\n      white-space: nowrap;\n    ";const c=`(${Math.round(e.x)}, ${Math.round(e.y)})`;l.innerHTML=`\n      <div>${o.name} #${n}</div>\n      <div style="font-size: 10px; opacity: 0.8;">Position: ${c}</div>\n    `;const g=s.getBoundingClientRect(),d=h.getBoundingClientRect(),x=g.left-d.left,y=g.top-d.top;l.style.left=x+t-60+"px",l.style.top=y+i-60+"px",h.appendChild(l),setTimeout(()=>{l.parentElement&&l.remove()},2e3)}renderDragPreview(t){if(!this.annotationTool.state.isCustomRegionDragging)return;const i=this.annotationTool.state.customRegionStartPoint,n=this.annotationTool.state.customRegionCurrentPoint;if(!i||!n)return;const o=this.customAnnotationManager.getCurrentCustomType();if(!o||"region"!==o.type)return;const e=Math.min(i.x,n.x),a=Math.min(i.y,n.y),s=Math.abs(n.x-i.x),h=Math.abs(n.y-i.y);this.ctx.save(),this.ctx.globalAlpha=.5,this.ctx.fillStyle=o.color,this.ctx.fillRect(e,a,s,h),this.ctx.strokeStyle=o.color,this.ctx.lineWidth=t?t.borderWidth:2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(e,a,s,h),this.ctx.globalAlpha=.8,this.ctx.fillStyle="#000000",this.ctx.font=`${t?t.fontSize:12}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle";const r=`${Math.round(s)}x${Math.round(h)}`;this.ctx.fillText(r,e+s/2,a+h/2),this.ctx.restore()}renderPointPreview(t,i){i&&"point"===i.type&&(this.ctx.save(),this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,this.config.pointRadius,0,2*Math.PI),this.ctx.fillStyle=i.color,this.ctx.fill(),this.ctx.strokeStyle=this.config.pointBorderColor,this.ctx.lineWidth=this.config.pointBorderWidth,this.ctx.setLineDash([3,3]),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle=this.config.pointBorderColor,this.ctx.font=`bold ${this.config.labelFontSize}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("?",t.x,t.y),this.ctx.restore())}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}startDrag(t,i,n=null){this.draggedAnnotation=t,this.dragStartPosition={screen:i,annotation:{x:t.x,y:t.y,...t.width&&{width:t.width},...t.height&&{height:t.height}}},this.dragCurrentPosition=i,this.isDragging=!0,this.dragHandle=n,this.dragMode=n?"resize":"move",console.log("Started dragging custom annotation:",t.id)}updateDrag(t){if(!this.isDragging||!this.draggedAnnotation||!this.dragStartPosition)return!1;this.dragCurrentPosition=t;const i=t.x-this.dragStartPosition.screen.x,n=t.y-this.dragStartPosition.screen.y,o=i/this.annotationTool.state.scale,e=n/this.annotationTool.state.scale,a=this.draggedAnnotation,s=this.dragStartPosition.annotation;if("resize"===this.dragMode&&s.width&&s.height){let t=s.x,i=s.y,n=s.width,h=s.height;switch(this.dragHandle){case"n":i=s.y+e,h=s.height-e;break;case"s":h=s.height+e;break;case"w":t=s.x+o,n=s.width-o;break;case"e":n=s.width+o;break;case"nw":t=s.x+o,n=s.width-o,i=s.y+e,h=s.height-e;break;case"ne":i=s.y+e,h=s.height-e,n=s.width+o;break;case"sw":t=s.x+o,n=s.width-o,h=s.height+e;break;case"se":n=s.width+o,h=s.height+e}const r=2/this.annotationTool.state.scale;n=Math.max(r,n),h=Math.max(r,h),a.x=t,a.y=i,a.width=n,a.height=h,this.constrainAnnotationPosition(a)}else a.x=s.x+o,a.y=s.y+e,this.constrainAnnotationPosition(a);return!0}finishDrag(){if(!this.isDragging||!this.draggedAnnotation)return null;const t=this.draggedAnnotation,i=this.dragStartPosition,n=Math.abs(t.x-i.annotation.x)>1||Math.abs(t.y-i.annotation.y)>1||i.annotation.width&&Math.abs((t.width||0)-i.annotation.width)>1||i.annotation.height&&Math.abs((t.height||0)-i.annotation.height)>1;return this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,console.log("Finished dragging custom annotation:",t.id,"Moved:",n),{annotation:t,moved:n,startPosition:i.annotation}}cancelDrag(){this.isDragging&&this.draggedAnnotation&&this.dragStartPosition&&(this.draggedAnnotation.x=this.dragStartPosition.annotation.x,this.draggedAnnotation.y=this.dragStartPosition.annotation.y,this.dragStartPosition.annotation.width&&(this.draggedAnnotation.width=this.dragStartPosition.annotation.width),this.dragStartPosition.annotation.height&&(this.draggedAnnotation.height=this.dragStartPosition.annotation.height),this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,console.log("Cancelled dragging custom annotation"))}constrainAnnotationPosition(t){if(!this.annotationTool.imageElement)return;const i=this.annotationTool.imageElement.width,n=this.annotationTool.imageElement.height;t.x=Math.max(0,Math.min(i,t.x)),t.y=Math.max(0,Math.min(n,t.y)),t.width&&t.height&&(t.width=Math.min(t.width,i-t.x),t.height=Math.min(t.height,n-t.y))}isDraggingAnnotation(){return this.isDragging}getDraggedAnnotation(){return this.draggedAnnotation}renderDragPreview(t){if(!this.isDragging||!this.draggedAnnotation)return;const i=this.draggedAnnotation.typeId||this.draggedAnnotation.customTypeId,n=this.customAnnotationManager.getCustomType(i);n&&(this.ctx.save(),this.ctx.globalAlpha=.6,"point"===n.type?this.renderPointAnnotation(this.draggedAnnotation,t):"region"===n.type&&this.renderRegionAnnotation(this.draggedAnnotation,t),this.ctx.restore())}})}}});
//# sourceMappingURL=CustomAnnotationRenderer-legacy-D7B7HzNb.js.map
