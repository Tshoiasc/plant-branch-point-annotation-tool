class m{constructor(t,i){this.annotationTool=t,this.customAnnotationManager=i,this.ctx=t.ctx,this.canvas=t.canvas,this.config={basePointRadius:8,minPointRadius:4,maxPointRadius:20,pointScaleFactor:.8,pointBorderColor:"#ffffff",pointBorderWidth:2,regionBorderWidth:2,regionFillAlpha:.2,baseLabelFontSize:12,labelOffset:16,labelThresholdScale:.6,tinyThresholdScale:.3,hoverAlpha:.8,selectedAlpha:.9},this.hoveredAnnotation=null,this.selectedAnnotation=null,this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,console.log("CustomAnnotationRenderer initialized")}getCustomAnnotationDisplayStrategy(){const t=this.annotationTool.state.scale,i=3;let n;if(t>=1.5){const o=Math.max(10,Math.min(16,12*t)),s=Math.max(8,o*.7),e=Math.min(12,8+(t-1.5)*2);n=Math.min(s,e),n=Math.max(8,n)}else n=i+(t-.1)*1.5,n=Math.max(i,Math.min(6,n));return{scale:t,radius:n,showInternalLabel:t>=1.5,showExternalLabel:t>=this.config.tinyThresholdScale,showMinimalMode:t<this.config.tinyThresholdScale,fontSize:Math.max(10,Math.min(16,12*t)),directionFontSize:Math.max(8,Math.min(12,10*t)),labelOffset:Math.max(8,this.config.labelOffset*Math.min(t,1.5)),borderWidth:Math.max(1,Math.min(3,this.config.pointBorderWidth*t))}}renderCustomAnnotations(t){if(!t)return;const i=this.customAnnotationManager.getAnnotationsByImageId(t);if(i.length===0&&!this.annotationTool.state.isCustomRegionDragging)return;const n=this.getCustomAnnotationDisplayStrategy(),o=i.filter(e=>{const a=this.customAnnotationManager.getCustomType(e.typeId);return(a==null?void 0:a.type)==="point"});i.filter(e=>{const a=this.customAnnotationManager.getCustomType(e.typeId);return(a==null?void 0:a.type)==="region"}).forEach(e=>{this.renderRegionAnnotation(e,n)}),o.forEach(e=>{this.renderPointAnnotation(e,n)}),this.renderDragPreview(n)}renderPointAnnotation(t,i){const n=this.customAnnotationManager.getCustomType(t.typeId);if(!n)return;const o=this.annotationTool.imageToScreen(t.x,t.y);let s=1;this.hoveredAnnotation===t?s=this.config.hoverAlpha:this.selectedAnnotation===t&&(s=this.config.selectedAlpha),this.ctx.save(),this.ctx.globalAlpha=s,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,i.radius,0,2*Math.PI),this.ctx.fillStyle=n.color,this.ctx.fill(),this.ctx.strokeStyle=this.config.pointBorderColor,this.ctx.lineWidth=i.borderWidth,this.ctx.stroke(),i.showInternalLabel?(this.ctx.fillStyle=this.config.pointBorderColor,this.ctx.font="bold ".concat(i.fontSize,"px Arial"),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.order.toString(),o.x,o.y)):i.showExternalLabel?this.renderPointLabel(t,o,n,s,i):i.showMinimalMode&&this.hoveredAnnotation===t&&this.createTooltip(o.x,o.y,t.order,n,t,i),this.ctx.restore()}renderRegionAnnotation(t,i){const n=this.customAnnotationManager.getCustomType(t.typeId);if(!n)return;const o=this.annotationTool.imageToScreen(t.x,t.y),s=this.annotationTool.imageToScreen(t.x+t.width,t.y+t.height),e=s.x-o.x,a=s.y-o.y;let h=1;this.hoveredAnnotation===t?h=this.config.hoverAlpha:this.selectedAnnotation===t&&(h=this.config.selectedAlpha),this.ctx.save(),this.ctx.globalAlpha=h,this.ctx.fillStyle=n.color,this.ctx.globalAlpha=h*this.config.regionFillAlpha,this.ctx.fillRect(o.x,o.y,e,a),this.ctx.globalAlpha=h,this.ctx.strokeStyle=n.color,this.ctx.lineWidth=i.borderWidth,this.ctx.strokeRect(o.x,o.y,e,a);const l=o.x+e/2,r=o.y+a/2;i.showInternalLabel&&Math.min(e,a)>20&&(this.ctx.fillStyle=n.color,this.ctx.font="bold ".concat(i.fontSize,"px Arial"),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.order.toString(),l,r)),i.showExternalLabel&&this.renderRegionLabel(t,{x:l,y:o.y},n,h,i),this.ctx.restore()}renderPointLabel(t,i,n,o,s){const e=i.y-s.radius-s.labelOffset;this.ctx.save(),this.ctx.globalAlpha=o;const a="".concat(n.name," #").concat(t.order);this.ctx.font="".concat(s.fontSize,"px Arial");const l=this.ctx.measureText(a).width,r=4;this.ctx.fillStyle=n.color,this.ctx.fillRect(i.x-l/2-r,e-s.fontSize/2-r,l+r*2,s.fontSize+r*2),this.ctx.fillStyle="#ffffff",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,i.x,e),this.ctx.restore()}renderRegionLabel(t,i,n,o,s){const e=i.y-s.labelOffset;this.ctx.save(),this.ctx.globalAlpha=o;const a="".concat(n.name," #").concat(t.order);this.ctx.font="".concat(s.fontSize,"px Arial");const l=this.ctx.measureText(a).width,r=4;this.ctx.fillStyle=n.color,this.ctx.fillRect(i.x-l/2-r,e-s.fontSize/2-r,l+r*2,s.fontSize+r*2),this.ctx.fillStyle="#ffffff",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,i.x,e),this.ctx.restore()}getCustomAnnotationAt(t,i){if(!i)return null;const n=this.customAnnotationManager.getAnnotationsByImageId(i),o=n.filter(e=>{const a=this.customAnnotationManager.getCustomType(e.typeId);return(a==null?void 0:a.type)==="point"}),s=n.filter(e=>{const a=this.customAnnotationManager.getCustomType(e.typeId);return(a==null?void 0:a.type)==="region"});for(const e of o)if(this.isPointInAnnotation(t,e))return e;for(const e of s)if(this.isPointInAnnotation(t,e))return e;return null}isPointInAnnotation(t,i){const n=this.customAnnotationManager.getCustomType(i.typeId);if(!n)return!1;const o=this.getCustomAnnotationDisplayStrategy();if(n.type==="point"){const s=this.annotationTool.imageToScreen(i.x,i.y);return Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2))<=o.radius+5}else if(n.type==="region"){const s=this.annotationTool.imageToScreen(i.x,i.y),e=this.annotationTool.imageToScreen(i.x+i.width,i.y+i.height);return t.x>=s.x&&t.x<=e.x&&t.y>=s.y&&t.y<=e.y}return!1}setHoveredAnnotation(t){this.hoveredAnnotation=t}setSelectedAnnotation(t){this.selectedAnnotation=t}getHoveredAnnotation(){return this.hoveredAnnotation}getSelectedAnnotation(){return this.selectedAnnotation}clearHover(){this.hoveredAnnotation=null}clearSelection(){this.selectedAnnotation=null}createTooltip(t,i,n,o,s,e){const a=this.canvas,h=a.parentElement,l=h.querySelector(".custom-annotation-tooltip");l&&l.remove();const r=document.createElement("div");r.className="custom-annotation-tooltip",r.style.cssText="\n      position: absolute;\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      padding: 6px 10px;\n      border-radius: 4px;\n      font-size: 12px;\n      z-index: 1000;\n      pointer-events: none;\n      white-space: nowrap;\n    ";const d="(".concat(Math.round(s.x),", ").concat(Math.round(s.y),")");r.innerHTML="\n      <div>".concat(o.name," #").concat(n,'</div>\n      <div style="font-size: 10px; opacity: 0.8;">Position: ').concat(d,"</div>\n    ");const c=a.getBoundingClientRect(),g=h.getBoundingClientRect(),x=c.left-g.left,f=c.top-g.top;r.style.left=x+t-60+"px",r.style.top=f+i-60+"px",h.appendChild(r),setTimeout(()=>{r.parentElement&&r.remove()},2e3)}renderDragPreview(t){if(!this.annotationTool.state.isCustomRegionDragging)return;const i=this.annotationTool.state.customRegionStartPoint,n=this.annotationTool.state.customRegionCurrentPoint;if(!i||!n)return;const o=this.customAnnotationManager.getCurrentCustomType();if(!o||o.type!=="region")return;const s=Math.min(i.x,n.x),e=Math.min(i.y,n.y),a=Math.abs(n.x-i.x),h=Math.abs(n.y-i.y);this.ctx.save(),this.ctx.globalAlpha=.5,this.ctx.fillStyle=o.color,this.ctx.fillRect(s,e,a,h),this.ctx.strokeStyle=o.color,this.ctx.lineWidth=t?t.borderWidth:2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(s,e,a,h),this.ctx.globalAlpha=.8,this.ctx.fillStyle="#000000",this.ctx.font="".concat(t?t.fontSize:12,"px Arial"),this.ctx.textAlign="center",this.ctx.textBaseline="middle";const l="".concat(Math.round(a),"x").concat(Math.round(h));this.ctx.fillText(l,s+a/2,e+h/2),this.ctx.restore()}renderPointPreview(t,i){!i||i.type!=="point"||(this.ctx.save(),this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,this.config.pointRadius,0,2*Math.PI),this.ctx.fillStyle=i.color,this.ctx.fill(),this.ctx.strokeStyle=this.config.pointBorderColor,this.ctx.lineWidth=this.config.pointBorderWidth,this.ctx.setLineDash([3,3]),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle=this.config.pointBorderColor,this.ctx.font="bold ".concat(this.config.labelFontSize,"px Arial"),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("?",t.x,t.y),this.ctx.restore())}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}startDrag(t,i){this.draggedAnnotation=t,this.dragStartPosition={screen:i,annotation:{x:t.x,y:t.y,...t.width&&{width:t.width},...t.height&&{height:t.height}}},this.dragCurrentPosition=i,this.isDragging=!0,console.log("Started dragging custom annotation:",t.id)}updateDrag(t){if(!this.isDragging||!this.draggedAnnotation||!this.dragStartPosition)return!1;this.dragCurrentPosition=t;const i=t.x-this.dragStartPosition.screen.x,n=t.y-this.dragStartPosition.screen.y,o=i/this.annotationTool.state.scale,s=n/this.annotationTool.state.scale;return this.draggedAnnotation.x=this.dragStartPosition.annotation.x+o,this.draggedAnnotation.y=this.dragStartPosition.annotation.y+s,this.constrainAnnotationPosition(this.draggedAnnotation),!0}finishDrag(){if(!this.isDragging||!this.draggedAnnotation)return null;const t=this.draggedAnnotation,i=this.dragStartPosition,n=Math.abs(t.x-i.annotation.x)>1||Math.abs(t.y-i.annotation.y)>1;return this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,console.log("Finished dragging custom annotation:",t.id,"Moved:",n),{annotation:t,moved:n,startPosition:i.annotation}}cancelDrag(){!this.isDragging||!this.draggedAnnotation||!this.dragStartPosition||(this.draggedAnnotation.x=this.dragStartPosition.annotation.x,this.draggedAnnotation.y=this.dragStartPosition.annotation.y,this.dragStartPosition.annotation.width&&(this.draggedAnnotation.width=this.dragStartPosition.annotation.width),this.dragStartPosition.annotation.height&&(this.draggedAnnotation.height=this.dragStartPosition.annotation.height),this.draggedAnnotation=null,this.dragStartPosition=null,this.dragCurrentPosition=null,this.isDragging=!1,console.log("Cancelled dragging custom annotation"))}constrainAnnotationPosition(t){if(!this.annotationTool.imageElement)return;const i=this.annotationTool.imageElement.width,n=this.annotationTool.imageElement.height;t.x=Math.max(0,Math.min(i,t.x)),t.y=Math.max(0,Math.min(n,t.y)),t.width&&t.height&&(t.width=Math.min(t.width,i-t.x),t.height=Math.min(t.height,n-t.y))}isDraggingAnnotation(){return this.isDragging}getDraggedAnnotation(){return this.draggedAnnotation}renderDragPreview(t){if(!this.isDragging||!this.draggedAnnotation)return;const i=this.customAnnotationManager.getCustomType(this.draggedAnnotation.typeId);i&&(this.ctx.save(),this.ctx.globalAlpha=.6,i.type==="point"?this.renderPointAnnotation(this.draggedAnnotation,t):i.type==="region"&&this.renderRegionAnnotation(this.draggedAnnotation,t),this.ctx.restore())}}export{m as CustomAnnotationRenderer};
//# sourceMappingURL=CustomAnnotationRenderer-DqFeI3UH.js.map
