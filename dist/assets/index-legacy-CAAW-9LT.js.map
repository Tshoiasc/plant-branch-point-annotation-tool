{"version":3,"file":"index-legacy-CAAW-9LT.js","sources":["../../src/core/HttpFileSystemManager.js","../../src/core/AnnotationStorageManager.js","../../src/core/TimeSeriesAnnotationManager.js","../../src/core/PlantDataManager.js","../../src/core/AnnotationTool.js","../../src/core/BranchPointPreviewManager.js","../../src/core/NoteManager.js","../../src/core/NoteUI.js","../../src/core/AnnotationManager.js","../../src/utils/BulkLoadingPerformanceMonitor.js","../../src/core/RealTimeSyncManager.js","../../src/core/CustomAnnotationToolbarController.js","../../src/core/CustomAnnotationSettingsController.js","../../src/main.js"],"sourcesContent":["/**\n * HTTPæ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨\n * \n * åŠŸèƒ½ï¼š\n * - é€šè¿‡HTTPè¯·æ±‚ä¸åç«¯é€šä¿¡\n * - æ›¿ä»£ç›´æ¥æ–‡ä»¶ç³»ç»Ÿè®¿é—®\n * - æ”¯æŒæ¤ç‰©æ•°æ®å’Œæ ‡æ³¨æ–‡ä»¶ç®¡ç†\n */\n\nexport class HttpFileSystemManager {\n  constructor() {\n    this.baseUrl = 'http://localhost:3003/api';\n    this.datasetPath = '/Users/tshoiasc/Brassica napus dataset/dataset';\n    this.isInitialized = false;\n    this.maxRetries = 3;\n    this.retryDelay = 1000;\n    this.connectionTimeout = 5000;\n    this.lastConnectionCheck = 0;\n    this.connectionCheckInterval = 30000;\n  }\n\n  /**\n   * åˆå§‹åŒ–ç®¡ç†å™¨ï¼Œå¸¦é‡è¯•æœºåˆ¶\n   */\n  async initialize() {\n    return this.withRetry(async () => {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), this.connectionTimeout);\n      \n      try {\n        const response = await fetch(`${this.baseUrl}/health`, {\n          signal: controller.signal,\n          headers: { 'Cache-Control': 'no-cache' }\n        });\n        \n        clearTimeout(timeoutId);\n        \n        if (!response.ok) {\n          throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n        }\n        \n        const result = await response.json();\n        \n        if (result.success) {\n          this.isInitialized = true;\n          this.lastConnectionCheck = Date.now();\n          console.log('HttpFileSystemManager åˆå§‹åŒ–æˆåŠŸ');\n          return true;\n        }\n        \n        throw new Error('Backend server responded but reported failure');\n      } catch (error) {\n        clearTimeout(timeoutId);\n        if (error.name === 'AbortError') {\n          throw new Error(`è¿æ¥è¶…æ—¶ (${this.connectionTimeout}ms)`);\n        }\n        throw error;\n      }\n    }, 'åˆå§‹åŒ–ç®¡ç†å™¨');\n  }\n\n  /**\n   * æ£€æŸ¥æ˜¯å¦æ”¯æŒï¼ˆå§‹ç»ˆè¿”å›trueï¼Œå› ä¸ºä½¿ç”¨HTTPï¼‰\n   */\n  static isSupported() {\n    return true;\n  }\n\n  /**\n   * é‡è¯•æœºåˆ¶åŒ…è£…å™¨\n   */\n  async withRetry(operation, operationName = 'æ“ä½œ', maxRetries = this.maxRetries) {\n    let lastError;\n    \n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\n      try {\n        if (attempt > 1) {\n          console.log(`${operationName} é‡è¯•ç¬¬ ${attempt - 1} æ¬¡...`);\n          await this.delay(this.retryDelay * attempt);\n        }\n        \n        return await operation();\n      } catch (error) {\n        lastError = error;\n        \n        if (this.isConnectionError(error) && attempt < maxRetries) {\n          console.warn(`${operationName} å¤±è´¥ (å°è¯• ${attempt}/${maxRetries}):`, error.message);\n          continue;\n        }\n        \n        console.error(`${operationName} æœ€ç»ˆå¤±è´¥:`, error);\n        throw error;\n      }\n    }\n    \n    throw lastError;\n  }\n  \n  /**\n   * æ£€æŸ¥æ˜¯å¦ä¸ºè¿æ¥é”™è¯¯\n   */\n  isConnectionError(error) {\n    return error.message.includes('Failed to fetch') ||\n           error.message.includes('ERR_CONNECTION_REFUSED') ||\n           error.message.includes('ç½‘ç»œé”™è¯¯') ||\n           error.message.includes('è¿æ¥è¶…æ—¶') ||\n           error.name === 'TypeError' && error.message.includes('fetch');\n  }\n  \n  /**\n   * å»¶è¿Ÿå‡½æ•°\n   */\n  delay(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n  \n  /**\n   * æ£€æŸ¥è¿æ¥çŠ¶æ€\n   */\n  async checkConnection() {\n    const now = Date.now();\n    if (now - this.lastConnectionCheck < this.connectionCheckInterval) {\n      return this.isInitialized;\n    }\n    \n    try {\n      const controller = new AbortController();\n      setTimeout(() => controller.abort(), 2000);\n      \n      const response = await fetch(`${this.baseUrl}/health`, {\n        signal: controller.signal,\n        headers: { 'Cache-Control': 'no-cache' }\n      });\n      \n      const isConnected = response.ok;\n      this.isInitialized = isConnected;\n      this.lastConnectionCheck = now;\n      \n      return isConnected;\n    } catch (error) {\n      this.isInitialized = false;\n      this.lastConnectionCheck = now;\n      return false;\n    }\n  }\n  \n  /**\n   * è·å–æ•°æ®é›†ä¿¡æ¯\n   */\n  async getDatasetInfo() {\n    await this.ensureConnection();\n    \n    return this.withRetry(async () => {\n      const response = await fetch(`${this.baseUrl}/dataset-info`);\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        return result.data;\n      }\n      \n      throw new Error(result.error || 'è·å–æ•°æ®é›†ä¿¡æ¯å¤±è´¥');\n    }, 'è·å–æ•°æ®é›†ä¿¡æ¯');\n  }\n  \n  /**\n   * ç¡®ä¿è¿æ¥å¯ç”¨\n   */\n  async ensureConnection() {\n    if (!(await this.checkConnection())) {\n      throw new Error('åç«¯æœåŠ¡è¿æ¥ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œåœ¨ http://localhost:3003');\n    }\n  }\n\n  /**\n   * éå†æ¤ç‰©æ–‡ä»¶å¤¹\n   */\n  async traversePlantDirectories() {\n    await this.ensureConnection();\n    \n    return this.withRetry(async () => {\n      const response = await fetch(`${this.baseUrl}/plant-directories`);\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`æ‰¾åˆ° ${result.data.length} ä¸ªæœ‰æ•ˆæ¤ç‰©æ–‡ä»¶å¤¹`);\n        return result.data;\n      }\n      \n      throw new Error(result.error || 'éå†æ¤ç‰©æ–‡ä»¶å¤¹å¤±è´¥');\n    }, 'éå†æ¤ç‰©æ–‡ä»¶å¤¹');\n  }\n\n  /**\n   * è¯»å–æ¤ç‰©çš„å›¾åƒæ–‡ä»¶\n   */\n  async readPlantImages(plantId) {\n    if (!plantId) {\n      throw new Error('æ¤ç‰©IDä¸èƒ½ä¸ºç©º');\n    }\n    \n    await this.ensureConnection();\n    \n    return this.withRetry(async () => {\n      const response = await fetch(`${this.baseUrl}/plant-images/${encodeURIComponent(plantId)}`);\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        const imagesByView = result.data;\n        \n        const totalImages = Object.values(imagesByView).reduce((total, images) => total + images.length, 0);\n        console.log(`æ¤ç‰© ${plantId} æ€»å…± ${totalImages} å¼ å›¾åƒ`);\n        \n        return imagesByView;\n      }\n      \n      throw new Error(result.error || 'è¯»å–æ¤ç‰©å›¾åƒå¤±è´¥');\n    }, `è¯»å–æ¤ç‰© ${plantId} å›¾åƒ`);\n  }\n\n  /**\n   * è·å–å›¾åƒæ–‡ä»¶URL\n   */\n  getImageUrl(plantId, viewAngle, imageName) {\n    return `${this.baseUrl}/image/${plantId}/${viewAngle}/${imageName}`;\n  }\n\n  /**\n   * åˆ›å»ºå›¾åƒURL (æ›¿ä»£createImageURL)\n   */\n  async createImageURL(imageData) {\n    try {\n      console.log('åˆ›å»ºå›¾åƒURLï¼ŒimageData:', imageData);\n      \n      // ä»imageDataä¸­æå–ä¿¡æ¯\n      const parts = imageData.id.split('_');\n      console.log('å›¾åƒIDåˆ†å‰²ç»“æœ:', parts);\n      \n      if (parts.length >= 3) {\n        const plantId = parts[0];\n        const viewAngle = parts[1];\n        const imageName = parts.slice(2).join('_'); // å¤„ç†æ–‡ä»¶åä¸­å¯èƒ½åŒ…å«ä¸‹åˆ’çº¿çš„æƒ…å†µ\n        \n        const imageUrl = this.getImageUrl(plantId, viewAngle, imageName);\n        console.log('ç”Ÿæˆçš„å›¾åƒURL:', imageUrl);\n        \n        return imageUrl;\n      }\n      \n      throw new Error(`Invalid image data format. ID: ${imageData.id}, expected format: plantId_viewAngle_imageName`);\n    } catch (error) {\n      console.error(`åˆ›å»ºå›¾åƒURLå¤±è´¥ ${imageData.name}:`, error);\n      console.error('imageData:', imageData);\n      throw error;\n    }\n  }\n\n  /**\n   * ä¿å­˜æ ‡æ³¨æ–‡ä»¶\n   */\n  async saveAnnotationFile(imageId, annotationData) {\n    if (!imageId) {\n      throw new Error('å›¾åƒIDä¸èƒ½ä¸ºç©º');\n    }\n    if (!annotationData) {\n      throw new Error('æ ‡æ³¨æ•°æ®ä¸èƒ½ä¸ºç©º');\n    }\n    \n    await this.ensureConnection();\n    \n    return this.withRetry(async () => {\n      const response = await fetch(`${this.baseUrl}/annotation/${encodeURIComponent(imageId)}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ annotationData })\n      });\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`ä¿å­˜æ ‡æ³¨æ–‡ä»¶: ${imageId}`);\n        return true;\n      }\n      \n      throw new Error(result.error || 'ä¿å­˜æ ‡æ³¨æ–‡ä»¶å¤±è´¥');\n    }, `ä¿å­˜æ ‡æ³¨æ–‡ä»¶ ${imageId}`);\n  }\n\n  /**\n   * è¯»å–æ ‡æ³¨æ–‡ä»¶\n   */\n  async loadAnnotationFile(imageId) {\n    try {\n      const response = await fetch(`${this.baseUrl}/annotation/${imageId}`);\n      const result = await response.json();\n      \n      if (result.success) {\n        if (result.data) {\n          console.log(`[æ ‡æ³¨] æˆåŠŸè¯»å– ${imageId}, åŒ…å« ${result.data.annotations?.length || 0} ä¸ªæ ‡æ³¨ç‚¹`);\n        }\n        return result.data;\n      }\n      \n      throw new Error(result.error || 'è¯»å–æ ‡æ³¨æ–‡ä»¶å¤±è´¥');\n    } catch (error) {\n      console.error(`[æ ‡æ³¨] è¯»å–æ ‡æ³¨æ–‡ä»¶å¤±è´¥ (${imageId}):`, error);\n      return null;\n    }\n  }\n\n  /**\n   * è·å–æ‰€æœ‰æ ‡æ³¨æ–‡ä»¶åˆ—è¡¨\n   */\n  async getAllAnnotationFiles() {\n    try {\n      const response = await fetch(`${this.baseUrl}/annotations`);\n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`[æ ‡æ³¨] æ‰«æå®Œæˆï¼Œæ‰¾åˆ° ${result.data.length} ä¸ªæ ‡æ³¨æ–‡ä»¶`);\n        return result.data;\n      }\n      \n      throw new Error(result.error || 'è·å–æ ‡æ³¨æ–‡ä»¶åˆ—è¡¨å¤±è´¥');\n    } catch (error) {\n      console.error('[æ ‡æ³¨] è·å–æ ‡æ³¨æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);\n      return [];\n    }\n  }\n\n  /**\n   * åˆ é™¤æ ‡æ³¨æ–‡ä»¶\n   */\n  async deleteAnnotationFile(imageId) {\n    try {\n      const response = await fetch(`${this.baseUrl}/annotation/${imageId}`, {\n        method: 'DELETE'\n      });\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`åˆ é™¤æ ‡æ³¨æ–‡ä»¶: ${imageId}`);\n        return true;\n      }\n      \n      throw new Error(result.error || 'åˆ é™¤æ ‡æ³¨æ–‡ä»¶å¤±è´¥');\n    } catch (error) {\n      console.error(`åˆ é™¤æ ‡æ³¨æ–‡ä»¶å¤±è´¥ (${imageId}):`, error);\n      return false;\n    }\n  }\n\n  /**\n   * è·å–ç›®å½•ç»Ÿè®¡ä¿¡æ¯\n   */\n  async getDirectoryStats(dirPath = null) {\n    try {\n      const url = dirPath ? \n        `${this.baseUrl}/directory-stats?dirPath=${encodeURIComponent(dirPath)}` : \n        `${this.baseUrl}/directory-stats`;\n      \n      const response = await fetch(url);\n      const result = await response.json();\n      \n      if (result.success) {\n        return result.data;\n      }\n      \n      throw new Error(result.error || 'è·å–ç›®å½•ç»Ÿè®¡å¤±è´¥');\n    } catch (error) {\n      console.error('è·å–ç›®å½•ç»Ÿè®¡å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æ˜¯å¦ä¸ºå›¾åƒæ–‡ä»¶\n   */\n  isImageFile(filename) {\n    const imageExtensions = ['.png', '.jpg', '.jpeg', '.bmp', '.tiff', '.webp'];\n    const ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));\n    return imageExtensions.includes(ext);\n  }\n\n  /**\n   * è§£æå›¾åƒæ–‡ä»¶åä¸­çš„æ—¶é—´ä¿¡æ¯\n   */\n  parseImageDateTime(filename) {\n    const regex = /BR\\d+-\\d+-(\\d{4}-\\d{2}-\\d{2})_(\\d{2})_VIS_sv_\\d+/;\n    const match = filename.match(regex);\n    \n    if (match) {\n      const dateStr = match[1];\n      const hourStr = match[2];\n      const dateTime = new Date(`${dateStr}T${hourStr}:00:00`);\n      return dateTime;\n    }\n    \n    console.warn(`æ— æ³•è§£ææ–‡ä»¶åæ—¶é—´ä¿¡æ¯: ${filename}`);\n    return new Date(0);\n  }\n\n  /**\n   * æ ¼å¼åŒ–å›¾åƒæ—¶é—´æ˜¾ç¤º - ğŸ”§ FIXED: Only show date, no time\n   */\n  formatImageTime(filename) {\n    const regex = /BR\\d+-\\d+-(\\d{4}-\\d{2}-\\d{2})_(\\d{2})_VIS_sv_\\d+/;\n    const match = filename.match(regex);\n    \n    if (match) {\n      const dateStr = match[1];\n      const hourStr = match[2];\n      const date = new Date(`${dateStr}T${hourStr}:00:00`);\n      // ğŸ”§ FIX: Remove time portion, only show year/month/day\n      return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;\n    }\n    \n    return filename;\n  }\n\n  /**\n   * è·å–æ‰€æœ‰è·³è¿‡ä¿¡æ¯\n   */\n  async getAllSkipInfo() {\n    try {\n      const response = await fetch(`${this.baseUrl}/skip-info`);\n      const result = await response.json();\n      \n      if (result.success) {\n        return result.data;\n      }\n      \n      throw new Error(result.error || 'è·å–è·³è¿‡ä¿¡æ¯å¤±è´¥');\n    } catch (error) {\n      console.error('è·å–è·³è¿‡ä¿¡æ¯å¤±è´¥:', error);\n      return {};\n    }\n  }\n\n  /**\n   * è·å–ç‰¹å®šæ¤ç‰©çš„è·³è¿‡ä¿¡æ¯\n   */\n  async getSkipInfo(plantId) {\n    try {\n      const response = await fetch(`${this.baseUrl}/skip-info/${plantId}`);\n      const result = await response.json();\n      \n      if (result.success) {\n        return result.data;\n      }\n      \n      throw new Error(result.error || 'è·å–è·³è¿‡ä¿¡æ¯å¤±è´¥');\n    } catch (error) {\n      console.error(`è·å–æ¤ç‰© ${plantId} è·³è¿‡ä¿¡æ¯å¤±è´¥:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * ä¿å­˜æ¤ç‰©è·³è¿‡ä¿¡æ¯\n   */\n  async saveSkipInfo(plantId, skipData) {\n    try {\n      const response = await fetch(`${this.baseUrl}/skip-info/${plantId}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ skipData })\n      });\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`ä¿å­˜è·³è¿‡ä¿¡æ¯: ${plantId}`);\n        return true;\n      }\n      \n      throw new Error(result.error || 'ä¿å­˜è·³è¿‡ä¿¡æ¯å¤±è´¥');\n    } catch (error) {\n      console.error(`ä¿å­˜æ¤ç‰© ${plantId} è·³è¿‡ä¿¡æ¯å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * åˆ é™¤æ¤ç‰©è·³è¿‡ä¿¡æ¯\n   */\n  async deleteSkipInfo(plantId) {\n    try {\n      const response = await fetch(`${this.baseUrl}/skip-info/${plantId}`, {\n        method: 'DELETE'\n      });\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`åˆ é™¤è·³è¿‡ä¿¡æ¯: ${plantId}`);\n        return true;\n      }\n      \n      throw new Error(result.error || 'åˆ é™¤è·³è¿‡ä¿¡æ¯å¤±è´¥');\n    } catch (error) {\n      console.error(`åˆ é™¤æ¤ç‰© ${plantId} è·³è¿‡ä¿¡æ¯å¤±è´¥:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * ğŸ”§ FIX: Get plant status from dedicated API\n   */\n  async getPlantStatus(plantId) {\n    try {\n      const response = await fetch(`${this.baseUrl}/plant-status/${plantId}`);\n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`[æ¤ç‰©çŠ¶æ€] ä»APIè·å–æ¤ç‰© ${plantId} çŠ¶æ€: ${result.data?.status || 'null'}`);\n        return result.data;\n      }\n      \n      // If no status found, return null (not an error)\n      if (response.status === 404 || result.message?.includes('æœªæ‰¾åˆ°')) {\n        console.log(`[æ¤ç‰©çŠ¶æ€] æ¤ç‰© ${plantId} æ— çŠ¶æ€ä¿¡æ¯`);\n        return null;\n      }\n      \n      throw new Error(result.error || 'è·å–æ¤ç‰©çŠ¶æ€å¤±è´¥');\n    } catch (error) {\n      console.error(`è·å–æ¤ç‰© ${plantId} çŠ¶æ€å¤±è´¥:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * ğŸ”§ FIX: Save plant status to dedicated API\n   */\n  async savePlantStatus(plantId, status) {\n    try {\n      const response = await fetch(`${this.baseUrl}/plant-status/${plantId}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ \n          status, \n          lastModified: new Date().toISOString() \n        })\n      });\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`[æ¤ç‰©çŠ¶æ€] ä¿å­˜æ¤ç‰© ${plantId} çŠ¶æ€: ${status}`);\n        return true;\n      }\n      \n      throw new Error(result.error || 'ä¿å­˜æ¤ç‰©çŠ¶æ€å¤±è´¥');\n    } catch (error) {\n      console.error(`ä¿å­˜æ¤ç‰© ${plantId} çŠ¶æ€å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ FIX: Delete plant status from dedicated API\n   */\n  async deletePlantStatus(plantId) {\n    try {\n      const response = await fetch(`${this.baseUrl}/plant-status/${plantId}`, {\n        method: 'DELETE'\n      });\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`[æ¤ç‰©çŠ¶æ€] åˆ é™¤æ¤ç‰© ${plantId} çŠ¶æ€`);\n        return true;\n      }\n      \n      throw new Error(result.error || 'åˆ é™¤æ¤ç‰©çŠ¶æ€å¤±è´¥');\n    } catch (error) {\n      console.error(`åˆ é™¤æ¤ç‰© ${plantId} çŠ¶æ€å¤±è´¥:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * æ¸…ç†èµ„æºï¼ˆHTTPç‰ˆæœ¬ä¸éœ€è¦å®é™…æ¸…ç†ï¼‰\n   */\n  cleanup() {\n    console.log('HttpFileSystemManager æ¸…ç†å®Œæˆ');\n  }\n\n  /**\n   * å…¼å®¹æ€§æ–¹æ³•ï¼šè·å–annotationsç›®å½•ï¼ˆHTTPç‰ˆæœ¬è¿”å›è™šæ‹ŸçŠ¶æ€ï¼‰\n   */\n  getAnnotationsDirectory() {\n    return this.isInitialized ? { exists: true } : null;\n  }\n\n  /**\n   * å…¼å®¹æ€§æ–¹æ³•ï¼šç¡®ä¿annotationsç›®å½•å­˜åœ¨\n   */\n  async ensureAnnotationsDirectory() {\n    // HTTPç‰ˆæœ¬ä¸­ï¼Œåç«¯è‡ªåŠ¨å¤„ç†ç›®å½•åˆ›å»º\n    return { exists: true };\n  }\n}","/**\n * æ ‡æ³¨æ•°æ®å­˜å‚¨ç®¡ç†å™¨\n * \n * åŠŸèƒ½ï¼š\n * - å°†æ ‡æ³¨æ•°æ®ä¿å­˜ä¸ºJSONæ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•\n * - ä»JSONæ–‡ä»¶åŠ è½½æ ‡æ³¨æ•°æ®\n * - æä¾›å¯¼å‡ºåŠŸèƒ½\n * - ç®¡ç†æ ‡æ³¨å†å²å’Œå¤‡ä»½\n */\n\nexport class AnnotationStorageManager {\n  constructor() {\n    this.apiBaseUrl = 'http://localhost:3002/api'; // æœ¬åœ°å­˜å‚¨æœåŠ¡å™¨\n    this.annotations = new Map();\n    this.imageAnnotations = new Map(); // æ–°å¢ï¼šæŒ‰å›¾åƒIDå­˜å‚¨æ ‡æ³¨\n    this.isInitialized = false;\n    this.fileSystemManager = null; // æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨\n    this.useFileSystem = false; // æ˜¯å¦ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨\n  }\n\n  /**\n   * è®¾ç½®æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨\n   */\n  setFileSystemManager(fileSystemManager) {\n    this.fileSystemManager = fileSystemManager;\n    this.useFileSystem = !!fileSystemManager;\n    console.log('[æ ‡æ³¨] æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨å·²å¯ç”¨');\n\n    // æ£€æŸ¥annotationsç›®å½•å¥æŸ„æ˜¯å¦å­˜åœ¨\n    if (fileSystemManager) {\n      const annotationsHandle = fileSystemManager.getAnnotationsDirectory();\n      console.log(`[æ ‡æ³¨] setFileSystemManager: annotationså¥æŸ„${annotationsHandle ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);\n    }\n  }\n\n  /**\n   * åˆå§‹åŒ–å­˜å‚¨ç®¡ç†å™¨\n   */\n  async initialize() {\n    try {\n      if (this.useFileSystem && this.fileSystemManager) {\n        // æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼ï¼šæ‰«ææ ‡æ³¨æ–‡ä»¶ä½†ä¸é¢„åŠ è½½åˆ°å†…å­˜\n        await this.scanAnnotationFiles();\n        console.log('AnnotationStorageManager åˆå§‹åŒ–å®Œæˆ (æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼)');\n        this.isInitialized = true;\n        return;\n      }\n\n      // å¦‚æœæ²¡æœ‰å¯ç”¨æ–‡ä»¶ç³»ç»Ÿï¼Œå°è¯•æœåŠ¡å™¨æ¨¡å¼\n      try {\n        await this.loadAnnotationsFromServer();\n        await this.loadImageAnnotationsFromServer();\n        console.log('AnnotationStorageManager åˆå§‹åŒ–å®Œæˆ (æœåŠ¡å™¨æ¨¡å¼)');\n      } catch (serverError) {\n        console.warn('æœåŠ¡å™¨æ¨¡å¼åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨localStorageæ¨¡å¼:', serverError.message);\n        // å°è¯•ä»localStorageæ¢å¤æ•°æ®\n        this.loadFromLocalStorage();\n        this.loadImageAnnotationsFromLocalStorage();\n        console.log('AnnotationStorageManager åˆå§‹åŒ–å®Œæˆ (localStorageæ¨¡å¼)');\n      }\n\n      this.isInitialized = true;\n    } catch (error) {\n      console.error('åˆå§‹åŒ–æ ‡æ³¨å­˜å‚¨ç®¡ç†å™¨å¤±è´¥:', error);\n      this.isInitialized = true; // å³ä½¿å¤±è´¥ä¹Ÿæ ‡è®°ä¸ºå·²åˆå§‹åŒ–ï¼Œé¿å…é‡å¤åˆå§‹åŒ–\n    }\n  }\n\n  /**\n   * ä»æœåŠ¡å™¨åŠ è½½æ ‡æ³¨æ•°æ®\n   */\n  async loadAnnotationsFromServer() {\n    try {\n      const response = await fetch(`${this.apiBaseUrl}/load-annotations`);\n      const result = await response.json();\n      \n      if (result.success && result.data) {\n        // å°†æ•°æ®åŠ è½½åˆ°Mapä¸­\n        for (const [plantId, annotationData] of Object.entries(result.data.annotations || {})) {\n          this.annotations.set(plantId, annotationData);\n        }\n        \n        console.log(`ä»æœåŠ¡å™¨åŠ è½½äº† ${this.annotations.size} ä¸ªæ¤ç‰©çš„æ ‡æ³¨æ•°æ®`);\n        return result.data;\n      } else {\n        throw new Error(result.error || 'åŠ è½½æ ‡æ³¨æ•°æ®å¤±è´¥');\n      }\n    } catch (error) {\n      console.warn('ä»æœåŠ¡å™¨åŠ è½½æ ‡æ³¨æ•°æ®å¤±è´¥ï¼Œå°è¯•ä»localStorageæ¢å¤:', error.message);\n      this.loadFromLocalStorage();\n      return { annotations: {} };\n    }\n  }\n\n  /**\n   * ä¿å­˜æ ‡æ³¨æ•°æ®åˆ°æœåŠ¡å™¨\n   */\n  async saveAnnotationsToServer() {\n    try {\n      const exportData = {\n        saveTime: new Date().toISOString(),\n        totalPlants: this.annotations.size,\n        annotations: {}\n      };\n\n      // è½¬æ¢Mapä¸ºæ™®é€šå¯¹è±¡\n      for (const [plantId, annotationData] of this.annotations) {\n        exportData.annotations[plantId] = annotationData;\n      }\n\n      // å‘é€ä¿å­˜è¯·æ±‚åˆ°æœ¬åœ°æœåŠ¡å™¨\n      const response = await fetch(`${this.apiBaseUrl}/save-annotations`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(exportData)\n      });\n\n      const result = await response.json();\n      \n      if (result.success) {\n        console.log(`æˆåŠŸä¿å­˜ ${this.annotations.size} ä¸ªæ¤ç‰©çš„æ ‡æ³¨æ•°æ®åˆ°æœåŠ¡å™¨`);\n        // åŒæ—¶å¤‡ä»½åˆ°localStorage\n        this.saveToLocalStorage();\n        return true;\n      } else {\n        throw new Error(result.error || 'æœåŠ¡å™¨ä¿å­˜å¤±è´¥');\n      }\n    } catch (error) {\n      console.error('ä¿å­˜æ ‡æ³¨æ•°æ®åˆ°æœåŠ¡å™¨å¤±è´¥:', error);\n      // å¦‚æœæ— æ³•ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œè‡³å°‘ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½\n      this.saveToLocalStorage();\n      return false;\n    }\n  }\n\n  /**\n   * ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½\n   */\n  saveToLocalStorage() {\n    try {\n      const data = {};\n      for (const [plantId, annotationData] of this.annotations) {\n        data[plantId] = annotationData;\n      }\n      localStorage.setItem('plant_annotations_backup', JSON.stringify({\n        saveTime: new Date().toISOString(),\n        annotations: data\n      }));\n      console.log('æ ‡æ³¨æ•°æ®å·²å¤‡ä»½åˆ°localStorage');\n    } catch (error) {\n      console.error('å¤‡ä»½åˆ°localStorageå¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * ä»localStorageæ¢å¤æ•°æ®\n   */\n  loadFromLocalStorage() {\n    try {\n      const backup = localStorage.getItem('plant_annotations_backup');\n      if (backup) {\n        const data = JSON.parse(backup);\n        for (const [plantId, annotationData] of Object.entries(data.annotations || {})) {\n          if (!this.annotations.has(plantId)) {\n            this.annotations.set(plantId, annotationData);\n          }\n        }\n        console.log('ä»localStorageæ¢å¤äº†å¤‡ä»½æ•°æ®');\n      }\n    } catch (error) {\n      console.error('ä»localStorageæ¢å¤æ•°æ®å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * ä¿å­˜æ¤ç‰©æ ‡æ³¨æ•°æ®\n   */\n  async savePlantAnnotations(plantId, annotations, plantInfo = {}) {\n    const annotationData = {\n      plantId,\n      annotations, // å½“å‰é€‰ä¸­å›¾åƒçš„æ ‡æ³¨\n      selectedImage: plantInfo.selectedImage?.name || null,\n      selectedImagePath: plantInfo.selectedImage?.id || null,\n      viewAngle: plantInfo.selectedViewAngle || null,\n      status: annotations.length > 0 ? 'completed' : 'in-progress',\n      lastModified: new Date().toISOString(),\n      imageDateTime: plantInfo.selectedImage?.dateTime || null,\n      keypointCount: annotations.length,\n      \n      // æ—¶é—´åºåˆ—æ•°æ®æ”¯æŒ\n      timeSeriesData: plantInfo.timeSeriesData || null,\n      isTimeSeriesEnabled: !!plantInfo.timeSeriesData,\n      \n      // å®Œæ•´çš„è§†è§’å’Œæ—¶é—´åºåˆ—ä¿¡æ¯\n      plantViewAngles: plantInfo.plantViewAngles || [], // æ¤æ ªæ‰€æœ‰å¯ç”¨çš„è§†è§’\n      selectedViewAngleHistory: plantInfo.selectedViewAngleHistory || {}, // æ¯ä¸ªè§†è§’çš„é€‰æ‹©å†å²\n      timeSeriesMetadata: plantInfo.timeSeriesMetadata || {} // æ—¶é—´åºåˆ—å…ƒæ•°æ®\n    };\n\n    this.annotations.set(plantId, annotationData);\n    \n    // è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶\n    await this.saveAnnotationsToServer();\n    \n    return annotationData;\n  }\n\n  /**\n   * è·å–æ¤ç‰©æ ‡æ³¨æ•°æ®\n   */\n  getPlantAnnotations(plantId) {\n    const data = this.annotations.get(plantId);\n    return data ? data.annotations : [];\n  }\n\n  /**\n   * è·å–æ¤ç‰©æ ‡æ³¨çŠ¶æ€\n   */\n  getPlantStatus(plantId) {\n    const data = this.annotations.get(plantId);\n    if (!data) return 'pending';\n    \n    return data.annotations.length > 0 ? 'completed' : 'in-progress';\n  }\n\n  /**\n   * è·å–æ‰€æœ‰å·²æ ‡æ³¨çš„æ¤ç‰©ID\n   */\n  getAnnotatedPlantIds() {\n    return Array.from(this.annotations.keys());\n  }\n\n  /**\n   * ä¿å­˜æ¤æ ªè·³è¿‡ä¿¡æ¯\n   */\n  async saveSkipInfo(plantId, skipInfo) {\n    try {\n      // è·å–æˆ–åˆ›å»ºæ¤æ ªæ ‡æ³¨æ•°æ®\n      let annotationData = this.annotations.get(plantId);\n      if (!annotationData) {\n        annotationData = {\n          plantId,\n          annotations: [],\n          lastModified: new Date().toISOString(),\n          createdAt: new Date().toISOString(),\n          selectedViewAngle: null,\n          selectedImage: null,\n          plantViewAngles: [],\n          selectedViewAngleHistory: {},\n          timeSeriesMetadata: {}\n        };\n      }\n\n      // æ›´æ–°è·³è¿‡ä¿¡æ¯\n      annotationData.status = skipInfo.status;\n      annotationData.skipReason = skipInfo.skipReason;\n      annotationData.skipDate = skipInfo.skipDate;\n      annotationData.lastModified = skipInfo.lastModified;\n\n      this.annotations.set(plantId, annotationData);\n\n      // ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿæˆ–HTTPåç«¯\n      if (this.useFileSystem && this.fileSystemManager.saveSkipInfo) {\n        try {\n          // HTTPæ¨¡å¼ï¼šé€šè¿‡APIä¿å­˜è·³è¿‡ä¿¡æ¯\n          await this.fileSystemManager.saveSkipInfo(plantId, annotationData);\n          console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²ä¿å­˜åˆ°åç«¯`);\n        } catch (apiError) {\n          console.warn('åç«¯ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨localStorageå¤‡ä»½:', apiError);\n          this.saveToLocalStorage();\n          console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²å¤‡ä»½åˆ°localStorage`);\n        }\n      } else if (this.fileSystemManager && this.fileSystemManager.getAnnotationsDirectory()) {\n        try {\n          // åŸæœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼\n          const fileName = `${plantId}_skip_info.json`;\n          const annotationsHandle = this.fileSystemManager.getAnnotationsDirectory();\n          const fileHandle = await annotationsHandle.getFileHandle(fileName, { create: true });\n          const writable = await fileHandle.createWritable();\n\n          await writable.write(JSON.stringify(annotationData, null, 2));\n          await writable.close();\n\n          console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ: ${fileName}`);\n        } catch (fsError) {\n          console.warn('æ–‡ä»¶ç³»ç»Ÿä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨localStorageå¤‡ä»½:', fsError);\n          this.saveToLocalStorage();\n          console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²å¤‡ä»½åˆ°localStorage`);\n        }\n      } else {\n        // å¦‚æœæ–‡ä»¶ç³»ç»Ÿä¸å¯ç”¨ï¼Œä¿å­˜åˆ°localStorage\n        this.saveToLocalStorage();\n        console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²ä¿å­˜åˆ°localStorage`);\n      }\n\n    } catch (error) {\n      console.error(`ä¿å­˜æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: ç§»é™¤æ¤æ ªè·³è¿‡ä¿¡æ¯\n   */\n  async removeSkipInfo(plantId) {\n    try {\n      // ä»å†…å­˜ä¸­ç§»é™¤è·³è¿‡çŠ¶æ€\n      const annotationData = this.annotations.get(plantId);\n      if (annotationData) {\n        delete annotationData.status;\n        delete annotationData.skipReason;\n        delete annotationData.skipDate;\n        annotationData.lastModified = new Date().toISOString();\n        \n        // å¦‚æœæ²¡æœ‰å…¶ä»–æ•°æ®ï¼Œå®Œå…¨ç§»é™¤\n        if (!annotationData.annotations || annotationData.annotations.length === 0) {\n          this.annotations.delete(plantId);\n        }\n      }\n\n      // ä»æ–‡ä»¶ç³»ç»Ÿæˆ–HTTPåç«¯ç§»é™¤\n      if (this.useFileSystem && this.fileSystemManager.deleteSkipInfo) {\n        try {\n          // HTTPæ¨¡å¼ï¼šé€šè¿‡APIç§»é™¤è·³è¿‡ä¿¡æ¯\n          await this.fileSystemManager.deleteSkipInfo(plantId);\n          console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²ä»åç«¯ç§»é™¤`);\n        } catch (apiError) {\n          console.warn('åç«¯ç§»é™¤å¤±è´¥ï¼Œä½¿ç”¨localStorageæ¸…ç†:', apiError);\n          this.saveToLocalStorage();\n          console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²ä»localStorageæ¸…ç†`);\n        }\n      } else if (this.fileSystemManager && this.fileSystemManager.getAnnotationsDirectory()) {\n        try {\n          // åŸæœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼ï¼šåˆ é™¤è·³è¿‡ä¿¡æ¯æ–‡ä»¶\n          const fileName = `${plantId}_skip_info.json`;\n          const annotationsHandle = this.fileSystemManager.getAnnotationsDirectory();\n          \n          try {\n            await annotationsHandle.removeEntry(fileName);\n            console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯æ–‡ä»¶å·²åˆ é™¤: ${fileName}`);\n          } catch (removeError) {\n            // æ–‡ä»¶ä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„\n            if (removeError.name !== 'NotFoundError') {\n              throw removeError;\n            }\n            console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤`);\n          }\n        } catch (fsError) {\n          console.warn('æ–‡ä»¶ç³»ç»Ÿåˆ é™¤å¤±è´¥ï¼Œä½¿ç”¨localStorageæ¸…ç†:', fsError);\n          this.saveToLocalStorage();\n          console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²ä»localStorageæ¸…ç†`);\n        }\n      } else {\n        // å¦‚æœæ–‡ä»¶ç³»ç»Ÿä¸å¯ç”¨ï¼Œä»localStorageæ¸…ç†\n        this.saveToLocalStorage();\n        console.log(`æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å·²ä»localStorageæ¸…ç†`);\n      }\n\n    } catch (error) {\n      console.error(`ç§»é™¤æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ FIX: Save plant status independently of annotations\n   */\n  async savePlantStatus(plantId, status) {\n    try {\n      // è·å–æˆ–åˆ›å»ºæ¤æ ªæ•°æ®\n      let annotationData = this.annotations.get(plantId);\n      if (!annotationData) {\n        annotationData = {\n          plantId,\n          annotations: [],\n          lastModified: new Date().toISOString(),\n          createdAt: new Date().toISOString(),\n          selectedViewAngle: null,\n          selectedImage: null,\n          plantViewAngles: [],\n          selectedViewAngleHistory: {},\n          timeSeriesMetadata: {}\n        };\n      }\n\n      // æ›´æ–°çŠ¶æ€å’Œæ—¶é—´æˆ³\n      annotationData.status = status;\n      annotationData.lastModified = new Date().toISOString();\n\n      this.annotations.set(plantId, annotationData);\n\n      // ğŸ”§ FIX: Use dedicated plant status API instead of skip-info API\n      if (this.useFileSystem && this.fileSystemManager.savePlantStatus) {\n        try {\n          // HTTPæ¨¡å¼ï¼šé€šè¿‡ä¸“ç”¨æ¤ç‰©çŠ¶æ€APIä¿å­˜\n          await this.fileSystemManager.savePlantStatus(plantId, status);\n          console.log(`æ¤æ ª ${plantId} çŠ¶æ€ ${status} å·²ä¿å­˜åˆ°ä¸“ç”¨API`);\n        } catch (apiError) {\n          console.warn('æ¤ç‰©çŠ¶æ€APIä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨localStorageå¤‡ä»½:', apiError);\n          this.saveToLocalStorage();\n          console.log(`æ¤æ ª ${plantId} çŠ¶æ€å·²å¤‡ä»½åˆ°localStorage`);\n        }\n      } else if (this.fileSystemManager && this.fileSystemManager.getAnnotationsDirectory()) {\n        try {\n          // æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼ï¼šä¿å­˜ä¸ºç‹¬ç«‹çš„çŠ¶æ€æ–‡ä»¶\n          const fileName = `${plantId}_status.json`;\n          const annotationsHandle = this.fileSystemManager.getAnnotationsDirectory();\n          const fileHandle = await annotationsHandle.getFileHandle(fileName, { create: true });\n          const writable = await fileHandle.createWritable();\n\n          const statusData = {\n            plantId,\n            status,\n            lastModified: new Date().toISOString(),\n            timestamp: new Date().toISOString()\n          };\n\n          await writable.write(JSON.stringify(statusData, null, 2));\n          await writable.close();\n\n          console.log(`æ¤æ ª ${plantId} çŠ¶æ€ ${status} å·²ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ: ${fileName}`);\n        } catch (fsError) {\n          console.warn('æ–‡ä»¶ç³»ç»Ÿä¿å­˜çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨localStorageå¤‡ä»½:', fsError);\n          this.saveToLocalStorage();\n          console.log(`æ¤æ ª ${plantId} çŠ¶æ€å·²å¤‡ä»½åˆ°localStorage`);\n        }\n      } else {\n        // å¦‚æœæ–‡ä»¶ç³»ç»Ÿä¸å¯ç”¨ï¼Œä¿å­˜åˆ°localStorage\n        this.saveToLocalStorage();\n        console.log(`æ¤æ ª ${plantId} çŠ¶æ€ ${status} å·²ä¿å­˜åˆ°localStorage`);\n      }\n\n      console.log(`[æ¤ç‰©çŠ¶æ€] ${plantId}: ${status} (ç‹¬ç«‹ä¿å­˜å®Œæˆ)`);\n\n    } catch (error) {\n      console.error(`ä¿å­˜æ¤æ ª ${plantId} çŠ¶æ€å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ FIX: Load plant status independently for status restoration\n   */\n  async loadPlantStatus(plantId) {\n    try {\n      console.log(`[çŠ¶æ€åŠ è½½] å¼€å§‹ä¸ºæ¤ç‰© ${plantId} åŠ è½½çŠ¶æ€...`);\n      console.log(`[çŠ¶æ€åŠ è½½] useFileSystem: ${this.useFileSystem}, fileSystemManagerå­˜åœ¨: ${!!this.fileSystemManager}`);\n      \n      // First check if we have status in memory\n      const existingData = this.annotations.get(plantId);\n      if (existingData && existingData.status) {\n        console.log(`[æ¤ç‰©çŠ¶æ€] ${plantId}: ä»å†…å­˜åŠ è½½çŠ¶æ€ ${existingData.status}`);\n        return existingData.status;\n      }\n\n      // ğŸ”§ FIX: Try to load from dedicated plant status API first\n      if (this.useFileSystem && this.fileSystemManager.getPlantStatus) {\n        try {\n          console.log(`[çŠ¶æ€åŠ è½½] å°è¯•ä»ä¸“ç”¨APIåŠ è½½æ¤ç‰© ${plantId} çŠ¶æ€...`);\n          const statusData = await this.fileSystemManager.getPlantStatus(plantId);\n          console.log(`[çŠ¶æ€åŠ è½½] ä¸“ç”¨APIå“åº”:`, statusData);\n          if (statusData && statusData.status) {\n            console.log(`[æ¤ç‰©çŠ¶æ€] ${plantId}: ä»ä¸“ç”¨APIåŠ è½½çŠ¶æ€ ${statusData.status}`);\n            return statusData.status;\n          }\n        } catch (apiError) {\n          console.warn(`ä»ä¸“ç”¨APIåŠ è½½æ¤æ ª ${plantId} çŠ¶æ€å¤±è´¥:`, apiError);\n        }\n      } else {\n        console.log(`[çŠ¶æ€åŠ è½½] è·³è¿‡ä¸“ç”¨API: useFileSystem=${this.useFileSystem}, getPlantStatuså­˜åœ¨=${!!this.fileSystemManager?.getPlantStatus}`);\n      }\n\n      // Fallback: Try to load from skip-info API for backwards compatibility\n      if (this.useFileSystem && this.fileSystemManager.getSkipInfo) {\n        try {\n          const data = await this.fileSystemManager.getSkipInfo(plantId);\n          if (data && data.status) {\n            console.log(`[æ¤ç‰©çŠ¶æ€] ${plantId}: ä»skip-info APIåŠ è½½çŠ¶æ€ ${data.status} (å‘åå…¼å®¹)`);\n            return data.status;\n          }\n        } catch (skipError) {\n          console.warn(`ä»skip-info APIåŠ è½½æ¤æ ª ${plantId} çŠ¶æ€å¤±è´¥:`, skipError);\n        }\n      } else if (this.fileSystemManager && this.fileSystemManager.getAnnotationsDirectory()) {\n        try {\n          // æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼ï¼šå°è¯•åŠ è½½çŠ¶æ€æ–‡ä»¶\n          const fileName = `${plantId}_status.json`;\n          const annotationsHandle = this.fileSystemManager.getAnnotationsDirectory();\n          const fileHandle = await annotationsHandle.getFileHandle(fileName);\n          const file = await fileHandle.getFile();\n          const content = await file.text();\n          const statusData = JSON.parse(content);\n          \n          if (statusData.status) {\n            console.log(`[æ¤ç‰©çŠ¶æ€] ${plantId}: ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½çŠ¶æ€ ${statusData.status}`);\n            return statusData.status;\n          }\n        } catch (fsError) {\n          // Status file doesn't exist, this is normal for pending plants\n          console.log(`[æ¤ç‰©çŠ¶æ€] ${plantId}: æ— çŠ¶æ€æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€`);\n        }\n      }\n\n      // Fallback to localStorage\n      try {\n        const localData = localStorage.getItem('plantAnnotations');\n        if (localData) {\n          const parsed = JSON.parse(localData);\n          if (parsed[plantId] && parsed[plantId].status) {\n            console.log(`[æ¤ç‰©çŠ¶æ€] ${plantId}: ä»localStorageåŠ è½½çŠ¶æ€ ${parsed[plantId].status}`);\n            return parsed[plantId].status;\n          }\n        }\n      } catch (localError) {\n        console.warn('ä»localStorageåŠ è½½çŠ¶æ€å¤±è´¥:', localError);\n      }\n\n      // Return null if no status found (let calling code decide default)\n      console.log(`[æ¤ç‰©çŠ¶æ€] ${plantId}: æœªæ‰¾åˆ°æŒä¹…åŒ–çŠ¶æ€`);\n      return null;\n\n    } catch (error) {\n      console.error(`åŠ è½½æ¤æ ª ${plantId} çŠ¶æ€å¤±è´¥:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æ¤ç‰©æ˜¯å¦æœ‰æ ‡æ³¨æ•°æ®\n   */\n  hasAnnotations(plantId) {\n    const data = this.annotations.get(plantId);\n    return data && data.annotations.length > 0;\n  }\n\n  /**\n   * åˆ é™¤æ¤ç‰©æ ‡æ³¨æ•°æ®\n   */\n  async deletePlantAnnotations(plantId) {\n    this.annotations.delete(plantId);\n    await this.saveAnnotationsToServer();\n  }\n\n  /**\n   * è·å–æ ‡æ³¨è¿›åº¦ç»Ÿè®¡\n   */\n  getAnnotationStats(totalPlants) {\n    const annotatedCount = this.getAnnotatedPlantIds().length;\n    const completedCount = Array.from(this.annotations.values())\n      .filter(data => data.annotations.length > 0).length;\n\n    return {\n      total: totalPlants,\n      annotated: annotatedCount,\n      completed: completedCount,\n      pending: totalPlants - annotatedCount,\n      completionRate: totalPlants > 0 ? (completedCount / totalPlants * 100).toFixed(1) : 0\n    };\n  }\n\n  /**\n   * å¯¼å‡ºæ‰€æœ‰æ ‡æ³¨æ•°æ®\n   */\n  exportAllAnnotations() {\n    const exportData = {\n      exportTime: new Date().toISOString(),\n      version: '1.0',\n      totalPlants: this.annotations.size,\n      annotations: {}\n    };\n\n    for (const [plantId, annotationData] of this.annotations) {\n      exportData.annotations[plantId] = {\n        ...annotationData,\n        exportedAt: new Date().toISOString()\n      };\n    }\n\n    return exportData;\n  }\n\n  /**\n   * å¯¼å‡ºä¸ºJSONæ–‡ä»¶ä¸‹è½½\n   */\n  downloadAnnotationsAsJSON() {\n    const exportData = this.exportAllAnnotations();\n    \n    const blob = new Blob([JSON.stringify(exportData, null, 2)], {\n      type: 'application/json'\n    });\n    \n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `plant_annotations_${new Date().toISOString().split('T')[0]}.json`;\n    \n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    \n    URL.revokeObjectURL(url);\n    \n    return exportData;\n  }\n\n  /**\n   * å¯¼å‡ºæ‰€æœ‰å›¾åƒçš„çº¯å‡€æ ‡æ³¨æ•°æ®ï¼ˆæ–°çš„ç®€åŒ–ç‰ˆæœ¬ï¼‰\n   * è¿”å›æ ¼å¼ï¼š{ imageId: annotations[] }\n   */\n  async exportPureImageAnnotations() {\n    const pureImageAnnotations = {};\n    \n    // ç›´æ¥ä»imageAnnotationså¯¼å‡º\n    for (const [imageId, annotationData] of this.imageAnnotations) {\n      if (annotationData.annotations && annotationData.annotations.length > 0) {\n        pureImageAnnotations[imageId] = annotationData.annotations.map(annotation => ({\n          id: annotation.id,\n          x: annotation.x,\n          y: annotation.y,\n          timestamp: annotation.timestamp,\n          direction: annotation.direction || 'right', // åŒ…å«æ–°çš„æ–¹å‘ä¿¡æ¯\n          order: annotation.order || 0 // åŒ…å«åºå·ä¿¡æ¯ï¼Œå…¼å®¹æ—§æ•°æ®\n        }));\n      }\n    }\n    \n    console.log(`å¯¼å‡º ${Object.keys(pureImageAnnotations).length} å¼ å›¾åƒçš„çº¯å‡€æ ‡æ³¨æ•°æ®`);\n    return pureImageAnnotations;\n  }\n\n  /**\n   * ä¸‹è½½çº¯å‡€çš„å›¾åƒæ ‡æ³¨æ•°æ®ä¸ºJSONæ–‡ä»¶\n   */\n  async downloadPureImageAnnotationsAsJSON() {\n    const pureAnnotations = await this.exportPureImageAnnotations();\n    const stats = this.getPureAnnotationsStats(pureAnnotations);\n    \n    const exportData = {\n      exportTime: new Date().toISOString(),\n      version: '2.0',\n      format: 'pure_image_annotations',\n      description: 'æ¯å¼ å›¾åƒå¯¹åº”çš„æ ‡æ³¨ç‚¹æ•°æ®ï¼Œä¸åŒ…å«å†…éƒ¨ç®¡ç†ä¿¡æ¯',\n      stats: {\n        totalImages: stats.totalImages,\n        annotatedImages: stats.annotatedImages,\n        totalKeypoints: stats.totalKeypoints,\n        completionRate: stats.completionRate\n      },\n      annotations: pureAnnotations\n    };\n    \n    const blob = new Blob([JSON.stringify(exportData, null, 2)], {\n      type: 'application/json'\n    });\n    \n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `pure_image_annotations_${new Date().toISOString().split('T')[0]}.json`;\n    \n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    \n    URL.revokeObjectURL(url);\n    \n    console.log(`å¯¼å‡ºäº† ${stats.annotatedImages} å¼ å›¾åƒçš„çº¯å‡€æ ‡æ³¨æ•°æ®ï¼Œå…± ${stats.totalKeypoints} ä¸ªå…³é”®ç‚¹`);\n    \n    return exportData;\n  }\n\n  /**\n   * è·å–çº¯å‡€æ ‡æ³¨æ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯\n   */\n  getPureAnnotationsStats(pureAnnotations) {\n    const totalImages = Object.keys(pureAnnotations).length;\n    let totalKeypoints = 0;\n    \n    for (const annotations of Object.values(pureAnnotations)) {\n      totalKeypoints += annotations.length;\n    }\n    \n    return {\n      totalImages,\n      annotatedImages: totalImages,\n      totalKeypoints,\n      averageKeypointsPerImage: totalImages > 0 ? (totalKeypoints / totalImages).toFixed(2) : 0,\n      completionRate: '100.0' // åªåŒ…å«æœ‰æ ‡æ³¨çš„å›¾åƒ\n    };\n  }\n\n  /**\n   * è®¾ç½®æ—¶é—´åºåˆ—ç®¡ç†å™¨çš„å¼•ç”¨\n   */\n  setTimeSeriesManager(timeSeriesManager) {\n    this.timeSeriesManager = timeSeriesManager;\n  }\n\n  /**\n   * æ¸…ç†æ‰€æœ‰æ ‡æ³¨æ•°æ®\n   */\n  async clearAllAnnotations() {\n    this.annotations.clear();\n    await this.saveAnnotationsToServer();\n  }\n\n  /**\n   * è·å–æ‰€æœ‰æ ‡æ³¨æ•°æ®çš„æ‘˜è¦\n   */\n  getSummary() {\n    const summary = {\n      totalAnnotations: this.annotations.size,\n      completedPlants: 0,\n      totalKeypoints: 0,\n      lastModified: null\n    };\n\n    for (const [plantId, data] of this.annotations) {\n      if (data.annotations.length > 0) {\n        summary.completedPlants++;\n        summary.totalKeypoints += data.annotations.length;\n        \n        if (!summary.lastModified || data.lastModified > summary.lastModified) {\n          summary.lastModified = data.lastModified;\n        }\n      }\n    }\n\n    return summary;\n  }\n\n  /**\n   * æ¢å¤æ—¶é—´åºåˆ—æ•°æ®åˆ°ç®¡ç†å™¨\n   */\n  restoreTimeSeriesData(timeSeriesManager) {\n    for (const [plantId, data] of this.annotations) {\n      if (data.isTimeSeriesEnabled && data.timeSeriesData) {\n        try {\n          // æ¢å¤æ—¶é—´åºåˆ—æ ‡æ³¨æ•°æ®\n          this.restorePlantTimeSeriesData(timeSeriesManager, plantId, data);\n          console.log(`æ¢å¤æ¤æ ª ${plantId} çš„æ—¶é—´åºåˆ—æ•°æ®`);\n        } catch (error) {\n          console.error(`æ¢å¤æ¤æ ª ${plantId} æ—¶é—´åºåˆ—æ•°æ®å¤±è´¥:`, error);\n        }\n      }\n    }\n  }\n\n  /**\n   * æ¢å¤å•ä¸ªæ¤æ ªçš„æ—¶é—´åºåˆ—æ•°æ®\n   */\n  restorePlantTimeSeriesData(timeSeriesManager, plantId, annotationData) {\n    const { timeSeriesData, viewAngle } = annotationData;\n    \n    if (!timeSeriesData || !viewAngle) return;\n    \n    // æ¢å¤æ—¶é—´åºåˆ—ç»“æ„\n    if (!timeSeriesManager.timeSequences.has(plantId)) {\n      timeSeriesManager.timeSequences.set(plantId, new Map());\n    }\n    \n    if (!timeSeriesManager.timeSeriesAnnotations.has(plantId)) {\n      timeSeriesManager.timeSeriesAnnotations.set(plantId, new Map());\n    }\n    \n    // æ¢å¤æ—¶é—´åºåˆ—\n    const imageIds = timeSeriesData.annotationData.map(item => item.imageId);\n    timeSeriesManager.timeSequences.get(plantId).set(viewAngle, imageIds);\n    \n    // æ¢å¤æ ‡æ³¨æ•°æ®\n    const viewAnnotations = new Map();\n    for (const item of timeSeriesData.annotationData) {\n      viewAnnotations.set(item.imageId, {\n        annotations: item.annotations,\n        timestamp: item.metadata.timestamp,\n        isManualAdjustment: item.metadata.isManualAdjustment,\n        inheritedFrom: item.metadata.inheritedFrom\n      });\n    }\n    \n    timeSeriesManager.timeSeriesAnnotations.get(plantId).set(viewAngle, viewAnnotations);\n    \n    // æ¢å¤æ‰‹åŠ¨è°ƒæ•´è®°å½•\n    const adjustmentKey = `${plantId}_${viewAngle}`;\n    if (!timeSeriesManager.manualAdjustments.has(adjustmentKey)) {\n      timeSeriesManager.manualAdjustments.set(adjustmentKey, new Set());\n    }\n    \n    const manualAdjustments = timeSeriesManager.manualAdjustments.get(adjustmentKey);\n    for (const item of timeSeriesData.annotationData) {\n      if (item.metadata.isManualAdjustment) {\n        manualAdjustments.add(item.imageId);\n      }\n    }\n  }\n\n  /**\n   * è·å–æ¤æ ªçš„è§†è§’é€‰æ‹©å†å²\n   */\n  getPlantViewAngleHistory(plantId) {\n    const data = this.annotations.get(plantId);\n    return data?.selectedViewAngleHistory || {};\n  }\n\n  /**\n   * è·å–æ¤æ ªçš„å®Œæ•´æ ‡æ³¨æ‘˜è¦\n   */\n  getPlantAnnotationSummary(plantId) {\n    const data = this.annotations.get(plantId);\n    if (!data) return null;\n\n    const summary = {\n      plantId,\n      status: data.status,\n      lastModified: data.lastModified,\n      selectedViewAngle: data.viewAngle,\n      availableViewAngles: data.plantViewAngles || [],\n      isTimeSeriesEnabled: data.isTimeSeriesEnabled,\n      currentImageInfo: {\n        imageName: data.selectedImage,\n        imageId: data.selectedImagePath,\n        dateTime: data.imageDateTime\n      }\n    };\n\n    // å¦‚æœæœ‰æ—¶é—´åºåˆ—æ•°æ®ï¼Œæ·»åŠ ç»Ÿè®¡ä¿¡æ¯\n    if (data.timeSeriesData) {\n      summary.timeSeriesStats = {\n        totalImages: data.timeSeriesData.totalImages,\n        annotatedImages: data.timeSeriesData.annotationData.length,\n        manualAdjustments: data.timeSeriesData.annotationData.filter(\n          item => item.metadata.isManualAdjustment\n        ).length\n      };\n    }\n\n    return summary;\n  }\n\n  /**\n   * ä¿å­˜å›¾åƒæ ‡æ³¨æ•°æ®\n   */\n  async saveImageAnnotation(imageId, annotationData) {\n    // ä¼˜å…ˆä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿä¿å­˜\n    if (this.useFileSystem) {\n      try {\n        const success = await this.saveImageAnnotationToFileSystem(imageId, annotationData);\n        if (success) {\n          console.log(`æˆåŠŸä¿å­˜å›¾åƒ ${imageId} çš„æ ‡æ³¨æ•°æ®åˆ°æ–‡ä»¶ç³»ç»Ÿ`);\n          // åªåœ¨æ–‡ä»¶ç³»ç»Ÿä¿å­˜æˆåŠŸæ—¶æ‰æ›´æ–°å†…å­˜ï¼ˆç”¨äºç»Ÿè®¡ç­‰åŠŸèƒ½ï¼‰\n          this.imageAnnotations.set(imageId, annotationData);\n          // å¤‡ä»½åˆ°localStorage\n          this.saveImageAnnotationsToLocalStorage();\n          return true;\n        }\n      } catch (error) {\n        console.error(`ä¿å­˜å›¾åƒ ${imageId} æ ‡æ³¨æ•°æ®åˆ°æ–‡ä»¶ç³»ç»Ÿå¤±è´¥:`, error);\n      }\n    } else {\n      // å¦‚æœæ²¡æœ‰å¯ç”¨æ–‡ä»¶ç³»ç»Ÿï¼Œæ›´æ–°å†…å­˜\n      this.imageAnnotations.set(imageId, annotationData);\n    }\n\n    // å¦‚æœæ–‡ä»¶ç³»ç»Ÿä¿å­˜å¤±è´¥æˆ–æœªå¯ç”¨ï¼Œå°è¯•ä¿å­˜åˆ°æœåŠ¡å™¨\n    try {\n      const response = await fetch(`${this.apiBaseUrl}/save-image-annotation`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          imageId,\n          annotationData\n        })\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        console.log(`æˆåŠŸä¿å­˜å›¾åƒ ${imageId} çš„æ ‡æ³¨æ•°æ®åˆ°æœåŠ¡å™¨`);\n        // å¤‡ä»½åˆ°localStorage\n        this.saveImageAnnotationsToLocalStorage();\n        return true;\n      } else {\n        throw new Error(result.error || 'æœåŠ¡å™¨ä¿å­˜å¤±è´¥');\n      }\n    } catch (error) {\n      console.error(`ä¿å­˜å›¾åƒ ${imageId} æ ‡æ³¨æ•°æ®åˆ°æœåŠ¡å™¨å¤±è´¥:`, error);\n      // å¦‚æœæ— æ³•ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œè‡³å°‘ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½\n      this.saveImageAnnotationsToLocalStorage();\n      return false;\n    }\n  }\n\n  /**\n   * è·å–å›¾åƒæ ‡æ³¨æ•°æ®\n   */\n  async getImageAnnotation(imageId) {\n    // å¦‚æœå¯ç”¨äº†æ–‡ä»¶ç³»ç»Ÿï¼Œç›´æ¥ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–\n    if (this.useFileSystem && this.fileSystemManager) {\n      try {\n        const annotationData = await this.fileSystemManager.loadAnnotationFile(imageId);\n        if (annotationData) {\n          console.log(`[æ ‡æ³¨] è¯»å–æˆåŠŸ ${imageId}: ${annotationData.annotations?.length || 0} ä¸ªæ ‡æ³¨ç‚¹`);\n        }\n        return annotationData;\n      } catch (error) {\n        console.warn(`ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½æ ‡æ³¨å¤±è´¥ (${imageId}):`, error);\n        return null;\n      }\n    }\n\n    // å¦‚æœæ²¡æœ‰å¯ç”¨æ–‡ä»¶ç³»ç»Ÿï¼Œä»å†…å­˜ä¸­è·å–ï¼ˆå‘åå…¼å®¹ï¼‰\n    return this.imageAnnotations.get(imageId) || null;\n  }\n\n  /**\n   * ä»æœåŠ¡å™¨åŠ è½½å›¾åƒæ ‡æ³¨æ•°æ®\n   */\n  async loadImageAnnotationsFromServer() {\n    try {\n      const response = await fetch(`${this.apiBaseUrl}/load-image-annotations`);\n      const result = await response.json();\n      \n      if (result.success && result.data) {\n        // å°†æ•°æ®åŠ è½½åˆ°Mapä¸­\n        for (const [imageId, annotationData] of Object.entries(result.data.imageAnnotations || {})) {\n          this.imageAnnotations.set(imageId, annotationData);\n        }\n        \n        console.log(`ä»æœåŠ¡å™¨åŠ è½½äº† ${this.imageAnnotations.size} å¼ å›¾åƒçš„æ ‡æ³¨æ•°æ®`);\n        return result.data;\n      } else {\n        console.log('æœåŠ¡å™¨æ²¡æœ‰å›¾åƒæ ‡æ³¨æ•°æ®æˆ–åŠ è½½å¤±è´¥');\n        return { imageAnnotations: {} };\n      }\n    } catch (error) {\n      console.warn('ä»æœåŠ¡å™¨åŠ è½½å›¾åƒæ ‡æ³¨æ•°æ®å¤±è´¥ï¼Œå°è¯•ä»localStorageæ¢å¤:', error.message);\n      this.loadImageAnnotationsFromLocalStorage();\n      return { imageAnnotations: {} };\n    }\n  }\n\n  /**\n   * ä¿å­˜å›¾åƒæ ‡æ³¨åˆ°localStorageä½œä¸ºå¤‡ä»½\n   */\n  saveImageAnnotationsToLocalStorage() {\n    try {\n      const data = {};\n      for (const [imageId, annotationData] of this.imageAnnotations) {\n        data[imageId] = annotationData;\n      }\n      localStorage.setItem('image_annotations_backup', JSON.stringify({\n        saveTime: new Date().toISOString(),\n        imageAnnotations: data\n      }));\n      console.log('å›¾åƒæ ‡æ³¨æ•°æ®å·²å¤‡ä»½åˆ°localStorage');\n    } catch (error) {\n      console.error('å¤‡ä»½å›¾åƒæ ‡æ³¨åˆ°localStorageå¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * ä»localStorageæ¢å¤å›¾åƒæ ‡æ³¨æ•°æ®\n   */\n  loadImageAnnotationsFromLocalStorage() {\n    try {\n      const backup = localStorage.getItem('image_annotations_backup');\n      if (backup) {\n        const data = JSON.parse(backup);\n        for (const [imageId, annotationData] of Object.entries(data.imageAnnotations || {})) {\n          if (!this.imageAnnotations.has(imageId)) {\n            this.imageAnnotations.set(imageId, annotationData);\n          }\n        }\n        console.log('ä»localStorageæ¢å¤äº†å›¾åƒæ ‡æ³¨å¤‡ä»½æ•°æ®');\n      }\n    } catch (error) {\n      console.error('ä»localStorageæ¢å¤å›¾åƒæ ‡æ³¨æ•°æ®å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * å¯¼å‡ºæ‰€æœ‰å›¾åƒæ ‡æ³¨æ•°æ®ï¼ˆæ–°çš„ç®€åŒ–ç‰ˆæœ¬ï¼‰\n   */\n  exportAllImageAnnotations() {\n    const exportData = {\n      exportTime: new Date().toISOString(),\n      version: '2.0',\n      format: 'simple_image_annotations',\n      totalImages: this.imageAnnotations.size,\n      annotations: {}\n    };\n\n    for (const [imageId, annotationData] of this.imageAnnotations) {\n      if (annotationData.annotations && annotationData.annotations.length > 0) {\n        exportData.annotations[imageId] = annotationData.annotations;\n      }\n    }\n\n    return exportData;\n  }\n\n  /**\n   * è·å–æ‰€æœ‰æœ‰æ ‡æ³¨çš„å›¾åƒç»Ÿè®¡\n   */\n  getImageAnnotationStats() {\n    let annotatedImages = 0;\n    let totalKeypoints = 0;\n\n    for (const [imageId, annotationData] of this.imageAnnotations) {\n      if (annotationData.annotations && annotationData.annotations.length > 0) {\n        annotatedImages++;\n        totalKeypoints += annotationData.annotations.length;\n      }\n    }\n\n    return {\n      totalImages: this.imageAnnotations.size,\n      annotatedImages,\n      totalKeypoints,\n      averageKeypointsPerImage: annotatedImages > 0 ? (totalKeypoints / annotatedImages).toFixed(2) : 0\n    };\n  }\n\n  /**\n   * ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½æ‰€æœ‰æ ‡æ³¨æ•°æ®\n   */\n  async loadAnnotationsFromFileSystem() {\n    if (!this.fileSystemManager) {\n      throw new Error('æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨æœªè®¾ç½®');\n    }\n\n    console.log('å¼€å§‹ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½æ ‡æ³¨æ•°æ®...');\n\n    try {\n      const imageIds = await this.fileSystemManager.getAllAnnotationFiles();\n      console.log(`å‘ç° ${imageIds.length} ä¸ªæ ‡æ³¨æ–‡ä»¶:`, imageIds);\n\n      let loadedCount = 0;\n      for (const imageId of imageIds) {\n        try {\n          const annotationData = await this.fileSystemManager.loadAnnotationFile(imageId);\n          if (annotationData) {\n            this.imageAnnotations.set(imageId, annotationData);\n            loadedCount++;\n            console.log(`æˆåŠŸåŠ è½½æ ‡æ³¨æ–‡ä»¶: ${imageId}, åŒ…å« ${annotationData.annotations?.length || 0} ä¸ªæ ‡æ³¨ç‚¹`);\n          }\n        } catch (error) {\n          console.error(`åŠ è½½æ ‡æ³¨æ–‡ä»¶å¤±è´¥ (${imageId}):`, error);\n        }\n      }\n\n      console.log(`ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½äº† ${loadedCount} ä¸ªå›¾åƒçš„æ ‡æ³¨æ•°æ®ï¼Œæ€»è®¡ ${this.imageAnnotations.size} ä¸ªå›¾åƒåœ¨å†…å­˜ä¸­`);\n    } catch (error) {\n      console.error('ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½æ ‡æ³¨æ•°æ®å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ä¿å­˜å›¾åƒæ ‡æ³¨åˆ°æ–‡ä»¶ç³»ç»Ÿ\n   */\n  async saveImageAnnotationToFileSystem(imageId, annotationData) {\n    if (!this.fileSystemManager) {\n      console.warn('æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨æœªè®¾ç½®ï¼Œè·³è¿‡æ–‡ä»¶ç³»ç»Ÿä¿å­˜');\n      return false;\n    }\n\n    try {\n      await this.fileSystemManager.saveAnnotationFile(imageId, annotationData);\n      return true;\n    } catch (error) {\n      console.error(`ä¿å­˜æ ‡æ³¨åˆ°æ–‡ä»¶ç³»ç»Ÿå¤±è´¥ (${imageId}):`, error);\n      return false;\n    }\n  }\n\n  /**\n   * ä»æ–‡ä»¶ç³»ç»Ÿåˆ é™¤å›¾åƒæ ‡æ³¨\n   */\n  async deleteImageAnnotationFromFileSystem(imageId) {\n    if (!this.fileSystemManager) {\n      return false;\n    }\n\n    try {\n      return await this.fileSystemManager.deleteAnnotationFile(imageId);\n    } catch (error) {\n      console.error(`ä»æ–‡ä»¶ç³»ç»Ÿåˆ é™¤æ ‡æ³¨å¤±è´¥ (${imageId}):`, error);\n      return false;\n    }\n  }\n\n  /**\n   * æ‰«ææ ‡æ³¨æ–‡ä»¶ï¼ˆç”¨äºç»Ÿè®¡ï¼Œä¸åŠ è½½åˆ°å†…å­˜ï¼‰\n   */\n  async scanAnnotationFiles() {\n    if (!this.fileSystemManager) {\n      return;\n    }\n\n    try {\n      const imageIds = await this.fileSystemManager.getAllAnnotationFiles();\n      // è¿™é‡Œåªæ˜¯ä¸ºäº†è§¦å‘æ‰«æå’Œæ—¥å¿—è¾“å‡ºï¼Œä¸å®é™…åŠ è½½åˆ°å†…å­˜\n      console.log(`[æ ‡æ³¨] æ‰«æå®Œæˆï¼Œå‘ç° ${imageIds.length} ä¸ªæ ‡æ³¨æ–‡ä»¶`);\n\n      // æ‰«æè·³è¿‡ä¿¡æ¯æ–‡ä»¶\n      await this.scanSkipInfoFiles();\n    } catch (error) {\n      console.error('[æ ‡æ³¨] æ‰«ææ ‡æ³¨æ–‡ä»¶å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * æ‰«æè·³è¿‡ä¿¡æ¯æ–‡ä»¶\n   */\n  async scanSkipInfoFiles() {\n    if (!this.fileSystemManager) {\n      return;\n    }\n\n    try {\n      if (this.useFileSystem && this.fileSystemManager.getAllSkipInfo) {\n        // HTTPæ¨¡å¼ï¼šé€šè¿‡APIè·å–è·³è¿‡ä¿¡æ¯\n        const skipInfoData = await this.fileSystemManager.getAllSkipInfo();\n        \n        let skipFileCount = 0;\n        for (const [plantId, skipData] of Object.entries(skipInfoData)) {\n          this.annotations.set(plantId, skipData);\n          skipFileCount++;\n          console.log(`[æ ‡æ³¨] åŠ è½½è·³è¿‡ä¿¡æ¯: ${plantId} - ${skipData.skipReason}`);\n        }\n        \n        if (skipFileCount > 0) {\n          console.log(`[æ ‡æ³¨] æˆåŠŸåŠ è½½ ${skipFileCount} ä¸ªæ¤æ ªçš„è·³è¿‡ä¿¡æ¯`);\n        }\n      } else {\n        // åŸæœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼\n        const annotationsHandle = this.fileSystemManager.getAnnotationsDirectory();\n        if (!annotationsHandle) {\n          return;\n        }\n\n        let skipFileCount = 0;\n        for await (const [name, handle] of annotationsHandle.entries()) {\n          if (handle.kind === 'file' && name.endsWith('_skip_info.json')) {\n            try {\n              const file = await handle.getFile();\n              const content = await file.text();\n              const skipData = JSON.parse(content);\n\n              // å°†è·³è¿‡ä¿¡æ¯åŠ è½½åˆ°å†…å­˜\n              this.annotations.set(skipData.plantId, skipData);\n              skipFileCount++;\n\n              console.log(`[æ ‡æ³¨] åŠ è½½è·³è¿‡ä¿¡æ¯: ${skipData.plantId} - ${skipData.skipReason}`);\n            } catch (error) {\n              console.warn(`[æ ‡æ³¨] åŠ è½½è·³è¿‡ä¿¡æ¯æ–‡ä»¶å¤±è´¥ (${name}):`, error);\n            }\n          }\n        }\n\n        if (skipFileCount > 0) {\n          console.log(`[æ ‡æ³¨] æˆåŠŸåŠ è½½ ${skipFileCount} ä¸ªæ¤æ ªçš„è·³è¿‡ä¿¡æ¯`);\n        }\n      }\n    } catch (error) {\n      console.error('[æ ‡æ³¨] æ‰«æè·³è¿‡ä¿¡æ¯æ–‡ä»¶å¤±è´¥:', error);\n    }\n  }\n}","/**\n * æ—¶é—´åºåˆ—æ ‡æ³¨ç®¡ç†å™¨\n * \n * åŠŸèƒ½ï¼š\n * - ç®¡ç†æ¤æ ªåœ¨ä¸åŒæ—¶é—´ç‚¹çš„æ ‡æ³¨æ•°æ®\n * - æ”¯æŒæ ‡æ³¨ä¼ æ’­ï¼ˆé¦–æ¬¡æ ‡æ³¨è‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰æ—¶é—´ç‚¹ï¼‰\n * - æ”¯æŒå¾®è°ƒï¼ˆè°ƒæ•´åå‘åä¼ æ’­åˆ°åç»­æ—¶é—´ç‚¹ï¼‰\n * - å¤„ç†æ—¶é—´åºåˆ—çš„æ ‡æ³¨ç»§æ‰¿å’Œè¦†ç›–\n */\n\nexport class TimeSeriesAnnotationManager {\n  constructor() {\n    // å­˜å‚¨æ ¼å¼ï¼šplantId -> viewAngle -> imageId -> annotations\n    this.timeSeriesAnnotations = new Map();\n    // å­˜å‚¨å›¾åƒçš„æ—¶é—´é¡ºåºï¼šplantId -> viewAngle -> [imageId...]\n    this.timeSequences = new Map();\n    // æ ‡è®°å“ªäº›æ˜¯ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´çš„æ—¶é—´ç‚¹\n    this.manualAdjustments = new Map();\n  }\n\n  /**\n   * åˆå§‹åŒ–æ¤æ ªçš„æ—¶é—´åºåˆ—\n   */\n  initializePlantTimeSeries(plantId, viewAngle, images) {\n    const plantKey = `${plantId}_${viewAngle}`;\n    \n    // æŒ‰æ—¶é—´æ’åºå›¾åƒ\n    const sortedImages = images.sort((a, b) => a.dateTime - b.dateTime);\n    const imageIds = sortedImages.map(img => img.id);\n    \n    // å­˜å‚¨æ—¶é—´åºåˆ—\n    if (!this.timeSequences.has(plantId)) {\n      this.timeSequences.set(plantId, new Map());\n    }\n    this.timeSequences.get(plantId).set(viewAngle, imageIds);\n    \n    // åˆå§‹åŒ–æ ‡æ³¨å­˜å‚¨\n    if (!this.timeSeriesAnnotations.has(plantId)) {\n      this.timeSeriesAnnotations.set(plantId, new Map());\n    }\n    if (!this.timeSeriesAnnotations.get(plantId).has(viewAngle)) {\n      this.timeSeriesAnnotations.get(plantId).set(viewAngle, new Map());\n    }\n    \n    console.log(`åˆå§‹åŒ–æ¤æ ª ${plantId} è§†è§’ ${viewAngle} çš„æ—¶é—´åºåˆ—ï¼Œå…± ${imageIds.length} ä¸ªæ—¶é—´ç‚¹`);\n    \n    return {\n      plantId,\n      viewAngle,\n      imageIds,\n      totalImages: imageIds.length,\n      firstImageId: imageIds[0],\n      lastImageId: imageIds[imageIds.length - 1]\n    };\n  }\n\n  /**\n   * ä¿å­˜æ ‡æ³¨å¹¶å¤„ç†ä¼ æ’­é€»è¾‘\n   */\n  saveAnnotations(plantId, viewAngle, imageId, annotations, isManualAdjustment = false) {\n    const plantAnnotations = this.timeSeriesAnnotations.get(plantId);\n    if (!plantAnnotations) {\n      throw new Error(`æ¤æ ª ${plantId} æœªåˆå§‹åŒ–`);\n    }\n\n    const viewAnnotations = plantAnnotations.get(viewAngle);\n    if (!viewAnnotations) {\n      throw new Error(`æ¤æ ª ${plantId} è§†è§’ ${viewAngle} æœªåˆå§‹åŒ–`);\n    }\n\n    const timeSequence = this.timeSequences.get(plantId)?.get(viewAngle);\n    if (!timeSequence) {\n      throw new Error(`æ¤æ ª ${plantId} è§†è§’ ${viewAngle} æ—¶é—´åºåˆ—æœªåˆå§‹åŒ–`);\n    }\n\n    const currentImageIndex = timeSequence.indexOf(imageId);\n    if (currentImageIndex === -1) {\n      throw new Error(`å›¾åƒ ${imageId} ä¸åœ¨æ—¶é—´åºåˆ—ä¸­`);\n    }\n\n    // ä¿å­˜å½“å‰æ—¶é—´ç‚¹çš„æ ‡æ³¨\n    viewAnnotations.set(imageId, {\n      annotations,\n      timestamp: new Date().toISOString(),\n      isManualAdjustment\n    });\n\n    // è®°å½•æ‰‹åŠ¨è°ƒæ•´\n    if (isManualAdjustment) {\n      const adjustmentKey = `${plantId}_${viewAngle}`;\n      if (!this.manualAdjustments.has(adjustmentKey)) {\n        this.manualAdjustments.set(adjustmentKey, new Set());\n      }\n      this.manualAdjustments.get(adjustmentKey).add(imageId);\n    }\n\n    // å¤„ç†ä¼ æ’­é€»è¾‘\n    this.propagateAnnotations(plantId, viewAngle, imageId, annotations, currentImageIndex);\n\n    console.log(`ä¿å­˜æ¤æ ª ${plantId} è§†è§’ ${viewAngle} å›¾åƒ ${imageId} çš„æ ‡æ³¨ï¼ŒåŒ…å« ${annotations.length} ä¸ªå…³é”®ç‚¹`);\n    \n    return {\n      savedImageId: imageId,\n      propagatedCount: this.getPropagationCount(plantId, viewAngle, currentImageIndex),\n      isFirstAnnotation: currentImageIndex === 0 && !isManualAdjustment,\n      isManualAdjustment\n    };\n  }\n\n  /**\n   * æ ‡æ³¨ä¼ æ’­é€»è¾‘\n   */\n  propagateAnnotations(plantId, viewAngle, sourceImageId, annotations, sourceImageIndex) {\n    const timeSequence = this.timeSequences.get(plantId).get(viewAngle);\n    const viewAnnotations = this.timeSeriesAnnotations.get(plantId).get(viewAngle);\n    const adjustmentKey = `${plantId}_${viewAngle}`;\n    const manualAdjustments = this.manualAdjustments.get(adjustmentKey) || new Set();\n\n    // å¦‚æœè¿™æ˜¯é¦–æ¬¡æ ‡æ³¨ï¼ˆç¬¬ä¸€å¼ å›¾åƒï¼‰ï¼Œä¼ æ’­åˆ°æ‰€æœ‰æœªæ‰‹åŠ¨è°ƒæ•´çš„æ—¶é—´ç‚¹\n    if (sourceImageIndex === 0) {\n      for (let i = 1; i < timeSequence.length; i++) {\n        const targetImageId = timeSequence[i];\n        \n        // å¦‚æœè¯¥æ—¶é—´ç‚¹æ²¡æœ‰è¢«æ‰‹åŠ¨è°ƒæ•´è¿‡ï¼Œåº”ç”¨æ ‡æ³¨\n        if (!manualAdjustments.has(targetImageId)) {\n          viewAnnotations.set(targetImageId, {\n            annotations: this.deepCloneAnnotations(annotations),\n            timestamp: new Date().toISOString(),\n            isManualAdjustment: false,\n            inheritedFrom: sourceImageId\n          });\n        }\n      }\n      console.log(`ä»é¦–ä¸ªå›¾åƒ ${sourceImageId} ä¼ æ’­æ ‡æ³¨åˆ°åç»­ ${timeSequence.length - 1} ä¸ªæ—¶é—´ç‚¹`);\n    } \n    // å¦‚æœè¿™æ˜¯ä¸­é—´æ—¶é—´ç‚¹çš„è°ƒæ•´ï¼Œå‘åä¼ æ’­\n    else {\n      let propagatedCount = 0;\n      for (let i = sourceImageIndex + 1; i < timeSequence.length; i++) {\n        const targetImageId = timeSequence[i];\n        \n        // å¦‚æœåç»­æ—¶é—´ç‚¹æ²¡æœ‰æ›´æ–°çš„æ‰‹åŠ¨è°ƒæ•´ï¼Œåº”ç”¨å½“å‰è°ƒæ•´\n        if (!manualAdjustments.has(targetImageId)) {\n          viewAnnotations.set(targetImageId, {\n            annotations: this.deepCloneAnnotations(annotations),\n            timestamp: new Date().toISOString(),\n            isManualAdjustment: false,\n            inheritedFrom: sourceImageId\n          });\n          propagatedCount++;\n        } else {\n          // é‡åˆ°æ‰‹åŠ¨è°ƒæ•´çš„æ—¶é—´ç‚¹ï¼Œåœæ­¢ä¼ æ’­\n          break;\n        }\n      }\n      \n      if (propagatedCount > 0) {\n        console.log(`ä»æ—¶é—´ç‚¹ ${sourceImageIndex} å‘åä¼ æ’­æ ‡æ³¨åˆ° ${propagatedCount} ä¸ªæ—¶é—´ç‚¹`);\n      }\n    }\n  }\n\n  /**\n   * è·å–æŒ‡å®šæ—¶é—´ç‚¹çš„æ ‡æ³¨\n   */\n  getAnnotations(plantId, viewAngle, imageId) {\n    const viewAnnotations = this.timeSeriesAnnotations.get(plantId)?.get(viewAngle);\n    if (!viewAnnotations) {\n      return [];\n    }\n\n    const annotationData = viewAnnotations.get(imageId);\n    return annotationData ? annotationData.annotations : [];\n  }\n\n  /**\n   * è·å–æ ‡æ³¨çš„å…ƒæ•°æ®\n   */\n  getAnnotationMetadata(plantId, viewAngle, imageId) {\n    const viewAnnotations = this.timeSeriesAnnotations.get(plantId)?.get(viewAngle);\n    if (!viewAnnotations) {\n      return null;\n    }\n\n    const data = viewAnnotations.get(imageId);\n    if (!data) {\n      return null;\n    }\n\n    const timeSequence = this.timeSequences.get(plantId)?.get(viewAngle);\n    const imageIndex = timeSequence ? timeSequence.indexOf(imageId) : -1;\n\n    return {\n      hasAnnotations: data.annotations.length > 0,\n      isManualAdjustment: data.isManualAdjustment,\n      inheritedFrom: data.inheritedFrom,\n      timestamp: data.timestamp,\n      imageIndex,\n      isFirstImage: imageIndex === 0,\n      isLastImage: imageIndex === timeSequence.length - 1\n    };\n  }\n\n  /**\n   * è·å–ä¼ æ’­ç»Ÿè®¡ä¿¡æ¯\n   */\n  getPropagationCount(plantId, viewAngle, fromIndex) {\n    const timeSequence = this.timeSequences.get(plantId)?.get(viewAngle);\n    if (!timeSequence) return 0;\n\n    if (fromIndex === 0) {\n      // é¦–æ¬¡æ ‡æ³¨ï¼Œè®¡ç®—ä¼ æ’­åˆ°çš„æ€»æ•°\n      return timeSequence.length - 1;\n    } else {\n      // ä¸­é—´è°ƒæ•´ï¼Œè®¡ç®—å‘åä¼ æ’­çš„æ•°é‡\n      const adjustmentKey = `${plantId}_${viewAngle}`;\n      const manualAdjustments = this.manualAdjustments.get(adjustmentKey) || new Set();\n      \n      let count = 0;\n      for (let i = fromIndex + 1; i < timeSequence.length; i++) {\n        if (!manualAdjustments.has(timeSequence[i])) {\n          count++;\n        } else {\n          break;\n        }\n      }\n      return count;\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æ˜¯å¦æœ‰æ ‡æ³¨æ•°æ®\n   */\n  hasAnnotations(plantId, viewAngle, imageId) {\n    const annotations = this.getAnnotations(plantId, viewAngle, imageId);\n    return annotations.length > 0;\n  }\n\n  /**\n   * è·å–æ¤æ ªè§†è§’çš„æ ‡æ³¨ç»Ÿè®¡\n   */\n  getAnnotationStats(plantId, viewAngle) {\n    const timeSequence = this.timeSequences.get(plantId)?.get(viewAngle);\n    if (!timeSequence) {\n      return { total: 0, annotated: 0, manual: 0, inherited: 0 };\n    }\n\n    const viewAnnotations = this.timeSeriesAnnotations.get(plantId)?.get(viewAngle);\n    if (!viewAnnotations) {\n      return { total: timeSequence.length, annotated: 0, manual: 0, inherited: 0 };\n    }\n\n    let annotated = 0;\n    let manual = 0;\n    let inherited = 0;\n\n    for (const imageId of timeSequence) {\n      const data = viewAnnotations.get(imageId);\n      if (data && data.annotations.length > 0) {\n        annotated++;\n        if (data.isManualAdjustment) {\n          manual++;\n        } else if (data.inheritedFrom) {\n          inherited++;\n        }\n      }\n    }\n\n    return {\n      total: timeSequence.length,\n      annotated,\n      manual,\n      inherited,\n      coverage: ((annotated / timeSequence.length) * 100).toFixed(1)\n    };\n  }\n\n  /**\n   * æ·±åº¦å…‹éš†æ ‡æ³¨æ•°æ®\n   */\n  deepCloneAnnotations(annotations) {\n    return annotations.map(annotation => ({\n      ...annotation,\n      x: annotation.x,\n      y: annotation.y\n    }));\n  }\n\n  /**\n   * æ¸…é™¤æ¤æ ªçš„æ‰€æœ‰æ ‡æ³¨\n   */\n  clearPlantAnnotations(plantId, viewAngle) {\n    const plantAnnotations = this.timeSeriesAnnotations.get(plantId);\n    if (plantAnnotations && plantAnnotations.has(viewAngle)) {\n      plantAnnotations.get(viewAngle).clear();\n    }\n\n    const adjustmentKey = `${plantId}_${viewAngle}`;\n    if (this.manualAdjustments.has(adjustmentKey)) {\n      this.manualAdjustments.get(adjustmentKey).clear();\n    }\n\n    console.log(`æ¸…é™¤æ¤æ ª ${plantId} è§†è§’ ${viewAngle} çš„æ‰€æœ‰æ ‡æ³¨`);\n  }\n\n  /**\n   * å¯¼å‡ºæ—¶é—´åºåˆ—æ ‡æ³¨æ•°æ®\n   */\n  exportTimeSeriesData(plantId, viewAngle) {\n    const timeSequence = this.timeSequences.get(plantId)?.get(viewAngle);\n    const viewAnnotations = this.timeSeriesAnnotations.get(plantId)?.get(viewAngle);\n    \n    if (!timeSequence || !viewAnnotations) {\n      return null;\n    }\n\n    const exportData = {\n      plantId,\n      viewAngle,\n      totalImages: timeSequence.length,\n      annotationData: []\n    };\n\n    for (const imageId of timeSequence) {\n      const data = viewAnnotations.get(imageId);\n      if (data) {\n        exportData.annotationData.push({\n          imageId,\n          annotations: data.annotations,\n          metadata: {\n            timestamp: data.timestamp,\n            isManualAdjustment: data.isManualAdjustment,\n            inheritedFrom: data.inheritedFrom\n          }\n        });\n      }\n    }\n\n    return exportData;\n  }\n\n  /**\n   * å¯¼å‡ºæ‰€æœ‰å›¾åƒçš„çº¯å‡€æ ‡æ³¨æ•°æ®ï¼ˆä¸åŒ…å«å†…éƒ¨ç®¡ç†ä¿¡æ¯ï¼‰\n   * è¿”å›æ ¼å¼ï¼š{ imageId: annotations[] }\n   */\n  exportAllImageAnnotations() {\n    const allImageAnnotations = {};\n    \n    // éå†æ‰€æœ‰æ¤æ ª\n    for (const [plantId, plantData] of this.timeSeriesAnnotations) {\n      // éå†æ¯ä¸ªæ¤æ ªçš„æ‰€æœ‰è§†è§’\n      for (const [viewAngle, viewAnnotations] of plantData) {\n        // éå†è¯¥è§†è§’çš„æ‰€æœ‰å›¾åƒ\n        for (const [imageId, annotationData] of viewAnnotations) {\n          // åŒ…å«æ‰€æœ‰æœ‰æ ‡æ³¨çš„å›¾åƒï¼Œä¸ç®¡æ˜¯åŸå§‹ã€ç»§æ‰¿è¿˜æ˜¯å¾®è°ƒçš„\n          if (annotationData.annotations && annotationData.annotations.length > 0) {\n            // åªä¿å­˜çº¯å‡€çš„æ ‡æ³¨ç‚¹æ•°æ®ï¼Œç§»é™¤å†…éƒ¨ç®¡ç†ä¿¡æ¯\n            allImageAnnotations[imageId] = annotationData.annotations.map(annotation => ({\n              id: annotation.id,\n              x: annotation.x,\n              y: annotation.y,\n              timestamp: annotation.timestamp\n            }));\n          }\n        }\n      }\n    }\n    \n    return allImageAnnotations;\n  }\n\n  /**\n   * å¯¼å‡ºæŒ‡å®šæ¤æ ªçš„æ‰€æœ‰å›¾åƒæ ‡æ³¨æ•°æ®\n   */\n  exportPlantImageAnnotations(plantId) {\n    const plantImageAnnotations = {};\n    const plantData = this.timeSeriesAnnotations.get(plantId);\n    \n    if (!plantData) {\n      return plantImageAnnotations;\n    }\n    \n    // éå†è¯¥æ¤æ ªçš„æ‰€æœ‰è§†è§’\n    for (const [viewAngle, viewAnnotations] of plantData) {\n      // éå†è¯¥è§†è§’çš„æ‰€æœ‰å›¾åƒ\n      for (const [imageId, annotationData] of viewAnnotations) {\n        if (annotationData.annotations && annotationData.annotations.length > 0) {\n          // åªä¿å­˜çº¯å‡€çš„æ ‡æ³¨ç‚¹æ•°æ®\n          plantImageAnnotations[imageId] = annotationData.annotations.map(annotation => ({\n            id: annotation.id,\n            x: annotation.x,\n            y: annotation.y,\n            timestamp: annotation.timestamp\n          }));\n        }\n      }\n    }\n    \n    return plantImageAnnotations;\n  }\n\n  /**\n   * è·å–æ ‡æ³¨æ•°æ®ç»Ÿè®¡ä¿¡æ¯\n   */\n  getExportStats() {\n    let totalImages = 0;\n    let annotatedImages = 0;\n    let totalKeypoints = 0;\n    const plantStats = {};\n    \n    for (const [plantId, plantData] of this.timeSeriesAnnotations) {\n      let plantImages = 0;\n      let plantAnnotatedImages = 0;\n      let plantKeypoints = 0;\n      \n      for (const [viewAngle, viewAnnotations] of plantData) {\n        for (const [imageId, annotationData] of viewAnnotations) {\n          plantImages++;\n          totalImages++;\n          \n          if (annotationData.annotations && annotationData.annotations.length > 0) {\n            plantAnnotatedImages++;\n            annotatedImages++;\n            plantKeypoints += annotationData.annotations.length;\n            totalKeypoints += annotationData.annotations.length;\n          }\n        }\n      }\n      \n      plantStats[plantId] = {\n        totalImages: plantImages,\n        annotatedImages: plantAnnotatedImages,\n        totalKeypoints: plantKeypoints,\n        completionRate: plantImages > 0 ? ((plantAnnotatedImages / plantImages) * 100).toFixed(1) : 0\n      };\n    }\n    \n    return {\n      totalImages,\n      annotatedImages,\n      totalKeypoints,\n      completionRate: totalImages > 0 ? ((annotatedImages / totalImages) * 100).toFixed(1) : 0,\n      plantStats\n    };\n  }\n\n  /**\n   * è°ƒè¯•ï¼šè·å–æ—¶é—´åºåˆ—ç®¡ç†å™¨çš„å½“å‰çŠ¶æ€\n   */\n  getDebugStatus() {\n    const status = {\n      plantsCount: this.timeSeriesAnnotations.size,\n      totalSequences: 0,\n      totalAnnotatedImages: 0,\n      plantDetails: {}\n    };\n    \n    for (const [plantId, plantData] of this.timeSeriesAnnotations) {\n      const plantDetail = {\n        viewAnglesCount: plantData.size,\n        viewAngles: {}\n      };\n      \n      for (const [viewAngle, viewAnnotations] of plantData) {\n        status.totalSequences++;\n        const annotatedImages = Array.from(viewAnnotations.values()).filter(\n          data => data.annotations && data.annotations.length > 0\n        ).length;\n        \n        status.totalAnnotatedImages += annotatedImages;\n        \n        plantDetail.viewAngles[viewAngle] = {\n          totalImages: viewAnnotations.size,\n          annotatedImages,\n          imageIds: Array.from(viewAnnotations.keys())\n        };\n      }\n      \n      status.plantDetails[plantId] = plantDetail;\n    }\n    \n    console.log('æ—¶é—´åºåˆ—ç®¡ç†å™¨çŠ¶æ€:', status);\n    return status;\n  }\n\n  /**\n   * è°ƒè¯•ï¼šå¼ºåˆ¶å¯¼å‡ºæ‰€æœ‰æ—¶é—´åºåˆ—æ•°æ®ï¼ˆè¯¦ç»†ç‰ˆæœ¬ï¼‰\n   */\n  exportAllTimeSeriesDataDebug() {\n    const debugData = {\n      managedPlants: this.timeSeriesAnnotations.size,\n      allData: {}\n    };\n    \n    for (const [plantId, plantData] of this.timeSeriesAnnotations) {\n      debugData.allData[plantId] = {};\n      \n      for (const [viewAngle, viewAnnotations] of plantData) {\n        debugData.allData[plantId][viewAngle] = {};\n        \n        for (const [imageId, annotationData] of viewAnnotations) {\n          debugData.allData[plantId][viewAngle][imageId] = {\n            hasAnnotations: !!(annotationData.annotations && annotationData.annotations.length > 0),\n            annotationCount: annotationData.annotations?.length || 0,\n            annotations: annotationData.annotations || [],\n            metadata: {\n              timestamp: annotationData.timestamp,\n              isManualAdjustment: annotationData.isManualAdjustment,\n              inheritedFrom: annotationData.inheritedFrom\n            }\n          };\n        }\n      }\n    }\n    \n    console.log('æ—¶é—´åºåˆ—è¯¦ç»†æ•°æ®:', debugData);\n    return debugData;\n  }\n} ","/**\n * æ¤ç‰©æ•°æ®ç®¡ç†å™¨\n * \n * åŠŸèƒ½ï¼š\n * - æ¤ç‰©æ•°æ®çš„åŠ è½½å’Œè§£æ\n * - å›¾åƒæ—¶é—´æ’åºå’Œç®¡ç†\n * - æ ‡æ³¨çŠ¶æ€è·Ÿè¸ª\n * - æ•°æ®ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–\n */\n\nimport { HttpFileSystemManager } from './HttpFileSystemManager.js';\nimport { AnnotationStorageManager } from './AnnotationStorageManager.js';\nimport { TimeSeriesAnnotationManager } from './TimeSeriesAnnotationManager.js';\n\nexport class PlantDataManager {\n  constructor() {\n    this.fileSystemManager = new HttpFileSystemManager();\n    this.annotationStorage = new AnnotationStorageManager();\n    this.timeSeriesManager = new TimeSeriesAnnotationManager();\n    this.plants = new Map();\n    this.plantImages = new Map();\n    this.annotationStatus = new Map();\n    this.loadingPlants = new Set();\n  }\n\n  /**\n   * åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨\n   */\n  async initialize() {\n    try {\n      // åˆå§‹åŒ–HTTPæ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨\n      await this.fileSystemManager.initialize();\n      \n      await this.annotationStorage.initialize();\n      \n      // æ¢å¤æ—¶é—´åºåˆ—æ•°æ®åˆ°ç®¡ç†å™¨\n      this.annotationStorage.restoreTimeSeriesData(this.timeSeriesManager);\n      \n      // è®¾ç½®æ—¶é—´åºåˆ—ç®¡ç†å™¨çš„å¼•ç”¨åˆ°å­˜å‚¨ç®¡ç†å™¨\n      this.annotationStorage.setTimeSeriesManager(this.timeSeriesManager);\n      \n      console.log('PlantDataManager åˆå§‹åŒ–å®Œæˆ');\n    } catch (error) {\n      console.error('PlantDataManager åˆå§‹åŒ–å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * åŠ è½½æ•°æ®é›†ä¸­çš„æ‰€æœ‰æ¤ç‰©\n   */\n  async loadDataset() {\n    console.log('å¼€å§‹åŠ è½½æ•°æ®é›†...');\n\n    try {\n      // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œcleanupï¼Œå› ä¸ºä¼šæ¸…é™¤annotationsç›®å½•å¥æŸ„\n      // åªæ¸…ç†æ¤ç‰©ç›¸å…³æ•°æ®\n      this.plants.clear();\n      this.plantImages.clear();\n      this.annotationStatus.clear();\n      this.loadingPlants.clear();\n\n      // è®¾ç½®æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨åˆ°æ ‡æ³¨å­˜å‚¨\n      this.annotationStorage.setFileSystemManager(this.fileSystemManager);\n\n      // é‡æ–°åˆå§‹åŒ–æ ‡æ³¨å­˜å‚¨ä»¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ\n      this.annotationStorage.isInitialized = false;\n      await this.annotationStorage.initialize();\n\n      // åˆå§‹åŒ–æ—¶é—´åºåˆ—ç›¸å…³åŠŸèƒ½\n      this.annotationStorage.restoreTimeSeriesData(this.timeSeriesManager);\n      this.annotationStorage.setTimeSeriesManager(this.timeSeriesManager);\n      \n      // éå†æ¤ç‰©æ–‡ä»¶å¤¹ï¼ˆä¸å†éœ€è¦ä¼ å…¥datasetHandleï¼‰\n      const plantFolders = await this.fileSystemManager.traversePlantDirectories();\n      \n      if (plantFolders.length === 0) {\n        throw new Error('æ•°æ®é›†ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¤ç‰©æ–‡ä»¶å¤¹');\n      }\n      \n      // æ‰¹é‡åŠ è½½æ¤ç‰©åŸºæœ¬ä¿¡æ¯\n      const plants = [];\n      for (const plantFolder of plantFolders) {\n        const plant = await this.createPlantData(plantFolder);\n        plants.push(plant);\n        this.plants.set(plant.id, plant);\n      }\n      \n      // ä»æŒä¹…åŒ–å­˜å‚¨æ¢å¤æ ‡æ³¨çŠ¶æ€\n      await this.restoreAnnotationStatus(plants);\n      \n      // æŒ‰æ¤ç‰©IDæ’åº\n      plants.sort((a, b) => a.id.localeCompare(b.id));\n      \n      console.log(`æˆåŠŸåŠ è½½ ${plants.length} ä¸ªæ¤ç‰©`);\n      return plants;\n      \n    } catch (error) {\n      console.error('åŠ è½½æ•°æ®é›†å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * æ¢å¤æ¤ç‰©çš„æ ‡æ³¨çŠ¶æ€\n   */\n  async restoreAnnotationStatus(plants) {\n    if (this.annotationStorage.useFileSystem) {\n      // æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼ï¼šæ£€æŸ¥æ¯ä¸ªæ¤ç‰©çš„æ ‡æ³¨æ–‡ä»¶\n      await this.restoreAnnotationStatusFromFileSystem(plants);\n    } else {\n      // æœåŠ¡å™¨æ¨¡å¼ï¼šä½¿ç”¨åŸæœ‰é€»è¾‘\n      const annotatedPlantIds = this.annotationStorage.getAnnotatedPlantIds();\n\n      for (const plant of plants) {\n        if (annotatedPlantIds.includes(plant.id)) {\n          const status = this.annotationStorage.getPlantStatus(plant.id);\n          const annotations = this.annotationStorage.getPlantAnnotations(plant.id);\n          const summary = this.annotationStorage.getPlantAnnotationSummary(plant.id);\n\n          plant.status = status;\n          plant.annotations = annotations;\n\n          // æ¢å¤è·³è¿‡ä¿¡æ¯\n          const annotationData = this.annotationStorage.annotations.get(plant.id);\n          if (annotationData && annotationData.status === 'skipped') {\n            plant.skipReason = annotationData.skipReason;\n            plant.skipDate = annotationData.skipDate;\n          }\n\n          // æ¢å¤è§†è§’é€‰æ‹©ä¿¡æ¯\n          if (summary) {\n            plant.selectedViewAngle = summary.selectedViewAngle;\n            plant.viewAngles = summary.availableViewAngles;\n\n            const skipInfo = plant.status === 'skipped' ? ` (è·³è¿‡: ${plant.skipReason})` : '';\n            console.log(`æ¢å¤æ¤æ ª ${plant.id} çš„æ ‡æ³¨çŠ¶æ€: ${status}, è§†è§’: ${summary.selectedViewAngle}, ${annotations.length} ä¸ªæ ‡æ³¨ç‚¹${skipInfo}`);\n          }\n\n          // ç¼“å­˜åˆ°å†…å­˜\n          this.annotationStatus.set(plant.id, annotations);\n        }\n      }\n    }\n  }\n\n  /**\n   * ä»æ–‡ä»¶ç³»ç»Ÿæ¢å¤æ¤ç‰©æ ‡æ³¨çŠ¶æ€ï¼ˆæ‰¹é‡ä¼˜åŒ–ç‰ˆï¼‰\n   */\n  async restoreAnnotationStatusFromFileSystem(plants) {\n    console.log('[æ ‡æ³¨] å¼€å§‹ä»æ–‡ä»¶ç³»ç»Ÿæ¢å¤æ¤ç‰©çŠ¶æ€...');\n\n    // ğŸš€ PERFORMANCE OPTIMIZATION: Try bulk loading first\n    let bulkAnnotationData = null;\n    try {\n      // Try to get bulk annotation data if AnnotationManager is available\n      if (window.PlantAnnotationTool?.annotationManager) {\n        console.log('[æ ‡æ³¨] å°è¯•ä½¿ç”¨æ‰¹é‡æ ‡æ³¨æ•°æ®è¿›è¡Œå¿«é€ŸçŠ¶æ€æ¢å¤...');\n        bulkAnnotationData = await window.PlantAnnotationTool.annotationManager.getAllAnnotationsInBulk();\n        \n        if (bulkAnnotationData) {\n          console.log('[æ ‡æ³¨] æ‰¹é‡æ ‡æ³¨æ•°æ®è·å–æˆåŠŸï¼Œä½¿ç”¨é«˜æ€§èƒ½æ¨¡å¼');\n          await this.restoreStatusFromBulkData(plants, bulkAnnotationData);\n          return; // Skip individual file reads completely\n        }\n      }\n    } catch (error) {\n      console.warn('[æ ‡æ³¨] æ‰¹é‡åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°å•ç‹¬æ–‡ä»¶è¯»å–æ¨¡å¼:', error);\n    }\n\n    // ğŸ”„ FALLBACK: Individual file reading (legacy mode)\n    console.log('[æ ‡æ³¨] ä½¿ç”¨ä¼ ç»Ÿå•ç‹¬æ–‡ä»¶è¯»å–æ¨¡å¼');\n    await this.restoreStatusFromIndividualFiles(plants);\n  }\n\n  /**\n   * ä»æ‰¹é‡æ•°æ®æ¢å¤æ¤ç‰©çŠ¶æ€ï¼ˆé«˜æ€§èƒ½æ¨¡å¼ï¼‰\n   */\n  async restoreStatusFromBulkData(plants, bulkData) {\n    console.log('[æ ‡æ³¨] ä½¿ç”¨æ‰¹é‡æ•°æ®è¿›è¡Œå¿«é€ŸçŠ¶æ€æ¢å¤...');\n    const startTime = performance.now();\n    \n    // Create lookup maps for fast access\n    const imageAnnotationsMap = bulkData.imageAnnotations || {};\n    const plantAnnotationsMap = bulkData.plantAnnotations || {};\n    \n    for (const plant of plants) {\n      try {\n        let hasAnnotations = false;\n        let totalAnnotations = 0;\n        let selectedViewAngle = null;\n        const viewAngleStats = {};\n\n        // è·å–æ¤ç‰©çš„æ‰€æœ‰å›¾åƒï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼‰\n        if (!this.plantImages.has(plant.id)) {\n          const imagesByView = await this.fileSystemManager.readPlantImages(plant.id);\n          this.plantImages.set(plant.id, imagesByView);\n        }\n\n        const imagesByView = this.plantImages.get(plant.id);\n\n        // æ£€æŸ¥æ¯ä¸ªè§†è§’çš„æ ‡æ³¨æƒ…å†µ - ä½¿ç”¨å†…å­˜æŸ¥æ‰¾è€Œéæ–‡ä»¶è¯»å–\n        for (const [viewAngle, images] of Object.entries(imagesByView)) {\n          let viewAnnotationCount = 0;\n\n          for (const image of images) {\n            // ğŸš€ FAST LOOKUP: Use in-memory data instead of file reads\n            const imageAnnotations = imageAnnotationsMap[image.id];\n            if (imageAnnotations && imageAnnotations.length > 0) {\n              hasAnnotations = true;\n              const count = imageAnnotations.length;\n              totalAnnotations += count;\n              viewAnnotationCount += count;\n\n              // è®°å½•æœ€å¸¸ç”¨çš„è§†è§’ä½œä¸ºé€‰ä¸­è§†è§’\n              if (!selectedViewAngle || viewAnnotationCount > (viewAngleStats[selectedViewAngle] || 0)) {\n                selectedViewAngle = viewAngle;\n              }\n            }\n          }\n\n          if (viewAnnotationCount > 0) {\n            viewAngleStats[viewAngle] = viewAnnotationCount;\n          }\n        }\n\n        // æ£€æŸ¥æ¤ç‰©çº§æ ‡æ³¨\n        const plantAnnotations = plantAnnotationsMap[plant.id];\n        if (plantAnnotations && plantAnnotations.length > 0) {\n          hasAnnotations = true;\n          totalAnnotations += plantAnnotations.length;\n        }\n\n        // æ£€æŸ¥æ˜¯å¦æœ‰è·³è¿‡ä¿¡æ¯\n        const skipData = this.annotationStorage.annotations.get(plant.id);\n        if (skipData && skipData.status === 'skipped') {\n          // æ¢å¤è·³è¿‡çŠ¶æ€\n          plant.status = 'skipped';\n          plant.skipReason = skipData.skipReason;\n          plant.skipDate = skipData.skipDate;\n        } else {\n          // ğŸ”§ FIX: Check for persisted completion status from dedicated API in bulk mode too\n          console.log(`[æ‰¹é‡æ¢å¤] æ£€æŸ¥æ¤ç‰© ${plant.id} çš„ä¸“ç”¨çŠ¶æ€API...`);\n          const persistedStatus = await this.annotationStorage.loadPlantStatus(plant.id);\n          console.log(`[æ‰¹é‡æ¢å¤] æ¤ç‰© ${plant.id} ä¸“ç”¨APIçŠ¶æ€: ${persistedStatus}`);\n          \n          if (persistedStatus === 'completed') {\n            // ä¿æŒå·²å®ŒæˆçŠ¶æ€ï¼Œå³ä½¿æ²¡æœ‰æ ‡æ³¨æ•°æ®  \n            plant.status = 'completed';\n            plant.selectedViewAngle = selectedViewAngle;\n            console.log(`[æ‰¹é‡æ¢å¤] æ¤ç‰© ${plant.id}: completed (ä»ä¸“ç”¨APIæ¢å¤)`);\n          } else if (hasAnnotations) {\n            // ğŸ”§ FIX: Plants with annotations are 'in-progress', not auto-completed\n            plant.status = 'in-progress';\n            plant.selectedViewAngle = selectedViewAngle;\n            console.log(`[æ‰¹é‡æ¢å¤] æ¤ç‰© ${plant.id}: in-progress (æœ‰æ ‡æ³¨æ•°æ®)`);\n          } else {\n            // æ— æ ‡æ³¨æ•°æ®ä¸”æ— æŒä¹…åŒ–çŠ¶æ€\n            plant.status = 'pending';\n            console.log(`[æ‰¹é‡æ¢å¤] æ¤ç‰© ${plant.id}: pending (æ— æ•°æ®)`);\n          }\n        }\n\n      } catch (error) {\n        console.warn(`[æ ‡æ³¨] æ£€æŸ¥æ¤ç‰© ${plant.id} çŠ¶æ€å¤±è´¥:`, error);\n        plant.status = 'pending';\n      }\n    }\n\n    const endTime = performance.now();\n    console.log(`[æ ‡æ³¨] æ‰¹é‡çŠ¶æ€æ¢å¤å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);\n  }\n\n  /**\n   * ä»å•ç‹¬æ–‡ä»¶æ¢å¤æ¤ç‰©çŠ¶æ€ï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰\n   */\n  async restoreStatusFromIndividualFiles(plants) {\n    console.log('[æ ‡æ³¨] ä½¿ç”¨ä¼ ç»Ÿæ–‡ä»¶è¯»å–æ¨¡å¼æ¢å¤çŠ¶æ€...');\n\n    // è·å–æ‰€æœ‰æ ‡æ³¨æ–‡ä»¶åˆ—è¡¨ï¼ˆä¸€æ¬¡æ€§è·å–ï¼‰\n    const allAnnotationFiles = await this.annotationStorage.fileSystemManager.getAllAnnotationFiles();\n    const annotationFileSet = new Set(allAnnotationFiles);\n\n    for (const plant of plants) {\n      try {\n        let hasAnnotations = false;\n        let totalAnnotations = 0;\n        let selectedViewAngle = null;\n        const viewAngleStats = {};\n\n        // è·å–æ¤ç‰©çš„æ‰€æœ‰å›¾åƒï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼‰\n        if (!this.plantImages.has(plant.id)) {\n          const imagesByView = await this.fileSystemManager.readPlantImages(plant.id);\n          this.plantImages.set(plant.id, imagesByView);\n        }\n\n        const imagesByView = this.plantImages.get(plant.id);\n\n        // æ£€æŸ¥æ¯ä¸ªè§†è§’çš„æ ‡æ³¨æƒ…å†µ\n        for (const [viewAngle, images] of Object.entries(imagesByView)) {\n          let viewAnnotationCount = 0;\n\n          for (const image of images) {\n            // å¿«é€Ÿæ£€æŸ¥ï¼šå¦‚æœæ ‡æ³¨æ–‡ä»¶å­˜åœ¨äºåˆ—è¡¨ä¸­ï¼Œæ‰å°è¯•è¯»å–\n            if (annotationFileSet.has(image.id)) {\n              const annotationData = await this.annotationStorage.getImageAnnotation(image.id);\n              if (annotationData && annotationData.annotations && annotationData.annotations.length > 0) {\n                hasAnnotations = true;\n                const count = annotationData.annotations.length;\n                totalAnnotations += count;\n                viewAnnotationCount += count;\n\n                // è®°å½•æœ€å¸¸ç”¨çš„è§†è§’ä½œä¸ºé€‰ä¸­è§†è§’\n                if (!selectedViewAngle || viewAnnotationCount > (viewAngleStats[selectedViewAngle] || 0)) {\n                  selectedViewAngle = viewAngle;\n                }\n              }\n            }\n          }\n\n          if (viewAnnotationCount > 0) {\n            viewAngleStats[viewAngle] = viewAnnotationCount;\n          }\n        }\n\n        // æ£€æŸ¥æ˜¯å¦æœ‰è·³è¿‡ä¿¡æ¯\n        const skipData = this.annotationStorage.annotations.get(plant.id);\n        if (skipData && skipData.status === 'skipped') {\n          // æ¢å¤è·³è¿‡çŠ¶æ€\n          plant.status = 'skipped';\n          plant.skipReason = skipData.skipReason;\n          plant.skipDate = skipData.skipDate;\n          console.log(`[æ ‡æ³¨] æ¤ç‰© ${plant.id}: skipped (${skipData.skipReason})`);\n        } else {\n          // ğŸ”§ FIX: Check for persisted completion status before applying default logic\n          console.log(`[çŠ¶æ€æ¢å¤] å¼€å§‹æ£€æŸ¥æ¤ç‰© ${plant.id} çš„æŒä¹…åŒ–çŠ¶æ€...`);\n          const persistedStatus = await this.annotationStorage.loadPlantStatus(plant.id);\n          console.log(`[çŠ¶æ€æ¢å¤] æ¤ç‰© ${plant.id} æŒä¹…åŒ–çŠ¶æ€ç»“æœ: ${persistedStatus}`);\n          \n          if (persistedStatus === 'completed') {\n            // ä¿æŒå·²å®ŒæˆçŠ¶æ€ï¼Œå³ä½¿æ²¡æœ‰æ ‡æ³¨æ•°æ®\n            plant.status = 'completed';\n            plant.selectedViewAngle = selectedViewAngle;\n            console.log(`[æ ‡æ³¨] æ¤ç‰© ${plant.id}: completed (ä»æŒä¹…åŒ–å­˜å‚¨æ¢å¤)`);\n          } else if (hasAnnotations) {\n            // ğŸ”§ FIX: Plants with annotations are 'in-progress', not auto-completed\n            plant.status = 'in-progress';\n            plant.selectedViewAngle = selectedViewAngle;\n            console.log(`[æ ‡æ³¨] æ¤ç‰© ${plant.id}: in-progress, é€‰ä¸­è§†è§’: ${selectedViewAngle} (${totalAnnotations} ä¸ªæ ‡æ³¨ç‚¹)`);\n          } else {\n            // æ— æ ‡æ³¨æ•°æ®ä¸”æ— æŒä¹…åŒ–çŠ¶æ€\n            plant.status = 'pending';\n            console.log(`[æ ‡æ³¨] æ¤ç‰© ${plant.id}: pending (æ— æ ‡æ³¨æ•°æ®ä¸”æ— æŒä¹…åŒ–çŠ¶æ€)`);\n          }\n        }\n\n      } catch (error) {\n        console.warn(`[æ ‡æ³¨] æ£€æŸ¥æ¤ç‰© ${plant.id} çŠ¶æ€å¤±è´¥:`, error);\n        plant.status = 'pending';\n      }\n    }\n\n    console.log('[æ ‡æ³¨] æ¤ç‰©çŠ¶æ€æ¢å¤å®Œæˆ');\n  }\n\n  /**\n   * åˆ›å»ºæ¤ç‰©æ•°æ®å¯¹è±¡\n   */\n  async createPlantData(plantFolder) {\n    const plant = {\n      id: plantFolder.id,\n      name: plantFolder.name,\n      path: plantFolder.path, // HTTPç‰ˆæœ¬ä½¿ç”¨pathè€Œä¸æ˜¯handle\n      status: 'pending', // pending, in-progress, completed\n      imageCount: 0,\n      hasImages: false,\n      viewAngles: [], // å¯ç”¨çš„è§†è§’åˆ—è¡¨\n      selectedViewAngle: null, // ç”¨æˆ·é€‰æ‹©çš„è§†è§’\n      selectedImage: null,\n      annotations: [],\n      lastModified: null,\n      loadedAt: new Date().toISOString()\n    };\n    \n    // å¼‚æ­¥åŠ è½½å›¾åƒæ•°é‡ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰\n    this.loadPlantImageCount(plant);\n    \n    return plant;\n  }\n\n  /**\n   * å¼‚æ­¥åŠ è½½æ¤ç‰©çš„å›¾åƒæ•°é‡\n   */\n  async loadPlantImageCount(plant) {\n    if (this.loadingPlants.has(plant.id)) {\n      return;\n    }\n    \n    this.loadingPlants.add(plant.id);\n    \n    try {\n      const imagesByView = await this.fileSystemManager.readPlantImages(plant.id);\n      \n      // ç»Ÿè®¡å„è§†è§’çš„å›¾åƒæ•°é‡\n      const viewAngles = Object.keys(imagesByView).filter(view => imagesByView[view].length > 0);\n      const totalImages = Object.values(imagesByView).reduce((total, images) => total + images.length, 0);\n      \n      // æ›´æ–°æ¤ç‰©ä¿¡æ¯\n      plant.viewAngles = viewAngles;\n      plant.imageCount = totalImages;\n      plant.hasImages = totalImages > 0;\n      \n      // ç¼“å­˜å›¾åƒæ•°æ®\n      if (totalImages > 0) {\n        this.plantImages.set(plant.id, imagesByView);\n      }\n      \n      console.log(`æ¤ç‰© ${plant.id} åŒ…å« ${totalImages} å¼ å›¾åƒï¼Œè§†è§’: ${viewAngles.join(', ')}`);\n      \n      // è§¦å‘UIæ›´æ–°äº‹ä»¶\n      this.emitPlantUpdated(plant);\n      \n    } catch (error) {\n      console.error(`åŠ è½½æ¤ç‰© ${plant.id} å›¾åƒä¿¡æ¯å¤±è´¥:`, error);\n      plant.hasImages = false;\n      plant.imageCount = 0;\n      plant.viewAngles = [];\n    } finally {\n      this.loadingPlants.delete(plant.id);\n    }\n  }\n\n  /**\n   * è·å–æ¤ç‰©åˆ—è¡¨\n   */\n  getPlantList() {\n    return Array.from(this.plants.values()).sort((a, b) => a.id.localeCompare(b.id));\n  }\n\n  /**\n   * æ ¹æ®IDè·å–æ¤ç‰©\n   */\n  getPlant(plantId) {\n    return this.plants.get(plantId);\n  }\n\n  /**\n   * è·å–æ¤ç‰©çš„å›¾åƒåˆ—è¡¨ï¼ˆæŒ‡å®šè§†è§’ï¼‰\n   */\n  async getPlantImages(plantId, viewAngle = null) {\n    // æ£€æŸ¥ç¼“å­˜\n    if (this.plantImages.has(plantId)) {\n      const imagesByView = this.plantImages.get(plantId);\n      \n      if (viewAngle) {\n        return imagesByView[viewAngle] || [];\n      } else {\n        // å¦‚æœæ²¡æœ‰æŒ‡å®šè§†è§’ï¼Œè¿”å›æ‰€æœ‰è§†è§’çš„æ•°æ®\n        return imagesByView;\n      }\n    }\n    \n    // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œç­‰å¾…å®Œæˆ\n    if (this.loadingPlants.has(plantId)) {\n      return new Promise((resolve) => {\n        const checkLoading = () => {\n          if (!this.loadingPlants.has(plantId)) {\n            const imagesByView = this.plantImages.get(plantId) || {};\n            resolve(viewAngle ? (imagesByView[viewAngle] || []) : imagesByView);\n          } else {\n            setTimeout(checkLoading, 100);\n          }\n        };\n        checkLoading();\n      });\n    }\n    \n    // ç«‹å³åŠ è½½\n    const plant = this.plants.get(plantId);\n    if (!plant) {\n      throw new Error(`æ¤ç‰© ${plantId} ä¸å­˜åœ¨`);\n    }\n    \n    try {\n      const imagesByView = await this.fileSystemManager.readPlantImages(plant.id);\n      this.plantImages.set(plantId, imagesByView);\n      \n      if (viewAngle) {\n        return imagesByView[viewAngle] || [];\n      } else {\n        return imagesByView;\n      }\n    } catch (error) {\n      console.error(`è·å–æ¤ç‰© ${plantId} å›¾åƒå¤±è´¥:`, error);\n      return viewAngle ? [] : {};\n    }\n  }\n\n  /**\n   * ğŸ”§ FIXED: æ›´æ–°æ¤ç‰©çŠ¶æ€ - å§‹ç»ˆä¿å­˜çŠ¶æ€åˆ°æŒä¹…åŒ–å­˜å‚¨\n   */\n  updatePlantStatus(plantId, status) {\n    const plant = this.plants.get(plantId);\n    if (plant) {\n      plant.status = status;\n      plant.lastModified = new Date().toISOString();\n\n      // ğŸ”§ FIX: Always save plant status to persistent storage, regardless of annotations\n      if (this.annotationStorage) {\n        // Use the new savePlantStatus method for independent status persistence\n        this.annotationStorage.savePlantStatus(plantId, status)\n          .then(() => {\n            console.log(`[çŠ¶æ€æ›´æ–°] ${plantId}: ${status} - å·²ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨`);\n          })\n          .catch(error => {\n            console.error('ä¿å­˜æ¤ç‰©çŠ¶æ€å¤±è´¥:', error);\n            // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœæœ‰æ ‡æ³¨æ•°æ®ï¼Œå°è¯•ä¼ ç»Ÿçš„ä¿å­˜æ–¹æ³•\n            const annotations = this.getPlantAnnotations(plantId);\n            if (annotations.length > 0) {\n              const plantInfo = {\n                selectedImage: plant.selectedImage,\n                selectedViewAngle: plant.selectedViewAngle\n              };\n              return this.annotationStorage.savePlantAnnotations(plantId, annotations, plantInfo);\n            }\n          });\n      }\n\n      this.emitPlantUpdated(plant);\n    }\n  }\n\n  /**\n   * è·³è¿‡æ¤æ ª\n   */\n  async skipPlant(plantId, reason) {\n    const plant = this.plants.get(plantId);\n    if (!plant) {\n      throw new Error(`æ¤æ ª ${plantId} ä¸å­˜åœ¨`);\n    }\n\n    // æ›´æ–°æ¤æ ªçŠ¶æ€\n    plant.status = 'skipped';\n    plant.skipReason = reason;\n    plant.skipDate = new Date().toISOString();\n    plant.lastModified = new Date().toISOString();\n\n    // ä¿å­˜è·³è¿‡ä¿¡æ¯åˆ°æŒä¹…åŒ–å­˜å‚¨\n    try {\n      const skipInfo = {\n        status: 'skipped',\n        skipReason: reason,\n        skipDate: plant.skipDate,\n        lastModified: plant.lastModified\n      };\n\n      await this.annotationStorage.saveSkipInfo(plantId, skipInfo);\n      console.log(`æ¤æ ª ${plantId} å·²æ ‡è®°ä¸ºè·³è¿‡: ${reason}`);\n\n      this.emitPlantUpdated(plant);\n\n    } catch (error) {\n      console.error(`ä¿å­˜æ¤æ ª ${plantId} è·³è¿‡ä¿¡æ¯å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: æ’¤é”€è·³è¿‡æ¤æ ª\n   */\n  async unskipPlant(plantId) {\n    const plant = this.plants.get(plantId);\n    if (!plant) {\n      throw new Error(`æ¤æ ª ${plantId} ä¸å­˜åœ¨`);\n    }\n\n    if (plant.status !== 'skipped') {\n      throw new Error(`æ¤æ ª ${plantId} å½“å‰çŠ¶æ€ä¸æ˜¯è·³è¿‡çŠ¶æ€`);\n    }\n\n    try {\n      // ç¡®å®šæ–°çŠ¶æ€ï¼šå¦‚æœæœ‰æ ‡æ³¨æ•°æ®åˆ™ä¸º in-progressï¼Œå¦åˆ™ä¸º pending\n      const annotations = await this.getPlantAnnotations(plantId);\n      const newStatus = (annotations && annotations.length > 0) ? 'in-progress' : 'pending';\n\n      // æ›´æ–°æ¤æ ªçŠ¶æ€\n      plant.status = newStatus;\n      plant.lastModified = new Date().toISOString();\n      \n      // æ¸…é™¤è·³è¿‡ç›¸å…³ä¿¡æ¯\n      delete plant.skipReason;\n      delete plant.skipDate;\n\n      // ç§»é™¤æŒä¹…åŒ–å­˜å‚¨ä¸­çš„è·³è¿‡ä¿¡æ¯\n      await this.annotationStorage.removeSkipInfo(plantId);\n      \n      // æ›´æ–°æ¤æ ªçŠ¶æ€åˆ°æŒä¹…åŒ–å­˜å‚¨\n      await this.annotationStorage.savePlantStatus(plantId, newStatus);\n\n      console.log(`æ¤æ ª ${plantId} å·²æ’¤é”€è·³è¿‡çŠ¶æ€ï¼Œæ–°çŠ¶æ€: ${newStatus}`);\n      this.emitPlantUpdated(plant);\n\n    } catch (error) {\n      console.error(`æ’¤é”€æ¤æ ª ${plantId} è·³è¿‡çŠ¶æ€å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: æ’¤é”€å®Œæˆæ¤æ ª\n   */\n  async uncompletePlant(plantId) {\n    const plant = this.plants.get(plantId);\n    if (!plant) {\n      throw new Error(`æ¤æ ª ${plantId} ä¸å­˜åœ¨`);\n    }\n\n    if (plant.status !== 'completed') {\n      throw new Error(`æ¤æ ª ${plantId} å½“å‰çŠ¶æ€ä¸æ˜¯å·²å®ŒæˆçŠ¶æ€`);\n    }\n\n    try {\n      // ç¡®å®šæ–°çŠ¶æ€ï¼šå¦‚æœæœ‰æ ‡æ³¨æ•°æ®åˆ™ä¸º in-progressï¼Œå¦åˆ™ä¸º pending\n      const annotations = await this.getPlantAnnotations(plantId);\n      const newStatus = (annotations && annotations.length > 0) ? 'in-progress' : 'pending';\n\n      // æ›´æ–°æ¤æ ªçŠ¶æ€\n      plant.status = newStatus;\n      plant.lastModified = new Date().toISOString();\n\n      // æ›´æ–°æ¤æ ªçŠ¶æ€åˆ°æŒä¹…åŒ–å­˜å‚¨\n      await this.annotationStorage.savePlantStatus(plantId, newStatus);\n\n      console.log(`æ¤æ ª ${plantId} å·²æ’¤é”€å®ŒæˆçŠ¶æ€ï¼Œæ–°çŠ¶æ€: ${newStatus}`);\n      this.emitPlantUpdated(plant);\n\n    } catch (error) {\n      console.error(`æ’¤é”€æ¤æ ª ${plantId} å®ŒæˆçŠ¶æ€å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * è®¾ç½®æ¤ç‰©çš„é€‰ä¸­è§†è§’\n   */\n  setSelectedViewAngle(plantId, viewAngle) {\n    const plant = this.plants.get(plantId);\n    if (plant) {\n      plant.selectedViewAngle = viewAngle;\n      plant.selectedImage = null; // é‡ç½®é€‰ä¸­çš„å›¾åƒ\n      \n      // å¦‚æœæ¤ç‰©çŠ¶æ€è¿˜æ˜¯pendingï¼Œæ›´æ–°ä¸ºin-progress\n      if (plant.status === 'pending') {\n        this.updatePlantStatus(plantId, 'in-progress');\n      }\n      \n      this.emitPlantUpdated(plant);\n    }\n  }\n\n  /**\n   * è®¾ç½®æ¤ç‰©çš„é€‰ä¸­å›¾åƒ\n   */\n  setSelectedImage(plantId, imageData) {\n    const plant = this.plants.get(plantId);\n    if (plant) {\n      plant.selectedImage = imageData;\n      \n      // è‡ªåŠ¨è®¾ç½®è§†è§’ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è®¾ç½®çš„è¯ï¼‰\n      if (!plant.selectedViewAngle && imageData.viewAngle) {\n        plant.selectedViewAngle = imageData.viewAngle;\n      }\n\n      // åˆå§‹åŒ–æ—¶é—´åºåˆ—ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰\n      if (plant.selectedViewAngle) {\n        this.initializeTimeSeriesIfNeeded(plantId, plant.selectedViewAngle);\n      }\n      \n      // å¦‚æœæ¤ç‰©çŠ¶æ€è¿˜æ˜¯pendingï¼Œæ›´æ–°ä¸ºin-progress\n      if (plant.status === 'pending') {\n        this.updatePlantStatus(plantId, 'in-progress');\n      }\n      \n      this.emitPlantUpdated(plant);\n    }\n  }\n\n  /**\n   * åˆå§‹åŒ–æ—¶é—´åºåˆ—ï¼ˆå¦‚æœéœ€è¦ï¼‰\n   */\n  async initializeTimeSeriesIfNeeded(plantId, viewAngle) {\n    try {\n      const images = await this.getPlantImages(plantId, viewAngle);\n      if (images.length > 0) {\n        const seriesInfo = this.timeSeriesManager.initializePlantTimeSeries(plantId, viewAngle, images);\n        console.log(`åˆå§‹åŒ–æ—¶é—´åºåˆ—: ${seriesInfo.totalImages} å¼ å›¾åƒ`);\n        return seriesInfo;\n      }\n    } catch (error) {\n      console.error('åˆå§‹åŒ–æ—¶é—´åºåˆ—å¤±è´¥:', error);\n    }\n    return null;\n  }\n\n  /**\n   * è·å–æ¤ç‰©çš„æ ‡æ³¨æ•°æ®ï¼ˆæ–°çš„ç®€åŒ–æ–¹æ¡ˆï¼‰\n   */\n  async savePlantAnnotations(plantId, annotations, isManualAdjustment = false, options = {}) {\n    const plant = this.plants.get(plantId);\n    if (!plant) {\n      throw new Error(`æ¤æ ª ${plantId} ä¸å­˜åœ¨`);\n    }\n\n    if (!plant.selectedImage || !plant.selectedViewAngle) {\n      throw new Error('è¯·å…ˆé€‰æ‹©å›¾åƒå’Œè§†è§’');\n    }\n\n    const currentImageId = plant.selectedImage.id;\n    const viewAngle = plant.selectedViewAngle;\n\n    try {\n      // è·å–è¯¥è§†è§’çš„æ‰€æœ‰å›¾åƒ\n      const images = await this.getPlantImages(plantId, viewAngle);\n      const currentImageIndex = images.findIndex(img => img.id === currentImageId);\n      \n      if (currentImageIndex === -1) {\n        throw new Error('å½“å‰å›¾åƒä¸åœ¨å›¾åƒåˆ—è¡¨ä¸­');\n      }\n\n      let savedCount = 0;\n      \n      if (isManualAdjustment) {\n        // ä»…ä¿å­˜å½“å‰å›¾åƒ\n        await this.saveAnnotationToFile(plantId, currentImageId, annotations, options);\n        savedCount = 1;\n        console.log(`ä¿å­˜æ ‡æ³¨åˆ°å½“å‰å›¾åƒ: ${currentImageId}`);\n      } else {\n        // å‘åä¼ æ’­ï¼šä¿å­˜åˆ°å½“å‰å›¾åƒåŠåç»­æ‰€æœ‰å›¾åƒ\n        for (let i = currentImageIndex; i < images.length; i++) {\n          const imageId = images[i].id;\n          await this.saveAnnotationToFile(plantId, imageId, annotations, options);\n          savedCount++;\n        }\n        console.log(`å‘åä¼ æ’­ä¿å­˜æ ‡æ³¨åˆ° ${savedCount} å¼ å›¾åƒ`);\n      }\n\n      // ğŸ”§ FIX: Update plant status - only set to in-progress when saving annotations\n      // Completion status should only be set explicitly via Complete Plant button\n      plant.annotations = annotations;\n      plant.lastModified = new Date().toISOString();\n      plant.status = annotations.length > 0 ? 'in-progress' : 'pending';\n\n      // æ›´æ–°å†…å­˜ç¼“å­˜\n      this.annotationStatus.set(plantId, annotations);\n\n      // è§¦å‘UIæ›´æ–°\n      this.emitPlantUpdated(plant);\n\n      const directionInfo = options.saveDirectionsOnly ? ' (ä»…æ–¹å‘ä¿¡æ¯)' : '';\n      const message = isManualAdjustment ? \n        `å·²ä¿å­˜åˆ°å½“å‰å›¾åƒ${directionInfo}` : \n        `å·²ä¼ æ’­ä¿å­˜åˆ° ${savedCount} å¼ å›¾åƒ${directionInfo}`;\n\n      return {\n        success: true,\n        savedCount,\n        message,\n        viewAngle: viewAngle,\n        isManualAdjustment,\n        saveDirectionsOnly: options.saveDirectionsOnly\n      };\n      \n    } catch (error) {\n      console.error(`ä¿å­˜æ¤æ ª ${plantId} æ ‡æ³¨æ•°æ®å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * ä¿å­˜æ ‡æ³¨æ•°æ®åˆ°ç‰¹å®šå›¾åƒæ–‡ä»¶\n   */\n  async saveAnnotationToFile(plantId, imageId, annotations, options = {}) {\n    let finalAnnotations = annotations;\n    \n    // å¦‚æœåªä¿å­˜æ–¹å‘ä¿¡æ¯ï¼Œéœ€è¦åˆå¹¶ç°æœ‰çš„ä½ç½®ä¿¡æ¯\n    if (options.saveDirectionsOnly) {\n      const existingData = await this.annotationStorage.getImageAnnotation(imageId);\n      if (existingData && existingData.annotations) {\n        finalAnnotations = this.mergeDirectionData(existingData.annotations, annotations);\n      }\n    }\n    \n    // ä¸ºæ¯ä¸ªå›¾åƒåˆ›å»ºç‹¬ç«‹çš„æ ‡æ³¨æ–‡ä»¶\n    const annotationData = {\n      plantId,\n      imageId,\n      annotations: finalAnnotations,\n      timestamp: new Date().toISOString(),\n      version: '2.0' // æ–°ç‰ˆæœ¬æ ‡è®°\n    };\n\n    // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨\n    await this.annotationStorage.saveImageAnnotation(imageId, annotationData);\n  }\n\n  /**\n   * åˆå¹¶æ–¹å‘æ•°æ®ï¼ˆä»…æ›´æ–°æ–¹å‘ä¿¡æ¯ï¼Œä¿æŒä½ç½®ä¸å˜ï¼‰\n   */\n  mergeDirectionData(existingAnnotations, newAnnotations) {\n    const merged = [...existingAnnotations];\n    \n    // ä¸ºæ¯ä¸ªæ–°æ ‡æ³¨ç‚¹çš„æ–¹å‘ä¿¡æ¯æ›´æ–°å¯¹åº”çš„ç°æœ‰æ ‡æ³¨ç‚¹\n    newAnnotations.forEach(newAnnotation => {\n      const existingIndex = merged.findIndex(existing => existing.order === newAnnotation.order);\n      \n      if (existingIndex !== -1) {\n        // åªæ›´æ–°æ–¹å‘ç›¸å…³ä¿¡æ¯ï¼Œä¿æŒä½ç½®ä¸å˜\n        merged[existingIndex] = {\n          ...merged[existingIndex],\n          direction: newAnnotation.direction,\n          directionType: newAnnotation.directionType,\n          timestamp: new Date().toISOString()\n        };\n      } else {\n        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„æ ‡æ³¨ç‚¹ï¼Œæ·»åŠ æ–°çš„\n        merged.push(newAnnotation);\n      }\n    });\n    \n    return merged;\n  }\n\n  /**\n   * ä¿å­˜æ ‡æ³¨æ•°æ®åˆ°æŒ‡å®šå›¾åƒï¼ˆè‡ªåŠ¨ä¿å­˜ä¸“ç”¨ï¼‰\n   */\n  async saveImageAnnotations(imageId, annotations) {\n    try {\n      // è·å–å½“å‰æ¤æ ªID\n      const currentPlantId = window.appState?.currentPlant?.id || this.getCurrentPlantIdFromImage(imageId);\n\n      // åˆ›å»ºæ ‡æ³¨æ•°æ®ç»“æ„\n      const annotationData = {\n        imageId,\n        plantId: currentPlantId,\n        annotations,\n        timestamp: new Date().toISOString(),\n        version: '2.0'\n      };\n\n      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨\n      await this.annotationStorage.saveImageAnnotation(imageId, annotationData);\n\n      console.log(`è‡ªåŠ¨ä¿å­˜å®Œæˆï¼šå›¾åƒ ${imageId} (æ¤æ ª: ${currentPlantId}) çš„ ${annotations.length} ä¸ªæ ‡æ³¨ç‚¹`);\n\n    } catch (error) {\n      console.error('è‡ªåŠ¨ä¿å­˜å›¾åƒæ ‡æ³¨å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ä»å›¾åƒIDæ¨æ–­æ¤æ ªID\n   */\n  getCurrentPlantIdFromImage(imageId) {\n    // å°è¯•ä»å›¾åƒIDä¸­æå–æ¤æ ªID\n    // å›¾åƒIDæ ¼å¼é€šå¸¸æ˜¯: BR017-028122_sv-000_BR017-028122-2018-07-04_00_VIS_sv_000-0-0-0.png\n    // æ¤æ ªIDé€šå¸¸æ˜¯: BR017-028122\n\n    if (imageId.includes('_')) {\n      const parts = imageId.split('_');\n      if (parts.length > 0) {\n        // å–ç¬¬ä¸€éƒ¨åˆ†ä½œä¸ºæ¤æ ªID\n        return parts[0];\n      }\n    }\n\n    // å¦‚æœæ— æ³•è§£æï¼Œå°è¯•ä»æ–‡ä»¶åä¸­æå–\n    if (imageId.includes('-')) {\n      const parts = imageId.split('-');\n      if (parts.length >= 2) {\n        // ç»„åˆå‰ä¸¤éƒ¨åˆ†ä½œä¸ºæ¤æ ªID (å¦‚ BR017-028122)\n        return `${parts[0]}-${parts[1]}`;\n      }\n    }\n\n    // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šè¿”å›åŸå§‹imageIdçš„å‰ç¼€\n    return imageId.split('.')[0].split('_')[0];\n  }\n\n  /**\n   * è·å–ç‰¹å®šå›¾åƒçš„æ ‡æ³¨æ•°æ®\n   */\n  async getImageAnnotations(imageId) {\n    try {\n      const annotationData = await this.annotationStorage.getImageAnnotation(imageId);\n\n      if (!annotationData || !annotationData.annotations) {\n        return [];\n      }\n\n      const annotations = annotationData.annotations;\n\n      // ğŸ”§ DISABLED: ä¸ºä¼ ç»Ÿæ•°æ®æ·»åŠ åºå·ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰\n      // IMPORTANT: This automatic renumbering was causing order inconsistencies\n      // across frames in real-time sync. Annotations should maintain their\n      // original order numbers to ensure consistent synchronization.\n      // this.ensureAnnotationOrders(annotations);\n      \n      console.log(`ğŸ”„ Loaded ${annotations.length} annotations for image ${imageId} (auto-renumbering disabled)`);\n\n      return annotations;\n    } catch (error) {\n      console.error('è·å–å›¾åƒæ ‡æ³¨å¤±è´¥:', error);\n      return [];\n    }\n  }\n\n  /**\n   * è·å–æ¤ç‰©çš„æ ‡æ³¨æ•°æ®ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰\n   */\n  getPlantAnnotations(plantId, imageId = null) {\n    if (imageId) {\n      // ç›´æ¥ä»æ–‡ä»¶è¯»å–æŒ‡å®šå›¾åƒçš„æ ‡æ³¨\n      return this.getImageAnnotations(imageId);\n    }\n\n    // å¦‚æœæ²¡æœ‰æŒ‡å®šå›¾åƒï¼Œè¿”å›æ¤ç‰©çš„å½“å‰æ ‡æ³¨çŠ¶æ€\n    return this.annotationStatus.get(plantId) || [];\n  }\n\n  /**\n   * è·å–å½“å‰å›¾åƒçš„æ ‡æ³¨å…ƒæ•°æ®\n   */\n  getCurrentImageAnnotationMetadata(plantId) {\n    const plant = this.plants.get(plantId);\n    if (!plant || !plant.selectedImage || !plant.selectedViewAngle) {\n      return null;\n    }\n\n    return this.timeSeriesManager.getAnnotationMetadata(\n      plantId,\n      plant.selectedViewAngle,\n      plant.selectedImage.id\n    );\n  }\n\n  /**\n   * è·å–æ¤æ ªè§†è§’çš„æ—¶é—´åºåˆ—ç»Ÿè®¡\n   */\n  getPlantTimeSeriesStats(plantId, viewAngle) {\n    return this.timeSeriesManager.getAnnotationStats(plantId, viewAngle);\n  }\n\n  /**\n   * æ£€æŸ¥æ˜¯å¦ä¸ºæ‰‹åŠ¨è°ƒæ•´æ¨¡å¼\n   */\n  shouldShowManualAdjustmentMode(plantId) {\n    const metadata = this.getCurrentImageAnnotationMetadata(plantId);\n    if (!metadata) return false;\n\n    // å¦‚æœä¸æ˜¯ç¬¬ä¸€å¼ å›¾åƒï¼Œä¸”å·²æœ‰æ ‡æ³¨ï¼Œæ˜¾ç¤ºå¾®è°ƒæ¨¡å¼\n    return !metadata.isFirstImage && metadata.hasAnnotations;\n  }\n\n  /**\n   * è·å–ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„æ¤ç‰©\n   */\n  getNextPendingPlant(currentPlantId = null) {\n    const plants = this.getPlantList();\n    \n    if (!currentPlantId) {\n      // è¿”å›ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„æ¤ç‰©\n      return plants.find(plant => plant.status !== 'completed');\n    }\n    \n    // æ‰¾åˆ°å½“å‰æ¤ç‰©çš„ç´¢å¼•\n    const currentIndex = plants.findIndex(plant => plant.id === currentPlantId);\n    \n    if (currentIndex === -1) {\n      return plants.find(plant => plant.status !== 'completed');\n    }\n    \n    // ä»å½“å‰æ¤ç‰©çš„ä¸‹ä¸€ä¸ªå¼€å§‹æŸ¥æ‰¾\n    for (let i = currentIndex + 1; i < plants.length; i++) {\n      if (plants[i].status !== 'completed') {\n        return plants[i];\n      }\n    }\n    \n    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä»å¤´å¼€å§‹æŸ¥æ‰¾\n    for (let i = 0; i < currentIndex; i++) {\n      if (plants[i].status !== 'completed') {\n        return plants[i];\n      }\n    }\n    \n    return null; // æ‰€æœ‰æ¤ç‰©éƒ½å·²å®Œæˆ\n  }\n\n  /**\n   * è·å–è¯¦ç»†çš„å›¾ç‰‡ç»Ÿè®¡ä¿¡æ¯\n   */\n  getDetailedImageStats() {\n    const plants = this.getPlantList();\n    let totalImages = 0;\n    let completedImages = 0;\n    let totalPlants = plants.length;\n    let completedPlants = 0;\n    \n    const plantStats = [];\n\n    for (const plant of plants) {\n      const plantImageCount = plant.imageCount || 0;\n      totalImages += plantImageCount;\n      \n      const plantStat = {\n        plantId: plant.id,\n        imageCount: plantImageCount,\n        status: plant.status,\n        isCompleted: plant.status === 'completed'\n      };\n      \n      if (plant.status === 'completed') {\n        completedPlants++;\n        completedImages += plantImageCount;\n      }\n      \n      plantStats.push(plantStat);\n    }\n\n    const completionRate = totalImages > 0 ? (completedImages / totalImages * 100) : 0;\n    const plantCompletionRate = totalPlants > 0 ? (completedPlants / totalPlants * 100) : 0;\n\n    return {\n      totalImages,\n      completedImages,\n      totalPlants,\n      completedPlants,\n      completionRate: completionRate.toFixed(1),\n      plantCompletionRate: plantCompletionRate.toFixed(1),\n      pendingImages: totalImages - completedImages,\n      plantStats\n    };\n  }\n\n  /**\n   * è·å–ç®€åŒ–çš„å›¾ç‰‡ç»Ÿè®¡ä¿¡æ¯\n   */\n  getImageStats() {\n    const detailed = this.getDetailedImageStats();\n    return {\n      totalImages: detailed.totalImages,\n      completedImages: detailed.completedImages,\n      totalPlants: detailed.totalPlants,\n      completedPlants: detailed.completedPlants,\n      completionRate: detailed.completionRate\n    };\n  }\n\n  /**\n   * è·å–è¿›åº¦ç»Ÿè®¡\n   */\n  getProgress() {\n    const plants = this.getPlantList();\n    const total = plants.length;\n    \n    // ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨çš„ç»Ÿè®¡ä¿¡æ¯\n    const persistentStats = this.annotationStorage.getAnnotationStats(total);\n    \n    // ç»“åˆå†…å­˜ä¸­çš„çŠ¶æ€\n    const completed = plants.filter(plant => plant.status === 'completed').length;\n    const inProgress = plants.filter(plant => plant.status === 'in-progress').length;\n    const pending = plants.filter(plant => plant.status === 'pending').length;\n    const skipped = plants.filter(plant => plant.status === 'skipped').length;\n\n    // è®¡ç®—æ€»å®Œæˆæ•°ï¼ˆåŒ…æ‹¬è·³è¿‡çš„æ¤æ ªï¼‰\n    const totalCompleted = completed + skipped;\n\n    // æ·»åŠ å›¾ç‰‡ç»Ÿè®¡\n    const imageStats = this.getImageStats();\n\n    return {\n      total,\n      completed: Math.max(completed, persistentStats.completed),\n      inProgress,\n      pending,\n      skipped,\n      totalCompleted, // æ–°å¢ï¼šåŒ…å«è·³è¿‡çš„æ€»å®Œæˆæ•°\n      completionRate: total > 0 ? (Math.max(totalCompleted, persistentStats.completed + skipped) / total * 100).toFixed(1) : 0,\n      persistent: persistentStats,\n      images: imageStats\n    };\n  }\n\n  /**\n   * æœç´¢æ¤ç‰©\n   */\n  searchPlants(query) {\n    if (!query) {\n      return this.getPlantList();\n    }\n    \n    const lowerQuery = query.toLowerCase();\n    return this.getPlantList().filter(plant => \n      plant.id.toLowerCase().includes(lowerQuery) ||\n      plant.name.toLowerCase().includes(lowerQuery)\n    );\n  }\n\n  /**\n   * æŒ‰çŠ¶æ€è¿‡æ»¤æ¤ç‰©\n   */\n  filterPlantsByStatus(status) {\n    if (status === 'all') {\n      return this.getPlantList();\n    }\n    \n    return this.getPlantList().filter(plant => plant.status === status);\n  }\n\n  /**\n   * è§¦å‘æ¤ç‰©æ›´æ–°äº‹ä»¶\n   */\n  emitPlantUpdated(plant) {\n    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶\n    const event = new CustomEvent('plantUpdated', {\n      detail: { plant }\n    });\n    document.dispatchEvent(event);\n  }\n\n  /**\n   * æ¸…ç†èµ„æºå’Œç¼“å­˜\n   */\n  cleanup() {\n    this.plants.clear();\n    this.plantImages.clear();\n    this.annotationStatus.clear();\n    this.loadingPlants.clear();\n    \n    if (this.fileSystemManager) {\n      this.fileSystemManager.cleanup();\n    }\n  }\n\n  /**\n   * å¯¼å‡ºæ‰€æœ‰æ ‡æ³¨æ•°æ®\n   */\n  exportAllAnnotations() {\n    // ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨çš„å¯¼å‡ºåŠŸèƒ½\n    return this.annotationStorage.exportAllAnnotations();\n  }\n\n  /**\n   * ä¸‹è½½æ ‡æ³¨æ•°æ®ä¸ºJSONæ–‡ä»¶\n   */\n  downloadAnnotationsAsJSON() {\n    return this.annotationStorage.downloadAnnotationsAsJSON();\n  }\n\n  /**\n   * å¯¼å‡ºæ‰€æœ‰å›¾åƒçš„çº¯å‡€æ ‡æ³¨æ•°æ®ï¼ˆæ–°æ ¼å¼ï¼‰\n   * ä¸åŒ…å«æ—¶é—´åºåˆ—ç®¡ç†çš„å†…éƒ¨ä¿¡æ¯ï¼Œç›´æ¥è¾“å‡ºå›¾åƒIDå¯¹åº”çš„æ ‡æ³¨ç‚¹\n   */\n  async exportPureImageAnnotations() {\n    return await this.annotationStorage.exportPureImageAnnotations();\n  }\n\n  /**\n   * ä¸‹è½½çº¯å‡€çš„å›¾åƒæ ‡æ³¨æ•°æ®ä¸ºJSONæ–‡ä»¶\n   */\n  async downloadPureImageAnnotationsAsJSON() {\n    return await this.annotationStorage.downloadPureImageAnnotationsAsJSON();\n  }\n\n  /**\n   * è·å–å¯¼å‡ºæ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯\n   */\n  async getExportStats() {\n    const pureAnnotations = await this.exportPureImageAnnotations();\n    const timeSeriesStats = this.timeSeriesManager.getExportStats();\n    \n    return {\n      pureFormat: this.annotationStorage.getPureAnnotationsStats(pureAnnotations),\n      timeSeriesFormat: timeSeriesStats,\n      recommendation: 'å»ºè®®ä½¿ç”¨çº¯å‡€æ ¼å¼è¿›è¡Œæ•°æ®åˆ†æå’Œå¤„ç†'\n    };\n  }\n\n  /**\n   * è°ƒè¯•ï¼šæ£€æŸ¥æ—¶é—´åºåˆ—æ•°æ®çŠ¶æ€å’Œå¯¼å‡ºé—®é¢˜\n   */\n  async debugTimeSeriesExport() {\n    console.log('=== æ—¶é—´åºåˆ—å¯¼å‡ºè°ƒè¯• ===');\n    \n    // 1. æ£€æŸ¥æ—¶é—´åºåˆ—ç®¡ç†å™¨çŠ¶æ€\n    const timeSeriesStatus = this.timeSeriesManager.getDebugStatus();\n    \n    // 2. æ£€æŸ¥æ—¶é—´åºåˆ—ç®¡ç†å™¨ä¸­çš„è¯¦ç»†æ•°æ®\n    const timeSeriesData = this.timeSeriesManager.exportAllTimeSeriesDataDebug();\n    \n    // 3. æ£€æŸ¥å¯¼å‡ºçš„çº¯å‡€æ•°æ®\n    const pureAnnotations = await this.exportPureImageAnnotations();\n    console.log('å¯¼å‡ºçš„çº¯å‡€æ ‡æ³¨æ•°æ®:', pureAnnotations);\n    \n    // 4. æ£€æŸ¥å­˜å‚¨ç®¡ç†å™¨ä¸­çš„æ•°æ®\n    const storageAnnotations = this.annotationStorage.annotations;\n    console.log('å­˜å‚¨ç®¡ç†å™¨ä¸­çš„æ•°æ®:', Array.from(storageAnnotations.entries()));\n    \n    // 5. æ¯”è¾ƒæ•°æ®å·®å¼‚\n    const comparison = {\n      timeSeriesManagerImages: timeSeriesStatus.totalAnnotatedImages,\n      pureExportImages: Object.keys(pureAnnotations).length,\n      storageManagerPlants: storageAnnotations.size\n    };\n    \n    console.log('æ•°æ®æ¯”è¾ƒ:', comparison);\n    \n    return {\n      timeSeriesStatus,\n      timeSeriesData,\n      pureAnnotations,\n      storageData: Array.from(storageAnnotations.entries()),\n      comparison\n    };\n  }\n\n  /**\n   * ä¿å­˜æ ‡æ³¨çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨\n   */\n  saveAnnotationStatus(plantId, data) {\n    try {\n      const storageKey = `plant_annotation_${plantId}`;\n      const savedData = {\n        ...data,\n        savedAt: new Date().toISOString()\n      };\n      localStorage.setItem(storageKey, JSON.stringify(savedData));\n    } catch (error) {\n      console.error('ä¿å­˜æ ‡æ³¨çŠ¶æ€å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ ‡æ³¨çŠ¶æ€\n   */\n  loadAnnotationStatus(plantId) {\n    try {\n      const storageKey = `plant_annotation_${plantId}`;\n      const saved = localStorage.getItem(storageKey);\n      \n      if (saved) {\n        return JSON.parse(saved);\n      }\n    } catch (error) {\n      console.error('åŠ è½½æ ‡æ³¨çŠ¶æ€å¤±è´¥:', error);\n    }\n    \n    return null;\n  }\n\n  /**\n   * ğŸ”§ FIXED: ç¡®ä¿æ ‡æ³¨æ•°æ®éƒ½æœ‰åºå·ï¼ˆæ”¯æŒç±»å‹ç‰¹å®šç¼–å·ç³»ç»Ÿï¼‰\n   * ä¸ºç¼ºå°‘åºå·çš„æ ‡æ³¨ç‚¹åˆ†é…åºå·ï¼Œä½†ä¿æŒç±»å‹ç‰¹å®šçš„ç¼–å·ç³»ç»Ÿ\n   */\n  ensureAnnotationOrders(annotations) {\n    if (!annotations || annotations.length === 0) {\n      return;\n    }\n    \n    // ğŸ”§ FIX: æŒ‰ç±»å‹åˆ†ç»„æ ‡æ³¨ç‚¹\n    const annotationsByType = {};\n    \n    // åˆ†ç»„ï¼šå†…ç½®regular(å·²è¿ç§»ä¸ºè‡ªå®šä¹‰) ä¸ å„ç§è‡ªå®šä¹‰ç±»å‹\n    annotations.forEach(annotation => {\n      // ğŸ› BUGFIX: Ensure all annotations have annotationType field set\n      if (!annotation.annotationType) {\n        // ğŸ”§ FIX: Smart detection - check if this is actually a custom annotation\n        if (annotation.customTypeId) {\n          annotation.annotationType = 'custom'; // Preserve custom type\n        } else {\n          // è¿ç§»åä¸åº”å†å‡ºç°çº¯regularï¼Œå…œåº•æ˜ å°„åˆ°å†…ç½®ç±»å‹\n          annotation.annotationType = 'custom';\n          annotation.customTypeId = annotation.customTypeId || 'builtin-regular-keypoint';\n        }\n      }\n      \n      const typeKey = annotation.annotationType === 'custom' \n        ? `custom:${annotation.customTypeId || 'unknown'}`\n        : `custom:builtin-regular-keypoint`;\n      \n      if (!annotationsByType[typeKey]) {\n        annotationsByType[typeKey] = [];\n      }\n      annotationsByType[typeKey].push(annotation);\n    });\n    \n    let totalFixed = 0;\n    \n    // ğŸ”§ FIX: ä¸ºæ¯ä¸ªç±»å‹ç‹¬ç«‹å¤„ç†åºå·\n    Object.entries(annotationsByType).forEach(([typeKey, typeAnnotations]) => {\n      let hasOrderIssues = false;\n      \n      // æ£€æŸ¥è¯¥ç±»å‹æ˜¯å¦æœ‰åºå·é—®é¢˜\n      for (let i = 0; i < typeAnnotations.length; i++) {\n        if (typeof typeAnnotations[i].order !== 'number' || typeAnnotations[i].order <= 0) {\n          hasOrderIssues = true;\n          break;\n        }\n      }\n      \n      // æ£€æŸ¥è¯¥ç±»å‹å†…éƒ¨æ˜¯å¦æœ‰é‡å¤åºå·\n      if (!hasOrderIssues) {\n        const orders = typeAnnotations.map(kp => kp.order);\n        const uniqueOrders = [...new Set(orders)];\n        if (uniqueOrders.length !== orders.length) {\n          hasOrderIssues = true;\n        }\n      }\n      \n      // å¦‚æœè¯¥ç±»å‹æœ‰åºå·é—®é¢˜ï¼Œé‡æ–°åˆ†é…\n      if (hasOrderIssues) {\n        console.log(`å‘ç° ${typeKey} ç±»å‹æ ‡æ³¨åºå·é—®é¢˜ï¼Œæ­£åœ¨ä¸º ${typeAnnotations.length} ä¸ªæ ‡æ³¨ç‚¹åˆ†é…åºå·...`);\n        \n        // æŒ‰ç…§åŸæœ‰é¡ºåºä¸ºè¯¥ç±»å‹åˆ†é…åºå·ï¼ˆä»1å¼€å§‹ï¼‰\n        for (let i = 0; i < typeAnnotations.length; i++) {\n          typeAnnotations[i].order = i + 1;\n        }\n        \n        totalFixed += typeAnnotations.length;\n        console.log(`å·²ä¸º ${typeKey} ç±»å‹åˆ†é…åºå·ï¼š1-${typeAnnotations.length}`);\n      }\n    });\n    \n    if (totalFixed > 0) {\n      console.log(`åºå·ä¿®å¤å®Œæˆï¼šå…±ä¿®å¤ ${totalFixed} ä¸ªæ ‡æ³¨ç‚¹ï¼Œä¿æŒç±»å‹ç‰¹å®šç¼–å·ç³»ç»Ÿ`);\n    }\n  }\n} ","/**\n * æ ‡æ³¨å·¥å…·ç»„ä»¶\n * \n * åŠŸèƒ½ï¼š\n * - Canvaså›¾åƒæ¸²æŸ“å’Œç¼©æ”¾\n * - è§¦æ‘¸æ¿ç¼©æ”¾æ”¯æŒ (0.1x-10x)\n * - å…³é”®ç‚¹æ·»åŠ ã€åˆ é™¤ã€æ‹–æ‹½\n * - æ’¤é”€/é‡åšåŠŸèƒ½\n * - è§†å›¾çŠ¶æ€ç®¡ç†\n */\n\nexport class AnnotationTool {\n  constructor(canvasId, options = {}) {\n    console.log('[è°ƒè¯•] AnnotationTool æ„é€ å‡½æ•°è¢«è°ƒç”¨', { canvasId, timestamp: Date.now() });\n\n    this.canvas = document.getElementById(canvasId);\n    if (!this.canvas) {\n      throw new Error(`Canvas element with id \"${canvasId}\" not found`);\n    }\n    \n    this.ctx = this.canvas.getContext('2d');\n    this.options = {\n      minZoom: 0.1,\n      maxZoom: 10,\n      zoomSpeed: 0.1,\n      // æ ‡æ³¨ç‚¹åŸºç¡€é…ç½®\n      baseKeypointRadius: 8,               // åŸºç¡€æ ‡æ³¨ç‚¹åŠå¾„\n      minKeypointRadius: 4,                // æœ€å°æ ‡æ³¨ç‚¹åŠå¾„  \n      maxKeypointRadius: 20,               // æœ€å¤§æ ‡æ³¨ç‚¹åŠå¾„\n      keypointScaleFactor: 0.8,            // æ ‡æ³¨ç‚¹ç¼©æ”¾å› å­\n      // é¢œè‰²é…ç½®\n      keypointLeftColor: '#ff4444',        // å·¦ä¾§å…³é”®ç‚¹é¢œè‰²\n      keypointRightColor: '#4444ff',       // å³ä¾§å…³é”®ç‚¹é¢œè‰²\n      keypointHoverColor: '#ff6666',\n      keypointSelectedColor: '#ffaa00',    // é€‰ä¸­å…³é”®ç‚¹é¢œè‰²\n      keypointBorderColor: '#ffffff',\n      keypointBorderWidth: 2,\n      // æ ‡ç­¾æ˜¾ç¤ºé…ç½®\n      labelThresholdScale: 0.6,            // æ ‡ç­¾å¤–éƒ¨æ˜¾ç¤ºçš„ç¼©æ”¾é˜ˆå€¼\n      tinyThresholdScale: 0.3,             // æå°æ˜¾ç¤ºæ¨¡å¼çš„ç¼©æ”¾é˜ˆå€¼\n      labelOffset: 15,                     // å¤–éƒ¨æ ‡ç­¾åç§»è·ç¦»\n      // æ–¹å‘æ ‡æ³¨é…ç½®\n      directionThreshold: 20,              // æœ€å°æ‹–æ‹½è·ç¦»é˜ˆå€¼\n      directionArrowLength: 40,            // æ–¹å‘ç®­å¤´é•¿åº¦\n      ...options\n    };\n    \n    // çŠ¶æ€ç®¡ç†\n    this.state = {\n      scale: 1,\n      translateX: 0,\n      translateY: 0,\n      isDragging: false,\n      isPanning: false,\n      lastPanPoint: null,\n      // æ–°å¢ï¼šæ–¹å‘æ ‡æ³¨çŠ¶æ€\n      isDirectionDragging: false,\n      dragStartPoint: null,\n      currentDragPoint: null,\n      previewKeypoint: null,\n      // æ–°å¢ï¼šé€‰ä¸­å’Œæ–¹å‘é€‰æ‹©çŠ¶æ€\n      selectedKeypoint: null,               // å½“å‰é€‰ä¸­çš„å…³é”®ç‚¹\n      isDirectionSelectionMode: false,     // æ˜¯å¦å¤„äºæ–¹å‘é€‰æ‹©æ¨¡å¼\n      directionSelectionPoint: null,       // æ–¹å‘é€‰æ‹©çš„é¼ æ ‡ä½ç½®\n      // æ–°å¢ï¼šè‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©çŠ¶æ€\n      isAutoDirectionMode: false,          // æ˜¯å¦å¤„äºè‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©æ¨¡å¼\n      autoDirectionIndex: 0,               // å½“å‰è‡ªåŠ¨é€‰æ‹©çš„å…³é”®ç‚¹ç´¢å¼•\n      autoDirectionKeypoints: [],          // éœ€è¦è‡ªåŠ¨é€‰æ‹©æ–¹å‘çš„å…³é”®ç‚¹åˆ—è¡¨\n      // ğŸ”§ NEW: å¤šæ–¹å‘æ ‡æ³¨çŠ¶æ€\n      isDirectionCountMode: false,         // æ˜¯å¦å¤„äºæ–¹å‘æ•°é‡é€‰æ‹©æ¨¡å¼\n      currentDirectionCount: 1,            // å½“å‰æ–¹å‘æ•°é‡\n      directionsSet: 0,                    // å·²è®¾ç½®çš„æ–¹å‘æ•°é‡\n      // æ–°å¢ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®\n      autoMoveToExpectedPosition: false,   // æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®\n      // æ–°å¢ï¼šè‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½çŠ¶æ€\n      isCustomRegionDragging: false,       // æ˜¯å¦æ­£åœ¨æ‹–æ‹½è‡ªå®šä¹‰åŒºåŸŸ\n      customRegionStartPoint: null,        // åŒºåŸŸæ‹–æ‹½å¼€å§‹ç‚¹\n      customRegionCurrentPoint: null,      // åŒºåŸŸæ‹–æ‹½å½“å‰ç‚¹\n      // æ–°å¢ï¼šAuto OrderçŠ¶æ€\n      isAutoOrderMode: false,              // æ˜¯å¦å¤„äºè‡ªåŠ¨æ’åºæ¨¡å¼\n      autoOrderTypeId: null,               // å½“å‰è‡ªåŠ¨æ’åºçš„ç±»å‹ID\n      autoOrderCurrentOrder: 1,            // å½“å‰æ­£åœ¨æ’åºçš„orderå·\n      autoOrderImages: [],                 // éœ€è¦æ’åºçš„å›¾ç‰‡åˆ—è¡¨\n      autoOrderCurrentImageIndex: 0,       // å½“å‰å›¾ç‰‡ç´¢å¼•\n      isUnorderedMode: false               // æ— åºå·æ ‡æ³¨æ¨¡å¼\n    };\n    \n    // å›¾åƒç›¸å…³\n    this.currentImage = null;\n    this.imageElement = null;\n    this.imageLoaded = false;\n    \n    // æ ‡æ³¨æ•°æ®\n    this.keypoints = [];\n    this.hoveredKeypoint = null;\n    this.draggedKeypoint = null;\n    \n    // å†å²ç®¡ç†ï¼ˆæ’¤é”€/é‡åšï¼‰\n    this.history = [];\n    this.historyIndex = -1;\n    this.maxHistorySize = 50;\n    \n    // è‡ªå®šä¹‰æ ‡æ³¨ç³»ç»Ÿ\n    this.customAnnotationManager = null;\n    this.customAnnotationRenderer = null;\n    \n    // è‡ªå®šä¹‰æ ‡æ³¨æ‹–æ‹½çŠ¶æ€\n    this.customAnnotationDragState = {\n      isDragging: false,\n      draggedAnnotation: null,\n      startPosition: null\n    };\n    \n    // ğŸ”§ NEW: å›¾åƒåˆ‡æ¢é”å®šæœºåˆ¶ - é˜²æ­¢å¿«é€Ÿåˆ‡æ¢æ—¶çš„æ•°æ®æ··ä¹±\n    this.imageSwitchLock = {\n      isLocked: false,\n      currentLoadingImageId: null,\n      lockStartTime: null\n    };\n    \n    // ğŸ”§ NEW: Enhanced Auto Direction State Management\n    this.autoDirectionMode = 'longitudinal'; // 'longitudinal' | 'cross-sectional' - default fallback\n    this.crossSectionalState = null; // Will be initialized when cross-sectional mode starts\n    this.crossSectionalMap = new Map(); // Maps order numbers to image-annotation pairs\n    \n    // ç»‘å®šäº‹ä»¶\n    this.bindEvents();\n    \n    // åˆå§‹åŒ–Canvas\n    this.initializeCanvas();\n    \n    // åˆå§‹åŒ–è‡ªå®šä¹‰æ ‡æ³¨ç³»ç»Ÿ - å¼‚æ­¥ä½†ç«‹å³å¼€å§‹\n    this.initializeCustomAnnotationSystem();\n    \n    // ğŸ”§ FIX: Initialize auto direction mode from UI selector\n    this.initializeAutoDirectionModeFromUI();\n    \n    console.log('AnnotationTool initialized with advanced direction annotation support and custom annotations');\n  }\n\n  /**\n   * ğŸ”§ FIX: Initialize auto direction mode from UI selector\n   */\n  initializeAutoDirectionModeFromUI() {\n    // Use setTimeout to ensure DOM is fully loaded\n    setTimeout(() => {\n      const modeSelector = document.getElementById('auto-direction-mode-selector');\n      if (modeSelector && modeSelector.value) {\n        this.autoDirectionMode = modeSelector.value;\n        console.log('[è°ƒè¯•] ä»UIé€‰æ‹©å™¨åˆå§‹åŒ–è‡ªåŠ¨æ–¹å‘æ¨¡å¼:', this.autoDirectionMode);\n      } else {\n        // Set default value in UI selector if none exists\n        this.autoDirectionMode = 'longitudinal';\n        if (modeSelector) {\n          modeSelector.value = 'longitudinal';\n          console.log('[è°ƒè¯•] è®¾ç½®UIé€‰æ‹©å™¨é»˜è®¤å€¼ä¸º: longitudinal');\n        }\n      }\n    }, 100);\n  }\n\n  /**\n   * åˆå§‹åŒ–Canvas\n   */\n  initializeCanvas() {\n    // ğŸ”§ FIX: Add resize state tracking and debouncing\n    this.resizeState = {\n      isResizing: false,\n      lastResizeTime: 0,\n      debounceTimeout: null,\n      dimensionsHistory: []\n    };\n    \n    // å»¶è¿Ÿè®¾ç½®Canvaså°ºå¯¸ï¼Œç¡®ä¿å®¹å™¨å·²æ­£ç¡®æ¸²æŸ“\n    setTimeout(() => {\n      this.resizeCanvasWithRetry();\n    }, 200);\n    \n    // è®¾ç½®Canvasæ ·å¼\n    this.canvas.style.cursor = 'crosshair';\n    \n    // ğŸ”§ FIX: Debounced window resize listener to prevent excessive resizing\n    window.addEventListener('resize', () => {\n      this.debouncedResize();\n    });\n  }\n\n  /**\n   * å¸¦é‡è¯•æœºåˆ¶çš„Canvaså°ºå¯¸è°ƒæ•´\n   */\n  resizeCanvasWithRetry(retryCount = 0) {\n    const maxRetries = 10;\n    const container = this.canvas.parentElement;\n    const rect = container.getBoundingClientRect();\n    \n    // æ£€æŸ¥å®¹å™¨å°ºå¯¸æ˜¯å¦æœ‰æ•ˆ\n    if (rect.width === 0 || rect.height === 0) {\n      if (retryCount < maxRetries) {\n        console.warn(`Canvaså®¹å™¨å°ºå¯¸ä¸º0ï¼Œå»¶è¿Ÿé‡è¯•... (${retryCount + 1}/${maxRetries})`);\n        setTimeout(() => {\n          this.resizeCanvasWithRetry(retryCount + 1);\n        }, 300); // å¢åŠ é‡è¯•é—´éš”\n        return;\n      } else {\n        console.error('Canvaså®¹å™¨å°ºå¯¸å§‹ç»ˆä¸º0ï¼Œä½¿ç”¨é»˜è®¤å°ºå¯¸');\n        // ä½¿ç”¨é»˜è®¤å°ºå¯¸\n        this.canvas.width = 600;\n        this.canvas.height = 400;\n        this.canvas.style.width = '600px';\n        this.canvas.style.height = '400px';\n        this.render();\n        return;\n      }\n    }\n    \n    // è®¾ç½®æ­£ç¡®çš„å°ºå¯¸\n    this.resizeCanvas();\n    this.render();\n  }\n\n  /**\n   * ğŸ”§ ENHANCED: Debounced resize handler to prevent resize loops\n   */\n  debouncedResize() {\n    const now = Date.now();\n    \n    // ğŸ”§ FIX: Prevent resize loops with timing checks\n    if (this.resizeState.isResizing && (now - this.resizeState.lastResizeTime) < 100) {\n      console.debug('Resize loop detected, skipping resize');\n      return;\n    }\n    \n    // Clear existing debounce timeout\n    if (this.resizeState.debounceTimeout) {\n      clearTimeout(this.resizeState.debounceTimeout);\n    }\n    \n    // Debounce resize calls\n    this.resizeState.debounceTimeout = setTimeout(() => {\n      this.resizeCanvas();\n      this.render();\n    }, 150); // 150ms debounce\n  }\n\n  /**\n   * è°ƒæ•´Canvaså°ºå¯¸ - Enhanced with loop prevention\n   */\n  resizeCanvas() {\n    const container = this.canvas.parentElement;\n    const rect = container.getBoundingClientRect();\n    \n    // ç¡®ä¿å®¹å™¨æœ‰æœ‰æ•ˆå°ºå¯¸\n    if (rect.width === 0 || rect.height === 0) {\n      console.warn('Canvaså®¹å™¨å°ºå¯¸æ— æ•ˆï¼Œè·³è¿‡è°ƒæ•´');\n      return;\n    }\n    \n    // ğŸ”§ FIX: Prevent resize loops by checking if dimensions actually changed\n    const currentDimensions = `${rect.width}x${rect.height}`;\n    const history = this.resizeState.dimensionsHistory;\n    \n    // Check if we're oscillating between dimensions\n    if (history.length >= 3) {\n      const recent = history.slice(-3);\n      if (recent.includes(currentDimensions) && recent.filter(d => d === currentDimensions).length >= 2) {\n        console.warn(`Canvas resize oscillation detected (${currentDimensions}), stabilizing...`);\n        return;\n      }\n    }\n    \n    // Record dimension change\n    history.push(currentDimensions);\n    if (history.length > 5) {\n      history.shift(); // Keep only recent 5 changes\n    }\n    \n    // ğŸ”§ FIX: Set resize state to prevent recursive calls\n    this.resizeState.isResizing = true;\n    this.resizeState.lastResizeTime = Date.now();\n    \n    try {\n      // è®¾ç½®Canvaså®é™…å°ºå¯¸\n      this.canvas.width = rect.width;\n      this.canvas.height = rect.height;\n      \n      // è®¾ç½®Canvasæ˜¾ç¤ºå°ºå¯¸\n      this.canvas.style.width = rect.width + 'px';\n      this.canvas.style.height = rect.height + 'px';\n      \n      console.log(`Canvas resized to ${rect.width}x${rect.height}`);\n      \n      // ğŸ”§ FIX: Only call fitToScreen if not already in resize process\n      if (this.imageLoaded && this.imageElement && !this.resizeState.fittingToScreen) {\n        this.safeFitToScreen();\n      }\n    } finally {\n      // Reset resize state after a delay\n      setTimeout(() => {\n        this.resizeState.isResizing = false;\n      }, 200);\n    }\n  }\n\n  /**\n   * ç»‘å®šäº‹ä»¶ç›‘å¬å™¨\n   */\n  bindEvents() {\n    console.log('[è°ƒè¯•] bindEvents è¢«è°ƒç”¨ï¼Œç»‘å®šé¼ æ ‡äº‹ä»¶ç›‘å¬å™¨', { timestamp: Date.now() });\n\n    // é¼ æ ‡äº‹ä»¶\n    this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));\n    this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));\n    this.canvas.addEventListener('mouseup', (e) => this.handleMouseUp(e));\n    this.canvas.addEventListener('contextmenu', (e) => this.handleContextMenu(e));\n    \n    // è§¦æ‘¸æ¿ç¼©æ”¾\n    this.canvas.addEventListener('wheel', (e) => this.handleWheel(e), { passive: false });\n    \n    // é”®ç›˜äº‹ä»¶\n    document.addEventListener('keydown', (e) => this.handleKeyDown(e));\n    document.addEventListener('keyup', (e) => this.handleKeyUp(e));\n    \n    // é˜²æ­¢ä¸Šä¸‹æ–‡èœå•\n    this.canvas.addEventListener('contextmenu', (e) => e.preventDefault());\n  }\n\n  /**\n   * ğŸ”§ ENHANCED: åŠ è½½å›¾åƒï¼ˆå¸¦å›¾åƒåˆ‡æ¢é”å®šæœºåˆ¶ï¼‰\n   * @param {Object} imageData - å›¾åƒæ•°æ®\n   * @param {boolean} preserveView - æ˜¯å¦ä¿æŒå½“å‰è§†å›¾çŠ¶æ€ï¼ˆç¼©æ”¾å’Œä½ç½®ï¼‰\n   */\n  async loadImage(imageData, preserveView = false) {\n    try {\n      console.log('Loading image:', imageData.name);\n      \n      // ğŸ”§ NEW: è®¾ç½®å›¾åƒåˆ‡æ¢é”å®šï¼Œé˜²æ­¢auto-saveåœ¨åˆ‡æ¢è¿‡ç¨‹ä¸­æ‰§è¡Œ\n      this.setImageSwitchLock(true, imageData.id);\n      \n      // ğŸ”§ NEW: å›¾åƒåˆ‡æ¢æ—¶ä¸­æ–­æ‰€æœ‰æ–¹å‘ç›¸å…³æ¨¡å¼\n      this.interruptAllDirectionModes('image_switch');\n      \n      this.currentImage = imageData;\n      this.imageLoaded = false;\n      \n      // æ£€æŸ¥plantDataManageræ˜¯å¦å¯ç”¨\n      if (!window.PlantAnnotationTool || !window.PlantAnnotationTool.plantDataManager) {\n        // ğŸ”§ FIX: å‡ºé”™æ—¶è§£é”\n        this.setImageSwitchLock(false);\n        throw new Error('PlantDataManageræœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');\n      }\n      \n      const plantDataManager = window.PlantAnnotationTool.plantDataManager;\n      \n      if (!plantDataManager.fileSystemManager) {\n        // ğŸ”§ FIX: å‡ºé”™æ—¶è§£é”\n        this.setImageSwitchLock(false);\n        throw new Error('FileSystemManageræœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');\n      }\n      \n      // è·å–å›¾åƒURL\n      const imageURL = await plantDataManager.fileSystemManager.createImageURL(imageData);\n      \n      // åˆ›å»ºå›¾åƒå…ƒç´ \n      this.imageElement = new Image();\n      this.imageElement.crossOrigin = 'anonymous'; // ğŸ”§ FIX: Allow canvas access for SIFT matching\n      \n      return new Promise((resolve, reject) => {\n        this.imageElement.onload = () => {\n          this.imageLoaded = true;\n          console.log(`Image loaded: ${this.imageElement.width}x${this.imageElement.height}`);\n\n          // æ ¹æ®preserveViewå‚æ•°å†³å®šæ˜¯å¦é‡ç½®è§†å›¾\n          if (!preserveView) {\n            // ğŸ”§ FIX: Use safe fit to screen to prevent resize loops\n            this.safeFitToScreen();\n            console.log('é‡ç½®è§†å›¾åˆ°é€‚åˆå±å¹•');\n          } else {\n            console.log('ä¿æŒå½“å‰è§†å›¾çŠ¶æ€');\n          }\n\n          // æ³¨æ„ï¼šä¸å†è‡ªåŠ¨æ¸…ç©ºæ ‡æ³¨ç‚¹ï¼Œè®©å¤–éƒ¨è°ƒç”¨è€…å†³å®šæ˜¯å¦éœ€è¦æ¸…ç©º\n          // this.clearKeypoints(); // ç§»é™¤è¿™è¡Œ\n\n          // æ¸²æŸ“\n          this.render();\n\n          // ğŸ”§ NEW: å›¾åƒåŠ è½½å®Œæˆåè§£é”ï¼Œå…è®¸auto-save\n          this.setImageSwitchLock(false);\n\n          resolve();\n        };\n        \n        this.imageElement.onerror = () => {\n          // ğŸ”§ FIX: å‡ºé”™æ—¶è§£é”\n          this.setImageSwitchLock(false);\n          reject(new Error('Failed to load image'));\n        };\n        \n        this.imageElement.src = imageURL;\n      });\n      \n    } catch (error) {\n      console.error('Error loading image:', error);\n      // ğŸ”§ FIX: å‡ºé”™æ—¶è§£é”\n      this.setImageSwitchLock(false);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ ENHANCED: Safe fit to screen with loop prevention\n   */\n  safeFitToScreen() {\n    // Prevent recursive fit-to-screen calls\n    if (this.resizeState.fittingToScreen) {\n      console.debug('fitToScreen already in progress, skipping');\n      return;\n    }\n    \n    this.resizeState.fittingToScreen = true;\n    \n    try {\n      this.fitToScreen();\n    } finally {\n      // Reset flag after processing\n      setTimeout(() => {\n        this.resizeState.fittingToScreen = false;\n      }, 50);\n    }\n  }\n\n  /**\n   * é€‚åº”å±å¹•å°ºå¯¸ - Enhanced with stability checks\n   */\n  fitToScreen() {\n    if (!this.imageElement || !this.imageLoaded) return;\n    \n    const canvasWidth = this.canvas.width;\n    const canvasHeight = this.canvas.height;\n    const imageWidth = this.imageElement.width;\n    const imageHeight = this.imageElement.height;\n    \n    // ğŸ”§ FIX: Validate canvas and image dimensions\n    if (canvasWidth <= 0 || canvasHeight <= 0 || imageWidth <= 0 || imageHeight <= 0) {\n      console.warn('Invalid dimensions for fit to screen, skipping');\n      return;\n    }\n    \n    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰\n    const scaleX = (canvasWidth * 0.9) / imageWidth;\n    const scaleY = (canvasHeight * 0.9) / imageHeight;\n    const scale = Math.min(scaleX, scaleY);\n    \n    // ğŸ”§ FIX: Add scale change detection to prevent unnecessary updates\n    const newScale = Math.max(this.options.minZoom, Math.min(this.options.maxZoom, scale));\n    const scaleChange = Math.abs(newScale - this.state.scale);\n    \n    // Only update if scale change is significant (more than 1%)\n    if (scaleChange > 0.01) {\n      this.state.scale = newScale;\n      \n      // å±…ä¸­æ˜¾ç¤º\n      this.state.translateX = (canvasWidth - imageWidth * this.state.scale) / 2;\n      this.state.translateY = (canvasHeight - imageHeight * this.state.scale) / 2;\n      \n      this.updateZoomInfo();\n      console.log(`Fit to screen: scale=${this.state.scale.toFixed(2)} (change: ${scaleChange.toFixed(3)})`);\n    } else {\n      console.debug(`Scale change too small (${scaleChange.toFixed(3)}), skipping update`);\n    }\n  }\n\n  /**\n   * é‡ç½®è§†å›¾\n   */\n  resetView() {\n    if (!this.imageElement || !this.imageLoaded) return;\n    \n    this.state.scale = 1;\n    this.state.translateX = 0;\n    this.state.translateY = 0;\n    \n    this.updateZoomInfo();\n    this.render();\n  }\n\n  /**\n   * æ¸…ç©ºå›¾åƒå’Œé‡ç½®è§†å›¾ - ç”¨äºæ¤ç‰©åˆ‡æ¢æ—¶å®Œå…¨æ¸…ç©ºå·¥ä½œåŒº\n   */\n  clearImage() {\n    console.log('æ¸…ç©ºå›¾åƒå’Œé‡ç½®è§†å›¾');\n    \n    // ğŸ”§ NEW: æ¤ç‰©åˆ‡æ¢æ—¶ä¸­æ–­æ‰€æœ‰æ–¹å‘ç›¸å…³æ¨¡å¼\n    this.interruptAllDirectionModes('plant_switch');\n    \n    // æ¸…ç©ºå›¾åƒç›¸å…³çŠ¶æ€\n    this.currentImage = null;\n    this.imageElement = null;\n    this.imageLoaded = false;\n    \n    // é‡ç½®è§†å›¾çŠ¶æ€\n    this.state.scale = 1;\n    this.state.translateX = 0;\n    this.state.translateY = 0;\n    \n    // ğŸ”§ FIX: æ¸…ç©ºæ ‡æ³¨ç‚¹ä½†ä¸è§¦å‘è‡ªåŠ¨ä¿å­˜ï¼ˆé˜²æ­¢è¦†ç›–å·²ä¿å­˜çš„æ•°æ®ï¼‰\n    this.clearKeypointsWithoutSave();\n    \n    // ğŸ”§ FIX: Additional safety - clear any keypoint labels that might remain\n    this.clearKeypointLabels();\n    \n    // æ›´æ–°æ˜¾ç¤º\n    this.updateZoomInfo();\n    this.render(); // ç°åœ¨ä¼šæ˜¾ç¤ºå ä½ç¬¦è€Œä¸æ˜¯å›¾åƒå’Œæ ‡æ³¨ç‚¹\n  }\n\n  /**\n   * æ¸²æŸ“Canvas\n   */\n  render() {\n    // æ¸…ç©ºCanvas\n    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n    \n    if (!this.imageElement || !this.imageLoaded) {\n      this.renderPlaceholder();\n      return;\n    }\n    \n    // ä¿å­˜CanvasçŠ¶æ€\n    this.ctx.save();\n    \n    // åº”ç”¨å˜æ¢\n    this.ctx.translate(this.state.translateX, this.state.translateY);\n    this.ctx.scale(this.state.scale, this.state.scale);\n    \n    // ç»˜åˆ¶å›¾åƒ\n    this.ctx.drawImage(this.imageElement, 0, 0);\n    \n    // æ¢å¤CanvasçŠ¶æ€\n    this.ctx.restore();\n    \n    // ğŸ”§ NEW: å¦‚æœåœ¨æ ¡å‡†é¢„è§ˆæ¨¡å¼ï¼Œæ¸²æŸ“æ ¡å‡†å¯è§†åŒ–\n    if (this.calibrationPreviewState?.isActive) {\n      this.renderCalibrationPreview();\n    } else {\n      // æ­£å¸¸æ¨¡å¼ï¼šç»˜åˆ¶æ ‡æ³¨ç‚¹\n      this.renderKeypoints();\n    }\n    \n    // ç»˜åˆ¶è‡ªå®šä¹‰æ ‡æ³¨\n    this.renderCustomAnnotations();\n  }\n\n  /**\n   * æ¸²æŸ“å ä½ç¬¦\n   */\n  renderPlaceholder() {\n    const centerX = this.canvas.width / 2;\n    const centerY = this.canvas.height / 2;\n    \n    this.ctx.fillStyle = '#f3f4f6';\n    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);\n    \n    this.ctx.fillStyle = '#6b7280';\n    this.ctx.font = '16px Inter, sans-serif';\n    this.ctx.textAlign = 'center';\n    this.ctx.fillText('Please choose image to annotate', centerX, centerY);\n  }\n\n  /**\n   * æ¸²æŸ“æ ‡æ³¨ç‚¹ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼Œæ”¯æŒè‡ªå®šä¹‰ç±»å‹ï¼‰\n   */\n  renderKeypoints() {\n    // ğŸ”§ FIX: Don't render keypoints when no image is loaded to prevent \"ghost\" annotations\n    if (!this.imageElement || !this.imageLoaded) {\n      console.log('[AnnotationTool] Skipping keypoint render - no image loaded');\n      return;\n    }\n    \n    // æ¸…é™¤æ‰€æœ‰æ ‡ç­¾å…ƒç´ \n    this.clearKeypointLabels();\n    \n    // è·å–å½“å‰çš„æ˜¾ç¤ºç­–ç•¥\n    const displayStrategy = this.getKeypointDisplayStrategy();\n    \n    // æ¸²æŸ“å·²å­˜åœ¨çš„æ ‡æ³¨ç‚¹\n    this.keypoints.forEach((keypoint, index) => {\n      const screenPos = this.imageToScreen(keypoint.x, keypoint.y);\n      \n      // ğŸ”„ NEW: ç»Ÿä¸€æ¸²æŸ“ç³»ç»Ÿ - æ”¯æŒè‡ªå®šä¹‰ç±»å‹\n      if (keypoint.annotationType === 'custom') {\n        this.renderCustomKeypoint(keypoint, screenPos, displayStrategy);\n      } else {\n        // å°†ä»»ä½•écustomæ ‡æ³¨å…œåº•è§†ä¸ºå†…ç½®regularç±»å‹ï¼ˆè¿ç§»åæå°‘å‡ºç°ï¼‰\n        const fallback = { ...keypoint, annotationType: 'custom', customTypeId: 'builtin-regular-keypoint' };\n        this.renderCustomKeypoint(fallback, screenPos, displayStrategy);\n      }\n    });\n    \n    // æ¸²æŸ“æ‹–æ‹½é¢„è§ˆ\n    if (this.state.isDirectionDragging && this.state.previewKeypoint) {\n      const previewPos = this.imageToScreen(this.state.previewKeypoint.x, this.state.previewKeypoint.y);\n      const direction = this.state.previewKeypoint.direction;\n      const fillColor = direction === 'left' ? this.options.keypointLeftColor : this.options.keypointRightColor;\n      \n      // åŠé€æ˜é¢„è§ˆ\n      this.ctx.globalAlpha = 0.7;\n      this.renderSingleKeypoint(previewPos.x, previewPos.y, fillColor, '?', direction, displayStrategy);\n      this.ctx.globalAlpha = 1.0;\n      \n      // ç»˜åˆ¶æ‹–æ‹½æŒ‡ç¤ºå™¨\n      this.renderDragIndicator();\n    }\n    \n    // æ¸²æŸ“è‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½é¢„è§ˆ\n    if (this.state.isCustomRegionDragging) {\n      this.renderCustomRegionPreview();\n    }\n    \n    // æ¸²æŸ“æ–¹å‘é€‰æ‹©æŒ‡å¼•\n    if (this.state.isDirectionSelectionMode && this.state.selectedKeypoint && this.state.directionSelectionPoint) {\n      this.renderDirectionSelectionGuide();\n    }\n    \n    // æ›´æ–°ç¼©æ”¾çº§åˆ«æŒ‡ç¤ºå™¨\n    this.updateZoomIndicator(displayStrategy);\n    \n    // æ›´æ–°æ ‡æ³¨ç‚¹å¤§å°ä¿¡æ¯\n    this.updateAnnotationSizeInfo(displayStrategy);\n  }\n\n  /**\n   * ğŸ”„ NEW: æ¸²æŸ“å¸¸è§„æ ‡æ³¨ç‚¹\n   */\n  renderRegularKeypoint(keypoint, screenPos, displayStrategy, index) {\n    // ç¡®å®šé¢œè‰²ï¼ˆæ ¹æ®æ–¹å‘å’Œé€‰ä¸­çŠ¶æ€ï¼‰\n    const isHovered = this.hoveredKeypoint === keypoint;\n    const isSelected = this.state.selectedKeypoint === keypoint;\n    let fillColor;\n    \n    if (isSelected) {\n      fillColor = this.options.keypointSelectedColor;\n    } else if (isHovered) {\n      fillColor = this.options.keypointHoverColor;\n    } else if (keypoint.directionType === 'angle' || typeof keypoint.direction === 'number') {\n      // è§’åº¦ç±»å‹ä½¿ç”¨ç‰¹æ®Šé¢œè‰²\n      fillColor = '#00aa00'; // ç»¿è‰²è¡¨ç¤ºå·²è®¾ç½®è§’åº¦\n    } else if (keypoint.direction === 'left') {\n      fillColor = this.options.keypointLeftColor;\n    } else if (keypoint.direction === 'right') {\n      fillColor = this.options.keypointRightColor;\n    } else {\n      // æ— æ–¹å‘æ ‡æ³¨ç‚¹ä½¿ç”¨ç´«è‰²\n      fillColor = '#9333ea'; // ç´«è‰²è¡¨ç¤ºæ— æ–¹å‘\n    }\n    \n    // ä½¿ç”¨æ ‡æ³¨ç‚¹çš„åºå·ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç´¢å¼•+1ä½œä¸ºåå¤‡\n    const displayOrder = keypoint.order || (index + 1);\n    \n    this.renderSingleKeypoint(screenPos.x, screenPos.y, fillColor, displayOrder, keypoint.direction, displayStrategy, keypoint);\n\n    // ğŸ”§ NEW: ç»˜åˆ¶å¤šæ–¹å‘ç®­å¤´ï¼ˆå¦‚æœæœ‰å¤šä¸ªæ–¹å‘ï¼‰\n    // ç¡®ä¿æ–¹å‘æ•°ç»„è§„èŒƒ\n    this.ensureMultiDirectionSupport(keypoint);\n    if (keypoint.directions && keypoint.directions.length > 1) {\n      this.renderMultipleDirections(keypoint);\n    } else {\n      // ç»˜åˆ¶å•ä¸€æ–¹å‘ç®­å¤´ï¼ˆæ”¯æŒæ‰€æœ‰ç±»å‹çš„æ–¹å‘ï¼‰\n      this.renderDirectionIndicator(screenPos.x, screenPos.y, keypoint.direction, keypoint);\n    }\n  }\n  \n  /**\n   * ğŸ”„ NEW: æ¸²æŸ“è‡ªå®šä¹‰æ ‡æ³¨ç‚¹\n   */\n  renderCustomKeypoint(keypoint, screenPos, displayStrategy) {\n    const customType = this.getCustomType(keypoint.customTypeId);\n    if (!customType) {\n      console.warn(`Custom type ${keypoint.customTypeId} not found`);\n      return;\n    }\n    \n    // ç¡®å®šé€æ˜åº¦å’Œè¾¹æ¡†ï¼ˆæ‚¬åœå’Œé€‰ä¸­çŠ¶æ€ï¼‰\n    const isHovered = this.hoveredKeypoint === keypoint;\n    const isSelected = this.state.selectedKeypoint === keypoint;\n    let alpha = 1;\n    let strokeWidth = displayStrategy.borderWidth;\n    \n    if (isSelected) {\n      alpha = 0.9;\n      strokeWidth = displayStrategy.borderWidth + 1; // é€‰ä¸­æ—¶è¾¹æ¡†åŠ ç²—\n    } else if (isHovered) {\n      alpha = 0.8;\n      strokeWidth = displayStrategy.borderWidth + 0.5; // æ‚¬åœæ—¶è¾¹æ¡†ç¨ç²—\n    }\n    \n    this.ctx.save();\n    this.ctx.globalAlpha = alpha;\n    \n    if (keypoint.width && keypoint.height) {\n      // æ¸²æŸ“åŒºåŸŸæ ‡æ³¨\n      this.renderCustomRegion(keypoint, screenPos, customType, {...displayStrategy, borderWidth: strokeWidth});\n    } else {\n      // æ¸²æŸ“ç‚¹æ ‡æ³¨  \n      this.renderCustomPoint(keypoint, screenPos, customType, {...displayStrategy, borderWidth: strokeWidth});\n    }\n    \n    this.ctx.restore();\n  }\n  \n  /**\n   * ğŸ”„ NEW: æ¸²æŸ“è‡ªå®šä¹‰ç‚¹æ ‡æ³¨\n   */\n  renderCustomPoint(keypoint, screenPos, customType, displayStrategy) {\n    // æ£€æŸ¥é€‰ä¸­å’Œæ‚¬åœçŠ¶æ€ä»¥è°ƒæ•´å¤§å°\n    const isSelected = (this.state.selectedKeypoint === keypoint) || \n                      (this.customAnnotationRenderer?.selectedAnnotation === keypoint);\n    const isHovered = this.hoveredKeypoint === keypoint;\n    \n    // æ‚¬åœå’Œé€‰ä¸­æ—¶ç¨å¾®å¢å¤§åŠå¾„\n    const radius = isSelected ? displayStrategy.radius + 2 : \n                  (isHovered ? displayStrategy.radius + 1 : displayStrategy.radius);\n    \n    // ç»˜åˆ¶ç‚¹\n    this.ctx.beginPath();\n    this.ctx.arc(screenPos.x, screenPos.y, radius, 0, 2 * Math.PI);\n    this.ctx.fillStyle = customType.color;\n    this.ctx.fill();\n    \n    // ç»˜åˆ¶è¾¹æ¡†\n    this.ctx.strokeStyle = '#ffffff';\n    this.ctx.lineWidth = displayStrategy.borderWidth;\n    this.ctx.stroke();\n    \n    // ç»˜åˆ¶æ ‡ç­¾ï¼ˆåªæœ‰æœ‰åºå·æ—¶æ‰æ˜¾ç¤ºï¼‰\n    if (displayStrategy.showInternalLabel && keypoint.order !== undefined && keypoint.order !== null) {\n      this.ctx.fillStyle = '#ffffff';\n      this.ctx.font = `bold ${displayStrategy.fontSize}px Arial`;\n      this.ctx.textAlign = 'center';\n      this.ctx.textBaseline = 'middle';\n      this.ctx.fillText(keypoint.order.toString(), screenPos.x, screenPos.y);\n    } else if (displayStrategy.showExternalLabel && keypoint.order !== undefined && keypoint.order !== null) {\n      this.renderCustomPointLabel(keypoint, screenPos, customType, displayStrategy);\n    }\n\n    // ç¡®ä¿æ–¹å‘æ•°ç»„è§„èŒƒ\n    this.ensureMultiDirectionSupport(keypoint);\n    // ç»˜åˆ¶æ–¹å‘æŒ‡ç¤ºï¼ˆé»˜è®¤å¼€å¯ï¼›ä»…å½“æ˜¾å¼ä¸º false æ—¶å…³é—­ï¼‰\n    if (!(customType && customType.metadata && customType.metadata.isDirectional === false)) {\n      if (keypoint.directions && keypoint.directions.length > 1) {\n        this.renderMultipleDirections(keypoint);\n      } else {\n        this.renderDirectionIndicator(screenPos.x, screenPos.y, keypoint.direction, keypoint);\n      }\n    }\n\n    // å¦‚æœå­˜åœ¨çˆ¶ç»‘å®šï¼Œç»˜åˆ¶è™šçº¿åˆ°çˆ¶èŠ‚ç‚¹\n    this.renderParentLinkIfAny(keypoint, customType);\n  }\n  \n  /**\n   * ğŸ”„ NEW: æ¸²æŸ“è‡ªå®šä¹‰åŒºåŸŸæ ‡æ³¨\n   */\n  renderCustomRegion(keypoint, screenPos, customType, displayStrategy) {\n    // è®¡ç®—åŒºåŸŸå±å¹•åæ ‡\n    const bottomRightScreen = this.imageToScreen(\n      keypoint.x + keypoint.width,\n      keypoint.y + keypoint.height\n    );\n    \n    const screenWidth = bottomRightScreen.x - screenPos.x;\n    const screenHeight = bottomRightScreen.y - screenPos.y;\n    \n    // æ£€æŸ¥é€‰ä¸­çŠ¶æ€ä»¥å†³å®šé«˜äº®\n    const isSelected = (this.state.selectedKeypoint === keypoint) || \n                      (this.customAnnotationRenderer?.selectedAnnotation === keypoint);\n    const isHovered = this.hoveredKeypoint === keypoint;\n    \n    // ç»˜åˆ¶å¡«å……åŒºåŸŸï¼ˆæ‚¬åœå’Œé€‰ä¸­æ—¶æœ‰ä¸åŒé€æ˜åº¦ï¼‰\n    this.ctx.fillStyle = customType.color;\n    this.ctx.globalAlpha = isSelected ? 0.4 : (isHovered ? 0.3 : 0.2); // é€‰ä¸­>æ‚¬åœ>é»˜è®¤\n    this.ctx.fillRect(screenPos.x, screenPos.y, screenWidth, screenHeight);\n    \n    // ç»˜åˆ¶è¾¹æ¡†ï¼ˆé€‰ä¸­æ—¶åŠ ç²—ï¼Œæ‚¬åœæ—¶ç¨ç²—ï¼‰\n    this.ctx.globalAlpha = 1.0;\n    this.ctx.strokeStyle = customType.color;\n    this.ctx.lineWidth = isSelected ? (displayStrategy.borderWidth + 2) : \n                        (isHovered ? (displayStrategy.borderWidth + 1) : displayStrategy.borderWidth);\n    this.ctx.strokeRect(screenPos.x, screenPos.y, screenWidth, screenHeight);\n    \n    // ç»˜åˆ¶æ ‡ç­¾ï¼ˆåœ¨ä¸­å¿ƒï¼‰\n    const centerX = screenPos.x + screenWidth / 2;\n    const centerY = screenPos.y + screenHeight / 2;\n    \n    if (displayStrategy.showInternalLabel && Math.min(screenWidth, screenHeight) > 20 && keypoint.order !== undefined && keypoint.order !== null) {\n      this.ctx.fillStyle = customType.color;\n      this.ctx.font = `bold ${displayStrategy.fontSize}px Arial`;\n      this.ctx.textAlign = 'center';\n      this.ctx.textBaseline = 'middle';\n      this.ctx.fillText(keypoint.order.toString(), centerX, centerY);\n    }\n    \n    if (displayStrategy.showExternalLabel && keypoint.order !== undefined && keypoint.order !== null) {\n      this.renderCustomRegionLabel(keypoint, { x: centerX, y: screenPos.y }, customType, displayStrategy);\n    }\n\n    // ç¡®ä¿æ–¹å‘æ•°ç»„è§„èŒƒ\n    this.ensureMultiDirectionSupport(keypoint);\n    // ç»˜åˆ¶æ–¹å‘æŒ‡ç¤ºï¼ˆçŸ©å½¢ä¸­å¿ƒä¸ºé”šç‚¹ï¼›é»˜è®¤å¼€å¯ï¼Œé™¤é isDirectional === falseï¼‰\n    if (!(customType && customType.metadata && customType.metadata.isDirectional === false)) {\n      if (keypoint.directions && keypoint.directions.length > 1) {\n        // å¯¹äºçŸ©å½¢ï¼Œä½¿ç”¨ä¸­å¿ƒç‚¹æ¸²æŸ“å¤šæ–¹å‘ç®­å¤´\n        const backup = { x: keypoint.x, y: keypoint.y };\n        // ä¸´æ—¶ä»¥ä¸­å¿ƒä¸ºé”šç‚¹æ¸²æŸ“\n        const centerKeypoint = { ...keypoint, x: keypoint.x + keypoint.width / 2, y: keypoint.y + keypoint.height / 2 };\n        this.renderMultipleDirections(centerKeypoint);\n      } else {\n        this.renderDirectionIndicator(\n          centerX,\n          centerY,\n          keypoint.direction,\n          keypoint\n        );\n      }\n    }\n\n    // å¦‚æœå­˜åœ¨çˆ¶ç»‘å®šï¼Œç»˜åˆ¶è™šçº¿åˆ°çˆ¶èŠ‚ç‚¹ï¼ˆä¸­å¿ƒç‚¹åæ ‡è½¬æ¢ä¸ºå›¾åƒåæ ‡ï¼‰\n    const centerImageX = keypoint.x + keypoint.width / 2;\n    const centerImageY = keypoint.y + keypoint.height / 2;\n    this.renderParentLinkIfAny(keypoint, customType, centerImageX, centerImageY);\n    \n    // å¦‚æœæ˜¯é€‰ä¸­çŠ¶æ€ï¼Œç»˜åˆ¶resize handles\n    const isRegionSelected = (this.state.selectedKeypoint === keypoint) || \n                             (this.customAnnotationRenderer?.selectedAnnotation === keypoint);\n    if (isRegionSelected) {\n      this.renderRegionResizeHandles(keypoint, screenPos, screenWidth, screenHeight, customType);\n    }\n  }\n\n  /**\n   * æ¸²æŸ“åŒºåŸŸresize handles\n   */\n  renderRegionResizeHandles(keypoint, screenPos, screenWidth, screenHeight, customType) {\n    // è®¡ç®—handleå¤§å°ï¼ˆéšç¼©æ”¾è°ƒæ•´ï¼‰\n    const handleSize = Math.max(8, Math.min(14, 10 * this.state.scale));\n    const half = handleSize / 2;\n    \n    // è®¡ç®—8ä¸ªhandleçš„ä½ç½®\n    const corners = [\n      { x: screenPos.x, y: screenPos.y }, // nw\n      { x: screenPos.x + screenWidth, y: screenPos.y }, // ne\n      { x: screenPos.x, y: screenPos.y + screenHeight }, // sw\n      { x: screenPos.x + screenWidth, y: screenPos.y + screenHeight } // se\n    ];\n    const edges = [\n      { x: screenPos.x + screenWidth / 2, y: screenPos.y }, // n\n      { x: screenPos.x + screenWidth / 2, y: screenPos.y + screenHeight }, // s\n      { x: screenPos.x, y: screenPos.y + screenHeight / 2 }, // w\n      { x: screenPos.x + screenWidth, y: screenPos.y + screenHeight / 2 } // e\n    ];\n\n    this.ctx.save();\n    this.ctx.fillStyle = '#ffffff';\n    this.ctx.strokeStyle = customType.color;\n    this.ctx.lineWidth = 1.5;\n    \n    // ç»˜åˆ¶è§’è½handles\n    corners.forEach(pt => {\n      this.ctx.fillRect(pt.x - half, pt.y - half, handleSize, handleSize);\n      this.ctx.strokeRect(pt.x - half, pt.y - half, handleSize, handleSize);\n    });\n    \n    // ç»˜åˆ¶è¾¹ç¼˜handles\n    edges.forEach(pt => {\n      this.ctx.fillRect(pt.x - half, pt.y - half, handleSize, handleSize);\n      this.ctx.strokeRect(pt.x - half, pt.y - half, handleSize, handleSize);\n    });\n    \n    this.ctx.restore();\n  }\n\n  /**\n   * æ£€æµ‹é¼ æ ‡ä½ç½®æ˜¯å¦åœ¨åŒºåŸŸresize handleä¸Š\n   */\n  getRegionHandleAt(mousePos, annotation) {\n    if (!annotation.width || !annotation.height) return null;\n    \n    const topLeft = this.imageToScreen(annotation.x, annotation.y);\n    const bottomRight = this.imageToScreen(\n      annotation.x + annotation.width,\n      annotation.y + annotation.height\n    );\n    \n    const screenWidth = bottomRight.x - topLeft.x;\n    const screenHeight = bottomRight.y - topLeft.y;\n    \n    // Handleå¤§å°ï¼ˆä¸æ¸²æŸ“æ—¶ä¸€è‡´ï¼‰\n    const handleSize = Math.max(8, Math.min(14, 10 * this.state.scale));\n    const half = handleSize / 2;\n    \n    // æ£€æµ‹å‡½æ•°\n    function hit(pt) {\n      return Math.abs(mousePos.x - pt.x) <= half && Math.abs(mousePos.y - pt.y) <= half;\n    }\n    \n    // æ£€æµ‹è§’è½handles\n    if (hit({ x: topLeft.x, y: topLeft.y })) return 'nw';\n    if (hit({ x: topLeft.x + screenWidth, y: topLeft.y })) return 'ne';\n    if (hit({ x: topLeft.x, y: topLeft.y + screenHeight })) return 'sw';\n    if (hit({ x: topLeft.x + screenWidth, y: topLeft.y + screenHeight })) return 'se';\n    \n    // æ£€æµ‹è¾¹ç¼˜handles\n    if (hit({ x: topLeft.x + screenWidth / 2, y: topLeft.y })) return 'n';\n    if (hit({ x: topLeft.x + screenWidth / 2, y: topLeft.y + screenHeight })) return 's';\n    if (hit({ x: topLeft.x, y: topLeft.y + screenHeight / 2 })) return 'w';\n    if (hit({ x: topLeft.x + screenWidth, y: topLeft.y + screenHeight / 2 })) return 'e';\n    \n    return null;\n  }\n\n  /**\n   * å¦‚æœæ ‡æ³¨å­˜åœ¨çˆ¶ç»‘å®šï¼Œåˆ™ç»˜åˆ¶è™šçº¿è¿çº¿\n   */\n  renderParentLinkIfAny(keypoint, customType, originX = null, originY = null) {\n    if (!keypoint.parentAnnotationType || !keypoint.parentAnnotationId) return;\n    const parentTypeId = keypoint.parentAnnotationType;\n    const parentOrder = keypoint.parentAnnotationId;\n    const parent = this.keypoints.find(kp => kp.annotationType === 'custom' && kp.customTypeId === parentTypeId && kp.order === parentOrder);\n    if (!parent) return;\n\n    const fromX = originX !== null ? originX : keypoint.x;\n    const fromY = originY !== null ? originY : keypoint.y;\n    const from = this.imageToScreen(fromX, fromY);\n    let toX = parent.x;\n    let toY = parent.y;\n    if (parent.width && parent.height) {\n      toX = parent.x + parent.width / 2;\n      toY = parent.y + parent.height / 2;\n    }\n    const to = this.imageToScreen(toX, toY);\n\n    this.ctx.save();\n    this.ctx.strokeStyle = '#9ca3af';\n    this.ctx.lineWidth = 2;\n    this.ctx.setLineDash([6, 6]);\n    this.ctx.beginPath();\n    this.ctx.moveTo(from.x, from.y);\n    this.ctx.lineTo(to.x, to.y);\n    this.ctx.stroke();\n    this.ctx.setLineDash([]);\n    this.ctx.restore();\n  }\n  \n  /**\n   * ğŸ”„ NEW: æ¸²æŸ“è‡ªå®šä¹‰ç‚¹æ ‡ç­¾\n   */\n  renderCustomPointLabel(keypoint, screenPos, customType, displayStrategy) {\n    const labelY = screenPos.y - displayStrategy.radius - displayStrategy.labelOffset;\n    \n    this.ctx.save();\n    \n    // åˆ›å»ºæ ‡ç­¾æ–‡æœ¬ï¼ˆæœ‰åºå·æ—¶æ˜¾ç¤ºåºå·ï¼Œæ— åºå·æ—¶åªæ˜¾ç¤ºç±»å‹åï¼‰\n    const labelText = keypoint.order !== undefined && keypoint.order !== null \n      ? `${customType.name} #${keypoint.order}`\n      : customType.name;\n    this.ctx.font = `${displayStrategy.fontSize}px Arial`;\n    const textMetrics = this.ctx.measureText(labelText);\n    const textWidth = textMetrics.width;\n    \n    // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯\n    const padding = 4;\n    this.ctx.fillStyle = customType.color;\n    this.ctx.fillRect(\n      screenPos.x - textWidth / 2 - padding,\n      labelY - displayStrategy.fontSize / 2 - padding,\n      textWidth + padding * 2,\n      displayStrategy.fontSize + padding * 2\n    );\n    \n    // ç»˜åˆ¶æ ‡ç­¾æ–‡æœ¬\n    this.ctx.fillStyle = '#ffffff';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    this.ctx.fillText(labelText, screenPos.x, labelY);\n    \n    this.ctx.restore();\n  }\n  \n  /**\n   * ğŸ”„ NEW: æ¸²æŸ“è‡ªå®šä¹‰åŒºåŸŸæ ‡ç­¾\n   */\n  renderCustomRegionLabel(keypoint, screenPos, customType, displayStrategy) {\n    const labelY = screenPos.y - displayStrategy.labelOffset;\n    \n    this.ctx.save();\n    \n    // åˆ›å»ºæ ‡ç­¾æ–‡æœ¬ï¼ˆæœ‰åºå·æ—¶æ˜¾ç¤ºåºå·ï¼Œæ— åºå·æ—¶åªæ˜¾ç¤ºç±»å‹åï¼‰\n    const labelText = keypoint.order !== undefined && keypoint.order !== null \n      ? `${customType.name} #${keypoint.order}`\n      : customType.name;\n    this.ctx.font = `${displayStrategy.fontSize}px Arial`;\n    const textMetrics = this.ctx.measureText(labelText);\n    const textWidth = textMetrics.width;\n    \n    // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯\n    const padding = 4;\n    this.ctx.fillStyle = customType.color;\n    this.ctx.fillRect(\n      screenPos.x - textWidth / 2 - padding,\n      labelY - displayStrategy.fontSize / 2 - padding,\n      textWidth + padding * 2,\n      displayStrategy.fontSize + padding * 2\n    );\n    \n    // ç»˜åˆ¶æ ‡ç­¾æ–‡æœ¬\n    this.ctx.fillStyle = '#ffffff';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    this.ctx.fillText(labelText, screenPos.x, labelY);\n    \n    this.ctx.restore();\n  }\n  \n  /**\n   * ğŸ”„ NEW: æ¸²æŸ“è‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½é¢„è§ˆ\n   */\n  renderCustomRegionPreview() {\n    if (!this.state.isCustomRegionDragging) return;\n    \n    const startScreenPos = this.state.customRegionStartPoint;\n    const currentScreenPos = this.state.customRegionCurrentPoint;\n    \n    if (!startScreenPos || !currentScreenPos) return;\n    \n    const customType = this.customAnnotationManager?.getCurrentCustomType();\n    if (!customType || customType.type !== 'region') return;\n    \n    const left = Math.min(startScreenPos.x, currentScreenPos.x);\n    const top = Math.min(startScreenPos.y, currentScreenPos.y);\n    const width = Math.abs(currentScreenPos.x - startScreenPos.x);\n    const height = Math.abs(currentScreenPos.y - startScreenPos.y);\n    \n    this.ctx.save();\n    this.ctx.globalAlpha = 0.5;\n    \n    // ç»˜åˆ¶é¢„è§ˆå¡«å……\n    this.ctx.fillStyle = customType.color;\n    this.ctx.fillRect(left, top, width, height);\n    \n    // ç»˜åˆ¶é¢„è§ˆè¾¹æ¡†\n    this.ctx.strokeStyle = customType.color;\n    this.ctx.lineWidth = 2;\n    this.ctx.setLineDash([5, 5]);\n    this.ctx.strokeRect(left, top, width, height);\n    \n    // ç»˜åˆ¶å°ºå¯¸ä¿¡æ¯\n    this.ctx.globalAlpha = 0.8;\n    this.ctx.fillStyle = '#000000';\n    this.ctx.font = '12px Arial';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    \n    const sizeText = `${Math.round(width)}x${Math.round(height)}`;\n    this.ctx.fillText(sizeText, left + width/2, top + height/2);\n    \n    this.ctx.restore();\n  }\n  \n  /**\n   * æ¸²æŸ“å•ä¸ªæ ‡æ³¨ç‚¹\n   */\n  renderSingleKeypoint(x, y, fillColor, label, direction, strategy, keypoint = null) {\n    // ç»˜åˆ¶æ ‡æ³¨ç‚¹åœ†åœˆ\n    this.ctx.beginPath();\n    this.ctx.arc(x, y, strategy.radius, 0, 2 * Math.PI);\n    \n    // å¡«å……\n    this.ctx.fillStyle = fillColor;\n    this.ctx.fill();\n    \n    // è¾¹æ¡†\n    this.ctx.strokeStyle = this.options.keypointBorderColor;\n    this.ctx.lineWidth = strategy.borderWidth;\n    this.ctx.stroke();\n    \n    // æ ¹æ®æ˜¾ç¤ºç­–ç•¥ç»˜åˆ¶æ ‡ç­¾\n    if (strategy.showInternalLabel) {\n      // åœ¨æ ‡æ³¨ç‚¹å†…éƒ¨æ˜¾ç¤ºåºå·\n      this.ctx.fillStyle = this.options.keypointBorderColor;\n      this.ctx.font = `bold ${strategy.fontSize}px Inter, sans-serif`;\n      this.ctx.textAlign = 'center';\n      this.ctx.textBaseline = 'middle';\n      this.ctx.fillText(label.toString(), x, y);\n      \n      // ä¸å†åœ¨æ ‡æ³¨ç‚¹ä¸Šæ–¹æ˜¾ç¤ºæ–¹å‘ç¬¦å·ï¼Œæ”¹ä¸ºä½¿ç”¨è™šçº¿ç®­å¤´\n      \n    } else if (strategy.showExternalLabel) {\n      // åœ¨æ ‡æ³¨ç‚¹å¤–éƒ¨æ˜¾ç¤ºæ ‡ç­¾\n      this.createExternalLabel(x, y, label, direction, fillColor, strategy);\n      \n    } else if (strategy.showMinimalMode) {\n      // æå°æ¨¡å¼ï¼šåªæ˜¾ç¤ºæ ‡æ³¨ç‚¹ï¼Œæ‚¬åœæ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯\n      if (keypoint && this.hoveredKeypoint === keypoint) {\n        this.createTooltip(x, y, label, direction, keypoint);\n      }\n    }\n  }\n\n  /**\n   * æ¸²æŸ“æ‹–æ‹½æŒ‡ç¤ºå™¨\n   */\n  renderDragIndicator() {\n    if (!this.state.dragStartPoint || !this.state.currentDragPoint) return;\n    \n    const startX = this.state.dragStartPoint.x;\n    const startY = this.state.dragStartPoint.y;\n    const currentX = this.state.currentDragPoint.x;\n    const currentY = this.state.currentDragPoint.y;\n    \n    // è®¡ç®—æ‹–æ‹½è·ç¦»å’Œæ–¹å‘\n    const deltaX = currentX - startX;\n    const distance = Math.sqrt(deltaX * deltaX + (currentY - startY) * (currentY - startY));\n    \n    if (distance >= this.options.directionThreshold) {\n      // ç»˜åˆ¶æ‹–æ‹½çº¿æ¡\n      this.ctx.strokeStyle = deltaX < 0 ? this.options.keypointLeftColor : this.options.keypointRightColor;\n      this.ctx.lineWidth = 3;\n      this.ctx.setLineDash([5, 5]);\n      \n      this.ctx.beginPath();\n      this.ctx.moveTo(startX, startY);\n      this.ctx.lineTo(currentX, currentY);\n      this.ctx.stroke();\n      \n      // é‡ç½®çº¿æ¡æ ·å¼\n      this.ctx.setLineDash([]);\n      \n      // ç»˜åˆ¶æ–¹å‘æ–‡å­—\n      const midX = (startX + currentX) / 2;\n      const midY = (startY + currentY) / 2 - 20;\n      \n      this.ctx.fillStyle = deltaX < 0 ? this.options.keypointLeftColor : this.options.keypointRightColor;\n      this.ctx.font = 'bold 14px Inter, sans-serif';\n      this.ctx.textAlign = 'center';\n      this.ctx.fillText(deltaX < 0 ? 'â† Left' : 'Right â†’', midX, midY);\n    }\n  }\n\n  /**\n   * å›¾åƒåæ ‡è½¬å±å¹•åæ ‡\n   */\n  imageToScreen(imageX, imageY) {\n    return {\n      x: imageX * this.state.scale + this.state.translateX,\n      y: imageY * this.state.scale + this.state.translateY\n    };\n  }\n\n  /**\n   * å±å¹•åæ ‡è½¬å›¾åƒåæ ‡\n   */\n  screenToImage(screenX, screenY) {\n    return {\n      x: (screenX - this.state.translateX) / this.state.scale,\n      y: (screenY - this.state.translateY) / this.state.scale\n    };\n  }\n\n  /**\n   * è·å–é¼ æ ‡ç›¸å¯¹Canvasçš„ä½ç½®\n   */\n  getMousePos(event) {\n    const rect = this.canvas.getBoundingClientRect();\n    return {\n      x: event.clientX - rect.left,\n      y: event.clientY - rect.top\n    };\n  }\n\n  /**\n   * ğŸ”§ NEW: Calculate the visible image bounds in screen coordinates\n   */\n  getVisibleImageBounds() {\n    if (!this.imageElement || !this.imageLoaded) {\n      return null;\n    }\n\n    // Image dimensions in screen space\n    const imageWidth = this.imageElement.width * this.state.scale;\n    const imageHeight = this.imageElement.height * this.state.scale;\n    \n    // Image position in screen space (top-left corner)\n    const imageLeft = this.state.translateX;\n    const imageTop = this.state.translateY;\n    \n    // Calculate visible bounds (intersection with canvas)\n    const visibleBounds = {\n      left: Math.max(0, imageLeft),\n      top: Math.max(0, imageTop),\n      right: Math.min(this.canvas.width, imageLeft + imageWidth),\n      bottom: Math.min(this.canvas.height, imageTop + imageHeight),\n      // Also store the full image bounds for reference\n      imageLeft,\n      imageTop,\n      imageRight: imageLeft + imageWidth,\n      imageBottom: imageTop + imageHeight\n    };\n    \n    // ğŸ”§ DEBUG: Log bounds occasionally for troubleshooting\n    if (Math.random() < 0.001) { // 0.1% chance to log\n      console.log('[AnnotationTool] Image bounds debug:', {\n        imageSize: { width: this.imageElement.width, height: this.imageElement.height },\n        canvasSize: { width: this.canvas.width, height: this.canvas.height },\n        scale: this.state.scale,\n        translate: { x: this.state.translateX, y: this.state.translateY },\n        visibleBounds,\n        imageLoaded: this.imageLoaded\n      });\n    }\n    \n    return visibleBounds;\n  }\n\n  /**\n   * ğŸ”§ NEW: Check if a screen point is within the visible image area\n   */\n  isPointInVisibleImage(screenX, screenY) {\n    const bounds = this.getVisibleImageBounds();\n    if (!bounds) {\n      return false;\n    }\n    \n    // Check if point is within the visible image area (intersection of image and canvas)\n    return screenX >= bounds.left && \n           screenX <= bounds.right && \n           screenY >= bounds.top && \n           screenY <= bounds.bottom;\n  }\n\n  /**\n   * ğŸ”§ NEW: Check if image coordinates are valid and within image boundaries\n   */\n  isImageCoordinateValid(imageX, imageY) {\n    if (!this.imageElement || !this.imageLoaded) {\n      return false;\n    }\n    \n    return imageX >= 0 && \n           imageX <= this.imageElement.width && \n           imageY >= 0 && \n           imageY <= this.imageElement.height;\n  }\n\n  /**\n   * ğŸ”§ NEW: Comprehensive bounds checking for annotation creation\n   */\n  canCreateAnnotationAt(screenX, screenY) {\n    // Check if image is loaded\n    if (!this.imageElement || !this.imageLoaded) {\n      console.warn('[AnnotationTool] Cannot create annotation: no image loaded');\n      return false;\n    }\n\n    // Check if point is within visible image area\n    if (!this.isPointInVisibleImage(screenX, screenY)) {\n      console.warn('[AnnotationTool] Cannot create annotation: position is outside visible image area');\n      return false;\n    }\n\n    // Double-check with image coordinates\n    const imagePos = this.screenToImage(screenX, screenY);\n    if (!this.isImageCoordinateValid(imagePos.x, imagePos.y)) {\n      console.warn('[AnnotationTool] Cannot create annotation: position is outside image boundaries');\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * ğŸ”§ NEW: Silent bounds checking for cursor state (no console warnings)\n   */\n  canAnnotateAtSilent(screenX, screenY) {\n    // Check if image is loaded\n    if (!this.imageElement || !this.imageLoaded) {\n      return false;\n    }\n\n    // Check if point is within visible image area\n    if (!this.isPointInVisibleImage(screenX, screenY)) {\n      return false;\n    }\n\n    // Double-check with image coordinates\n    const imagePos = this.screenToImage(screenX, screenY);\n    if (!this.isImageCoordinateValid(imagePos.x, imagePos.y)) {\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * ğŸ”§ DEBUG: Manual bounds checking for troubleshooting\n   */\n  debugBoundsAt(screenX, screenY) {\n    console.log('[AnnotationTool] Debug bounds check at:', { screenX, screenY });\n    \n    if (!this.imageElement || !this.imageLoaded) {\n      console.log('âŒ Image not loaded');\n      return false;\n    }\n    \n    const bounds = this.getVisibleImageBounds();\n    console.log('ğŸ“ Visible bounds:', bounds);\n    \n    const inVisibleArea = this.isPointInVisibleImage(screenX, screenY);\n    console.log('ğŸ¯ In visible area:', inVisibleArea);\n    \n    const imagePos = this.screenToImage(screenX, screenY);\n    const validCoords = this.isImageCoordinateValid(imagePos.x, imagePos.y);\n    console.log('ğŸ“ Image coords:', imagePos, 'Valid:', validCoords);\n    \n    const finalResult = this.canAnnotateAtSilent(screenX, screenY);\n    console.log('âœ… Final result:', finalResult);\n    \n    return finalResult;\n  }\n\n  /**\n   * å¤„ç†é¼ æ ‡æŒ‰ä¸‹\n   */\n  async handleMouseDown(event) {\n    console.log('[è°ƒè¯•] handleMouseDown è¢«è°ƒç”¨', {\n      button: event.button,\n      timestamp: Date.now(),\n      target: event.target.tagName,\n      isTrusted: event.isTrusted,\n      type: event.type,\n      eventPhase: event.eventPhase,\n      bubbles: event.bubbles,\n      cancelable: event.cancelable,\n      stackTrace: new Error().stack\n    });\n\n    const mousePos = this.getMousePos(event);\n\n    if (event.button === 0) { // å·¦é”®\n      if (event.shiftKey) {\n        // Shift + å·¦é”®ï¼šå¼€å§‹å¹³ç§»\n        this.state.isPanning = true;\n        this.state.lastPanPoint = mousePos;\n        this.canvas.style.cursor = 'grabbing';\n      } else if (event.metaKey || event.ctrlKey) {\n        // Cmd/Ctrl + å·¦é”®ï¼šæ— åºå·æ ‡æ³¨æ¨¡å¼\n        this.state.isUnorderedMode = true;\n        console.log('[è°ƒè¯•] è¿›å…¥æ— åºå·æ ‡æ³¨æ¨¡å¼');\n        // ç»§ç»­æ‰§è¡Œæ ‡æ³¨é€»è¾‘ï¼ˆä¸è¦returnï¼Œè®©ä»£ç ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼‰\n      }\n      \n      // æ ‡æ³¨å¤„ç†é€»è¾‘ï¼ˆåŒ…æ‹¬æ™®é€šæ ‡æ³¨å’Œæ— åºå·æ ‡æ³¨ï¼‰\n      if (!this.state.isPanning) {\n        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è‡ªå®šä¹‰æ ‡æ³¨\n        const clickedCustomAnnotation = this.getCustomAnnotationAt(mousePos);\n        \n        if (clickedCustomAnnotation) {\n          // è‡ªå®šä¹‰æ ‡æ³¨ï¼šåŒºåˆ†ç‚¹ä¸åŒºåŸŸ\n          const isRegion = !!(clickedCustomAnnotation.width && clickedCustomAnnotation.height);\n          this.handleCustomAnnotationClick(clickedCustomAnnotation, mousePos);\n          if (isRegion) {\n            // åˆ¤æ–­æ˜¯å¦ç‚¹åœ¨ resize æ‰‹æŸ„ä¸Š\n            let handle = this.customAnnotationRenderer?.getRegionHandleAt(mousePos, clickedCustomAnnotation);\n            // å¦‚æœCustomAnnotationRendereræ²¡æœ‰æ£€æµ‹åˆ°handleï¼Œç”¨æœ¬åœ°æ–¹æ³•å†æ¬¡æ£€æµ‹\n            if (!handle) {\n              handle = this.getRegionHandleAt(mousePos, clickedCustomAnnotation);\n            }\n            \n            if (handle) {\n              this.startCustomAnnotationDrag(clickedCustomAnnotation, mousePos, handle);\n            } else {\n              // æ²¡æœ‰å‘½ä¸­handleï¼Œå¯åŠ¨ç§»åŠ¨æ‹–æ‹½ï¼šåˆ‡æ¢ç±»å‹å¹¶è®¾ç½®ä¸ºé€‰ä¸­\n              if (clickedCustomAnnotation.annotationType === 'custom' && clickedCustomAnnotation.customTypeId && this.customAnnotationManager) {\n                try { this.customAnnotationManager.setCustomAnnotationMode(clickedCustomAnnotation.customTypeId); } catch (e) {}\n              }\n              // åŒæ­¥ä¸¤ä¸ªé€‰ä¸­çŠ¶æ€ï¼šä¸»å·¥å…·ç±»å’Œæ¸²æŸ“å™¨\n              this.state.selectedKeypoint = clickedCustomAnnotation;\n              this.state.isDirectionSelectionMode = false;\n              this.customAnnotationRenderer?.setSelectedAnnotation(clickedCustomAnnotation);\n              console.log('[è°ƒè¯•] Regionå·²è®¾ä¸ºé€‰ä¸­:', clickedCustomAnnotation.id, 'order:', clickedCustomAnnotation.order);\n              \n              // å¯åŠ¨æ‹–æ‹½ï¼ˆç§»åŠ¨æ¨¡å¼ï¼Œhandle = nullï¼‰\n              this.startCustomAnnotationDrag(clickedCustomAnnotation, mousePos, null);\n              this.render();\n            }\n            return;\n          }\n          // ç‚¹ç±»å‹ï¼šä¸åœ¨è¿™é‡Œå¯åŠ¨æ‹–æ‹½ï¼Œäº¤ç”±ä¸‹æ–¹ keypoint é€»è¾‘å¤„ç†ï¼ˆæ”¯æŒç‚¹å‡»è¿›å…¥æ–¹å‘é€‰æ‹©/æˆ–æ‹–æ‹½ï¼‰\n        }\n        \n        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ ‡æ³¨ç‚¹\n        const clickedKeypoint = this.getKeypointAt(mousePos);\n        \n        if (clickedKeypoint) {\n          // è‹¥ç‚¹å‡»çš„æ˜¯è‡ªå®šä¹‰ç‚¹ç±»å‹ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹åº”ç±»å‹\n          if (clickedKeypoint.annotationType === 'custom' && clickedKeypoint.customTypeId && this.customAnnotationManager && !this.state.isSelectingParent && !this.state.isCustomRegionDragging && !this.state.isDirectionSelectionMode) {\n            try { this.customAnnotationManager.setCustomAnnotationMode(clickedKeypoint.customTypeId); } catch (e) { /* noop */ }\n          }\n          // è‹¥å¤„äºçˆ¶èŠ‚ç‚¹é€‰æ‹©æ¨¡å¼å¹¶ç‚¹å‡»äº†çˆ¶ç±»å‹æ ‡æ³¨ï¼Œåˆ™ç»‘å®šå¹¶è·¨æ—¶åºåŒæ­¥\n          if (this.state.isSelectingParent && this.state.parentSelectionForType) {\n            try {\n              const childTypeId = this.state.parentSelectionForType;\n              const parentTypeId = clickedKeypoint.customTypeId;\n              const childType = this.getCustomType(childTypeId);\n              \n              console.log('[è°ƒè¯•] çˆ¶èŠ‚ç‚¹é€‰æ‹© - å­ç±»å‹ID:', childTypeId, 'çˆ¶ç±»å‹ID:', parentTypeId);\n              console.log('[è°ƒè¯•] å­ç±»å‹é…ç½®:', childType?.metadata);\n              \n              // æ ¡éªŒï¼šä»…å…è®¸é€‰æ‹©é…ç½®äº† associateTypeId çš„å­ç±»å‹ï¼Œä¸”çˆ¶ç±»å‹åŒ¹é…\n              if (!childType || childType.metadata?.associateTypeId !== parentTypeId) {\n                const expectedParentType = childType?.metadata?.associateTypeId;\n                const message = `é€‰æ‹©çš„çˆ¶ç±»å‹ä¸åŒ¹é…ã€‚æœŸæœ›: ${this.getCustomType(expectedParentType)?.name || expectedParentType}ï¼Œå®é™…: ${this.getCustomType(parentTypeId)?.name || parentTypeId}`;\n                \n                if (window.PlantAnnotationTool?.showError) {\n                  window.PlantAnnotationTool.showError('çˆ¶ç±»å‹ä¸åŒ¹é…', message);\n                } else {\n                  console.log('[è°ƒè¯•]', message);\n                }\n              } else {\n                // ç»‘å®šï¼šå­æ ‡æ³¨order â†’ çˆ¶æ ‡æ³¨order\n                const selectedChild = this.state.selectedKeypoint;\n                if (selectedChild) {\n                  // å…ˆç«‹å³æ›´æ–°å½“å‰å›¾ç‰‡çš„keypointsæ•°ç»„ï¼Œç¡®ä¿å³æ—¶æ˜¾ç¤º\n                  selectedChild.parentAnnotationType = parentTypeId;\n                  selectedChild.parentAnnotationId = clickedKeypoint.order;\n                  console.log('[è°ƒè¯•] ç«‹å³æ›´æ–°å½“å‰å›¾ç‰‡çš„çˆ¶å­å…³è”:', selectedChild.id, 'â†’', clickedKeypoint.id);\n                  \n                  // ç„¶åè·¨å›¾ç‰‡åŒæ­¥\n                  await this.bindParentForOrderAcrossImages(childTypeId, selectedChild.order, parentTypeId, clickedKeypoint.order);\n                  const message = `å·²å°† ${childType.name} #${selectedChild.order} å…³è”åˆ° ${this.getCustomType(parentTypeId)?.name} #${clickedKeypoint.order}ï¼Œå¹¶åŒæ­¥åˆ°æ‰€æœ‰å›¾ç‰‡`;\n                  \n                  if (window.PlantAnnotationTool?.showSuccess) {\n                    window.PlantAnnotationTool.showSuccess('å…³è”æˆåŠŸ', message);\n                  } else {\n                    console.log('[è°ƒè¯•] å…³è”æˆåŠŸ:', message);\n                  }\n                  \n                  // ç«‹å³é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºè™šçº¿è¿æ¥\n                  this.render();\n                  \n                  // å…³è”æˆåŠŸåæ¸…ç©ºé€‰ä¸­çŠ¶æ€\n                  this.clearAllSelections();\n                }\n              }\n            } catch (e) {\n              console.error('ç»‘å®šçˆ¶èŠ‚ç‚¹å¤±è´¥:', e);\n              if (window.PlantAnnotationTool?.showError) {\n                window.PlantAnnotationTool.showError('ç»‘å®šå¤±è´¥', e.message || 'æœªçŸ¥é”™è¯¯');\n              } else {\n                console.log('[è°ƒè¯•] ç»‘å®šå¤±è´¥:', e.message || 'æœªçŸ¥é”™è¯¯');\n              }\n            } finally {\n              this.disableParentSelectionMode();\n            }\n            return;\n          }\n          console.log('[è°ƒè¯•] ç‚¹å‡»äº†æ ‡æ³¨ç‚¹', {\n            clickedKeypoint: clickedKeypoint.order,\n            isDirectionSelectionMode: this.state.isDirectionSelectionMode,\n            selectedKeypoint: this.state.selectedKeypoint?.order,\n            isSameKeypoint: this.state.selectedKeypoint === clickedKeypoint\n          });\n\n          // ç‚¹å‡»å·²é€‰ä¸­çš„ç‚¹ä¸å†ç«‹å³è®¾ç½®æ–¹å‘ï¼›åªä¿æŒé€‰ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ç‚¹å‡»ç©ºç™½åŒºåŸŸå†è®¾ç½®æ–¹å‘\n          if (this.state.isDirectionSelectionMode && this.state.selectedKeypoint === clickedKeypoint) {\n            // ä¸åšæ–¹å‘è®¾ç½®ï¼Œç»§ç»­åç»­ç‚¹å‡»/æ‹–æ‹½åˆ¤å®š\n          }\n\n          // å¦‚æœä¸æ˜¯åœ¨å¤„ç†æ–¹å‘é€‰æ‹©ï¼šåŒºåˆ†ç‚¹å‡»ä¸æ‹–æ‹½\n          this.draggedKeypoint = clickedKeypoint;\n          this.state.dragStartPoint = mousePos;\n          this.state.mouseDownTime = Date.now();\n          this.state.wasDraggedDuringSession = false;\n          this.canvas.style.cursor = 'grabbing';\n\n          // ä¸ç«‹å³è¿›å…¥æ–¹å‘è®¾ç½®ï¼›ç”± mouseup åˆ¤æ–­æ˜¯ç‚¹å‡»ï¼ˆåªé€‰ä¸­ï¼‰è¿˜æ˜¯æ‹–æ‹½ï¼ˆç§»åŠ¨ï¼‰\n        } else {\n          // å¦‚æœå¤„äºæ–¹å‘é€‰æ‹©æ¨¡å¼ï¼Œå¤„ç†æ–¹å‘é€‰æ‹©\n          if (this.state.isDirectionSelectionMode) {\n            // æ— è®ºæ˜¯è‡ªåŠ¨æ¨¡å¼è¿˜æ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼Œç‚¹å‡»ç©ºç™½åŒºåŸŸéƒ½åº”è¯¥è®¾ç½®æ–¹å‘\n            console.log('[è°ƒè¯•] æ–¹å‘é€‰æ‹©æ¨¡å¼ä¸‹ç‚¹å‡»ï¼Œå¤„ç†æ–¹å‘é€‰æ‹©');\n            try {\n              await this.handleDirectionSelection(mousePos);\n            } catch (error) {\n              console.error('[æ–¹å‘é€‰æ‹©] å¤„ç†æ–¹å‘é€‰æ‹©å¤±è´¥:', error);\n            }\n            return;\n          }\n\n          // ğŸ”§ FIX: Check if image is loaded before allowing annotation creation\n          if (!this.imageElement || !this.imageLoaded) {\n            console.warn('[AnnotationTool] Cannot create annotation: no image loaded');\n            if (window.PlantAnnotationTool?.showError) {\n              window.PlantAnnotationTool.showError('No Image Loaded', 'Please select and load an image before creating annotations.');\n            }\n            return;\n          }\n\n          // æ£€æŸ¥æ˜¯å¦å¤„äºè‡ªå®šä¹‰æ ‡æ³¨æ¨¡å¼\n          if (this.customAnnotationManager && this.customAnnotationManager.isInCustomMode()) {\n            const customType = this.customAnnotationManager.getCurrentCustomType();\n            if (!customType) {\n              console.warn('No custom type selected');\n              return;\n            }\n            if (customType.type === 'region') {\n              // åŒºåŸŸç±»å‹ï¼šèµ°è‡ªå®šä¹‰åŒºåŸŸæµç¨‹\n              this.handleCustomAnnotationMode(mousePos);\n              return;\n            }\n            if (customType.type === 'point') {\n              // ç‚¹ç±»å‹ï¼šå…è®¸æ‹–æ‹½è®¾ç½®æ–¹å‘æˆ–ç®€å•ç‚¹å‡»åè¿›å…¥æ–¹å‘é€‰æ‹©\n              this.state.blankAreaClickStart = mousePos;\n              this.state.mouseDownTime = Date.now();\n              this.state.wasDraggedDuringSession = false;\n              return;\n            }\n          }\n\n          // ğŸš« ç¦æ­¢åœ¨æœªé€‰æ‹© Annotation Type æ—¶åˆ›å»ºæ ‡æ³¨\n          console.warn('[AnnotationTool] Annotation disabled: please select an Annotation Type to start annotating.');\n          if (window.PlantAnnotationTool?.showError) {\n            window.PlantAnnotationTool.showError('Annotation Disabled', 'Please open Annotation Type Setting and select a type before annotating.');\n          }\n          return;\n        }\n      }\n    } else if (event.button === 2) { // å³é”®\n      if (this.state.isAutoDirectionMode) {\n        // å³é”®æš‚åœè‡ªåŠ¨åŒ–æ–¹å‘å‡çº§æ¨¡å¼\n        this.pauseAutoDirectionMode();\n      } else if (this.state.isDirectionSelectionMode) {\n        // å³é”®å–æ¶ˆæ–¹å‘é€‰æ‹©\n        this.cancelDirectionSelection(true); // å¼ºåˆ¶é€€å‡º\n      }\n    } else if (event.button === 1) { // ğŸ”§ NEW: ä¸­é”® - æ–¹å‘æ•°é‡é€‰æ‹©\n      this.handleMiddleMouseButton(mousePos);\n    }\n  }\n\n  /**\n   * å¤„ç†é¼ æ ‡ç§»åŠ¨\n   */\n  handleMouseMove(event) {\n    const mousePos = this.getMousePos(event);\n    \n    if (this.state.isPanning && this.state.lastPanPoint) {\n      // å¹³ç§»å›¾åƒ\n      const deltaX = mousePos.x - this.state.lastPanPoint.x;\n      const deltaY = mousePos.y - this.state.lastPanPoint.y;\n      \n      this.state.translateX += deltaX;\n      this.state.translateY += deltaY;\n      \n      this.state.lastPanPoint = mousePos;\n      this.render();\n      \n    } else if (this.draggedKeypoint) {\n      // æ‹–æ‹½æ ‡æ³¨ç‚¹\n      const imagePos = this.screenToImage(mousePos.x, mousePos.y);\n      \n      // ğŸ”§ FIX: Constrain dragged keypoint to stay within image boundaries\n      if (this.isImageCoordinateValid(imagePos.x, imagePos.y)) {\n        this.draggedKeypoint.x = imagePos.x;\n        this.draggedKeypoint.y = imagePos.y;\n        \n        // æ ‡è®°å·²ç»è¿›è¡Œäº†æ‹–æ‹½\n        this.state.wasDraggedDuringSession = true;\n        \n        this.render();\n        \n        // é€šçŸ¥é¢„è§ˆç®¡ç†å™¨æ˜¾ç¤ºè¢«æ‹–åŠ¨ç‚¹å¯¹åº”çš„é¢„è§ˆ\n        this.notifyDraggedKeypointPreview(this.draggedKeypoint);\n      }\n      // If the position is invalid, don't update the keypoint position (ignore the movement)\n      \n    } else if (this.customAnnotationDragState.isDragging) {\n      // æ‹–æ‹½è‡ªå®šä¹‰æ ‡æ³¨\n      this.updateCustomAnnotationDrag(mousePos);\n\n    } else if (this.state.blankAreaClickStart) {\n      // æ£€æŸ¥æ˜¯å¦å¼€å§‹äº†æ‹–æ‹½ï¼ˆä»ç©ºç™½åŒºåŸŸç‚¹å‡»å¼€å§‹ï¼‰\n      const distance = Math.sqrt(\n        Math.pow(mousePos.x - this.state.blankAreaClickStart.x, 2) +\n        Math.pow(mousePos.y - this.state.blankAreaClickStart.y, 2)\n      );\n\n      if (distance >= this.options.directionThreshold) {\n        // è·ç¦»è¶³å¤Ÿï¼Œæ ‡è®°ä¸ºæ‹–æ‹½çŠ¶æ€\n        this.state.wasDraggedDuringSession = true;\n\n        // è‡ªå®šä¹‰ç‚¹ç±»å‹ä¹Ÿæ”¯æŒæ–¹å‘æ‹–æ‹½\n        this.startDirectionAnnotation(this.state.blankAreaClickStart);\n        this.state.blankAreaClickStart = null; // æ¸…é™¤ç©ºç™½ç‚¹å‡»çŠ¶æ€\n        this.updateDirectionDragging(mousePos);\n      }\n\n    } else if (this.state.isDirectionDragging) {\n      // æ–¹å‘æ‹–æ‹½å¤„ç†\n      this.updateDirectionDragging(mousePos);\n\n    } else if (this.state.isCustomRegionDragging) {\n      // è‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½å¤„ç†\n      this.updateCustomRegionDrag(mousePos);\n\n    } else if (this.state.isDirectionSelectionMode) {\n      // æ–¹å‘é€‰æ‹©æ¨¡å¼ä¸‹çš„é¼ æ ‡ç§»åŠ¨\n      this.state.directionSelectionPoint = mousePos;\n      \n      // ğŸ”§ FIX: Proper cursor management for direction selection mode\n      let directionCursor = 'crosshair'; // Default for direction selection\n      \n      // Check if we're hovering over the selected keypoint for better UX\n      if (this.state.selectedKeypoint) {\n        const keypointScreen = this.imageToScreen(\n          this.state.selectedKeypoint.x,\n          this.state.selectedKeypoint.y\n        );\n        const distance = Math.sqrt(\n          Math.pow(mousePos.x - keypointScreen.x, 2) +\n          Math.pow(mousePos.y - keypointScreen.y, 2)\n        );\n        \n        // If hovering over the selected keypoint, show pointer cursor\n        if (distance <= (this.options.baseKeypointRadius * 2)) {\n          directionCursor = 'pointer';\n        }\n      }\n      \n      // Update cursor for direction selection mode\n      if (this.canvas.style.cursor !== directionCursor) {\n        this.canvas.style.cursor = directionCursor;\n      }\n      \n      this.render();\n      \n    } else {\n      // æ£€æŸ¥æ˜¯å¦æ‚¬åœåœ¨è‡ªå®šä¹‰æ ‡æ³¨ä¸Š\n      const hoveredCustomAnnotation = this.getCustomAnnotationAt(mousePos);\n      \n      if (hoveredCustomAnnotation) {\n        // æ‚¬åœåœ¨è‡ªå®šä¹‰æ ‡æ³¨ä¸Š\n        this.canvas.style.cursor = 'pointer';\n        \n        // æ›´æ–°æ‚¬åœçŠ¶æ€\n        if (this.customAnnotationRenderer) {\n          this.customAnnotationRenderer.setHoveredAnnotation(hoveredCustomAnnotation);\n        }\n        \n        this.render();\n        return;\n      } else {\n        // æ¸…é™¤æ‚¬åœçŠ¶æ€\n        if (this.customAnnotationRenderer) {\n          this.customAnnotationRenderer.setHoveredAnnotation(null);\n        }\n      }\n      \n      // æ£€æŸ¥æ‚¬åœçš„æ ‡æ³¨ç‚¹\n      const hoveredKeypoint = this.getKeypointAt(mousePos);\n      \n      // ğŸ”§ FIX: Always check cursor state for better responsiveness\n      let newCursor = 'crosshair'; // Default cursor\n      \n      // ğŸ”§ FIX: Special handling for auto direction mode\n      if (this.state.isAutoDirectionMode) {\n        // In auto direction mode, provide different cursor feedback\n        if (hoveredKeypoint) {\n          newCursor = 'pointer'; // Can click keypoints in auto mode\n        } else {\n          newCursor = 'crosshair'; // Allow normal interaction in auto mode\n        }\n      } else if (this.customAnnotationManager && this.customAnnotationManager.isInCustomMode()) {\n        // ğŸ”§ FIX: Custom annotation mode - maintain crosshair cursor for annotation purposes\n        if (hoveredKeypoint) {\n          newCursor = 'pointer'; // Can still interact with existing keypoints\n        } else {\n          // Check if mouse is within valid annotation area\n          const canAnnotate = this.canAnnotateAtSilent(mousePos.x, mousePos.y);\n          newCursor = canAnnotate ? 'crosshair' : 'not-allowed';\n        }\n      } else {\n        // Normal mode cursor logic\n        if (hoveredKeypoint) {\n          newCursor = 'pointer';\n        } else {\n          // Check if mouse is within valid annotation area\n          const canAnnotate = this.canAnnotateAtSilent(mousePos.x, mousePos.y);\n          newCursor = canAnnotate ? 'crosshair' : 'not-allowed';\n        }\n      }\n      \n      // Update cursor if it changed\n      if (this.canvas.style.cursor !== newCursor) {\n        this.canvas.style.cursor = newCursor;\n      }\n      \n      // Update hovered keypoint and render if it changed\n      if (hoveredKeypoint !== this.hoveredKeypoint) {\n        this.hoveredKeypoint = hoveredKeypoint;\n        this.render();\n      }\n    }\n  }\n\n  /**\n   * å¤„ç†é¼ æ ‡æŠ¬èµ·\n   */\n  handleMouseUp(event) {\n    const mousePos = this.getMousePos(event);\n    \n    if (this.state.isPanning) {\n      this.state.isPanning = false;\n      this.state.lastPanPoint = null;\n      this.canvas.style.cursor = 'crosshair';\n    }\n    \n    // æ£€æŸ¥æ˜¯å¦æ˜¯ç®€å•ç‚¹å‡»ï¼ˆæ²¡æœ‰æ‹–æ‹½ï¼‰\n    if (this.draggedKeypoint) {\n      // æ£€æŸ¥æ˜¯å¦æœ‰å®é™…ç§»åŠ¨\n      const startPos = this.state.dragStartPoint || mousePos;\n      const distance = Math.sqrt(\n        Math.pow(mousePos.x - startPos.x, 2) +\n        Math.pow(mousePos.y - startPos.y, 2)\n      );\n\n      // æ£€æŸ¥æ˜¯å¦åœ¨çŸ­æ—¶é—´å†…è¿›è¡Œäº†æ‹–æ‹½æ“ä½œ\n      const currentTime = Date.now();\n      const timeSinceMouseDown = currentTime - (this.state.mouseDownTime || currentTime);\n      const wasDragged = this.state.wasDraggedDuringSession || false;\n\n      // æ›´ä¸¥æ ¼çš„ç‚¹å‡»åˆ¤æ–­ï¼šè·ç¦»å°ä¸”æ—¶é—´çŸ­ä¸”æ²¡æœ‰æ‹–æ‹½è¿‡\n      if (distance < 8 && timeSinceMouseDown < 200 && !wasDragged) {\n        // è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿç‚¹å‡»ï¼Œä¸æ˜¯æ‹–æ‹½ï¼šä»…é€‰ä¸­keypointä½†è¿›å…¥æ–¹å‘é€‰æ‹©æ¨¡å¼\n        this.selectKeypointForDirection(this.draggedKeypoint);\n      } else {\n        // è¿™æ˜¯æ‹–æ‹½ï¼Œä¿å­˜çŠ¶æ€\n        this.saveState();\n        this.autoSaveCurrentImage();\n        \n        // ğŸ”„ NEW: å®æ—¶åŒæ­¥ - æ ‡æ³¨ç‚¹ç§»åŠ¨\n        this.triggerRealTimeSync('MOVE_KEYPOINT', this.draggedKeypoint, this.state.dragStartPoint);\n      }\n\n      // é‡ç½®æ‹–æ‹½çŠ¶æ€\n      this.draggedKeypoint = null;\n      this.state.wasDraggedDuringSession = false;\n      this.state.mouseDownTime = null;\n      this.canvas.style.cursor = 'crosshair';\n      this.restoreNormalPreview();\n    }\n    \n    // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºç™½åŒºåŸŸçš„ç®€å•ç‚¹å‡»ï¼ˆè¿›å…¥æ–¹å‘é€‰æ‹©æˆ–åˆ›å»ºç‚¹ï¼‰\n    if (this.state.blankAreaClickStart) {\n      const distance = Math.sqrt(\n        Math.pow(mousePos.x - this.state.blankAreaClickStart.x, 2) +\n        Math.pow(mousePos.y - this.state.blankAreaClickStart.y, 2)\n      );\n\n      const currentTime = Date.now();\n      const timeSinceMouseDown = currentTime - (this.state.mouseDownTime || currentTime);\n      const wasDragged = this.state.wasDraggedDuringSession || false;\n\n      // åˆ¤æ–­æ˜¯å¦æ˜¯ç®€å•ç‚¹å‡»ï¼šè·ç¦»å°ã€æ—¶é—´çŸ­ã€æ²¡æœ‰æ‹–æ‹½\n      if (distance < 8 && timeSinceMouseDown < 300 && !wasDragged) {\n        const isCustomPointMode = this.customAnnotationManager?.isInCustomMode() && this.customAnnotationManager.getCurrentCustomType()?.type === 'point';\n        if (isCustomPointMode) {\n          // è‡ªå®šä¹‰ç‚¹ç±»å‹ï¼šåˆ›å»ºæ— æ–¹å‘ç‚¹ï¼Œä¸è‡ªåŠ¨è¿›å…¥æ–¹å‘é€‰æ‹©\n          const imagePos = this.screenToImage(this.state.blankAreaClickStart.x, this.state.blankAreaClickStart.y);\n          const currentType = this.customAnnotationManager.getCurrentCustomType();\n          // åˆ›å»ºæ—¶ä¸å†™å…¥ direction å­—æ®µ\n          const kp = this.addKeypointWithDirection(imagePos.x, imagePos.y, undefined, currentType.id);\n          if (kp) {\n            // ç¡®ä¿ç§»é™¤å¯èƒ½è¢«é»˜è®¤èµ‹å€¼çš„ direction\n            delete kp.direction;\n            delete kp.directionType;\n            this.render();\n            this.autoSaveCurrentImage();\n          }\n        } else {\n          // æœªé€‰æ‹©è‡ªå®šä¹‰ç‚¹ç±»å‹ï¼šä¿ç•™å…¼å®¹è·¯å¾„ï¼ˆæ­¤å‰åœ¨mouseDownå·²é˜»æ­¢æœªé€‰ç±»å‹ï¼‰\n          this.createNoDirectionKeypoint(this.state.blankAreaClickStart);\n        }\n      }\n\n      // æ¸…é™¤ç©ºç™½ç‚¹å‡»çŠ¶æ€\n      this.state.blankAreaClickStart = null;\n      this.state.mouseDownTime = null;\n      this.state.wasDraggedDuringSession = false;\n    }\n\n    \n    // å®Œæˆè‡ªå®šä¹‰æ ‡æ³¨æ‹–æ‹½\n    if (this.customAnnotationDragState.isDragging) {\n      this.finishCustomAnnotationDrag();\n    }\n    \n    if (this.state.isDirectionDragging) {\n      // å®Œæˆæ–¹å‘æ ‡æ³¨\n      this.finishDirectionAnnotation();\n    }\n    \n    if (this.state.isCustomRegionDragging) {\n      // å®Œæˆè‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½\n      this.finishCustomRegionDrag();\n    }\n    \n    // ğŸ”§ NEW: æ¸…é™¤æ— åºå·æ¨¡å¼ï¼ˆæ ‡æ³¨å®Œæˆåè‡ªåŠ¨å…³é—­ï¼‰\n    if (this.state.isUnorderedMode) {\n      this.state.isUnorderedMode = false;\n      console.log('[è°ƒè¯•] é€€å‡ºæ— åºå·æ ‡æ³¨æ¨¡å¼');\n    }\n  }\n\n  /**\n   * åˆ›å»ºæ— æ–¹å‘æ ‡æ³¨ç‚¹\n   */\n  createNoDirectionKeypoint(mousePos) {\n    // ğŸš« ä¸å…è®¸åœ¨æœªé€‰æ‹© Annotation Type çš„æƒ…å†µä¸‹åˆ›å»ºâ€œé»˜è®¤/regularâ€å…³é”®ç‚¹\n    if (!this.customAnnotationManager || !this.customAnnotationManager.isInCustomMode()) {\n      if (window.PlantAnnotationTool?.showError) {\n        window.PlantAnnotationTool.showError('Annotation Disabled', 'Please select an Annotation Type before creating keypoints.');\n      }\n      return;\n    }\n\n    // ğŸ”§ FIX: Comprehensive bounds checking for annotation creation\n    if (!this.canCreateAnnotationAt(mousePos.x, mousePos.y)) {\n      if (window.PlantAnnotationTool?.showError) {\n        window.PlantAnnotationTool.showError('Invalid Position', 'Annotations can only be placed within the image area. Please click directly on the image.');\n      }\n      return;\n    }\n\n    const imagePos = this.screenToImage(mousePos.x, mousePos.y);\n\n    // åœ¨â€œç±»å‹æ¨¡å¼â€ä¸‹ï¼Œç©ºç™½ç‚¹å‡»åº”è¯¥åˆ›å»ºå½“å‰é€‰ä¸­ç±»å‹çš„æ ‡æ³¨\n    const currentType = this.customAnnotationManager.getCurrentCustomType();\n    if (!currentType) {\n      if (window.PlantAnnotationTool?.showError) {\n        window.PlantAnnotationTool.showError('No Type Selected', 'Please select an Annotation Type before annotating.');\n      }\n      return;\n    }\n\n    if (currentType.type === 'region') {\n      // å¦‚æœæ˜¯çŸ©å½¢ç±»å‹ï¼Œå¯åŠ¨ç»Ÿä¸€çš„çŸ©å½¢æ‹–æ‹½æµç¨‹\n      this.startUnifiedCustomRegionDrag(mousePos, currentType.id);\n      return;\n    }\n\n    // Keypoint ç±»å‹ï¼šä½¿ç”¨ç±»å‹é»˜è®¤è§’åº¦\n    const direction = typeof currentType.metadata?.defaultAngle === 'number' ? currentType.metadata.defaultAngle : null;\n    const keypoint = this.addCustomPointAnnotation(imagePos.x, imagePos.y, currentType.id);\n    // addCustomPointAnnotation å†…éƒ¨å·²å¤„ç† defaultAngle åº”ç”¨ä¸ä¿å­˜/æ¸²æŸ“/åŒæ­¥\n    return keypoint;\n  }\n\n  /**\n   * é€‰æ‹©å…³é”®ç‚¹\n   */\n  selectKeypoint(keypoint) {\n    console.log('[è°ƒè¯•] selectKeypoint è¢«è°ƒç”¨', {\n      keypoint: keypoint.order,\n      currentDirection: keypoint.direction,\n      directionType: keypoint.directionType\n    });\n\n    // ğŸ”§ BUG FIX: ç¡®ä¿æ ‡æ³¨ç‚¹å…·æœ‰å¤šæ–¹å‘æ”¯æŒ\n    this.ensureMultiDirectionSupport(keypoint);\n\n    this.state.selectedKeypoint = keypoint;\n    this.state.isDirectionSelectionMode = true;\n    this.state.directionSelectionPoint = null;\n\n    console.log('[è°ƒè¯•] æ–¹å‘é€‰æ‹©æ¨¡å¼çŠ¶æ€', {\n      isDirectionSelectionMode: this.state.isDirectionSelectionMode,\n      selectedKeypoint: this.state.selectedKeypoint?.order,\n      isAutoDirectionMode: this.state.isAutoDirectionMode\n    });\n\n    // ğŸ”§ FIX: Set appropriate cursor for direction selection mode\n    this.canvas.style.cursor = 'crosshair';\n\n    // é€šçŸ¥é¢„è§ˆç®¡ç†å™¨æ˜¾ç¤ºè¿™ä¸ªç‚¹çš„é¢„è§ˆ\n    this.notifySelectedKeypointPreview(keypoint);\n\n    this.render();\n    console.log(`Selected keypoint #${keypoint.order} for direction selection`);\n  }\n  \n  /**\n   * ğŸ”§ NEW: é€‰ä¸­keypointå¹¶è¿›å…¥æ–¹å‘é€‰æ‹©æ¨¡å¼ï¼ˆä»…åœ¨ç‚¹å‡»æ—¶è°ƒç”¨ï¼Œæ‹–æ‹½æ—¶ä¸è°ƒç”¨ï¼‰\n   */\n  selectKeypointForDirection(keypoint) {\n    console.log('[è°ƒè¯•] selectKeypointForDirection è¢«è°ƒç”¨ - ç‚¹å‡»è€Œéæ‹–æ‹½', {\n      keypoint: keypoint.order,\n      currentDirection: keypoint.direction,\n      isDirectional: this.getIsDirectionalForKeypoint(keypoint)\n    });\n\n    // ğŸ”§ BUG FIX: ç¡®ä¿æ ‡æ³¨ç‚¹å…·æœ‰å¤šæ–¹å‘æ”¯æŒ\n    this.ensureMultiDirectionSupport(keypoint);\n\n    this.state.selectedKeypoint = keypoint;\n    \n    // ğŸ”§ FIX: åªæœ‰å½“å‰æ ‡æ³¨ç±»å‹æ”¯æŒæ–¹å‘æ—¶æ‰è¿›å…¥æ–¹å‘é€‰æ‹©æ¨¡å¼\n    const isDirectional = this.getIsDirectionalForKeypoint(keypoint);\n    this.state.isDirectionSelectionMode = isDirectional;\n    this.state.directionSelectionPoint = null;\n\n    console.log('[è°ƒè¯•] selectKeypointForDirection çŠ¶æ€è®¾ç½®', {\n      isDirectionSelectionMode: this.state.isDirectionSelectionMode,\n      selectedKeypoint: this.state.selectedKeypoint?.order,\n      isDirectional: isDirectional\n    });\n\n    // ğŸ”§ FIX: Set appropriate cursor\n    this.canvas.style.cursor = isDirectional ? 'crosshair' : 'default';\n\n    // é€šçŸ¥é¢„è§ˆç®¡ç†å™¨æ˜¾ç¤ºè¿™ä¸ªç‚¹çš„é¢„è§ˆ\n    this.notifySelectedKeypointPreview(keypoint);\n\n    this.render();\n    console.log(`Selected keypoint #${keypoint.order}`, isDirectional ? 'for direction selection' : 'without direction selection');\n  }\n\n  /**\n   * ğŸ”§ NEW: è·å–keypointæ˜¯å¦æ”¯æŒæ–¹å‘æ ‡æ³¨\n   */\n  getIsDirectionalForKeypoint(keypoint) {\n    if (!keypoint) return false;\n    \n    // å¦‚æœæ˜¯è‡ªå®šä¹‰æ ‡æ³¨ç±»å‹\n    if (keypoint.annotationType === 'custom' && keypoint.customTypeId) {\n      const customType = this.customAnnotationManager?.getCustomType(keypoint.customTypeId);\n      if (customType && customType.metadata) {\n        // ä¼˜å…ˆä½¿ç”¨æ˜ç¡®è®¾ç½®çš„isDirectionalå€¼ï¼Œé»˜è®¤ä¸ºtrueï¼ˆå‘åå…¼å®¹ï¼‰\n        return customType.metadata.isDirectional !== false;\n      }\n    }\n    \n    // å¦‚æœæ˜¯ä¼ ç»Ÿçš„regularç±»å‹ï¼Œé»˜è®¤æ”¯æŒæ–¹å‘\n    if (keypoint.annotationType === 'regular') {\n      return true;\n    }\n    \n    // é»˜è®¤ä¸æ”¯æŒæ–¹å‘\n    return false;\n  }\n\n  /**\n   * å¤„ç†å…³é”®ç‚¹ç‚¹å‡»\n   */\n  handleKeypointClick(keypoint) {\n    console.log('[è°ƒè¯•] handleKeypointClick è¢«è°ƒç”¨', {\n      keypoint: keypoint.order,\n      isAutoDirectionMode: this.state.isAutoDirectionMode,\n      isDirectionSelectionMode: this.state.isDirectionSelectionMode,\n      currentSelectedKeypoint: this.state.selectedKeypoint?.order\n    });\n\n    if (this.state.isAutoDirectionMode) {\n      // è‡ªåŠ¨åŒ–æ¨¡å¼ä¸‹ï¼Œé€‰æ‹©å½“å‰å…³é”®ç‚¹\n      this.selectKeypoint(keypoint);\n    } else {\n      // æ™®é€šæ¨¡å¼ä¸‹ï¼Œæ€»æ˜¯é€‰æ‹©å…³é”®ç‚¹è¿›å…¥æ–¹å‘é€‰æ‹©æ¨¡å¼\n      // æ— è®ºæ˜¯å¦å·²ç»å¤„äºæ–¹å‘é€‰æ‹©æ¨¡å¼\n      this.selectKeypoint(keypoint);\n    }\n  }\n\n  /**\n   * å¤„ç†æ–¹å‘é€‰æ‹©\n   */\n  async handleDirectionSelection(mousePos) {\n    console.log('[è°ƒè¯•] handleDirectionSelection è¢«è°ƒç”¨', {\n      selectedKeypoint: this.state.selectedKeypoint,\n      mousePos,\n      isAutoDirectionMode: this.state.isAutoDirectionMode\n    });\n\n    if (!this.state.selectedKeypoint) {\n      console.log('[è°ƒè¯•] æ²¡æœ‰é€‰ä¸­çš„æ ‡æ³¨ç‚¹ï¼Œé€€å‡ºæ–¹å‘é€‰æ‹©');\n      return;\n    }\n\n    const keypointScreen = this.imageToScreen(\n      this.state.selectedKeypoint.x,\n      this.state.selectedKeypoint.y\n    );\n\n    // è®¡ç®—æ–¹å‘è§’åº¦\n    const deltaX = mousePos.x - keypointScreen.x;\n    const deltaY = mousePos.y - keypointScreen.y;\n    const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;\n\n    // æ ‡å‡†åŒ–è§’åº¦åˆ° 0-360 åº¦\n    const normalizedAngle = (angle + 360) % 360;\n\n    // ğŸ”§ NEW: è®°å½•ç‚¹å‡»åæ ‡\n    const imagePos = this.screenToImage(mousePos.x, mousePos.y);\n    const clickData = {\n      x: imagePos.x,\n      y: imagePos.y,\n      screenX: mousePos.x,\n      screenY: mousePos.y,\n      timestamp: Date.now()\n    };\n\n    console.log('[è°ƒè¯•] è®¡ç®—çš„è§’åº¦ä¿¡æ¯', {\n      deltaX, deltaY, angle, normalizedAngle,\n      clickData,\n      keypointBefore: {...this.state.selectedKeypoint}\n    });\n\n    // ğŸ”§ NEW: æ”¯æŒå¤šæ–¹å‘è®¾ç½®\n    if (this.state.selectedKeypoint.maxDirections > 1) {\n      // å¤šæ–¹å‘æ¨¡å¼\n      const direction = { \n        angle: normalizedAngle, \n        type: 'angle',\n        clickPosition: clickData  // ğŸ”§ NEW: è®°å½•ç‚¹å‡»ä½ç½®\n      };\n      \n      if (this.addDirectionToKeypoint(this.state.selectedKeypoint, direction)) {\n        // ğŸ”§ FIX: Only increment counter after successful addition\n        this.state.directionsSet++;\n        \n        console.log(`[å¤šæ–¹å‘] è®¾ç½®æ–¹å‘ ${this.state.directionsSet}/${this.state.selectedKeypoint.maxDirections}: ${normalizedAngle.toFixed(1)}Â°`);\n        \n        // æ›´æ–°è¿›åº¦æ˜¾ç¤º\n        this.showMultiDirectionProgress();\n        \n        // ğŸ”„ NEW: å®æ—¶åŒæ­¥ - å¤šæ–¹å‘ç¼–è¾‘\n        this.triggerRealTimeSync('EDIT_DIRECTION', this.state.selectedKeypoint);\n        \n        // ğŸ”§ FIX: Check actual directions count, not counter\n        if (this.state.selectedKeypoint.directions.length >= this.state.selectedKeypoint.maxDirections) {\n          console.log('[å¤šæ–¹å‘] æ‰€æœ‰æ–¹å‘è®¾ç½®å®Œæˆ');\n          this.finishMultiDirectionSetting();\n        }\n      }\n    } else {\n      // å•æ–¹å‘æ¨¡å¼ï¼ˆåŸæœ‰é€»è¾‘ï¼‰\n      // æ›´æ–°å…³é”®ç‚¹æ–¹å‘\n      const oldDirection = this.state.selectedKeypoint.direction;\n      this.state.selectedKeypoint.direction = normalizedAngle;\n      this.state.selectedKeypoint.directionType = 'angle'; // æ ‡è®°ä¸ºè§’åº¦ç±»å‹\n      \n      // ğŸ”§ NEW: è®°å½•ç‚¹å‡»åæ ‡\n      this.state.selectedKeypoint.directionClick = clickData;\n      \n      // åŒæ—¶æ›´æ–°directionsæ•°ç»„ä»¥ä¿æŒä¸€è‡´æ€§\n      this.state.selectedKeypoint.directions = [{ \n        angle: normalizedAngle, \n        type: 'angle',\n        clickPosition: clickData  // ğŸ”§ NEW: è®°å½•ç‚¹å‡»ä½ç½®\n      }];\n\n      console.log('[è°ƒè¯•] æ–¹å‘æ›´æ–°', {\n        keypointId: this.state.selectedKeypoint.id,\n        order: this.state.selectedKeypoint.order,\n        oldDirection,\n        newDirection: normalizedAngle,\n        clickData,\n        keypointAfter: {...this.state.selectedKeypoint}\n      });\n      \n      // ğŸ”„ NEW: å®æ—¶åŒæ­¥ - å•æ–¹å‘ç¼–è¾‘\n      this.triggerRealTimeSync('EDIT_DIRECTION', this.state.selectedKeypoint);\n      \n      // ğŸ”§ ENHANCED: Handle both longitudinal and cross-sectional auto direction modes\n      if (this.state.isAutoDirectionMode) {\n        console.log('[è°ƒè¯•] è‡ªåŠ¨æ¨¡å¼ï¼Œå¤„ç†ä¸‹ä¸€æ­¥:', this.autoDirectionMode);\n        \n        if (this.autoDirectionMode === 'cross-sectional') {\n          // Cross-sectional mode: process current point and advance\n          await this.handleCrossSectionalDirectionSet(normalizedAngle);\n        } else {\n          // Longitudinal mode: proceed to next keypoint in current image\n          this.selectNextAutoDirectionKeypoint();\n        }\n      } else {\n        console.log('[è°ƒè¯•] éè‡ªåŠ¨æ¨¡å¼ï¼Œå–æ¶ˆæ–¹å‘é€‰æ‹©');\n        this.cancelDirectionSelection(true); // å¼ºåˆ¶é€€å‡º\n\n        // ğŸ”§ FIX: Only move to expected position if auto-move is enabled AND we just created a new point\n        // Don't auto-move when just setting direction on existing points\n        if (this.state.autoMoveToExpectedPosition && this.justCreatedNewPoint) {\n          console.log('[è‡ªåŠ¨ç§»åŠ¨] æ£€æµ‹åˆ°æ–°å»ºæ ‡æ³¨ç‚¹ï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªé¢„æœŸä½ç½®');\n          this.moveToNextExpectedPosition();\n          this.justCreatedNewPoint = false; // Reset flag\n        } else {\n          console.log('[è‡ªåŠ¨ç§»åŠ¨] è·³è¿‡ç§»åŠ¨ - ä»…ä¸ºç°æœ‰æ ‡æ³¨ç‚¹è®¾ç½®æ–¹å‘æˆ–auto-moveå·²å…³é—­');\n        }\n      }\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: Handle Cross-Sectional Direction Set\n   * @param {number} direction - Direction angle in degrees\n   */\n  async handleCrossSectionalDirectionSet(direction) {\n    if (!this.crossSectionalState) {\n      console.error('[Cross-Sectional] No cross-sectional state available');\n      return;\n    }\n    \n    try {\n      console.log(`[Cross-Sectional] Setting direction ${direction.toFixed(1)}Â° for current point`);\n      \n      // ğŸ”§ FIX: Check if cross-sectional state still exists\n      if (!this.crossSectionalState) {\n        console.warn('[Cross-Sectional] State is null, cannot process direction');\n        return;\n      }\n      \n      // Process current cross-sectional point with the direction\n      await this.processCurrentCrossSectionalPoint(direction);\n      \n      // Save state\n      this.saveState();\n      this.autoSaveCurrentImage();\n      \n      // ğŸ”§ FIX: Check state again after processing\n      if (!this.crossSectionalState) {\n        console.warn('[Cross-Sectional] State became null during processing');\n        return;\n      }\n      \n      // Check if all annotations are processed\n      if (this.crossSectionalState.processedCount >= this.crossSectionalState.totalCount) {\n        console.log('[Cross-Sectional] All annotations processed, completing mode');\n        this.completeCrossSectionalMode();\n      } else {\n        // Continue with next annotation\n        console.log('[Cross-Sectional] Continuing to next annotation');\n        // The advance method will be called from processCurrentCrossSectionalPoint\n      }\n      \n    } catch (error) {\n      console.error('[Cross-Sectional] Failed to handle direction set:', error);\n      \n      // Show error to user but don't break the mode\n      if (window.PlantAnnotationTool?.showError) {\n        window.PlantAnnotationTool.showError('Cross-Sectional Error', `Failed to process direction: ${error.message}`);\n      }\n      \n      // Try to continue anyway by advancing to next point\n      try {\n        console.log('[Cross-Sectional] Attempting to continue despite error...');\n        // ğŸ”§ FIX: Check if state exists before accessing\n        if (this.crossSectionalState) {\n          this.crossSectionalState.processedCount++;\n          await this.advanceCrossSectionalProgress();\n        } else {\n          console.warn('[Cross-Sectional] Cannot continue - state is null');\n        }\n      } catch (advanceError) {\n        console.error('[Cross-Sectional] Failed to advance after error:', advanceError);\n        // Exit cross-sectional mode if we can't continue\n        if (this.crossSectionalState) {\n          this.completeCrossSectionalMode();\n        } else {\n          console.warn('[Cross-Sectional] Cannot complete - state is null, forcing exit');\n          this.exitAutoDirectionMode();\n        }\n      }\n    }\n  }\n\n  /**\n   * å–æ¶ˆæ–¹å‘é€‰æ‹©\n   */\n  cancelDirectionSelection(forceExit = false) {\n    console.log('[è°ƒè¯•] cancelDirectionSelection è¢«è°ƒç”¨', {\n      wasInDirectionMode: this.state.isDirectionSelectionMode,\n      selectedKeypoint: this.state.selectedKeypoint?.order,\n      isAutoMode: this.state.isAutoDirectionMode,\n      forceExit\n    });\n\n    this.state.selectedKeypoint = null;\n    this.state.isDirectionSelectionMode = false;\n    this.state.directionSelectionPoint = null;\n\n    // åªæœ‰åœ¨å¼ºåˆ¶é€€å‡ºæˆ–éè‡ªåŠ¨æ¨¡å¼æ—¶æ‰é€€å‡ºè‡ªåŠ¨æ¨¡å¼\n    if (this.state.isAutoDirectionMode && forceExit) {\n      console.log('[è°ƒè¯•] å¼ºåˆ¶é€€å‡ºè‡ªåŠ¨æ¨¡å¼');\n      this.exitAutoDirectionMode();\n    } else if (this.state.isAutoDirectionMode) {\n      console.log('[è°ƒè¯•] è‡ªåŠ¨æ¨¡å¼ä¸­å–æ¶ˆæ–¹å‘é€‰æ‹©ï¼Œä½†ä¿æŒè‡ªåŠ¨æ¨¡å¼');\n      // åœ¨è‡ªåŠ¨æ¨¡å¼ä¸‹ï¼Œåªæ˜¯æ¸…é™¤å½“å‰é€‰æ‹©ï¼Œä¸é€€å‡ºè‡ªåŠ¨æ¨¡å¼\n    }\n\n    // ğŸ”§ FIX: Reset cursor to appropriate state when exiting direction selection\n    if (this.state.isAutoDirectionMode) {\n      // In auto mode, maintain crosshair cursor\n      this.canvas.style.cursor = 'crosshair';\n    } else {\n      // In normal mode, reset to default crosshair\n      this.canvas.style.cursor = 'crosshair';\n    }\n\n    this.restoreNormalPreview();\n    this.render();\n    console.log('Direction selection cancelled');\n  }\n\n  /**\n   * ğŸ”§ ENHANCED: å¼€å§‹è‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©æ¨¡å¼ï¼ˆæ”¯æŒçºµå‘å’Œæ¨ªå‘æ¨¡å¼ï¼‰\n   */\n  async startAutoDirectionMode() {\n    console.log('[è°ƒè¯•] startAutoDirectionMode è¢«è°ƒç”¨ï¼Œå½“å‰æ¨¡å¼:', this.autoDirectionMode);\n\n    // å…ˆæ¸…ç†ä¹‹å‰çš„çŠ¶æ€\n    if (this.state.isDirectionSelectionMode || this.state.isAutoDirectionMode) {\n      console.log('[è°ƒè¯•] æ¸…ç†ä¹‹å‰çš„æ–¹å‘é€‰æ‹©çŠ¶æ€');\n      this.state.selectedKeypoint = null;\n      this.state.isDirectionSelectionMode = false;\n      this.state.directionSelectionPoint = null;\n      this.state.isAutoDirectionMode = false;\n    }\n\n    // Clear any existing cross-sectional state\n    this.crossSectionalState = null;\n    this.crossSectionalMap.clear();\n\n    try {\n      // å¦‚æœå½“å‰é€‰æ‹©çš„ç±»å‹å­˜åœ¨ä¸”ä¸æ”¯æŒæ–¹å‘ï¼Œç›´æ¥æç¤ºå¹¶è¿”å›\n      if (this.customAnnotationManager) {\n        const t = this.customAnnotationManager.getCurrentCustomType?.();\n        if (t && t.metadata && t.metadata.isDirectional === false) {\n          if (window.PlantAnnotationTool?.showError) {\n            window.PlantAnnotationTool.showError('Auto Direction Disabled', 'å½“å‰é€‰æ‹©çš„ç±»å‹æœªå¯ç”¨æ–¹å‘åŠŸèƒ½');\n          }\n          return false;\n        }\n      }\n      if (this.autoDirectionMode === 'cross-sectional') {\n        // ğŸ”§ NEW: Cross-Sectional Mode - Process same order across all images\n        const ok = await this.startCrossSectionalMode();\n        if (!ok) {\n          this.exitAutoDirectionMode();\n          this.resetAutoDirectionButton();\n        }\n        return ok;\n      } else {\n        // ğŸ”§ EXISTING: Longitudinal Mode - Complete all points in one image first\n        const ok = this.startLongitudinalMode();\n        if (!ok) {\n          this.exitAutoDirectionMode();\n          this.resetAutoDirectionButton();\n        }\n        return ok;\n      }\n    } catch (error) {\n      console.error('[Auto Direction] Failed to start auto direction mode:', error);\n      if (window.PlantAnnotationTool?.showError) {\n        window.PlantAnnotationTool.showError('Auto Direction Error', error.message);\n      }\n      return false;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: Start Cross-Sectional Mode\n   */\n  async startCrossSectionalMode() {\n    console.log('[Cross-Sectional] Starting cross-sectional mode');\n    \n    try {\n      // Build cross-sectional map for all images\n      this.crossSectionalMap = await this.buildCrossSectionalMap();\n      \n      if (this.crossSectionalMap.size === 0) {\n        console.log('[Cross-Sectional] No directionless annotations found across all images');\n        if (window.PlantAnnotationTool?.showInfo) {\n          window.PlantAnnotationTool.showInfo('No Work Needed', 'No directionless annotations found across all images in current view angle.');\n        }\n        return false;\n      }\n      \n      // Initialize cross-sectional state\n      this.initializeCrossSectionalState();\n      \n      // Set auto direction mode flag\n      this.state.isAutoDirectionMode = true;\n      \n      // Update UI to reflect cross-sectional mode\n      this.updateAutoDirectionModeUI();\n      \n      // Start processing with first annotation\n      const currentPoint = this.getCurrentCrossSectionalPoint();\n      if (currentPoint) {\n        console.log(`[Cross-Sectional] Starting with annotation #${currentPoint.annotation.order} in ${currentPoint.imageName}`);\n        \n        // Switch to the first image with annotations to process\n        await this.switchToImageForCrossSectional(currentPoint.imageId);\n        \n        // Show cross-sectional progress UI\n        this.updateCrossSectionalProgressUI();\n        \n        if (window.PlantAnnotationTool?.showInfo) {\n          window.PlantAnnotationTool.showInfo('Cross-Sectional Mode', \n            `Processing ${this.crossSectionalState.totalCount} annotations across ${this.crossSectionalState.availableOrders.length} order numbers. Click to set directions.`);\n        }\n        \n        return true;\n      } else {\n        throw new Error('No annotations to process in cross-sectional mode');\n      }\n      \n    } catch (error) {\n      console.error('[Cross-Sectional] Failed to start cross-sectional mode:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ EXISTING: Start Longitudinal Mode (original behavior)\n   */\n  startLongitudinalMode() {\n    console.log('[Longitudinal] Starting longitudinal mode');\n    \n    // æ‰¾åˆ°æ‰€æœ‰éœ€è¦è®¾ç½®æ–¹å‘çš„æ ‡æ³¨ç‚¹ï¼ˆä¼ ç»Ÿleft/rightæ ‡æ³¨ç‚¹ + æ— æ–¹å‘æ ‡æ³¨ç‚¹ï¼‰\n    const needDirectionKeypoints = this.keypoints.filter(kp => {\n      // ä¼ ç»Ÿleft/rightæ ‡æ³¨ç‚¹\n      const isLegacy = (kp.direction === 'left' || kp.direction === 'right') &&\n                      kp.directionType !== 'angle' &&\n                      typeof kp.direction !== 'number';\n\n      // æ— æ–¹å‘æ ‡æ³¨ç‚¹\n      const isNoDirection = kp.direction === null || kp.direction === undefined;\n\n      return isLegacy || isNoDirection;\n    });\n\n    console.log('[Longitudinal] æ‰¾åˆ°éœ€è¦è®¾ç½®æ–¹å‘çš„æ ‡æ³¨ç‚¹', needDirectionKeypoints.map(kp => ({\n      order: kp.order,\n      direction: kp.direction,\n      directionType: kp.directionType,\n      type: kp.direction === null ? 'æ— æ–¹å‘' : 'ä¼ ç»Ÿæ–¹å‘'\n    })));\n\n    if (needDirectionKeypoints.length === 0) {\n      console.log('[Longitudinal] æ²¡æœ‰éœ€è¦è®¾ç½®æ–¹å‘çš„æ ‡æ³¨ç‚¹');\n      // æ˜¾ç¤ºæç¤ºä¿¡æ¯\n      if (window.PlantAnnotationTool?.showInfo) {\n        window.PlantAnnotationTool.showInfo('æ— éœ€è®¾ç½®', 'å½“å‰å›¾åƒæ²¡æœ‰éœ€è¦è®¾ç½®æ–¹å‘çš„æ ‡æ³¨ç‚¹');\n      }\n      // ç¡®ä¿æŒ‰é’®å’ŒçŠ¶æ€å¤ä½\n      this.exitAutoDirectionMode();\n      this.resetAutoDirectionButton();\n      return false;\n    }\n\n    // æŒ‰åºå·æ’åº\n    needDirectionKeypoints.sort((a, b) => (a.order || 0) - (b.order || 0));\n\n    this.state.isAutoDirectionMode = true;\n    this.state.autoDirectionKeypoints = needDirectionKeypoints;\n    this.state.autoDirectionIndex = 0;\n\n    console.log('[Longitudinal] è®¾ç½®è‡ªåŠ¨æ¨¡å¼çŠ¶æ€', {\n      isAutoDirectionMode: this.state.isAutoDirectionMode,\n      autoDirectionKeypoints: this.state.autoDirectionKeypoints.length,\n      autoDirectionIndex: this.state.autoDirectionIndex\n    });\n\n    // Update UI to reflect longitudinal mode\n    this.updateAutoDirectionModeUI();\n\n    // é€‰æ‹©ç¬¬ä¸€ä¸ªå…³é”®ç‚¹å¹¶è‡ªåŠ¨æ”¾å¤§\n    this.selectKeypointWithZoom(needDirectionKeypoints[0]);\n\n    console.log(`[Longitudinal] å¼€å§‹è‡ªåŠ¨åŒ–æ–¹å‘è®¾ç½®æ¨¡å¼ï¼Œå…± ${needDirectionKeypoints.length} ä¸ªæ ‡æ³¨ç‚¹éœ€è¦è®¾ç½®æ–¹å‘`);\n\n    // æ˜¾ç¤ºæç¤ºä¿¡æ¯\n    if (window.PlantAnnotationTool?.showInfo) {\n      window.PlantAnnotationTool.showInfo('Longitudinal Mode', \n        `Setting directions for ${needDirectionKeypoints.length} annotations in current image. Move mouse to select direction, click to confirm, right-click to pause.`);\n    }\n\n    return true;\n  }\n\n  /**\n   * é€‰æ‹©å…³é”®ç‚¹å¹¶è‡ªåŠ¨æ”¾å¤§åˆ°è¯¥ä½ç½®\n   */\n  selectKeypointWithZoom(keypoint) {\n    console.log('[è°ƒè¯•] selectKeypointWithZoom å¼€å§‹', {\n      keypoint: keypoint.order,\n      isAutoMode: this.state.isAutoDirectionMode,\n      isDirectionMode: this.state.isDirectionSelectionMode\n    });\n\n    // å…ˆé€‰æ‹©å…³é”®ç‚¹\n    this.selectKeypoint(keypoint);\n\n    console.log('[è°ƒè¯•] selectKeypoint å®ŒæˆåçŠ¶æ€', {\n      isAutoMode: this.state.isAutoDirectionMode,\n      isDirectionMode: this.state.isDirectionSelectionMode,\n      selectedKeypoint: this.state.selectedKeypoint?.order\n    });\n\n    // è‡ªåŠ¨æ”¾å¤§åˆ°å…³é”®ç‚¹ä½ç½®\n    const defaultAutoScale = 2.5; // é»˜è®¤çš„è‡ªåŠ¨åŒ–æ”¾å¤§å€æ•°\n    const currentScale = this.state.scale;\n\n    // å¦‚æœå½“å‰ç¼©æ”¾å¤§äºé»˜è®¤å€¼ï¼Œä¿æŒå½“å‰ç¼©æ”¾ï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤å€¼\n    const targetScale = Math.max(currentScale, defaultAutoScale);\n    const newScale = Math.min(targetScale, this.options.maxZoom);\n\n    // è®¡ç®—ç”»å¸ƒä¸­å¿ƒ\n    const centerX = this.canvas.width / 2;\n    const centerY = this.canvas.height / 2;\n\n    // è®¡ç®—æ ‡æ³¨ç‚¹åœ¨æ–°ç¼©æ”¾ä¸‹çš„ä½ç½®ï¼Œä½¿å…¶å±…ä¸­\n    this.state.scale = newScale;\n    this.state.translateX = centerX - (keypoint.x * newScale);\n    this.state.translateY = centerY - (keypoint.y * newScale);\n\n    // ç¡®ä¿å›¾åƒä¸ä¼šè¶…å‡ºè¾¹ç•Œ\n    this.constrainView();\n\n    this.updateZoomInfo();\n    this.render();\n\n    const scaleAction = currentScale >= defaultAutoScale ? 'ä¿æŒå½“å‰ç¼©æ”¾' : 'ä½¿ç”¨é»˜è®¤ç¼©æ”¾';\n    console.log(`è‡ªåŠ¨å±…ä¸­åˆ°æ ‡æ³¨ç‚¹ #${keypoint.order}ï¼Œç¼©æ”¾: ${newScale.toFixed(1)}x (${scaleAction})`);\n\n    // æ·»åŠ è§†è§‰æç¤º\n    this.showKeypointFocusHint(keypoint);\n\n    console.log('[è°ƒè¯•] selectKeypointWithZoom å®ŒæˆåçŠ¶æ€', {\n      isAutoMode: this.state.isAutoDirectionMode,\n      isDirectionMode: this.state.isDirectionSelectionMode,\n      selectedKeypoint: this.state.selectedKeypoint?.order\n    });\n  }\n\n  /**\n   * æ˜¾ç¤ºæ ‡æ³¨ç‚¹èšç„¦æç¤º\n   */\n  showKeypointFocusHint(keypoint) {\n    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„èšç„¦æ•ˆæœ\n    const originalRender = this.render.bind(this);\n    let pulseCount = 0;\n    const maxPulses = 3;\n\n    const pulse = () => {\n      if (pulseCount >= maxPulses) {\n        return;\n      }\n\n      // ç»˜åˆ¶è„‰å†²æ•ˆæœ\n      const screenPos = this.imageToScreen(keypoint.x, keypoint.y);\n      const ctx = this.ctx;\n\n      ctx.save();\n      ctx.globalAlpha = 0.6 - (pulseCount * 0.2);\n      ctx.strokeStyle = '#f59e0b';\n      ctx.lineWidth = 3;\n      ctx.setLineDash([]);\n\n      const radius = 30 + (pulseCount * 10);\n      ctx.beginPath();\n      ctx.arc(screenPos.x, screenPos.y, radius, 0, 2 * Math.PI);\n      ctx.stroke();\n\n      ctx.restore();\n\n      pulseCount++;\n      if (pulseCount < maxPulses) {\n        setTimeout(pulse, 200);\n      }\n    };\n\n    // å»¶è¿Ÿä¸€ç‚¹å¼€å§‹è„‰å†²æ•ˆæœ\n    setTimeout(pulse, 100);\n  }\n\n  /**\n   * çº¦æŸè§†å›¾ï¼Œç¡®ä¿ä¸è¶…å‡ºåˆç†è¾¹ç•Œ\n   */\n  constrainView() {\n    if (!this.imageElement) return;\n\n    const imageWidth = this.imageElement.width * this.state.scale;\n    const imageHeight = this.imageElement.height * this.state.scale;\n    const canvasWidth = this.canvas.width;\n    const canvasHeight = this.canvas.height;\n\n    // å¦‚æœå›¾åƒå°äºç”»å¸ƒï¼Œå±…ä¸­æ˜¾ç¤º\n    if (imageWidth < canvasWidth) {\n      this.state.translateX = (canvasWidth - imageWidth) / 2;\n    } else {\n      // ç¡®ä¿å›¾åƒä¸ä¼šç§»å‡ºç”»å¸ƒå¤ªè¿œ\n      const maxTranslateX = 0;\n      const minTranslateX = canvasWidth - imageWidth;\n      this.state.translateX = Math.max(minTranslateX, Math.min(maxTranslateX, this.state.translateX));\n    }\n\n    if (imageHeight < canvasHeight) {\n      this.state.translateY = (canvasHeight - imageHeight) / 2;\n    } else {\n      const maxTranslateY = 0;\n      const minTranslateY = canvasHeight - imageHeight;\n      this.state.translateY = Math.max(minTranslateY, Math.min(maxTranslateY, this.state.translateY));\n    }\n  }\n\n  /**\n   * é€‰æ‹©ä¸‹ä¸€ä¸ªè‡ªåŠ¨æ–¹å‘é€‰æ‹©çš„å…³é”®ç‚¹\n   */\n  selectNextAutoDirectionKeypoint() {\n    this.state.autoDirectionIndex++;\n\n    if (this.state.autoDirectionIndex >= this.state.autoDirectionKeypoints.length) {\n      // å½“å‰å›¾ç‰‡çš„æ‰€æœ‰æ ‡æ³¨ç‚¹éƒ½å·²å®Œæˆ\n      const totalUpgraded = this.state.autoDirectionKeypoints.length;\n      console.log(`å½“å‰å›¾ç‰‡æ–¹å‘è®¾ç½®å®Œæˆï¼Œå…±è®¾ç½®äº† ${totalUpgraded} ä¸ªæ ‡æ³¨ç‚¹`);\n\n      // å°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡ç»§ç»­è‡ªåŠ¨åŒ–\n      if (this.tryAutoSwitchToNextImage()) {\n        console.log('è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡ç»§ç»­æ–¹å‘è®¾ç½®');\n        return;\n      }\n\n      // æ²¡æœ‰ä¸‹ä¸€å¼ å›¾ç‰‡ï¼Œå®Œå…¨ç»“æŸè‡ªåŠ¨åŒ–æ¨¡å¼\n      this.exitAutoDirectionMode();\n      this.resetAutoDirectionButton();\n\n      // æ˜¾ç¤ºå®Œæˆæç¤º\n      if (window.showSuccess) {\n        window.showSuccess('å…¨éƒ¨å®Œæˆ', `è‡ªåŠ¨åŒ–æ–¹å‘è®¾ç½®å·²å®Œæˆï¼`);\n      }\n      return;\n    }\n\n    const nextKeypoint = this.state.autoDirectionKeypoints[this.state.autoDirectionIndex];\n    this.selectKeypointWithZoom(nextKeypoint);\n\n    const progress = `${this.state.autoDirectionIndex + 1}/${this.state.autoDirectionKeypoints.length}`;\n    console.log(`è‡ªåŠ¨é€‰æ‹©ä¸‹ä¸€ä¸ªä¼ ç»Ÿæ ‡æ³¨ç‚¹ #${nextKeypoint.order} (${progress})`);\n\n    // æ˜¾ç¤ºè¿›åº¦æç¤º\n    if (window.showInfo) {\n      window.showInfo('å‡çº§è¿›åº¦', `æ­£åœ¨å‡çº§ç¬¬ ${this.state.autoDirectionIndex + 1} ä¸ªï¼Œå…± ${this.state.autoDirectionKeypoints.length} ä¸ªä¼ ç»Ÿæ ‡æ³¨ç‚¹`);\n    }\n  }\n\n  /**\n   * æ˜¾ç¤ºè‡ªåŠ¨æ¨¡å¼å®Œæˆæç¤º\n   */\n  showAutoModeCompletionHint() {\n    // åˆ›å»ºå®Œæˆæç¤ºå…ƒç´ \n    const hint = document.createElement('div');\n    hint.className = 'auto-direction-completion-hint';\n    hint.textContent = 'ğŸ‰ è‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©å·²å®Œæˆï¼';\n    hint.style.cssText = `\n      position: absolute;\n      top: 50px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n      padding: 12px 24px;\n      border-radius: 25px;\n      font-size: 14px;\n      font-weight: 600;\n      z-index: 1000;\n      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);\n      animation: completionBounce 0.6s ease-out;\n    `;\n    \n    // æ·»åŠ åŠ¨ç”»æ ·å¼\n    if (!document.getElementById('completion-animation-style')) {\n      const style = document.createElement('style');\n      style.id = 'completion-animation-style';\n      style.textContent = `\n        @keyframes completionBounce {\n          0% {\n            opacity: 0;\n            transform: translateX(-50%) translateY(-20px) scale(0.8);\n          }\n          50% {\n            transform: translateX(-50%) translateY(0) scale(1.1);\n          }\n          100% {\n            opacity: 1;\n            transform: translateX(-50%) translateY(0) scale(1);\n          }\n        }\n      `;\n      document.head.appendChild(style);\n    }\n    \n    // æ·»åŠ åˆ°canvaså®¹å™¨\n    const canvasContainer = document.getElementById('canvas-container');\n    if (canvasContainer) {\n      canvasContainer.appendChild(hint);\n      \n      // 3ç§’åè‡ªåŠ¨ç§»é™¤\n      setTimeout(() => {\n        if (hint.parentElement) {\n          hint.remove();\n        }\n      }, 3000);\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: Set Auto Direction Mode (Longitudinal vs Cross-Sectional)\n   * @param {string} mode - 'longitudinal' or 'cross-sectional'\n   */\n  setAutoDirectionMode(mode) {\n    if (!['longitudinal', 'cross-sectional'].includes(mode)) {\n      throw new Error('Invalid auto direction mode: ' + mode);\n    }\n    \n    this.autoDirectionMode = mode;\n    console.log(`Auto Direction mode set to: ${mode}`);\n    \n    // Update UI to reflect mode change\n    this.updateAutoDirectionModeUI();\n  }\n\n  /**\n   * ğŸ”§ NEW: Update UI to reflect current auto direction mode\n   */\n  updateAutoDirectionModeUI() {\n    const autoDirectionBtn = document.getElementById('auto-direction-btn');\n    const modeSelector = document.getElementById('auto-direction-mode-selector');\n    \n    if (autoDirectionBtn && this.autoDirectionMode) {\n      // Remove existing mode classes\n      autoDirectionBtn.classList.remove('longitudinal-mode', 'cross-sectional-mode');\n      \n      // Add current mode class\n      autoDirectionBtn.classList.add(`${this.autoDirectionMode}-mode`);\n      \n      // Update button text if needed\n      if (this.state.isAutoDirectionMode) {\n        const modeText = this.autoDirectionMode === 'cross-sectional' ? 'Exit Vertical Mode' : 'Exit Horizontal Mode';\n        autoDirectionBtn.textContent = modeText;\n      } else {\n        autoDirectionBtn.textContent = 'Auto Direction';\n      }\n    }\n    \n    // ğŸ”§ FIX: Only update mode selector if we have a valid mode\n    // Don't override UI selector with null/undefined values\n    if (modeSelector && this.autoDirectionMode) {\n      modeSelector.value = this.autoDirectionMode;\n      console.log('[è°ƒè¯•] æ›´æ–°UIé€‰æ‹©å™¨ä¸º:', this.autoDirectionMode);\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: Build Cross-Sectional Map for all images\n   * @returns {Promise<Map>} Map of order numbers to array of {imageId, annotation} pairs\n   */\n  async buildCrossSectionalMap() {\n    const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n    const appState = window.PlantAnnotationTool?.appState;\n    \n    if (!plantDataManager || !appState?.currentPlant) {\n      throw new Error('Plant data manager or current plant not available');\n    }\n    \n    const crossSectionalMap = new Map();\n    \n    try {\n      // Get all images for current plant and view angle\n      const allImages = await plantDataManager.getPlantImages(\n        appState.currentPlant.id,\n        appState.currentPlant.selectedViewAngle\n      );\n      \n      if (!allImages || allImages.length === 0) {\n        throw new Error('No images found for current plant and view angle');\n      }\n      \n      console.log(`[Cross-Sectional] Analyzing ${allImages.length} images for directionless annotations`);\n      \n      // Analyze each image for directionless annotations\n      for (const image of allImages) {\n        try {\n          const annotations = await plantDataManager.getImageAnnotations(image.id);\n          \n          if (annotations && annotations.length > 0) {\n            // Find directionless annotations\n            const directionlessAnnotations = annotations.filter(ann => \n              !ann.direction || ann.direction === 'none' || ann.direction === null\n            );\n            \n            // Group by order number\n            for (const annotation of directionlessAnnotations) {\n              const order = annotation.order || 1;\n              \n              if (!crossSectionalMap.has(order)) {\n                crossSectionalMap.set(order, []);\n              }\n              \n              crossSectionalMap.get(order).push({\n                imageId: image.id,\n                imageName: image.name,\n                annotation: annotation\n              });\n            }\n          }\n        } catch (error) {\n          console.warn(`[Cross-Sectional] Failed to load annotations for image ${image.id}:`, error);\n        }\n      }\n      \n      // Sort each order group by image name for consistent processing order\n      for (const [order, imageAnnotationPairs] of crossSectionalMap) {\n        imageAnnotationPairs.sort((a, b) => a.imageName.localeCompare(b.imageName));\n      }\n      \n      console.log(`[Cross-Sectional] Built map with ${crossSectionalMap.size} order numbers`, \n        Array.from(crossSectionalMap.keys()).sort((a, b) => a - b));\n      \n      return crossSectionalMap;\n      \n    } catch (error) {\n      console.error('[Cross-Sectional] Failed to build cross-sectional map:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: Get all available order numbers across all images\n   * @returns {Array<number>} Sorted array of order numbers\n   */\n  getAvailableOrderNumbers() {\n    if (!this.crossSectionalMap) {\n      return [];\n    }\n    \n    return Array.from(this.crossSectionalMap.keys()).sort((a, b) => a - b);\n  }\n\n  /**\n   * ğŸ”§ NEW: Get all images that have annotations with specific order\n   * @param {number} order - Order number to search for\n   * @returns {Array} Array of {imageId, imageName, annotation} objects\n   */\n  getImagesWithOrder(order) {\n    if (!this.crossSectionalMap || !this.crossSectionalMap.has(order)) {\n      return [];\n    }\n    \n    return this.crossSectionalMap.get(order);\n  }\n\n  /**\n   * ğŸ”§ NEW: Initialize Cross-Sectional State\n   */\n  initializeCrossSectionalState() {\n    const availableOrders = this.getAvailableOrderNumbers();\n    \n    if (availableOrders.length === 0) {\n      throw new Error('No directionless annotations found across all images');\n    }\n    \n    this.crossSectionalState = {\n      currentOrder: availableOrders[0],\n      currentImageIndex: 0,\n      processedCount: 0,\n      totalCount: this.getAllCrossSectionalPoints().length,\n      availableOrders: availableOrders,\n      startTime: Date.now()\n    };\n    \n    console.log(`[Cross-Sectional] Initialized state:`, this.crossSectionalState);\n  }\n\n  /**\n   * ğŸ”§ NEW: Get all cross-sectional points for progress tracking\n   * @returns {Array} All directionless annotation points across all images\n   */\n  getAllCrossSectionalPoints() {\n    const allPoints = [];\n    \n    if (!this.crossSectionalMap) {\n      return allPoints;\n    }\n    \n    for (const imageAnnotationPairs of this.crossSectionalMap.values()) {\n      allPoints.push(...imageAnnotationPairs);\n    }\n    \n    return allPoints;\n  }\n\n  /**\n   * ğŸ”§ NEW: Get current cross-sectional annotation to process\n   * @returns {Object|null} Current annotation data or null if done\n   */\n  getCurrentCrossSectionalPoint() {\n    if (!this.crossSectionalState) {\n      return null;\n    }\n    \n    const { currentOrder, currentImageIndex } = this.crossSectionalState;\n    const imagesWithCurrentOrder = this.getImagesWithOrder(currentOrder);\n    \n    if (currentImageIndex >= imagesWithCurrentOrder.length) {\n      return null; // No more images for current order\n    }\n    \n    return imagesWithCurrentOrder[currentImageIndex];\n  }\n\n  /**\n   * ğŸ”§ NEW: Process current cross-sectional point with direction\n   * @param {string|number} direction - Direction value ('left', 'right', or angle in degrees)\n   */\n  async processCurrentCrossSectionalPoint(direction) {\n    // ğŸ”§ FIX: Check if state exists first\n    if (!this.crossSectionalState) {\n      console.warn('[Cross-Sectional] Cannot process point - state is null');\n      return;\n    }\n    \n    const currentPoint = this.getCurrentCrossSectionalPoint();\n    \n    if (!currentPoint) {\n      console.warn('[Cross-Sectional] No current point to process');\n      return;\n    }\n    \n    try {\n      // Update the annotation with direction\n      currentPoint.annotation.direction = direction;\n      \n      // Save to storage\n      const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n      if (plantDataManager) {\n        const allAnnotations = await plantDataManager.getImageAnnotations(currentPoint.imageId);\n        await plantDataManager.saveImageAnnotations(currentPoint.imageId, allAnnotations);\n      }\n      \n      // ğŸ”§ FIX: Check state again before updating count\n      if (!this.crossSectionalState) {\n        console.warn('[Cross-Sectional] State became null during processing');\n        return;\n      }\n      \n      // Update progress\n      this.crossSectionalState.processedCount++;\n      \n      console.log(`[Cross-Sectional] Processed annotation #${currentPoint.annotation.order} in ${currentPoint.imageName} with direction: ${direction}`);\n      \n      // Move to next point\n      await this.advanceCrossSectionalProgress();\n      \n    } catch (error) {\n      console.error('[Cross-Sectional] Failed to process point:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: Advance cross-sectional processing to next point\n   */\n  async advanceCrossSectionalProgress() {\n    if (!this.crossSectionalState) {\n      return;\n    }\n    \n    const { currentOrder, currentImageIndex, availableOrders } = this.crossSectionalState;\n    const imagesWithCurrentOrder = this.getImagesWithOrder(currentOrder);\n    \n    // Check if there are more images with current order\n    if (currentImageIndex + 1 < imagesWithCurrentOrder.length) {\n      // ğŸ”§ FIX: Check state still exists before updating\n      if (!this.crossSectionalState) {\n        console.warn('[Cross-Sectional] State became null during advance, cannot continue');\n        return;\n      }\n      \n      // Move to next image with same order\n      this.crossSectionalState.currentImageIndex++;\n      const nextImageData = imagesWithCurrentOrder[this.crossSectionalState.currentImageIndex];\n      \n      console.log(`[Cross-Sectional] Moving to next image for order ${currentOrder}: ${nextImageData.imageName}`);\n      \n      // Switch to next image\n      await this.switchToImageForCrossSectional(nextImageData.imageId);\n      \n    } else {\n      // Current order complete, move to next order\n      const currentOrderIndex = availableOrders.indexOf(currentOrder);\n      \n      if (currentOrderIndex + 1 < availableOrders.length) {\n        // ğŸ”§ FIX: Check state still exists before updating\n        if (!this.crossSectionalState) {\n          console.warn('[Cross-Sectional] State became null during advance, cannot continue');\n          return;\n        }\n        \n        // Move to next order\n        const nextOrder = availableOrders[currentOrderIndex + 1];\n        this.crossSectionalState.currentOrder = nextOrder;\n        this.crossSectionalState.currentImageIndex = 0;\n        \n        const nextOrderImages = this.getImagesWithOrder(nextOrder);\n        if (nextOrderImages.length > 0) {\n          console.log(`[Cross-Sectional] Moving to next order ${nextOrder}, starting with: ${nextOrderImages[0].imageName}`);\n          \n          // Switch to first image with next order\n          await this.switchToImageForCrossSectional(nextOrderImages[0].imageId);\n        }\n      } else {\n        // All orders processed - complete cross-sectional mode\n        console.log('[Cross-Sectional] All orders processed, completing mode');\n        this.completeCrossSectionalMode();\n      }\n    }\n    \n    // Update progress UI\n    this.updateCrossSectionalProgressUI();\n  }\n\n  /**\n   * ğŸ”§ NEW: Switch to specific image for cross-sectional processing\n   * @param {string} targetImageId - Image ID to switch to\n   */\n  async switchToImageForCrossSectional(targetImageId) {\n    try {\n      console.log(`[Cross-Sectional] Starting image switch to: ${targetImageId}`);\n      \n      const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n      const appState = window.PlantAnnotationTool?.appState;\n      \n      if (!plantDataManager || !appState?.currentPlant) {\n        throw new Error('Plant data manager or current plant not available');\n      }\n      \n      // Get image data\n      const allImages = await plantDataManager.getPlantImages(\n        appState.currentPlant.id,\n        appState.currentPlant.selectedViewAngle\n      );\n      \n      const targetImage = allImages.find(img => img.id === targetImageId);\n      if (!targetImage) {\n        throw new Error(`Image not found: ${targetImageId}`);\n      }\n      \n      console.log(`[Cross-Sectional] Switching to image: ${targetImage.name}`);\n      \n      // Use global image selection function\n      if (window.handleImageSelect) {\n        console.log(`[Cross-Sectional] Calling handleImageSelect...`);\n        await window.handleImageSelect(targetImage, true);\n        console.log(`[Cross-Sectional] handleImageSelect completed successfully`);\n      } else {\n        throw new Error('Global image selection function not available');\n      }\n      \n      // Wait for image to load and annotations to be ready\n      console.log(`[Cross-Sectional] Waiting for image to load...`);\n      await this.waitForImageLoad();\n      console.log(`[Cross-Sectional] Image loaded successfully`);\n      \n      // Select the annotation for current processing\n      const currentPoint = this.getCurrentCrossSectionalPoint();\n      if (currentPoint && currentPoint.annotation) {\n        console.log(`[Cross-Sectional] Looking for annotation #${currentPoint.annotation.order} in loaded keypoints`);\n        \n        // Find the annotation in the loaded keypoints\n        const loadedAnnotation = this.keypoints.find(kp => \n          kp.order === currentPoint.annotation.order\n        );\n        \n        if (loadedAnnotation) {\n          console.log(`[Cross-Sectional] Found annotation #${loadedAnnotation.order}, selecting it`);\n          this.state.selectedKeypoint = loadedAnnotation;\n          this.state.isDirectionSelectionMode = true;\n          \n          // Center view on the annotation\n          this.selectKeypointWithZoom(loadedAnnotation);\n        } else {\n          console.warn(`[Cross-Sectional] Could not find annotation #${currentPoint.annotation.order} in loaded keypoints`);\n        }\n      } else {\n        console.warn(`[Cross-Sectional] No current point available after image switch`);\n      }\n      \n    } catch (error) {\n      console.error('[Cross-Sectional] Failed to switch image:', error);\n      // Don't re-throw the error, continue with error handling\n      if (window.PlantAnnotationTool?.showError) {\n        window.PlantAnnotationTool.showError('Image Switch Failed', error.message);\n      }\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: Wait for image load to complete\n   */\n  async waitForImageLoad(maxWaitTime = 5000) {\n    const startTime = Date.now();\n    \n    console.log(`[Cross-Sectional] Waiting for image load... (max ${maxWaitTime}ms)`);\n    \n    while (!this.imageLoaded && (Date.now() - startTime) < maxWaitTime) {\n      await new Promise(resolve => setTimeout(resolve, 100));\n    }\n    \n    if (!this.imageLoaded) {\n      console.warn(`[Cross-Sectional] Image load timeout after ${maxWaitTime}ms`);\n      // Don't throw error, continue anyway\n      return false;\n    }\n    \n    console.log(`[Cross-Sectional] Image loaded in ${Date.now() - startTime}ms`);\n    return true;\n  }\n\n  /**\n   * ğŸ”§ NEW: Complete cross-sectional mode\n   */\n  completeCrossSectionalMode() {\n    // ğŸ”§ FIX: Check if state exists before accessing\n    if (!this.crossSectionalState) {\n      console.warn('[Cross-Sectional] Cannot complete - state is null');\n      // Just exit auto direction mode if state is already gone\n      this.exitAutoDirectionMode();\n      return;\n    }\n    \n    const duration = Date.now() - this.crossSectionalState.startTime;\n    const processedCount = this.crossSectionalState.processedCount;\n    \n    console.log(`[Cross-Sectional] Mode completed! Processed ${processedCount} annotations in ${duration}ms`);\n    \n    // Show completion message\n    if (window.updateProgressInfo) {\n      window.updateProgressInfo(`Cross-Sectional mode completed! Processed ${processedCount} annotations across all images.`);\n    }\n    \n    // Clean up state\n    this.crossSectionalState = null;\n    this.crossSectionalMap.clear();\n    \n    // Exit auto direction mode\n    this.exitAutoDirectionMode();\n  }\n\n  /**\n   * ğŸ”§ NEW: Update cross-sectional progress UI\n   */\n  updateCrossSectionalProgressUI() {\n    const progressIndicator = document.getElementById('auto-direction-progress');\n    const progressCurrent = document.getElementById('progress-current');\n    const progressTotal = document.getElementById('progress-total');\n    const progressFill = document.getElementById('auto-direction-progress-fill');\n    const progressModeInfo = document.getElementById('progress-mode-info');\n    \n    if (!this.crossSectionalState) {\n      if (progressIndicator) {\n        progressIndicator.style.display = 'none';\n      }\n      return;\n    }\n    \n    const { processedCount, totalCount, currentOrder, availableOrders } = this.crossSectionalState;\n    const progressPercentage = totalCount > 0 ? (processedCount / totalCount) * 100 : 0;\n    \n    if (progressIndicator) {\n      progressIndicator.style.display = 'block';\n    }\n    \n    if (progressCurrent) {\n      progressCurrent.textContent = processedCount;\n    }\n    \n    if (progressTotal) {\n      progressTotal.textContent = totalCount;\n    }\n    \n    if (progressFill) {\n      progressFill.style.width = `${progressPercentage}%`;\n      progressFill.className = 'progress-fill cross-sectional-indicator';\n    }\n    \n    if (progressModeInfo) {\n      const currentOrderIndex = availableOrders.indexOf(currentOrder);\n      progressModeInfo.textContent = `Order ${currentOrder} (${currentOrderIndex + 1}/${availableOrders.length})`;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: Get Auto Direction Progress (works for both modes)\n   * @returns {Object} Progress information\n   */\n  getAutoDirectionProgress() {\n    if (this.autoDirectionMode === 'cross-sectional' && this.crossSectionalState) {\n      const { processedCount, totalCount, currentOrder, availableOrders } = this.crossSectionalState;\n      \n      return {\n        total: totalCount,\n        completed: processedCount,\n        percentage: totalCount > 0 ? Math.round((processedCount / totalCount) * 100) : 0,\n        currentOrder: currentOrder,\n        totalOrders: availableOrders.length,\n        mode: 'cross-sectional'\n      };\n    } else if (this.autoDirectionMode === 'longitudinal' && this.state.isAutoDirectionMode) {\n      const total = this.state.autoDirectionKeypoints.length;\n      const completed = this.state.autoDirectionIndex;\n      \n      return {\n        total: total,\n        completed: completed,\n        percentage: total > 0 ? Math.round((completed / total) * 100) : 0,\n        mode: 'longitudinal'\n      };\n    }\n    \n    return {\n      total: 0,\n      completed: 0,\n      percentage: 0,\n      mode: this.autoDirectionMode\n    };\n  }\n\n  /**\n   * é€€å‡ºè‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©æ¨¡å¼\n   */\n  exitAutoDirectionMode() {\n    console.log('[è°ƒè¯•] exitAutoDirectionMode è¢«è°ƒç”¨', {\n      stackTrace: new Error().stack\n    });\n\n    // ğŸ”§ FIX: Store the user's mode preference before resetting\n    const userModePreference = this.autoDirectionMode;\n    console.log('[è°ƒè¯•] ä¿å­˜ç”¨æˆ·æ¨¡å¼åå¥½:', userModePreference);\n\n    this.state.isAutoDirectionMode = false;\n    this.state.autoDirectionKeypoints = [];\n    this.state.autoDirectionIndex = 0;\n\n    // æ¸…ç†æ–¹å‘é€‰æ‹©çŠ¶æ€ï¼Œä½†ä¸éœ€è¦å¼ºåˆ¶é€€å‡ºï¼ˆå› ä¸ºå·²ç»åœ¨é€€å‡ºäº†ï¼‰\n    this.state.selectedKeypoint = null;\n    this.state.isDirectionSelectionMode = false;\n    this.state.directionSelectionPoint = null;\n\n    // ğŸ”§ FIX: Only reset cross-sectional state if we're not in the middle of completion\n    // This prevents null reference errors during the completion process\n    if (this.autoDirectionMode === 'cross-sectional' && this.crossSectionalState) {\n      console.log('[è°ƒè¯•] å»¶è¿Ÿæ¸…ç† cross-sectional çŠ¶æ€ï¼Œè®©å®Œæˆæµç¨‹å¤„ç†');\n      // Don't reset cross-sectional state here - let completeCrossSectionalMode handle it\n      // But preserve the user's mode preference\n      this.autoDirectionMode = userModePreference;\n    } else {\n      // For non-cross-sectional modes or if state is already null, reset state but preserve mode preference\n      this.crossSectionalState = null;\n      // ğŸ”§ FIX: Don't reset autoDirectionMode to null - preserve user's choice\n      this.autoDirectionMode = userModePreference;\n    }\n\n    this.restoreNormalPreview();\n    this.render();\n\n    // ğŸ”§ FIX: Reset auto direction button state when exiting auto direction mode\n    this.resetAutoDirectionButton();\n\n    // ğŸ”§ FIX: Preserve the mode selector UI state\n    const modeSelector = document.getElementById('auto-direction-mode-selector');\n    if (modeSelector && userModePreference) {\n      modeSelector.value = userModePreference;\n      console.log('[è°ƒè¯•] æ¢å¤UIé€‰æ‹©å™¨çŠ¶æ€:', userModePreference);\n    }\n\n    console.log('Exited auto direction mode, preserved mode preference:', userModePreference);\n  }\n\n  /**\n   * ğŸ”§ NEW: å¼€å§‹è‡ªåŠ¨æ’åºæ¨¡å¼\n   */\n  startAutoOrderMode(typeId) {\n    console.log('[Auto Order] å¼€å§‹è‡ªåŠ¨æ’åºæ¨¡å¼ï¼Œç±»å‹:', typeId);\n    \n    if (this.state.isAutoOrderMode) {\n      console.log('[Auto Order] å·²åœ¨è‡ªåŠ¨æ’åºæ¨¡å¼ä¸­');\n      return;\n    }\n    \n    // è·å–æ‰€æœ‰è¯¥ç±»å‹çš„æ— åºå·æ ‡æ³¨\n    console.log('[Auto Order] æ­£åœ¨æŸ¥æ‰¾æ— åºå·æ ‡æ³¨...');\n    const unorderedAnnotations = this.getAllUnorderedAnnotationsOfType(typeId);\n    console.log('[Auto Order] æ‰¾åˆ°æ— åºå·æ ‡æ³¨:', unorderedAnnotations.length, 'ä¸ª');\n    \n    if (unorderedAnnotations.length === 0) {\n      console.log('[Auto Order] æ²¡æœ‰æ‰¾åˆ°æ— åºå·æ ‡æ³¨ï¼Œå°è¯•è·³è½¬åˆ°æœ‰å½“å‰ç±»å‹çš„ç¬¬ä¸€å¼ å›¾');\n      // å°è¯•è·³è½¬åˆ°æœ‰å½“å‰ç±»å‹æ ‡æ³¨çš„ç¬¬ä¸€å¼ å›¾\n      this.navigateToFirstImageWithType(typeId);\n      return;\n    }\n    \n    // æŒ‰å›¾ç‰‡åˆ†ç»„\n    console.log('[Auto Order] æŒ‰å›¾ç‰‡åˆ†ç»„...');\n    const imageGroups = this.groupAnnotationsByImage(unorderedAnnotations);\n    const imageIds = Object.keys(imageGroups).sort();\n    console.log('[Auto Order] æ‰¾åˆ°å›¾ç‰‡:', imageIds.length, 'ä¸ª', imageIds);\n    \n    if (imageIds.length === 0) {\n      console.log('[Auto Order] æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ’åºçš„å›¾ç‰‡ï¼Œé€€å‡º');\n      if (window.showError) {\n        window.showError('è‡ªåŠ¨æ’åºä¸å¯ç”¨', 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ’åºçš„å›¾ç‰‡');\n      }\n      return;\n    }\n    \n    // åˆå§‹åŒ–è‡ªåŠ¨æ’åºçŠ¶æ€\n    this.state.isAutoOrderMode = true;\n    this.state.autoOrderTypeId = typeId;\n    this.state.autoOrderCurrentOrder = 1;\n    this.state.autoOrderImages = imageIds;\n    this.state.autoOrderCurrentImageIndex = 0;\n    \n    // æ›´æ–°UI\n    this.updateAutoOrderButton(true);\n    this.updateAutoOrderStatus(`Ordering type \"${this.getTypeName(typeId)}\" #${this.state.autoOrderCurrentOrder}`);\n    \n    // ğŸ”§ FIX: å¼€å§‹æ—¶å¯¼èˆªåˆ°regular(builtin)æ ‡å·ä¸º1çš„ç¬¬ä¸€ä¸ªå›¾\n    this.navigateToImageWithBuiltinOrder(1); // ä¸éœ€è¦awaitï¼Œè®©å®ƒå¼‚æ­¥è¿è¡Œ\n    \n    console.log('[Auto Order] è‡ªåŠ¨æ’åºæ¨¡å¼å·²å¯åŠ¨ï¼Œå…±', imageIds.length, 'ä¸ªå›¾ç‰‡éœ€è¦å¤„ç†');\n  }\n  \n  /**\n   * ğŸ”§ NEW: åœæ­¢è‡ªåŠ¨æ’åºæ¨¡å¼\n   */\n  stopAutoOrderMode() {\n    console.log('[Auto Order] åœæ­¢è‡ªåŠ¨æ’åºæ¨¡å¼');\n    \n    this.state.isAutoOrderMode = false;\n    this.state.autoOrderTypeId = null;\n    this.state.autoOrderCurrentOrder = 1;\n    this.state.autoOrderImages = [];\n    this.state.autoOrderCurrentImageIndex = 0;\n    \n    this.updateAutoOrderButton(false);\n    this.updateAutoOrderStatus('');\n    \n    console.log('[Auto Order] è‡ªåŠ¨æ’åºæ¨¡å¼å·²åœæ­¢');\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¤„ç†Auto Orderä¸­çš„æ ‡æ³¨ç‚¹å‡»\n   */\n  handleAutoOrderAnnotationClick(annotation) {\n    if (!this.state.isAutoOrderMode || !annotation) return false;\n    \n    // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç±»å‹çš„æ ‡æ³¨\n    if (annotation.annotationType !== 'custom' || annotation.customTypeId !== this.state.autoOrderTypeId) {\n      return false;\n    }\n    \n    // å¦‚æœæ ‡æ³¨å·²æœ‰åºå·ï¼Œæ›´æ–°ä¸ºå½“å‰åºå·\n    const currentOrder = this.state.autoOrderCurrentOrder;\n    \n    if (annotation.order !== undefined) {\n      console.log('[Auto Order] æ›´æ–°å·²æœ‰åºå·æ ‡æ³¨ä»', annotation.order, 'åˆ°', currentOrder);\n    } else {\n      console.log('[Auto Order] ä¸ºæ— åºå·æ ‡æ³¨åˆ†é…åºå·', currentOrder);\n    }\n    \n    // æ›´æ–°æ ‡æ³¨çš„åºå·\n    annotation.order = currentOrder;\n    \n    // ä¿å­˜å½“å‰å›¾ç‰‡çš„æ ‡æ³¨\n    this.saveCurrentImageAnnotations();\n    \n    // åŒæ­¥åˆ°å…¶ä»–ç›¸åŒæ¤æ ªå’Œè§†è§’çš„å›¾ç‰‡\n    this.syncOrderAcrossImages(annotation, currentOrder);\n    \n    // è¿›å…¥ä¸‹ä¸€ä¸ªåºå·\n    this.proceedToNextOrder();\n    \n    return true;\n  }\n  \n  /**\n   * ğŸ”§ NEW: è¿›å…¥ä¸‹ä¸€ä¸ªåºå·\n   */\n  proceedToNextOrder() {\n    // ğŸ”§ FIX: ç”¨æˆ·å¸Œæœ›çš„æµç¨‹æ˜¯ï¼šæ ‡æ³¨ä¸€ä¸ªåç«‹å³åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå›¾ç‰‡\n    // å…ˆåˆ‡æ¢å›¾ç‰‡ï¼Œç»§ç»­å½“å‰åºå·\n    console.log('[Auto Order] å®Œæˆå½“å‰åºå·æ ‡æ³¨ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå›¾ç‰‡');\n    this.navigateToNextImageInAutoOrder();\n  }\n  \n  /**\n   * ğŸ”§ NEW: è·³è¿‡å½“å‰å›¾ç‰‡\n   */\n  skipCurrentImageInAutoOrder() {\n    if (!this.state.isAutoOrderMode) return;\n    \n    console.log('[Auto Order] è·³è¿‡å½“å‰å›¾ç‰‡');\n    this.navigateToNextUnorderedImage();\n  }\n\n  /**\n   * é€šçŸ¥é¢„è§ˆç®¡ç†å™¨æ˜¾ç¤ºé€‰ä¸­å…³é”®ç‚¹çš„é¢„è§ˆ\n   */\n  notifySelectedKeypointPreview(keypoint) {\n    const branchPointPreviewManager = window.PlantAnnotationTool?.branchPointPreviewManager;\n    \n    if (branchPointPreviewManager && keypoint && keypoint.order) {\n      branchPointPreviewManager.showSpecificOrderPreview(keypoint.order);\n    }\n  }\n\n  /**\n   * æ¢å¤æ­£å¸¸çš„é¢„è§ˆæ˜¾ç¤º\n   */\n  restoreNormalPreview() {\n    // é€šè¿‡å…¨å±€å¯¹è±¡è®¿é—®åˆ†æ”¯ç‚¹é¢„è§ˆç®¡ç†å™¨\n    const branchPointPreviewManager = window.PlantAnnotationTool?.branchPointPreviewManager;\n    \n    if (branchPointPreviewManager) {\n      // æ¢å¤åˆ°æ˜¾ç¤ºä¸‹ä¸€ä¸ªè¦æ ‡æ³¨ç¼–å·çš„é¢„è§ˆ\n      branchPointPreviewManager.restoreNormalPreview();\n    }\n  }\n\n  /**\n   * å¤„ç†å³é”®èœå•\n   */\n  handleContextMenu(event) {\n    event.preventDefault();\n    \n    const mousePos = this.getMousePos(event);\n    \n    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è‡ªå®šä¹‰æ ‡æ³¨\n    const clickedCustomAnnotation = this.getCustomAnnotationAt(mousePos);\n    if (clickedCustomAnnotation) {\n      this.removeCustomAnnotation(clickedCustomAnnotation);\n      return;\n    }\n    \n    // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰æ ‡æ³¨ï¼Œæ£€æŸ¥å¸¸è§„å…³é”®ç‚¹\n    const clickedKeypoint = this.getKeypointAt(mousePos);\n    if (clickedKeypoint) {\n      this.removeKeypoint(clickedKeypoint);\n      return;\n    }\n    \n    // å³é”®ç‚¹å‡»ç©ºç™½åŒºåŸŸ\n    console.log('[è°ƒè¯•] å³é”®ç‚¹å‡»ç©ºç™½åŒºåŸŸ');\n    \n    // ğŸ”§ NEW: Auto Orderæ¨¡å¼ä¸‹å³é”®è·³è¿‡å½“å‰å›¾ç‰‡\n    if (this.state.isAutoOrderMode) {\n      console.log('[Auto Order] å³é”®è·³è¿‡å½“å‰å›¾ç‰‡');\n      this.skipCurrentImageInAutoOrder();\n    } else {\n      // å¸¸è§„æ¨¡å¼ï¼šæ¸…ç©ºæ‰€æœ‰é€‰ä¸­çŠ¶æ€\n      this.clearAllSelections();\n    }\n  }\n  \n  /**\n   * æ¸…ç©ºæ‰€æœ‰é€‰ä¸­çŠ¶æ€\n   */\n  clearAllSelections() {\n    // æ¸…ç©ºä¸»å·¥å…·ç±»çš„é€‰ä¸­çŠ¶æ€\n    this.state.selectedKeypoint = null;\n    this.state.isDirectionSelectionMode = false;\n    this.state.directionSelectionPoint = null;\n    \n    // æ¸…ç©ºæ¸²æŸ“å™¨çš„é€‰ä¸­çŠ¶æ€\n    if (this.customAnnotationRenderer) {\n      this.customAnnotationRenderer.clearSelection();\n    }\n    \n    // å¦‚æœæ­£åœ¨çˆ¶èŠ‚ç‚¹é€‰æ‹©æ¨¡å¼ï¼Œä¹Ÿå–æ¶ˆ\n    if (this.state.isSelectingParent) {\n      this.disableParentSelectionMode();\n    }\n    \n    // é‡æ–°æ¸²æŸ“\n    this.render();\n    console.log('[è°ƒè¯•] å·²æ¸…ç©ºæ‰€æœ‰é€‰ä¸­çŠ¶æ€');\n  }\n\n  /**\n   * å¤„ç†æ»šè½®ç¼©æ”¾\n   */\n  handleWheel(event) {\n    event.preventDefault();\n    \n    // ğŸ”§ NEW: å¦‚æœå¤„äºæ–¹å‘æ•°é‡æ¨¡å¼ï¼Œç”¨æ»šè½®è°ƒæ•´æ–¹å‘æ•°é‡\n    if (this.state.isDirectionCountMode) {\n      this.handleScrollWheel(event);\n      return;\n    }\n    \n    const mousePos = this.getMousePos(event);\n    const delta = -event.deltaY;\n    const zoomFactor = 1 + (delta > 0 ? this.options.zoomSpeed : -this.options.zoomSpeed);\n    \n    this.zoomAt(mousePos.x, mousePos.y, zoomFactor);\n  }\n\n  /**\n   * åœ¨æŒ‡å®šç‚¹ç¼©æ”¾\n   */\n  zoomAt(x, y, factor) {\n    const newScale = this.state.scale * factor;\n    \n    // é™åˆ¶ç¼©æ”¾èŒƒå›´\n    if (newScale < this.options.minZoom || newScale > this.options.maxZoom) {\n      return;\n    }\n    \n    // è®¡ç®—ç¼©æ”¾åçš„ä½ç§»\n    this.state.translateX = x - (x - this.state.translateX) * factor;\n    this.state.translateY = y - (y - this.state.translateY) * factor;\n    this.state.scale = newScale;\n    \n    this.updateZoomInfo();\n    this.render();\n  }\n\n  /**\n   * å¤„ç†é”®ç›˜æŒ‰ä¸‹\n   */\n  handleKeyDown(event) {\n    console.log('[è°ƒè¯•] é”®ç›˜äº‹ä»¶:', event.key, 'target:', event.target.tagName, 'focused element:', document.activeElement?.tagName);\n    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {\n      console.log('[è°ƒè¯•] åœ¨è¾“å…¥æ¡†ä¸­ï¼Œå¿½ç•¥é”®ç›˜äº‹ä»¶');\n      return; // åœ¨è¾“å…¥æ¡†ä¸­æ—¶ä¸å¤„ç†\n    }\n    \n    switch (event.key) {\n      case ' ':\n        event.preventDefault();\n        // ç©ºæ ¼é”®å‡†å¤‡å¹³ç§»\n        break;\n        \n      case 'r':\n      case 'R':\n        event.preventDefault();\n        this.resetView();\n        break;\n        \n      case '1':\n        event.preventDefault();\n        this.setZoom(1);\n        break;\n        \n      case 'z':\n        if (event.ctrlKey || event.metaKey) {\n          event.preventDefault();\n          if (event.shiftKey) {\n            this.redo();\n          } else {\n            this.undo();\n          }\n        }\n        break;\n        \n      case 'y':\n        if (event.ctrlKey || event.metaKey) {\n          event.preventDefault();\n          this.redo();\n        }\n        break;\n        \n      case 'e':\n      case 'E':\n        event.preventDefault();\n        console.log('[è°ƒè¯•] Eé”®è¢«æŒ‰ä¸‹ - çˆ¶èŠ‚ç‚¹é€‰æ‹©æ¨¡å¼åˆ‡æ¢');\n        \n        // åˆ‡æ¢çˆ¶èŠ‚ç‚¹é€‰æ‹©æ¨¡å¼ï¼ˆéœ€è¦å·²æœ‰é€‰ä¸­ç‚¹ï¼Œä¸”è¯¥ç±»å‹é…ç½®äº†å…³è”çˆ¶ç±»å‹ï¼‰\n        if (this.state.isSelectingParent) {\n          console.log('[è°ƒè¯•] å–æ¶ˆçˆ¶èŠ‚ç‚¹é€‰æ‹©æ¨¡å¼');\n          this.disableParentSelectionMode();\n          if (window.PlantAnnotationTool?.showInfo) {\n            window.PlantAnnotationTool.showInfo('Parent Link', 'å·²å–æ¶ˆçˆ¶èŠ‚ç‚¹é€‰æ‹©');\n          }\n          break;\n        }\n        \n        // éœ€è¦å½“å‰é€‰ä¸­å…³é”®ç‚¹\n        const selected = this.state.selectedKeypoint;\n        console.log('[è°ƒè¯•] å½“å‰é€‰ä¸­æ ‡æ³¨:', selected?.id, 'type:', selected?.annotationType, 'customTypeId:', selected?.customTypeId);\n        \n        if (!selected || selected.annotationType !== 'custom' || !selected.customTypeId) {\n          console.log('[è°ƒè¯•] æ— æœ‰æ•ˆé€‰ä¸­æ ‡æ³¨ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º');\n          if (window.PlantAnnotationTool?.showError) {\n            window.PlantAnnotationTool.showError('æ— æ³•è¿›å…¥çˆ¶èŠ‚ç‚¹é€‰æ‹©', 'è¯·å…ˆé€‰ä¸­ä¸€ä¸ªå¯å…³è”çˆ¶èŠ‚ç‚¹çš„è‡ªå®šä¹‰æ ‡æ³¨');\n          } else {\n            console.log('[è°ƒè¯•] æ— æ³•è¿›å…¥çˆ¶èŠ‚ç‚¹é€‰æ‹© - è¯·å…ˆé€‰ä¸­ä¸€ä¸ªå¯å…³è”çˆ¶èŠ‚ç‚¹çš„è‡ªå®šä¹‰æ ‡æ³¨');\n          }\n          break;\n        }\n        \n        const childType = this.getCustomType(selected.customTypeId);\n        const associateId = childType?.metadata?.associateTypeId;\n        console.log('[è°ƒè¯•] å­ç±»å‹:', childType?.name, 'å…³è”çˆ¶ç±»å‹ID:', associateId);\n        \n        if (!associateId) {\n          console.log('[è°ƒè¯•] æœªé…ç½®çˆ¶ç±»å‹ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º');\n          if (window.PlantAnnotationTool?.showError) {\n            window.PlantAnnotationTool.showError('æœªé…ç½®çˆ¶ç±»å‹', 'è¯¥æ ‡æ³¨ç±»å‹æœªåœ¨ Annotation Type Setting ä¸­è®¾ç½®çˆ¶ç±»å‹');\n          } else {\n            console.log('[è°ƒè¯•] æœªé…ç½®çˆ¶ç±»å‹ - è¯¥æ ‡æ³¨ç±»å‹æœªåœ¨ Annotation Type Setting ä¸­è®¾ç½®çˆ¶ç±»å‹');\n          }\n          break;\n        }\n        \n        console.log('[è°ƒè¯•] å¯åŠ¨çˆ¶èŠ‚ç‚¹é€‰æ‹©æ¨¡å¼');\n        this.enableParentSelectionMode(selected.customTypeId);\n        if (window.PlantAnnotationTool?.showInfo) {\n          const parentTypeName = this.getCustomType(associateId)?.name || 'çˆ¶ç±»å‹';\n          window.PlantAnnotationTool.showInfo('Parent Link', `å·²è¿›å…¥çˆ¶èŠ‚ç‚¹é€‰æ‹©æ¨¡å¼ï¼šç‚¹å‡»ä¸€ä¸ª\"${parentTypeName}\"æ ‡æ³¨ä»¥å»ºç«‹å…³è”`);\n        } else {\n          const parentTypeName = this.getCustomType(associateId)?.name || 'çˆ¶ç±»å‹';\n          console.log(`[è°ƒè¯•] å·²è¿›å…¥çˆ¶èŠ‚ç‚¹é€‰æ‹©æ¨¡å¼ï¼šç‚¹å‡»ä¸€ä¸ª\"${parentTypeName}\"æ ‡æ³¨ä»¥å»ºç«‹å…³è”`);\n        }\n        break;\n    }\n  }\n\n  /**\n   * å¤„ç†é”®ç›˜æŠ¬èµ·\n   */\n  handleKeyUp(event) {\n    // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†é”®ç›˜æŠ¬èµ·äº‹ä»¶\n  }\n\n  /**\n   * è®¾ç½®ç¼©æ”¾çº§åˆ«\n   */\n  setZoom(scale) {\n    if (!this.imageElement || !this.imageLoaded) return;\n    \n    const centerX = this.canvas.width / 2;\n    const centerY = this.canvas.height / 2;\n    \n    this.zoomAt(centerX, centerY, scale / this.state.scale);\n  }\n\n  /**\n   * æ›´æ–°ç¼©æ”¾ä¿¡æ¯æ˜¾ç¤º\n   */\n  updateZoomInfo() {\n    const zoomElement = document.getElementById('zoom-level');\n    if (zoomElement) {\n      zoomElement.textContent = Math.round(this.state.scale * 100) + '%';\n    }\n  }\n\n  /**\n   * è·å–æŒ‡å®šä½ç½®çš„æ ‡æ³¨ç‚¹\n   */\n  getKeypointAt(screenPos) {\n    const threshold = this.options.baseKeypointRadius + 5;\n    \n    return this.keypoints.find(keypoint => {\n      const keypointScreen = this.imageToScreen(keypoint.x, keypoint.y);\n      const distance = Math.sqrt(\n        Math.pow(screenPos.x - keypointScreen.x, 2) +\n        Math.pow(screenPos.y - keypointScreen.y, 2)\n      );\n      return distance <= threshold;\n    });\n  }\n\n  /**\n   * æ·»åŠ æ ‡æ³¨ç‚¹ï¼ˆå‘åå…¼å®¹æ–¹æ³•ï¼‰\n   */\n  addKeypoint(screenPos, direction = 'right') {\n    // ğŸ”§ FIX: Use comprehensive bounds checking for annotation creation\n    if (!this.canCreateAnnotationAt(screenPos.x, screenPos.y)) {\n      console.warn('[AnnotationTool] Cannot add keypoint: position is outside valid annotation area');\n      return;\n    }\n    \n    const imagePos = this.screenToImage(screenPos.x, screenPos.y);\n    this.addKeypointWithDirection(imagePos.x, imagePos.y, direction);\n  }\n\n  /**\n   * æ·»åŠ å¸¦æ–¹å‘çš„æ ‡æ³¨ç‚¹ï¼ˆæ”¯æŒè‡ªå®šä¹‰ç±»å‹ï¼‰\n   */\n  addKeypointWithDirection(x, y, direction, customTypeId = null, width = null, height = null) {\n    // ğŸ”§ FIX: Ensure image is loaded before creating keypoints\n    if (!this.imageElement || !this.imageLoaded) {\n      console.warn('[AnnotationTool] Cannot add keypoint: no image loaded');\n      return;\n    }\n\n    // ğŸ”„ NEW: If in custom mode and a point type is selected, default to that type\n    if (!customTypeId && this.customAnnotationManager && this.customAnnotationManager.isInCustomMode()) {\n      const currentType = this.customAnnotationManager.getCurrentCustomType();\n      if (currentType && (currentType.type === 'point' || currentType.type === 'region')) {\n        customTypeId = currentType.id;\n        // Respect isDirectional: if false, strip direction\n        if (!currentType.metadata || currentType.metadata.isDirectional === false) {\n          direction = null;\n        }\n      }\n    }\n\n    // ğŸ”§ FIX: ä½¿ç”¨ç±»å‹ç‰¹å®šçš„åºå·åˆ†é…ï¼Œæ”¯æŒæ— åºå·æ¨¡å¼\n    let order;\n    if (this.state.isUnorderedMode) {\n      order = null; // æ— åºå·æ ‡æ³¨\n    } else {\n      order = customTypeId ? this.findNextAvailableOrderForType(customTypeId) : this.findNextAvailableOrder();\n    }\n\n    // ç»Ÿä¸€æ–¹å‘æ ¼å¼ï¼šå°†ä¼ ç»Ÿçš„left/rightè½¬æ¢ä¸ºè§’åº¦\n    let normalizedDirection = direction;\n    if (direction === 'left') {\n      normalizedDirection = 180; // å·¦ä¾§ä¸º180åº¦\n    } else if (direction === 'right') {\n      normalizedDirection = 0;   // å³ä¾§ä¸º0åº¦\n    } else if (typeof direction === 'number') {\n      normalizedDirection = direction;\n    } else if (direction === undefined) {\n      // ä¿æŒ undefinedï¼Œä¸å†™å…¥ direction å­—æ®µ\n      normalizedDirection = undefined;\n    } else {\n      normalizedDirection = 0;   // é»˜è®¤ä¸ºå³ä¾§\n    }\n\n    const keypoint = {\n      id: Date.now(),\n      x: x,\n      y: y,\n      timestamp: new Date().toISOString(),\n      ...(normalizedDirection !== undefined && { direction: normalizedDirection }),\n      ...(normalizedDirection !== undefined && { directionType: 'angle' }),\n      ...(order !== null && { order }),  // åªæœ‰énullæ—¶æ‰æ·»åŠ åºå·å­—æ®µ\n      \n      // ğŸ”„ NEW: ç»Ÿä¸€æ ‡æ³¨ç³»ç»Ÿ - æ”¯æŒè‡ªå®šä¹‰ç±»å‹\n      annotationType: customTypeId ? 'custom' : 'regular',\n      ...(customTypeId && { customTypeId }),\n      ...(typeof width === 'number' && { width }),\n      ...(typeof height === 'number' && { height })\n    };\n\n    this.keypoints.push(keypoint);\n    this.saveState();\n    this.render();\n\n    // è‡ªåŠ¨ä¿å­˜åˆ°å½“å‰å›¾åƒ\n    this.autoSaveCurrentImage();\n\n    // ğŸ”„ NEW: å®æ—¶åŒæ­¥ - æ ‡æ³¨ç‚¹æ·»åŠ \n    this.triggerRealTimeSync('ADD_KEYPOINT', keypoint);\n\n    // åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n    this.syncBranchPointPreview();\n\n    // ğŸ”§ FIX: Set flag to indicate we just created a new point\n    this.justCreatedNewPoint = true;\n\n    // ğŸ”§ FIX: Only move to expected position if auto-move is enabled\n    if (this.state.autoMoveToExpectedPosition) {\n      this.moveToNextExpectedPosition();\n      this.justCreatedNewPoint = false; // Reset flag after moving\n    }\n\n    const typeDesc = customTypeId ? `custom(${customTypeId})` : 'regular';\n    const directionDesc = typeof normalizedDirection === 'number' ? `${normalizedDirection}Â°` : normalizedDirection;\n    console.log(`Added ${typeDesc} keypoint #${order} at (${x.toFixed(1)}, ${y.toFixed(1)}) with direction ${directionDesc}`);\n    \n    return keypoint;\n  }\n\n  /**\n   * ğŸ”„ NEW: æ·»åŠ è‡ªå®šä¹‰ç‚¹æ ‡æ³¨ï¼ˆç»Ÿä¸€åˆ°keypointsç³»ç»Ÿï¼‰\n   */\n  addCustomPointAnnotation(x, y, customTypeId) {\n    // Use default angle from type metadata if provided\n    let direction = null;\n    try {\n      const customType = this.getCustomType(customTypeId);\n      if (customType && customType.metadata && typeof customType.metadata.defaultAngle === 'number') {\n        direction = customType.metadata.defaultAngle;\n      }\n    } catch (e) {\n      // Fallback to null (will default to 0Â° in addKeypointWithDirection)\n    }\n    return this.addKeypointWithDirection(x, y, direction, customTypeId);\n  }\n  \n  /**\n   * ğŸ”„ NEW: æ·»åŠ è‡ªå®šä¹‰åŒºåŸŸæ ‡æ³¨ï¼ˆç»Ÿä¸€åˆ°keypointsç³»ç»Ÿï¼‰\n   */\n  addCustomRegionAnnotation(x, y, width, height, customTypeId) {\n    return this.addKeypointWithDirection(x, y, null, customTypeId, width, height);\n  }\n  \n  /**\n   * ğŸ”„ NEW: è·å–è‡ªå®šä¹‰ç±»å‹å®šä¹‰\n   */\n  getCustomType(customTypeId) {\n    // ğŸ”§ FIX: ç›´æ¥ä»CustomAnnotationManagerè·å–è‡ªå®šä¹‰ç±»å‹\n    if (this.customAnnotationManager) {\n      return this.customAnnotationManager.getCustomType(customTypeId);\n    }\n    return this.customTypes?.get(customTypeId) || null;\n  }\n  \n  /**\n   * ğŸ”„ NEW: è®¾ç½®è‡ªå®šä¹‰ç±»å‹å®šä¹‰\n   */\n  setCustomTypes(customTypes) {\n    this.customTypes = customTypes;\n  }\n  \n  /**\n   * ğŸ”„ NEW: å¤„ç†è‡ªå®šä¹‰æ ‡æ³¨æ¨¡å¼ä¸‹çš„ç‚¹å‡»ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼‰\n   */\n  handleUnifiedCustomAnnotationMode(mousePos) {\n    if (!this.customAnnotationManager) {\n      console.warn('Custom annotation manager not available');\n      return;\n    }\n    \n    try {\n      const customType = this.customAnnotationManager.getCurrentCustomType();\n      if (!customType) {\n        console.warn('No custom type selected');\n        return;\n      }\n      \n      const imagePos = this.screenToImage(mousePos.x, mousePos.y);\n      \n      if (customType.type === 'point') {\n        // åˆ›å»ºè‡ªå®šä¹‰ç‚¹æ ‡æ³¨\n        const keypoint = this.addCustomPointAnnotation(imagePos.x, imagePos.y, customType.id);\n        if (keypoint) {\n          console.log('Created unified custom point annotation:', keypoint);\n        }\n      } else if (customType.type === 'region') {\n        // å¼€å§‹æ‹–æ‹½åŒºåŸŸæ ‡æ³¨\n        this.startUnifiedCustomRegionDrag(mousePos, customType.id);\n      }\n    } catch (error) {\n      console.error('Failed to handle unified custom annotation mode:', error);\n    }\n  }\n  \n  /**\n   * ğŸ”„ NEW: å¼€å§‹ç»Ÿä¸€çš„è‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½\n   */\n  startUnifiedCustomRegionDrag(mousePos, customTypeId) {\n    if (!this.canCreateAnnotationAt(mousePos.x, mousePos.y)) {\n      console.warn('Cannot create custom region annotation: position is outside valid area');\n      return;\n    }\n\n    this.state.isCustomRegionDragging = true;\n    this.state.customRegionStartPoint = mousePos;\n    this.state.customRegionCurrentPoint = mousePos;\n    this.state.customRegionTypeId = customTypeId;\n    this.canvas.style.cursor = 'crosshair';\n    \n    console.log('Started unified custom region drag at:', mousePos);\n  }\n  \n  /**\n   * ğŸ”„ NEW: å®Œæˆç»Ÿä¸€çš„è‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½\n   */\n  finishUnifiedCustomRegionDrag() {\n    if (!this.state.isCustomRegionDragging || !this.state.customRegionStartPoint || !this.state.customRegionCurrentPoint) {\n      this.resetCustomRegionDrag();\n      return;\n    }\n\n    const startPos = this.screenToImage(this.state.customRegionStartPoint.x, this.state.customRegionStartPoint.y);\n    const endPos = this.screenToImage(this.state.customRegionCurrentPoint.x, this.state.customRegionCurrentPoint.y);\n\n    // æ£€æŸ¥æ‹–æ‹½è·ç¦»æ˜¯å¦è¶³å¤Ÿï¼ˆä»¥å±å¹•åƒç´ ä¸ºå‡†ï¼Œé¿å…é«˜å€ç¼©æ”¾ä¸‹è¯¯åˆ¤ï¼‰\n    const startScreen = this.state.customRegionStartPoint;\n    const currentScreen = this.state.customRegionCurrentPoint;\n    const screenWidth = Math.abs(currentScreen.x - startScreen.x);\n    const screenHeight = Math.abs(currentScreen.y - startScreen.y);\n    const minScreenSize = 8; // å±å¹•åƒç´ é˜ˆå€¼\n\n    if (screenWidth < minScreenSize || screenHeight < minScreenSize) {\n      console.log('Region too small, ignoring');\n      this.resetCustomRegionDrag();\n      return;\n    }\n\n    // è®¡ç®—åŒºåŸŸä½ç½®ä¸å°ºå¯¸ï¼ˆå›¾åƒåæ ‡ï¼‰\n    const x = Math.min(startPos.x, endPos.x);\n    const y = Math.min(startPos.y, endPos.y);\n    const width = Math.abs(endPos.x - startPos.x);\n    const height = Math.abs(endPos.y - startPos.y);\n    \n    // åˆ›å»ºè‡ªå®šä¹‰åŒºåŸŸæ ‡æ³¨\n    const keypoint = this.addCustomRegionAnnotation(x, y, width, height, this.state.customRegionTypeId);\n    \n    if (keypoint) {\n      console.log('Created unified custom region annotation:', keypoint);\n    }\n\n    this.resetCustomRegionDrag();\n  }\n  \n  /**\n   * ğŸ”§ NEW: ä¸ºç‰¹å®šè‡ªå®šä¹‰ç±»å‹æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç¼–å·ï¼ˆç‹¬ç«‹è®¡æ•°ï¼‰\n   */\n  findNextAvailableOrderForType(customTypeId) {\n    // åªè€ƒè™‘ç›¸åŒè‡ªå®šä¹‰ç±»å‹çš„æ ‡æ³¨\n    const sameTypeKeypoints = this.keypoints.filter(kp => \n      kp.annotationType === 'custom' && kp.customTypeId === customTypeId\n    );\n    \n    if (sameTypeKeypoints.length === 0) {\n      return 1;\n    }\n    \n    // è·å–è¯¥ç±»å‹æ‰€æœ‰ç°æœ‰çš„ç¼–å·å¹¶æ’åº\n    const existingOrders = sameTypeKeypoints\n      .map(kp => kp.order || 0)\n      .filter(order => order > 0)\n      .sort((a, b) => a - b);\n    \n    // æ‰¾åˆ°æœ€å°çš„ç¼ºå¤±ç¼–å·\n    for (let i = 1; i <= existingOrders.length + 1; i++) {\n      if (!existingOrders.includes(i)) {\n        return i;\n      }\n    }\n    \n    // å¦‚æœæ²¡æœ‰ç¼ºå¤±ï¼Œè¿”å›ä¸‹ä¸€ä¸ªç¼–å·\n    return existingOrders.length + 1;\n  }\n\n  /**\n   * æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç¼–å·ï¼ˆæœ€å°çš„ç¼ºå¤±ç¼–å·ï¼‰- åªè€ƒè™‘å¸¸è§„æ ‡æ³¨\n   */\n  findNextAvailableOrder() {\n    // ğŸ”§ FIX: åªè€ƒè™‘å¸¸è§„æ ‡æ³¨çš„åºå·ï¼Œå®ç°ç‹¬ç«‹è®¡æ•°\n    // ğŸ› BUGFIX: Include fallback for annotations without annotationType field (loaded from storage)\n    const regularKeypoints = this.keypoints.filter(kp => \n      kp.annotationType === 'regular' || !kp.annotationType);\n    \n    if (regularKeypoints.length === 0) {\n      return 1;\n    }\n    \n    // è·å–æ‰€æœ‰ç°æœ‰çš„ç¼–å·å¹¶æ’åº\n    const existingOrders = regularKeypoints\n      .map(kp => kp.order || 0)\n      .filter(order => order > 0)\n      .sort((a, b) => a - b);\n    \n    // æ‰¾åˆ°æœ€å°çš„ç¼ºå¤±ç¼–å·\n    for (let i = 1; i <= existingOrders.length + 1; i++) {\n      if (!existingOrders.includes(i)) {\n        return i;\n      }\n    }\n    \n    // å¦‚æœæ²¡æœ‰ç¼ºå¤±ï¼Œè¿”å›ä¸‹ä¸€ä¸ªç¼–å·\n    return existingOrders.length + 1;\n  }\n\n  /**\n   * åˆ é™¤æ ‡æ³¨ç‚¹\n   */\n  removeKeypoint(keypoint) {\n    const index = this.keypoints.indexOf(keypoint);\n    if (index !== -1) {\n      const removed = this.keypoints.splice(index, 1)[0];\n      \n      // ä¸å†é‡æ–°æ•´ç†åºå·ï¼Œä¿æŒå…¶ä»–æ ‡æ³¨ç‚¹çš„ç¼–å·ä¸å˜\n      // this.reorderKeypoints(); // ç§»é™¤è¿™è¡Œ\n      \n      this.saveState();\n      this.render();\n      \n      // è§¦å‘å®æ—¶åŒæ­¥åˆ é™¤ï¼ˆå¦‚æœå¯ç”¨ï¼‰\n      this.triggerRealTimeSync('DELETE_KEYPOINT', removed);\n      \n      // è‡ªåŠ¨ä¿å­˜åˆ°å½“å‰å›¾åƒ\n      this.autoSaveCurrentImage();\n      \n      // åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n      this.syncBranchPointPreview();\n      \n      console.log(`Removed keypoint #${removed.order || 'unknown'} (id: ${keypoint.id})`);\n      console.log(`ä¸‹ä¸€ä¸ªæ–°å¢æ ‡æ³¨ç‚¹å°†ä½¿ç”¨ç¼–å·: ${this.findNextAvailableOrder()}`);\n    }\n  }\n\n  /**\n   * æ¸…ç©ºæ‰€æœ‰æ ‡æ³¨ç‚¹\n   */\n  clearKeypoints() {\n    if (this.keypoints.length > 0) {\n      this.keypoints = [];\n      this.saveState();\n      this.render();\n      \n      // è‡ªåŠ¨ä¿å­˜åˆ°å½“å‰å›¾åƒï¼ˆæ¸…ç©ºçŠ¶æ€ï¼‰\n      this.autoSaveCurrentImage();\n      \n      // åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n      this.syncBranchPointPreview();\n      \n      console.log('Cleared all keypoints (unified system)');\n    }\n  }\n\n  /**\n   * æ¸…ç©ºæ‰€æœ‰æ ‡æ³¨ç‚¹ä½†ä¸è§¦å‘è‡ªåŠ¨ä¿å­˜ - ç”¨äºå·¥ä½œåŒºæ¸…ç†ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼‰\n   */\n  clearKeypointsWithoutSave() {\n    if (this.keypoints.length > 0) {\n      this.keypoints = [];\n      this.saveState();\n      this.render();\n      \n      // åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆä½†ä¸ä¿å­˜\n      this.syncBranchPointPreview();\n      \n      console.log('Cleared all keypoints (without auto-save, unified system)');\n    }\n  }\n\n  /**\n   * é‡æ–°æ•´ç†æ ‡æ³¨ç‚¹åºå·ï¼Œç¡®ä¿åºå·è¿ç»­\n   */\n  reorderKeypoints() {\n    // å…ˆæŒ‰ç…§å½“å‰åºå·æ’åºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰\n    this.keypoints.sort((a, b) => {\n      const orderA = a.order || 0;\n      const orderB = b.order || 0;\n      return orderA - orderB;\n    });\n    \n    // é‡æ–°åˆ†é…è¿ç»­çš„åºå·\n    for (let i = 0; i < this.keypoints.length; i++) {\n      this.keypoints[i].order = i + 1;\n    }\n    \n    console.log(`Reordered ${this.keypoints.length} keypoints`);\n  }\n\n  /**\n   * ä¿å­˜çŠ¶æ€åˆ°å†å²è®°å½•\n   */\n  saveState() {\n    const state = {\n      keypoints: JSON.parse(JSON.stringify(this.keypoints)),\n      timestamp: Date.now()\n    };\n    \n    // ç§»é™¤å½“å‰ä½ç½®ä¹‹åçš„å†å²è®°å½•\n    this.history = this.history.slice(0, this.historyIndex + 1);\n    \n    // æ·»åŠ æ–°çŠ¶æ€\n    this.history.push(state);\n    this.historyIndex = this.history.length - 1;\n    \n    // é™åˆ¶å†å²è®°å½•å¤§å°\n    if (this.history.length > this.maxHistorySize) {\n      this.history.shift();\n      this.historyIndex--;\n    }\n  }\n\n  /**\n   * æ’¤é”€\n   */\n  undo() {\n    if (this.historyIndex > 0) {\n      this.historyIndex--;\n      const state = this.history[this.historyIndex];\n      this.keypoints = JSON.parse(JSON.stringify(state.keypoints));\n      this.render();\n      \n      // è‡ªåŠ¨ä¿å­˜åˆ°å½“å‰å›¾åƒ\n      this.autoSaveCurrentImage();\n      \n      // åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n      this.syncBranchPointPreview();\n      \n      console.log('Undo');\n    }\n  }\n\n  /**\n   * é‡åš\n   */\n  redo() {\n    if (this.historyIndex < this.history.length - 1) {\n      this.historyIndex++;\n      const state = this.history[this.historyIndex];\n      this.keypoints = JSON.parse(JSON.stringify(state.keypoints));\n      this.render();\n      \n      // è‡ªåŠ¨ä¿å­˜åˆ°å½“å‰å›¾åƒ\n      this.autoSaveCurrentImage();\n      \n      // åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n      this.syncBranchPointPreview();\n      \n      console.log('Redo');\n    }\n  }\n\n  /**\n   * è·å–æ ‡æ³¨æ•°æ®ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼ŒåŒ…å«è‡ªå®šä¹‰æ ‡æ³¨ï¼‰\n   */\n  getAnnotationData() {\n    return {\n      keypoints: this.keypoints.map(kp => ({...kp})), // åŒ…å«æ‰€æœ‰æ ‡æ³¨ï¼šå¸¸è§„ + è‡ªå®šä¹‰\n      imageInfo: this.currentImage ? {\n        name: this.currentImage.name,\n        width: this.imageElement?.width,\n        height: this.imageElement?.height\n      } : null,\n      viewState: {\n        scale: this.state.scale,\n        translateX: this.state.translateX,\n        translateY: this.state.translateY\n      }\n    };\n  }\n\n  /**\n   * åŠ è½½æ ‡æ³¨æ•°æ®ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼ŒåŒ…å«è‡ªå®šä¹‰æ ‡æ³¨ï¼‰\n   */\n  loadAnnotationData(data) {\n    if (data.keypoints) {\n      this.keypoints = data.keypoints.map(kp => ({...kp})); // åŒ…å«æ‰€æœ‰æ ‡æ³¨ï¼šå¸¸è§„ + è‡ªå®šä¹‰\n\n      // ğŸ”§ DISABLED: ä¸ºæ²¡æœ‰åºå·çš„æ—§æ•°æ®æ·»åŠ åºå·ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰\n      // IMPORTANT: This automatic renumbering was causing order inconsistencies\n      // across frames in real-time sync. Annotations should maintain their\n      // original order numbers to ensure consistent synchronization.\n      // this.ensureKeypointOrders();\n      \n      console.log(`ğŸ”„ Loaded ${this.keypoints.length} keypoints (auto-renumbering disabled)`);\n    }\n\n    if (data.viewState) {\n      this.state.scale = data.viewState.scale || 1;\n      this.state.translateX = data.viewState.translateX || 0;\n      this.state.translateY = data.viewState.translateY || 0;\n      this.updateZoomInfo();\n    }\n\n    this.saveState();\n    this.render();\n  }\n\n  /**\n   * ç¡®ä¿æ‰€æœ‰æ ‡æ³¨ç‚¹éƒ½æœ‰åºå·ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰- ç»Ÿä¸€ç³»ç»Ÿç‰ˆæœ¬\n   */\n  ensureKeypointOrders() {\n    // ğŸ”§ FIX: ä½¿ç”¨ç±»å‹æ„ŸçŸ¥çš„åºå·æ£€æŸ¥ï¼Œä¸PlantDataManagerä¿æŒä¸€è‡´\n    \n    // æŒ‰ç±»å‹åˆ†ç»„æ ‡æ³¨ç‚¹\n    const annotationsByType = {};\n    \n    this.keypoints.forEach(keypoint => {\n      const typeKey = keypoint.annotationType === 'custom' \n        ? `custom:${keypoint.customTypeId || 'unknown'}`\n        : 'regular';\n      \n      if (!annotationsByType[typeKey]) {\n        annotationsByType[typeKey] = [];\n      }\n      annotationsByType[typeKey].push(keypoint);\n    });\n    \n    let hasOrderIssues = false;\n    let totalFixed = 0;\n    \n    // ä¸ºæ¯ä¸ªç±»å‹ç‹¬ç«‹æ£€æŸ¥åºå·\n    Object.entries(annotationsByType).forEach(([typeKey, typeAnnotations]) => {\n      let typeHasIssues = false;\n      \n      // æ£€æŸ¥è¯¥ç±»å‹æ˜¯å¦æœ‰åºå·é—®é¢˜\n      for (let i = 0; i < typeAnnotations.length; i++) {\n        if (typeof typeAnnotations[i].order !== 'number' || typeAnnotations[i].order <= 0) {\n          typeHasIssues = true;\n          break;\n        }\n      }\n      \n      // æ£€æŸ¥è¯¥ç±»å‹å†…éƒ¨æ˜¯å¦æœ‰é‡å¤åºå·\n      if (!typeHasIssues) {\n        const orders = typeAnnotations.map(kp => kp.order);\n        const uniqueOrders = [...new Set(orders)];\n        if (uniqueOrders.length !== orders.length) {\n          typeHasIssues = true;\n        }\n      }\n      \n      // å¦‚æœè¯¥ç±»å‹æœ‰åºå·é—®é¢˜ï¼Œé‡æ–°åˆ†é…\n      if (typeHasIssues) {\n        console.log(`å‘ç° ${typeKey} ç±»å‹æ ‡æ³¨åºå·é—®é¢˜ï¼Œæ­£åœ¨ä¸º ${typeAnnotations.length} ä¸ªæ ‡æ³¨ç‚¹åˆ†é…åºå·...`);\n        hasOrderIssues = true;\n        \n        // æŒ‰ç…§åŸæœ‰é¡ºåºä¸ºè¯¥ç±»å‹åˆ†é…åºå·ï¼ˆä»1å¼€å§‹ï¼‰\n        for (let i = 0; i < typeAnnotations.length; i++) {\n          typeAnnotations[i].order = i + 1;\n        }\n        \n        totalFixed += typeAnnotations.length;\n        console.log(`å·²ä¸º ${typeKey} ç±»å‹åˆ†é…åºå·ï¼š1-${typeAnnotations.length}`);\n      }\n    });\n    \n    if (hasOrderIssues) {\n      console.log('å‘ç°ä¼ ç»Ÿæ•°æ®æˆ–åºå·é—®é¢˜ï¼Œæ­£åœ¨ä¸ºæ ‡æ³¨ç‚¹æ·»åŠ /ä¿®å¤åºå·...');\n      console.log(`åºå·ä¿®å¤å®Œæˆï¼šå…±ä¿®å¤ ${totalFixed} ä¸ªæ ‡æ³¨ç‚¹ï¼Œä¿æŒç±»å‹ç‰¹å®šç¼–å·ç³»ç»Ÿ`);\n    }\n  }\n\n  /**\n   * é”€æ¯ç»„ä»¶\n   */\n  destroy() {\n    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨\n    // è¿™é‡Œåº”è¯¥ç§»é™¤æ‰€æœ‰ç»‘å®šçš„äº‹ä»¶ç›‘å¬å™¨ï¼Œä½†ä¸ºäº†ç®€åŒ–æš‚æ—¶çœç•¥\n    \n    // æ¸…ç†èµ„æº\n    if (this.imageElement && this.imageElement.src.startsWith('blob:')) {\n      URL.revokeObjectURL(this.imageElement.src);\n    }\n    \n    console.log('AnnotationTool destroyed');\n  }\n\n  /**\n   * å¼€å§‹æ–¹å‘æ ‡æ³¨\n   */\n  startDirectionAnnotation(mousePos) {\n    // ğŸ”§ FIX: Use comprehensive bounds checking for direction annotation creation\n    if (!this.canCreateAnnotationAt(mousePos.x, mousePos.y)) {\n      if (window.PlantAnnotationTool?.showError) {\n        window.PlantAnnotationTool.showError('Invalid Position', 'Direction annotations can only be placed within the image area. Please click directly on the image.');\n      }\n      return;\n    }\n    \n    const imagePos = this.screenToImage(mousePos.x, mousePos.y);\n    \n    this.state.isDirectionDragging = true;\n    this.state.dragStartPoint = mousePos;\n    this.state.currentDragPoint = mousePos;\n    this.state.previewKeypoint = {\n      x: imagePos.x,\n      y: imagePos.y,\n      direction: 0, // é»˜è®¤æ–¹å‘ï¼ˆ0åº¦ï¼Œå‘å³ï¼‰\n      directionType: 'angle'\n    };\n    \n    this.canvas.style.cursor = 'grabbing';\n    console.log('Started direction annotation');\n  }\n\n  /**\n   * æ›´æ–°æ–¹å‘æ‹–æ‹½\n   */\n  updateDirectionDragging(mousePos) {\n    this.state.currentDragPoint = mousePos;\n\n    // è®¡ç®—æ‹–æ‹½æ–¹å‘è§’åº¦\n    const deltaX = mousePos.x - this.state.dragStartPoint.x;\n    const deltaY = mousePos.y - this.state.dragStartPoint.y;\n    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n\n    if (distance >= this.options.directionThreshold) {\n      // è®¡ç®—è§’åº¦ï¼ˆ0-360åº¦ï¼‰\n      const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;\n      const normalizedAngle = (angle + 360) % 360;\n\n      this.state.previewKeypoint.direction = normalizedAngle;\n      this.state.previewKeypoint.directionType = 'angle';\n    } else {\n      // è·ç¦»ä¸å¤Ÿï¼Œä½¿ç”¨é»˜è®¤æ–¹å‘\n      this.state.previewKeypoint.direction = 0; // é»˜è®¤å‘å³\n      this.state.previewKeypoint.directionType = 'angle';\n    }\n\n    this.render();\n  }\n\n  /**\n   * å®Œæˆæ–¹å‘æ ‡æ³¨\n   */\n  finishDirectionAnnotation() {\n    if (!this.state.previewKeypoint) {\n      this.resetDirectionDragging();\n      return;\n    }\n\n    // è®¡ç®—æ‹–æ‹½è·ç¦»\n    const deltaX = this.state.currentDragPoint.x - this.state.dragStartPoint.x;\n    const deltaY = this.state.currentDragPoint.y - this.state.dragStartPoint.y;\n    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n\n    let direction, directionType;\n\n    if (distance >= this.options.directionThreshold) {\n      // æ‹–æ‹½è·ç¦»è¶³å¤Ÿï¼Œä½¿ç”¨è®¡ç®—çš„è§’åº¦æ–¹å‘\n      const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;\n      direction = (angle + 360) % 360;\n      directionType = 'angle';\n\n      console.log(`Added keypoint with angle direction ${direction.toFixed(1)}Â° at (${this.state.previewKeypoint.x.toFixed(1)}, ${this.state.previewKeypoint.y.toFixed(1)})`);\n    } else {\n      // æ‹–æ‹½è·ç¦»ä¸å¤Ÿï¼Œå½“ä½œæ™®é€šç‚¹å‡»ï¼Œæ·»åŠ é»˜è®¤è§’åº¦æ–¹å‘\n      direction = 0; // é»˜è®¤å‘å³ï¼ˆ0åº¦ï¼‰\n      directionType = 'angle';\n\n      console.log(`Added default keypoint (0Â°) at (${this.state.previewKeypoint.x.toFixed(1)}, ${this.state.previewKeypoint.y.toFixed(1)})`);\n    }\n\n    // æ·»åŠ å¸¦è§’åº¦æ–¹å‘çš„æ ‡æ³¨ç‚¹\n    this.addKeypointWithDirection(\n      this.state.previewKeypoint.x,\n      this.state.previewKeypoint.y,\n      direction\n    );\n\n    this.resetDirectionDragging();\n  }\n\n  /**\n   * é‡ç½®æ–¹å‘æ‹–æ‹½çŠ¶æ€\n   */\n  resetDirectionDragging() {\n    this.state.isDirectionDragging = false;\n    this.state.dragStartPoint = null;\n    this.state.currentDragPoint = null;\n    this.state.previewKeypoint = null;\n    this.canvas.style.cursor = 'crosshair';\n    this.render();\n  }\n\n  /**\n   * è·å–æ ‡æ³¨ç‚¹æ˜¾ç¤ºç­–ç•¥\n   */\n  getKeypointDisplayStrategy() {\n    const scale = this.state.scale;\n    \n    // è®¡ç®—å®é™…çš„æ ‡æ³¨ç‚¹åŠå¾„ï¼ˆé»˜è®¤ä½¿ç”¨æ›´å°çš„åŸºç¡€åŠå¾„ï¼‰\n    const smallRadius = 2; // æ›´å°çš„é»˜è®¤ç‚¹åŠå¾„\n    let actualRadius;\n    \n    if (scale >= 1.5) {\n      // å¤§ç¼©æ”¾ï¼šä½¿ç”¨èƒ½å®¹çº³æ–‡å­—çš„æœ€å°åœ†åœˆ\n      const fontSize = Math.max(10, Math.min(16, 12 * scale));\n      \n      // æ ¹æ®æ–‡å­—å¤§å°è®¡ç®—åˆé€‚çš„åœ†åœˆåŠå¾„\n      // æ–‡å­—é«˜åº¦çº¦ç­‰äºfontSizeï¼Œéœ€è¦ç•™ä¸€ç‚¹è¾¹è·\n      const textBasedRadius = Math.max(8, fontSize * 0.7); // æ–‡å­—å¤§å°çš„70%ä½œä¸ºåŠå¾„\n      \n      // é™åˆ¶æœ€å¤§åŠå¾„ï¼Œåœ¨é«˜ç¼©æ”¾æ—¶ä¸è¦è®©åœ†åœˆè¿‡å¤§\n      const maxRadiusForLargeScale = Math.min(12, 8 + (scale - 1.5) * 2); // æœ€å¤§12pxï¼Œç¼“æ…¢å¢é•¿\n      \n      actualRadius = Math.min(textBasedRadius, maxRadiusForLargeScale);\n      actualRadius = Math.max(8, actualRadius); // æœ€å°ä¿è¯8px\n    } else {\n      // é»˜è®¤å’Œå°ç¼©æ”¾ï¼šä½¿ç”¨æ›´å°çš„ç‚¹\n      actualRadius = smallRadius + (scale - 0.1) * 1.5; // ä»2pxåˆ°4pxçš„èŒƒå›´\n      actualRadius = Math.max(smallRadius, Math.min(4, actualRadius));\n    }\n    \n    return {\n      scale: scale,\n      radius: actualRadius,\n      showInternalLabel: scale >= 1.5, // åªæœ‰åœ¨1.5å€ç¼©æ”¾ä»¥ä¸Šæ‰å†…éƒ¨æ˜¾ç¤º\n      showExternalLabel: scale >= this.options.tinyThresholdScale, // å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¤–éƒ¨æ˜¾ç¤º\n      showMinimalMode: scale < this.options.tinyThresholdScale,\n      fontSize: Math.max(10, Math.min(16, 12 * scale)),\n      directionFontSize: Math.max(8, Math.min(12, 10 * scale)),\n      labelOffset: 8, // æ›´å°çš„åç§»è·ç¦»\n      borderWidth: Math.max(1, Math.min(2, 1.5 * scale))\n    };\n  }\n\n  /**\n   * åˆ›å»ºå¤–éƒ¨æ ‡ç­¾\n   */\n  createExternalLabel(x, y, label, direction, fillColor, strategy) {\n    const canvas = this.canvas;\n    const container = canvas.parentElement;\n    \n    // åˆ›å»ºæ ‡ç­¾å…ƒç´ \n    const labelElement = document.createElement('div');\n    labelElement.className = `keypoint-label ${direction === 'left' ? 'left-direction' : 'right-direction'}`;\n    labelElement.textContent = label.toString();\n    labelElement.dataset.keypointId = `${x}-${y}`;\n    \n    // è®¡ç®—æ ‡ç­¾ä½ç½®\n    const rect = canvas.getBoundingClientRect();\n    const containerRect = container.getBoundingClientRect();\n    \n    const offsetX = rect.left - containerRect.left;\n    const offsetY = rect.top - containerRect.top;\n    \n    // æ ¹æ®æ ‡æ³¨ç‚¹å¤§å°è°ƒæ•´æ ‡ç­¾ä½ç½®ï¼Œè®©æ ‡ç­¾è·ç¦»æ›´è¿œ\n    const labelOffsetY = strategy.radius < 4 ? 12 : 15;\n    \n    labelElement.style.left = (offsetX + x - 6) + 'px'; // å±…ä¸­å¯¹é½ï¼Œç¨å¾®è°ƒæ•´\n    labelElement.style.top = (offsetY + y - strategy.radius - labelOffsetY) + 'px';\n    \n    container.appendChild(labelElement);\n  }\n\n  /**\n   * åˆ›å»ºæ‚¬åœæç¤º\n   */\n  createTooltip(x, y, label, direction, keypoint) {\n    const canvas = this.canvas;\n    const container = canvas.parentElement;\n    \n    // ç§»é™¤å·²å­˜åœ¨çš„æç¤º\n    const existingTooltip = container.querySelector('.keypoint-tooltip');\n    if (existingTooltip) {\n      existingTooltip.remove();\n    }\n    \n    // åˆ›å»ºæç¤ºå…ƒç´ \n    const tooltip = document.createElement('div');\n    tooltip.className = 'keypoint-tooltip';\n    \n    const directionText = direction === 'left' ? 'Left' : 'Right';\n    const coordinateText = `(${Math.round(keypoint.x)}, ${Math.round(keypoint.y)})`;\n    \n    tooltip.innerHTML = `\n      <div>åˆ†æ”¯ç‚¹ #${label}</div>\n      <div>æ–¹å‘: ${directionText}</div>\n      <div>ä½ç½®: ${coordinateText}</div>\n    `;\n    \n    // è®¡ç®—æç¤ºä½ç½®\n    const rect = canvas.getBoundingClientRect();\n    const containerRect = container.getBoundingClientRect();\n    \n    const offsetX = rect.left - containerRect.left;\n    const offsetY = rect.top - containerRect.top;\n    \n    tooltip.style.left = (offsetX + x - 60) + 'px';\n    tooltip.style.top = (offsetY + y - 80) + 'px';\n    \n    container.appendChild(tooltip);\n    \n    // è‡ªåŠ¨ç§»é™¤æç¤º\n    setTimeout(() => {\n      if (tooltip.parentElement) {\n        tooltip.remove();\n      }\n    }, 3000);\n  }\n\n  /**\n   * æ¸…é™¤æ‰€æœ‰æ ‡æ³¨ç‚¹æ ‡ç­¾\n   */\n  clearKeypointLabels() {\n    if (!this.canvas || !this.canvas.parentElement) return;\n    \n    const container = this.canvas.parentElement;\n    const labels = container.querySelectorAll('.keypoint-label');\n    labels.forEach(label => label.remove());\n  }\n\n  /**\n   * æ›´æ–°ç¼©æ”¾çº§åˆ«æŒ‡ç¤ºå™¨\n   */\n  updateZoomIndicator(strategy) {\n    const indicator = document.getElementById('zoom-indicator');\n    if (!indicator) return;\n    \n    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»\n    indicator.classList.remove('small', 'tiny');\n    \n    if (strategy.showMinimalMode) {\n      indicator.classList.add('tiny');\n    } else if (strategy.showExternalLabel) {\n      indicator.classList.add('small');\n    }\n  }\n\n  /**\n   * æ›´æ–°æ ‡æ³¨ç‚¹å¤§å°ä¿¡æ¯\n   */\n  updateAnnotationSizeInfo(strategy) {\n    const sizeInfo = document.getElementById('annotation-size-info');\n    const sizeText = document.getElementById('size-info-text');\n    \n    if (!sizeInfo || !sizeText) return;\n    \n    let statusText = '';\n    let showInfo = false;\n    \n    if (strategy.showMinimalMode) {\n      statusText = 'æ ‡æ³¨ç‚¹: æå°æ¨¡å¼ï¼ˆæ‚¬åœæŸ¥çœ‹è¯¦æƒ…ï¼‰';\n      showInfo = true;\n    } else if (strategy.showExternalLabel) {\n      statusText = 'æ ‡æ³¨ç‚¹: å¤–éƒ¨æ ‡ç­¾æ¨¡å¼';\n      showInfo = true;\n    } else {\n      statusText = 'æ ‡æ³¨ç‚¹: æ­£å¸¸å¤§å°';\n      showInfo = this.keypoints.length > 0 && (strategy.scale < 0.8 || strategy.scale > 3);\n    }\n    \n    sizeText.textContent = statusText;\n    \n    if (showInfo) {\n      sizeInfo.classList.add('visible');\n      \n      // è‡ªåŠ¨éšè—\n      setTimeout(() => {\n        if (sizeInfo) {\n          sizeInfo.classList.remove('visible');\n        }\n      }, 2000);\n    } else {\n      sizeInfo.classList.remove('visible');\n    }\n  }\n\n  /**\n   * åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n   */\n  syncBranchPointPreview() {\n    // é€šè¿‡å…¨å±€å¯¹è±¡è®¿é—®åˆ†æ”¯ç‚¹é¢„è§ˆç®¡ç†å™¨\n    const branchPointPreviewManager = window.PlantAnnotationTool?.branchPointPreviewManager;\n    const appState = window.PlantAnnotationTool?.appState;\n    \n    if (branchPointPreviewManager && appState?.currentPlant && appState?.currentImage) {\n      // è·å–å½“å‰æ ‡æ³¨ç‚¹æ•°é‡å¹¶æ›´æ–°é¢„è§ˆä¸Šä¸‹æ–‡\n      const currentKeypointCount = this.keypoints.length;\n      \n      // å¼‚æ­¥æ›´æ–°é¢„è§ˆä¸Šä¸‹æ–‡\n      setTimeout(async () => {\n        try {\n          const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n          if (plantDataManager) {\n            const images = await plantDataManager.getPlantImages(\n              appState.currentPlant.id, \n              appState.currentPlant.selectedViewAngle\n            );\n            const imageIndex = images.findIndex(img => img.id === appState.currentImage.id);\n            \n            await branchPointPreviewManager.updateContext(\n              appState.currentPlant.id,\n              appState.currentPlant.selectedViewAngle,\n              imageIndex,\n              currentKeypointCount\n            );\n          }\n        } catch (error) {\n          console.warn('åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆå¤±è´¥:', error);\n        }\n      }, 100);\n    }\n  }\n\n  /**\n   * é€šçŸ¥é¢„è§ˆç®¡ç†å™¨æ˜¾ç¤ºè¢«æ‹–åŠ¨ç‚¹å¯¹åº”çš„é¢„è§ˆ\n   */\n  notifyDraggedKeypointPreview(keypoint) {\n    // é€šè¿‡å…¨å±€å¯¹è±¡è®¿é—®åˆ†æ”¯ç‚¹é¢„è§ˆç®¡ç†å™¨\n    const branchPointPreviewManager = window.PlantAnnotationTool?.branchPointPreviewManager;\n    \n    if (branchPointPreviewManager && keypoint && keypoint.order) {\n      // å‘Šè¯‰é¢„è§ˆç®¡ç†å™¨æ˜¾ç¤ºè¿™ä¸ªç¼–å·çš„é¢„è§ˆ\n      branchPointPreviewManager.showSpecificOrderPreview(keypoint.order);\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: è®¾ç½®å›¾åƒåˆ‡æ¢é”å®šçŠ¶æ€\n   * @param {boolean} isLocked - æ˜¯å¦é”å®š\n   * @param {string} imageId - æ­£åœ¨åŠ è½½çš„å›¾åƒID\n   */\n  setImageSwitchLock(isLocked, imageId = null) {\n    this.imageSwitchLock.isLocked = isLocked;\n    this.imageSwitchLock.currentLoadingImageId = imageId;\n    this.imageSwitchLock.lockStartTime = isLocked ? Date.now() : null;\n    \n    console.log(`[å›¾åƒåˆ‡æ¢é”] ${isLocked ? 'é”å®š' : 'è§£é”'} - å›¾åƒ: ${imageId || 'none'}`);\n  }\n  \n  /**\n   * ğŸ”§ NEW: éªŒè¯å½“å‰å›¾åƒä¸€è‡´æ€§\n   * @param {string} expectedImageId - æœŸæœ›çš„å›¾åƒID\n   * @returns {boolean} æ˜¯å¦ä¸€è‡´\n   */\n  validateCurrentImageConsistency(expectedImageId) {\n    const appState = window.PlantAnnotationTool?.appState;\n    if (!appState?.currentImage?.id) {\n      console.warn('[ä¸€è‡´æ€§æ£€æŸ¥] å½“å‰å›¾åƒçŠ¶æ€æ— æ•ˆ');\n      return false;\n    }\n    \n    const isConsistent = appState.currentImage.id === expectedImageId;\n    if (!isConsistent) {\n      console.warn(`[ä¸€è‡´æ€§æ£€æŸ¥] ä¸ä¸€è‡´ - æœŸæœ›: ${expectedImageId}, å®é™…: ${appState.currentImage.id}`);\n    }\n    \n    return isConsistent;\n  }\n  \n  /**\n   * ğŸ”§ ENHANCED: è‡ªåŠ¨ä¿å­˜å½“å‰å›¾åƒï¼ˆå¸¦é”å®šæœºåˆ¶ï¼‰\n   */\n  async autoSaveCurrentImage() {\n    try {\n      const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n      const appState = window.PlantAnnotationTool?.appState;\n      \n      if (!plantDataManager || !appState?.currentPlant || !appState?.currentImage) {\n        console.warn('è‡ªåŠ¨ä¿å­˜è·³è¿‡ï¼šç¼ºå°‘å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯');\n        return;\n      }\n      \n      // ğŸ”§ NEW: æ£€æŸ¥å›¾åƒåˆ‡æ¢é”å®šçŠ¶æ€\n      if (this.imageSwitchLock.isLocked) {\n        console.warn(`[è‡ªåŠ¨ä¿å­˜] è·³è¿‡ï¼šå›¾åƒåˆ‡æ¢è¿›è¡Œä¸­ (${this.imageSwitchLock.currentLoadingImageId})`);\n        return;\n      }\n      \n      // ğŸ”§ FIX: æ£€æŸ¥ currentImage çš„æœ‰æ•ˆæ€§ï¼Œé˜²æ­¢ null å¼•ç”¨é”™è¯¯\n      if (!appState.currentImage || !appState.currentImage.id) {\n        console.warn('è‡ªåŠ¨ä¿å­˜è·³è¿‡ï¼šå½“å‰å›¾åƒä¿¡æ¯æ— æ•ˆ');\n        return;\n      }\n      \n      // ğŸ”§ NEW: è®°å½•å½“å‰å›¾åƒIDï¼Œç”¨äºä¸€è‡´æ€§éªŒè¯\n      const currentImageId = appState.currentImage.id;\n      \n      // è·å–å½“å‰æ ‡æ³¨æ•°æ®\n      const annotationData = this.getAnnotationData();\n      \n      // ğŸ”§ NEW: åœ¨ä¿å­˜å‰å†æ¬¡éªŒè¯å›¾åƒä¸€è‡´æ€§\n      if (!this.validateCurrentImageConsistency(currentImageId)) {\n        console.warn(`[è‡ªåŠ¨ä¿å­˜] è·³è¿‡ï¼šå›¾åƒçŠ¶æ€åœ¨ä¿å­˜å‰å‘ç”Ÿå˜åŒ– (${currentImageId})`);\n        return;\n      }\n      \n      // ä¿å­˜åˆ°å½“å‰å›¾åƒï¼ˆå³ä½¿æ²¡æœ‰æ ‡æ³¨ç‚¹ä¹Ÿè¦ä¿å­˜ï¼Œè¡¨ç¤ºæ¸…ç©ºçŠ¶æ€ï¼‰\n      await plantDataManager.saveImageAnnotations(\n        currentImageId,\n        annotationData.keypoints\n      );\n      \n      // ğŸ”§ NEW: åœ¨ä¿å­˜åéªŒè¯å›¾åƒçŠ¶æ€ä»ç„¶ä¸€è‡´\n      if (!this.validateCurrentImageConsistency(currentImageId)) {\n        console.warn(`[è‡ªåŠ¨ä¿å­˜] è­¦å‘Šï¼šå›¾åƒçŠ¶æ€åœ¨ä¿å­˜åå‘ç”Ÿå˜åŒ–ï¼Œæ•°æ®å¯èƒ½å·²ä¿å­˜åˆ°é”™è¯¯å›¾åƒ (${currentImageId})`);\n        return;\n      }\n      \n      console.log(`è‡ªåŠ¨ä¿å­˜å®Œæˆï¼š${annotationData.keypoints.length} ä¸ªæ ‡æ³¨ç‚¹å·²ä¿å­˜åˆ°å›¾åƒ ${currentImageId}`);\n      \n      // ğŸ”§ FIX: è‡ªåŠ¨ä¿å­˜åç«‹å³åˆ·æ–°ç¼©ç•¥å›¾çŠ¶æ€ï¼ˆé€šè¿‡å…¨å±€å‡½æ•°è®¿é—®ï¼‰\n      try {\n        // å°è¯•é€šè¿‡windowå¯¹è±¡è®¿é—®å…¨å±€å‡½æ•°\n        const refreshFunction = window.refreshThumbnailAnnotationStatus;\n        if (typeof refreshFunction === 'function') {\n          await refreshFunction(currentImageId);\n          console.log('è‡ªåŠ¨ä¿å­˜åç¼©ç•¥å›¾çŠ¶æ€å·²åˆ·æ–°');\n        } else {\n          console.warn('refreshThumbnailAnnotationStatus å‡½æ•°æœªæ‰¾åˆ°ï¼Œè·³è¿‡ç¼©ç•¥å›¾åˆ·æ–°');\n        }\n      } catch (refreshError) {\n        console.warn('åˆ·æ–°ç¼©ç•¥å›¾çŠ¶æ€å¤±è´¥:', refreshError);\n      }\n      \n    } catch (error) {\n      console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * ğŸ”„ è§¦å‘å®æ—¶åŒæ­¥æ“ä½œ\n   * @param {string} operationType - æ“ä½œç±»å‹ ('ADD_KEYPOINT', 'MOVE_KEYPOINT', 'DELETE_KEYPOINT', 'EDIT_DIRECTION')\n   * @param {object} keypoint - ç›¸å…³çš„å…³é”®ç‚¹æ•°æ®\n   * @param {object} previousPosition - ä¹‹å‰çš„ä½ç½®ï¼ˆä»…ç§»åŠ¨æ“ä½œéœ€è¦ï¼‰\n   */\n  triggerRealTimeSync(operationType, keypoint, previousPosition = null) {\n    try {\n      // è·å–å®æ—¶åŒæ­¥ç®¡ç†å™¨\n      const realTimeSyncManager = window.PlantAnnotationTool?.realTimeSyncManager;\n      \n      if (!realTimeSyncManager) {\n        console.warn('ğŸ”„ å®æ—¶åŒæ­¥ç®¡ç†å™¨æœªæ‰¾åˆ°ï¼Œè·³è¿‡åŒæ­¥æ“ä½œ');\n        return;\n      }\n\n      // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å®æ—¶åŒæ­¥\n      if (!realTimeSyncManager.isRealTimeSyncEnabled()) {\n        console.log('ğŸ”„ å®æ—¶åŒæ­¥å·²ç¦ç”¨ï¼Œè·³è¿‡åŒæ­¥æ“ä½œ');\n        return;\n      }\n\n      // è·å–å½“å‰ä¸Šä¸‹æ–‡\n      const appState = window.PlantAnnotationTool?.appState;\n      if (!appState?.currentPlant || !appState?.currentImage) {\n        console.warn('ğŸ”„ ç¼ºå°‘å½“å‰æ¤æ ªæˆ–å›¾åƒä¿¡æ¯ï¼Œè·³è¿‡åŒæ­¥æ“ä½œ');\n        return;\n      }\n\n      // ğŸ”§ Enhanced Debug: Log detailed keypoint information\n      const keypointInfo = {\n        id: keypoint?.id,\n        order: keypoint?.order,\n        annotationType: keypoint?.annotationType,\n        customTypeId: keypoint?.customTypeId,\n        x: keypoint?.x,\n        y: keypoint?.y\n      };\n\n      console.log(`ğŸ”„ è§¦å‘å®æ—¶åŒæ­¥: ${operationType}`, {\n        keypoint: keypointInfo,\n        plant: appState.currentPlant.id,\n        image: appState.currentImage.id,\n        isCustom: keypoint?.annotationType === 'custom'\n      });\n\n      // ğŸ”§ FIX: Route custom annotations to custom annotation sync methods\n      // This is crucial for proper order-based synchronization\n      const isCustomAnnotation = keypoint?.annotationType === 'custom';\n      \n      if (isCustomAnnotation) {\n        // Use custom annotation sync methods for custom annotations\n        console.log(`ğŸ”„ Using custom annotation sync for ${operationType}`);\n        \n        switch (operationType) {\n          case 'ADD_KEYPOINT':\n            // Create sync data for custom annotation creation\n            const createSyncData = {\n              type: 'CUSTOM_ANNOTATION_CREATE',\n              annotation: keypoint,\n              context: {\n                imageId: appState.currentImage.id,\n                plantId: appState.currentPlant.id,\n                viewAngle: appState.currentPlant.selectedViewAngle,\n                appState: appState\n              },\n              timestamp: new Date().toISOString()\n            };\n            realTimeSyncManager.triggerCustomAnnotationSync(createSyncData);\n            break;\n            \n          case 'MOVE_KEYPOINT':\n            // Create sync data for custom annotation update\n            const updateSyncData = {\n              type: 'CUSTOM_ANNOTATION_UPDATE',\n              annotation: keypoint,\n              context: {\n                imageId: appState.currentImage.id,\n                plantId: appState.currentPlant.id,\n                viewAngle: appState.currentPlant.selectedViewAngle,\n                appState: appState,\n                positionChange: {\n                  from: previousPosition,\n                  to: { x: keypoint.x, y: keypoint.y }\n                }\n              },\n              timestamp: new Date().toISOString()\n            };\n            realTimeSyncManager.triggerCustomAnnotationSync(updateSyncData);\n            break;\n            \n          case 'DELETE_KEYPOINT':\n            // Create sync data for custom annotation deletion\n            const deleteSyncData = {\n              type: 'CUSTOM_ANNOTATION_DELETE',\n              annotation: keypoint,\n              context: {\n                imageId: appState.currentImage.id,\n                plantId: appState.currentPlant.id,\n                viewAngle: appState.currentPlant.selectedViewAngle,\n                appState: appState\n              },\n              timestamp: new Date().toISOString()\n            };\n            realTimeSyncManager.triggerCustomAnnotationSync(deleteSyncData);\n            break;\n            \n          default:\n            console.warn(`ğŸ”„ æœªçŸ¥çš„è‡ªå®šä¹‰æ ‡æ³¨åŒæ­¥æ“ä½œç±»å‹: ${operationType}`);\n        }\n      } else {\n        // Use regular keypoint sync methods for regular annotations\n        console.log(`ğŸ”„ Using regular keypoint sync for ${operationType}`);\n        \n        switch (operationType) {\n          case 'ADD_KEYPOINT':\n            realTimeSyncManager.triggerKeypointAddSync(\n              keypoint,\n              appState.currentImage,\n              appState.currentPlant\n            );\n            break;\n            \n          case 'MOVE_KEYPOINT':\n            realTimeSyncManager.triggerKeypointMoveSync(\n              keypoint,\n              previousPosition,\n              appState.currentImage,\n              appState.currentPlant\n            );\n            break;\n            \n          case 'DELETE_KEYPOINT':\n            realTimeSyncManager.triggerKeypointDeleteSync(\n              keypoint,\n              appState.currentImage,\n              appState.currentPlant\n            );\n            break;\n            \n          case 'EDIT_DIRECTION':\n            realTimeSyncManager.triggerDirectionEditSync(\n              keypoint,\n              appState.currentImage,\n              appState.currentPlant\n            );\n            break;\n            \n          default:\n            console.warn(`ğŸ”„ æœªçŸ¥çš„å¸¸è§„æ ‡æ³¨åŒæ­¥æ“ä½œç±»å‹: ${operationType}`);\n        }\n      }\n      \n    } catch (error) {\n      console.error('ğŸ”„ è§¦å‘å®æ—¶åŒæ­¥å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * æ¸²æŸ“æ–¹å‘æŒ‡ç¤ºå™¨ï¼ˆç»Ÿä¸€å¤„ç†æ‰€æœ‰æ–¹å‘ç±»å‹ï¼‰\n   */\n  renderDirectionIndicator(x, y, direction, keypoint) {\n    if (!direction) return;\n\n    let angleDegrees;\n    let directionText = '';\n\n    // ç»Ÿä¸€è½¬æ¢ä¸ºè§’åº¦\n    if (typeof direction === 'number') {\n      // å·²ç»æ˜¯è§’åº¦\n      angleDegrees = direction;\n      directionText = `${angleDegrees.toFixed(1)}Â°`;\n    } else if (direction === 'left') {\n      // å·¦ä¾§ï¼š180åº¦\n      angleDegrees = 180;\n      directionText = 'Left (180Â°)';\n    } else if (direction === 'right') {\n      // å³ä¾§ï¼š0åº¦\n      angleDegrees = 0;\n      directionText = 'Right (0Â°)';\n    } else {\n      return; // æœªçŸ¥æ–¹å‘ç±»å‹\n    }\n\n    this.renderDirectionArrow(x, y, angleDegrees, directionText, keypoint);\n  }\n\n  /**\n   * æ¸²æŸ“æ–¹å‘ç®­å¤´ï¼ˆæ”¹è¿›ç‰ˆ - è™šçº¿ä»ä¸­å¿ƒå»¶ä¼¸ï¼‰\n   */\n  renderDirectionArrow(x, y, angleDegrees, directionText, keypoint) {\n    const angleRadians = angleDegrees * Math.PI / 180;\n    const arrowLength = this.options.directionArrowLength;\n\n    // è®¡ç®—ç®­å¤´ç»ˆç‚¹\n    const endX = x + Math.cos(angleRadians) * arrowLength;\n    const endY = y + Math.sin(angleRadians) * arrowLength;\n\n    // ç»˜åˆ¶è™šçº¿ä¸»çº¿\n    this.ctx.strokeStyle = '#10b981'; // ç»¿è‰²\n    this.ctx.lineWidth = 3;\n    this.ctx.setLineDash([8, 4]); // è™šçº¿æ ·å¼\n    this.ctx.lineCap = 'round';\n\n    this.ctx.beginPath();\n    this.ctx.moveTo(x, y);\n    this.ctx.lineTo(endX, endY);\n    this.ctx.stroke();\n\n    // é‡ç½®è™šçº¿æ ·å¼\n    this.ctx.setLineDash([]);\n\n    // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨ï¼ˆå®çº¿ï¼‰\n    const headAngle1 = angleRadians + Math.PI * 0.8;\n    const headAngle2 = angleRadians - Math.PI * 0.8;\n    const headLength = 15;\n\n    this.ctx.strokeStyle = '#10b981';\n    this.ctx.lineWidth = 3;\n    this.ctx.lineCap = 'round';\n\n    this.ctx.beginPath();\n    this.ctx.moveTo(endX, endY);\n    this.ctx.lineTo(endX + Math.cos(headAngle1) * headLength, endY + Math.sin(headAngle1) * headLength);\n    this.ctx.moveTo(endX, endY);\n    this.ctx.lineTo(endX + Math.cos(headAngle2) * headLength, endY + Math.sin(headAngle2) * headLength);\n    this.ctx.stroke();\n\n    // ç»˜åˆ¶æ–¹å‘æ–‡æœ¬ï¼ˆå¸¦èƒŒæ™¯ï¼‰\n    const textOffset = 20;\n    const textX = endX + Math.cos(angleRadians) * textOffset;\n    const textY = endY + Math.sin(angleRadians) * textOffset;\n\n    // æµ‹é‡æ–‡æœ¬å°ºå¯¸\n    this.ctx.font = 'bold 11px Arial';\n    const textMetrics = this.ctx.measureText(directionText);\n    const textWidth = textMetrics.width;\n    const textHeight = 11;\n\n    // ç»˜åˆ¶æ–‡æœ¬èƒŒæ™¯\n    this.ctx.fillStyle = 'rgba(16, 185, 129, 0.9)';\n    this.ctx.fillRect(textX - textWidth/2 - 3, textY - textHeight/2 - 2, textWidth + 6, textHeight + 4);\n\n    // ç»˜åˆ¶æ–‡æœ¬\n    this.ctx.fillStyle = '#ffffff';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    this.ctx.fillText(directionText, textX, textY);\n  }\n\n  /**\n   * æ¸²æŸ“æ–¹å‘é€‰æ‹©æŒ‡å¼•\n   */\n  renderDirectionSelectionGuide() {\n    if (!this.state.selectedKeypoint || !this.state.directionSelectionPoint) return;\n\n    const keypointScreen = this.imageToScreen(\n      this.state.selectedKeypoint.x,\n      this.state.selectedKeypoint.y\n    );\n\n    const guideX = this.state.directionSelectionPoint.x;\n    const guideY = this.state.directionSelectionPoint.y;\n\n    // è®¡ç®—è·ç¦»ï¼Œåªæœ‰è¶³å¤Ÿè¿œæ‰æ˜¾ç¤ºæŒ‡å¼•\n    const distance = Math.sqrt(\n      Math.pow(guideX - keypointScreen.x, 2) +\n      Math.pow(guideY - keypointScreen.y, 2)\n    );\n\n    if (distance < 20) return; // è·ç¦»å¤ªè¿‘ä¸æ˜¾ç¤º\n\n    // ç»˜åˆ¶è™šçº¿æŒ‡å¼•çº¿\n    this.ctx.strokeStyle = '#f59e0b'; // æ©™è‰²\n    this.ctx.lineWidth = 3;\n    this.ctx.setLineDash([8, 4]);\n    this.ctx.lineCap = 'round';\n\n    this.ctx.beginPath();\n    this.ctx.moveTo(keypointScreen.x, keypointScreen.y);\n    this.ctx.lineTo(guideX, guideY);\n    this.ctx.stroke();\n\n    // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨\n    const deltaX = guideX - keypointScreen.x;\n    const deltaY = guideY - keypointScreen.y;\n    const angle = Math.atan2(deltaY, deltaX);\n    const normalizedAngle = (angle * 180 / Math.PI + 360) % 360;\n\n    const headAngle1 = angle + Math.PI * 0.8;\n    const headAngle2 = angle - Math.PI * 0.8;\n    const headLength = 12;\n\n    this.ctx.setLineDash([]); // å®çº¿ç®­å¤´\n    this.ctx.beginPath();\n    this.ctx.moveTo(guideX, guideY);\n    this.ctx.lineTo(guideX + Math.cos(headAngle1) * headLength, guideY + Math.sin(headAngle1) * headLength);\n    this.ctx.moveTo(guideX, guideY);\n    this.ctx.lineTo(guideX + Math.cos(headAngle2) * headLength, guideY + Math.sin(headAngle2) * headLength);\n    this.ctx.stroke();\n\n    // ç»˜åˆ¶è§’åº¦æ–‡æœ¬ï¼ˆå¸¦èƒŒæ™¯ï¼‰\n    const textOffset = 25;\n    const textX = guideX + Math.cos(angle) * textOffset;\n    const textY = guideY + Math.sin(angle) * textOffset;\n    const angleText = `${normalizedAngle.toFixed(1)}Â°`;\n\n    // æµ‹é‡æ–‡æœ¬å°ºå¯¸\n    this.ctx.font = 'bold 12px Arial';\n    const textMetrics = this.ctx.measureText(angleText);\n    const textWidth = textMetrics.width;\n    const textHeight = 12;\n\n    // ç»˜åˆ¶æ–‡æœ¬èƒŒæ™¯\n    this.ctx.fillStyle = 'rgba(245, 158, 11, 0.9)';\n    this.ctx.fillRect(textX - textWidth/2 - 4, textY - textHeight/2 - 2, textWidth + 8, textHeight + 4);\n\n    // ç»˜åˆ¶æ–‡æœ¬\n    this.ctx.fillStyle = '#ffffff';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    this.ctx.fillText(angleText, textX, textY);\n\n    // é‡ç½®çº¿æ¡æ ·å¼\n    this.ctx.setLineDash([]);\n  }\n\n  /**\n   * å‡çº§ä¼ ç»Ÿæ–¹å‘åˆ°è§’åº¦æ–¹å‘\n   */\n  upgradeLegacyDirections() {\n    let upgraded = 0;\n\n    this.keypoints.forEach(keypoint => {\n      if (keypoint.direction === 'left' && keypoint.directionType !== 'angle') {\n        keypoint.direction = 180;\n        keypoint.directionType = 'angle';\n        upgraded++;\n      } else if (keypoint.direction === 'right' && keypoint.directionType !== 'angle') {\n        keypoint.direction = 0;\n        keypoint.directionType = 'angle';\n        upgraded++;\n      }\n    });\n\n    if (upgraded > 0) {\n      console.log(`Upgraded ${upgraded} legacy direction annotations to angle format`);\n      this.saveState();\n      this.render();\n      this.autoSaveCurrentImage();\n    }\n\n    return upgraded;\n  }\n\n  /**\n   * è®¾ç½®è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®åŠŸèƒ½\n   */\n  setAutoMoveToExpectedPosition(enabled) {\n    this.state.autoMoveToExpectedPosition = enabled;\n    console.log(`è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®: ${enabled ? 'å¼€å¯' : 'å…³é—­'}`);\n  }\n\n  /**\n   * è·å–ç›®æ ‡ç¼©æ”¾å€æ•°ï¼ˆé”å®šå€æ•°ä¼˜å…ˆï¼Œå¦åˆ™ä¿æŒå½“å‰å€æ•°ï¼‰\n   */\n  getTargetScale() {\n    // è·å–é”å®šå€æ•°è®¾ç½®\n    if (typeof window.getZoomLockSettings === 'function') {\n      const zoomSettings = window.getZoomLockSettings();\n      if (zoomSettings.isLocked) {\n        console.log(`[è‡ªåŠ¨åˆ‡æ¢] ä½¿ç”¨é”å®šå€æ•°: ${zoomSettings.lockValue}x`);\n        return zoomSettings.lockValue;\n      }\n    }\n\n    // éé”å®šçŠ¶æ€ï¼šä¿æŒå½“å‰å€æ•°\n    console.log(`[è‡ªåŠ¨åˆ‡æ¢] ä¿æŒå½“å‰å€æ•°: ${this.state.scale.toFixed(1)}x`);\n    return this.state.scale;\n  }\n\n  /**\n   * ç§»åŠ¨è§†è§’åˆ°æœ€é«˜æ ‡è®°ç‚¹å¹¶ä¿æŒå½“å‰ç¼©æ”¾\n   */\n  moveToHighestKeypoint() {\n    if (!this.keypoints || this.keypoints.length === 0) {\n      console.log('æ²¡æœ‰æ ‡æ³¨ç‚¹ï¼Œæ— æ³•ç§»åŠ¨è§†è§’');\n      return false;\n    }\n\n    // æ‰¾åˆ°åºå·æœ€å¤§çš„æ ‡æ³¨ç‚¹\n    const highestKeypoint = this.keypoints.reduce((highest, current) => {\n      const currentOrder = current.order || 0;\n      const highestOrder = highest.order || 0;\n      return currentOrder > highestOrder ? current : highest;\n    });\n\n    console.log(`ç§»åŠ¨è§†è§’åˆ°æœ€é«˜æ ‡è®°ç‚¹ #${highestKeypoint.order}`);\n\n    // ä¿æŒå½“å‰ç¼©æ”¾ï¼Œåªç§»åŠ¨è§†è§’ä¸­å¿ƒ\n    const currentScale = this.state.scale;\n    const centerX = this.canvas.width / 2;\n    const centerY = this.canvas.height / 2;\n\n    // è®¡ç®—æ–°çš„å¹³ç§»ï¼Œä½¿æœ€é«˜æ ‡è®°ç‚¹å±…ä¸­\n    this.state.translateX = centerX - (highestKeypoint.x * currentScale);\n    this.state.translateY = centerY - (highestKeypoint.y * currentScale);\n\n    // ç¡®ä¿å›¾åƒä¸ä¼šè¶…å‡ºè¾¹ç•Œ\n    this.constrainView();\n\n    this.updateZoomInfo();\n    this.render();\n\n    console.log(`è§†è§’å·²ç§»åŠ¨åˆ°æ ‡æ³¨ç‚¹ #${highestKeypoint.order}ï¼Œä¿æŒç¼©æ”¾: ${currentScale.toFixed(1)}x`);\n    return true;\n  }\n\n  /**\n   * ç§»åŠ¨åˆ°é¢„æœŸä½ç½®ï¼ˆåŸºäºé¢„è§ˆå›¾ä¸­çš„å‚è€ƒä½ç½®ï¼‰\n   * @param {boolean} isImageSwitch - æ˜¯å¦æ˜¯å›¾ç‰‡åˆ‡æ¢è§¦å‘çš„\n   */\n  async moveToExpectedPosition(isImageSwitch = false) {\n    if (!this.state.autoMoveToExpectedPosition) {\n      return; // åŠŸèƒ½æœªå¼€å¯\n    }\n\n    try {\n      if (isImageSwitch) {\n        // å›¾ç‰‡åˆ‡æ¢æ—¶çš„é€»è¾‘ï¼šåˆ†æåˆ‡æ¢åˆ°çš„æ–°å›¾åƒ\n        await this.handleImageSwitchAutoMove();\n      } else {\n        // æ ‡æ³¨ç‚¹åˆ›å»ºåçš„é€»è¾‘ï¼šç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªé¢„æœŸä½ç½®\n        await this.moveToNextExpectedPosition();\n      }\n    } catch (error) {\n      console.error('[è‡ªåŠ¨åˆ‡æ¢] ç§»åŠ¨åˆ°é¢„æœŸä½ç½®å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * å¤„ç†å›¾ç‰‡åˆ‡æ¢æ—¶çš„è‡ªåŠ¨ç§»åŠ¨\n   */\n  async handleImageSwitchAutoMove() {\n    // åˆ†ææ–°å›¾åƒï¼ˆå½“å‰åŠ è½½çš„å›¾åƒï¼‰çš„æ ‡æ³¨æƒ…å†µ\n    const newImageAnnotations = this.keypoints || [];\n\n    console.log(`[è‡ªåŠ¨åˆ‡æ¢] å›¾ç‰‡åˆ‡æ¢ï¼šæ–°å›¾åƒæœ‰ ${newImageAnnotations.length} ä¸ªæ ‡æ³¨ç‚¹`);\n\n    if (newImageAnnotations.length === 0) {\n      // æƒ…å†µ1: æ–°å›¾åƒæ²¡æœ‰æ ‡æ³¨ï¼Œç§»åŠ¨åˆ°1å·ç‚¹ä½ç½®\n      console.log('[è‡ªåŠ¨åˆ‡æ¢] æ–°å›¾åƒæ²¡æœ‰æ ‡æ³¨ï¼Œç§»åŠ¨åˆ°1å·ç‚¹ä½ç½®');\n      await this.moveToPosition1();\n    } else {\n      // æ£€æŸ¥æ–°å›¾åƒçš„æ ‡æ³¨ç‚¹æ˜¯å¦éƒ½æ²¡æœ‰æ–¹å‘\n      const hasDirectionAnnotations = newImageAnnotations.some(kp =>\n        kp.direction !== null && kp.direction !== undefined &&\n        (typeof kp.direction === 'number' || kp.directionType === 'angle')\n      );\n\n      if (!hasDirectionAnnotations) {\n        // æƒ…å†µ2: æ–°å›¾åƒæœ‰æ ‡æ³¨ä½†éƒ½æ²¡æœ‰æ–¹å‘ï¼Œç§»åŠ¨åˆ°å‡ ä½•ä¸­å¿ƒ\n        console.log('[è‡ªåŠ¨åˆ‡æ¢] æ–°å›¾åƒæœ‰æ— æ–¹å‘æ ‡æ³¨ï¼Œç§»åŠ¨åˆ°å‡ ä½•ä¸­å¿ƒ');\n        this.moveToAnnotationsCenter();\n      } else {\n        // æƒ…å†µ3: æ–°å›¾åƒæœ‰æ–¹å‘æ ‡æ³¨ï¼Œä¿æŒå½“å‰ä½ç½®ä¸åŠ¨\n        console.log('[è‡ªåŠ¨åˆ‡æ¢] æ–°å›¾åƒæœ‰æ–¹å‘æ ‡æ³¨ï¼Œä¿æŒå½“å‰ä½ç½®');\n      }\n    }\n  }\n\n  /**\n   * ç§»åŠ¨åˆ°1å·ä½ç½®ï¼ˆä»é¢„è§ˆå›¾è·å–ï¼‰\n   */\n  async moveToPosition1() {\n    try {\n      // è·å–åˆ†æ”¯ç‚¹é¢„è§ˆç®¡ç†å™¨\n      const branchPointPreviewManager = window.PlantAnnotationTool?.branchPointPreviewManager;\n      if (!branchPointPreviewManager) {\n        console.log('[è‡ªåŠ¨åˆ‡æ¢] é¢„è§ˆç®¡ç†å™¨ä¸å¯ç”¨ï¼Œæ— æ³•è·å–1å·ä½ç½®');\n        return;\n      }\n\n      // è·å–1å·ä½ç½®\n      const position1 = await branchPointPreviewManager.getExpectedPosition(1);\n\n      if (position1) {\n        console.log(`[è‡ªåŠ¨åˆ‡æ¢] ç§»åŠ¨åˆ°1å·ä½ç½®: (${position1.x.toFixed(1)}, ${position1.y.toFixed(1)})`);\n\n        // æ£€æŸ¥æ˜¯å¦éœ€è¦åº”ç”¨é”å®šå€æ•°\n        const zoomSettings = typeof window.getZoomLockSettings === 'function' ? window.getZoomLockSettings() : { isLocked: false };\n\n        if (zoomSettings.isLocked) {\n          // é”å®šçŠ¶æ€ï¼šä½¿ç”¨é”å®šå€æ•°\n          this.state.scale = zoomSettings.lockValue;\n          console.log(`[è‡ªåŠ¨åˆ‡æ¢] åº”ç”¨é”å®šå€æ•°: ${zoomSettings.lockValue}x`);\n        } else {\n          // éé”å®šçŠ¶æ€ï¼šä¿æŒå½“å‰å€æ•°\n          console.log(`[è‡ªåŠ¨åˆ‡æ¢] ä¿æŒå½“å‰å€æ•°: ${this.state.scale.toFixed(1)}x`);\n        }\n\n        const centerX = this.canvas.width / 2;\n        const centerY = this.canvas.height / 2;\n\n        // è®¡ç®—æ–°çš„ä½ç½®\n        this.state.translateX = centerX - (position1.x * this.state.scale);\n        this.state.translateY = centerY - (position1.y * this.state.scale);\n\n        // ç¡®ä¿å›¾åƒä¸ä¼šè¶…å‡ºè¾¹ç•Œ\n        this.constrainView();\n\n        this.updateZoomInfo();\n        this.render();\n\n        console.log(`[è‡ªåŠ¨åˆ‡æ¢] è§†è§’å·²ç§»åŠ¨åˆ°1å·ä½ç½®ï¼Œç¼©æ”¾: ${this.state.scale.toFixed(1)}x`);\n      } else {\n        console.log(`[è‡ªåŠ¨åˆ‡æ¢] æœªæ‰¾åˆ°1å·ä½ç½®çš„å‚è€ƒåæ ‡`);\n      }\n    } catch (error) {\n      console.error('[è‡ªåŠ¨åˆ‡æ¢] ç§»åŠ¨åˆ°1å·ä½ç½®å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * ç§»åŠ¨åˆ°æ‰€æœ‰æ ‡æ³¨ç‚¹çš„å‡ ä½•ä¸­å¿ƒ\n   */\n  moveToAnnotationsCenter() {\n    const annotations = this.keypoints || [];\n    if (annotations.length === 0) {\n      return;\n    }\n\n    // è®¡ç®—å‡ ä½•ä¸­å¿ƒ\n    let sumX = 0, sumY = 0;\n    for (const annotation of annotations) {\n      sumX += annotation.x;\n      sumY += annotation.y;\n    }\n\n    const centerX_img = sumX / annotations.length;\n    const centerY_img = sumY / annotations.length;\n\n    console.log(`[è‡ªåŠ¨åˆ‡æ¢] ç§»åŠ¨åˆ°æ ‡æ³¨ç‚¹å‡ ä½•ä¸­å¿ƒ: (${centerX_img.toFixed(1)}, ${centerY_img.toFixed(1)}), å…±${annotations.length}ä¸ªæ ‡æ³¨ç‚¹`);\n\n    // æ£€æŸ¥æ˜¯å¦éœ€è¦åº”ç”¨é”å®šå€æ•°\n    const zoomSettings = typeof window.getZoomLockSettings === 'function' ? window.getZoomLockSettings() : { isLocked: false };\n\n    if (zoomSettings.isLocked) {\n      // é”å®šçŠ¶æ€ï¼šä½¿ç”¨é”å®šå€æ•°\n      this.state.scale = zoomSettings.lockValue;\n      console.log(`[è‡ªåŠ¨åˆ‡æ¢] åº”ç”¨é”å®šå€æ•°: ${zoomSettings.lockValue}x`);\n    } else {\n      // éé”å®šçŠ¶æ€ï¼šä¿æŒå½“å‰å€æ•°\n      console.log(`[è‡ªåŠ¨åˆ‡æ¢] ä¿æŒå½“å‰å€æ•°: ${this.state.scale.toFixed(1)}x`);\n    }\n\n    const centerX = this.canvas.width / 2;\n    const centerY = this.canvas.height / 2;\n\n    // è®¡ç®—æ–°çš„ä½ç½®\n    this.state.translateX = centerX - (centerX_img * this.state.scale);\n    this.state.translateY = centerY - (centerY_img * this.state.scale);\n\n    // ç¡®ä¿å›¾åƒä¸ä¼šè¶…å‡ºè¾¹ç•Œ\n    this.constrainView();\n\n    this.updateZoomInfo();\n    this.render();\n\n    console.log(`[è‡ªåŠ¨åˆ‡æ¢] è§†è§’å·²ç§»åŠ¨åˆ°æ ‡æ³¨ç‚¹å‡ ä½•ä¸­å¿ƒï¼Œç¼©æ”¾: ${this.state.scale.toFixed(1)}x`);\n  }\n\n  /**\n   * ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªé¢„æœŸä½ç½®ï¼ˆåŸæœ‰é€»è¾‘ï¼‰\n   */\n  async moveToNextExpectedPosition() {\n    try {\n      // è·å–åˆ†æ”¯ç‚¹é¢„è§ˆç®¡ç†å™¨\n      const branchPointPreviewManager = window.PlantAnnotationTool?.branchPointPreviewManager;\n      if (!branchPointPreviewManager) {\n        console.log('[è‡ªåŠ¨åˆ‡æ¢] é¢„è§ˆç®¡ç†å™¨ä¸å¯ç”¨');\n        return;\n      }\n\n      // è·å–ä¸‹ä¸€ä¸ªè¦æ ‡æ³¨çš„ç¼–å·\n      const nextOrder = this.findNextAvailableOrder();\n\n      // ä»é¢„è§ˆç®¡ç†å™¨è·å–é¢„æœŸä½ç½®\n      const expectedPosition = await branchPointPreviewManager.getExpectedPosition(nextOrder);\n\n      if (expectedPosition) {\n        console.log(`[è‡ªåŠ¨åˆ‡æ¢] ç§»åŠ¨åˆ°é¢„æœŸä½ç½®: ç¼–å·${nextOrder}, åæ ‡(${expectedPosition.x.toFixed(1)}, ${expectedPosition.y.toFixed(1)})`);\n\n        // æ£€æŸ¥æ˜¯å¦éœ€è¦åº”ç”¨é”å®šå€æ•°\n        const zoomSettings = typeof window.getZoomLockSettings === 'function' ? window.getZoomLockSettings() : { isLocked: false };\n\n        if (zoomSettings.isLocked) {\n          // é”å®šçŠ¶æ€ï¼šä½¿ç”¨é”å®šå€æ•°\n          this.state.scale = zoomSettings.lockValue;\n          console.log(`[è‡ªåŠ¨åˆ‡æ¢] åº”ç”¨é”å®šå€æ•°: ${zoomSettings.lockValue}x`);\n        } else {\n          // éé”å®šçŠ¶æ€ï¼šä¿æŒå½“å‰å€æ•°\n          console.log(`[è‡ªåŠ¨åˆ‡æ¢] ä¿æŒå½“å‰å€æ•°: ${this.state.scale.toFixed(1)}x`);\n        }\n\n        const centerX = this.canvas.width / 2;\n        const centerY = this.canvas.height / 2;\n\n        // è®¡ç®—æ–°çš„ä½ç½®\n        this.state.translateX = centerX - (expectedPosition.x * this.state.scale);\n        this.state.translateY = centerY - (expectedPosition.y * this.state.scale);\n\n        // ç¡®ä¿å›¾åƒä¸ä¼šè¶…å‡ºè¾¹ç•Œ\n        this.constrainView();\n\n        this.updateZoomInfo();\n        this.render();\n\n        console.log(`[è‡ªåŠ¨åˆ‡æ¢] è§†è§’å·²ç§»åŠ¨åˆ°é¢„æœŸä½ç½®ï¼Œç¼©æ”¾: ${this.state.scale.toFixed(1)}x`);\n      } else {\n        console.log(`[è‡ªåŠ¨åˆ‡æ¢] æœªæ‰¾åˆ°ç¼–å·${nextOrder}çš„é¢„æœŸä½ç½®`);\n      }\n    } catch (error) {\n      console.error('[è‡ªåŠ¨åˆ‡æ¢] ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªé¢„æœŸä½ç½®å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * å°è¯•è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡ç»§ç»­è‡ªåŠ¨åŒ–\n   */\n  tryAutoSwitchToNextImage() {\n    // æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€çš„å›¾ç‰‡å¯¼èˆªåŠŸèƒ½\n    if (typeof window.navigateToNextImage === 'function') {\n      // è°ƒç”¨å…¨å±€çš„ä¸‹ä¸€å¼ å›¾ç‰‡å‡½æ•°ï¼ˆè‡ªåŠ¨åŒ–æ¨¡å¼ï¼Œä¸å¾ªç¯ï¼‰\n      window.navigateToNextImage(true).then(success => {\n        if (success) {\n          // åˆ‡æ¢æˆåŠŸï¼Œå»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç­‰å¾…å›¾ç‰‡åŠ è½½ï¼Œç„¶åé‡æ–°å¼€å§‹è‡ªåŠ¨åŒ–\n          setTimeout(() => {\n            this.restartAutoDirectionMode();\n          }, 300);\n        } else {\n          // æ²¡æœ‰ä¸‹ä¸€å¼ å›¾ç‰‡ï¼Œç»“æŸè‡ªåŠ¨åŒ–\n          console.log('æ²¡æœ‰æ›´å¤šå›¾ç‰‡ï¼Œç»“æŸè‡ªåŠ¨åŒ–');\n          this.exitAutoDirectionMode();\n          this.resetAutoDirectionButton();\n\n          if (window.showSuccess) {\n            window.showSuccess('å…¨éƒ¨å®Œæˆ', 'æ‰€æœ‰å›¾ç‰‡çš„æ–¹å‘è®¾ç½®å·²å®Œæˆï¼');\n          }\n        }\n      });\n      return true; // è¡¨ç¤ºå·²ç»å¤„ç†äº†åˆ‡æ¢é€»è¾‘\n    }\n\n    // å¦‚æœæ²¡æœ‰å…¨å±€å¯¼èˆªå‡½æ•°ï¼Œå°è¯•æ¨¡æ‹Ÿå³ç®­å¤´é”®\n    if (typeof window.handleKeyDown === 'function') {\n      const rightArrowEvent = {\n        key: 'ArrowRight',\n        preventDefault: () => {},\n        stopPropagation: () => {}\n      };\n\n      window.handleKeyDown(rightArrowEvent);\n\n      // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç­‰å¾…å›¾ç‰‡åˆ‡æ¢ï¼Œç„¶åé‡æ–°å¼€å§‹è‡ªåŠ¨åŒ–\n      setTimeout(() => {\n        this.restartAutoDirectionMode();\n      }, 200);\n      return true;\n    }\n\n    return false; // æ— æ³•åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡\n  }\n\n  /**\n   * é‡æ–°å¼€å§‹è‡ªåŠ¨åŒ–æ–¹å‘è®¾ç½®æ¨¡å¼ï¼ˆç”¨äºå›¾ç‰‡åˆ‡æ¢åï¼‰\n   */\n  restartAutoDirectionMode() {\n    console.log('[è°ƒè¯•] é‡æ–°å¼€å§‹è‡ªåŠ¨åŒ–æ–¹å‘è®¾ç½®æ¨¡å¼');\n\n    // æ¸…é™¤å½“å‰çŠ¶æ€\n    this.state.isAutoDirectionMode = false;\n    this.state.autoDirectionKeypoints = [];\n    this.state.autoDirectionIndex = 0;\n\n    // é‡æ–°å¯åŠ¨è‡ªåŠ¨åŒ–æ¨¡å¼\n    const success = this.startAutoDirectionMode();\n    if (!success) {\n      // å¦‚æœæ–°å›¾ç‰‡æ²¡æœ‰éœ€è¦è®¾ç½®æ–¹å‘çš„ç‚¹ï¼Œç»“æŸè‡ªåŠ¨åŒ–\n      console.log('æ–°å›¾ç‰‡æ²¡æœ‰éœ€è¦è®¾ç½®æ–¹å‘çš„æ ‡æ³¨ç‚¹ï¼Œç»“æŸè‡ªåŠ¨åŒ–');\n      this.exitAutoDirectionMode();\n      this.resetAutoDirectionButton();\n\n      if (window.showInfo) {\n        window.showInfo('è‡ªåŠ¨åŒ–å®Œæˆ', 'å·²å®Œæˆæ‰€æœ‰å›¾ç‰‡çš„æ–¹å‘è®¾ç½®');\n      }\n    }\n  }\n\n  /**\n   * é‡ç½®è‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©æŒ‰é’®çŠ¶æ€\n   */\n  resetAutoDirectionButton() {\n    const autoDirectionBtn = document.getElementById('auto-direction-btn');\n    if (autoDirectionBtn) {\n      console.log('[è°ƒè¯•] é‡ç½®æŒ‰é’®çŠ¶æ€ä¸ºæ­£å¸¸æ¨¡å¼');\n\n      // ç§»é™¤æš‚åœæ¨¡å¼çš„äº‹ä»¶ç›‘å¬å™¨\n      if (autoDirectionBtn._pauseHandler) {\n        autoDirectionBtn.removeEventListener('click', autoDirectionBtn._pauseHandler);\n        autoDirectionBtn._pauseHandler = null;\n      }\n\n      // æ›´æ–°æŒ‰é’®å¤–è§‚\n      autoDirectionBtn.textContent = 'Auto Direction';\n      autoDirectionBtn.classList.remove('active');\n\n      // é‡æ–°æ·»åŠ åŸå§‹çš„ç‚¹å‡»äº‹ä»¶\n      if (window.handleAutoDirectionSelection) {\n        autoDirectionBtn.addEventListener('click', window.handleAutoDirectionSelection);\n      }\n    }\n  }\n\n  /**\n   * æš‚åœè‡ªåŠ¨åŒ–æ–¹å‘å‡çº§æ¨¡å¼\n   */\n  pauseAutoDirectionMode() {\n    if (!this.state.isAutoDirectionMode) return;\n\n    const remaining = this.state.autoDirectionKeypoints.length - this.state.autoDirectionIndex;\n    const completed = this.state.autoDirectionIndex;\n\n    this.exitAutoDirectionMode();\n\n    // é‡ç½®æŒ‰é’®çŠ¶æ€\n    this.resetAutoDirectionButton();\n\n    console.log(`æ–¹å‘å‡çº§æ¨¡å¼å·²æš‚åœï¼Œå·²å®Œæˆ ${completed} ä¸ªï¼Œå‰©ä½™ ${remaining} ä¸ª`);\n\n    // æ˜¾ç¤ºæš‚åœæç¤º\n    if (window.showInfo) {\n      window.showInfo('å‡çº§æš‚åœ', `å·²å®Œæˆ ${completed} ä¸ªæ ‡æ³¨ç‚¹çš„å‡çº§ï¼Œå‰©ä½™ ${remaining} ä¸ªã€‚å¯é‡æ–°ç‚¹å‡»\"è‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©\"ç»§ç»­ã€‚`);\n    }\n  }\n\n  /**\n   * å¼€å§‹è‡ªå®šä¹‰æ ‡æ³¨æ‹–æ‹½\n   */\n  startCustomAnnotationDrag(annotation, mousePos, handle = null) {\n    if (!this.customAnnotationRenderer) return;\n    \n    this.customAnnotationDragState.isDragging = true;\n    this.customAnnotationDragState.draggedAnnotation = annotation;\n    this.customAnnotationDragState.startPosition = mousePos;\n    \n    // é€šçŸ¥æ¸²æŸ“å™¨å¼€å§‹æ‹–æ‹½\n    this.customAnnotationRenderer.startDrag(annotation, mousePos, handle);\n    \n    this.canvas.style.cursor = 'grabbing';\n    console.log('Started custom annotation drag:', annotation.id);\n  }\n  \n  /**\n   * æ›´æ–°è‡ªå®šä¹‰æ ‡æ³¨æ‹–æ‹½\n   */\n  updateCustomAnnotationDrag(mousePos) {\n    if (!this.customAnnotationRenderer || !this.customAnnotationDragState.isDragging) return;\n    \n    // æ›´æ–°æ‹–æ‹½ä½ç½®\n    const updated = this.customAnnotationRenderer.updateDrag(mousePos);\n    \n    if (updated) {\n      this.render();\n    }\n  }\n  \n  /**\n   * å®Œæˆè‡ªå®šä¹‰æ ‡æ³¨æ‹–æ‹½\n   */\n  finishCustomAnnotationDrag() {\n    if (!this.customAnnotationRenderer || !this.customAnnotationDragState.isDragging) return;\n    \n    // å®Œæˆæ‹–æ‹½\n    const result = this.customAnnotationRenderer.finishDrag();\n    \n    if (result && result.moved) {\n      // æ ‡æ³¨è¢«ç§»åŠ¨äº†ï¼Œè§¦å‘ä¿å­˜å’ŒåŒæ­¥\n      this.customAnnotationManager.saveToStorage();\n      \n      // è§¦å‘æ›´æ–°äº‹ä»¶\n      this.customAnnotationManager.triggerEvent('onAnnotationUpdate', result.annotation);\n      \n      // å®æ—¶åŒæ­¥\n      this.customAnnotationManager.triggerCustomAnnotationUpdateSync(result.annotation, {\n        imageId: this.getAppState()?.currentImage?.id,\n        positionChange: {\n          from: result.startPosition,\n          to: {\n            x: result.annotation.x,\n            y: result.annotation.y\n          }\n        },\n        timestamp: new Date().toISOString()\n      });\n      \n      // ğŸ”§ FIX: æ›´æ–°é¢„è§ˆåŒºåŸŸ - åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n      this.syncBranchPointPreview();\n      \n      console.log('Custom annotation dragged and saved:', result.annotation.id);\n    }\n    \n    // æ¸…é™¤æ‹–æ‹½çŠ¶æ€\n    this.customAnnotationDragState.isDragging = false;\n    this.customAnnotationDragState.draggedAnnotation = null;\n    this.customAnnotationDragState.startPosition = null;\n    \n    this.canvas.style.cursor = 'crosshair';\n    this.render();\n  }\n  \n  /**\n   * å–æ¶ˆè‡ªå®šä¹‰æ ‡æ³¨æ‹–æ‹½\n   */\n  cancelCustomAnnotationDrag() {\n    if (!this.customAnnotationRenderer || !this.customAnnotationDragState.isDragging) return;\n    \n    // å–æ¶ˆæ‹–æ‹½\n    this.customAnnotationRenderer.cancelDrag();\n    \n    // æ¸…é™¤æ‹–æ‹½çŠ¶æ€\n    this.customAnnotationDragState.isDragging = false;\n    this.customAnnotationDragState.draggedAnnotation = null;\n    this.customAnnotationDragState.startPosition = null;\n    \n    this.canvas.style.cursor = 'crosshair';\n    this.render();\n    \n    console.log('Cancelled custom annotation drag');\n  }\n  \n  /**\n   * è·å–åº”ç”¨çŠ¶æ€\n   */\n  getAppState() {\n    return window.PlantAnnotationTool?.appState;\n  }\n\n  /**\n   * ç»‘å®šçˆ¶èŠ‚ç‚¹åˆ°æŒ‡å®šç±»å‹ä¸åºå·å¹¶è·¨æ—¶åºåŒæ­¥\n   */\n  async bindParentForOrderAcrossImages(childTypeId, childOrder, parentTypeId, parentOrder) {\n    const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n    const appState = window.PlantAnnotationTool?.appState;\n    if (!plantDataManager || !appState?.currentPlant) throw new Error('Missing plant context');\n    \n    console.log('[è°ƒè¯•] å¼€å§‹è·¨å›¾ç‰‡åŒæ­¥å…³è”:', {\n      childTypeId, childOrder, parentTypeId, parentOrder,\n      plant: appState.currentPlant.id,\n      viewAngle: appState.currentPlant.selectedViewAngle\n    });\n    \n    const images = await plantDataManager.getPlantImages(appState.currentPlant.id, appState.currentPlant.selectedViewAngle);\n    let syncCount = 0;\n    let skipCount = 0;\n    \n    for (const image of images) {\n      try {\n        const annotations = await plantDataManager.getImageAnnotations(image.id);\n        \n        // å¿…é¡»åŒæ—¶æ‰¾åˆ°å¯¹åº”orderçš„å­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹æ‰èƒ½åŒæ­¥\n        const child = annotations.find(a => a.annotationType === 'custom' && a.customTypeId === childTypeId && a.order === childOrder);\n        const parent = annotations.find(a => a.annotationType === 'custom' && a.customTypeId === parentTypeId && a.order === parentOrder);\n        \n        if (child && parent) {\n          // æ›´æ–°å­èŠ‚ç‚¹çš„çˆ¶ç»‘å®šä¿¡æ¯\n          child.parentAnnotationType = parentTypeId;\n          child.parentAnnotationId = parentOrder;\n          await plantDataManager.saveImageAnnotations(image.id, annotations);\n          syncCount++;\n          console.log(`[è°ƒè¯•] å›¾ç‰‡ ${image.id} åŒæ­¥æˆåŠŸ: ${childTypeId}#${childOrder} â†’ ${parentTypeId}#${parentOrder}`);\n        } else {\n          skipCount++;\n          const reason = !child ? `ç¼ºå°‘å­èŠ‚ç‚¹ ${childTypeId}#${childOrder}` : \n                       !parent ? `ç¼ºå°‘çˆ¶èŠ‚ç‚¹ ${parentTypeId}#${parentOrder}` : 'æœªçŸ¥åŸå› ';\n          console.log(`[è°ƒè¯•] å›¾ç‰‡ ${image.id} è·³è¿‡åŒæ­¥: ${reason}`);\n        }\n      } catch (e) {\n        skipCount++;\n        console.warn(`[è°ƒè¯•] å›¾ç‰‡ ${image.id} åŒæ­¥å¤±è´¥:`, e.message);\n      }\n    }\n    \n    // ä¿å­˜å½“å‰å›¾ç‰‡çš„æ›´æ”¹\n    try {\n      const currentImageId = window.PlantAnnotationTool?.appState?.currentImage?.id;\n      if (currentImageId) {\n        await plantDataManager.saveImageAnnotations(currentImageId, this.keypoints);\n        console.log(`[è°ƒè¯•] å½“å‰å›¾ç‰‡ ${currentImageId} çš„çˆ¶å­å…³è”å·²ä¿å­˜`);\n      }\n    } catch (e) {\n      console.warn('[è°ƒè¯•] ä¿å­˜å½“å‰å›¾ç‰‡å¤±è´¥:', e.message);\n    }\n    \n    console.log(`[è°ƒè¯•] è·¨å›¾ç‰‡åŒæ­¥å®Œæˆ: æˆåŠŸ ${syncCount} å¼ ï¼Œè·³è¿‡ ${skipCount} å¼ `);\n    this.render();\n  }\n  \n  /**\n   * åˆå§‹åŒ–è‡ªå®šä¹‰æ ‡æ³¨ç³»ç»Ÿ\n   */\n  async initializeCustomAnnotationSystem() {\n    try {\n      // åŠ¨æ€å¯¼å…¥è‡ªå®šä¹‰æ ‡æ³¨ç®¡ç†å™¨\n      const { CustomAnnotationManager } = await import('./CustomAnnotationManager.js');\n      this.customAnnotationManager = new CustomAnnotationManager(this);\n      \n      // ğŸ”„ NEW: è®¾ç½®å®æ—¶åŒæ­¥ç®¡ç†å™¨\n      const realTimeSyncManager = window.PlantAnnotationTool?.realTimeSyncManager;\n      if (realTimeSyncManager) {\n        this.customAnnotationManager.setRealTimeSyncManager(realTimeSyncManager);\n        console.log('Custom annotation real-time sync manager connected');\n      } else {\n        console.warn('Real-time sync manager not available for custom annotations');\n      }\n      \n      // ğŸ”§ NEW: æ·»åŠ æ¨¡å¼å˜åŒ–ç›‘å¬å™¨åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n      this.customAnnotationManager.addEventListener('onModeChange', (data) => {\n        console.log('Mode changed:', data.mode, 'Type:', data.typeId);\n        this.syncBranchPointPreview();\n        \n        // æ›´æ–°SIFTæŒ‰é’®çŠ¶æ€\n        if (window.updateSiftButtonState && typeof window.updateSiftButtonState === 'function') {\n          window.updateSiftButtonState();\n        }\n      });\n      \n      console.log('CustomAnnotationManager initialized');\n      \n      // åŠ¨æ€å¯¼å…¥è‡ªå®šä¹‰æ ‡æ³¨æ¸²æŸ“å™¨\n      const { CustomAnnotationRenderer } = await import('./CustomAnnotationRenderer.js');\n      this.customAnnotationRenderer = new CustomAnnotationRenderer(this, this.customAnnotationManager);\n      console.log('CustomAnnotationRenderer initialized');\n      \n      // æ ‡è®°ç³»ç»Ÿå·²å°±ç»ª\n      this.customAnnotationSystemReady = true;\n      \n      // é€šçŸ¥ç³»ç»Ÿè‡ªå®šä¹‰æ ‡æ³¨ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª\n      if (window.onCustomAnnotationSystemReady && typeof window.onCustomAnnotationSystemReady === 'function') {\n        setTimeout(() => {\n          window.onCustomAnnotationSystemReady();\n        }, 100); // ç»™ä¸€ä¸ªå°å»¶è¿Ÿç¡®ä¿å®Œå…¨åˆå§‹åŒ–\n      }\n      \n    } catch (error) {\n      console.warn('Failed to initialize custom annotation system:', error);\n    }\n  }\n\n  /**\n   * æ¸²æŸ“è‡ªå®šä¹‰æ ‡æ³¨ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼‰\n   * æ³¨æ„ï¼šåœ¨ç»Ÿä¸€ç³»ç»Ÿä¸­ï¼Œè‡ªå®šä¹‰æ ‡æ³¨å·²ç»é›†æˆåˆ°keypointsæ•°ç»„ä¸­ï¼Œ\n   * å¹¶é€šè¿‡renderKeypointsæ–¹æ³•ç»Ÿä¸€æ¸²æŸ“ï¼Œæ­¤æ–¹æ³•ä»…ä¿ç•™å…¼å®¹æ€§\n   */\n  renderCustomAnnotations() {\n    // åœ¨ç»Ÿä¸€ç³»ç»Ÿä¸­ï¼Œè‡ªå®šä¹‰æ ‡æ³¨å·²ç»é€šè¿‡ renderKeypoints() æ–¹æ³•æ¸²æŸ“\n    // è¿™é‡Œä¿ç•™æ–¹æ³•ä»¥ç»´æŒå…¼å®¹æ€§ï¼Œä½†ä¸æ‰§è¡Œä»»ä½•æ“ä½œ\n    console.debug('renderCustomAnnotations called (unified system - no action needed)');\n  }\n\n  /**\n   * è·å–æŒ‡å®šä½ç½®çš„è‡ªå®šä¹‰æ ‡æ³¨ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼‰\n   */\n  getCustomAnnotationAt(mousePos) {\n    // åœ¨ç»Ÿä¸€ç³»ç»Ÿä¸­ï¼Œè‡ªå®šä¹‰æ ‡æ³¨å­˜å‚¨åœ¨keypointsæ•°ç»„ä¸­\n    const threshold = this.options.baseKeypointRadius + 5;\n    \n    return this.keypoints.find(keypoint => {\n      // åªæ£€æŸ¥è‡ªå®šä¹‰æ ‡æ³¨\n      if (keypoint.annotationType !== 'custom') return false;\n      \n      const keypointScreen = this.imageToScreen(keypoint.x, keypoint.y);\n      \n      if (keypoint.width && keypoint.height) {\n        // åŒºåŸŸæ ‡æ³¨ - æ£€æŸ¥æ˜¯å¦åœ¨çŸ©å½¢åŒºåŸŸå†…\n        const bottomRight = this.imageToScreen(keypoint.x + keypoint.width, keypoint.y + keypoint.height);\n        return mousePos.x >= keypointScreen.x && mousePos.x <= bottomRight.x &&\n               mousePos.y >= keypointScreen.y && mousePos.y <= bottomRight.y;\n      } else {\n        // ç‚¹æ ‡æ³¨ - æ£€æŸ¥è·ç¦»\n        const distance = Math.sqrt(\n          Math.pow(mousePos.x - keypointScreen.x, 2) +\n          Math.pow(mousePos.y - keypointScreen.y, 2)\n        );\n        return distance <= threshold;\n      }\n    }) || null;\n  }\n\n  /**\n   * å¤„ç†è‡ªå®šä¹‰æ ‡æ³¨ç‚¹å‡»ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼‰\n   */\n  handleCustomAnnotationClick(customAnnotation, mousePos) {\n    // åœ¨ç»Ÿä¸€ç³»ç»Ÿä¸­ï¼Œè‡ªå®šä¹‰æ ‡æ³¨ç‚¹å‡»å¤„ç†ä¸å¸¸è§„æ ‡æ³¨ç›¸åŒ\n    console.log('Custom annotation clicked:', customAnnotation.id, 'type:', customAnnotation.annotationType);\n    \n    // ğŸ”§ NEW: å¤„ç†Auto Orderæ¨¡å¼ä¸‹çš„ç‚¹å‡»\n    if (this.state.isAutoOrderMode) {\n      const handled = this.handleAutoOrderAnnotationClick(customAnnotation);\n      if (handled) {\n        return; // Auto Orderå¤„ç†äº†ç‚¹å‡»ï¼Œç›´æ¥è¿”å›\n      }\n    }\n    \n    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰æ ‡æ³¨ç‰¹æœ‰çš„ç‚¹å‡»é€»è¾‘\n    // ä¾‹å¦‚æ˜¾ç¤ºè‡ªå®šä¹‰æ ‡æ³¨çš„è¯¦ç»†ä¿¡æ¯\n    const customType = this.getCustomType(customAnnotation.customTypeId);\n    if (customType) {\n      console.log('Custom type:', customType.name, 'color:', customType.color);\n    }\n\n    // è‹¥æœªå¤„äºçˆ¶èŠ‚ç‚¹é€‰æ‹©/æ–¹å‘é€‰æ‹©/åŒºåŸŸæ‹–æ‹½ï¼Œç‚¹å‡»ä»»ä½•è‡ªå®šä¹‰æ ‡æ³¨å³åˆ‡æ¢ Annotation Type\n    if (!this.state.isSelectingParent && !this.state.isDirectionSelectionMode && !this.customAnnotationDragState.isDragging) {\n      if (customAnnotation.annotationType === 'custom' && customAnnotation.customTypeId && this.customAnnotationManager) {\n        try { this.customAnnotationManager.setCustomAnnotationMode(customAnnotation.customTypeId); } catch (e) {}\n      }\n      \n      // ğŸ”§ FIX: ä¸åœ¨mouseDowné˜¶æ®µç«‹å³é€‰ä¸­ï¼Œå»¶è¿Ÿåˆ°mouseUpé˜¶æ®µåˆ¤æ–­æ˜¯ç‚¹å‡»è¿˜æ˜¯æ‹–æ‹½\n      // åŒºåŸŸç±»å‹ï¼šç«‹å³é€‰ä¸­ï¼ˆå› ä¸ºåŒºåŸŸéœ€è¦å¤„ç†resize handlesï¼‰\n      if (customAnnotation.width && customAnnotation.height) {\n        this.state.selectedKeypoint = customAnnotation;\n        this.state.isDirectionSelectionMode = false;\n        this.customAnnotationRenderer?.setSelectedAnnotation(customAnnotation);\n        console.log('[è°ƒè¯•] Regionå·²åœ¨handleCustomAnnotationClickä¸­è®¾ä¸ºé€‰ä¸­:', customAnnotation.id);\n        this.render();\n      } else {\n        // ç‚¹ç±»å‹ï¼šä¸åœ¨è¿™é‡Œç«‹å³é€‰ä¸­ï¼Œç­‰å¾…mouseUpåˆ¤æ–­æ˜¯ç‚¹å‡»è¿˜æ˜¯æ‹–æ‹½\n        console.log('[è°ƒè¯•] ç‚¹ç±»å‹æ ‡æ³¨è¢«ç‚¹å‡»ï¼Œç­‰å¾…mouseUpåˆ¤æ–­æ˜¯ç‚¹å‡»è¿˜æ˜¯æ‹–æ‹½');\n      }\n    }\n  }\n\n  /**\n   * å¤„ç†è‡ªå®šä¹‰æ ‡æ³¨æ¨¡å¼ä¸‹çš„ç‚¹å‡»\n   */\n  handleCustomAnnotationMode(mousePos) {\n    if (!this.customAnnotationManager) {\n      console.warn('Custom annotation manager not available');\n      return;\n    }\n    \n    // ğŸ”§ NEW: è¿›å…¥è‡ªå®šä¹‰æ ‡æ³¨æ¨¡å¼æ—¶ä¸­æ–­æ‰€æœ‰æ–¹å‘ç›¸å…³æ¨¡å¼\n    this.interruptAllDirectionModes('custom_annotation_mode');\n    \n    try {\n      const appState = window.PlantAnnotationTool?.appState;\n      const currentImageId = appState?.currentImage?.id;\n      \n      if (!currentImageId) {\n        console.warn('No current image ID available for custom annotation');\n        return;\n      }\n      \n      const customType = this.customAnnotationManager.getCurrentCustomType();\n      if (!customType) {\n        console.warn('No custom type selected');\n        return;\n      }\n      \n      if (customType.type === 'region') {\n        // åŒºåŸŸç±»å‹ï¼šå¼€å§‹æ‹–æ‹½\n        this.startCustomRegionDrag(mousePos);\n      } else if (customType.type === 'point') {\n        // ç‚¹ç±»å‹ï¼šä½¿ç”¨ç»Ÿä¸€ç³»ç»Ÿç›´æ¥åˆ›å»ºç‚¹\n        const imagePos = this.screenToImage(mousePos.x, mousePos.y);\n        \n        // ğŸ”§ FIX: ä½¿ç”¨ç»Ÿä¸€ç³»ç»Ÿæ–¹æ³•åˆ›å»ºè‡ªå®šä¹‰ç‚¹æ ‡æ³¨\n        const keypoint = this.addCustomPointAnnotation(imagePos.x, imagePos.y, customType.id);\n        \n        if (keypoint) {\n          console.log('Created unified custom point annotation:', keypoint);\n          // æ¸²æŸ“å·²ç»åœ¨addCustomPointAnnotationä¸­è§¦å‘\n        } else {\n          console.warn('Failed to create custom point annotation');\n        }\n      }\n    } catch (error) {\n      console.warn('Failed to handle custom annotation mode:', error);\n    }\n  }\n\n  /**\n   * å¼€å§‹è‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½\n   */\n  startCustomRegionDrag(mousePos) {\n    if (!this.canCreateAnnotationAt(mousePos.x, mousePos.y)) {\n      console.warn('Cannot create custom region annotation: position is outside valid area');\n      return;\n    }\n\n    this.state.isCustomRegionDragging = true;\n    this.state.customRegionStartPoint = mousePos;\n    this.state.customRegionCurrentPoint = mousePos;\n    this.canvas.style.cursor = 'crosshair';\n    \n    console.log('Started custom region drag at:', mousePos);\n  }\n\n  /**\n   * æ›´æ–°è‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½\n   */\n  updateCustomRegionDrag(mousePos) {\n    if (!this.state.isCustomRegionDragging) return;\n    \n    this.state.customRegionCurrentPoint = mousePos;\n    this.render(); // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºæ‹–æ‹½é¢„è§ˆ\n  }\n\n  /**\n   * å®Œæˆè‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½\n   */\n  finishCustomRegionDrag() {\n    if (!this.state.isCustomRegionDragging || !this.state.customRegionStartPoint || !this.state.customRegionCurrentPoint) {\n      this.resetCustomRegionDrag();\n      return;\n    }\n\n    const startPos = this.screenToImage(this.state.customRegionStartPoint.x, this.state.customRegionStartPoint.y);\n    const endPos = this.screenToImage(this.state.customRegionCurrentPoint.x, this.state.customRegionCurrentPoint.y);\n\n    // æ£€æŸ¥æ‹–æ‹½è·ç¦»æ˜¯å¦è¶³å¤Ÿï¼ˆä»¥å±å¹•åƒç´ ä¸ºå‡†ï¼Œé¿å…é«˜å€ç¼©æ”¾ä¸‹è¯¯åˆ¤ï¼‰\n    const startScreen = this.state.customRegionStartPoint;\n    const currentScreen = this.state.customRegionCurrentPoint;\n    const screenWidth = Math.abs(currentScreen.x - startScreen.x);\n    const screenHeight = Math.abs(currentScreen.y - startScreen.y);\n    const minScreenSize = 8; // å±å¹•åƒç´ é˜ˆå€¼\n\n    if (screenWidth < minScreenSize || screenHeight < minScreenSize) {\n      console.log('Region too small, ignoring');\n      this.resetCustomRegionDrag();\n      return;\n    }\n\n    // è·å–å½“å‰å›¾åƒID\n    const appState = window.PlantAnnotationTool?.appState;\n    const imageId = appState?.currentImage?.id;\n\n    if (!imageId) {\n      console.warn('No current image ID available for custom region annotation');\n      this.resetCustomRegionDrag();\n      return;\n    }\n\n    // åˆ›å»ºåŒºåŸŸæ ‡æ³¨\n    try {\n      const currentCustomType = this.customAnnotationManager.getCurrentCustomType();\n      if (!currentCustomType) {\n        console.warn('No custom type selected for region annotation');\n        this.resetCustomRegionDrag();\n        return;\n      }\n      \n      // è®¡ç®—åŒºåŸŸä½ç½®ä¸å°ºå¯¸ï¼ˆå›¾åƒåæ ‡ï¼‰\n      const x = Math.min(startPos.x, endPos.x);\n      const y = Math.min(startPos.y, endPos.y);\n      const width = Math.abs(endPos.x - startPos.x);\n      const height = Math.abs(endPos.y - startPos.y);\n      \n      // ğŸ”§ FIX: ä½¿ç”¨ç»Ÿä¸€ç³»ç»Ÿæ–¹æ³•åˆ›å»ºè‡ªå®šä¹‰åŒºåŸŸæ ‡æ³¨\n      const keypoint = this.addCustomRegionAnnotation(x, y, width, height, currentCustomType.id);\n      \n      if (keypoint) {\n        console.log('Created unified custom region annotation:', keypoint);\n        // æ¸²æŸ“å·²ç»åœ¨addCustomRegionAnnotationä¸­è§¦å‘\n      } else {\n        console.warn('Failed to create custom region annotation');\n      }\n    } catch (error) {\n      console.error('Error creating custom region annotation:', error);\n    }\n\n    this.resetCustomRegionDrag();\n  }\n\n  /**\n   * é‡ç½®è‡ªå®šä¹‰åŒºåŸŸæ‹–æ‹½çŠ¶æ€\n   */\n  resetCustomRegionDrag() {\n    this.state.isCustomRegionDragging = false;\n    this.state.customRegionStartPoint = null;\n    this.state.customRegionCurrentPoint = null;\n    this.canvas.style.cursor = 'crosshair';\n    this.render();\n  }\n\n  /**\n   * åˆ é™¤è‡ªå®šä¹‰æ ‡æ³¨ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼‰\n   * @param {Object} customAnnotation - è¦åˆ é™¤çš„è‡ªå®šä¹‰æ ‡æ³¨ keypoint\n   */\n  removeCustomAnnotation(customAnnotation) {\n    // åœ¨ç»Ÿä¸€ç³»ç»Ÿä¸­ï¼Œè‡ªå®šä¹‰æ ‡æ³¨ä¹Ÿæ˜¯keypointï¼Œç›´æ¥è°ƒç”¨removeKeypoint\n    this.removeKeypoint(customAnnotation);\n  }\n\n  // é€‰æ‹©çˆ¶èŠ‚ç‚¹æ¨¡å¼ï¼ˆç®€ç‰ˆï¼‰\n  enableParentSelectionMode(childTypeId) {\n    this.state.isSelectingParent = true;\n    this.state.parentSelectionForType = childTypeId;\n    this.canvas.style.cursor = 'cell';\n  }\n  disableParentSelectionMode() {\n    this.state.isSelectingParent = false;\n    this.state.parentSelectionForType = null;\n    this.canvas.style.cursor = 'crosshair';\n  }\n\n  /**\n   * è·å–è‡ªå®šä¹‰æ ‡æ³¨ç®¡ç†å™¨\n   */\n  getCustomAnnotationManager() {\n    return this.customAnnotationManager;\n  }\n\n  /**\n   * è·å–è‡ªå®šä¹‰æ ‡æ³¨æ¸²æŸ“å™¨\n   */\n  getCustomAnnotationRenderer() {\n    return this.customAnnotationRenderer;\n  }\n\n  // ğŸ”§ NEW: Multi-Direction Annotation Methods\n  \n  /**\n   * å¤„ç†ä¸­é”®ç‚¹å‡» - è¿›å…¥/é€€å‡ºæ–¹å‘æ•°é‡é€‰æ‹©æ¨¡å¼\n   */\n  handleMiddleMouseButton(mousePos) {\n    // åªæœ‰åœ¨é€‰ä¸­äº†æ ‡æ³¨ç‚¹æ—¶æ‰å…è®¸è¿›å…¥æ–¹å‘æ•°é‡æ¨¡å¼\n    if (!this.state.selectedKeypoint) {\n      // è‹¥æœªé€‰ä¸­ï¼Œå°è¯•ä¼˜å…ˆé€‰æ‹©æ‚¬åœç‚¹ï¼›å¦åˆ™å‘½ä¸­æœ€è¿‘ç‚¹\n      let candidate = this.hoveredKeypoint;\n      if (!candidate) {\n        const kp = this.getKeypointAt(mousePos);\n        if (kp) candidate = kp;\n      }\n      if (candidate) {\n        this.selectKeypoint(candidate);\n      } else {\n        console.log('[å¤šæ–¹å‘] æœªé€‰ä¸­æ ‡æ³¨ç‚¹ï¼Œå¿½ç•¥ä¸­é”®ç‚¹å‡»');\n        return;\n      }\n    }\n\n    if (this.state.isDirectionCountMode) {\n      // é€€å‡ºæ–¹å‘æ•°é‡æ¨¡å¼å¹¶åº”ç”¨é€‰æ‹©çš„æ–¹å‘æ•°é‡\n      this.exitDirectionCountMode();\n    } else {\n      // è¿›å…¥æ–¹å‘æ•°é‡æ¨¡å¼\n      this.enterDirectionCountMode();\n    }\n  }\n\n  /**\n   * è¿›å…¥æ–¹å‘æ•°é‡é€‰æ‹©æ¨¡å¼\n   */\n  enterDirectionCountMode() {\n    console.log('[å¤šæ–¹å‘] è¿›å…¥æ–¹å‘æ•°é‡é€‰æ‹©æ¨¡å¼');\n    \n    this.state.isDirectionCountMode = true;\n    this.state.currentDirectionCount = this.state.selectedKeypoint.maxDirections || 1;\n    \n    // æ˜¾ç¤ºæç¤ºä¿¡æ¯\n    this.showDirectionCountPrompt('ä½¿ç”¨æ»šè½®è°ƒæ•´æ–¹å‘æ•°é‡ï¼Œå†æ¬¡æŒ‰ä¸­é”®ç¡®è®¤');\n    \n    // æ”¹å˜å…‰æ ‡æ ·å¼\n    this.canvas.style.cursor = 'help';\n  }\n\n  /**\n   * é€€å‡ºæ–¹å‘æ•°é‡é€‰æ‹©æ¨¡å¼\n   */\n  exitDirectionCountMode() {\n    console.log('[å¤šæ–¹å‘] é€€å‡ºæ–¹å‘æ•°é‡é€‰æ‹©æ¨¡å¼ï¼Œåº”ç”¨æ–¹å‘æ•°é‡:', this.state.currentDirectionCount);\n    \n    // åº”ç”¨é€‰æ‹©çš„æ–¹å‘æ•°é‡åˆ°å½“å‰æ ‡æ³¨ç‚¹\n    if (this.state.selectedKeypoint) {\n      // ğŸ”§ BUG FIX: ç¡®ä¿æ ‡æ³¨ç‚¹å…·æœ‰å¤šæ–¹å‘æ”¯æŒ\n      this.ensureMultiDirectionSupport(this.state.selectedKeypoint);\n      \n      this.state.selectedKeypoint.maxDirections = this.state.currentDirectionCount;\n      \n      // å¦‚æœæ–°çš„æ–¹å‘æ•°é‡å°äºå·²æœ‰æ–¹å‘æ•°é‡ï¼Œéœ€è¦æˆªæ–­\n      if (this.state.selectedKeypoint.directions.length > this.state.currentDirectionCount) {\n        this.state.selectedKeypoint.directions = this.state.selectedKeypoint.directions.slice(0, this.state.currentDirectionCount);\n        console.log('[å¤šæ–¹å‘] æˆªæ–­directionsæ•°ç»„åˆ°', this.state.currentDirectionCount, 'ä¸ª');\n      }\n    }\n    \n    this.state.isDirectionCountMode = false;\n    this.hideDirectionCountPrompt();\n    \n    // æ¢å¤å…‰æ ‡æ ·å¼\n    this.canvas.style.cursor = 'crosshair';\n    \n    // å¼€å§‹è®¾ç½®æ–¹å‘\n    this.startMultiDirectionSetting();\n  }\n\n  /**\n   * å¤„ç†æ»šè½®è°ƒæ•´æ–¹å‘æ•°é‡\n   */\n  handleScrollWheel(event) {\n    if (!this.state.isDirectionCountMode) {\n      return;\n    }\n\n    const delta = -event.deltaY;\n    const direction = delta > 0 ? 1 : -1;\n    \n    // è°ƒæ•´æ–¹å‘æ•°é‡ï¼ˆé™åˆ¶åœ¨1-8ä¹‹é—´ï¼‰\n    const newCount = Math.max(1, Math.min(8, this.state.currentDirectionCount + direction));\n    \n    if (newCount !== this.state.currentDirectionCount) {\n      this.state.currentDirectionCount = newCount;\n      this.updateDirectionCountDisplay();\n      console.log('[å¤šæ–¹å‘] æ–¹å‘æ•°é‡è°ƒæ•´ä¸º:', newCount);\n    }\n  }\n\n  /**\n   * æ˜¾ç¤ºæ–¹å‘æ•°é‡æç¤º\n   */\n  showDirectionCountPrompt(message) {\n    // åˆ›å»ºæˆ–æ›´æ–°æç¤ºæ¡†\n    let prompt = document.getElementById('direction-count-prompt');\n    if (!prompt) {\n      prompt = document.createElement('div');\n      prompt.id = 'direction-count-prompt';\n      prompt.style.cssText = `\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: rgba(0, 0, 0, 0.8);\n        color: white;\n        padding: 15px 20px;\n        border-radius: 8px;\n        font-size: 14px;\n        z-index: 10000;\n        pointer-events: none;\n        font-family: Arial, sans-serif;\n      `;\n      document.body.appendChild(prompt);\n    }\n    \n    prompt.innerHTML = `\n      <div style=\"margin-bottom: 8px;\">${message}</div>\n      <div style=\"font-size: 18px; font-weight: bold; text-align: center;\">\n        æ–¹å‘æ•°é‡: ${this.state.currentDirectionCount}\n      </div>\n    `;\n  }\n\n  /**\n   * éšè—æ–¹å‘æ•°é‡æç¤º\n   */\n  hideDirectionCountPrompt() {\n    const prompt = document.getElementById('direction-count-prompt');\n    if (prompt) {\n      prompt.remove();\n    }\n  }\n\n  /**\n   * æ›´æ–°æ–¹å‘æ•°é‡æ˜¾ç¤º\n   */\n  updateDirectionCountDisplay() {\n    const prompt = document.getElementById('direction-count-prompt');\n    if (prompt) {\n      prompt.innerHTML = `\n        <div style=\"margin-bottom: 8px;\">ä½¿ç”¨æ»šè½®è°ƒæ•´æ–¹å‘æ•°é‡ï¼Œå†æ¬¡æŒ‰ä¸­é”®ç¡®è®¤</div>\n        <div style=\"font-size: 18px; font-weight: bold; text-align: center;\">\n          æ–¹å‘æ•°é‡: ${this.state.currentDirectionCount}\n        </div>\n      `;\n    }\n  }\n\n  /**\n   * å¼€å§‹å¤šæ–¹å‘è®¾ç½®\n   */\n  startMultiDirectionSetting() {\n    if (!this.state.selectedKeypoint) {\n      return;\n    }\n\n    // ğŸ”§ FIX: Initialize counter based on existing directions\n    this.state.directionsSet = this.state.selectedKeypoint.directions.length;\n    this.state.isDirectionSelectionMode = true;\n    \n    // æ˜¾ç¤ºè¿›åº¦æç¤º\n    this.showMultiDirectionProgress();\n    \n    console.log(`[å¤šæ–¹å‘] å¼€å§‹è®¾ç½® ${this.state.selectedKeypoint.maxDirections} ä¸ªæ–¹å‘ (å·²æœ‰ ${this.state.directionsSet} ä¸ª)`);\n  }\n\n  /**\n   * æ˜¾ç¤ºå¤šæ–¹å‘è®¾ç½®è¿›åº¦\n   */\n  showMultiDirectionProgress() {\n    const keypoint = this.state.selectedKeypoint;\n    if (!keypoint) return;\n    \n    // ğŸ”§ FIX: Use actual directions count for accuracy\n    const actualDirections = keypoint.directions.length;\n    const progress = `${actualDirections}/${keypoint.maxDirections}`;\n    \n    let message;\n    if (actualDirections >= keypoint.maxDirections) {\n      message = `æ‰€æœ‰æ–¹å‘å·²è®¾ç½®å®Œæˆ ${progress}`;\n    } else {\n      message = `è®¾ç½®æ–¹å‘ ${progress} - ç‚¹å‡»è®¾ç½®ç¬¬ ${actualDirections + 1} ä¸ªæ–¹å‘`;\n    }\n    \n    // æ›´æ–°æˆ–åˆ›å»ºè¿›åº¦æç¤º\n    let progressPrompt = document.getElementById('multi-direction-progress');\n    if (!progressPrompt) {\n      progressPrompt = document.createElement('div');\n      progressPrompt.id = 'multi-direction-progress';\n      progressPrompt.style.cssText = `\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: rgba(16, 185, 129, 0.9);\n        color: white;\n        padding: 10px 15px;\n        border-radius: 6px;\n        font-size: 13px;\n        z-index: 10000;\n        pointer-events: none;\n        font-family: Arial, sans-serif;\n      `;\n      document.body.appendChild(progressPrompt);\n    }\n    \n    progressPrompt.textContent = message;\n    \n    // ğŸ”§ FIX: Auto-hide progress when all directions are set\n    if (actualDirections >= keypoint.maxDirections) {\n      setTimeout(() => {\n        this.hideMultiDirectionProgress();\n      }, 2000); // Hide after 2 seconds\n    }\n  }\n\n  /**\n   * éšè—å¤šæ–¹å‘è®¾ç½®è¿›åº¦\n   */\n  hideMultiDirectionProgress() {\n    const progressPrompt = document.getElementById('multi-direction-progress');\n    if (progressPrompt) {\n      progressPrompt.remove();\n    }\n  }\n\n  /**\n   * æ·»åŠ æ–¹å‘åˆ°æ ‡æ³¨ç‚¹\n   */\n  addDirectionToKeypoint(keypoint, direction) {\n    // ğŸ”§ BUG FIX: ç¡®ä¿æ ‡æ³¨ç‚¹å…·æœ‰å¤šæ–¹å‘æ”¯æŒ\n    this.ensureMultiDirectionSupport(keypoint);\n    \n    if (keypoint.directions.length >= keypoint.maxDirections) {\n      console.warn('[å¤šæ–¹å‘] å·²è¾¾åˆ°æœ€å¤§æ–¹å‘æ•°é‡:', keypoint.maxDirections);\n      return false;\n    }\n    \n    keypoint.directions.push(direction);\n    console.log('[å¤šæ–¹å‘] æ·»åŠ æ–¹å‘æˆåŠŸ:', direction, 'åˆ°keypoint #' + keypoint.order);\n    return true;\n  }\n\n  /**\n   * ä»æ ‡æ³¨ç‚¹ç§»é™¤æ–¹å‘\n   */\n  removeDirectionFromKeypoint(keypoint, index) {\n    // ğŸ”§ BUG FIX: ç¡®ä¿æ ‡æ³¨ç‚¹å…·æœ‰å¤šæ–¹å‘æ”¯æŒ\n    this.ensureMultiDirectionSupport(keypoint);\n    \n    if (index < 0 || index >= keypoint.directions.length) {\n      console.warn('[å¤šæ–¹å‘] æ— æ•ˆçš„æ–¹å‘ç´¢å¼•:', index);\n      return false;\n    }\n    \n    const removedDirection = keypoint.directions[index];\n    keypoint.directions.splice(index, 1);\n    console.log('[å¤šæ–¹å‘] ç§»é™¤æ–¹å‘æˆåŠŸ:', removedDirection, 'ä»keypoint #' + keypoint.order);\n    return true;\n  }\n\n  /**\n   * å®Œæˆå¤šæ–¹å‘è®¾ç½®\n   */\n  finishMultiDirectionSetting() {\n    console.log('[å¤šæ–¹å‘] å®Œæˆå¤šæ–¹å‘è®¾ç½®');\n    \n    // æ¸…ç†UIæç¤º\n    this.hideMultiDirectionProgress();\n    \n    // ğŸ”§ FIX: Ensure state consistency before cleanup\n    if (this.state.selectedKeypoint) {\n      // Sync counter with actual directions\n      this.state.directionsSet = this.state.selectedKeypoint.directions.length;\n      \n      // ğŸ”§ FIX: Verify completion state\n      const isComplete = this.state.selectedKeypoint.directions.length >= this.state.selectedKeypoint.maxDirections;\n      console.log(`[å¤šæ–¹å‘] è®¾ç½®çŠ¶æ€: ${this.state.selectedKeypoint.directions.length}/${this.state.selectedKeypoint.maxDirections} (${isComplete ? 'å®Œæˆ' : 'æœªå®Œæˆ'})`);\n    }\n    \n    // é‡ç½®çŠ¶æ€\n    this.state.isDirectionSelectionMode = false;\n    this.state.directionsSet = 0;\n    this.state.selectedKeypoint = null;\n    \n    // æ¢å¤å…‰æ ‡æ ·å¼\n    this.canvas.style.cursor = 'crosshair';\n    \n    // ä¿å­˜çŠ¶æ€\n    this.saveState();\n    this.autoSaveCurrentImage();\n    \n    // åŒæ­¥åˆ†æ”¯ç‚¹é¢„è§ˆ\n    this.syncBranchPointPreview();\n    \n    // è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®\n    this.moveToNextExpectedPosition();\n    \n    console.log('[å¤šæ–¹å‘] å¤šæ–¹å‘è®¾ç½®å®Œæˆ');\n  }\n\n  /**\n   * ä¸­æ–­æ–¹å‘æ•°é‡æ¨¡å¼\n   */\n  interruptDirectionCountMode(reason) {\n    if (this.state.isDirectionCountMode) {\n      console.log('[å¤šæ–¹å‘] æ–¹å‘æ•°é‡æ¨¡å¼è¢«ä¸­æ–­:', reason);\n      \n      this.state.isDirectionCountMode = false;\n      this.state.currentDirectionCount = 1;\n      this.state.selectedKeypoint = null;\n      \n      this.hideDirectionCountPrompt();\n      this.hideMultiDirectionProgress();\n      \n      // æ¢å¤å…‰æ ‡æ ·å¼\n      this.canvas.style.cursor = 'crosshair';\n    }\n  }\n\n  /**\n   * ä¸­æ–­å¤šæ–¹å‘è®¾ç½®æ¨¡å¼\n   */\n  interruptMultiDirectionSetting(reason) {\n    if (this.state.isDirectionSelectionMode && this.state.selectedKeypoint && this.state.selectedKeypoint.maxDirections > 1) {\n      console.log('[å¤šæ–¹å‘] å¤šæ–¹å‘è®¾ç½®è¢«ä¸­æ–­:', reason);\n      \n      // ğŸ”§ FIX: Ensure progress display is properly cleaned up\n      this.hideMultiDirectionProgress();\n      \n      // é‡ç½®çŠ¶æ€\n      this.state.isDirectionSelectionMode = false;\n      this.state.directionsSet = 0;\n      this.state.selectedKeypoint = null;\n      \n      // æ¢å¤å…‰æ ‡æ ·å¼\n      this.canvas.style.cursor = 'crosshair';\n      \n      // é‡æ–°æ¸²æŸ“ä»¥æ¸…é™¤ä»»ä½•è§†è§‰æç¤º\n      this.render();\n    }\n  }\n\n  /**\n   * ä¸­æ–­æ‰€æœ‰æ–¹å‘ç›¸å…³æ¨¡å¼\n   */\n  interruptAllDirectionModes(reason) {\n    console.log('[å¤šæ–¹å‘] ä¸­æ–­æ‰€æœ‰æ–¹å‘æ¨¡å¼:', reason);\n    \n    // ä¸­æ–­æ–¹å‘æ•°é‡æ¨¡å¼\n    this.interruptDirectionCountMode(reason);\n    \n    // ä¸­æ–­å¤šæ–¹å‘è®¾ç½®æ¨¡å¼\n    this.interruptMultiDirectionSetting(reason);\n    \n    // ğŸ”§ FIX: Handle auto direction mode preservation BEFORE calling cancelDirectionSelection\n    // Cross-sectional mode needs to persist across image switches\n    if (this.state.isAutoDirectionMode) {\n      if (this.autoDirectionMode === 'cross-sectional' && reason === 'image_switch') {\n        // For cross-sectional mode during image switch, only clear current selection\n        // but preserve the overall cross-sectional state and progress\n        console.log('[Cross-Sectional] Preserving cross-sectional mode during image switch');\n        this.state.selectedKeypoint = null;\n        this.state.isDirectionSelectionMode = false;\n        this.state.directionSelectionPoint = null;\n        // Return early to avoid calling cancelDirectionSelection with forceExit\n        return;\n      } else if (this.autoDirectionMode === 'cross-sectional' && reason === 'custom_annotation_mode') {\n        // For cross-sectional mode when entering custom annotation, only pause\n        console.log('[Cross-Sectional] Pausing cross-sectional mode for custom annotation');\n        this.state.selectedKeypoint = null;\n        this.state.isDirectionSelectionMode = false;\n        this.state.directionSelectionPoint = null;\n        // Return early to avoid calling cancelDirectionSelection with forceExit\n        return;\n      } else {\n        // For other cases or longitudinal mode, exit completely\n        // This includes plant_switch which should exit cross-sectional mode\n        this.exitAutoDirectionMode();\n      }\n    }\n    \n    // ä¸­æ–­å¸¸è§„æ–¹å‘é€‰æ‹©æ¨¡å¼ (only if we didn't return early above)\n    if (this.state.isDirectionSelectionMode) {\n      this.cancelDirectionSelection(true);\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æ ‡æ³¨ç‚¹æ˜¯å¦å¯ä»¥æœ‰å¤šä¸ªæ–¹å‘\n   */\n  canHaveMultipleDirections(keypoint) {\n    return keypoint && keypoint.annotationType === 'regular';\n  }\n\n  /**\n   * ğŸ”§ BUG FIX: ç¡®ä¿æ ‡æ³¨ç‚¹å…·æœ‰å¤šæ–¹å‘æ”¯æŒçš„å¿…è¦å±æ€§\n   */\n  ensureMultiDirectionSupport(keypoint) {\n    if (!keypoint) return;\n    \n    // ç¡®ä¿directionsæ•°ç»„å­˜åœ¨\n    if (!keypoint.directions) {\n      keypoint.directions = [];\n      \n      // å¦‚æœæœ‰æ—§çš„å•æ–¹å‘æ•°æ®ï¼Œè¿ç§»åˆ°æ–°æ ¼å¼\n      if (keypoint.direction !== null && keypoint.direction !== undefined) {\n        if (typeof keypoint.direction === 'number') {\n          keypoint.directions.push({ angle: keypoint.direction, type: 'angle' });\n        } else if (keypoint.direction === 'left') {\n          keypoint.directions.push({ angle: 180, type: 'angle' });\n        } else if (keypoint.direction === 'right') {\n          keypoint.directions.push({ angle: 0, type: 'angle' });\n        }\n        console.log('[å¤šæ–¹å‘] è¿ç§»å•æ–¹å‘æ•°æ®åˆ°æ–°æ ¼å¼:', keypoint.direction, 'â†’', keypoint.directions);\n      }\n    }\n    \n    // ç¡®ä¿maxDirectionså±æ€§å­˜åœ¨\n    if (!keypoint.maxDirections) {\n      keypoint.maxDirections = Math.max(1, keypoint.directions.length);\n      console.log('[å¤šæ–¹å‘] åˆå§‹åŒ–maxDirectionsä¸º', keypoint.maxDirections, 'for keypoint #' + keypoint.order);\n    }\n    \n    // ç¡®ä¿annotationTypeå­˜åœ¨\n    if (!keypoint.annotationType) {\n      keypoint.annotationType = 'regular';\n    }\n  }\n\n  /**\n   * æ¸²æŸ“å¤šä¸ªæ–¹å‘ç®­å¤´\n   */\n  renderMultipleDirections(keypoint) {\n    // ğŸ”§ BUG FIX: ç¡®ä¿æ ‡æ³¨ç‚¹å…·æœ‰å¤šæ–¹å‘æ”¯æŒ\n    this.ensureMultiDirectionSupport(keypoint);\n    \n    // å¦‚æœæ²¡æœ‰æ–¹å‘æ•°æ®ï¼Œä¸æ¸²æŸ“\n    if (keypoint.directions.length === 0) {\n      return;\n    }\n\n    const screenPos = this.imageToScreen(keypoint.x, keypoint.y);\n    \n    keypoint.directions.forEach((direction, index) => {\n      const angleDegrees = direction.angle;\n      const directionText = `${(index + 1)}/${keypoint.directions.length}`;\n      \n      // æ¸²æŸ“æ–¹å‘ç®­å¤´ï¼Œä½¿ç”¨ä¸åŒçš„é¢œè‰²æˆ–æ ·å¼æ¥åŒºåˆ†\n      this.renderDirectionArrow(screenPos.x, screenPos.y, angleDegrees, directionText, keypoint);\n    });\n  }\n\n  /**\n   * æ¸²æŸ“æ–¹å‘ç®­å¤´ï¼ˆæ”¹è¿›ç‰ˆ - æ”¯æŒå¤šæ–¹å‘æ˜¾ç¤ºï¼‰\n   */\n  renderDirectionArrow(x, y, angleDegrees, directionText, keypoint) {\n    const angleRadians = angleDegrees * Math.PI / 180;\n    const arrowLength = this.options.directionArrowLength;\n\n    // è®¡ç®—ç®­å¤´ç»ˆç‚¹\n    const endX = x + Math.cos(angleRadians) * arrowLength;\n    const endY = y + Math.sin(angleRadians) * arrowLength;\n\n    // ç»˜åˆ¶è™šçº¿ä¸»çº¿\n    this.ctx.strokeStyle = '#10b981'; // ç»¿è‰²\n    this.ctx.lineWidth = 3;\n    this.ctx.setLineDash([8, 4]); // è™šçº¿æ ·å¼\n    this.ctx.lineCap = 'round';\n\n    this.ctx.beginPath();\n    this.ctx.moveTo(x, y);\n    this.ctx.lineTo(endX, endY);\n    this.ctx.stroke();\n\n    // é‡ç½®è™šçº¿æ ·å¼\n    this.ctx.setLineDash([]);\n\n    // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨ï¼ˆå®çº¿ï¼‰\n    const headAngle1 = angleRadians + Math.PI * 0.8;\n    const headAngle2 = angleRadians - Math.PI * 0.8;\n    const headLength = 15;\n\n    this.ctx.strokeStyle = '#10b981';\n    this.ctx.lineWidth = 3;\n    this.ctx.lineCap = 'round';\n\n    this.ctx.beginPath();\n    this.ctx.moveTo(endX, endY);\n    this.ctx.lineTo(endX + Math.cos(headAngle1) * headLength, endY + Math.sin(headAngle1) * headLength);\n    this.ctx.moveTo(endX, endY);\n    this.ctx.lineTo(endX + Math.cos(headAngle2) * headLength, endY + Math.sin(headAngle2) * headLength);\n    this.ctx.stroke();\n\n    // ç»˜åˆ¶æ–¹å‘æ–‡æœ¬ï¼ˆå¸¦èƒŒæ™¯ï¼‰\n    const textOffset = 20;\n    const textX = endX + Math.cos(angleRadians) * textOffset;\n    const textY = endY + Math.sin(angleRadians) * textOffset;\n\n    // æµ‹é‡æ–‡æœ¬å°ºå¯¸\n    this.ctx.font = 'bold 11px Arial';\n    const textMetrics = this.ctx.measureText(directionText);\n    const textWidth = textMetrics.width;\n    const textHeight = 11;\n\n    // ç»˜åˆ¶æ–‡æœ¬èƒŒæ™¯\n    this.ctx.fillStyle = 'rgba(16, 185, 129, 0.9)';\n    this.ctx.fillRect(textX - textWidth/2 - 3, textY - textHeight/2 - 2, textWidth + 6, textHeight + 4);\n\n    // ç»˜åˆ¶æ–‡æœ¬\n    this.ctx.fillStyle = '#ffffff';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    this.ctx.fillText(directionText, textX, textY);\n  }\n\n  /**\n   * ğŸ”§ NEW: Enhanced direction data structure with click coordinates\n   */\n  enhanceDirectionData(keypoint, clickData) {\n    return {\n      ...keypoint,\n      directionClick: {\n        x: clickData.clickX,\n        y: clickData.clickY,\n        screenX: clickData.screenX,\n        screenY: clickData.screenY,\n        timestamp: clickData.timestamp\n      }\n    };\n  }\n\n  /**\n   * ğŸ”§ NEW: Enhanced multi-direction data structure with click coordinates\n   */\n  enhanceMultiDirectionData(keypoint, clickDataArray) {\n    const enhancedDirections = keypoint.directions.map((direction, index) => {\n      const clickData = clickDataArray[index];\n      return {\n        ...direction,\n        clickPosition: clickData ? {\n          x: clickData.clickX,\n          y: clickData.clickY,\n          screenX: clickData.screenX,\n          screenY: clickData.screenY,\n          timestamp: clickData.timestamp\n        } : null\n      };\n    });\n\n    return {\n      ...keypoint,\n      directions: enhancedDirections\n    };\n  }\n\n  /**\n   * ğŸ”§ NEW: Handle direction selection click with coordinate recording\n   */\n  handleDirectionSelectionClick(event) {\n    if (!this.state.selectedKeypoint || !this.state.isDirectionSelectionMode) {\n      return;\n    }\n\n    const screenCoords = this.getEventCoordinates(event);\n    const imageCoords = this.screenToImage(screenCoords.x, screenCoords.y);\n    \n    // Validate click coordinates\n    if (!this.validateDirectionClick(this.state.selectedKeypoint, {\n      clickX: imageCoords.x,\n      clickY: imageCoords.y,\n      screenX: screenCoords.x,\n      screenY: screenCoords.y\n    })) {\n      return;\n    }\n\n    // Calculate angle from keypoint to click position\n    const angle = this.calculateAngleFromClick(this.state.selectedKeypoint, imageCoords);\n    \n    // Record click data\n    const clickData = {\n      x: imageCoords.x,\n      y: imageCoords.y,\n      screenX: screenCoords.x,\n      screenY: screenCoords.y,\n      timestamp: Date.now()\n    };\n\n    // Update keypoint with direction and click data\n    this.state.selectedKeypoint.direction = angle;\n    this.state.selectedKeypoint.directionType = 'angle';\n    this.state.selectedKeypoint.directionClick = clickData;\n\n    // Trigger UI update\n    this.render();\n    \n    // Exit direction selection mode\n    this.state.isDirectionSelectionMode = false;\n    this.state.selectedKeypoint = null;\n  }\n\n  /**\n   * ğŸ”§ NEW: Validate direction click coordinates\n   */\n  validateDirectionClick(keypoint, clickData) {\n    // Check if click is within image bounds\n    if (!this.isClickWithinImageBounds(clickData)) {\n      return false;\n    }\n\n    // Check if click is within canvas bounds\n    if (!this.isClickWithinCanvasBounds(clickData)) {\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * ğŸ”§ NEW: Calculate angle from keypoint to click position\n   */\n  calculateAngleFromClick(keypoint, clickPosition) {\n    const deltaX = clickPosition.x - keypoint.x;\n    const deltaY = clickPosition.y - keypoint.y;\n    const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;\n    return (angle + 360) % 360;\n  }\n\n  /**\n   * ğŸ”§ NEW: Check if click is within canvas bounds\n   */\n  isClickWithinCanvasBounds(clickData) {\n    return clickData.screenX >= 0 && clickData.screenX <= this.canvas.width &&\n           clickData.screenY >= 0 && clickData.screenY <= this.canvas.height;\n  }\n\n  /**\n   * ğŸ”§ NEW: Check if click is within image bounds\n   */\n  isClickWithinImageBounds(clickData) {\n    if (!this.currentImage) return false;\n    \n    return clickData.x >= 0 && clickData.x <= this.currentImage.width &&\n           clickData.y >= 0 && clickData.y <= this.currentImage.height;\n  }\n\n  /**\n   * ğŸ”§ NEW: Convert screen coordinates to image coordinates\n   */\n  screenToImage(screenX, screenY) {\n    const imageX = (screenX - this.state.translateX) / this.state.scale;\n    const imageY = (screenY - this.state.translateY) / this.state.scale;\n    return { x: imageX, y: imageY };\n  }\n\n  /**\n   * ğŸ”§ NEW: Handle multi-direction click with coordinate recording\n   */\n  handleMultiDirectionClick(event) {\n    if (!this.state.selectedKeypoint || !this.state.selectedKeypoint.maxDirections) {\n      return false;\n    }\n\n    const keypoint = this.state.selectedKeypoint;\n    if (keypoint.directions.length >= keypoint.maxDirections) {\n      return false;\n    }\n\n    const screenCoords = this.getEventCoordinates(event);\n    const imageCoords = this.screenToImage(screenCoords.x, screenCoords.y);\n    \n    // Calculate angle and add new direction\n    const angle = this.calculateAngleFromClick(keypoint, imageCoords);\n    \n    keypoint.directions.push({\n      angle: angle,\n      type: 'angle',\n      clickPosition: {\n        x: imageCoords.x,\n        y: imageCoords.y,\n        screenX: screenCoords.x,\n        screenY: screenCoords.y,\n        timestamp: Date.now()\n      }\n    });\n\n    return true;\n  }\n\n  /**\n   * ğŸ”§ NEW: Get annotation data with click coordinates\n   */\n  getAnnotationData() {\n    return {\n      keypoints: this.keypoints.map(kp => ({\n        ...kp,\n        directionClick: kp.directionClick || null\n      }))\n    };\n  }\n\n  /**\n   * ğŸ”§ NEW: Serialize annotation data with click coordinates\n   */\n  serializeAnnotationData(keypoints) {\n    return JSON.stringify(keypoints.map(kp => ({\n      ...kp,\n      directionClick: kp.directionClick || null\n    })));\n  }\n\n  /**\n   * ğŸ”§ NEW: Deserialize annotation data with click coordinates\n   */\n  deserializeAnnotationData(data) {\n    const keypoints = JSON.parse(data);\n    return keypoints.map(kp => ({\n      ...kp,\n      directionClick: kp.directionClick || null\n    }));\n  }\n\n  /**\n   * ğŸ”§ NEW: Get event coordinates from mouse/touch event\n   */\n  getEventCoordinates(event) {\n    const rect = this.canvas.getBoundingClientRect();\n    return {\n      x: event.clientX - rect.left,\n      y: event.clientY - rect.top\n    };\n  }\n\n  /**\n   * ğŸ”§ NEW: SIFTåŒ¹é…åŠŸèƒ½ - åŸºäºä¸Šä¸€å¸§è°ƒæ•´å½“å‰å¸§æ ‡æ³¨\n   */\n  async performSiftMatching() {\n    console.log('[SIFT] å¼€å§‹æ‰§è¡ŒSIFTåŒ¹é…');\n    \n    try {\n      // éªŒè¯å‰ç½®æ¡ä»¶\n      const validation = await this.validateMatchingPreconditions();\n      if (!validation.isValid) {\n        console.error('[SIFT] å‰ç½®æ¡ä»¶éªŒè¯å¤±è´¥:', validation.errors);\n        this.showSiftError('SIFTåŒ¹é…å‰ç½®æ¡ä»¶ä¸æ»¡è¶³', validation.errors.join('\\n'));\n        return;\n      }\n\n      // è·å–å½“å‰å’Œä¸Šä¸€å¸§çš„æ ‡æ³¨æ•°æ®ï¼ˆåªæ”¯æŒbuiltin keypointsï¼‰\n      const currentAnnotations = this.keypoints.filter(kp => \n        kp.annotationType === 'custom' && kp.customTypeId === 'builtin-regular-keypoint'\n      );\n      const allPreviousAnnotations = await this.getPreviousFrameAnnotations();\n      const previousAnnotations = allPreviousAnnotations ? \n        allPreviousAnnotations.filter(kp => \n          kp.annotationType === 'custom' && kp.customTypeId === 'builtin-regular-keypoint'\n        ) : null;\n      \n      if (!previousAnnotations || previousAnnotations.length === 0) {\n        this.showSiftError('æ— æ³•è·å–ä¸Šä¸€å¸§builtinæ ‡æ³¨æ•°æ®', 'è¯·ç¡®ä¿ä¸Šä¸€å¸§å­˜åœ¨Regular (Builtin)æ ‡æ³¨ç‚¹');\n        return;\n      }\n      \n      if (currentAnnotations.length === 0) {\n        this.showSiftError('å½“å‰å¸§æ— builtinæ ‡æ³¨', 'è¯·å…ˆæ·»åŠ Regular (Builtin)æ ‡æ³¨ç‚¹');\n        return;\n      }\n\n      // è·å–å›¾åƒæ•°æ®\n      const currentImageData = this.getCurrentImageData();\n      const previousImageData = await this.getPreviousImageData();\n\n      // æ‰§è¡ŒSIFTåŒ¹é…\n      const { SiftMatcher } = await import('./SiftMatcher.js');\n      const siftMatcher = new SiftMatcher();\n      \n      const calibratedAnnotations = await siftMatcher.calibrateAnnotations(\n        previousAnnotations,\n        currentAnnotations,\n        previousImageData,\n        currentImageData\n      );\n\n      // è®¡ç®—åŒ¹é…è´¨é‡\n      const quality = siftMatcher.calculateMatchingQuality(calibratedAnnotations);\n      \n      console.log('[SIFT] åŒ¹é…å®Œæˆ:', {\n        åŸå§‹æ ‡æ³¨: currentAnnotations.length,\n        æ ¡å‡†æ ‡æ³¨: calibratedAnnotations.length,\n        å¹³å‡ç½®ä¿¡åº¦: `${(quality.averageConfidence * 100).toFixed(1)}%`,\n        å¹³å‡åç§»: `${quality.averageOffset.toFixed(2)}px`,\n        æˆåŠŸåŒ¹é…: quality.successfulMatches\n      });\n\n      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†\n      this.showCalibrationPreview(currentAnnotations, calibratedAnnotations, quality);\n\n    } catch (error) {\n      console.error('[SIFT] åŒ¹é…è¿‡ç¨‹å‡ºé”™:', error);\n      this.showSiftError('SIFTåŒ¹é…å¤±è´¥', error.message);\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: éªŒè¯SIFTåŒ¹é…å‰ç½®æ¡ä»¶\n   */\n  async validateMatchingPreconditions() {\n    const errors = [];\n    \n    // æ£€æŸ¥å½“å‰å›¾åƒ\n    if (!this.currentImage || !this.imageElement) {\n      errors.push('å½“å‰å›¾åƒæœªåŠ è½½');\n    }\n    \n    // æ£€æŸ¥å½“å‰æ ‡æ³¨\n    if (!this.keypoints || this.keypoints.length === 0) {\n      errors.push('å½“å‰å›¾åƒæ²¡æœ‰æ ‡æ³¨ç‚¹');\n    }\n    \n    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¸€å¸§\n    if (!(await this.hasPreviousFrame())) {\n      errors.push('æ²¡æœ‰ä¸Šä¸€å¸§å›¾åƒå¯ç”¨ä½œå‚è€ƒ');\n    }\n    \n    return {\n      hasCurrentImage: !!this.currentImage,\n      hasPreviousImage: await this.hasPreviousFrame(),\n      hasCurrentAnnotations: this.keypoints && this.keypoints.length > 0,\n      hasPreviousAnnotations: await this.hasPreviousFrameAnnotations(),\n      isValid: errors.length === 0,\n      errors\n    };\n  }\n\n  /**\n   * ğŸ”§ NEW: æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¸€å¸§\n   */\n  async hasPreviousFrame() {\n    if (!window.PlantAnnotationTool?.plantDataManager) {\n      return false;\n    }\n    \n    const currentPlant = window.PlantAnnotationTool.appState.currentPlant;\n    if (!currentPlant || !currentPlant.selectedViewAngle) {\n      return false;\n    }\n    \n    return await this.getPreviousFrameId() !== null;\n  }\n\n  /**\n   * ğŸ”§ NEW: æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¸€å¸§æ ‡æ³¨\n   */\n  async hasPreviousFrameAnnotations() {\n    const previousAnnotations = await this.getPreviousFrameAnnotations();\n    return previousAnnotations && previousAnnotations.length > 0;\n  }\n\n  /**\n   * ğŸ”§ NEW: è·å–ä¸Šä¸€å¸§ID\n   */\n  async getPreviousFrameId() {\n    if (!window.PlantAnnotationTool?.plantDataManager) {\n      return null;\n    }\n    \n    const currentPlant = window.PlantAnnotationTool.appState.currentPlant;\n    if (!currentPlant || !currentPlant.selectedViewAngle || !currentPlant.selectedImage) {\n      return null;\n    }\n    \n    // è·å–å½“å‰è§†è§’çš„æ‰€æœ‰å›¾åƒ\n    const images = await window.PlantAnnotationTool.plantDataManager.getPlantImages(\n      currentPlant.id, \n      currentPlant.selectedViewAngle\n    );\n    \n    if (!images || images.length === 0) {\n      return null;\n    }\n    \n    // æ‰¾åˆ°å½“å‰å›¾åƒçš„ç´¢å¼•\n    const currentIndex = images.findIndex(img => img.id === currentPlant.selectedImage.id);\n    \n    if (currentIndex <= 0) {\n      return null; // æ²¡æœ‰ä¸Šä¸€å¸§\n    }\n    \n    return images[currentIndex - 1].id;\n  }\n\n  /**\n   * ğŸ”§ NEW: è·å–ä¸Šä¸€å¸§æ ‡æ³¨æ•°æ®\n   */\n  async getPreviousFrameAnnotations() {\n    const previousFrameId = await this.getPreviousFrameId();\n    if (!previousFrameId) {\n      return null;\n    }\n    \n    // ä»æ•°æ®ç®¡ç†å™¨è·å–ä¸Šä¸€å¸§çš„æ ‡æ³¨\n    const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n    if (!plantDataManager) {\n      return null;\n    }\n    \n    try {\n      const annotations = plantDataManager.getImageAnnotations(previousFrameId);\n      return annotations || [];\n    } catch (error) {\n      console.warn('[SIFT] è·å–ä¸Šä¸€å¸§æ ‡æ³¨å¤±è´¥:', error);\n      return null;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: è·å–å½“å‰å›¾åƒæ•°æ®\n   */\n  getCurrentImageData() {\n    if (!this.imageElement) {\n      throw new Error('å½“å‰å›¾åƒæœªåŠ è½½');\n    }\n    \n    // ğŸ”§ FIX: If image is already loaded but might be tainted, reload with CORS\n    if (this.imageElement.complete && !this.imageElement.crossOrigin) {\n      console.warn('[SIFT] å›¾åƒå·²åŠ è½½ä½†æœªè®¾ç½®CORSï¼Œéœ€è¦é‡æ–°åŠ è½½');\n      throw new Error('å›¾åƒéœ€è¦é‡æ–°åŠ è½½ä»¥æ”¯æŒCORSè®¿é—®ï¼Œè¯·é‡æ–°é€‰æ‹©å›¾åƒ');\n    }\n    \n    // åˆ›å»ºä¸´æ—¶canvasæ¥è·å–å›¾åƒæ•°æ®\n    const tempCanvas = document.createElement('canvas');\n    tempCanvas.width = this.imageElement.width;\n    tempCanvas.height = this.imageElement.height;\n    const tempCtx = tempCanvas.getContext('2d');\n    \n    try {\n      tempCtx.drawImage(this.imageElement, 0, 0);\n      return tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);\n    } catch (error) {\n      console.error('[SIFT] è·å–å›¾åƒæ•°æ®å¤±è´¥:', error);\n      throw new Error('æ— æ³•è·å–å›¾åƒæ•°æ®ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé—®é¢˜ã€‚è¯·é‡æ–°é€‰æ‹©å›¾åƒã€‚');\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: è·å–ä¸Šä¸€å¸§å›¾åƒæ•°æ®\n   */\n  async getPreviousImageData() {\n    const previousFrameId = await this.getPreviousFrameId();\n    if (!previousFrameId) {\n      throw new Error('æ— æ³•è·å–ä¸Šä¸€å¸§å›¾åƒID');\n    }\n    \n    // è·å–ä¸Šä¸€å¸§å›¾åƒçš„è·¯å¾„\n    const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n    if (!plantDataManager) {\n      throw new Error('æ¤ç‰©æ•°æ®ç®¡ç†å™¨ä¸å¯ç”¨');\n    }\n    \n    const currentPlant = window.PlantAnnotationTool.appState.currentPlant;\n    const images = await plantDataManager.getPlantImages(currentPlant.id, currentPlant.selectedViewAngle);\n    const previousImage = images.find(img => img.id === previousFrameId);\n    \n    if (!previousImage) {\n      throw new Error('æ‰¾ä¸åˆ°ä¸Šä¸€å¸§å›¾åƒ');\n    }\n    \n    // ğŸ”§ FIX: åˆ›å»ºæ­£ç¡®çš„å›¾åƒURLï¼ˆä½¿ç”¨ä¸ä¸»å›¾åƒç›¸åŒçš„æ–¹æ³•ï¼‰\n    const imageURL = await plantDataManager.fileSystemManager.createImageURL(previousImage);\n    \n    // åŠ è½½ä¸Šä¸€å¸§å›¾åƒ\n    const img = new Image();\n    img.crossOrigin = 'anonymous';\n    \n    return new Promise((resolve, reject) => {\n      img.onload = () => {\n        const tempCanvas = document.createElement('canvas');\n        tempCanvas.width = img.width;\n        tempCanvas.height = img.height;\n        const tempCtx = tempCanvas.getContext('2d');\n        \n        try {\n          tempCtx.drawImage(img, 0, 0);\n          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);\n          resolve(imageData);\n        } catch (error) {\n          console.error('[SIFT] è·å–ä¸Šä¸€å¸§å›¾åƒæ•°æ®å¤±è´¥:', error);\n          reject(new Error('æ— æ³•è·å–ä¸Šä¸€å¸§å›¾åƒæ•°æ®ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé—®é¢˜'));\n        }\n      };\n      \n      img.onerror = () => {\n        console.error('[SIFT] ä¸Šä¸€å¸§å›¾åƒåŠ è½½å¤±è´¥:', imageURL);\n        reject(new Error('åŠ è½½ä¸Šä¸€å¸§å›¾åƒå¤±è´¥'));\n      };\n      \n      img.src = imageURL;\n    });\n  }\n\n  /**\n   * ğŸ”§ NEW: æ˜¾ç¤ºéé˜»å¡å¼æ ¡å‡†é¢„è§ˆå’Œç¡®è®¤æç¤º\n   */\n  showCalibrationPreview(originalAnnotations, calibratedAnnotations, quality) {\n    // åˆ›å»ºé¢„è§ˆæ¨¡å¼çŠ¶æ€\n    this.calibrationPreviewState = {\n      originalAnnotations: [...originalAnnotations],\n      calibratedAnnotations: [...calibratedAnnotations],\n      quality,\n      isActive: true,\n      showOriginal: true,\n      showCalibrated: true,\n      showArrows: true\n    };\n    \n    // æ˜¾ç¤ºéé˜»å¡å¼æç¤º\n    this.showNonBlockingNotification(quality);\n    \n    // ç»‘å®šé”®ç›˜äº‹ä»¶\n    this.bindCalibrationKeyboardEvents();\n    \n    // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºé¢„è§ˆ\n    this.render();\n    \n    console.log('[SIFT] æ ¡å‡†é¢„è§ˆå·²æ˜¾ç¤º');\n  }\n\n  /**\n   * ğŸ”§ NEW: æ˜¾ç¤ºéé˜»å¡å¼é€šçŸ¥\n   */\n  showNonBlockingNotification(quality) {\n    // åˆ›å»ºé€šçŸ¥å…ƒç´ \n    const notification = document.createElement('div');\n    notification.className = 'sift-notification';\n    notification.innerHTML = `\n      <div class=\"notification-content\">\n        <div class=\"notification-header\">\n          <h3>ğŸ” SIFT Match Result</h3>\n          <button class=\"close-btn\" onclick=\"this.parentElement.parentElement.parentElement.remove()\">Ã—</button>\n        </div>\n        <div class=\"quality-info\">\n          <p><strong>Match Quality:</strong> ${(quality.qualityScore * 100).toFixed(1)}%</p>\n          <p><strong>Average Confidence:</strong> ${(quality.averageConfidence * 100).toFixed(1)}%</p>\n          <p><strong>Average Offset:</strong> ${quality.averageOffset.toFixed(2)}px</p>\n          <p><strong>Successful Matches:</strong> ${quality.successfulMatches}/${quality.totalAnnotations}</p>\n        </div>\n        \n        <div class=\"notification-actions\">\n          <button class=\"btn-accept\" title=\"Accept Adjustment (Shortcut: A)\">âœ“ Accept Adjustment (A)</button>\n          <button class=\"btn-reject\" title=\"Reject Adjustment (Shortcut: R)\">âœ— Reject Adjustment (R)</button>\n        </div>\n        \n        <div class=\"notification-help\">\n          <small>Shortcuts: A=Accept, R=Reject, ESC=Cancel</small>\n        </div>\n      </div>\n    `;\n    \n    // æ·»åŠ æ ·å¼\n    notification.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      max-width: 350px;\n      background: white;\n      border: 1px solid #ddd;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      z-index: 10000;\n      font-family: Arial, sans-serif;\n      animation: slideIn 0.3s ease-out;\n    `;\n    \n    // æ·»åŠ åŠ¨ç”»æ ·å¼\n    if (!document.getElementById('sift-notification-style')) {\n      const style = document.createElement('style');\n      style.id = 'sift-notification-style';\n      style.textContent = `\n        @keyframes slideIn {\n          from {\n            transform: translateX(100%);\n            opacity: 0;\n          }\n          to {\n            transform: translateX(0);\n            opacity: 1;\n          }\n        }\n        .sift-notification .notification-content {\n          padding: 15px;\n        }\n        .sift-notification .notification-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          margin-bottom: 10px;\n        }\n        .sift-notification .notification-header h3 {\n          margin: 0;\n          font-size: 16px;\n          color: #333;\n        }\n        .sift-notification .close-btn {\n          background: none;\n          border: none;\n          font-size: 18px;\n          cursor: pointer;\n          color: #666;\n          padding: 0;\n          width: 20px;\n          height: 20px;\n        }\n        .sift-notification .close-btn:hover {\n          color: #000;\n        }\n        .sift-notification .quality-info {\n          margin-bottom: 15px;\n          font-size: 13px;\n          color: #666;\n        }\n        .sift-notification .quality-info p {\n          margin: 3px 0;\n        }\n        .sift-notification .notification-actions {\n          display: flex;\n          gap: 10px;\n          margin-bottom: 10px;\n        }\n        .sift-notification .btn-accept,\n        .sift-notification .btn-reject {\n          flex: 1;\n          padding: 8px 12px;\n          border: none;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 12px;\n          font-weight: 500;\n        }\n        .sift-notification .btn-accept {\n          background: #10b981;\n          color: white;\n        }\n        .sift-notification .btn-accept:hover {\n          background: #059669;\n        }\n        .sift-notification .btn-reject {\n          background: #ef4444;\n          color: white;\n        }\n        .sift-notification .btn-reject:hover {\n          background: #dc2626;\n        }\n        .sift-notification .notification-help {\n          text-align: center;\n          color: #999;\n          border-top: 1px solid #eee;\n          padding-top: 8px;\n        }\n      `;\n      document.head.appendChild(style);\n    }\n    \n    // ç»‘å®šæŒ‰é’®äº‹ä»¶\n    const acceptBtn = notification.querySelector('.btn-accept');\n    const rejectBtn = notification.querySelector('.btn-reject');\n    \n    acceptBtn.addEventListener('click', () => {\n      this.applyCalibrationResults();\n    });\n    \n    rejectBtn.addEventListener('click', () => {\n      this.cancelCalibration();\n    });\n    \n    // æ·»åŠ åˆ°é¡µé¢\n    document.body.appendChild(notification);\n    \n    // å­˜å‚¨å¼•ç”¨ä»¥ä¾¿åç»­æ¸…ç†\n    this.calibrationNotification = notification;\n    \n    // è‡ªåŠ¨éšè—æ—¶é—´ï¼ˆ30ç§’ï¼‰\n    this.notificationTimeout = setTimeout(() => {\n      this.cancelCalibration();\n    }, 30000);\n  }\n\n  /**\n   * ğŸ”§ NEW: ç»‘å®šæ ¡å‡†é”®ç›˜äº‹ä»¶\n   */\n  bindCalibrationKeyboardEvents() {\n    this.calibrationKeyboardHandler = (event) => {\n      if (!this.calibrationPreviewState?.isActive) return;\n      \n      switch (event.key.toLowerCase()) {\n        case 'a':\n          event.preventDefault();\n          this.applyCalibrationResults();\n          break;\n        case 'r':\n          event.preventDefault();\n          this.cancelCalibration();\n          break;\n        case 'p':\n          event.preventDefault();\n          this.toggleCalibrationPreview();\n          break;\n        case 'escape':\n          event.preventDefault();\n          this.cancelCalibration();\n          break;\n      }\n    };\n    \n    document.addEventListener('keydown', this.calibrationKeyboardHandler);\n  }\n\n  /**\n   * ğŸ”§ NEW: åˆ‡æ¢æ ¡å‡†é¢„è§ˆ\n   */\n  toggleCalibrationPreview() {\n    if (!this.calibrationPreviewState) return;\n    \n    this.calibrationPreviewState.showOriginal = !this.calibrationPreviewState.showOriginal;\n    this.calibrationPreviewState.showCalibrated = !this.calibrationPreviewState.showCalibrated;\n    this.calibrationPreviewState.showArrows = !this.calibrationPreviewState.showArrows;\n    \n    this.render();\n  }\n\n  /**\n   * ğŸ”§ NEW: åº”ç”¨æ ¡å‡†ç»“æœ\n   */\n  async applyCalibrationResults() {\n    if (!this.calibrationPreviewState) return;\n    \n    try {\n      console.log('[SIFT] åº”ç”¨æ ¡å‡†ç»“æœ');\n      \n      // ä¿å­˜å†å²è®°å½•\n      this.saveState();\n      \n      // åº”ç”¨æ ¡å‡†åçš„æ ‡æ³¨\n      this.keypoints = [...this.calibrationPreviewState.calibratedAnnotations];\n      \n      // æ¸…ç†é¢„è§ˆçŠ¶æ€\n      this.cleanupCalibrationPreview();\n      \n      // é‡æ–°æ¸²æŸ“\n      this.render();\n      \n      // è§¦å‘è‡ªåŠ¨ä¿å­˜\n      if (window.PlantAnnotationTool?.autoSave) {\n        await window.PlantAnnotationTool.autoSave();\n      }\n      \n      // æ˜¾ç¤ºæˆåŠŸæç¤º\n      this.showSiftSuccess('SIFTåŒ¹é…æˆåŠŸåº”ç”¨', `å·²è°ƒæ•´ ${this.keypoints.length} ä¸ªæ ‡æ³¨ç‚¹`);\n      \n    } catch (error) {\n      console.error('[SIFT] åº”ç”¨æ ¡å‡†ç»“æœå¤±è´¥:', error);\n      this.showSiftError('åº”ç”¨æ ¡å‡†ç»“æœå¤±è´¥', error.message);\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: å–æ¶ˆæ ¡å‡†\n   */\n  cancelCalibration() {\n    console.log('[SIFT] å–æ¶ˆæ ¡å‡†');\n    \n    // æ¸…ç†é¢„è§ˆçŠ¶æ€\n    this.cleanupCalibrationPreview();\n    \n    // é‡æ–°æ¸²æŸ“\n    this.render();\n    \n    this.showSiftInfo('å·²å–æ¶ˆSIFTåŒ¹é…', 'æ ‡æ³¨ç‚¹ä¿æŒåŸå§‹ä½ç½®');\n  }\n\n  /**\n   * ğŸ”§ NEW: æ¸…ç†æ ¡å‡†é¢„è§ˆ\n   */\n  cleanupCalibrationPreview() {\n    // ç§»é™¤é€šçŸ¥\n    if (this.calibrationNotification) {\n      this.calibrationNotification.remove();\n      this.calibrationNotification = null;\n    }\n    \n    // æ¸…é™¤è‡ªåŠ¨éšè—å®šæ—¶å™¨\n    if (this.notificationTimeout) {\n      clearTimeout(this.notificationTimeout);\n      this.notificationTimeout = null;\n    }\n    \n    // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬\n    if (this.calibrationKeyboardHandler) {\n      document.removeEventListener('keydown', this.calibrationKeyboardHandler);\n      this.calibrationKeyboardHandler = null;\n    }\n    \n    // æ¸…ç†çŠ¶æ€\n    this.calibrationPreviewState = null;\n  }\n\n  /**\n   * ğŸ”§ NEW: æ˜¾ç¤ºSIFTé”™è¯¯æ¶ˆæ¯\n   */\n  showSiftError(title, message) {\n    console.error(`[SIFT] ${title}: ${message}`);\n    if (window.PlantAnnotationTool?.showError) {\n      window.PlantAnnotationTool.showError(title, message);\n    } else {\n      alert(`${title}\\n${message}`);\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: æ˜¾ç¤ºSIFTæˆåŠŸæ¶ˆæ¯\n   */\n  showSiftSuccess(title, message) {\n    console.log(`[SIFT] ${title}: ${message}`);\n    if (window.PlantAnnotationTool?.showSuccess) {\n      window.PlantAnnotationTool.showSuccess(title, message);\n    } else {\n      alert(`${title}\\n${message}`);\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: æ˜¾ç¤ºSIFTä¿¡æ¯æ¶ˆæ¯\n   */\n  showSiftInfo(title, message) {\n    console.log(`[SIFT] ${title}: ${message}`);\n    if (window.PlantAnnotationTool?.showInfo) {\n      window.PlantAnnotationTool.showInfo(title, message);\n    } else {\n      alert(`${title}\\n${message}`);\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: åˆ›å»ºåŒ¹é…å¯è§†åŒ–\n   */\n  createMatchingVisualizations(data, type) {\n    const visualizations = [];\n    \n    if (type === 'original') {\n      data.forEach((annotation, index) => {\n        visualizations.push({\n          type: 'original',\n          x: annotation.x,\n          y: annotation.y,\n          color: '#ff4444',\n          size: 8,\n          label: annotation.order?.toString() || (index + 1).toString()\n        });\n      });\n    } else if (type === 'adjusted') {\n      data.forEach((annotation, index) => {\n        visualizations.push({\n          type: 'adjusted',\n          x: annotation.x,\n          y: annotation.y,\n          color: '#44ff44',\n          size: 8,\n          label: annotation.order?.toString() || (index + 1).toString()\n        });\n      });\n    } else if (type === 'arrows') {\n      data.forEach((annotation, index) => {\n        if (annotation.calibrationData) {\n          visualizations.push({\n            type: 'arrow',\n            from: { x: annotation.calibrationData.originalX, y: annotation.calibrationData.originalY },\n            to: { x: annotation.x, y: annotation.y },\n            color: '#ffaa00',\n            width: 2,\n            label: `${annotation.calibrationData.offset.toFixed(1)}px`\n          });\n        }\n      });\n    }\n    \n    return visualizations;\n  }\n\n  /**\n   * ğŸ”§ NEW: æ¸²æŸ“æ ¡å‡†é¢„è§ˆ\n   */\n  renderCalibrationPreview() {\n    if (!this.calibrationPreviewState) return;\n    \n    const { originalAnnotations, calibratedAnnotations, showOriginal, showCalibrated, showArrows } = this.calibrationPreviewState;\n    \n    // Render original positions (red)\n    if (showOriginal) {\n      originalAnnotations.forEach((annotation, index) => {\n        const screenPos = this.imageToScreen(annotation.x, annotation.y);\n        this.renderCalibrationPoint(screenPos.x, screenPos.y, '#ff4444', annotation.order || (index + 1), 'Original');\n      });\n    }\n    \n    // Render calibrated positions (green)\n    if (showCalibrated) {\n      calibratedAnnotations.forEach((annotation, index) => {\n        const screenPos = this.imageToScreen(annotation.x, annotation.y);\n        this.renderCalibrationPoint(screenPos.x, screenPos.y, '#44ff44', annotation.order || (index + 1), 'Calibrated');\n      });\n    }\n    \n    // æ¸²æŸ“ç§»åŠ¨ç®­å¤´ï¼ˆæ©™è‰²ï¼‰\n    if (showArrows) {\n      calibratedAnnotations.forEach((annotation, index) => {\n        if (annotation.calibrationData) {\n          const originalPos = this.imageToScreen(annotation.calibrationData.originalX, annotation.calibrationData.originalY);\n          const calibratedPos = this.imageToScreen(annotation.x, annotation.y);\n          \n          this.renderCalibrationArrow(\n            originalPos.x, originalPos.y,\n            calibratedPos.x, calibratedPos.y,\n            annotation.calibrationData.offset\n          );\n        }\n      });\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: æ¸²æŸ“æ ¡å‡†ç‚¹\n   */\n  renderCalibrationPoint(x, y, color, order, type) {\n    const radius = 8;\n    \n    // ç»˜åˆ¶åœ†å½¢\n    this.ctx.beginPath();\n    this.ctx.arc(x, y, radius, 0, 2 * Math.PI);\n    this.ctx.fillStyle = color;\n    this.ctx.fill();\n    \n    // ç»˜åˆ¶è¾¹æ¡†\n    this.ctx.strokeStyle = '#ffffff';\n    this.ctx.lineWidth = 2;\n    this.ctx.stroke();\n    \n    // ç»˜åˆ¶åºå·\n    this.ctx.fillStyle = '#ffffff';\n    this.ctx.font = 'bold 12px Arial';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    this.ctx.fillText(order.toString(), x, y);\n    \n    // ç»˜åˆ¶ç±»å‹æ ‡ç­¾\n    this.ctx.fillStyle = color;\n    this.ctx.font = '10px Arial';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'top';\n    this.ctx.fillText(type, x, y + radius + 2);\n  }\n\n  /**\n   * ğŸ”§ NEW: æ¸²æŸ“æ ¡å‡†ç®­å¤´\n   */\n  renderCalibrationArrow(x1, y1, x2, y2, offset) {\n    const dx = x2 - x1;\n    const dy = y2 - y1;\n    const distance = Math.sqrt(dx * dx + dy * dy);\n    \n    if (distance < 2) return; // å¤ªå°çš„åç§»ä¸æ˜¾ç¤ºç®­å¤´\n    \n    // ç»˜åˆ¶ç®­å¤´çº¿\n    this.ctx.beginPath();\n    this.ctx.moveTo(x1, y1);\n    this.ctx.lineTo(x2, y2);\n    this.ctx.strokeStyle = '#ffaa00';\n    this.ctx.lineWidth = 3;\n    this.ctx.setLineDash([5, 3]);\n    this.ctx.stroke();\n    this.ctx.setLineDash([]); // é‡ç½®è™šçº¿\n    \n    // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨\n    const angle = Math.atan2(dy, dx);\n    const headLength = 12;\n    const headAngle = Math.PI / 6;\n    \n    this.ctx.beginPath();\n    this.ctx.moveTo(x2, y2);\n    this.ctx.lineTo(\n      x2 - headLength * Math.cos(angle - headAngle),\n      y2 - headLength * Math.sin(angle - headAngle)\n    );\n    this.ctx.moveTo(x2, y2);\n    this.ctx.lineTo(\n      x2 - headLength * Math.cos(angle + headAngle),\n      y2 - headLength * Math.sin(angle + headAngle)\n    );\n    this.ctx.strokeStyle = '#ffaa00';\n    this.ctx.lineWidth = 3;\n    this.ctx.stroke();\n    \n    // ç»˜åˆ¶åç§»è·ç¦»æ ‡ç­¾\n    const midX = (x1 + x2) / 2;\n    const midY = (y1 + y2) / 2;\n    \n    this.ctx.fillStyle = '#ffaa00';\n    this.ctx.font = 'bold 10px Arial';\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    this.ctx.fillText(`${offset.toFixed(1)}px`, midX, midY - 8);\n  }\n\n  /**\n   * ğŸ”§ NEW: è·å–æŒ‡å®šç±»å‹çš„æ‰€æœ‰æ— åºå·æ ‡æ³¨\n   */\n  getAllUnorderedAnnotationsOfType(typeId) {\n    console.log('[Auto Order] getAllUnorderedAnnotationsOfType called with typeId:', typeId);\n    console.log('[Auto Order] å½“å‰å›¾ç‰‡æ ‡æ³¨æ•°é‡:', this.keypoints.length);\n    \n    const unorderedAnnotations = [];\n    \n    // æ£€æŸ¥å½“å‰å›¾ç‰‡çš„æ ‡æ³¨\n    this.keypoints.forEach(annotation => {\n      console.log(`[Auto Order] æ£€æŸ¥æ ‡æ³¨:`, {\n        id: annotation.id,\n        annotationType: annotation.annotationType,\n        customTypeId: annotation.customTypeId,\n        order: annotation.order,\n        hasOrder: annotation.hasOwnProperty('order'),\n        isTargetType: annotation.customTypeId === typeId\n      });\n      \n      if (annotation.annotationType === 'custom' && \n          annotation.customTypeId === typeId && \n          (annotation.order === undefined || annotation.order === null)) {\n        console.log('[Auto Order] æ‰¾åˆ°æ— åºå·æ ‡æ³¨:', annotation.id);\n        unorderedAnnotations.push({\n          ...annotation,\n          imageId: this.currentImage || 'current'\n        });\n      }\n    });\n    \n    console.log('[Auto Order] æ€»å…±æ‰¾åˆ°æ— åºå·æ ‡æ³¨:', unorderedAnnotations.length, 'ä¸ª');\n    return unorderedAnnotations;\n  }\n  \n  /**\n   * ğŸ”§ NEW: æŒ‰å›¾ç‰‡åˆ†ç»„æ ‡æ³¨\n   */\n  groupAnnotationsByImage(annotations) {\n    const groups = {};\n    annotations.forEach(annotation => {\n      const imageId = annotation.imageId;\n      if (!groups[imageId]) {\n        groups[imageId] = [];\n      }\n      groups[imageId].push(annotation);\n    });\n    return groups;\n  }\n  \n  /**\n   * ğŸ”§ NEW: è·å–ç±»å‹åç§°\n   */\n  getTypeName(typeId) {\n    if (!this.customAnnotationManager) return typeId;\n    const type = this.customAnnotationManager.getCustomType(typeId);\n    return type ? type.name : typeId;\n  }\n  \n  /**\n   * ğŸ”§ NEW: æ›´æ–°Auto OrderæŒ‰é’®çŠ¶æ€\n   */\n  updateAutoOrderButton(isActive) {\n    const btn = document.getElementById('auto-order-btn');\n    console.log('[Auto Order] updateAutoOrderButton called:', { isActive, btnFound: !!btn });\n    \n    if (btn) {\n      if (isActive) {\n        btn.classList.add('active');\n        btn.textContent = 'Stop Order';\n        btn.title = 'Stop automated order assignment';\n        console.log('[Auto Order] æŒ‰é’®å·²è®¾ç½®ä¸ºæ¿€æ´»çŠ¶æ€');\n      } else {\n        btn.classList.remove('active');\n        btn.textContent = 'Auto Order';\n        btn.title = 'Start automated order assignment';\n        console.log('[Auto Order] æŒ‰é’®å·²è®¾ç½®ä¸ºéæ¿€æ´»çŠ¶æ€');\n      }\n    } else {\n      console.error('[Auto Order] æ‰¾ä¸åˆ°auto-order-btnæŒ‰é’®å…ƒç´ ');\n    }\n  }\n  \n  /**\n   * ğŸ”§ NEW: æ›´æ–°Auto OrderçŠ¶æ€æ˜¾ç¤º\n   */\n  updateAutoOrderStatus(message) {\n    const statusElement = document.getElementById('auto-order-status');\n    console.log('[Auto Order] updateAutoOrderStatus called:', { message, statusFound: !!statusElement });\n    if (statusElement) {\n      statusElement.textContent = message;\n      statusElement.style.fontWeight = 'bold';\n      statusElement.style.color = '#2563eb';\n    } else {\n      console.error('[Auto Order] æ‰¾ä¸åˆ°auto-order-statusçŠ¶æ€å…ƒç´ ');\n    }\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°æŒ‡å®šå›¾ç‰‡è¿›è¡ŒAuto Order\n   */\n  navigateToImageForAutoOrder(imageId) {\n    console.log('[Auto Order] åˆ‡æ¢åˆ°å›¾ç‰‡:', imageId);\n    // æš‚æ—¶ä½¿ç”¨ä¸‹ä¸€å¼ å›¾ç‰‡å¯¼èˆª\n    if (window.navigateToNextImage) {\n      window.navigateToNextImage(true);\n    }\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªæœ‰æ— åºå·æ ‡æ³¨çš„å›¾ç‰‡\n   */\n  navigateToNextUnorderedImage() {\n    console.log('[Auto Order] å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªæœ‰æ— åºå·æ ‡æ³¨çš„å›¾ç‰‡');\n    \n    // æš‚æ—¶ä½¿ç”¨ç®€å•çš„ä¸‹ä¸€å¼ å›¾ç‰‡å¯¼èˆª\n    if (window.navigateToNextImage) {\n      const success = window.navigateToNextImage(true);\n      if (!success) {\n        // æ²¡æœ‰ä¸‹ä¸€å¼ å›¾ç‰‡ï¼Œå®ŒæˆAuto Order\n        this.completeAutoOrder();\n      }\n    } else {\n      console.error('[Auto Order] æ‰¾ä¸åˆ°å›¾ç‰‡å¯¼èˆªå‡½æ•°');\n      this.completeAutoOrder();\n    }\n  }\n  \n  /**\n   * ğŸ”§ NEW: å®ŒæˆAuto Order\n   */\n  completeAutoOrder() {\n    const typeId = this.state.autoOrderTypeId;\n    const typeName = this.getTypeName(typeId);\n    const totalOrders = this.state.autoOrderCurrentOrder - 1;\n    \n    this.stopAutoOrderMode();\n    \n    if (window.showSuccess) {\n      window.showSuccess('è‡ªåŠ¨æ’åºå®Œæˆ', `å·²ä¸ºç±»å‹ \"${typeName}\" åˆ†é…äº† ${totalOrders} ä¸ªåºå·`);\n    }\n    \n    console.log('[Auto Order] è‡ªåŠ¨æ’åºå®Œæˆï¼Œå…±åˆ†é…', totalOrders, 'ä¸ªåºå·');\n  }\n  \n  /**\n   * ğŸ”§ NEW: åŒæ­¥åºå·åˆ°å…¶ä»–å›¾ç‰‡\n   */\n  syncOrderAcrossImages(annotation, order) {\n    if (!this.plantDataManager) return;\n    \n    const currentPlant = this.plantDataManager.getCurrentPlant();\n    const currentViewAngle = this.plantDataManager.getCurrentViewAngle();\n    \n    if (!currentPlant || !currentViewAngle) return;\n    \n    // è·å–ç›¸åŒæ¤æ ªå’Œè§†è§’çš„æ‰€æœ‰å›¾ç‰‡\n    const allImages = this.plantDataManager.getAllImagesForPlantAndView(currentPlant, currentViewAngle);\n    \n    allImages.forEach(imageId => {\n      if (imageId === this.currentImage) return; // è·³è¿‡å½“å‰å›¾ç‰‡\n      \n      const annotations = this.plantDataManager.getAnnotationsForImage(imageId) || [];\n      let updated = false;\n      \n      annotations.forEach(ann => {\n        // æŸ¥æ‰¾ç›¸åŒä½ç½®å’Œç±»å‹çš„æ ‡æ³¨ï¼ˆé€šè¿‡åæ ‡ç›¸ä¼¼åº¦åˆ¤æ–­ï¼‰\n        if (ann.annotationType === 'custom' && \n            ann.customTypeId === annotation.customTypeId &&\n            (ann.order === undefined || ann.order === null) &&\n            this.areAnnotationsSimilarPosition(ann, annotation)) {\n          ann.order = order;\n          updated = true;\n          console.log('[Auto Order] åŒæ­¥åºå·åˆ°å›¾ç‰‡', imageId, 'æ ‡æ³¨', ann.id);\n        }\n      });\n      \n      if (updated) {\n        this.plantDataManager.saveAnnotationsForImage(imageId, annotations);\n      }\n    });\n  }\n  \n  /**\n   * ğŸ”§ NEW: åˆ¤æ–­ä¸¤ä¸ªæ ‡æ³¨æ˜¯å¦ä½ç½®ç›¸ä¼¼\n   */\n  areAnnotationsSimilarPosition(ann1, ann2) {\n    const threshold = 50; // åƒç´ é˜ˆå€¼\n    const dx = Math.abs(ann1.x - ann2.x);\n    const dy = Math.abs(ann1.y - ann2.y);\n    return dx < threshold && dy < threshold;\n  }\n  \n  /**\n   * ğŸ”§ NEW: æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå›¾ç‰‡ï¼ˆå½“å‰åºå·ï¼‰\n   */\n  shouldSwitchToNextImageInAutoOrder() {\n    // ç®€åŒ–ç‰ˆæœ¬ï¼šå…ˆæ£€æŸ¥å½“å‰å›¾ç‰‡æ˜¯å¦è¿˜æœ‰å½“å‰åºå·çš„æ— åºå·æ ‡æ³¨\n    const currentTypeId = this.state.autoOrderTypeId;\n    const hasUnorderedInCurrentImage = this.keypoints.some(annotation =>\n      annotation.annotationType === 'custom' &&\n      annotation.customTypeId === currentTypeId &&\n      (annotation.order === undefined || annotation.order === null)\n    );\n    \n    // å¦‚æœå½“å‰å›¾ç‰‡æ²¡æœ‰æ— åºå·æ ‡æ³¨äº†ï¼Œä½†æ˜¯è¿˜éœ€è¦æ£€æŸ¥å…¶ä»–å›¾ç‰‡\n    return !hasUnorderedInCurrentImage;\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªå›¾ç‰‡ï¼ˆç»§ç»­å½“å‰åºå·ï¼‰\n   */\n  navigateToNextImageInAutoOrder() {\n    console.log('[Auto Order] åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå›¾ç‰‡ç»§ç»­å½“å‰åºå·');\n    \n    // å…ˆå°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡\n    if (window.navigateToNextImage) {\n      const success = window.navigateToNextImage(true);\n      \n      if (!success) {\n        // æ²¡æœ‰ä¸‹ä¸€å¼ å›¾ç‰‡äº†ï¼Œå½“å‰åºå·å®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªåºå·\n        console.log('[Auto Order] æ²¡æœ‰æ›´å¤šå›¾ç‰‡ï¼Œå½“å‰åºå·å®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªåºå·');\n        this.advanceToNextOrderNumber();\n      } else {\n        // åˆ‡æ¢æˆåŠŸï¼Œç­‰å¾…ç”¨æˆ·åœ¨æ–°å›¾ç‰‡ä¸Šæ ‡æ³¨\n        console.log('[Auto Order] åˆ‡æ¢å›¾ç‰‡æˆåŠŸï¼Œç­‰å¾…ç”¨æˆ·æ ‡æ³¨');\n      }\n    } else {\n      console.error('[Auto Order] æ‰¾ä¸åˆ°å›¾ç‰‡å¯¼èˆªå‡½æ•°');\n      this.completeAutoOrder();\n    }\n  }\n  \n  /**\n   * ğŸ”§ NEW: è¿›å…¥ä¸‹ä¸€ä¸ªåºå·ç¼–å·\n   */\n  async advanceToNextOrderNumber() {\n    console.log('[Auto Order] advanceToNextOrderNumber è¢«è°ƒç”¨');\n    this.state.autoOrderCurrentOrder++;\n    \n    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º\n    this.updateAutoOrderStatus(`Ordering type \"${this.getTypeName(this.state.autoOrderTypeId)}\" #${this.state.autoOrderCurrentOrder}`);\n    \n    // ğŸ”§ FIX: ç§»é™¤dependsOnBranchPointé€‰é¡¹ï¼Œé»˜è®¤æ€»æ˜¯è·³è½¬åˆ°builtinå¯¹åº”ç¼–å·çš„ç¬¬ä¸€ä¸ªå›¾\n    console.log('[Auto Order] è·³è½¬åˆ°builtinåºå·', this.state.autoOrderCurrentOrder);\n    await this.navigateToImageWithBuiltinOrder(this.state.autoOrderCurrentOrder);\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°å½“å‰æ ‡æ³¨ç±»å‹çš„ç¬¬ä¸€å¼ å›¾\n   */\n  navigateToFirstImageOfCurrentType() {\n    console.log('[Auto Order] è·³è½¬åˆ°å½“å‰æ ‡æ³¨ç±»å‹çš„ç¬¬ä¸€å¼ å›¾');\n    \n    // ç®€åŒ–å®ç°ï¼šå›åˆ°ç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œä¸ç®¡æ˜¯å¦æœ‰å½“å‰ç±»å‹çš„æ ‡æ³¨\n    this.navigateToAbsoluteFirst();\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°æœ‰æŒ‡å®šç±»å‹æ ‡æ³¨çš„ç¬¬ä¸€å¼ å›¾\n   */\n  async navigateToFirstImageWithType(typeId) {\n    console.log('[Auto Order] æŸ¥æ‰¾æœ‰æŒ‡å®šç±»å‹æ ‡æ³¨çš„ç¬¬ä¸€å¼ å›¾:', typeId);\n    \n    try {\n      // è·å–ç¼©ç•¥å›¾å®¹å™¨\n      const thumbnailContainer = document.querySelector('#thumbnail-container');\n      if (!thumbnailContainer) {\n        console.error('[Auto Order] æ‰¾ä¸åˆ°ç¼©ç•¥å›¾å®¹å™¨');\n        return;\n      }\n      \n      // è·å–æ‰€æœ‰ç¼©ç•¥å›¾\n      const thumbnails = thumbnailContainer.querySelectorAll('.image-thumbnail');\n      console.log('[Auto Order] æ‰¾åˆ°ç¼©ç•¥å›¾æ•°é‡:', thumbnails.length);\n      \n      // éå†æ‰€æœ‰ç¼©ç•¥å›¾ï¼ŒæŸ¥æ‰¾æœ‰æŒ‡å®šç±»å‹æ ‡æ³¨çš„å›¾ç‰‡\n      for (const thumbnail of thumbnails) {\n        const imageId = thumbnail.getAttribute('data-image-id');\n        if (!imageId) continue;\n        \n        console.log('[Auto Order] æ£€æŸ¥å›¾ç‰‡:', imageId);\n        const hasType = await this.checkImageHasType(imageId, typeId);\n        if (hasType) {\n          console.log('[Auto Order] æ‰¾åˆ°æœ‰æŒ‡å®šç±»å‹çš„å›¾ç‰‡:', imageId);\n          // ç›´æ¥ç‚¹å‡»ç¼©ç•¥å›¾è·³è½¬\n          thumbnail.click();\n          return;\n        }\n      }\n      \n      console.log('[Auto Order] æ²¡æœ‰æ‰¾åˆ°æœ‰æŒ‡å®šç±»å‹æ ‡æ³¨çš„å›¾ç‰‡');\n      // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°±å›åˆ°ç¬¬ä¸€å¼ å›¾ç‰‡\n      this.navigateToAbsoluteFirst();\n      \n    } catch (error) {\n      console.error('[Auto Order] æŸ¥æ‰¾æŒ‡å®šç±»å‹å›¾ç‰‡å¤±è´¥:', error);\n      // å‡ºé”™æ—¶å›åˆ°ç¬¬ä¸€å¼ å›¾ç‰‡\n      this.navigateToAbsoluteFirst();\n    }\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°ç»å¯¹ç¬¬ä¸€å¼ å›¾ç‰‡\n   */\n  navigateToAbsoluteFirst() {\n    console.log('[Auto Order] å¯¼èˆªåˆ°ç»å¯¹ç¬¬ä¸€å¼ å›¾ç‰‡');\n    \n    let attempts = 0;\n    const maxAttempts = 50;\n    \n    const goToPrevious = () => {\n      if (attempts >= maxAttempts) {\n        console.log('[Auto Order] å·²å°è¯•æœ€å¤§æ¬¡æ•°ï¼Œåœç•™åœ¨å½“å‰å›¾ç‰‡');\n        return;\n      }\n      \n      attempts++;\n      if (window.navigateToPreviousImage) {\n        const success = window.navigateToPreviousImage();\n        if (success) {\n          setTimeout(goToPrevious, 200);\n        } else {\n          console.log('[Auto Order] å·²åˆ°è¾¾ç¬¬ä¸€å¼ å›¾ç‰‡');\n        }\n      } else {\n        console.error('[Auto Order] æ‰¾ä¸åˆ°navigateToPreviousImageå‡½æ•°');\n      }\n    };\n    \n    goToPrevious();\n  }\n\n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°ç¬¬ä¸€ä¸ªæœ‰æ— åºå·æ ‡æ³¨çš„å›¾ç‰‡\n   */\n  navigateToFirstImageWithUnorderedAnnotations() {\n    console.log('[Auto Order] è·³è½¬åˆ°ç¬¬ä¸€ä¸ªæœ‰æ— åºå·æ ‡æ³¨çš„å›¾ç‰‡');\n    \n    // ç®€åŒ–å®ç°ï¼šè¿ç»­æŒ‰ä¸Šä¸€å¼ å›¾ç‰‡ï¼Œç›´åˆ°æ— æ³•ç»§ç»­ï¼Œç„¶åå¼€å§‹ä»å¤´æŸ¥æ‰¾\n    this.navigateToBeginningThenFindUnordered();\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°å¼€å§‹ä½ç½®ç„¶åæŸ¥æ‰¾æ— åºå·æ ‡æ³¨\n   */\n  navigateToBeginningThenFindUnordered() {\n    console.log('[Auto Order] å°è¯•å¯¼èˆªåˆ°ç¬¬ä¸€å¼ å›¾ç‰‡');\n    \n    // å°è¯•å¤šæ¬¡æŒ‰ä¸Šä¸€å¼ å›¾ç‰‡æ¥å›åˆ°å¼€å§‹\n    let attempts = 0;\n    const maxAttempts = 50; // æœ€å¤šå°è¯•50æ¬¡\n    \n    const goToPrevious = () => {\n      if (attempts >= maxAttempts) {\n        console.log('[Auto Order] å·²å°è¯•æœ€å¤§æ¬¡æ•°ï¼Œå¼€å§‹æŸ¥æ‰¾');\n        this.findFirstUnorderedFromCurrent();\n        return;\n      }\n      \n      attempts++;\n      if (window.navigateToPreviousImage) {\n        const success = window.navigateToPreviousImage();\n        if (success) {\n          // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç­‰å¾…å›¾ç‰‡åŠ è½½ï¼Œç„¶åç»§ç»­\n          setTimeout(goToPrevious, 200);\n        } else {\n          // æ— æ³•ç»§ç»­å›é€€ï¼Œè¯´æ˜å·²ç»åˆ°ç¬¬ä¸€å¼ å›¾ç‰‡\n          console.log('[Auto Order] å·²åˆ°è¾¾ç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œå¼€å§‹æŸ¥æ‰¾');\n          this.findFirstUnorderedFromCurrent();\n        }\n      } else {\n        console.error('[Auto Order] æ‰¾ä¸åˆ°navigateToPreviousImageå‡½æ•°');\n        this.findFirstUnorderedFromCurrent();\n      }\n    };\n    \n    goToPrevious();\n  }\n  \n  /**\n   * ğŸ”§ NEW: ä»å½“å‰ä½ç½®å¼€å§‹æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ— åºå·æ ‡æ³¨çš„å›¾ç‰‡\n   */\n  findFirstUnorderedFromCurrent() {\n    console.log('[Auto Order] ä»å½“å‰ä½ç½®æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ— åºå·æ ‡æ³¨çš„å›¾ç‰‡');\n    \n    // æ£€æŸ¥å½“å‰å›¾ç‰‡\n    const hasUnordered = this.keypoints.some(annotation =>\n      annotation.annotationType === 'custom' &&\n      annotation.customTypeId === this.state.autoOrderTypeId &&\n      (annotation.order === undefined || annotation.order === null)\n    );\n    \n    if (hasUnordered) {\n      console.log('[Auto Order] å½“å‰å›¾ç‰‡æœ‰æ— åºå·æ ‡æ³¨ï¼Œåœç•™åœ¨æ­¤');\n      return;\n    }\n    \n    // å½“å‰å›¾ç‰‡æ²¡æœ‰ï¼Œç»§ç»­ä¸‹ä¸€å¼ \n    this.navigateToNextUnorderedImage();\n  }\n  \n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°æœ‰builtinæŒ‡å®šç¼–å·çš„å›¾ç‰‡\n   */\n  async navigateToImageWithBuiltinOrder(order) {\n    console.log('[Auto Order] è·³è½¬åˆ°builtinåºå·', order, 'çš„å›¾ç‰‡');\n    \n    // ğŸ”§ FIX: ä½¿ç”¨ç®€åŒ–çš„æœç´¢æ¨¡å¼ï¼Œæ¨¡ä»¿Auto Direction\n    await this.searchAndNavigateToBuiltinOrder(order);\n  }\n  \n  /**\n   * ğŸ”§ NEW: ç›´æ¥æœç´¢å¹¶å¯¼èˆªåˆ°builtinåºå·çš„å›¾ç‰‡\n   */\n  async searchAndNavigateToBuiltinOrder(order) {\n    console.log('[Auto Order] ç›´æ¥æœç´¢builtinåºå·', order);\n    \n    // ğŸ”§ FINAL FIX: å®Œå…¨æ¨¡ä»¿Auto Direction - ç›´æ¥åœ¨å·²è¯»å–æ•°æ®ä¸­æŸ¥æ‰¾å¹¶è·³è½¬\n    // 1. ä»windowè·å–æ‰€æœ‰å›¾ç‰‡æ•°æ®\n    // 2. ç›´æ¥åœ¨æ•°æ®ä¸­æŸ¥æ‰¾ç›®æ ‡\n    // 3. ç›´æ¥è·³è½¬åˆ°ç›®æ ‡å›¾ç‰‡\n    \n    const appState = window.PlantAnnotationTool?.appState;\n    if (!appState?.currentPlant) {\n      console.error('[Auto Order] æ— æ³•è·å–å½“å‰æ¤ç‰©ä¿¡æ¯');\n      return;\n    }\n    \n    // ä»ç¼©ç•¥å›¾è·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆæ¨¡ä»¿Auto Directionï¼‰\n    const thumbnailContainer = document.querySelector('#thumbnail-container');\n    if (!thumbnailContainer) {\n      console.error('[Auto Order] æ‰¾ä¸åˆ°ç¼©ç•¥å›¾å®¹å™¨');\n      return;\n    }\n    \n    const thumbnails = thumbnailContainer.querySelectorAll('.image-thumbnail');\n    console.log('[Auto Order] ä»ç¼©ç•¥å›¾æ‰¾åˆ°', thumbnails.length, 'å¼ å›¾ç‰‡');\n    \n    // éå†ç¼©ç•¥å›¾ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰ç›®æ ‡builtinåºå·çš„å›¾ç‰‡\n    for (const thumbnail of thumbnails) {\n      const imageId = thumbnail.dataset.imageId;\n      if (!imageId) continue;\n      \n      // æ£€æŸ¥è¿™ä¸ªå›¾ç‰‡æ˜¯å¦æœ‰ç›®æ ‡builtinåºå·ï¼ˆä»æœ¬åœ°æ•°æ®æ£€æŸ¥ï¼‰\n      const hasBuiltin = await this.checkImageHasBuiltinOrder(imageId, order);\n      if (hasBuiltin) {\n        console.log('[Auto Order] æ‰¾åˆ°ç›®æ ‡å›¾ç‰‡:', imageId);\n        // ç›´æ¥ç‚¹å‡»ç¼©ç•¥å›¾è·³è½¬\n        thumbnail.click();\n        return;\n      }\n    }\n    \n    console.log('[Auto Order] æ²¡æœ‰æ‰¾åˆ°builtinåºå·', order, 'çš„å›¾ç‰‡');\n  }\n  \n  /**\n   * ğŸ”§ NEW: æ£€æŸ¥æŒ‡å®šå›¾ç‰‡æ˜¯å¦æœ‰æŒ‡å®šç±»å‹çš„æ ‡æ³¨\n   */\n  async checkImageHasType(imageId, typeId) {\n    try {\n      // ä»æ¤ç‰©æ•°æ®ç®¡ç†å™¨è·å–æ ‡æ³¨æ•°æ®\n      const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n      if (!plantDataManager) return false;\n      \n      if (imageId === this.currentImage) {\n        // å½“å‰å›¾ç‰‡ï¼Œä½¿ç”¨å·²åŠ è½½çš„ this.keypoints\n        return this.keypoints.some(annotation =>\n          annotation.annotationType === 'custom' &&\n          annotation.customTypeId === typeId\n        );\n      } else {\n        // å…¶ä»–å›¾ç‰‡ï¼Œéœ€è¦è·å–æ ‡æ³¨æ•°æ®\n        const annotationData = await plantDataManager.annotationStorage.getImageAnnotation(imageId);\n        if (!annotationData || !annotationData.annotations) {\n          return false;\n        }\n        const annotations = annotationData.annotations;\n        return annotations.some(annotation =>\n          annotation.annotationType === 'custom' &&\n          annotation.customTypeId === typeId\n        );\n      }\n    } catch (error) {\n      console.error(`[Auto Order] æ— æ³•è·å–å›¾ç‰‡æ ‡æ³¨: ${imageId}`, error);\n      return false;\n    }\n  }\n  \n  /**\n   * ğŸ”§ NEW: æ£€æŸ¥æŒ‡å®šå›¾ç‰‡æ˜¯å¦æœ‰builtinåºå·ï¼ˆæ¨¡ä»¿Auto Directionçš„æ•°æ®æ£€æŸ¥ï¼‰\n   */\n  async checkImageHasBuiltinOrder(imageId, order) {\n    try {\n      // ä»æ¤ç‰©æ•°æ®ç®¡ç†å™¨è·å–æ ‡æ³¨æ•°æ®\n      const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n      if (!plantDataManager) return false;\n      \n      // å¦‚æœæ˜¯å½“å‰å›¾ç‰‡ï¼Œç›´æ¥ç”¨this.keypoints\n      if (imageId === this.currentImage) {\n        return this.keypoints.some(annotation =>\n          annotation.annotationType === 'custom' &&\n          annotation.customTypeId === 'builtin-regular-keypoint' &&\n          annotation.order === order\n        );\n      }\n      \n      // ğŸ”§ FIX: å¯¹äºå…¶ä»–å›¾ç‰‡ï¼Œå°è¯•è·å–æ ‡æ³¨æ•°æ®\n      try {\n        const annotationData = await plantDataManager.annotationStorage.getImageAnnotation(imageId);\n        if (!annotationData || !annotationData.annotations) {\n          return false;\n        }\n        const annotations = annotationData.annotations;\n        return annotations.some(annotation =>\n          annotation.annotationType === 'custom' &&\n          annotation.customTypeId === 'builtin-regular-keypoint' &&\n          annotation.order === order\n        );\n      } catch (annotationError) {\n        console.warn('[Auto Order] æ— æ³•è·å–å›¾ç‰‡æ ‡æ³¨:', imageId, annotationError);\n        return false;\n      }\n      \n    } catch (error) {\n      console.warn('[Auto Order] æ£€æŸ¥å›¾ç‰‡æ ‡æ³¨å¤±è´¥:', imageId, error);\n      return false;\n    }\n  }\n\n  /**\n   * ğŸ”§ NEW: å¯¼èˆªåˆ°å¼€å§‹ä½ç½®ç„¶åæŸ¥æ‰¾builtinåºå·\n   */\n  navigateToBeginningThenFindBuiltinOrder(order) {\n    console.log('[Auto Order] æŸ¥æ‰¾builtinåºå·', order, 'çš„å›¾ç‰‡');\n    \n    // ç±»ä¼¼äºnavigateToBeginningThenFindUnorderedï¼Œä½†æŸ¥æ‰¾builtinåºå·\n    let attempts = 0;\n    const maxAttempts = 50;\n    \n    const goToPrevious = () => {\n      if (attempts >= maxAttempts) {\n        console.log('[Auto Order] å·²å°è¯•æœ€å¤§æ¬¡æ•°ï¼Œå¼€å§‹æŸ¥æ‰¾builtinåºå·');\n        this.findBuiltinOrderFromCurrent(order);\n        return;\n      }\n      \n      attempts++;\n      if (window.navigateToPreviousImage) {\n        const success = window.navigateToPreviousImage();\n        if (success) {\n          setTimeout(goToPrevious, 200);\n        } else {\n          console.log('[Auto Order] å·²åˆ°è¾¾ç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œå¼€å§‹æŸ¥æ‰¾builtinåºå·');\n          this.findBuiltinOrderFromCurrent(order);\n        }\n      } else {\n        console.error('[Auto Order] æ‰¾ä¸åˆ°navigateToPreviousImageå‡½æ•°');\n        this.findBuiltinOrderFromCurrent(order);\n      }\n    };\n    \n    goToPrevious();\n  }\n  \n  /**\n   * ğŸ”§ NEW: ä»å½“å‰ä½ç½®æŸ¥æ‰¾builtinåºå·\n   */\n  findBuiltinOrderFromCurrent(order) {\n    console.log('[Auto Order] ä»å½“å‰ä½ç½®æŸ¥æ‰¾builtinåºå·', order);\n    \n    // æ£€æŸ¥å½“å‰å›¾ç‰‡æ˜¯å¦æœ‰builtinæŒ‡å®šåºå·çš„æ ‡æ³¨\n    const hasBuiltinOrder = this.keypoints.some(annotation =>\n      annotation.annotationType === 'custom' &&\n      annotation.customTypeId === 'builtin-regular-keypoint' &&\n      annotation.order === order\n    );\n    \n    if (hasBuiltinOrder) {\n      console.log('[Auto Order] æ‰¾åˆ°builtinåºå·', order, 'ï¼Œåœç•™åœ¨æ­¤å›¾ç‰‡');\n      // æ‰¾åˆ°äº†ï¼Œåœç•™åœ¨æ­¤å›¾ç‰‡ç­‰å¾…ç”¨æˆ·æ ‡æ³¨\n      console.log('[Auto Order] å·²åˆ°è¾¾ç›®æ ‡å›¾ç‰‡ï¼Œç­‰å¾…ç”¨æˆ·æ ‡æ³¨');\n      return;\n    }\n    \n    // å½“å‰å›¾ç‰‡æ²¡æœ‰ï¼Œå°è¯•ä¸‹ä¸€å¼ \n    if (window.navigateToNextImage) {\n      const success = window.navigateToNextImage(true);\n      if (success) {\n        // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç­‰å¾…å›¾ç‰‡åŠ è½½\n        setTimeout(() => this.findBuiltinOrderFromCurrent(order), 300);\n      } else {\n        // æ²¡æœ‰æ‰¾åˆ°ï¼Œå›é€€åˆ°æ™®é€šæŸ¥æ‰¾\n        console.log('[Auto Order] æ²¡æœ‰æ‰¾åˆ°builtinåºå·', order, 'ï¼Œä½¿ç”¨æ™®é€šæŸ¥æ‰¾');\n        this.navigateToFirstImageWithUnorderedAnnotations();\n      }\n    } else {\n      console.error('[Auto Order] æ‰¾ä¸åˆ°navigateToNextImageå‡½æ•°');\n      this.navigateToFirstImageWithUnorderedAnnotations();\n    }\n  }\n  \n  /**\n   * ğŸ”§ NEW: ä¿å­˜å½“å‰å›¾ç‰‡çš„æ ‡æ³¨\n   */\n  saveCurrentImageAnnotations() {\n    if (!this.plantDataManager || !this.currentImage) return;\n    \n    this.plantDataManager.saveAnnotationsForImage(this.currentImage, this.keypoints);\n  }\n}","/**\n * åˆ†æ”¯ç‚¹å®šä½é¢„è§ˆç®¡ç†å™¨\n * \n * åŠŸèƒ½ï¼š\n * - åœ¨å·¥ä½œåŒºå·¦ä¸Šè§’æ˜¾ç¤ºé¢„è§ˆçª—å£\n * - æ˜¾ç¤ºä¸Šä¸€å¼ å›¾åƒçš„å¯¹åº”åˆ†æ”¯ç‚¹ä½ç½®\n * - å¸®åŠ©æ ‡æ³¨è€…å¿«é€Ÿå®šä½å½“å‰åº”è¯¥æ ‡æ³¨çš„ä½ç½®\n * - åŸºäºåˆ†æ”¯ç‚¹åºå·çš„ä¸€è‡´æ€§é€»è¾‘\n */\n\nexport class BranchPointPreviewManager {\n  constructor() {\n    this.previewWindow = null;\n    this.previewCanvas = null;\n    this.previewCtx = null;\n    this.previewTitle = null;\n    this.previewLoading = null;\n    this.noPreview = null;\n    this.zoomSlider = null;\n    this.zoomValue = null;\n    this.plantDataManager = null;\n    \n    // çŠ¶æ€ç®¡ç†\n    this.isVisible = false;\n    this.isDragging = false;\n    this.dragStartX = 0;\n    this.dragStartY = 0;\n    this.windowStartX = 0;\n    this.windowStartY = 0;\n    this.zoomLevel = 2; // é»˜è®¤2å€æ”¾å¤§\n    \n    // ç‰¹å®šé¢„è§ˆæ¨¡å¼çŠ¶æ€\n    this.isShowingSpecificOrder = false; // æ˜¯å¦æ­£åœ¨æ˜¾ç¤ºç‰¹å®šç¼–å·çš„é¢„è§ˆ\n    this.specificTargetOrder = null; // å½“å‰æ˜¾ç¤ºçš„ç‰¹å®šç¼–å·\n    \n    // ä¸Šä¸‹æ–‡ä¿¡æ¯\n    this.currentPlantId = null;\n    this.currentViewAngle = null;\n    this.currentImageIndex = -1;\n    this.currentKeypointCount = 0; // å½“å‰å›¾åƒçš„æ ‡æ³¨ç‚¹æ•°é‡\n    \n    // ç¼“å­˜æ•°æ®ï¼Œç”¨äºå®æ—¶æ›´æ–°\n    this.previousImageData = null;\n    this.previousAnnotations = [];\n    this.cachedImageElement = null; // ç¼“å­˜åŠ è½½çš„å›¾åƒå…ƒç´ \n    \n    this.initializeElements();\n  }\n\n  /**\n   * åˆå§‹åŒ–DOMå…ƒç´ \n   */\n  initializeElements() {\n    this.previewWindow = document.getElementById('branch-point-preview');\n    this.previewCanvas = document.getElementById('preview-canvas');\n    this.previewTitle = document.getElementById('preview-title');\n    this.previewLoading = document.getElementById('preview-loading');\n    this.noPreview = document.getElementById('no-preview');\n    this.zoomSlider = document.getElementById('zoom-slider');\n    this.zoomValue = document.getElementById('zoom-value');\n    \n    if (this.previewCanvas) {\n      this.previewCtx = this.previewCanvas.getContext('2d');\n      // åˆå§‹canvaså°ºå¯¸\n      this.updateCanvasSize();\n      \n      // ç›‘å¬çª—å£å¤§å°å˜åŒ–\n      const resizeObserver = new ResizeObserver(() => {\n        this.updateCanvasSize();\n        if (this.isVisible && this.previousImageData && this.previousAnnotations) {\n          // é‡æ–°æ¸²æŸ“é¢„è§ˆ\n          this.renderPreview(this.previousImageData, this.previousAnnotations);\n        }\n      });\n      \n      if (this.previewWindow) {\n        resizeObserver.observe(this.previewWindow);\n      }\n    }\n    \n    // ç»‘å®šç¼©æ”¾æ»‘å—äº‹ä»¶\n    this.bindZoomControls();\n    \n    // ç»‘å®šæ‹–æ‹½äº‹ä»¶\n    this.bindDragEvents();\n    \n    console.log('BranchPointPreviewManager åˆå§‹åŒ–å®Œæˆ');\n  }\n\n  /**\n   * æ›´æ–°canvaså°ºå¯¸\n   */\n  updateCanvasSize() {\n    if (!this.previewCanvas || !this.previewWindow) return;\n    \n    const container = this.previewCanvas.parentElement;\n    if (!container) return;\n    \n    const containerRect = container.getBoundingClientRect();\n    const width = Math.max(100, containerRect.width - 4); // å‡å»padding\n    const height = Math.max(80, containerRect.height - 4);\n    \n    // åªæœ‰åœ¨å°ºå¯¸çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°\n    if (this.previewCanvas.width !== width || this.previewCanvas.height !== height) {\n      this.previewCanvas.width = width;\n      this.previewCanvas.height = height;\n      this.previewCanvas.style.width = width + 'px';\n      this.previewCanvas.style.height = height + 'px';\n      \n      console.log('Canvaså°ºå¯¸æ›´æ–°:', width, 'x', height);\n      \n      // å°ºå¯¸æ”¹å˜åç«‹å³ä½¿ç”¨ç¼“å­˜æ•°æ®é‡æ–°æ¸²æŸ“ï¼Œé¿å…ç™½å±\n      if (this.isVisible && this.cachedImageElement && this.previousAnnotations) {\n        this.renderCachedPreview();\n      } else if (this.isVisible && this.previousImageData && this.previousAnnotations) {\n        // å¦‚æœæ²¡æœ‰ç¼“å­˜çš„å›¾åƒå…ƒç´ ï¼Œä½¿ç”¨åŸå§‹æ•°æ®é‡æ–°æ¸²æŸ“\n        setTimeout(() => {\n          this.renderPreview(this.previousImageData, this.previousAnnotations);\n        }, 50);\n      }\n    }\n  }\n\n  /**\n   * ä½¿ç”¨ç¼“å­˜çš„å›¾åƒæ•°æ®ç«‹å³é‡æ–°æ¸²æŸ“é¢„è§ˆ\n   */\n  renderCachedPreview() {\n    if (!this.cachedImageElement || !this.previousAnnotations || !this.previewCanvas || !this.previewCtx) {\n      return;\n    }\n    \n    // è·å–ä¸‹ä¸€ä¸ªè¦æ ‡æ³¨çš„ç¼–å·\n    const nextOrder = this.getNextOrderToAnnotate();\n    \n    // åœ¨ä¸Šä¸€å¼ å›¾åƒçš„æ ‡æ³¨ä¸­æŸ¥æ‰¾å¯¹åº”ç¼–å·çš„æ ‡æ³¨ç‚¹\n    const targetAnnotation = this.previousAnnotations.find(annotation => annotation.order === nextOrder);\n    \n    // å¦‚æœæ²¡æœ‰å¯¹åº”ç¼–å·çš„æ ‡æ³¨ç‚¹ï¼Œæ˜¾ç¤ºæ— é¢„è§ˆ\n    if (!targetAnnotation) {\n      this.showNoPreview(`ä¸Šä¸€å¼ å›¾åƒæš‚æ— ç¬¬${nextOrder}ä¸ªåˆ†æ”¯ç‚¹`);\n      return;\n    }\n    \n    const img = this.cachedImageElement;\n    \n    try {\n      // è®¡ç®—å±€éƒ¨åŒºåŸŸï¼ˆå›´ç»•ç›®æ ‡æ ‡æ³¨ç‚¹ï¼Œæ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´ï¼‰\n      const baseCropSize = 200; // åŸºç¡€è£å‰ªåŒºåŸŸå¤§å°\n      const cropSize = Math.round(baseCropSize / this.zoomLevel); // æ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´è£å‰ªåŒºåŸŸ\n      const centerX = targetAnnotation.x;\n      const centerY = targetAnnotation.y;\n      \n      // è®¡ç®—è£å‰ªåŒºåŸŸï¼Œç¡®ä¿ä¸è¶…å‡ºå›¾åƒè¾¹ç•Œ\n      const cropX = Math.max(0, Math.min(img.width - cropSize, centerX - cropSize / 2));\n      const cropY = Math.max(0, Math.min(img.height - cropSize, centerY - cropSize / 2));\n      const actualCropWidth = Math.min(cropSize, img.width - cropX);\n      const actualCropHeight = Math.min(cropSize, img.height - cropY);\n      \n      // è®¾ç½®canvaså°ºå¯¸\n      const canvasWidth = this.previewCanvas.width;\n      const canvasHeight = this.previewCanvas.height;\n      \n      // æ¸…ç©ºcanvas\n      this.previewCtx.clearRect(0, 0, canvasWidth, canvasHeight);\n      \n      // ç»˜åˆ¶å±€éƒ¨æ”¾å¤§å›¾\n      this.previewCtx.drawImage(\n        img,\n        cropX, cropY, actualCropWidth, actualCropHeight, // æºå›¾è£å‰ªåŒºåŸŸ\n        0, 0, canvasWidth, canvasHeight // ç›®æ ‡åŒºåŸŸ\n      );\n      \n      // è®¡ç®—æ ‡æ³¨ç‚¹åœ¨é¢„è§ˆcanvasä¸­çš„ä½ç½®\n      const scaleX = canvasWidth / actualCropWidth;\n      const scaleY = canvasHeight / actualCropHeight;\n      const pointX = (centerX - cropX) * scaleX;\n      const pointY = (centerY - cropY) * scaleY;\n      \n      // ç»˜åˆ¶ç›®æ ‡æ ‡æ³¨ç‚¹ï¼ˆé«˜äº®ï¼‰\n      this.renderLocalizedAnnotation(pointX, pointY, nextOrder, targetAnnotation.direction, true, targetAnnotation);\n      \n      // ç»˜åˆ¶å…¶ä»–æ ‡æ³¨ç‚¹ï¼ˆå¦‚æœåœ¨è§†å›¾èŒƒå›´å†…ï¼‰\n      this.previousAnnotations.forEach((annotation) => {\n        if (annotation.order === nextOrder) return; // è·³è¿‡ç›®æ ‡ç‚¹ï¼Œå·²ç»ç»˜åˆ¶\n        \n        // æ£€æŸ¥æ˜¯å¦åœ¨è£å‰ªåŒºåŸŸå†…\n        if (annotation.x >= cropX && annotation.x <= cropX + actualCropWidth &&\n            annotation.y >= cropY && annotation.y <= cropY + actualCropHeight) {\n          \n          const otherX = (annotation.x - cropX) * scaleX;\n          const otherY = (annotation.y - cropY) * scaleY;\n          this.renderLocalizedAnnotation(otherX, otherY, annotation.order || 0, annotation.direction, false, annotation);\n        }\n      });\n      \n      // ç»˜åˆ¶æ”¾å¤§å€æ•°æç¤º\n      this.renderZoomInfo(scaleX, scaleY);\n      \n      console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®å¿«é€Ÿé‡æ–°æ¸²æŸ“å®Œæˆ');\n      \n    } catch (error) {\n      console.error('ç¼“å­˜æ¸²æŸ“å¤±è´¥:', error);\n      // å¦‚æœç¼“å­˜æ¸²æŸ“å¤±è´¥ï¼Œå›é€€åˆ°å®Œæ•´é‡æ–°æ¸²æŸ“\n      if (this.previousImageData && this.previousAnnotations) {\n        this.renderPreview(this.previousImageData, this.previousAnnotations);\n      }\n    }\n  }\n\n  /**\n   * ç»‘å®šæ‹–æ‹½äº‹ä»¶\n   */\n  bindDragEvents() {\n    const header = document.querySelector('.preview-header');\n    if (!header || !this.previewWindow) return;\n    \n    header.addEventListener('mousedown', (e) => {\n      e.preventDefault();\n      this.startDrag(e);\n    });\n    \n    document.addEventListener('mousemove', (e) => {\n      if (this.isDragging) {\n        this.drag(e);\n      }\n    });\n    \n    document.addEventListener('mouseup', () => {\n      this.endDrag();\n    });\n  }\n\n  /**\n   * å¼€å§‹æ‹–æ‹½\n   */\n  startDrag(e) {\n    this.isDragging = true;\n    this.dragStartX = e.clientX;\n    this.dragStartY = e.clientY;\n    \n    const rect = this.previewWindow.getBoundingClientRect();\n    this.windowStartX = rect.left;\n    this.windowStartY = rect.top;\n    \n    this.previewWindow.style.cursor = 'grabbing';\n    document.body.style.userSelect = 'none';\n  }\n\n  /**\n   * æ‹–æ‹½ä¸­\n   */\n  drag(e) {\n    if (!this.isDragging) return;\n    \n    const deltaX = e.clientX - this.dragStartX;\n    const deltaY = e.clientY - this.dragStartY;\n    \n    const newX = this.windowStartX + deltaX;\n    const newY = this.windowStartY + deltaY;\n    \n    // é™åˆ¶åœ¨çª—å£èŒƒå›´å†…\n    const maxX = window.innerWidth - this.previewWindow.offsetWidth;\n    const maxY = window.innerHeight - this.previewWindow.offsetHeight;\n    \n    const constrainedX = Math.max(0, Math.min(maxX, newX));\n    const constrainedY = Math.max(0, Math.min(maxY, newY));\n    \n    this.previewWindow.style.left = constrainedX + 'px';\n    this.previewWindow.style.top = constrainedY + 'px';\n  }\n\n  /**\n   * ç»“æŸæ‹–æ‹½\n   */\n  endDrag() {\n    if (!this.isDragging) return;\n    \n    this.isDragging = false;\n    this.previewWindow.style.cursor = '';\n    document.body.style.userSelect = '';\n  }\n\n  /**\n   * è®¾ç½®æ¤ç‰©æ•°æ®ç®¡ç†å™¨å¼•ç”¨\n   */\n  setPlantDataManager(plantDataManager) {\n    this.plantDataManager = plantDataManager;\n  }\n\n  /**\n   * æ˜¾ç¤º/éšè—é¢„è§ˆçª—å£\n   */\n  toggleVisibility(show = null) {\n    if (!this.previewWindow) return;\n    \n    this.isVisible = show !== null ? show : !this.isVisible;\n    \n    if (this.isVisible) {\n      this.previewWindow.classList.remove('hidden');\n      this.updatePreview();\n    } else {\n      this.previewWindow.classList.add('hidden');\n    }\n    \n    console.log(`åˆ†æ”¯ç‚¹é¢„è§ˆçª—å£: ${this.isVisible ? 'æ˜¾ç¤º' : 'éšè—'}`);\n  }\n\n  /**\n   * æ›´æ–°å½“å‰ä¸Šä¸‹æ–‡\n   */\n  async updateContext(plantId, viewAngle, imageIndex, currentKeypointCount = 0) {\n    this.currentPlantId = plantId;\n    this.currentViewAngle = viewAngle;\n    this.currentImageIndex = imageIndex;\n    this.currentKeypointCount = currentKeypointCount; // å½“å‰å›¾åƒçš„æ ‡æ³¨ç‚¹æ•°é‡\n    \n    if (this.isVisible) {\n      await this.updatePreview();\n    }\n  }\n\n  /**\n   * æ›´æ–°é¢„è§ˆå†…å®¹\n   */\n  async updatePreview() {\n    if (!this.isVisible || !this.plantDataManager || !this.currentPlantId) {\n      return;\n    }\n    \n    try {\n      this.showLoading(true);\n      \n      // è·å–ä¸Šä¸€å¼ å›¾åƒ\n      const previousImageData = await this.getPreviousImage();\n      \n      if (!previousImageData) {\n        this.showNoPreview('This is the first image');\n        return;\n      }\n      \n      // è·å–ä¸Šä¸€å¼ å›¾åƒçš„æ ‡æ³¨æ•°æ®\n      const previousAnnotations = await this.plantDataManager.getImageAnnotations(previousImageData.id);\n      \n      if (!previousAnnotations || previousAnnotations.length === 0) {\n        this.showNoPreview('This image has no annotations');\n        return;\n      }\n      \n      // æ›´æ–°é¢„è§ˆæ ‡é¢˜\n      this.updatePreviewTitle(previousImageData, previousAnnotations.length);\n      \n      // æ¸²æŸ“é¢„è§ˆ\n      await this.renderPreview(previousImageData, previousAnnotations);\n      \n      this.showLoading(false);\n      \n    } catch (error) {\n      console.error('Update branch point preview failed:', error);\n      this.showNoPreview('Preview loading failed');\n    }\n  }\n\n  /**\n   * è·å–ä¸Šä¸€å¼ å›¾åƒ\n   */\n  async getPreviousImage() {\n    if (!this.plantDataManager || this.currentImageIndex <= 0) {\n      return null;\n    }\n    \n    try {\n      const images = await this.plantDataManager.getPlantImages(\n        this.currentPlantId, \n        this.currentViewAngle\n      );\n      \n      const previousIndex = this.currentImageIndex - 1;\n      return images[previousIndex] || null;\n      \n    } catch (error) {\n      console.error('Get previous image failed:', error);\n      return null;\n    }\n  }\n\n  /**\n   * æ›´æ–°é¢„è§ˆæ ‡é¢˜\n   */\n  updatePreviewTitle(imageData, annotationCount) {\n    if (this.previewTitle) {\n      const timeString = imageData.timeString || 'Unknown time';\n      \n      // è·å–ä¸‹ä¸€ä¸ªè¦æ ‡æ³¨çš„ç¼–å·ï¼ˆæœ€å°çš„ç¼ºå¤±ç¼–å·ï¼‰\n      const nextOrder = this.getNextOrderToAnnotate();\n      \n      this.previewTitle.textContent = `Reference: ${nextOrder}th branch point`;\n      this.previewTitle.title = `${timeString} - Current need to annotate the position of the ${nextOrder}th branch point`;\n    }\n  }\n\n  /**\n   * è·å–ä¸‹ä¸€ä¸ªè¦æ ‡æ³¨çš„ç¼–å·ï¼ˆæœ€å°çš„ç¼ºå¤±ç¼–å·ï¼‰- æ”¯æŒè‡ªå®šä¹‰æ ‡æ³¨ç±»å‹\n   */\n  getNextOrderToAnnotate() {\n    // ä»AnnotationToolè·å–ä¸‹ä¸€ä¸ªå¯ç”¨ç¼–å·\n    const annotationTool = window.PlantAnnotationTool?.annotationTool;\n    if (!annotationTool) {\n      console.warn('[Preview] AnnotationTool is not available, using fallback');\n      return this.currentKeypointCount + 1;\n    }\n\n    // ğŸ”§ FIX: æ£€æŸ¥æ˜¯å¦å¤„äºè‡ªå®šä¹‰æ ‡æ³¨æ¨¡å¼\n    const customAnnotationManager = annotationTool.getCustomAnnotationManager();\n    const isInCustomMode = customAnnotationManager?.isInCustomMode();\n    \n    if (isInCustomMode) {\n      // è‡ªå®šä¹‰æ ‡æ³¨æ¨¡å¼ï¼šè·å–å½“å‰è‡ªå®šä¹‰ç±»å‹çš„ä¸‹ä¸€ä¸ªç¼–å·\n      const currentCustomType = customAnnotationManager.getCurrentCustomType();\n      if (currentCustomType && typeof annotationTool.findNextAvailableOrderForType === 'function') {\n        const nextOrder = annotationTool.findNextAvailableOrderForType(currentCustomType.id);\n        console.log(`[Preview] Custom mode - get next order for type ${currentCustomType.id}: ${nextOrder}, current keypoint count: ${this.currentKeypointCount}`);\n        return nextOrder;\n      }\n    } else {\n      // å¸¸è§„æ ‡æ³¨æ¨¡å¼ï¼šè·å–å¸¸è§„æ ‡æ³¨çš„ä¸‹ä¸€ä¸ªç¼–å·\n      if (typeof annotationTool.findNextAvailableOrder === 'function') {\n        const nextOrder = annotationTool.findNextAvailableOrder();\n        console.log(`[Preview] Regular mode - get next order: ${nextOrder}, current keypoint count: ${this.currentKeypointCount}`);\n        return nextOrder;\n      }\n    }\n\n    // åå¤‡æ–¹æ¡ˆï¼šç®€å•è®¡ç®—\n    const fallbackOrder = this.currentKeypointCount + 1;\n    console.log(`[Preview] Using fallback to calculate next order: ${fallbackOrder}, current keypoint count: ${this.currentKeypointCount}`);\n    return fallbackOrder;\n  }\n\n  /**\n   * æ¸²æŸ“é¢„è§ˆå›¾åƒå’Œæ ‡æ³¨\n   */\n  async renderPreview(imageData, annotations) {\n    if (!this.previewCanvas || !this.previewCtx) return;\n    \n    // è·å–ä¸‹ä¸€ä¸ªè¦æ ‡æ³¨çš„ç¼–å·\n    const nextOrder = this.getNextOrderToAnnotate();\n    \n    // ğŸ”§ FIX: æ ¹æ®å½“å‰æ ‡æ³¨æ¨¡å¼è¿›è¡Œä¸åŒçš„åŒ¹é…é€»è¾‘\n    const annotationTool = window.PlantAnnotationTool?.annotationTool;\n    const customAnnotationManager = annotationTool?.getCustomAnnotationManager();\n    const isInCustomMode = customAnnotationManager?.isInCustomMode();\n    \n    let targetAnnotation;\n    let previewMessage;\n    \n    if (isInCustomMode) {\n      // è‡ªå®šä¹‰æ ‡æ³¨æ¨¡å¼ï¼šåŒ¹é…ç¼–å·å’Œè‡ªå®šä¹‰ç±»å‹\n      const currentCustomType = customAnnotationManager.getCurrentCustomType();\n      if (currentCustomType) {\n        targetAnnotation = annotations.find(annotation => \n          annotation.order === nextOrder && \n          annotation.annotationType === 'custom' && \n          annotation.customTypeId === currentCustomType.id\n        );\n        previewMessage = `This image has no ${nextOrder}th ${currentCustomType.name} annotation`;\n      } else {\n        previewMessage = `This image has no ${nextOrder}th custom annotation`;\n      }\n    } else {\n      // è¿ç§»åå¸¸è§„æ ‡æ³¨è§†ä¸ºå†…ç½®ç±»å‹\n      targetAnnotation = annotations.find(annotation => \n        annotation.order === nextOrder && \n        (\n          (annotation.annotationType === 'custom' && annotation.customTypeId === 'builtin-regular-keypoint') ||\n          (!annotation.annotationType && !annotation.customTypeId) // å…œåº•å…¼å®¹æ—§æ•°æ®\n        )\n      );\n      previewMessage = `This image has no ${nextOrder}th branch point`;\n    }\n    \n    // å¦‚æœæ²¡æœ‰å¯¹åº”çš„æ ‡æ³¨ç‚¹ï¼Œæ˜¾ç¤ºæ— é¢„è§ˆ\n    if (!targetAnnotation) {\n      this.showNoPreview(previewMessage);\n      return;\n    }\n    \n    this.hideLoading();\n    this.hideNoPreview();\n    \n    try {\n      console.log('Start loading preview image:', imageData);\n      \n      // è·å–å›¾åƒURLçš„å¤šç§æ–¹å¼\n      let imageURL;\n      \n      // æ–¹å¼1ï¼šå¦‚æœæœ‰fileå¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨\n      if (imageData.file && imageData.file instanceof File) {\n        imageURL = URL.createObjectURL(imageData.file);\n          console.log('Create URL using file object:', imageURL);\n      }\n      // æ–¹å¼2ï¼šå¦‚æœæœ‰ç°æˆçš„URL\n      else if (imageData.url) {\n        imageURL = imageData.url;\n        console.log('Use existing URL:', imageURL);\n      }\n      // æ–¹å¼3ï¼šä½¿ç”¨FileSystemManager (HTTPåç«¯æˆ–ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿ)\n      else if (this.plantDataManager?.fileSystemManager) {\n        try {\n          imageURL = await this.plantDataManager.fileSystemManager.createImageURL(imageData);\n          console.log('Create URL using FileSystemManager:', imageURL);\n        } catch (error) {\n          console.warn('Create URL using FileSystemManager failed:', error);\n          \n          // å¦‚æœæ˜¯ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå°è¯•ç›´æ¥ä»handleè¯»å–\n          if (imageData.handle) {\n            try {\n              const file = await imageData.handle.getFile();\n              imageURL = URL.createObjectURL(file);\n              console.log('Create URL directly from handle:', imageURL);\n            } catch (handleError) {\n              console.error('Create URL from handle also failed:', handleError);\n              throw new Error('æ— æ³•è·å–å›¾åƒæ•°æ®ï¼šæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥');\n            }\n          } else {\n            throw error;\n          }\n        }\n      }\n      else {\n        throw new Error('æ— æ³•è·å–å›¾åƒæ•°æ®ï¼šç¼ºå°‘å¿…è¦çš„å›¾åƒä¿¡æ¯æˆ–æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨');\n      }\n      \n      // åŠ è½½å›¾åƒ\n      const img = new Image();\n      img.crossOrigin = 'anonymous'; // ğŸ”§ FIX: Prevent canvas taint issues\n      await new Promise((resolve, reject) => {\n        img.onload = () => {\n          console.log('Image loaded successfully:', img.width, 'x', img.height);\n          resolve();\n        };\n        img.onerror = (error) => {\n          console.error('Image loading failed:', error);\n          reject(new Error('Image loading failed'));\n        };\n        img.src = imageURL;\n      });\n      \n      // è®¡ç®—å±€éƒ¨åŒºåŸŸï¼ˆå›´ç»•ç›®æ ‡æ ‡æ³¨ç‚¹ï¼Œæ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´ï¼‰\n      const baseCropSize = 200; // åŸºç¡€è£å‰ªåŒºåŸŸå¤§å°\n      const cropSize = Math.round(baseCropSize / this.zoomLevel); // æ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´è£å‰ªåŒºåŸŸ\n      const centerX = targetAnnotation.x;\n      const centerY = targetAnnotation.y;\n      \n      // è®¡ç®—è£å‰ªåŒºåŸŸï¼Œç¡®ä¿ä¸è¶…å‡ºå›¾åƒè¾¹ç•Œ\n      const cropX = Math.max(0, Math.min(img.width - cropSize, centerX - cropSize / 2));\n      const cropY = Math.max(0, Math.min(img.height - cropSize, centerY - cropSize / 2));\n      const actualCropWidth = Math.min(cropSize, img.width - cropX);\n      const actualCropHeight = Math.min(cropSize, img.height - cropY);\n      \n      // è®¾ç½®canvaså°ºå¯¸\n      const canvasWidth = this.previewCanvas.width;\n      const canvasHeight = this.previewCanvas.height;\n      \n      // æ¸…ç©ºcanvas\n      this.previewCtx.clearRect(0, 0, canvasWidth, canvasHeight);\n      \n      // ç»˜åˆ¶å±€éƒ¨æ”¾å¤§å›¾\n      this.previewCtx.drawImage(\n        img,\n        cropX, cropY, actualCropWidth, actualCropHeight, // æºå›¾è£å‰ªåŒºåŸŸ\n        0, 0, canvasWidth, canvasHeight // ç›®æ ‡åŒºåŸŸ\n      );\n      \n      // è®¡ç®—æ ‡æ³¨ç‚¹åœ¨é¢„è§ˆcanvasä¸­çš„ä½ç½®\n      const scaleX = canvasWidth / actualCropWidth;\n      const scaleY = canvasHeight / actualCropHeight;\n      const pointX = (centerX - cropX) * scaleX;\n      const pointY = (centerY - cropY) * scaleY;\n      \n      // ç»˜åˆ¶ç›®æ ‡æ ‡æ³¨ç‚¹ï¼ˆé«˜äº®ï¼‰\n      this.renderLocalizedAnnotation(pointX, pointY, nextOrder, targetAnnotation.direction, true, targetAnnotation);\n      \n      // ç»˜åˆ¶å…¶ä»–æ ‡æ³¨ç‚¹ï¼ˆå¦‚æœåœ¨è§†å›¾èŒƒå›´å†…ï¼‰\n      annotations.forEach((annotation) => {\n        if (annotation.order === nextOrder) return; // è·³è¿‡ç›®æ ‡ç‚¹ï¼Œå·²ç»ç»˜åˆ¶\n        \n        // æ£€æŸ¥æ˜¯å¦åœ¨è£å‰ªåŒºåŸŸå†…\n        if (annotation.x >= cropX && annotation.x <= cropX + actualCropWidth &&\n            annotation.y >= cropY && annotation.y <= cropY + actualCropHeight) {\n          \n          const otherX = (annotation.x - cropX) * scaleX;\n          const otherY = (annotation.y - cropY) * scaleY;\n          this.renderLocalizedAnnotation(otherX, otherY, annotation.order || 0, annotation.direction, false, annotation);\n        }\n      });\n      \n      // ç»˜åˆ¶æ”¾å¤§å€æ•°æç¤º\n      this.renderZoomInfo(scaleX, scaleY);\n      \n      // ç¼“å­˜æˆåŠŸæ¸²æŸ“çš„æ•°æ®ï¼Œç”¨äºå®æ—¶æ›´æ–°\n      this.previousImageData = imageData;\n      this.previousAnnotations = annotations;\n      this.cachedImageElement = img;\n      \n      // æ¸…ç†ä¸´æ—¶URL\n      if (imageURL && imageURL.startsWith('blob:') && !imageData.url) {\n        setTimeout(() => URL.revokeObjectURL(imageURL), 5000);\n      }\n      \n      console.log('Preview rendering completed');\n      \n    } catch (error) {\n      console.error('Preview rendering failed:', error);\n      this.showNoPreview(`Preview loading failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * æ¸²æŸ“å±€éƒ¨åŒ–çš„æ ‡æ³¨ç‚¹æˆ–åŒºåŸŸ\n   */\n  renderLocalizedAnnotation(x, y, label, direction, isTarget = true, annotation = null) {\n    // ç¡®å®šæ ‡æ³¨ç±»å‹ï¼ˆç‚¹æˆ–åŒºåŸŸï¼‰\n    let isRegion = false;\n    let annotationWidth = 0;\n    let annotationHeight = 0;\n    \n    if (annotation) {\n      // æ£€æŸ¥æ˜¯å¦ä¸ºåŒºåŸŸç±»å‹\n      if (annotation.width !== undefined && annotation.height !== undefined) {\n        isRegion = true;\n        annotationWidth = annotation.width;\n        annotationHeight = annotation.height;\n      }\n    }\n\n    // æ ¹æ®æ˜¯å¦ä¸ºç›®æ ‡ç‚¹è®¾ç½®æ ·å¼\n    let fillColor, radius, borderWidth;\n\n    if (isTarget) {\n      fillColor = '#ffeb3b'; // é»„è‰²é«˜äº®\n      radius = 5; // ç¼©å°ç›®æ ‡åœ†åœˆ\n      borderWidth = 2;\n    } else {\n      // æ ¹æ®æ–¹å‘ç±»å‹è®¾ç½®é¢œè‰²\n      if (typeof direction === 'number') {\n        fillColor = '#4CAF50'; // ç»¿è‰²è¡¨ç¤ºè§’åº¦æ–¹å‘\n      } else {\n        fillColor = direction === 'left' ? '#ff6666' : '#6666ff'; // ä¼ ç»Ÿé¢œè‰²\n      }\n      radius = 3;\n      borderWidth = 1;\n    }\n\n    if (isRegion) {\n      // ç»˜åˆ¶åŒºåŸŸæ ‡æ³¨\n      const rectWidth = Math.max(10, annotationWidth * 0.1); // ç¼©æ”¾åˆ°é¢„è§ˆå°ºå¯¸\n      const rectHeight = Math.max(10, annotationHeight * 0.1);\n      const rectX = x - rectWidth / 2;\n      const rectY = y - rectHeight / 2;\n      \n      // ç»˜åˆ¶å¤–åœˆæç¤ºï¼ˆå¦‚æœæ˜¯ç›®æ ‡ï¼‰\n      if (isTarget) {\n        this.previewCtx.strokeStyle = '#ff9800';\n        this.previewCtx.lineWidth = 1;\n        this.previewCtx.setLineDash([2, 2]);\n        this.previewCtx.strokeRect(rectX - 3, rectY - 3, rectWidth + 6, rectHeight + 6);\n        this.previewCtx.setLineDash([]);\n      }\n\n      // ç»˜åˆ¶ä¸»åŒºåŸŸ\n      this.previewCtx.fillStyle = fillColor + '80'; // åŠé€æ˜å¡«å……\n      this.previewCtx.fillRect(rectX, rectY, rectWidth, rectHeight);\n\n      // ç»˜åˆ¶è¾¹æ¡†\n      this.previewCtx.strokeStyle = '#ffffff';\n      this.previewCtx.lineWidth = borderWidth;\n      this.previewCtx.strokeRect(rectX, rectY, rectWidth, rectHeight);\n\n      // ç»˜åˆ¶æ–¹å‘ç®­å¤´ï¼ˆä»åŒºåŸŸä¸­å¿ƒï¼‰\n      this.renderDirectionArrow(x, y, direction, isTarget);\n\n      // ç»˜åˆ¶åºå·ï¼ˆåœ¨åŒºåŸŸä¸­å¿ƒï¼‰\n      this.previewCtx.fillStyle = isTarget ? '#000000' : '#ffffff';\n      this.previewCtx.font = `bold ${isTarget ? 8 : 6}px Arial`;\n      this.previewCtx.textAlign = 'center';\n      this.previewCtx.textBaseline = 'middle';\n      this.previewCtx.fillText(label.toString(), x, y);\n\n      // å¦‚æœæ˜¯ç›®æ ‡åŒºåŸŸï¼Œæ·»åŠ æŒ‡ç¤º\n      if (isTarget) {\n        this.previewCtx.fillStyle = '#ff9800';\n        this.previewCtx.font = 'bold 8px Arial';\n        this.previewCtx.fillText('â–¼', x, y - rectHeight / 2 - 8);\n\n        this.previewCtx.fillStyle = '#ff9800';\n        this.previewCtx.font = 'bold 6px Arial';\n        this.previewCtx.textAlign = 'center';\n        this.previewCtx.fillText('Target', x, y + rectHeight / 2 + 8);\n      }\n    } else {\n      // ç»˜åˆ¶ç‚¹æ ‡æ³¨ï¼ˆåŸæœ‰é€»è¾‘ï¼‰\n      if (isTarget) {\n        // ç»˜åˆ¶å¤–åœˆæç¤ºï¼ˆæ›´å°çš„è™šçº¿åœ†åœˆï¼‰\n        this.previewCtx.beginPath();\n        this.previewCtx.arc(x, y, radius + 3, 0, 2 * Math.PI);\n        this.previewCtx.strokeStyle = '#ff9800';\n        this.previewCtx.lineWidth = 1;\n        this.previewCtx.setLineDash([2, 2]);\n        this.previewCtx.stroke();\n        this.previewCtx.setLineDash([]);\n      }\n\n      // ç»˜åˆ¶æ ‡æ³¨ç‚¹\n      this.previewCtx.beginPath();\n      this.previewCtx.arc(x, y, radius, 0, 2 * Math.PI);\n      this.previewCtx.fillStyle = fillColor;\n      this.previewCtx.fill();\n\n      // ç»˜åˆ¶è¾¹æ¡†\n      this.previewCtx.strokeStyle = '#ffffff';\n      this.previewCtx.lineWidth = borderWidth;\n      this.previewCtx.stroke();\n\n      // ç»˜åˆ¶æ–¹å‘ç®­å¤´ï¼ˆå¦‚æœæœ‰æ–¹å‘ä¿¡æ¯ï¼‰\n      this.renderDirectionArrow(x, y, direction, isTarget);\n\n      // ç»˜åˆ¶åºå·\n      this.previewCtx.fillStyle = isTarget ? '#000000' : '#ffffff';\n      this.previewCtx.font = `bold ${isTarget ? 8 : 6}px Arial`;\n      this.previewCtx.textAlign = 'center';\n      this.previewCtx.textBaseline = 'middle';\n      this.previewCtx.fillText(label.toString(), x, y);\n\n      // å¦‚æœæ˜¯ç›®æ ‡ç‚¹ï¼Œæ·»åŠ å°ç®­å¤´æŒ‡ç¤º\n      if (isTarget) {\n        this.previewCtx.fillStyle = '#ff9800';\n        this.previewCtx.font = 'bold 8px Arial';\n        this.previewCtx.fillText('â–¼', x, y - radius - 8);\n\n        this.previewCtx.fillStyle = '#ff9800';\n        this.previewCtx.font = 'bold 6px Arial';\n        this.previewCtx.textAlign = 'center';\n        this.previewCtx.fillText('Target', x, y + radius + 8);\n      }\n    }\n  }\n\n  /**\n   * æ¸²æŸ“æ–¹å‘ç®­å¤´ï¼ˆä¸ä¸»æ ‡æ³¨åŒºåŸŸæ ·å¼ä¸€è‡´ï¼‰\n   */\n  renderDirectionArrow(x, y, direction, isTarget = false) {\n    if (!direction) return;\n\n    let angleDegrees;\n\n    // ç»Ÿä¸€è½¬æ¢ä¸ºè§’åº¦\n    if (typeof direction === 'number') {\n      angleDegrees = direction;\n    } else if (direction === 'left') {\n      angleDegrees = 180;\n    } else if (direction === 'right') {\n      angleDegrees = 0;\n    } else {\n      return; // æ— æ•ˆæ–¹å‘\n    }\n\n    const angleRadians = angleDegrees * Math.PI / 180;\n\n    // ğŸ”§ FIX: å¢åŠ ç®­å¤´å°ºå¯¸ä»¥æé«˜å¯è§æ€§\n    const arrowLength = isTarget ? 25 : 18;  // å¢åŠ ç®­å¤´é•¿åº¦ (åŸæ¥: 15/10)\n    const headLength = isTarget ? 7 : 5;     // å¢åŠ ç®­å¤´å¤´éƒ¨å°ºå¯¸ (åŸæ¥: 4/3)\n    const lineWidth = isTarget ? 3 : 2;      // å¢åŠ çº¿æ¡å®½åº¦ (åŸæ¥: 2/1)\n\n    // è®¡ç®—ç®­å¤´ç»ˆç‚¹\n    const endX = x + Math.cos(angleRadians) * arrowLength;\n    const endY = y + Math.sin(angleRadians) * arrowLength;\n\n    this.previewCtx.save();\n\n    // ç»˜åˆ¶è™šçº¿ä¸»çº¿ï¼ˆç»¿è‰²ï¼‰\n    this.previewCtx.strokeStyle = '#10b981'; // ä¸ä¸»æ ‡æ³¨åŒºåŸŸç›¸åŒçš„ç»¿è‰²\n    this.previewCtx.lineWidth = lineWidth;\n    this.previewCtx.setLineDash([4, 2]); // è™šçº¿æ ·å¼\n    this.previewCtx.lineCap = 'round';\n\n    this.previewCtx.beginPath();\n    this.previewCtx.moveTo(x, y);\n    this.previewCtx.lineTo(endX, endY);\n    this.previewCtx.stroke();\n\n    // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨ï¼ˆå®çº¿ï¼‰\n    this.previewCtx.setLineDash([]);\n    this.previewCtx.strokeStyle = '#10b981';\n    this.previewCtx.lineWidth = lineWidth;\n    this.previewCtx.lineCap = 'round';\n\n    const headAngle1 = angleRadians + Math.PI * 0.8;\n    const headAngle2 = angleRadians - Math.PI * 0.8;\n\n    this.previewCtx.beginPath();\n    this.previewCtx.moveTo(endX, endY);\n    this.previewCtx.lineTo(endX + Math.cos(headAngle1) * headLength, endY + Math.sin(headAngle1) * headLength);\n    this.previewCtx.moveTo(endX, endY);\n    this.previewCtx.lineTo(endX + Math.cos(headAngle2) * headLength, endY + Math.sin(headAngle2) * headLength);\n    this.previewCtx.stroke();\n\n    this.previewCtx.restore();\n  }\n\n  /**\n   * æ¸²æŸ“æ”¾å¤§å€æ•°ä¿¡æ¯\n   */\n  renderZoomInfo(scaleX, scaleY) {\n    const actualScale = this.zoomLevel; // ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„ç¼©æ”¾çº§åˆ«\n    const zoomText = `${actualScale}x zoom`;\n    \n    this.previewCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';\n    this.previewCtx.fillRect(5, 5, 60, 16);\n    \n    this.previewCtx.fillStyle = '#ffffff';\n    this.previewCtx.font = '8px Arial';\n    this.previewCtx.textAlign = 'left';\n    this.previewCtx.textBaseline = 'middle';\n    this.previewCtx.fillText(zoomText, 8, 13);\n  }\n\n  /**\n   * æ˜¾ç¤ºåŠ è½½çŠ¶æ€\n   */\n  showLoading(show) {\n    if (this.previewLoading) {\n      this.previewLoading.style.display = show ? 'block' : 'none';\n    }\n    if (this.noPreview) {\n      this.noPreview.style.display = 'none';\n    }\n  }\n\n  /**\n   * æ˜¾ç¤ºæ— é¢„è§ˆçŠ¶æ€\n   */\n  showNoPreview(message) {\n    this.showLoading(false);\n    if (this.noPreview) {\n      this.noPreview.textContent = message;\n      this.noPreview.style.display = 'block';\n    }\n    \n    // æ¸…ç©ºcanvas\n    if (this.previewCanvas && this.previewCtx) {\n      this.previewCtx.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height);\n    }\n  }\n\n  /**\n   * å½“æ ‡æ³¨ç‚¹å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆä¸­çš„é«˜äº®\n   */\n  highlightCorrespondingPoints(currentAnnotations) {\n    if (!this.isVisible || !currentAnnotations) return;\n    \n    // è¿™é‡Œå¯ä»¥å®ç°é«˜äº®é€»è¾‘ï¼Œæ¯”å¦‚å½“å‰æ­£åœ¨æ ‡æ³¨çš„ç‚¹åœ¨é¢„è§ˆä¸­ç‰¹æ®Šæ˜¾ç¤º\n    // æš‚æ—¶ç®€å•é‡æ–°æ¸²æŸ“\n    this.updatePreview();\n  }\n\n  /**\n   * è·å–æŒ‡å®šç¼–å·çš„é¢„æœŸä½ç½®ï¼ˆç”¨äºè‡ªåŠ¨åˆ‡æ¢åŠŸèƒ½ï¼‰\n   */\n  async getExpectedPosition(targetOrder) {\n    try {\n      // å¦‚æœæ²¡æœ‰ç¼“å­˜çš„é¢„è§ˆæ•°æ®ï¼Œå…ˆæ›´æ–°é¢„è§ˆ\n      if (!this.previousImageData || !this.previousAnnotations) {\n        console.log(`[Expected position] No cached preview data, trying to get previous image`);\n\n        // è·å–ä¸Šä¸€å¼ å›¾åƒ\n        const previousImageData = await this.getPreviousImage();\n        if (!previousImageData) {\n          console.log(`[Expected position] No previous image data`);\n          return null;\n        }\n\n        // è·å–ä¸Šä¸€å¼ å›¾åƒçš„æ ‡æ³¨æ•°æ®\n        const previousAnnotations = await this.plantDataManager.getImageAnnotations(previousImageData.id);\n        if (!previousAnnotations || previousAnnotations.length === 0) {\n          console.log(`[Expected position] Previous image has no annotations`);\n          return null;\n        }\n\n        // æ›´æ–°ç¼“å­˜\n        this.previousImageData = previousImageData;\n        this.previousAnnotations = previousAnnotations;\n      }\n\n      // åœ¨ä¸Šä¸€å¼ å›¾åƒçš„æ ‡æ³¨ä¸­æŸ¥æ‰¾å¯¹åº”ç¼–å·çš„æ ‡æ³¨ç‚¹\n      const targetAnnotation = this.previousAnnotations.find(annotation => annotation.order === targetOrder);\n\n      if (!targetAnnotation) {\n        console.log(`[Expected position] No annotation found for order ${targetOrder} in previous image`);\n        return null;\n      }\n\n      console.log(`[Expected position] Found reference position for order ${targetOrder}: (${targetAnnotation.x.toFixed(1)}, ${targetAnnotation.y.toFixed(1)})`);\n\n      return {\n        x: targetAnnotation.x,\n        y: targetAnnotation.y,\n        order: targetAnnotation.order,\n        sourceImage: this.previousImageData.timeString || 'Previous image'\n      };\n\n    } catch (error) {\n      console.error('[Expected position] Get expected position failed:', error);\n      return null;\n    }\n  }\n\n  /**\n   * é‡ç½®é¢„è§ˆçŠ¶æ€\n   */\n  reset() {\n    this.currentPlantId = null;\n    this.currentViewAngle = null;\n    this.currentImageIndex = -1;\n    this.previousImageData = null;\n    this.previousAnnotations = [];\n    \n    if (this.isVisible) {\n      this.showNoPreview('Please choose an image');\n    }\n  }\n\n  /**\n   * è·å–é¢„è§ˆçŠ¶æ€\n   */\n  getStatus() {\n    return {\n      isVisible: this.isVisible,\n      currentPlantId: this.currentPlantId,\n      currentViewAngle: this.currentViewAngle,\n      currentImageIndex: this.currentImageIndex,\n      hasPreviousData: this.previousImageData !== null\n    };\n  }\n\n  /**\n   * éšè—åŠ è½½çŠ¶æ€\n   */\n  hideLoading() {\n    this.showLoading(false);\n  }\n\n  /**\n   * éšè—æ— é¢„è§ˆçŠ¶æ€\n   */\n  hideNoPreview() {\n    if (this.noPreview) {\n      this.noPreview.style.display = 'none';\n    }\n  }\n\n  /**\n   * ç»‘å®šç¼©æ”¾æ§åˆ¶äº‹ä»¶\n   */\n  bindZoomControls() {\n    if (!this.zoomSlider || !this.zoomValue) return;\n    \n    this.zoomSlider.addEventListener('input', (e) => {\n      this.zoomLevel = parseFloat(e.target.value);\n      this.zoomValue.textContent = this.zoomLevel + 'x';\n      \n      // ç«‹å³ä½¿ç”¨ç¼“å­˜æ•°æ®é‡æ–°æ¸²æŸ“ï¼Œé¿å…å»¶è¿Ÿ\n      if (this.isVisible && this.cachedImageElement && this.previousAnnotations) {\n        this.renderCachedPreview();\n      } else if (this.isVisible && this.previousImageData && this.previousAnnotations) {\n        // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œå›é€€åˆ°å®Œæ•´é‡æ–°æ¸²æŸ“\n        this.renderPreview(this.previousImageData, this.previousAnnotations);\n      }\n    });\n    \n    // è®¾ç½®åˆå§‹å€¼\n    this.zoomSlider.value = this.zoomLevel;\n    this.zoomValue.textContent = this.zoomLevel + 'x';\n  }\n\n  /**\n   * æ˜¾ç¤ºç‰¹å®šç¼–å·çš„é¢„è§ˆï¼ˆæ‹–åŠ¨æ—¶ä½¿ç”¨ï¼‰\n   */\n  async showSpecificOrderPreview(targetOrder) {\n    if (!this.isVisible || !this.plantDataManager || !this.currentPlantId) {\n      return;\n    }\n    \n    // æ ‡è®°å½“å‰å¤„äºç‰¹å®šé¢„è§ˆæ¨¡å¼\n    this.isShowingSpecificOrder = true;\n    this.specificTargetOrder = targetOrder;\n    \n    try {\n      // è·å–ä¸Šä¸€å¼ å›¾åƒ\n      const previousImageData = await this.getPreviousImage();\n      \n      if (!previousImageData) {\n        this.showNoPreview('This is the first image');\n        return;\n      }\n      \n      // è·å–ä¸Šä¸€å¼ å›¾åƒçš„æ ‡æ³¨æ•°æ®\n      const previousAnnotations = await this.plantDataManager.getImageAnnotations(previousImageData.id);\n      \n      if (!previousAnnotations || previousAnnotations.length === 0) {\n        this.showNoPreview('This image has no annotations');\n        return;\n      }\n      \n      // æŸ¥æ‰¾å¯¹åº”ç¼–å·çš„æ ‡æ³¨ç‚¹\n      const targetAnnotation = previousAnnotations.find(annotation => annotation.order === targetOrder);\n      \n      if (!targetAnnotation) {\n        this.showNoPreview(`This image has no ${targetOrder}th branch point`);\n        return;\n      }\n      \n      // æ›´æ–°é¢„è§ˆæ ‡é¢˜\n      this.updateSpecificPreviewTitle(previousImageData, targetOrder);\n      \n      // æ¸²æŸ“ç‰¹å®šç¼–å·çš„é¢„è§ˆ\n      await this.renderSpecificOrderPreview(previousImageData, previousAnnotations, targetOrder);\n      \n    } catch (error) {\n      console.error('Show specific order preview failed:', error);\n      this.showNoPreview('Preview loading failed');\n    }\n  }\n\n  /**\n   * æ¢å¤æ­£å¸¸é¢„è§ˆæ˜¾ç¤º\n   */\n  async restoreNormalPreview() {\n    // æ¸…é™¤ç‰¹å®šé¢„è§ˆæ¨¡å¼æ ‡è®°\n    this.isShowingSpecificOrder = false;\n    this.specificTargetOrder = null;\n    \n    // æ¢å¤åˆ°æ­£å¸¸çš„é¢„è§ˆæ›´æ–°\n    await this.updatePreview();\n  }\n\n  /**\n   * æ›´æ–°ç‰¹å®šé¢„è§ˆçš„æ ‡é¢˜\n   */\n  updateSpecificPreviewTitle(imageData, targetOrder) {\n    if (this.previewTitle) {\n      const timeString = imageData.timeString || 'Unknown time';\n      this.previewTitle.textContent = `Dragging: ${targetOrder}th branch point`;\n      this.previewTitle.title = `${timeString} - Dragging ${targetOrder}th branch point, reference position from previous image`;\n    }\n  }\n\n  /**\n   * æ¸²æŸ“ç‰¹å®šç¼–å·çš„é¢„è§ˆ\n   */\n  async renderSpecificOrderPreview(imageData, annotations, targetOrder) {\n    if (!this.previewCanvas || !this.previewCtx) return;\n    \n    // æŸ¥æ‰¾ç›®æ ‡æ ‡æ³¨ç‚¹\n    const targetAnnotation = annotations.find(annotation => annotation.order === targetOrder);\n    \n    if (!targetAnnotation) {\n      this.showNoPreview(`This image has no ${targetOrder}th branch point`);\n      return;\n    }\n    \n    this.hideLoading();\n    this.hideNoPreview();\n    \n    try {\n      console.log('Render specific order preview:', targetOrder);\n      \n      // è·å–å›¾åƒURLçš„å¤šç§æ–¹å¼ï¼ˆä¸renderPreviewä¿æŒä¸€è‡´ï¼‰\n      let imageURL;\n      \n      // æ–¹å¼1ï¼šå¦‚æœæœ‰fileå¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨\n      if (imageData.file && imageData.file instanceof File) {\n        imageURL = URL.createObjectURL(imageData.file);\n      }\n      // æ–¹å¼2ï¼šå¦‚æœæœ‰ç°æˆçš„URL\n      else if (imageData.url) {\n        imageURL = imageData.url;\n      }\n      // æ–¹å¼3ï¼šä½¿ç”¨FileSystemManager (HTTPåç«¯æˆ–ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿ)\n      else if (this.plantDataManager?.fileSystemManager) {\n        try {\n          imageURL = await this.plantDataManager.fileSystemManager.createImageURL(imageData);\n        } catch (error) {\n          console.warn('Create URL using FileSystemManager failed:', error);\n          \n          // å¦‚æœæ˜¯ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå°è¯•ç›´æ¥ä»handleè¯»å–\n          if (imageData.handle) {\n            try {\n              const file = await imageData.handle.getFile();\n              imageURL = URL.createObjectURL(file);\n            } catch (handleError) {\n              console.error('Create URL from handle also failed:', handleError);\n              throw new Error('Failed to get image data: all methods failed');\n            }\n          } else {\n            throw error;\n          }\n        }\n      }\n      else {\n        throw new Error('Failed to get image data: missing necessary image information or file system manager');\n      }\n      \n      // åŠ è½½å›¾åƒ\n      const img = new Image();\n      img.crossOrigin = 'anonymous'; // ğŸ”§ FIX: Prevent canvas taint issues\n      await new Promise((resolve, reject) => {\n        img.onload = () => resolve();\n        img.onerror = () => reject(new Error('Image loading failed'));\n        img.src = imageURL;\n      });\n      \n      // è®¡ç®—å±€éƒ¨åŒºåŸŸ\n      const baseCropSize = 200;\n      const cropSize = Math.round(baseCropSize / this.zoomLevel);\n      const centerX = targetAnnotation.x;\n      const centerY = targetAnnotation.y;\n      \n      const cropX = Math.max(0, Math.min(img.width - cropSize, centerX - cropSize / 2));\n      const cropY = Math.max(0, Math.min(img.height - cropSize, centerY - cropSize / 2));\n      const actualCropWidth = Math.min(cropSize, img.width - cropX);\n      const actualCropHeight = Math.min(cropSize, img.height - cropY);\n      \n      const canvasWidth = this.previewCanvas.width;\n      const canvasHeight = this.previewCanvas.height;\n      \n      // æ¸…ç©ºcanvas\n      this.previewCtx.clearRect(0, 0, canvasWidth, canvasHeight);\n      \n      // ç»˜åˆ¶å±€éƒ¨æ”¾å¤§å›¾\n      this.previewCtx.drawImage(\n        img,\n        cropX, cropY, actualCropWidth, actualCropHeight,\n        0, 0, canvasWidth, canvasHeight\n      );\n      \n      // è®¡ç®—æ ‡æ³¨ç‚¹ä½ç½®\n      const scaleX = canvasWidth / actualCropWidth;\n      const scaleY = canvasHeight / actualCropHeight;\n      const pointX = (centerX - cropX) * scaleX;\n      const pointY = (centerY - cropY) * scaleY;\n      \n      // ç»˜åˆ¶ç›®æ ‡æ ‡æ³¨ç‚¹ï¼ˆç‰¹æ®Šé«˜äº®ï¼‰\n      this.renderDraggedAnnotation(pointX, pointY, targetOrder, targetAnnotation.direction);\n      \n      // ç»˜åˆ¶å…¶ä»–æ ‡æ³¨ç‚¹\n      annotations.forEach((annotation) => {\n        if (annotation.order === targetOrder) return;\n        \n        if (annotation.x >= cropX && annotation.x <= cropX + actualCropWidth &&\n            annotation.y >= cropY && annotation.y <= cropY + actualCropHeight) {\n          \n          const otherX = (annotation.x - cropX) * scaleX;\n          const otherY = (annotation.y - cropY) * scaleY;\n          this.renderLocalizedAnnotation(otherX, otherY, annotation.order || 0, annotation.direction, false, annotation);\n        }\n      });\n      \n      // ç»˜åˆ¶æ”¾å¤§å€æ•°æç¤º\n      this.renderZoomInfo(scaleX, scaleY);\n      \n      // æ¸…ç†ä¸´æ—¶URL\n      if (imageURL && imageURL.startsWith('blob:') && !imageData.url) {\n        setTimeout(() => URL.revokeObjectURL(imageURL), 5000);\n      }\n      \n      console.log('Specific order preview rendering completed');\n      \n    } catch (error) {\n      console.error('Specific order preview rendering failed:', error);\n      this.showNoPreview(`Preview loading failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * æ¸²æŸ“è¢«æ‹–åŠ¨çš„æ ‡æ³¨ç‚¹ï¼ˆç‰¹æ®Šæ ·å¼ï¼‰\n   */\n  renderDraggedAnnotation(x, y, label, direction) {\n    // ä½¿ç”¨ç‰¹æ®Šçš„é¢œè‰²å’Œæ ·å¼è¡¨ç¤ºæ­£åœ¨æ‹–åŠ¨\n    const fillColor = '#ff9800'; // æ©™è‰²è¡¨ç¤ºæ‹–åŠ¨çŠ¶æ€\n    const radius = 6;\n    const borderWidth = 3;\n    \n    // ç»˜åˆ¶è„‰å†²æ•ˆæœçš„å¤–åœˆ\n    this.previewCtx.beginPath();\n    this.previewCtx.arc(x, y, radius + 5, 0, 2 * Math.PI);\n    this.previewCtx.strokeStyle = '#ff9800';\n    this.previewCtx.lineWidth = 2;\n    this.previewCtx.setLineDash([3, 3]);\n    this.previewCtx.stroke();\n    this.previewCtx.setLineDash([]);\n    \n    // ç»˜åˆ¶ä¸»æ ‡æ³¨ç‚¹\n    this.previewCtx.beginPath();\n    this.previewCtx.arc(x, y, radius, 0, 2 * Math.PI);\n    this.previewCtx.fillStyle = fillColor;\n    this.previewCtx.fill();\n    \n    // ç»˜åˆ¶è¾¹æ¡†\n    this.previewCtx.strokeStyle = '#ffffff';\n    this.previewCtx.lineWidth = borderWidth;\n    this.previewCtx.stroke();\n\n    // ç»˜åˆ¶æ–¹å‘ç®­å¤´ï¼ˆå¦‚æœæœ‰æ–¹å‘ä¿¡æ¯ï¼‰\n    this.renderDirectionArrow(x, y, direction, true);\n\n    // ç»˜åˆ¶åºå·\n    this.previewCtx.fillStyle = '#000000';\n    this.previewCtx.font = 'bold 9px Arial';\n    this.previewCtx.textAlign = 'center';\n    this.previewCtx.textBaseline = 'middle';\n    this.previewCtx.fillText(label.toString(), x, y);\n    \n    // æ·»åŠ æ‹–åŠ¨æŒ‡ç¤º\n    this.previewCtx.fillStyle = '#ff9800';\n    this.previewCtx.font = 'bold 7px Arial';\n    this.previewCtx.fillText('Dragging', x, y + radius + 12);\n  }\n} ","/**\n * ç¬”è®°ç®¡ç†å™¨\n * \n * åŠŸèƒ½ï¼š\n * - ç®¡ç†æ¤ç‰©çº§å’Œå›¾åƒçº§ç¬”è®°\n * - ä¸HttpFileSystemManageré›†æˆ\n * - ç‹¬ç«‹äºè·³è¿‡åŠŸèƒ½çš„ç¬”è®°ç³»ç»Ÿ\n * - æ”¯æŒæœç´¢ã€è¿‡æ»¤å’Œç»Ÿè®¡\n */\n\nexport class NoteManager {\n  constructor(httpFileSystemManager) {\n    this.httpManager = httpFileSystemManager;\n    this.notes = new Map(); // ç¬”è®°ç¼“å­˜\n    this.cacheTimestamps = new Map(); // ç¼“å­˜æ—¶é—´æˆ³\n    this.isInitialized = false;\n    this.cacheExpiration = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜è¿‡æœŸ\n    this.requestQueue = new Map(); // è¯·æ±‚é˜Ÿåˆ—é˜²æ­¢é‡å¤è¯·æ±‚\n    this.noteCounts = new Map(); // ç¬”è®°æ•°é‡ç¼“å­˜\n    \n    // Performance optimizations\n    this.bulkNoteData = null; // æ‰¹é‡ç¬”è®°æ•°æ®ç¼“å­˜\n    this.bulkDataTimestamp = 0; // æ‰¹é‡æ•°æ®æ—¶é—´æˆ³\n    this.performanceMetrics = {\n      requestCount: 0,\n      bulkRequestCount: 0,\n      cacheHits: 0,\n      networkTime: 0\n    };\n  }\n\n  /**\n   * è·å–åŸºç¡€URL (ç”¨äºNoteUIå…¼å®¹æ€§)\n   */\n  get baseUrl() {\n    return this.httpManager.baseUrl;\n  }\n\n  /**\n   * åˆå§‹åŒ–ç¬”è®°ç®¡ç†å™¨\n   */\n  async initialize() {\n    try {\n      await this.httpManager.ensureConnection();\n      this.isInitialized = true;\n      console.log('NoteManager åˆå§‹åŒ–æˆåŠŸ');\n      return true;\n    } catch (error) {\n      console.error('NoteManager åˆå§‹åŒ–å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç¡®ä¿è¿æ¥å¯ç”¨\n   */\n  async ensureConnection() {\n    if (!this.isInitialized) {\n      await this.initialize();\n    }\n    await this.httpManager.ensureConnection();\n  }\n\n  /**\n   * æ·»åŠ æ¤ç‰©ç¬”è®°\n   */\n  async addPlantNote(plantId, noteData) {\n    if (!plantId) {\n      throw new Error('æ¤ç‰©IDä¸èƒ½ä¸ºç©º');\n    }\n    if (!noteData.title || !noteData.content) {\n      throw new Error('ç¬”è®°æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n\n    return this.httpManager.withRetry(async () => {\n      const response = await fetch(`${this.httpManager.baseUrl}/notes/plant/${encodeURIComponent(plantId)}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(noteData)\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n\n      if (result.success) {\n        // ğŸ”§ FIX: Force complete cache clear for immediate visibility of new note\n        this.clearCache();\n        console.log(`æ¤ç‰©ç¬”è®°åˆ›å»ºæˆåŠŸ: ${result.data.noteId} - ç¼“å­˜å·²å®Œå…¨æ¸…é™¤`);\n        return result.data.noteId;\n      }\n\n      throw new Error(result.error || 'åˆ›å»ºæ¤ç‰©ç¬”è®°å¤±è´¥');\n    }, `åˆ›å»ºæ¤ç‰© ${plantId} ç¬”è®°`);\n  }\n\n  /**\n   * æ·»åŠ å›¾åƒç¬”è®°\n   */\n  async addImageNote(plantId, imageId, noteData) {\n    if (!plantId) {\n      throw new Error('æ¤ç‰©IDä¸èƒ½ä¸ºç©º');\n    }\n    if (!imageId) {\n      throw new Error('å›¾åƒIDä¸èƒ½ä¸ºç©º');\n    }\n    if (!noteData.title || !noteData.content) {\n      throw new Error('ç¬”è®°æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n\n    return this.httpManager.withRetry(async () => {\n      const response = await fetch(`${this.httpManager.baseUrl}/notes/image/${encodeURIComponent(plantId)}/${encodeURIComponent(imageId)}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(noteData)\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n\n      if (result.success) {\n        // ğŸ”§ FIX: Force complete cache clear for immediate visibility of new note\n        this.clearCache();\n        console.log(`å›¾åƒç¬”è®°åˆ›å»ºæˆåŠŸ: ${result.data.noteId} - ç¼“å­˜å·²å®Œå…¨æ¸…é™¤`);\n        return result.data.noteId;\n      }\n\n      throw new Error(result.error || 'åˆ›å»ºå›¾åƒç¬”è®°å¤±è´¥');\n    }, `åˆ›å»ºå›¾åƒ ${imageId} ç¬”è®°`);\n  }\n\n  /**\n   * è·å–æ¤ç‰©ç¬”è®° (ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¼˜å…ˆä½¿ç”¨æ‰¹é‡æ•°æ®)\n   */\n  async getPlantNotes(plantId) {\n    if (!plantId) {\n      throw new Error('æ¤ç‰©IDä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n\n    const cacheKey = `plant_${plantId}`;\n    \n    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ‰¹é‡æ•°æ®ç¼“å­˜\n    if (this.bulkNoteData && !this.isBulkDataExpired()) {\n      const plantNotes = this.bulkNoteData.plantNotes[plantId] || [];\n      this.notes.set(cacheKey, plantNotes);\n      this.performanceMetrics.cacheHits++;\n      return plantNotes;\n    }\n    \n    // æ£€æŸ¥ç‹¬ç«‹ç¼“å­˜\n    if (this.notes.has(cacheKey) && !this.isCacheExpired(cacheKey)) {\n      this.performanceMetrics.cacheHits++;\n      return this.notes.get(cacheKey);\n    }\n\n    return this.httpManager.withRetry(async () => {\n      const startTime = performance.now();\n      const url = `${this.httpManager.baseUrl}/notes/plant/${encodeURIComponent(plantId)}`;\n      console.log(`[NoteManager] è¯·æ±‚æ¤ç‰©ç¬”è®° URL: ${url}`);\n      \n      try {\n        const response = await fetch(url);\n        this.performanceMetrics.requestCount++;\n\n        if (!response.ok) {\n          console.error(`[NoteManager] è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);\n          \n          // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯\n          if (response.status === 404) {\n            // 404 å¯èƒ½è¡¨ç¤ºè¯¥æ¤ç‰©æ²¡æœ‰ç¬”è®°ï¼Œè¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯\n            const emptyResult = [];\n            this.setCache(cacheKey, emptyResult);\n            return emptyResult;\n          } else if (response.status === 500) {\n            throw new Error(`æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500): è¯·æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€`);\n          } else if (response.status === 403) {\n            throw new Error(`è®¿é—®è¢«æ‹’ç» (403): è¯·æ£€æŸ¥æƒé™è®¾ç½®`);\n          } else {\n            throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n          }\n        }\n\n        const result = await response.json();\n        this.performanceMetrics.networkTime += performance.now() - startTime;\n\n        if (result.success) {\n          // ç¼“å­˜ç»“æœ\n          this.setCache(cacheKey, result.data);\n          console.log(`[NoteManager] æˆåŠŸè·å–æ¤ç‰© ${plantId} çš„ ${result.data.length} æ¡ç¬”è®°`);\n          return result.data;\n        }\n\n        throw new Error(result.error || 'è·å–æ¤ç‰©ç¬”è®°å¤±è´¥');\n      } catch (fetchError) {\n        this.performanceMetrics.networkTime += performance.now() - startTime;\n        // ç½‘ç»œé”™è¯¯å¤„ç†\n        if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {\n          throw new Error(`ç½‘ç»œè¿æ¥å¤±è´¥: æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ (${url})`);\n        }\n        throw fetchError;\n      }\n    }, `è·å–æ¤ç‰© ${plantId} ç¬”è®°`);\n  }\n\n  /**\n   * è·å–å›¾åƒç¬”è®° (ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¼˜å…ˆä½¿ç”¨æ‰¹é‡æ•°æ®)\n   */\n  async getImageNotes(plantId, imageId) {\n    if (!plantId) {\n      throw new Error('æ¤ç‰©IDä¸èƒ½ä¸ºç©º');\n    }\n    if (!imageId) {\n      throw new Error('å›¾åƒIDä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n\n    const cacheKey = `image_${plantId}_${imageId}`;\n    \n    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ‰¹é‡æ•°æ®ç¼“å­˜\n    if (this.bulkNoteData && !this.isBulkDataExpired()) {\n      const imageNotes = this.bulkNoteData.imageNotes[imageId] || [];\n      this.notes.set(cacheKey, imageNotes);\n      this.performanceMetrics.cacheHits++;\n      return imageNotes;\n    }\n    \n    // æ£€æŸ¥ç‹¬ç«‹ç¼“å­˜\n    if (this.notes.has(cacheKey) && !this.isCacheExpired(cacheKey)) {\n      this.performanceMetrics.cacheHits++;\n      return this.notes.get(cacheKey);\n    }\n\n    return this.httpManager.withRetry(async () => {\n      const startTime = performance.now();\n      const url = `${this.httpManager.baseUrl}/notes/image/${encodeURIComponent(plantId)}/${encodeURIComponent(imageId)}`;\n      console.log(`[NoteManager] è¯·æ±‚å›¾åƒç¬”è®° URL: ${url}`);\n      \n      try {\n        const response = await fetch(url);\n        this.performanceMetrics.requestCount++;\n\n        if (!response.ok) {\n          console.error(`[NoteManager] è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);\n          \n          // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯\n          if (response.status === 404) {\n            // 404 å¯èƒ½è¡¨ç¤ºè¯¥å›¾åƒæ²¡æœ‰ç¬”è®°ï¼Œè¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯\n            const emptyResult = [];\n            this.setCache(cacheKey, emptyResult);\n            return emptyResult;\n          } else if (response.status === 500) {\n            throw new Error(`æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500): è¯·æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€`);\n          } else if (response.status === 403) {\n            throw new Error(`è®¿é—®è¢«æ‹’ç» (403): è¯·æ£€æŸ¥æƒé™è®¾ç½®`);\n          } else {\n            throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n          }\n        }\n\n        const result = await response.json();\n        this.performanceMetrics.networkTime += performance.now() - startTime;\n\n        if (result.success) {\n          // ç¼“å­˜ç»“æœ\n          this.setCache(cacheKey, result.data);\n          console.log(`[NoteManager] æˆåŠŸè·å–å›¾åƒ ${imageId} çš„ ${result.data.length} æ¡ç¬”è®°`);\n          return result.data;\n        }\n\n        throw new Error(result.error || 'è·å–å›¾åƒç¬”è®°å¤±è´¥');\n      } catch (fetchError) {\n        this.performanceMetrics.networkTime += performance.now() - startTime;\n        // ç½‘ç»œé”™è¯¯å¤„ç†\n        if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {\n          throw new Error(`ç½‘ç»œè¿æ¥å¤±è´¥: æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ (${url})`);\n        }\n        throw fetchError;\n      }\n    }, `è·å–å›¾åƒ ${imageId} ç¬”è®°`);\n  }\n\n  /**\n   * æ›´æ–°ç¬”è®°\n   */\n  async updateNote(noteId, updates) {\n    if (!noteId) {\n      throw new Error('ç¬”è®°IDä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n\n    return this.httpManager.withRetry(async () => {\n      const response = await fetch(`${this.httpManager.baseUrl}/notes/${encodeURIComponent(noteId)}`, {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(updates)\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n\n      if (result.success) {\n        // æ¸…é™¤ç›¸å…³ç¼“å­˜\n        this.clearCache();\n        console.log(`ç¬”è®°æ›´æ–°æˆåŠŸ: ${noteId}`);\n        return result.data;\n      }\n\n      throw new Error(result.error || 'æ›´æ–°ç¬”è®°å¤±è´¥');\n    }, `æ›´æ–°ç¬”è®° ${noteId}`);\n  }\n\n  /**\n   * åˆ é™¤ç¬”è®°\n   */\n  async deleteNote(noteId) {\n    if (!noteId) {\n      throw new Error('ç¬”è®°IDä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n\n    return this.httpManager.withRetry(async () => {\n      const response = await fetch(`${this.httpManager.baseUrl}/notes/${encodeURIComponent(noteId)}`, {\n        method: 'DELETE'\n      });\n\n      if (!response.ok) {\n        // ğŸ”§ FIX: Handle 404 gracefully - note may already be deleted\n        if (response.status === 404) {\n          console.warn(`ç¬”è®° ${noteId} ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤`);\n          // Clear cache and return success since the goal (note not existing) is achieved\n          this.clearCache();\n          return true;\n        }\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n\n      if (result.success) {\n        // æ¸…é™¤ç›¸å…³ç¼“å­˜\n        this.clearCache();\n        console.log(`ç¬”è®°åˆ é™¤æˆåŠŸ: ${noteId}`);\n        return true;\n      }\n\n      throw new Error(result.error || 'åˆ é™¤ç¬”è®°å¤±è´¥');\n    }, `åˆ é™¤ç¬”è®° ${noteId}`);\n  }\n\n  /**\n   * è·å–å•ä¸ªç¬”è®°\n   */\n  async getNote(noteId) {\n    if (!noteId) {\n      throw new Error('ç¬”è®°IDä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n\n    return this.httpManager.withRetry(async () => {\n      const response = await fetch(`${this.httpManager.baseUrl}/notes/${encodeURIComponent(noteId)}`);\n\n      if (!response.ok) {\n        if (response.status === 404) {\n          return null;\n        }\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n\n      if (result.success) {\n        return result.data;\n      }\n\n      throw new Error(result.error || 'è·å–ç¬”è®°å¤±è´¥');\n    }, `è·å–ç¬”è®° ${noteId}`);\n  }\n\n  /**\n   * æœç´¢ç¬”è®°\n   */\n  async searchNotes(query, filters = {}) {\n    await this.ensureConnection();\n\n    return this.httpManager.withRetry(async () => {\n      const searchParams = new URLSearchParams();\n      \n      if (query) {\n        searchParams.append('query', query);\n      }\n      \n      if (filters.plantId) {\n        searchParams.append('plantId', filters.plantId);\n      }\n      \n      if (filters.noteType) {\n        searchParams.append('noteType', filters.noteType);\n      }\n      \n      if (filters.author) {\n        searchParams.append('author', filters.author);\n      }\n\n      const searchUrl = `${this.httpManager.baseUrl}/notes/search?${searchParams}`;\n      console.log('[NoteManager] Making search request to:', searchUrl);\n      \n      const response = await fetch(searchUrl);\n\n      if (!response.ok) {\n        const error = new Error(`HTTP ${response.status}: ${response.statusText}`);\n        error.url = searchUrl;\n        error.status = response.status;\n        console.error('[NoteManager] Search request failed:', error);\n        throw error;\n      }\n\n      const result = await response.json();\n\n      if (result.success) {\n        return result.data;\n      }\n\n      throw new Error(result.error || 'æœç´¢ç¬”è®°å¤±è´¥');\n    }, 'æœç´¢ç¬”è®°');\n  }\n\n  /**\n   * è·å–ç¬”è®°ç»Ÿè®¡\n   */\n  async getStats() {\n    await this.ensureConnection();\n\n    return this.httpManager.withRetry(async () => {\n      const response = await fetch(`${this.httpManager.baseUrl}/notes/stats`);\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n\n      if (result.success) {\n        return result.data;\n      }\n\n      throw new Error(result.error || 'è·å–ç¬”è®°ç»Ÿè®¡å¤±è´¥');\n    }, 'è·å–ç¬”è®°ç»Ÿè®¡');\n  }\n\n  /**\n   * æ¸…é™¤ç¼“å­˜\n   */\n  clearCache() {\n    this.notes.clear();\n    this.cacheTimestamps.clear();\n    this.noteCounts.clear();\n    \n    // ğŸ”§ FIX: Clear bulk data cache to prevent stale data issues\n    this.bulkNoteData = null;\n    this.bulkDataTimestamp = 0;\n    \n    console.log('ç¬”è®°ç¼“å­˜å·²å®Œå…¨æ¸…é™¤ (åŒ…æ‹¬æ‰¹é‡æ•°æ®ç¼“å­˜)');\n  }\n\n  /**\n   * ä½¿ç‰¹å®šç¼“å­˜å¤±æ•ˆ\n   */\n  invalidateCache(plantId, imageId = null) {\n    const plantKey = `plant_${plantId}`;\n    this.notes.delete(plantKey);\n    \n    if (imageId) {\n      const imageKey = `image_${plantId}_${imageId}`;\n      this.notes.delete(imageKey);\n    }\n  }\n\n  /**\n   * è·å–ç¼“å­˜ç»Ÿè®¡\n   */\n  getCacheStats() {\n    return {\n      cacheSize: this.notes.size,\n      isInitialized: this.isInitialized,\n      cacheKeys: Array.from(this.notes.keys())\n    };\n  }\n\n  /**\n   * éªŒè¯ç¬”è®°æ•°æ®æ ¼å¼\n   */\n  validateNoteData(noteData) {\n    const errors = [];\n\n    if (!noteData.title || noteData.title.trim() === '') {\n      errors.push('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');\n    }\n\n    if (!noteData.content || noteData.content.trim() === '') {\n      errors.push('å†…å®¹ä¸èƒ½ä¸ºç©º');\n    }\n\n    if (noteData.title && noteData.title.length > 100) {\n      errors.push('æ ‡é¢˜é•¿åº¦ä¸èƒ½è¶…è¿‡100å­—ç¬¦');\n    }\n\n    if (noteData.content && noteData.content.length > 5000) {\n      errors.push('å†…å®¹é•¿åº¦ä¸èƒ½è¶…è¿‡5000å­—ç¬¦');\n    }\n\n    if (noteData.noteType && !['general', 'observation', 'annotation'].includes(noteData.noteType)) {\n      errors.push('ç¬”è®°ç±»å‹å¿…é¡»æ˜¯ generalã€observation æˆ– annotation');\n    }\n\n    if (noteData.tags && !Array.isArray(noteData.tags)) {\n      errors.push('æ ‡ç­¾å¿…é¡»æ˜¯æ•°ç»„');\n    }\n\n    return {\n      isValid: errors.length === 0,\n      errors\n    };\n  }\n\n  /**\n   * æ ¼å¼åŒ–ç¬”è®°æ•°æ®ç”¨äºæ˜¾ç¤º\n   */\n  formatNoteForDisplay(note) {\n    return {\n      ...note,\n      formattedTimestamp: new Date(note.timestamp).toLocaleString('zh-CN'),\n      formattedLastModified: new Date(note.lastModified).toLocaleString('zh-CN'),\n      shortContent: note.content.length > 100 ? \n        note.content.substring(0, 100) + '...' : \n        note.content,\n      tagsText: note.tags.join(', ')\n    };\n  }\n\n  /**\n   * æ¸…ç†èµ„æº\n   */\n  cleanup() {\n    this.clearCache();\n    this.isInitialized = false;\n    \n    // æ¸…ç†å®šæ—¶å™¨ï¼ˆå¦‚æœæœ‰ï¼‰\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n    }\n    \n    console.log('NoteManager æ¸…ç†å®Œæˆ');\n  }\n\n  /**\n   * å¯åŠ¨è‡ªåŠ¨æ¸…ç†\n   */\n  startAutoCleanup() {\n    // æ¯10åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡è¿‡æœŸç¼“å­˜\n    this.cleanupTimer = setInterval(() => {\n      this.cleanupExpiredCache();\n    }, 10 * 60 * 1000);\n  }\n\n  /**\n   * æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ\n   */\n  isCacheExpired(key) {\n    const timestamp = this.cacheTimestamps.get(key);\n    if (!timestamp) return true;\n    return Date.now() - timestamp > this.cacheExpiration;\n  }\n\n  /**\n   * è®¾ç½®ç¼“å­˜\n   */\n  setCache(key, data) {\n    this.notes.set(key, data);\n    this.cacheTimestamps.set(key, Date.now());\n  }\n\n  /**\n   * é˜²é‡å¤è¯·æ±‚è£…é¥°å™¨\n   */\n  async withRequestDeduplication(key, requestFn) {\n    // å¦‚æœå·²æœ‰ç›¸åŒè¯·æ±‚åœ¨è¿›è¡Œï¼Œè¿”å›è¯¥è¯·æ±‚\n    if (this.requestQueue.has(key)) {\n      return this.requestQueue.get(key);\n    }\n\n    // åˆ›å»ºæ–°è¯·æ±‚\n    const requestPromise = requestFn();\n    this.requestQueue.set(key, requestPromise);\n\n    try {\n      const result = await requestPromise;\n      this.requestQueue.delete(key);\n      return result;\n    } catch (error) {\n      this.requestQueue.delete(key);\n      throw error;\n    }\n  }\n\n  /**\n   * è·å–ç¬”è®°æ•°é‡ï¼ˆå¿«é€Ÿæ£€æŸ¥ï¼‰\n   */\n  async getNoteCount(plantId, imageId = null) {\n    const countKey = imageId ? `image_${plantId}_${imageId}` : `plant_${plantId}`;\n    \n    // å¦‚æœæœ‰ç¼“å­˜çš„æ•°é‡ï¼Œç›´æ¥è¿”å›\n    if (this.noteCounts.has(countKey)) {\n      return this.noteCounts.get(countKey);\n    }\n\n    // å¦‚æœæœ‰å®Œæ•´çš„ç¬”è®°ç¼“å­˜ï¼Œè®¡ç®—æ•°é‡\n    const cacheKey = imageId ? `image_${plantId}_${imageId}` : `plant_${plantId}`;\n    if (this.notes.has(cacheKey) && !this.isCacheExpired(cacheKey)) {\n      const notes = this.notes.get(cacheKey);\n      const count = notes.length;\n      this.noteCounts.set(countKey, count);\n      return count;\n    }\n\n    // å¼‚æ­¥è·å–ç¬”è®°ï¼ˆä¸é˜»å¡UIï¼‰\n    this.loadNotesAsync(plantId, imageId);\n    return 0; // è¿”å›é»˜è®¤å€¼\n  }\n\n  /**\n   * å¼‚æ­¥åŠ è½½ç¬”è®°ï¼ˆåå°åŠ è½½ï¼‰\n   */\n  async loadNotesAsync(plantId, imageId = null) {\n    try {\n      if (imageId) {\n        await this.getImageNotes(plantId, imageId);\n      } else {\n        await this.getPlantNotes(plantId);\n      }\n    } catch (error) {\n      console.warn('åå°åŠ è½½ç¬”è®°å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * é¢„åŠ è½½ç¬”è®°ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰\n   */\n  async preloadNotes(plantId, imageIds = []) {\n    const promises = [];\n    \n    // é¢„åŠ è½½æ¤ç‰©ç¬”è®°\n    promises.push(this.loadNotesAsync(plantId));\n    \n    // é¢„åŠ è½½å›¾åƒç¬”è®°\n    imageIds.forEach(imageId => {\n      promises.push(this.loadNotesAsync(plantId, imageId));\n    });\n    \n    try {\n      await Promise.allSettled(promises);\n      console.log(`é¢„åŠ è½½å®Œæˆ: æ¤ç‰© ${plantId} å’Œ ${imageIds.length} ä¸ªå›¾åƒçš„ç¬”è®°`);\n    } catch (error) {\n      console.warn('é¢„åŠ è½½ç¬”è®°å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * æ‰¹é‡è·å–æ‰€æœ‰ç¬”è®°æ•°æ® (æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ–¹æ³•)\n   */\n  async getAllNotesInBulk() {\n    console.log('[NoteManager] å¼€å§‹æ‰¹é‡è·å–æ‰€æœ‰ç¬”è®°æ•°æ®...');\n    \n    await this.ensureConnection();\n    \n    // æ£€æŸ¥æ‰¹é‡æ•°æ®ç¼“å­˜\n    if (this.bulkNoteData && !this.isBulkDataExpired()) {\n      console.log('[NoteManager] ä½¿ç”¨ç¼“å­˜çš„æ‰¹é‡ç¬”è®°æ•°æ®');\n      this.performanceMetrics.cacheHits++;\n      return this.bulkNoteData;\n    }\n\n    return this.httpManager.withRetry(async () => {\n      const startTime = performance.now();\n      const url = `${this.httpManager.baseUrl}/notes/bulk`;\n      console.log(`[NoteManager] è¯·æ±‚æ‰¹é‡ç¬”è®°æ•°æ® URL: ${url}`);\n      \n      try {\n        const response = await fetch(url, {\n          headers: {\n            'Cache-Control': 'no-cache'\n          }\n        });\n        this.performanceMetrics.bulkRequestCount++;\n\n        if (!response.ok) {\n          if (response.status === 404) {\n            console.warn('[NoteManager] æ‰¹é‡ç¬”è®°ç«¯ç‚¹ä¸å­˜åœ¨ï¼Œå°†å›é€€åˆ°å•ç‹¬è¯·æ±‚æ¨¡å¼');\n            return null; // è¡¨ç¤ºä¸æ”¯æŒæ‰¹é‡API\n          }\n          throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n        }\n\n        const result = await response.json();\n        this.performanceMetrics.networkTime += performance.now() - startTime;\n\n        if (result.success) {\n          // ç¼“å­˜æ‰¹é‡æ•°æ®\n          this.bulkNoteData = {\n            plantNotes: result.data.plantNotes || {},\n            imageNotes: result.data.imageNotes || {},\n            statistics: result.data.statistics || {}\n          };\n          this.bulkDataTimestamp = Date.now();\n          \n          // åŒæ—¶æ›´æ–°ä¸ªåˆ«ç¼“å­˜ä»¥ä¿æŒä¸€è‡´æ€§\n          this.updateIndividualCacheFromBulk();\n          \n          const plantCount = Object.keys(this.bulkNoteData.plantNotes).length;\n          const imageCount = Object.keys(this.bulkNoteData.imageNotes).length;\n          console.log(`[NoteManager] æˆåŠŸè·å–æ‰¹é‡ç¬”è®°æ•°æ®: ${plantCount} ä¸ªæ¤ç‰©, ${imageCount} ä¸ªå›¾åƒ`);\n          \n          return this.bulkNoteData;\n        }\n\n        throw new Error(result.error || 'è·å–æ‰¹é‡ç¬”è®°æ•°æ®å¤±è´¥');\n      } catch (fetchError) {\n        this.performanceMetrics.networkTime += performance.now() - startTime;\n        \n        if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {\n          throw new Error(`ç½‘ç»œè¿æ¥å¤±è´¥: æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ (${url})`);\n        }\n        throw fetchError;\n      }\n    }, 'æ‰¹é‡è·å–ç¬”è®°æ•°æ®');\n  }\n\n  /**\n   * æ£€æŸ¥æ‰¹é‡æ•°æ®æ˜¯å¦è¿‡æœŸ\n   */\n  isBulkDataExpired() {\n    if (!this.bulkDataTimestamp) return true;\n    return Date.now() - this.bulkDataTimestamp > this.cacheExpiration;\n  }\n\n  /**\n   * ä»æ‰¹é‡æ•°æ®æ›´æ–°ä¸ªåˆ«ç¼“å­˜\n   */\n  updateIndividualCacheFromBulk() {\n    if (!this.bulkNoteData) return;\n    \n    // æ›´æ–°æ¤ç‰©ç¬”è®°ç¼“å­˜\n    for (const [plantId, notes] of Object.entries(this.bulkNoteData.plantNotes)) {\n      const cacheKey = `plant_${plantId}`;\n      this.setCache(cacheKey, notes);\n    }\n    \n    // æ›´æ–°å›¾åƒç¬”è®°ç¼“å­˜\n    for (const [imageId, notes] of Object.entries(this.bulkNoteData.imageNotes)) {\n      // ä»imageIdæ¨æ–­plantId (æ ¼å¼: plantId_viewAngle_imageName)\n      const plantId = imageId.split('_')[0];\n      const cacheKey = `image_${plantId}_${imageId}`;\n      this.setCache(cacheKey, notes);\n    }\n  }\n\n  /**\n   * è·å–å¿«é€Ÿç¬”è®°ç»Ÿè®¡ï¼ˆç”¨äºBadgeæ›´æ–°ï¼‰\n   */\n  async getQuickNoteStats() {\n    console.log('[NoteManager] è·å–å¿«é€Ÿç¬”è®°ç»Ÿè®¡...');\n    \n    try {\n      const bulkData = await this.getAllNotesInBulk();\n      \n      if (!bulkData) {\n        console.warn('[NoteManager] æ‰¹é‡APIä¸å¯ç”¨ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼');\n        return null;\n      }\n      \n      const stats = {};\n      \n      // è®¡ç®—æ¯ä¸ªæ¤ç‰©çš„ç¬”è®°æ€»æ•°\n      for (const [plantId, plantNotes] of Object.entries(bulkData.plantNotes)) {\n        const plantNotesCount = plantNotes.length;\n        let imageNotesCount = 0;\n        \n        // ç»Ÿè®¡è¯¥æ¤ç‰©æ‰€æœ‰å›¾åƒçš„ç¬”è®°æ•°\n        for (const [imageId, imageNotes] of Object.entries(bulkData.imageNotes)) {\n          if (imageId.startsWith(plantId + '_')) {\n            imageNotesCount += imageNotes.length;\n          }\n        }\n        \n        stats[plantId] = {\n          plantNotes: plantNotesCount,\n          imageNotes: imageNotesCount,\n          total: plantNotesCount + imageNotesCount\n        };\n      }\n      \n      console.log(`[NoteManager] å¿«é€Ÿç»Ÿè®¡å®Œæˆ: ${Object.keys(stats).length} ä¸ªæ¤ç‰©`);\n      return stats;\n    } catch (error) {\n      console.error('[NoteManager] è·å–å¿«é€Ÿç¬”è®°ç»Ÿè®¡å¤±è´¥:', error);\n      return null;\n    }\n  }\n\n  /**\n   * è·å–æ€§èƒ½æŒ‡æ ‡\n   */\n  getPerformanceMetrics() {\n    return {\n      ...this.performanceMetrics,\n      cacheSize: this.notes.size,\n      hasBulkData: !!this.bulkNoteData,\n      bulkDataAge: this.bulkDataTimestamp ? Date.now() - this.bulkDataTimestamp : null,\n      averageRequestTime: this.performanceMetrics.requestCount > 0 \n        ? this.performanceMetrics.networkTime / this.performanceMetrics.requestCount \n        : 0\n    };\n  }\n\n  /**\n   * é‡ç½®æ€§èƒ½æŒ‡æ ‡\n   */\n  resetPerformanceMetrics() {\n    this.performanceMetrics = {\n      requestCount: 0,\n      bulkRequestCount: 0,\n      cacheHits: 0,\n      networkTime: 0\n    };\n  }\n\n  /**\n   * å¼ºåˆ¶åˆ·æ–°æ‰¹é‡æ•°æ®\n   */\n  async refreshBulkData() {\n    console.log('[NoteManager] å¼ºåˆ¶åˆ·æ–°æ‰¹é‡æ•°æ®...');\n    this.bulkNoteData = null;\n    this.bulkDataTimestamp = 0;\n    return await this.getAllNotesInBulk();\n  }\n\n  /**\n   * æ¸…ç†è¿‡æœŸç¼“å­˜\n   */\n  cleanupExpiredCache() {\n    const now = Date.now();\n    const expiredKeys = [];\n    \n    for (const [key, timestamp] of this.cacheTimestamps) {\n      if (now - timestamp > this.cacheExpiration) {\n        expiredKeys.push(key);\n      }\n    }\n    \n    expiredKeys.forEach(key => {\n      this.notes.delete(key);\n      this.cacheTimestamps.delete(key);\n    });\n    \n    // æ¸…ç†è¿‡æœŸçš„æ‰¹é‡æ•°æ®\n    if (this.isBulkDataExpired()) {\n      this.bulkNoteData = null;\n      this.bulkDataTimestamp = 0;\n    }\n    \n    if (expiredKeys.length > 0) {\n      console.log(`æ¸…ç†äº† ${expiredKeys.length} ä¸ªè¿‡æœŸç¼“å­˜`);\n    }\n  }\n}","/**\n * Note System UI Component\n * \n * Features:\n * - Note modal dialogs\n * - Note list display\n * - Note editor\n * - Note search\n */\n\nexport class NoteUI {\n  constructor(noteManager) {\n    this.noteManager = noteManager;\n    this.currentPlantId = null;\n    this.currentImageId = null;\n    this.currentNote = null;\n    this.isEditMode = false;\n    \n    this.initializeUI();\n  }\n\n  /**\n   * Initialize UI components\n   */\n  initializeUI() {\n    // Delay initialization of all UI components to ensure DOM is fully loaded\n    setTimeout(() => {\n      this.createNoteModal();\n      this.createNoteListModal();\n      this.setupEventListeners();\n      this.createNoteButtons();\n      this.injectNoteStyles(); // ğŸ”§ FIX: Add styles for separated note display\n      console.log('[NoteUI] UI initialization completed with note separation styles');\n      \n      // Initialize plant note badges after a short delay\n      setTimeout(() => {\n        this.updateAllPlantNoteBadges();\n      }, 500);\n      \n      // ADDITIONAL SAFETY: Update badges again after a longer delay to catch any timing issues\n      setTimeout(() => {\n        console.log('[NoteUI] Running additional badge update for safety');\n        this.updateAllPlantNoteBadges();\n      }, 2000);\n    }, 200);\n  }\n\n  /**\n   * Create note modal with improved styling\n   */\n  createNoteModal() {\n    console.log('[NoteUI] Creating note modal');\n    const modal = document.createElement('div');\n    modal.id = 'note-modal';\n    modal.className = 'modal';\n    modal.style.display = 'none'; // Ensure initial state is hidden\n    modal.innerHTML = `\n      <div class=\"modal-content note-modal-content\">\n        <div class=\"modal-header\">\n          <h2 id=\"note-modal-title\">Add Note</h2>\n          <button class=\"close-button\" id=\"note-modal-close\"></button>\n        </div>\n        <div class=\"modal-body\">\n          <div class=\"note-form\">\n            <div class=\"form-group\">\n              <label for=\"note-title\">Title <span class=\"required\">*</span></label>\n              <input type=\"text\" id=\"note-title\" maxlength=\"100\" required placeholder=\"Enter note title...\">\n              <div class=\"char-counter\">\n                <span id=\"note-title-count\">0</span>/100\n              </div>\n            </div>\n            \n            <div class=\"form-group\">\n              <label for=\"note-type\">Type</label>\n              <select id=\"note-type\">\n                <option value=\"general\">General Note</option>\n                <option value=\"observation\">Observation Record</option>\n                <option value=\"annotation\">Annotation Description</option>\n              </select>\n            </div>\n            \n            <div class=\"form-group\">\n              <label for=\"note-content\">Content <span class=\"required\">*</span></label>\n              <textarea id=\"note-content\" rows=\"6\" maxlength=\"5000\" required placeholder=\"Enter note content...\"></textarea>\n              <div class=\"char-counter\">\n                <span id=\"note-content-count\">0</span>/5000\n              </div>\n            </div>\n            \n            <div class=\"form-group\">\n              <label for=\"note-tags\">Tags</label>\n              <input type=\"text\" id=\"note-tags\" placeholder=\"Separate multiple tags with commas\">\n              <div class=\"form-help\">Example: observation, growth, issue</div>\n            </div>\n            \n            <div class=\"form-group\">\n              <label for=\"note-author\">Author</label>\n              <input type=\"text\" id=\"note-author\" value=\"User\" placeholder=\"Enter author name\">\n            </div>\n            \n            <!-- ğŸ”§ NEW: Backward Propagation Option -->\n            <div class=\"form-group\" id=\"backward-propagation-group\" style=\"display: none;\">\n              <div class=\"checkbox-wrapper\">\n                <label class=\"checkbox-label\">\n                  <input type=\"checkbox\" id=\"note-backward-propagation\">\n                  <span class=\"checkbox-text\">Backward Propagation</span>\n                </label>\n                <div class=\"form-help\">Apply this note to all later-dated images of the current plant</div>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class=\"modal-footer\">\n          <button class=\"btn btn-secondary\" id=\"note-cancel-btn\">Cancel</button>\n          <button class=\"btn btn-primary\" id=\"note-save-btn\">Save</button>\n        </div>\n      </div>\n    `;\n    \n    document.body.appendChild(modal);\n    console.log('[NoteUI] Note modal created and set to hidden');\n  }\n\n  /**\n   * Create note list modal with improved styling\n   */\n  createNoteListModal() {\n    console.log('[NoteUI] Creating note list modal');\n    const modal = document.createElement('div');\n    modal.id = 'note-list-modal';\n    modal.className = 'modal';\n    modal.style.display = 'none'; // Ensure initial state is hidden\n    modal.innerHTML = `\n      <div class=\"modal-content note-list-modal-content\">\n        <div class=\"modal-header\">\n          <h2 id=\"note-list-modal-title\">Note List</h2>\n          <button class=\"close-button\" id=\"note-list-modal-close\"></button>\n        </div>\n        <div class=\"modal-body\">\n          <div class=\"note-list-controls\">\n            <div class=\"search-group\">\n              <input type=\"text\" id=\"note-search\" placeholder=\"Search notes...\">\n              <button class=\"btn btn-sm btn-secondary\" id=\"note-search-btn\">Search</button>\n            </div>\n            <div class=\"filter-group\">\n              <select id=\"note-type-filter\">\n                <option value=\"\">All Types</option>\n                <option value=\"general\">General Note</option>\n                <option value=\"observation\">Observation Record</option>\n                <option value=\"annotation\">Annotation Description</option>\n              </select>\n              <button class=\"btn btn-sm btn-primary\" id=\"add-note-btn\">Add Note</button>\n            </div>\n          </div>\n          <div class=\"note-list-container\">\n            <div id=\"note-list-content\">\n              <div class=\"loading-message\">Loading...</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n    \n    document.body.appendChild(modal);\n    console.log('[NoteUI] Note list modal created and set to hidden');\n  }\n\n  /**\n   * Create note buttons\n   */\n  createNoteButtons() {\n    this.createPlantNoteButton();\n    this.createImageNoteButton();\n    // ğŸ”§ REMOVED: Note display areas no longer needed - counts shown in buttons\n  }\n\n  /**\n   * Create plant notes button in toolbar\n   */\n  createPlantNoteButton() {\n    // Find toolbar section\n    const toolbarSection = document.querySelector('.toolbar-section');\n    if (!toolbarSection) {\n      console.warn('[NoteUI] Toolbar section not found, creating fallback container');\n      this.createFallbackPlantNoteContainer();\n      return;\n    }\n    \n    // Remove existing button\n    const existingBtn = document.getElementById('plant-note-btn');\n    if (existingBtn) {\n      existingBtn.remove();\n    }\n    \n    // Create button container within toolbar\n    let noteContainer = toolbarSection.querySelector('.plant-notes-section');\n    if (!noteContainer) {\n      noteContainer = document.createElement('div');\n      noteContainer.className = 'plant-notes-section';\n      noteContainer.style.cssText = `\n        margin-top: 10px;\n        padding-top: 10px;\n        border-top: 1px solid var(--border-color);\n      `;\n      toolbarSection.appendChild(noteContainer);\n    }\n    \n    // Create the button with note count display\n    const noteBtn = document.createElement('button');\n    noteBtn.id = 'plant-note-btn';\n    noteBtn.className = 'btn btn-small btn-secondary';\n    noteBtn.innerHTML = 'ğŸ“ Plant Notes <span id=\"plant-note-count\" class=\"note-count-display\"></span>';\n    noteBtn.title = 'View or add plant notes';\n    noteBtn.style.cssText = `\n      display: none;\n      width: 100%;\n      margin-bottom: 5px;\n      position: relative;\n    `;\n    noteContainer.appendChild(noteBtn);\n    \n    console.log('[NoteUI] Plant notes button created in toolbar with count display');\n  }\n  \n  /**\n   * Create fallback container if toolbar not found\n   */\n  createFallbackPlantNoteContainer() {\n    const container = document.createElement('div');\n    container.className = 'plant-note-container';\n    container.style.cssText = `\n      position: fixed;\n      top: 80px;\n      right: 20px;\n      z-index: 1000;\n      background: rgba(255, 255, 255, 0.9);\n      padding: 10px;\n      border-radius: 8px;\n      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n      display: none;\n    `;\n    document.body.appendChild(container);\n    \n    const noteBtn = document.createElement('button');\n    noteBtn.id = 'plant-note-btn';\n    noteBtn.className = 'btn btn-info btn-sm note-btn';\n    noteBtn.innerHTML = 'ğŸ“ Plant Notes';\n    noteBtn.title = 'View or add plant notes';\n    noteBtn.style.display = 'none';\n    container.appendChild(noteBtn);\n  }\n\n  /**\n   * Create image notes button in annotation controls\n   */\n  createImageNoteButton() {\n    console.log('[NoteUI] Creating image notes button');\n    \n    // Find annotation controls container\n    const annotationControls = document.querySelector('.annotation-controls');\n    if (!annotationControls) {\n      console.warn('[NoteUI] Annotation controls not found, creating fallback container');\n      this.createFallbackImageNoteContainer();\n      return;\n    }\n    \n    // Remove existing button\n    const existingBtn = document.getElementById('image-note-btn');\n    if (existingBtn) {\n      existingBtn.remove();\n    }\n    \n    // Create the icon button to match annotation controls style with count display\n    const noteBtn = document.createElement('button');\n    noteBtn.id = 'image-note-btn';\n    noteBtn.className = 'btn btn-icon';\n    noteBtn.innerHTML = 'ğŸ“<span id=\"image-note-count\" class=\"note-count-overlay\"></span>';\n    noteBtn.title = 'View or add image notes';\n    noteBtn.style.cssText = `\n      display: none;\n      width: 32px;\n      height: 32px;\n      padding: 0;\n      font-size: 16px;\n      background-color: rgba(0, 0, 0, 0.7);\n      color: white;\n      border: none;\n      pointer-events: auto;\n      cursor: pointer;\n      border-radius: 0.375rem;\n      position: relative;\n    `;\n    \n    // Add to annotation controls\n    annotationControls.appendChild(noteBtn);\n    \n    console.log('[NoteUI] Image notes button created in annotation controls with count display');\n  }\n  \n  /**\n   * Create fallback container if annotation controls not found\n   */\n  createFallbackImageNoteContainer() {\n    const container = document.createElement('div');\n    container.className = 'image-note-container';\n    container.style.cssText = `\n      position: fixed;\n      top: 120px;\n      right: 20px;\n      z-index: 1000;\n      background: rgba(255, 255, 255, 0.9);\n      padding: 10px;\n      border-radius: 8px;\n      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n      display: none;\n    `;\n    document.body.appendChild(container);\n    \n    const noteBtn = document.createElement('button');\n    noteBtn.id = 'image-note-btn';\n    noteBtn.className = 'btn btn-info btn-sm note-btn';\n    noteBtn.innerHTML = 'ğŸ“';\n    noteBtn.title = 'View or add image notes';\n    noteBtn.style.cssText = `\n      display: none;\n      pointer-events: auto;\n      cursor: pointer;\n    `;\n    container.appendChild(noteBtn);\n  }\n\n  /**\n   * Setup event listeners\n   */\n  setupEventListeners() {\n    // Delay event listener setup to ensure DOM elements are created\n    setTimeout(() => {\n      this.setupModalEventListeners();\n      this.setupButtonEventListeners();\n      this.setupInputEventListeners();\n      // ğŸ”§ REMOVED: Note display event listeners no longer needed\n    }, 200);\n  }\n\n  /**\n   * Setup modal event listeners\n   */\n  setupModalEventListeners() {\n    // Note modal events\n    const noteModalClose = document.getElementById('note-modal-close');\n    if (noteModalClose) {\n      noteModalClose.addEventListener('click', () => {\n        this.closeNoteModal();\n      });\n    }\n\n    const noteCancelBtn = document.getElementById('note-cancel-btn');\n    if (noteCancelBtn) {\n      noteCancelBtn.addEventListener('click', () => {\n        this.closeNoteModal();\n      });\n    }\n\n    const noteSaveBtn = document.getElementById('note-save-btn');\n    if (noteSaveBtn) {\n      noteSaveBtn.addEventListener('click', () => {\n        this.saveNote();\n      });\n    }\n\n    // Note list modal events\n    const noteListModalClose = document.getElementById('note-list-modal-close');\n    if (noteListModalClose) {\n      noteListModalClose.addEventListener('click', () => {\n        this.closeNoteListModal();\n      });\n    }\n\n    const addNoteBtn = document.getElementById('add-note-btn');\n    if (addNoteBtn) {\n      addNoteBtn.addEventListener('click', () => {\n        this.closeNoteListModal();\n        this.showNoteModal();\n      });\n    }\n\n    const noteSearchBtn = document.getElementById('note-search-btn');\n    if (noteSearchBtn) {\n      noteSearchBtn.addEventListener('click', () => {\n        this.searchNotes();\n      });\n    }\n\n    const noteSearch = document.getElementById('note-search');\n    if (noteSearch) {\n      noteSearch.addEventListener('keypress', (e) => {\n        if (e.key === 'Enter') {\n          this.searchNotes();\n        }\n      });\n    }\n\n    // Close modal when clicking outside\n    document.addEventListener('click', (e) => {\n      if (e.target.id === 'note-modal') {\n        this.closeNoteModal();\n      }\n      if (e.target.id === 'note-list-modal') {\n        this.closeNoteListModal();\n      }\n    });\n  }\n\n  /**\n   * Setup button event listeners\n   */\n  setupButtonEventListeners() {\n    // Plant notes button\n    const plantNoteBtn = document.getElementById('plant-note-btn');\n    if (plantNoteBtn) {\n      console.log('[NoteUI] Plant notes button found, binding events');\n      plantNoteBtn.addEventListener('click', (event) => {\n        console.log('[NoteUI] Plant notes button clicked');\n        event.preventDefault();\n        this.showPlantNotes();\n      });\n    } else {\n      console.warn('[NoteUI] Plant notes button not found');\n    }\n\n    // Image notes button\n    const imageNoteBtn = document.getElementById('image-note-btn');\n    if (imageNoteBtn) {\n      console.log('[NoteUI] Image notes button found, binding events');\n      imageNoteBtn.addEventListener('click', (event) => {\n        console.log('[NoteUI] Image notes button clicked');\n        event.preventDefault();\n        this.showImageNotes();\n      });\n    } else {\n      console.warn('[NoteUI] Image notes button not found');\n    }\n  }\n\n  /**\n   * Setup input field event listeners\n   */\n  setupInputEventListeners() {\n    // Character counter\n    const noteTitle = document.getElementById('note-title');\n    if (noteTitle) {\n      noteTitle.addEventListener('input', () => {\n        this.updateCharCounter('note-title', 'note-title-count', 100);\n      });\n    }\n\n    const noteContent = document.getElementById('note-content');\n    if (noteContent) {\n      noteContent.addEventListener('input', () => {\n        this.updateCharCounter('note-content', 'note-content-count', 5000);\n      });\n    }\n  }\n\n  /**\n   * Show plant notes\n   */\n  async showPlantNotes() {\n    console.log('[NoteUI] showPlantNotes called');\n    if (!this.currentPlantId) {\n      console.warn('[NoteUI] No plant selected, cannot show plant notes');\n      this.showUserError('Please select a plant', 'You need to select a plant to view notes');\n      return;\n    }\n\n    // ğŸ”§ FIX: ç¡®ä¿åœ¨æ˜¾ç¤ºæ¤ç‰©ç¬”è®°æ—¶æ¸…é™¤å›¾åƒIDï¼Œé˜²æ­¢è¯¯åˆ›å»ºå›¾åƒç¬”è®°\n    this.currentImageId = null;\n    console.log('[NoteUI] Cleared currentImageId to ensure plant notes creation');\n    \n    document.getElementById('note-list-modal-title').textContent = `Plant Notes - ${this.currentPlantId}`;\n    \n    const modal = document.getElementById('note-list-modal');\n    if (modal) {\n      console.log('[NoteUI] Showing plant notes modal');\n      modal.style.display = 'flex';\n    }\n    \n    try {\n      await this.loadNoteList();\n    } catch (error) {\n      console.error('[NoteUI] Failed to load plant notes:', error);\n      this.showUserError('Failed to load notes', error.message);\n    }\n  }\n\n  /**\n   * Show image notes\n   */\n  async showImageNotes() {\n    console.log('[NoteUI] showImageNotes called');\n    console.log(`[NoteUI] Current state - plantId: ${this.currentPlantId}, imageId: ${this.currentImageId}`);\n    \n    // Also check the global app state as a fallback\n    const globalAppState = window.PlantAnnotationTool?.appState;\n    const fallbackPlantId = globalAppState?.currentPlant?.id;\n    const fallbackImageId = globalAppState?.currentImage?.id;\n    \n    console.log(`[NoteUI] Fallback state - plantId: ${fallbackPlantId}, imageId: ${fallbackImageId}`);\n    \n    const effectivePlantId = this.currentPlantId || fallbackPlantId;\n    const effectiveImageId = this.currentImageId || fallbackImageId;\n    \n    if (!effectivePlantId || !effectiveImageId) {\n      console.warn('[NoteUI] No plant or image selected, cannot show image notes');\n      this.showUserError('Please select plant and image', 'You need to select both plant and image to view image notes');\n      return;\n    }\n    \n    // Update current state if we used fallback values\n    if (!this.currentPlantId && fallbackPlantId) {\n      this.currentPlantId = fallbackPlantId;\n    }\n    if (!this.currentImageId && fallbackImageId) {\n      this.currentImageId = fallbackImageId;\n    }\n\n    document.getElementById('note-list-modal-title').textContent = `Image Notes - ${effectiveImageId}`;\n    \n    const modal = document.getElementById('note-list-modal');\n    if (modal) {\n      console.log('[NoteUI] Showing image notes modal');\n      modal.style.display = 'flex';\n    }\n    \n    try {\n      await this.loadNoteList();\n    } catch (error) {\n      console.error('[NoteUI] Failed to load image notes:', error);\n      this.showUserError('Failed to load notes', error.message);\n    }\n  }\n\n  /**\n   * Load note list (unified to show ALL notes for plant, consistent with search)\n   */\n  async loadNoteList() {\n    const listContainer = document.getElementById('note-list-content');\n    listContainer.innerHTML = '<div class=\"loading-message\">Loading...</div>';\n\n    try {\n      let notes;\n      if (this.currentImageId) {\n        // For image notes, get specific image notes\n        notes = await this.noteManager.getImageNotes(this.currentPlantId, this.currentImageId);\n        console.log(`[NoteUI] Loaded ${notes.length} image notes for ${this.currentImageId}`);\n      } else {\n        // ğŸ”§ FIX: For plant modal initial load, show ONLY plant-level notes\n        // Search function will show all notes when user explicitly searches\n        console.log(`[NoteUI] Loading plant-level notes only for ${this.currentPlantId}`);\n        notes = await this.noteManager.getPlantNotes(this.currentPlantId);\n        console.log(`[NoteUI] Plant API loaded ${notes.length} plant-only notes for ${this.currentPlantId}`);\n      }\n\n      this.renderNoteList(notes);\n      console.log(`[NoteUI] Modal refreshed with ${notes.length} notes`);\n    } catch (error) {\n      console.error('Failed to load note list:', error);\n      listContainer.innerHTML = `<div class=\"error-message\">Loading failed: ${error.message}</div>`;\n    }\n  }\n\n  /**\n   * Render note list with proper plant/image note separation\n   */\n  renderNoteList(notes) {\n    const listContainer = document.getElementById('note-list-content');\n    \n    if (!notes || notes.length === 0) {\n      listContainer.innerHTML = '<div class=\"empty-message\">No notes available</div>';\n      return;\n    }\n\n    // ğŸ”§ FIX: Separate plant-level notes from image-level notes\n    const plantNotes = notes.filter(note => !note.imageId);\n    const imageNotes = notes.filter(note => note.imageId);\n    \n    console.log(`[NoteUI] Rendering ${plantNotes.length} plant notes and ${imageNotes.length} image notes`);\n\n    let html = '';\n    \n    // Render plant-level notes section\n    if (plantNotes.length > 0) {\n      html += `\n        <div class=\"notes-section\">\n          <div class=\"section-header\">\n            <h3 class=\"section-title\">\n              <span class=\"section-icon\">ğŸ“</span>\n              Plant Notes (${plantNotes.length})\n            </h3>\n          </div>\n          <div class=\"notes-list\">\n            ${this.renderNoteItems(plantNotes, 'plant')}\n          </div>\n        </div>\n      `;\n    }\n    \n    // Render image-level notes section\n    if (imageNotes.length > 0) {\n      html += `\n        <div class=\"notes-section\">\n          <div class=\"section-header\">\n            <h3 class=\"section-title\">\n              <span class=\"section-icon\">ğŸ–¼ï¸</span>\n              Image Notes (${imageNotes.length})\n            </h3>\n          </div>\n          <div class=\"notes-list\">\n            ${this.renderNoteItems(imageNotes, 'image')}\n          </div>\n        </div>\n      `;\n    }\n\n    listContainer.innerHTML = html;\n\n    // Bind edit and delete events\n    this.bindNoteActionEvents(listContainer);\n  }\n\n  /**\n   * Helper method to render note items with proper type indicators\n   */\n  renderNoteItems(notes, noteScope) {\n    return notes.map(note => {\n      const formattedNote = this.noteManager.formatNoteForDisplay(note);\n      \n      // ğŸ”§ FIX: Add visual indicators and image info for different note types\n      let scopeIndicator = '';\n      let imageInfo = '';\n      \n      if (noteScope === 'plant') {\n        scopeIndicator = '<span class=\"note-scope plant-scope\">ğŸ“ Plant</span>';\n      } else if (noteScope === 'image') {\n        scopeIndicator = '<span class=\"note-scope image-scope\">ğŸ–¼ï¸ Image</span>';\n        // Extract image name from imageId for display\n        const imageName = note.imageId ? note.imageId.split('_').slice(-1)[0] : 'Unknown';\n        imageInfo = `<div class=\"image-info\">ğŸ“· Image: ${this.escapeHtml(imageName)}</div>`;\n      }\n      \n      return `\n        <div class=\"note-item ${noteScope}-note\" data-note-id=\"${note.noteId}\">\n          <div class=\"note-item-header\">\n            <h4 class=\"note-title\">${this.escapeHtml(formattedNote.title)}</h4>\n            <div class=\"note-actions\">\n              <button class=\"btn btn-sm btn-secondary edit-note-btn\" data-note-id=\"${note.noteId}\">Edit</button>\n              <button class=\"btn btn-sm btn-danger delete-note-btn\" data-note-id=\"${note.noteId}\">Delete</button>\n            </div>\n          </div>\n          <div class=\"note-item-meta\">\n            ${scopeIndicator}\n            <span class=\"note-type note-type-${note.noteType}\">${this.getNoteTypeText(note.noteType)}</span>\n            <span class=\"note-timestamp\">${formattedNote.formattedTimestamp}</span>\n            <span class=\"note-author\">Author: ${this.escapeHtml(note.author)}</span>\n          </div>\n          ${imageInfo}\n          <div class=\"note-content\">\n            ${this.escapeHtml(formattedNote.shortContent)}\n          </div>\n          ${note.tags.length > 0 ? `\n            <div class=\"note-tags\">\n              ${note.tags.map(tag => `<span class=\"tag\">${this.escapeHtml(tag)}</span>`).join('')}\n            </div>\n          ` : ''}\n        </div>\n      `;\n    }).join('');\n  }\n\n  /**\n   * Helper method to bind note action events\n   */\n  bindNoteActionEvents(container) {\n    container.querySelectorAll('.edit-note-btn').forEach(btn => {\n      btn.addEventListener('click', (e) => {\n        const noteId = e.target.dataset.noteId;\n        this.editNote(noteId);\n      });\n    });\n\n    container.querySelectorAll('.delete-note-btn').forEach(btn => {\n      btn.addEventListener('click', (e) => {\n        const noteId = e.target.dataset.noteId;\n        this.deleteNote(noteId);\n      });\n    });\n  }\n\n  /**\n   * Inject CSS styles for separated note display\n   */\n  injectNoteStyles() {\n    const styleId = 'note-separation-styles';\n    if (document.getElementById(styleId)) return; // Already injected\n\n    const style = document.createElement('style');\n    style.id = styleId;\n    style.textContent = `\n      /* Note section separation styles */\n      .notes-section {\n        margin-bottom: 20px;\n        border: 1px solid #e5e7eb;\n        border-radius: 8px;\n        overflow: hidden;\n      }\n      \n      .section-header {\n        background: #f9fafb;\n        padding: 12px 16px;\n        border-bottom: 1px solid #e5e7eb;\n      }\n      \n      .section-title {\n        margin: 0;\n        font-size: 16px;\n        font-weight: 600;\n        color: #374151;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n      \n      .section-icon {\n        font-size: 18px;\n      }\n      \n      .notes-list {\n        background: white;\n      }\n      \n      /* Note scope indicators */\n      .note-scope {\n        display: inline-flex;\n        align-items: center;\n        gap: 4px;\n        padding: 2px 8px;\n        border-radius: 12px;\n        font-size: 12px;\n        font-weight: 500;\n        margin-right: 8px;\n      }\n      \n      .plant-scope {\n        background: #dcfce7;\n        color: #166534;\n      }\n      \n      .image-scope {\n        background: #dbeafe;\n        color: #1d4ed8;\n      }\n      \n      /* Image info display */\n      .image-info {\n        background: #f0f9ff;\n        border: 1px solid #bae6fd;\n        border-radius: 4px;\n        padding: 6px 10px;\n        margin: 8px 0;\n        font-size: 13px;\n        color: #0c4a6e;\n      }\n      \n      /* Note item styling for different types */\n      .plant-note {\n        border-left: 4px solid #22c55e;\n      }\n      \n      .image-note {\n        border-left: 4px solid #3b82f6;\n      }\n      \n      /* Enhance existing note item spacing */\n      .note-item {\n        margin-bottom: 0;\n        border-bottom: 1px solid #f3f4f6;\n      }\n      \n      .note-item:last-child {\n        border-bottom: none;\n      }\n      \n      /* Backward propagation checkbox styling */\n      .checkbox-wrapper {\n        margin: 15px 0;\n      }\n      \n      .checkbox-label {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        cursor: pointer;\n        font-weight: 500;\n        color: #374151;\n      }\n      \n      .checkbox-label input[type=\"checkbox\"] {\n        margin: 0;\n        padding: 0;\n        transform: scale(1.1);\n        accent-color: #3b82f6;\n      }\n      \n      .checkbox-text {\n        user-select: none;\n      }\n      \n      #backward-propagation-group .form-help {\n        margin-top: 5px;\n        font-size: 12px;\n        color: #6b7280;\n        font-style: italic;\n      }\n    `;\n    \n    document.head.appendChild(style);\n    console.log('[NoteUI] Injected separation styles for plant/image notes');\n  }\n\n  /**\n   * Display note edit modal\n   */\n  showNoteModal(note = null) {\n    console.log('[NoteUI] showNoteModal called, note:', note);\n    this.currentNote = note;\n    this.isEditMode = !!note;\n\n    const modal = document.getElementById('note-modal');\n    const title = document.getElementById('note-modal-title');\n    const backwardPropagationGroup = document.getElementById('backward-propagation-group');\n    \n    if (!modal || !title) {\n      console.error('[NoteUI] Note modal elements not found');\n      return;\n    }\n    \n    title.textContent = this.isEditMode ? 'Edit Note' : 'Add Note';\n    \n    // ğŸ”§ NEW: Show backward propagation option only for new image notes\n    const isNewImageNote = !this.isEditMode && this.currentImageId;\n    if (backwardPropagationGroup) {\n      backwardPropagationGroup.style.display = isNewImageNote ? 'block' : 'none';\n      // Reset checkbox when showing modal\n      const checkbox = document.getElementById('note-backward-propagation');\n      if (checkbox) {\n        checkbox.checked = false;\n      }\n    }\n    \n    if (note) {\n      document.getElementById('note-title').value = note.title;\n      document.getElementById('note-type').value = note.noteType;\n      document.getElementById('note-content').value = note.content;\n      document.getElementById('note-tags').value = note.tags.join(', ');\n      document.getElementById('note-author').value = note.author;\n    } else {\n      document.getElementById('note-title').value = '';\n      document.getElementById('note-type').value = 'general';\n      document.getElementById('note-content').value = '';\n      document.getElementById('note-tags').value = '';\n      document.getElementById('note-author').value = 'User';\n    }\n\n    this.updateCharCounter('note-title', 'note-title-count', 100);\n    this.updateCharCounter('note-content', 'note-content-count', 5000);\n\n    console.log('[NoteUI] Showing note edit modal');\n    modal.style.display = 'flex';\n    \n    const titleInput = document.getElementById('note-title');\n    if (titleInput) {\n      titleInput.focus();\n    }\n  }\n\n  /**\n   * Close note modal\n   */\n  closeNoteModal() {\n    document.getElementById('note-modal').style.display = 'none';\n    this.currentNote = null;\n    this.isEditMode = false;\n  }\n\n  /**\n   * Close note list modal\n   */\n  closeNoteListModal() {\n    document.getElementById('note-list-modal').style.display = 'none';\n  }\n\n  /**\n   * Get later-dated images for backward propagation\n   */\n  async getLaterDatedImages(plantId, currentImageId) {\n    try {\n      console.log(`[NoteUI] Finding later-dated images for ${plantId}, current: ${currentImageId}`);\n      \n      // Get all images for the current plant and view angle\n      const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n      if (!plantDataManager) {\n        throw new Error('PlantDataManager not available');\n      }\n      \n      // Get current plant information\n      const currentPlant = plantDataManager.plants?.get(plantId);\n      if (!currentPlant || !currentPlant.selectedViewAngle) {\n        throw new Error('Current plant or view angle not found');\n      }\n      \n      // Get all images for the current view angle\n      const images = await plantDataManager.getPlantImages(plantId, currentPlant.selectedViewAngle);\n      if (!images || images.length === 0) {\n        return [];\n      }\n      \n      // Find the current image index\n      const currentImageIndex = images.findIndex(img => img.id === currentImageId);\n      if (currentImageIndex === -1) {\n        throw new Error('Current image not found in plant images');\n      }\n      \n      // Get all images after the current one (later in time)\n      const laterImages = images.slice(currentImageIndex + 1);\n      \n      console.log(`[NoteUI] Found ${laterImages.length} later-dated images for backward propagation`);\n      return laterImages;\n      \n    } catch (error) {\n      console.error('[NoteUI] Error finding later-dated images:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Apply note to multiple images (backward propagation)\n   */\n  async applyNoteToMultipleImages(plantId, noteData, targetImages) {\n    const results = {\n      success: [],\n      failed: []\n    };\n    \n    console.log(`[NoteUI] Applying note to ${targetImages.length} images via backward propagation`);\n    \n    for (const image of targetImages) {\n      try {\n        await this.noteManager.addImageNote(plantId, image.id, noteData);\n        results.success.push(image.id);\n        console.log(`[NoteUI] Note successfully applied to ${image.id}`);\n      } catch (error) {\n        console.error(`[NoteUI] Failed to apply note to ${image.id}:`, error);\n        results.failed.push({ imageId: image.id, error: error.message });\n      }\n    }\n    \n    console.log(`[NoteUI] Backward propagation completed: ${results.success.length} success, ${results.failed.length} failed`);\n    return results;\n  }\n\n  /**\n   * Save note\n   */\n  async saveNote() {\n    const title = document.getElementById('note-title').value.trim();\n    const content = document.getElementById('note-content').value.trim();\n    const noteType = document.getElementById('note-type').value;\n    const tags = document.getElementById('note-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);\n    const author = document.getElementById('note-author').value.trim();\n    \n    // ğŸ”§ NEW: Check backward propagation setting\n    const backwardPropagationCheckbox = document.getElementById('note-backward-propagation');\n    const enableBackwardPropagation = backwardPropagationCheckbox && backwardPropagationCheckbox.checked;\n\n    const noteData = {\n      title,\n      content,\n      noteType,\n      tags,\n      author\n    };\n\n    const validation = this.noteManager.validateNoteData(noteData);\n    if (!validation.isValid) {\n      alert('Input error:\\\\n' + validation.errors.join('\\\\n'));\n      return;\n    }\n\n    try {\n      if (this.isEditMode && this.currentNote) {\n        console.log(`[NoteUI] Updating note: ${this.currentNote.noteId}`);\n        await this.noteManager.updateNote(this.currentNote.noteId, noteData);\n        console.log('[NoteUI] Note updated successfully');\n      } else {\n        console.log('[NoteUI] Creating new note...');\n        if (this.currentImageId) {\n          console.log(`[NoteUI] Creating image note for ${this.currentPlantId}/${this.currentImageId}`);\n          \n          // Add note to current image\n          await this.noteManager.addImageNote(this.currentPlantId, this.currentImageId, noteData);\n          \n          // ğŸ”§ NEW: Handle backward propagation\n          if (enableBackwardPropagation) {\n            console.log('[NoteUI] Backward propagation enabled, finding later-dated images...');\n            \n            const laterImages = await this.getLaterDatedImages(this.currentPlantId, this.currentImageId);\n            if (laterImages.length > 0) {\n              console.log(`[NoteUI] Applying note to ${laterImages.length} later-dated images`);\n              const propagationResults = await this.applyNoteToMultipleImages(this.currentPlantId, noteData, laterImages);\n              \n              // Show propagation results\n              if (propagationResults.success.length > 0) {\n                console.log(`[NoteUI] Backward propagation successful: ${propagationResults.success.length} images updated`);\n              }\n              if (propagationResults.failed.length > 0) {\n                console.warn(`[NoteUI] Backward propagation partial failure: ${propagationResults.failed.length} images failed`);\n              }\n            } else {\n              console.log('[NoteUI] No later-dated images found for backward propagation');\n            }\n          }\n          \n        } else {\n          console.log(`[NoteUI] Creating plant note for ${this.currentPlantId}`);\n          await this.noteManager.addPlantNote(this.currentPlantId, noteData);\n        }\n        console.log('[NoteUI] Note created successfully');\n      }\n\n      this.closeNoteModal();\n      \n      // ğŸ”§ FIX: Add small delay to ensure backend processing completes\n      await new Promise(resolve => setTimeout(resolve, 100));\n      \n      // ğŸ”§ FIX: Force immediate cache clear to ensure fresh data\n      console.log('[NoteUI] Note saved, forcing complete cache clear for fresh data...');\n      if (this.noteManager.clearCache) {\n        this.noteManager.clearCache();\n        console.log('[NoteUI] Note manager cache completely cleared');\n      }\n      \n      // ğŸ”§ FIX: Force refresh bulk data to ensure real-time accuracy\n      if (this.noteManager.refreshBulkData) {\n        try {\n          await this.noteManager.refreshBulkData();\n          console.log('[NoteUI] Bulk data forcefully refreshed for immediate sync');\n        } catch (refreshError) {\n          console.warn('[NoteUI] Bulk data refresh failed, cache cleared anyway:', refreshError);\n        }\n      }\n      \n      // ğŸ”§ FIX: Always refresh the note list modal regardless of visibility to show new note\n      const listModal = document.getElementById('note-list-modal');\n      if (listModal && listModal.style.display !== 'none') {\n        console.log('[NoteUI] Refreshing note list to show new/updated note');\n        await this.loadNoteList();\n        console.log('[NoteUI] Note list refreshed with fresh data');\n      }\n\n      // ğŸ”§ FIX: ç«‹å³åˆ·æ–°æ¤ç‰©ç¬”è®°å¾½ç« å’Œå›¾åƒç¬”è®°å¾½ç« ï¼Œä»¥åŠæŒ‰é’®è®¡æ•°\n      if (this.currentPlantId) {\n        console.log('[NoteUI] ç¬”è®°ä¿å­˜å®Œæˆï¼Œç«‹å³åˆ·æ–°å¾½ç« å’ŒæŒ‰é’®...');\n        \n        // ğŸ”§ FIX: Force real-time badge updates with fresh data (bypassing stale cache)\n        console.log('[NoteUI] Forcing immediate badge refresh with fresh data...');\n        \n        // Wait a bit longer for backend sync\n        await new Promise(resolve => setTimeout(resolve, 200));\n        \n        // ç«‹å³åˆ·æ–°æ¤ç‰©ç¬”è®°å¾½ç« å’ŒæŒ‰é’®\n        await this.updatePlantNoteBadge(this.currentPlantId);\n        await this.updatePlantNoteButton(this.currentPlantId);\n        \n        // å¦‚æœæ˜¯å›¾åƒç¬”è®°ï¼Œä½¿ç”¨ç›´æ¥APIè°ƒç”¨åˆ·æ–°å¾½ç« é¿å…ç¼“å­˜å†²çª\n        if (this.currentImageId) {\n          // âœ… CONSISTENCY: Use direct API call for save operations too\n          await this.directUpdateThumbnailBadge(this.currentPlantId, this.currentImageId);\n          // ğŸ”§ FIX: Also update the image note button count overlay\n          await this.updateImageNoteButton(this.currentPlantId, this.currentImageId);\n          console.log('[NoteUI] âœ… å›¾åƒç¬”è®°å¾½ç« å’ŒæŒ‰é’®è®¡æ•°é€šè¿‡ç›´æ¥APIåˆ·æ–°å®Œæˆ');\n          \n          // ğŸ”§ NEW: Update badges for all affected images if backward propagation was used\n          if (enableBackwardPropagation) {\n            console.log('[NoteUI] Refreshing badges for all images affected by backward propagation...');\n            const laterImages = await this.getLaterDatedImages(this.currentPlantId, this.currentImageId);\n            for (const image of laterImages) {\n              await this.directUpdateThumbnailBadge(this.currentPlantId, image.id);\n            }\n            console.log(`[NoteUI] Updated badges for ${laterImages.length} propagated images`);\n          }\n        }\n        \n        console.log('[NoteUI] ç¬”è®°å¾½ç« å’ŒæŒ‰é’®åˆ·æ–°å®Œæˆ');\n      }\n\n    } catch (error) {\n      console.error('Save note failed:', error);\n      alert('Save failed: ' + error.message);\n    }\n  }\n\n  /**\n   * Edit note\n   */\n  async editNote(noteId) {\n    try {\n      const note = await this.noteManager.getNote(noteId);\n      if (note) {\n        this.closeNoteListModal();\n        this.showNoteModal(note);\n      }\n    } catch (error) {\n      console.error('Failed to get note:', error);\n      alert('Failed to get note: ' + error.message);\n    }\n  }\n\n  /**\n   * Delete note\n   */\n  async deleteNote(noteId) {\n    if (!confirm('Are you sure you want to delete this note?')) {\n      return;\n    }\n\n    try {\n      console.log(`[NoteUI] Attempting to delete note: ${noteId}`);\n      await this.noteManager.deleteNote(noteId);\n      console.log('[NoteUI] Note deletion successful');\n      \n      // ğŸ”§ FIX: Add small delay to ensure cache clearing completes\n      await new Promise(resolve => setTimeout(resolve, 100));\n      \n      // ğŸ”§ FIX: Force immediate cache clear and refresh for deletion\n      console.log('[NoteUI] Note deleted, forcing complete cache clear and refresh...');\n      \n      // Double-ensure cache is cleared\n      if (this.noteManager.clearCache) {\n        this.noteManager.clearCache();\n        console.log('[NoteUI] Note manager cache cleared after deletion');\n      }\n      \n      // ğŸ”§ FIX: Force refresh bulk data to ensure deletion is reflected immediately\n      if (this.noteManager.refreshBulkData) {\n        try {\n          await this.noteManager.refreshBulkData();\n          console.log('[NoteUI] Bulk data forcefully refreshed after deletion');\n        } catch (refreshError) {\n          console.warn('[NoteUI] Bulk data refresh failed after deletion, cache cleared anyway:', refreshError);\n        }\n      }\n      \n      // Immediately refresh note list in modal with fresh data\n      await this.loadNoteList();\n      console.log('[NoteUI] Note list refreshed after deletion');\n      \n      // ğŸ”§ FIX: Streamlined badge refresh after deletion - direct API only\n      if (this.currentPlantId) {\n        console.log('[NoteUI] Refreshing badges after note deletion using direct API calls...');\n        \n        // Force refresh plant note badge and button with bypassed cache\n        await this.updatePlantNoteBadge(this.currentPlantId);\n        await this.updatePlantNoteButton(this.currentPlantId);\n        \n        // If there's a current image, use ONLY direct API call to avoid cache conflicts\n        if (this.currentImageId) {\n          // âœ… SOLUTION: Skip cache-dependent methods, use direct API call exclusively\n          await this.directUpdateThumbnailBadge(this.currentPlantId, this.currentImageId);\n          // ğŸ”§ FIX: Also update the image note button count overlay\n          await this.updateImageNoteButton(this.currentPlantId, this.currentImageId);\n          console.log('[NoteUI] âœ… Image note badge and button updated via direct API after deletion');\n        }\n        \n        console.log('[NoteUI] All badges refreshed after deletion');\n      }\n    } catch (error) {\n      console.error('Delete note failed:', error);\n      \n      // ğŸ”§ FIX: Improved error handling for different error types\n      let errorMessage = 'Delete failed: ';\n      if (error.message.includes('404') || error.message.includes('ä¸å­˜åœ¨')) {\n        errorMessage += 'Note was already deleted or does not exist.';\n        // Still refresh the modal to show current state\n        console.log('[NoteUI] Note already deleted, refreshing modal to show current state...');\n        if (this.noteManager.clearCache) {\n          this.noteManager.clearCache();\n        }\n        await this.loadNoteList();\n        if (this.currentPlantId) {\n          await this.updatePlantNoteBadge(this.currentPlantId);\n          // ğŸ”§ FIX: Also use direct API for error recovery to maintain consistency\n          if (this.currentImageId) {\n            await this.directUpdateThumbnailBadge(this.currentPlantId, this.currentImageId);\n            // ğŸ”§ FIX: Also update the image note button count overlay in error recovery\n            await this.updateImageNoteButton(this.currentPlantId, this.currentImageId);\n          }\n        }\n      } else {\n        errorMessage += error.message;\n      }\n      \n      alert(errorMessage);\n    }\n  }\n\n  /**\n   * Search notes with proper scope based on current modal context\n   */\n  async searchNotes() {\n    const query = document.getElementById('note-search').value.trim();\n    const typeFilter = document.getElementById('note-type-filter').value;\n    \n    try {\n      let notes;\n      \n      if (this.currentImageId) {\n        // ğŸ”§ FIX: In Image Notes modal - search only image notes for this specific image\n        console.log(`[NoteUI] Searching image notes for ${this.currentImageId} with query:`, query);\n        const allImageNotes = await this.noteManager.getImageNotes(this.currentPlantId, this.currentImageId);\n        \n        // Filter by query and type if provided\n        notes = allImageNotes.filter(note => {\n          const matchesQuery = !query || \n            note.title.toLowerCase().includes(query.toLowerCase()) ||\n            note.content.toLowerCase().includes(query.toLowerCase()) ||\n            note.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()));\n          \n          const matchesType = !typeFilter || note.noteType === typeFilter;\n          \n          return matchesQuery && matchesType;\n        });\n        \n        console.log(`[NoteUI] Image note search completed: found ${notes.length} notes`);\n        \n      } else {\n        // ğŸ”§ FIX: In Plant Notes modal - search ONLY plant-level notes for consistency\n        console.log(`[NoteUI] Searching plant-level notes only for ${this.currentPlantId} with query:`, query);\n        const allPlantNotes = await this.noteManager.getPlantNotes(this.currentPlantId);\n        \n        // Filter by query and type if provided  \n        notes = allPlantNotes.filter(note => {\n          const matchesQuery = !query || \n            note.title.toLowerCase().includes(query.toLowerCase()) ||\n            note.content.toLowerCase().includes(query.toLowerCase()) ||\n            note.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()));\n          \n          const matchesType = !typeFilter || note.noteType === typeFilter;\n          \n          return matchesQuery && matchesType;\n        });\n        \n        console.log(`[NoteUI] Plant note search completed: found ${notes.length} plant-level notes (image notes excluded for consistency)`);\n      }\n      \n      this.renderNoteList(notes);\n      \n    } catch (error) {\n      console.error('Search notes failed:', error);\n      \n      let errorMessage = 'Search failed: ';\n      if (error.message.includes('404')) {\n        errorMessage += 'Notes not found or backend server unavailable.';\n      } else if (error.message.includes('500')) {\n        errorMessage += 'Server error occurred during search. Please try again.';\n      } else {\n        errorMessage += error.message;\n      }\n      \n      document.getElementById('note-list-content').innerHTML = `<div class=\"error-message\">${errorMessage}</div>`;\n    }\n  }\n\n  /**\n   * Update character counter\n   */\n  updateCharCounter(inputId, counterId, maxLength) {\n    const input = document.getElementById(inputId);\n    const counter = document.getElementById(counterId);\n    const currentLength = input.value.length;\n    \n    counter.textContent = currentLength;\n    \n    if (currentLength > maxLength * 0.9) {\n      counter.style.color = '#ff6b6b';\n    } else if (currentLength > maxLength * 0.8) {\n      counter.style.color = '#feca57';\n    } else {\n      counter.style.color = '#666';\n    }\n  }\n\n  /**\n   * Set current plant ID\n   */\n  setCurrentPlant(plantId) {\n    this.currentPlantId = plantId;\n    \n    // Show plant notes button and container\n    const plantNoteBtn = document.getElementById('plant-note-btn');\n    const plantNoteContainer = document.querySelector('.plant-notes-section, .plant-note-container');\n    \n    if (plantNoteBtn) {\n      plantNoteBtn.style.display = plantId ? 'block' : 'none';\n    }\n    \n    if (plantNoteContainer) {\n      plantNoteContainer.style.display = plantId ? 'block' : 'none';\n    }\n    \n    // Update plant note button count and badge\n    if (plantId) {\n      this.updatePlantNoteButton(plantId);\n      this.updatePlantNoteBadge(plantId);\n    } else {\n      this.updatePlantNoteButton(null);\n    }\n  }\n\n  /**\n   * Set current image ID\n   */\n  setCurrentImage(imageId) {\n    console.log(`[NoteUI] Setting current image ID: ${imageId}, current plant ID: ${this.currentPlantId}`);\n    this.currentImageId = imageId;\n    \n    // ğŸ”§ FIX: Always update image note button regardless of state\n    if (imageId && this.currentPlantId) {\n      // Ensure we have the current plant ID as well\n      if (!this.currentPlantId && window.PlantAnnotationTool?.appState?.currentPlant?.id) {\n        this.currentPlantId = window.PlantAnnotationTool.appState.currentPlant.id;\n        console.log(`[NoteUI] Auto-updated plant ID from global state: ${this.currentPlantId}`);\n      }\n      \n      // Update image note button and thumbnail badge\n      this.updateImageNoteButton(this.currentPlantId, imageId);\n      this.refreshThumbnailNoteBadge(this.currentPlantId, imageId);\n    } else {\n      // ğŸ”§ FIX: Clear image note button when no image is selected\n      this.updateImageNoteButton(null, null);\n      console.log('[NoteUI] Image note button cleared - no image selected');\n    }\n    \n    // Show image notes button and container\n    const imageNoteBtn = document.getElementById('image-note-btn');\n    const imageNoteContainer = document.querySelector('.annotation-controls, .image-note-container');\n    \n    console.log(`[NoteUI] Image note button exists: ${!!imageNoteBtn}, container exists: ${!!imageNoteContainer}`);\n    \n    if (imageNoteBtn) {\n      const shouldShow = this.currentPlantId && imageId;\n      console.log(`[NoteUI] Image note button should show: ${shouldShow}`);\n      imageNoteBtn.style.display = shouldShow ? 'block' : 'none';\n    }\n    \n    if (imageNoteContainer && imageNoteContainer.classList.contains('image-note-container')) {\n      const shouldShow = this.currentPlantId && imageId;\n      console.log(`[NoteUI] Image note container should show: ${shouldShow}`);\n      imageNoteContainer.style.display = shouldShow ? 'block' : 'none';\n    }\n  }\n\n  /**\n   * Update plant note button count display (ALL notes for this plant)\n   */\n  async updatePlantNoteButton(plantId) {\n    const plantNoteCountElement = document.getElementById('plant-note-count');\n    if (!plantNoteCountElement) return;\n    \n    if (!plantId) {\n      plantNoteCountElement.textContent = '';\n      return;\n    }\n    \n    try {\n      // ğŸ”§ FIX: Use bulk stats first for performance, then fallback to search API for accuracy\n      let totalCount = 0;\n      \n      // Try bulk stats first (fast)\n      const bulkStats = await this.noteManager.getQuickNoteStats();\n      if (bulkStats && bulkStats[plantId]) {\n        // ğŸ”§ FIX: Plant Notes button should ONLY show plant-level notes, not image notes\n        totalCount = bulkStats[plantId].plantNotes; // Only plant notes, not .total\n        console.log(`[NoteUI] Plant note button using bulk data: ${totalCount} plant-only notes`);\n        \n        // ğŸ”§ FIX: Validate plant-only count with plant API (not search API)\n        if (Math.random() < 0.1) { // 10% spot-check for validation\n          try {\n            const plantNotes = await this.noteManager.getPlantNotes(plantId);\n            const actualCount = plantNotes ? plantNotes.length : 0;\n            if (actualCount !== totalCount) {\n              console.warn(`[NoteUI] Plant button bulk data inconsistency! Bulk: ${totalCount}, Actual: ${actualCount}. Using actual...`);\n              totalCount = actualCount;\n            }\n          } catch (validationError) {\n            console.debug('[NoteUI] Plant button validation failed, continuing with bulk data:', validationError);\n          }\n        }\n      } else {\n        // Fallback to plant API (only plant-level notes, consistent with button purpose)\n        console.log(`[NoteUI] Plant note button fallback to plant API for ${plantId}`);\n        try {\n          const plantNotes = await this.noteManager.getPlantNotes(plantId);\n          totalCount = plantNotes ? plantNotes.length : 0;\n          console.log(`[NoteUI] Plant note button plant API found: ${totalCount} plant-only notes`);\n        } catch (plantError) {\n          console.warn(`[NoteUI] Plant API failed, final fallback to 0:`, plantError);\n          totalCount = 0;\n        }\n      }\n      \n      if (totalCount > 0) {\n        plantNoteCountElement.textContent = `(${totalCount})`;\n        plantNoteCountElement.style.cssText = `\n          color: #059669;\n          font-weight: bold;\n          margin-left: 5px;\n        `;\n      } else {\n        plantNoteCountElement.textContent = '';\n      }\n      \n      console.log(`[NoteUI] Plant note button updated: ${totalCount} total notes (plant + image)`);\n    } catch (error) {\n      console.error('Failed to update plant note button:', error);\n      plantNoteCountElement.textContent = '';\n    }\n  }\n\n  /**\n   * Update image note button count display\n   */\n  async updateImageNoteButton(plantId, imageId) {\n    const imageNoteCountElement = document.getElementById('image-note-count');\n    if (!imageNoteCountElement) return;\n    \n    if (!plantId || !imageId) {\n      imageNoteCountElement.textContent = '';\n      imageNoteCountElement.style.display = 'none';\n      return;\n    }\n    \n    try {\n      const notes = await this.noteManager.getImageNotes(plantId, imageId);\n      const count = notes ? notes.length : 0;\n      \n      if (count > 0) {\n        imageNoteCountElement.textContent = count;\n        imageNoteCountElement.style.cssText = `\n          position: absolute;\n          top: -5px;\n          right: -5px;\n          background: #dc2626;\n          color: white;\n          border-radius: 50%;\n          width: 16px;\n          height: 16px;\n          font-size: 10px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-weight: bold;\n        `;\n      } else {\n        imageNoteCountElement.textContent = '';\n        imageNoteCountElement.style.display = 'none';\n      }\n      \n      console.log(`[NoteUI] Image note button updated: ${count} notes`);\n    } catch (error) {\n      console.error('Failed to update image note button:', error);\n      imageNoteCountElement.textContent = '';\n      imageNoteCountElement.style.display = 'none';\n    }\n  }\n\n  /**\n   * Refresh thumbnail note badge for specific image\n   */\n  async refreshThumbnailNoteBadge(plantId, imageId) {\n    try {\n      // ğŸ”§ FIX: Force cache invalidation for this specific image before refresh\n      const cacheKey = `image_${plantId}_${imageId}`;\n      if (this.noteManager.notes && this.noteManager.notes.has(cacheKey)) {\n        this.noteManager.notes.delete(cacheKey);\n        console.log(`[NoteUI] Force cleared cache for ${cacheKey}`);\n      }\n      \n      // ğŸ”§ FIX: Also clear bulk data to ensure fresh load\n      if (this.noteManager.bulkNoteData) {\n        this.noteManager.bulkNoteData = null;\n        this.noteManager.bulkDataTimestamp = 0;\n        console.log(`[NoteUI] Force cleared bulk cache for thumbnail refresh`);\n      }\n      \n      // Call the global function to refresh thumbnail badge\n      if (typeof loadImageNoteCount === 'function') {\n        await loadImageNoteCount(plantId, imageId);\n        console.log(`[NoteUI] Thumbnail note badge refreshed for ${imageId}`);\n      } else {\n        console.warn('[NoteUI] loadImageNoteCount function not available');\n      }\n    } catch (error) {\n      console.error('Failed to refresh thumbnail note badge:', error);\n    }\n  }\n  async updatePlantNoteBadge(plantId) {\n    if (!plantId) return;\n    \n    console.log(`[NoteUI] updatePlantNoteBadge called for plant: ${plantId}`);\n    \n    try {\n      // Use bulk note stats for better performance\n      const bulkStats = await this.noteManager.getQuickNoteStats();\n      \n      if (bulkStats && bulkStats[plantId]) {\n        const stats = bulkStats[plantId];\n        const totalNotes = stats.total;\n        \n        console.log(`[NoteUI] Plant ${plantId} bulk stats: ${stats.plantNotes} plant + ${stats.imageNotes} image = ${totalNotes} total`);\n        \n        // ğŸ”§ FIX: Occasional validation to detect stale bulk data\n        if (Math.random() < 0.15) { // 15% validation rate for badges\n          try {\n            const validationResults = await this.noteManager.searchNotes('', { plantId: plantId });\n            const actualTotal = validationResults ? validationResults.length : 0;\n            if (actualTotal !== totalNotes) {\n              console.warn(`[NoteUI] Badge bulk data stale! Bulk: ${totalNotes}, Actual: ${actualTotal}. Using accurate data...`);\n              // Force refresh and use accurate data\n              if (this.noteManager.refreshBulkData) {\n                await this.noteManager.refreshBulkData();\n              }\n              // Fall through to individual method below\n            } else {\n              // Bulk data is accurate, proceed with badge update\n              this.updateBadgeWithStats(plantId, stats);\n              return;\n            }\n          } catch (validationError) {\n            console.debug('[NoteUI] Badge validation failed, using bulk data:', validationError);\n            // Continue with bulk data despite validation failure\n            this.updateBadgeWithStats(plantId, stats);\n            return;\n          }\n        } else {\n          // No validation this time, trust bulk data\n          this.updateBadgeWithStats(plantId, stats);\n          return;\n        }\n      }\n      \n      console.log(`[NoteUI] Bulk stats not available for ${plantId}, falling back to individual requests`);\n      \n      // Fallback to individual requests if bulk API is not available\n      const plantNotes = await this.noteManager.getPlantNotes(plantId);\n      console.log(`[NoteUI] Plant ${plantId} has ${plantNotes?.length || 0} plant notes`);\n      \n      let totalImageNotes = 0;\n      \n      // Get plant images using the correct API\n      let plantImages = null;\n      if (window.PlantAnnotationTool?.plantDataManager) {\n        try {\n          plantImages = await window.PlantAnnotationTool.plantDataManager.getPlantImages(plantId);\n        } catch (error) {\n          console.debug(`Could not load plant images for ${plantId}:`, error.message);\n          // Fallback: try to get images by view angles if available\n          const plant = window.PlantAnnotationTool.plantDataManager.plants?.find(p => p.id === plantId);\n          if (plant?.viewAngles) {\n            const imagesByView = {};\n            for (const viewAngle of plant.viewAngles) {\n              try {\n                const images = await window.PlantAnnotationTool.plantDataManager.getPlantImages(plantId, viewAngle);\n                if (images && images.length > 0) {\n                  imagesByView[viewAngle] = images;\n                }\n              } catch (viewError) {\n                console.debug(`Could not load images for ${plantId}/${viewAngle}:`, viewError.message);\n              }\n            }\n            plantImages = imagesByView;\n          }\n        }\n      }\n      \n      // Count notes for all images of this plant\n      if (plantImages) {\n        const imagePromises = [];\n        \n        if (Array.isArray(plantImages)) {\n          // Single view angle array\n          for (const image of plantImages) {\n            imagePromises.push(this.noteManager.getImageNotes(plantId, image.id));\n          }\n        } else {\n          // Multi-view angle object\n          for (const viewAngle in plantImages) {\n            for (const image of plantImages[viewAngle]) {\n              imagePromises.push(this.noteManager.getImageNotes(plantId, image.id));\n            }\n          }\n        }\n        \n        // Get all image notes in parallel with proper error handling\n        const imageNotesResults = await Promise.allSettled(imagePromises);\n        totalImageNotes = imageNotesResults.reduce((total, result) => {\n          if (result.status === 'fulfilled' && result.value && result.value.length > 0) {\n            return total + result.value.length;\n          }\n          return total;\n        }, 0);\n      }\n      \n      const totalNotes = (plantNotes?.length || 0) + totalImageNotes;\n      console.log(`[NoteUI] Plant ${plantId} total notes: ${totalNotes} (${plantNotes?.length || 0} plant + ${totalImageNotes} image)`);\n      \n      const badge = document.getElementById(`note-badge-${plantId}`);\n      console.log(`[NoteUI] Badge element found for ${plantId}:`, !!badge);\n      \n      if (badge) {\n        if (totalNotes > 0) {\n          // ğŸ”§ FIX: åˆ†ç¦»æ˜¾ç¤ºæ¤æ ªç¬”è®°å’Œå›¾ç‰‡ç¬”è®°ï¼ˆé™çº§å¤„ç†ï¼‰\n          const plantNotesCount = plantNotes?.length || 0;\n          let badgeText = '';\n          let title = '';\n          \n          if (plantNotesCount > 0 && totalImageNotes > 0) {\n            // ä¸¤ç§ç¬”è®°éƒ½æœ‰\n            badgeText = `ğŸ“ ${plantNotesCount} | ğŸ–¼ï¸ ${totalImageNotes}`;\n            title = `${plantNotesCount} plant notes, ${totalImageNotes} image notes`;\n          } else if (plantNotesCount > 0) {\n            // åªæœ‰æ¤æ ªç¬”è®°\n            badgeText = `ğŸ“ ${plantNotesCount}`;\n            title = `${plantNotesCount} plant notes`;\n          } else if (totalImageNotes > 0) {\n            // åªæœ‰å›¾ç‰‡ç¬”è®°\n            badgeText = `ğŸ–¼ï¸ ${totalImageNotes}`;\n            title = `${totalImageNotes} image notes`;\n          }\n          \n          badge.innerHTML = `<span class=\"note-count\">${badgeText}</span>`;\n          badge.style.display = 'inline-flex';\n          badge.style.visibility = 'visible';\n          badge.style.opacity = '1';\n          badge.title = title;\n          console.log(`[NoteUI] Badge updated for ${plantId}: ${badgeText} (INDIVIDUAL)`);\n        } else {\n          badge.style.display = 'none';\n          badge.style.visibility = 'hidden';\n          badge.style.opacity = '0';\n          console.log(`[NoteUI] Badge hidden for ${plantId}: no notes found`);\n        }\n      } else {\n        console.error(`[NoteUI] Badge element not found for plant ${plantId}`);\n      }\n    } catch (error) {\n      console.error(`Failed to update note badge for plant ${plantId}:`, error);\n    }\n  }\n\n  /**\n   * Helper method to update badge with provided stats\n   */\n  updateBadgeWithStats(plantId, stats) {\n    const badge = document.getElementById(`note-badge-${plantId}`);\n    console.log(`[NoteUI] Badge element found for ${plantId}:`, !!badge);\n    \n    if (badge) {\n      const totalNotes = stats.total;\n      if (totalNotes > 0) {\n        // ğŸ”§ FIX: åˆ†ç¦»æ˜¾ç¤ºæ¤æ ªç¬”è®°å’Œå›¾ç‰‡ç¬”è®°\n        let badgeText = '';\n        let title = '';\n        \n        if (stats.plantNotes > 0 && stats.imageNotes > 0) {\n          // ä¸¤ç§ç¬”è®°éƒ½æœ‰\n          badgeText = `ğŸ“ ${stats.plantNotes} | ğŸ–¼ï¸ ${stats.imageNotes}`;\n          title = `${stats.plantNotes} plant notes, ${stats.imageNotes} image notes`;\n        } else if (stats.plantNotes > 0) {\n          // åªæœ‰æ¤æ ªç¬”è®°\n          badgeText = `ğŸ“ ${stats.plantNotes}`;\n          title = `${stats.plantNotes} plant notes`;\n        } else if (stats.imageNotes > 0) {\n          // åªæœ‰å›¾ç‰‡ç¬”è®°\n          badgeText = `ğŸ–¼ï¸ ${stats.imageNotes}`;\n          title = `${stats.imageNotes} image notes`;\n        }\n        \n        badge.innerHTML = `<span class=\"note-count\">${badgeText}</span>`;\n        badge.style.display = 'inline-flex';\n        badge.style.visibility = 'visible';\n        badge.style.opacity = '1';\n        badge.title = title;\n        console.log(`[NoteUI] Badge updated for ${plantId}: ${badgeText} (VALIDATED)`);\n      } else {\n        badge.style.display = 'none';\n        badge.style.visibility = 'hidden';\n        badge.style.opacity = '0';\n        console.log(`[NoteUI] Badge hidden for ${plantId}: no notes found (VALIDATED)`);\n      }\n    } else {\n      console.error(`[NoteUI] Badge element not found for plant ${plantId}`);\n    }\n  }\n\n  /**\n   * Update all plant note badges using bulk data (INSTANT - no individual requests)\n   */\n  async updateAllPlantNoteBadgesFromBulk(bulkData) {\n    console.log('[NoteUI] updateAllPlantNoteBadgesFromBulk() called with bulk data');\n    const plantItems = document.querySelectorAll('.plant-item');\n    console.log(`[NoteUI] Found ${plantItems.length} plant items to update`);\n    \n    if (!bulkData || !bulkData.plantNotes || !bulkData.imageNotes) {\n      console.error('[NoteUI] Invalid bulk data provided');\n      return;\n    }\n    \n    const startTime = performance.now();\n    \n    // Create quick stats lookup from bulk data\n    const quickStats = {};\n    \n    // Process plant notes\n    for (const [plantId, notes] of Object.entries(bulkData.plantNotes)) {\n      if (!quickStats[plantId]) {\n        quickStats[plantId] = { plantNotes: 0, imageNotes: 0, total: 0 };\n      }\n      quickStats[plantId].plantNotes = notes.length;\n      quickStats[plantId].total += notes.length;\n    }\n    \n    // Process image notes (group by plant)\n    for (const [imageId, notes] of Object.entries(bulkData.imageNotes)) {\n      // Extract plant ID from image ID (format: BR017-028111_sv-000_...)\n      const plantId = imageId.split('_')[0];\n      if (plantId) {\n        if (!quickStats[plantId]) {\n          quickStats[plantId] = { plantNotes: 0, imageNotes: 0, total: 0 };\n        }\n        quickStats[plantId].imageNotes += notes.length;\n        quickStats[plantId].total += notes.length;\n      }\n    }\n    \n    console.log(`[NoteUI] Generated quick stats for ${Object.keys(quickStats).length} plants`);\n    \n    // Update all badges instantly using pre-calculated stats\n    for (const item of plantItems) {\n      const plantId = item.dataset.plantId;\n      if (plantId && quickStats[plantId]) {\n        const stats = quickStats[plantId];\n        const totalNotes = stats.total;\n        \n        const badge = document.getElementById(`note-badge-${plantId}`);\n        if (badge) {\n          if (totalNotes > 0) {\n            // ğŸ”§ FIX: Use consistent separated display format for instant bulk updates\n            let badgeText = '';\n            let title = '';\n            \n            if (stats.plantNotes > 0 && stats.imageNotes > 0) {\n              // ä¸¤ç§ç¬”è®°éƒ½æœ‰\n              badgeText = `ğŸ“ ${stats.plantNotes} | ğŸ–¼ï¸ ${stats.imageNotes}`;\n              title = `${stats.plantNotes} plant notes, ${stats.imageNotes} image notes`;\n            } else if (stats.plantNotes > 0) {\n              // åªæœ‰æ¤æ ªç¬”è®°\n              badgeText = `ğŸ“ ${stats.plantNotes}`;\n              title = `${stats.plantNotes} plant notes`;\n            } else if (stats.imageNotes > 0) {\n              // åªæœ‰å›¾ç‰‡ç¬”è®°\n              badgeText = `ğŸ–¼ï¸ ${stats.imageNotes}`;\n              title = `${stats.imageNotes} image notes`;\n            }\n            \n            badge.innerHTML = `<span class=\"note-count\">${badgeText}</span>`;\n            badge.style.display = 'inline-flex';\n            badge.style.visibility = 'visible';\n            badge.style.opacity = '1';\n            badge.title = title;\n          } else {\n            badge.style.display = 'none';\n            badge.style.visibility = 'hidden';\n            badge.style.opacity = '0';\n          }\n        }\n      }\n    }\n    \n    const endTime = performance.now();\n    console.log(`[NoteUI] BULK UPDATE COMPLETE: ${plantItems.length} badges updated in ${(endTime - startTime).toFixed(2)}ms using bulk data`);\n    console.log(`[NoteUI] Performance: INSTANT UPDATE - no individual HTTP requests`);\n  }\n\n  /**\n   * Update all plant note badges (OPTIMIZED with bulk API)\n   */\n  async updateAllPlantNoteBadges() {\n    console.log('[NoteUI] updateAllPlantNoteBadges() called');\n    const plantItems = document.querySelectorAll('.plant-item');\n    console.log(`[NoteUI] Found ${plantItems.length} plant items to update`);\n    \n    const startTime = performance.now();\n    \n    try {\n      // Try bulk API first for maximum performance\n      const bulkStats = await this.noteManager.getQuickNoteStats();\n      \n      if (bulkStats) {\n        console.log('[NoteUI] Using bulk note stats for optimal performance');\n        \n        // Update all badges using bulk data in a single pass\n        for (const item of plantItems) {\n          const plantId = item.dataset.plantId;\n          if (plantId && bulkStats[plantId]) {\n            const stats = bulkStats[plantId];\n            const totalNotes = stats.total;\n            \n            const badge = document.getElementById(`note-badge-${plantId}`);\n            if (badge) {\n              if (totalNotes > 0) {\n                // ğŸ”§ FIX: Use consistent separated display format like updatePlantNoteBadge()\n                let badgeText = '';\n                let title = '';\n                \n                if (stats.plantNotes > 0 && stats.imageNotes > 0) {\n                  // ä¸¤ç§ç¬”è®°éƒ½æœ‰\n                  badgeText = `ğŸ“ ${stats.plantNotes} | ğŸ–¼ï¸ ${stats.imageNotes}`;\n                  title = `${stats.plantNotes} plant notes, ${stats.imageNotes} image notes`;\n                } else if (stats.plantNotes > 0) {\n                  // åªæœ‰æ¤æ ªç¬”è®°\n                  badgeText = `ğŸ“ ${stats.plantNotes}`;\n                  title = `${stats.plantNotes} plant notes`;\n                } else if (stats.imageNotes > 0) {\n                  // åªæœ‰å›¾ç‰‡ç¬”è®°\n                  badgeText = `ğŸ–¼ï¸ ${stats.imageNotes}`;\n                  title = `${stats.imageNotes} image notes`;\n                }\n                \n                badge.innerHTML = `<span class=\"note-count\">${badgeText}</span>`;\n                badge.style.display = 'inline-flex';\n                badge.style.visibility = 'visible';\n                badge.style.opacity = '1';\n                badge.title = title;\n              } else {\n                badge.style.display = 'none';\n                badge.style.visibility = 'hidden';\n                badge.style.opacity = '0';\n              }\n            }\n          }\n        }\n        \n        const endTime = performance.now();\n        const metrics = this.noteManager.getPerformanceMetrics();\n        console.log(`[NoteUI] BULK UPDATE COMPLETE: ${plantItems.length} badges updated in ${(endTime - startTime).toFixed(2)}ms`);\n        console.log(`[NoteUI] Performance: ${metrics.bulkRequestCount} bulk requests, ${metrics.cacheHits} cache hits`);\n        \n        return; // Exit early with optimal performance\n      }\n      \n      console.log('[NoteUI] Bulk API not available, falling back to individual requests');\n    } catch (error) {\n      console.error('[NoteUI] Bulk badge update failed, falling back to individual requests:', error);\n    }\n    \n    // Fallback to individual updates if bulk API fails\n    console.log('[NoteUI] Using individual badge updates (slower)');\n    for (const item of plantItems) {\n      const plantId = item.dataset.plantId;\n      if (plantId) {\n        console.log(`[NoteUI] Updating badge for plant: ${plantId}`);\n        await this.updatePlantNoteBadge(plantId);\n      } else {\n        console.warn('[NoteUI] Plant item found without plantId dataset');\n      }\n    }\n    \n    const endTime = performance.now();\n    const metrics = this.noteManager.getPerformanceMetrics();\n    console.log(`[NoteUI] INDIVIDUAL UPDATE COMPLETE: ${plantItems.length} badges updated in ${(endTime - startTime).toFixed(2)}ms`);\n    console.log(`[NoteUI] Performance: ${metrics.requestCount} individual requests, ${metrics.cacheHits} cache hits`);\n  }\n\n  /**\n   * Get note type text in English\n   */\n  getNoteTypeText(noteType) {\n    const typeMap = {\n      'general': 'General Note',\n      'observation': 'Observation Record',\n      'annotation': 'Annotation Description'\n    };\n    return typeMap[noteType] || noteType;\n  }\n\n  /**\n   * HTML escape\n   */\n  escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * Show user-friendly error message\n   */\n  showUserError(title, message) {\n    // Try to use global error display function\n    if (window.PlantAnnotationTool && window.PlantAnnotationTool.showError) {\n      window.PlantAnnotationTool.showError(title, message);\n    } else {\n      // Fall back to alert\n      alert(`${title}: ${message}`);\n    }\n  }\n\n  /**\n   * Direct thumbnail badge update (bypass all cache issues) - OPTIMIZED\n   */\n  async directUpdateThumbnailBadge(plantId, imageId) {\n    try {\n      console.log(`[NoteUI] ğŸ”„ Direct thumbnail badge update for ${imageId}`);\n      \n      // ğŸ”§ INCREASED DELAY: Allow backend processing to complete fully\n      await new Promise(resolve => setTimeout(resolve, 150));\n      \n      // Force fresh data by making direct API call\n      const response = await fetch(`${this.noteManager.baseUrl}/notes/image/${plantId}/${imageId}`);\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      \n      const result = await response.json();\n      const noteCount = result.success ? (result.data?.length || 0) : 0;\n      \n      // Update badge directly\n      const badge = document.getElementById(`image-note-badge-${imageId}`);\n      if (badge) {\n        if (noteCount > 0) {\n          badge.innerHTML = `<span class=\"image-note-count\">ğŸ“ ${noteCount}</span>`;\n          badge.style.display = 'inline-block';\n          badge.className = 'image-note-badge';\n          console.log(`[NoteUI] âœ… Badge updated: ${noteCount} notes for ${imageId} (DIRECT API)`);\n        } else {\n          badge.innerHTML = '';\n          badge.style.display = 'none';\n          console.log(`[NoteUI] âœ… Badge cleared for ${imageId} - no notes (DIRECT API)`);\n        }\n      } else {\n        console.error(`[NoteUI] Badge element not found for ${imageId}`);\n      }\n    } catch (error) {\n      console.error(`[NoteUI] âŒ Direct thumbnail badge update failed for ${imageId}:`, error);\n      \n      // ğŸ”§ FALLBACK: Try global function as last resort\n      try {\n        console.log(`[NoteUI] ğŸ”„ Attempting fallback via global loadImageNoteCount for ${imageId}`);\n        if (typeof loadImageNoteCount === 'function') {\n          await loadImageNoteCount(plantId, imageId);\n          console.log(`[NoteUI] âœ… Fallback badge update successful for ${imageId}`);\n        } else {\n          console.warn(`[NoteUI] âš ï¸ Global loadImageNoteCount not available for fallback`);\n        }\n      } catch (fallbackError) {\n        console.error(`[NoteUI] âŒ Fallback badge update also failed for ${imageId}:`, fallbackError);\n      }\n    }\n  }\n\n  /**\n   * Clean up resources\n   */\n  cleanup() {\n    // Remove event listeners and DOM elements\n    const elementsToRemove = [\n      'note-modal',\n      'note-list-modal',\n      'plant-note-btn',\n      'image-note-btn'\n      // ğŸ”§ REMOVED: Note display elements no longer exist\n    ];\n\n    elementsToRemove.forEach(id => {\n      const element = document.getElementById(id);\n      if (element) {\n        element.remove();\n      }\n    });\n\n    // Remove created containers\n    const containers = document.querySelectorAll('.plant-note-container, .image-note-container');\n    containers.forEach(container => container.remove());\n\n    console.log('NoteUI cleanup completed');\n  }\n}","/**\n * æ ‡æ³¨ç®¡ç†å™¨ - æ‰¹é‡åŠ è½½ä¼˜åŒ–ç‰ˆæœ¬\n * \n * åŠŸèƒ½ï¼š\n * - æ‰¹é‡è·å–æ‰€æœ‰æ¤ç‰©å’Œå›¾åƒçš„æ ‡æ³¨æ•°æ®\n * - æ™ºèƒ½ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–\n * - ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ\n * - é¿å…å•ç‹¬çš„ç½‘ç»œè¯·æ±‚\n */\n\nexport class AnnotationManager {\n  constructor(httpFileSystemManager) {\n    this.httpManager = httpFileSystemManager;\n    this.annotations = new Map(); // æ ‡æ³¨ç¼“å­˜\n    this.cacheTimestamps = new Map(); // ç¼“å­˜æ—¶é—´æˆ³\n    this.isInitialized = false;\n    this.cacheExpiration = 10 * 60 * 1000; // 10åˆ†é’Ÿç¼“å­˜è¿‡æœŸ\n    \n    // æ‰¹é‡æ•°æ®ç¼“å­˜\n    this.bulkAnnotationData = null;\n    this.bulkDataTimestamp = 0;\n    \n    // æ€§èƒ½æŒ‡æ ‡\n    this.performanceMetrics = {\n      requestCount: 0,\n      bulkRequestCount: 0,\n      cacheHits: 0,\n      networkTime: 0,\n      totalAnnotations: 0\n    };\n  }\n\n  /**\n   * åˆå§‹åŒ–æ ‡æ³¨ç®¡ç†å™¨\n   */\n  async initialize() {\n    try {\n      await this.httpManager.ensureConnection();\n      this.isInitialized = true;\n      console.log('[AnnotationManager] åˆå§‹åŒ–æˆåŠŸ');\n      return true;\n    } catch (error) {\n      console.error('[AnnotationManager] åˆå§‹åŒ–å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç¡®ä¿è¿æ¥å¯ç”¨\n   */\n  async ensureConnection() {\n    if (!this.isInitialized) {\n      await this.initialize();\n    }\n    await this.httpManager.ensureConnection();\n  }\n\n  /**\n   * æ‰¹é‡è·å–æ‰€æœ‰æ ‡æ³¨æ•°æ® (æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–æ–¹æ³•)\n   */\n  async getAllAnnotationsInBulk() {\n    console.log('[AnnotationManager] å¼€å§‹æ‰¹é‡è·å–æ‰€æœ‰æ ‡æ³¨æ•°æ®...');\n    \n    await this.ensureConnection();\n    \n    // æ£€æŸ¥æ‰¹é‡æ•°æ®ç¼“å­˜\n    if (this.bulkAnnotationData && !this.isBulkDataExpired()) {\n      console.log('[AnnotationManager] ä½¿ç”¨ç¼“å­˜çš„æ‰¹é‡æ ‡æ³¨æ•°æ®');\n      this.performanceMetrics.cacheHits++;\n      return this.bulkAnnotationData;\n    }\n\n    return this.httpManager.withRetry(async () => {\n      const startTime = performance.now();\n      // ğŸ”§ FIX: Correct URL construction to avoid double /api/\n      const baseUrl = this.httpManager.baseUrl.replace(/\\/api$/, ''); // Remove trailing /api if present\n      const url = `${baseUrl}/api/annotations/bulk`;\n      console.log(`[AnnotationManager] è¯·æ±‚æ‰¹é‡æ ‡æ³¨æ•°æ® URL: ${url}`);\n      \n      try {\n        const response = await fetch(url, {\n          headers: {\n            'Cache-Control': 'no-cache'\n          }\n        });\n        this.performanceMetrics.bulkRequestCount++;\n\n        if (!response.ok) {\n          if (response.status === 404) {\n            console.warn('[AnnotationManager] æ‰¹é‡æ ‡æ³¨ç«¯ç‚¹ä¸å­˜åœ¨ï¼Œå°†å›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼');\n            return null; // è¡¨ç¤ºä¸æ”¯æŒæ‰¹é‡API\n          }\n          throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n        }\n\n        const result = await response.json();\n        this.performanceMetrics.networkTime += performance.now() - startTime;\n\n        if (result.success) {\n          // ç¼“å­˜æ‰¹é‡æ•°æ®\n          this.bulkAnnotationData = {\n            plantAnnotations: result.data.plantAnnotations || {},\n            imageAnnotations: result.data.imageAnnotations || {},\n            statistics: result.data.statistics || {}\n          };\n          this.bulkDataTimestamp = Date.now();\n          \n          // æ›´æ–°ä¸ªåˆ«ç¼“å­˜ä»¥ä¿æŒä¸€è‡´æ€§\n          this.updateIndividualCacheFromBulk();\n          \n          // ç»Ÿè®¡æ•°æ®\n          const plantCount = Object.keys(this.bulkAnnotationData.plantAnnotations).length;\n          const imageCount = Object.keys(this.bulkAnnotationData.imageAnnotations).length;\n          this.performanceMetrics.totalAnnotations = this.calculateTotalAnnotations();\n          \n          console.log(`[AnnotationManager] æˆåŠŸè·å–æ‰¹é‡æ ‡æ³¨æ•°æ®: ${plantCount} ä¸ªæ¤ç‰©, ${imageCount} ä¸ªå›¾åƒ, ${this.performanceMetrics.totalAnnotations} ä¸ªæ ‡æ³¨ç‚¹`);\n          \n          return this.bulkAnnotationData;\n        }\n\n        throw new Error(result.error || 'è·å–æ‰¹é‡æ ‡æ³¨æ•°æ®å¤±è´¥');\n      } catch (fetchError) {\n        this.performanceMetrics.networkTime += performance.now() - startTime;\n        \n        if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {\n          throw new Error(`ç½‘ç»œè¿æ¥å¤±è´¥: æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ (${url})`);\n        }\n        throw fetchError;\n      }\n    }, 'æ‰¹é‡è·å–æ ‡æ³¨æ•°æ®');\n  }\n\n  /**\n   * è·å–æ¤ç‰©æ ‡æ³¨æ•°æ® (ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¼˜å…ˆä½¿ç”¨æ‰¹é‡æ•°æ®)\n   */\n  async getPlantAnnotations(plantId) {\n    if (!plantId) {\n      throw new Error('æ¤ç‰©IDä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n    \n    const cacheKey = `plant_${plantId}`;\n    \n    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ‰¹é‡æ•°æ®ç¼“å­˜\n    if (this.bulkAnnotationData && !this.isBulkDataExpired()) {\n      const plantAnnotations = this.bulkAnnotationData.plantAnnotations[plantId] || [];\n      this.annotations.set(cacheKey, plantAnnotations);\n      this.performanceMetrics.cacheHits++;\n      return plantAnnotations;\n    }\n    \n    // æ£€æŸ¥ç‹¬ç«‹ç¼“å­˜\n    if (this.annotations.has(cacheKey) && !this.isCacheExpired(cacheKey)) {\n      this.performanceMetrics.cacheHits++;\n      return this.annotations.get(cacheKey);\n    }\n\n    // å›é€€åˆ°å•ç‹¬è¯·æ±‚\n    return this.getSinglePlantAnnotations(plantId);\n  }\n\n  /**\n   * è·å–å›¾åƒæ ‡æ³¨æ•°æ® (ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¼˜å…ˆä½¿ç”¨æ‰¹é‡æ•°æ®)\n   */\n  async getImageAnnotations(imageId) {\n    if (!imageId) {\n      throw new Error('å›¾åƒIDä¸èƒ½ä¸ºç©º');\n    }\n\n    await this.ensureConnection();\n    \n    const cacheKey = `image_${imageId}`;\n    \n    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ‰¹é‡æ•°æ®ç¼“å­˜\n    if (this.bulkAnnotationData && !this.isBulkDataExpired()) {\n      const imageAnnotations = this.bulkAnnotationData.imageAnnotations[imageId] || [];\n      this.annotations.set(cacheKey, imageAnnotations);\n      this.performanceMetrics.cacheHits++;\n      return imageAnnotations;\n    }\n    \n    // æ£€æŸ¥ç‹¬ç«‹ç¼“å­˜\n    if (this.annotations.has(cacheKey) && !this.isCacheExpired(cacheKey)) {\n      this.performanceMetrics.cacheHits++;\n      return this.annotations.get(cacheKey);\n    }\n\n    // å›é€€åˆ°å•ç‹¬è¯·æ±‚\n    return this.getSingleImageAnnotations(imageId);\n  }\n\n  /**\n   * è·å–å¿«é€Ÿæ ‡æ³¨ç»Ÿè®¡ï¼ˆç”¨äºBadgeæ›´æ–°ï¼‰\n   */\n  async getQuickAnnotationStats() {\n    console.log('[AnnotationManager] è·å–å¿«é€Ÿæ ‡æ³¨ç»Ÿè®¡...');\n    \n    try {\n      const bulkData = await this.getAllAnnotationsInBulk();\n      \n      if (!bulkData) {\n        console.warn('[AnnotationManager] æ‰¹é‡APIä¸å¯ç”¨ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼');\n        return null;\n      }\n      \n      const stats = {};\n      \n      // è®¡ç®—æ¯ä¸ªæ¤ç‰©çš„æ ‡æ³¨ç»Ÿè®¡\n      for (const [plantId, plantAnnotations] of Object.entries(bulkData.plantAnnotations)) {\n        let imageAnnotationCount = 0;\n        \n        // ç»Ÿè®¡è¯¥æ¤ç‰©æ‰€æœ‰å›¾åƒçš„æ ‡æ³¨æ•°\n        for (const [imageId, imageAnnotations] of Object.entries(bulkData.imageAnnotations)) {\n          if (imageId.startsWith(plantId + '_')) {\n            imageAnnotationCount += imageAnnotations.length;\n          }\n        }\n        \n        stats[plantId] = {\n          plantAnnotations: plantAnnotations.length,\n          imageAnnotations: imageAnnotationCount,\n          total: plantAnnotations.length + imageAnnotationCount\n        };\n      }\n      \n      console.log(`[AnnotationManager] å¿«é€Ÿç»Ÿè®¡å®Œæˆ: ${Object.keys(stats).length} ä¸ªæ¤ç‰©`);\n      return stats;\n    } catch (error) {\n      console.error('[AnnotationManager] è·å–å¿«é€Ÿæ ‡æ³¨ç»Ÿè®¡å¤±è´¥:', error);\n      return null;\n    }\n  }\n\n  /**\n   * å•ç‹¬è·å–æ¤ç‰©æ ‡æ³¨ï¼ˆå›é€€æ–¹æ¡ˆï¼‰\n   */\n  async getSinglePlantAnnotations(plantId) {\n    const startTime = performance.now();\n    \n    try {\n      // ğŸ”§ FIX: Consistent URL construction to avoid double /api/\n      const baseUrl = this.httpManager.baseUrl.replace(/\\/api$/, '');\n      const url = `${baseUrl}/api/plant-annotations/${encodeURIComponent(plantId)}`;\n      \n      const response = await fetch(url);\n      this.performanceMetrics.requestCount++;\n\n      if (!response.ok) {\n        if (response.status === 404) {\n          const emptyResult = [];\n          this.setCache(`plant_${plantId}`, emptyResult);\n          return emptyResult;\n        }\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n      this.performanceMetrics.networkTime += performance.now() - startTime;\n\n      if (result.success) {\n        this.setCache(`plant_${plantId}`, result.data);\n        return result.data;\n      }\n\n      throw new Error(result.error || 'è·å–æ¤ç‰©æ ‡æ³¨å¤±è´¥');\n    } catch (fetchError) {\n      this.performanceMetrics.networkTime += performance.now() - startTime;\n      throw fetchError;\n    }\n  }\n\n  /**\n   * å•ç‹¬è·å–å›¾åƒæ ‡æ³¨ï¼ˆå›é€€æ–¹æ¡ˆï¼‰\n   */\n  async getSingleImageAnnotations(imageId) {\n    const startTime = performance.now();\n    \n    try {\n      // ğŸ”§ FIX: Consistent URL construction to avoid double /api/\n      const baseUrl = this.httpManager.baseUrl.replace(/\\/api$/, '');\n      const url = `${baseUrl}/api/image-annotations/${encodeURIComponent(imageId)}`;\n      \n      const response = await fetch(url);\n      this.performanceMetrics.requestCount++;\n\n      if (!response.ok) {\n        if (response.status === 404) {\n          const emptyResult = [];\n          this.setCache(`image_${imageId}`, emptyResult);\n          return emptyResult;\n        }\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n      this.performanceMetrics.networkTime += performance.now() - startTime;\n\n      if (result.success) {\n        this.setCache(`image_${imageId}`, result.data);\n        return result.data;\n      }\n\n      throw new Error(result.error || 'è·å–å›¾åƒæ ‡æ³¨å¤±è´¥');\n    } catch (fetchError) {\n      this.performanceMetrics.networkTime += performance.now() - startTime;\n      throw fetchError;\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æ‰¹é‡æ•°æ®æ˜¯å¦è¿‡æœŸ\n   */\n  isBulkDataExpired() {\n    if (!this.bulkDataTimestamp) return true;\n    return Date.now() - this.bulkDataTimestamp > this.cacheExpiration;\n  }\n\n  /**\n   * ä»æ‰¹é‡æ•°æ®æ›´æ–°ä¸ªåˆ«ç¼“å­˜\n   */\n  updateIndividualCacheFromBulk() {\n    if (!this.bulkAnnotationData) return;\n    \n    // æ›´æ–°æ¤ç‰©æ ‡æ³¨ç¼“å­˜\n    for (const [plantId, annotations] of Object.entries(this.bulkAnnotationData.plantAnnotations)) {\n      const cacheKey = `plant_${plantId}`;\n      this.setCache(cacheKey, annotations);\n    }\n    \n    // æ›´æ–°å›¾åƒæ ‡æ³¨ç¼“å­˜\n    for (const [imageId, annotations] of Object.entries(this.bulkAnnotationData.imageAnnotations)) {\n      const cacheKey = `image_${imageId}`;\n      this.setCache(cacheKey, annotations);\n    }\n  }\n\n  /**\n   * è®¡ç®—æ€»æ ‡æ³¨æ•°é‡\n   */\n  calculateTotalAnnotations() {\n    if (!this.bulkAnnotationData) return 0;\n    \n    let total = 0;\n    \n    // æ¤ç‰©æ ‡æ³¨\n    for (const annotations of Object.values(this.bulkAnnotationData.plantAnnotations)) {\n      total += annotations.length;\n    }\n    \n    // å›¾åƒæ ‡æ³¨\n    for (const annotations of Object.values(this.bulkAnnotationData.imageAnnotations)) {\n      total += annotations.length;\n    }\n    \n    return total;\n  }\n\n  /**\n   * æ¸…é™¤ç¼“å­˜\n   */\n  clearCache() {\n    this.annotations.clear();\n    this.cacheTimestamps.clear();\n    this.bulkAnnotationData = null;\n    this.bulkDataTimestamp = 0;\n    console.log('[AnnotationManager] æ ‡æ³¨ç¼“å­˜å·²å®Œå…¨æ¸…é™¤');\n  }\n\n  /**\n   * è®¾ç½®ç¼“å­˜\n   */\n  setCache(key, data) {\n    this.annotations.set(key, data);\n    this.cacheTimestamps.set(key, Date.now());\n  }\n\n  /**\n   * æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ\n   */\n  isCacheExpired(key) {\n    const timestamp = this.cacheTimestamps.get(key);\n    if (!timestamp) return true;\n    return Date.now() - timestamp > this.cacheExpiration;\n  }\n\n  /**\n   * è·å–æ€§èƒ½æŒ‡æ ‡\n   */\n  getPerformanceMetrics() {\n    return {\n      ...this.performanceMetrics,\n      cacheSize: this.annotations.size,\n      hasBulkData: !!this.bulkAnnotationData,\n      bulkDataAge: this.bulkDataTimestamp ? Date.now() - this.bulkDataTimestamp : null,\n      averageRequestTime: this.performanceMetrics.requestCount > 0 \n        ? this.performanceMetrics.networkTime / this.performanceMetrics.requestCount \n        : 0\n    };\n  }\n\n  /**\n   * å¼ºåˆ¶åˆ·æ–°æ‰¹é‡æ•°æ®\n   */\n  async refreshBulkData() {\n    console.log('[AnnotationManager] å¼ºåˆ¶åˆ·æ–°æ‰¹é‡æ ‡æ³¨æ•°æ®...');\n    this.bulkAnnotationData = null;\n    this.bulkDataTimestamp = 0;\n    return await this.getAllAnnotationsInBulk();\n  }\n\n  /**\n   * æ¸…ç†èµ„æº\n   */\n  cleanup() {\n    this.clearCache();\n    this.isInitialized = false;\n    console.log('[AnnotationManager] æ¸…ç†å®Œæˆ');\n  }\n}","/**\n * Bulk Loading Performance Monitor\n * \n * åŠŸèƒ½ï¼š\n * - ç›‘æ§æ‰¹é‡åŠ è½½æ€§èƒ½\n * - è·Ÿè¸ªç¼“å­˜æ•ˆæœ\n * - æ€§èƒ½æŒ‡æ ‡æ”¶é›†å’ŒæŠ¥å‘Š\n * - è‡ªåŠ¨ä¼˜åŒ–å»ºè®®\n */\n\nexport class BulkLoadingPerformanceMonitor {\n  constructor() {\n    this.metrics = {\n      // åŠ è½½æ€§èƒ½\n      loadingStartTime: null,\n      loadingEndTime: null,\n      totalLoadingTime: 0,\n      \n      // æ•°æ®ç»Ÿè®¡\n      plantsLoaded: 0,\n      annotationsLoaded: 0,\n      notesLoaded: 0,\n      \n      // ç½‘ç»œæ€§èƒ½\n      networkRequests: 0,\n      bulkRequests: 0,\n      individualRequests: 0,\n      totalDataTransferred: 0,\n      \n      // ç¼“å­˜æ€§èƒ½\n      cacheHits: 0,\n      cacheMisses: 0,\n      cacheSize: 0,\n      \n      // é”™è¯¯ç»Ÿè®¡\n      errors: [],\n      fallbacksUsed: 0,\n      \n      // ç”¨æˆ·ä½“éªŒ\n      timeToFirstInteraction: 0,\n      timeToFullyLoaded: 0\n    };\n    \n    this.isMonitoring = false;\n    this.startTime = null;\n    this.checkpoints = [];\n  }\n\n  /**\n   * å¼€å§‹ç›‘æ§åŠ è½½è¿‡ç¨‹\n   */\n  startMonitoring() {\n    this.isMonitoring = true;\n    this.startTime = performance.now();\n    this.metrics.loadingStartTime = Date.now();\n    this.checkpoints = [];\n    \n    console.log('[æ€§èƒ½ç›‘æ§] å¼€å§‹ç›‘æ§æ‰¹é‡åŠ è½½è¿‡ç¨‹');\n  }\n\n  /**\n   * æ·»åŠ æ£€æŸ¥ç‚¹\n   */\n  addCheckpoint(name, details = {}) {\n    if (!this.isMonitoring) return;\n    \n    const checkpoint = {\n      name,\n      timestamp: performance.now(),\n      relativeTime: performance.now() - this.startTime,\n      details\n    };\n    \n    this.checkpoints.push(checkpoint);\n    console.log(`[æ€§èƒ½ç›‘æ§] ${name}: ${checkpoint.relativeTime.toFixed(2)}ms`, details);\n  }\n\n  /**\n   * è®°å½•æ•°æ®åŠ è½½å®Œæˆ\n   */\n  recordDataLoaded(type, count, dataSize = 0) {\n    switch (type) {\n      case 'plants':\n        this.metrics.plantsLoaded = count;\n        break;\n      case 'annotations':\n        this.metrics.annotationsLoaded = count;\n        break;\n      case 'notes':\n        this.metrics.notesLoaded = count;\n        break;\n    }\n    \n    this.metrics.totalDataTransferred += dataSize;\n    this.addCheckpoint(`${type} æ•°æ®åŠ è½½å®Œæˆ`, { count, dataSize: `${(dataSize / 1024).toFixed(2)}KB` });\n  }\n\n  /**\n   * è®°å½•ç½‘ç»œè¯·æ±‚\n   */\n  recordNetworkRequest(type, isBulk = false) {\n    this.metrics.networkRequests++;\n    \n    if (isBulk) {\n      this.metrics.bulkRequests++;\n    } else {\n      this.metrics.individualRequests++;\n    }\n    \n    this.addCheckpoint(`ç½‘ç»œè¯·æ±‚: ${type}`, { isBulk, total: this.metrics.networkRequests });\n  }\n\n  /**\n   * è®°å½•ç¼“å­˜å‘½ä¸­\n   */\n  recordCacheHit(type, cacheSize = 0) {\n    this.metrics.cacheHits++;\n    this.metrics.cacheSize = cacheSize;\n    \n    console.log(`[ç¼“å­˜å‘½ä¸­] ${type} - æ€»å‘½ä¸­: ${this.metrics.cacheHits}`);\n  }\n\n  /**\n   * è®°å½•ç¼“å­˜æœªå‘½ä¸­\n   */\n  recordCacheMiss(type) {\n    this.metrics.cacheMisses++;\n    \n    console.log(`[ç¼“å­˜æœªå‘½ä¸­] ${type} - æ€»æœªå‘½ä¸­: ${this.metrics.cacheMisses}`);\n  }\n\n  /**\n   * è®°å½•é”™è¯¯\n   */\n  recordError(error, context = '') {\n    this.metrics.errors.push({\n      error: error.message,\n      context,\n      timestamp: Date.now()\n    });\n    \n    console.error(`[æ€§èƒ½ç›‘æ§] é”™è¯¯è®°å½•: ${context}`, error);\n  }\n\n  /**\n   * è®°å½•å›é€€ä½¿ç”¨\n   */\n  recordFallback(reason) {\n    this.metrics.fallbacksUsed++;\n    \n    this.addCheckpoint('ä½¿ç”¨å›é€€æ–¹æ¡ˆ', { reason, totalFallbacks: this.metrics.fallbacksUsed });\n  }\n\n  /**\n   * ç»“æŸç›‘æ§å¹¶ç”ŸæˆæŠ¥å‘Š\n   */\n  endMonitoring() {\n    if (!this.isMonitoring) return null;\n    \n    this.isMonitoring = false;\n    this.metrics.loadingEndTime = Date.now();\n    this.metrics.totalLoadingTime = performance.now() - this.startTime;\n    \n    const report = this.generatePerformanceReport();\n    console.log('[æ€§èƒ½ç›‘æ§] åŠ è½½å®Œæˆï¼Œç”Ÿæˆæ€§èƒ½æŠ¥å‘Š:', report);\n    \n    return report;\n  }\n\n  /**\n   * ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š\n   */\n  generatePerformanceReport() {\n    const cacheHitRate = this.metrics.cacheHits + this.metrics.cacheMisses > 0 \n      ? (this.metrics.cacheHits / (this.metrics.cacheHits + this.metrics.cacheMisses) * 100).toFixed(1)\n      : 0;\n\n    const bulkRequestRatio = this.metrics.networkRequests > 0\n      ? (this.metrics.bulkRequests / this.metrics.networkRequests * 100).toFixed(1)\n      : 0;\n\n    const report = {\n      // æ€»ä½“æ€§èƒ½\n      summary: {\n        totalLoadingTime: `${this.metrics.totalLoadingTime.toFixed(2)}ms`,\n        dataLoaded: {\n          plants: this.metrics.plantsLoaded,\n          annotations: this.metrics.annotationsLoaded,\n          notes: this.metrics.notesLoaded\n        },\n        networkRequests: this.metrics.networkRequests,\n        dataTransferred: `${(this.metrics.totalDataTransferred / 1024).toFixed(2)}KB`\n      },\n      \n      // ç½‘ç»œæ€§èƒ½\n      networkPerformance: {\n        totalRequests: this.metrics.networkRequests,\n        bulkRequests: this.metrics.bulkRequests,\n        individualRequests: this.metrics.individualRequests,\n        bulkRequestRatio: `${bulkRequestRatio}%`,\n        averageRequestSize: this.metrics.networkRequests > 0 \n          ? `${(this.metrics.totalDataTransferred / this.metrics.networkRequests / 1024).toFixed(2)}KB`\n          : '0KB'\n      },\n      \n      // ç¼“å­˜æ€§èƒ½\n      cachePerformance: {\n        hits: this.metrics.cacheHits,\n        misses: this.metrics.cacheMisses,\n        hitRate: `${cacheHitRate}%`,\n        cacheSize: `${(this.metrics.cacheSize / 1024).toFixed(2)}KB`\n      },\n      \n      // é”™è¯¯å’Œå›é€€\n      reliability: {\n        errors: this.metrics.errors.length,\n        fallbacksUsed: this.metrics.fallbacksUsed,\n        errorDetails: this.metrics.errors\n      },\n      \n      // æ£€æŸ¥ç‚¹æ—¶é—´çº¿\n      timeline: this.checkpoints,\n      \n      // æ€§èƒ½è¯„çº§\n      performanceGrade: this.calculatePerformanceGrade(),\n      \n      // ä¼˜åŒ–å»ºè®®\n      optimizationSuggestions: this.generateOptimizationSuggestions()\n    };\n\n    return report;\n  }\n\n  /**\n   * è®¡ç®—æ€§èƒ½è¯„çº§\n   */\n  calculatePerformanceGrade() {\n    let score = 100;\n    \n    // åŠ è½½æ—¶é—´è¯„åˆ†\n    if (this.metrics.totalLoadingTime > 5000) {\n      score -= 30; // è¶…è¿‡5ç§’æ‰£30åˆ†\n    } else if (this.metrics.totalLoadingTime > 2000) {\n      score -= 15; // è¶…è¿‡2ç§’æ‰£15åˆ†\n    } else if (this.metrics.totalLoadingTime > 1000) {\n      score -= 5; // è¶…è¿‡1ç§’æ‰£5åˆ†\n    }\n    \n    // ç½‘ç»œè¯·æ±‚è¯„åˆ†\n    const requestEfficiency = this.metrics.bulkRequests / (this.metrics.networkRequests || 1);\n    if (requestEfficiency < 0.5) {\n      score -= 20; // æ‰¹é‡è¯·æ±‚æ¯”ä¾‹ä½äº50%æ‰£20åˆ†\n    } else if (requestEfficiency < 0.8) {\n      score -= 10; // æ‰¹é‡è¯·æ±‚æ¯”ä¾‹ä½äº80%æ‰£10åˆ†\n    }\n    \n    // ç¼“å­˜æ•ˆç‡è¯„åˆ†\n    const cacheHitRate = this.metrics.cacheHits / ((this.metrics.cacheHits + this.metrics.cacheMisses) || 1);\n    if (cacheHitRate < 0.6) {\n      score -= 15; // ç¼“å­˜å‘½ä¸­ç‡ä½äº60%æ‰£15åˆ†\n    } else if (cacheHitRate < 0.8) {\n      score -= 8; // ç¼“å­˜å‘½ä¸­ç‡ä½äº80%æ‰£8åˆ†\n    }\n    \n    // é”™è¯¯å’Œå›é€€è¯„åˆ†\n    score -= this.metrics.errors.length * 5; // æ¯ä¸ªé”™è¯¯æ‰£5åˆ†\n    score -= this.metrics.fallbacksUsed * 3; // æ¯æ¬¡å›é€€æ‰£3åˆ†\n    \n    // ç¡®ä¿åˆ†æ•°åœ¨0-100ä¹‹é—´\n    score = Math.max(0, Math.min(100, score));\n    \n    if (score >= 90) return 'A+';\n    if (score >= 80) return 'A';\n    if (score >= 70) return 'B';\n    if (score >= 60) return 'C';\n    if (score >= 50) return 'D';\n    return 'F';\n  }\n\n  /**\n   * ç”Ÿæˆä¼˜åŒ–å»ºè®®\n   */\n  generateOptimizationSuggestions() {\n    const suggestions = [];\n    \n    // åŠ è½½æ—¶é—´å»ºè®®\n    if (this.metrics.totalLoadingTime > 2000) {\n      suggestions.push({\n        category: 'åŠ è½½æ€§èƒ½',\n        suggestion: 'è€ƒè™‘å®ç°æ•°æ®åˆ†é¡µæˆ–å¢é‡åŠ è½½',\n        priority: 'high',\n        impact: 'å‡å°‘åˆå§‹åŠ è½½æ—¶é—´50%+'\n      });\n    }\n    \n    // ç½‘ç»œè¯·æ±‚å»ºè®®\n    const bulkRatio = this.metrics.bulkRequests / (this.metrics.networkRequests || 1);\n    if (bulkRatio < 0.8) {\n      suggestions.push({\n        category: 'ç½‘ç»œä¼˜åŒ–',\n        suggestion: 'å¢åŠ æ‰¹é‡APIçš„ä½¿ç”¨ï¼Œå‡å°‘å•ç‹¬è¯·æ±‚',\n        priority: 'high',\n        impact: 'å‡å°‘ç½‘ç»œè¯·æ±‚80%+'\n      });\n    }\n    \n    // ç¼“å­˜å»ºè®®\n    const cacheHitRate = this.metrics.cacheHits / ((this.metrics.cacheHits + this.metrics.cacheMisses) || 1);\n    if (cacheHitRate < 0.7) {\n      suggestions.push({\n        category: 'ç¼“å­˜ä¼˜åŒ–',\n        suggestion: 'ä¼˜åŒ–ç¼“å­˜ç­–ç•¥ï¼Œå¢åŠ ç¼“å­˜æ—¶é—´æˆ–æ”¹è¿›ç¼“å­˜é”®è®¾è®¡',\n        priority: 'medium',\n        impact: 'æé«˜å“åº”é€Ÿåº¦30%+'\n      });\n    }\n    \n    // é”™è¯¯å¤„ç†å»ºè®®\n    if (this.metrics.errors.length > 0) {\n      suggestions.push({\n        category: 'é”™è¯¯å¤„ç†',\n        suggestion: 'æ”¹è¿›é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶',\n        priority: 'medium',\n        impact: 'æé«˜ç³»ç»Ÿç¨³å®šæ€§'\n      });\n    }\n    \n    // å›é€€å»ºè®®\n    if (this.metrics.fallbacksUsed > 0) {\n      suggestions.push({\n        category: 'å…¼å®¹æ€§',\n        suggestion: 'ç¡®ä¿æ‰¹é‡APIçš„å¯ç”¨æ€§ï¼Œå‡å°‘å›é€€æ–¹æ¡ˆçš„ä½¿ç”¨',\n        priority: 'low',\n        impact: 'æé«˜æ€§èƒ½ä¸€è‡´æ€§'\n      });\n    }\n    \n    return suggestions;\n  }\n\n  /**\n   * å¯¼å‡ºæ€§èƒ½æ•°æ®\n   */\n  exportMetrics() {\n    return {\n      metrics: this.metrics,\n      report: this.generatePerformanceReport(),\n      exportTime: new Date().toISOString()\n    };\n  }\n\n  /**\n   * é‡ç½®æ‰€æœ‰æŒ‡æ ‡\n   */\n  reset() {\n    this.metrics = {\n      loadingStartTime: null,\n      loadingEndTime: null,\n      totalLoadingTime: 0,\n      plantsLoaded: 0,\n      annotationsLoaded: 0,\n      notesLoaded: 0,\n      networkRequests: 0,\n      bulkRequests: 0,\n      individualRequests: 0,\n      totalDataTransferred: 0,\n      cacheHits: 0,\n      cacheMisses: 0,\n      cacheSize: 0,\n      errors: [],\n      fallbacksUsed: 0,\n      timeToFirstInteraction: 0,\n      timeToFullyLoaded: 0\n    };\n    \n    this.isMonitoring = false;\n    this.startTime = null;\n    this.checkpoints = [];\n    \n    console.log('[æ€§èƒ½ç›‘æ§] æŒ‡æ ‡å·²é‡ç½®');\n  }\n}","/**\n * RealTimeSyncManager - Manages real-time synchronization of annotation operations\n * across future images within the same plant and view angle.\n * \n * Features:\n * - Toggle-able real-time synchronization\n * - Sync keypoint operations (add, move, delete) to future images\n * - Compatible with existing save logic\n * - Sequential processing to avoid race conditions\n */\nclass RealTimeSyncManager {\n  constructor(plantDataManager, annotationStorageManager) {\n    this.plantDataManager = plantDataManager;\n    this.annotationStorageManager = annotationStorageManager;\n    \n    // Sync state\n    this.isEnabled = false;\n    this.isSyncing = false;\n    this.syncQueue = [];\n    \n    // Operation types\n    this.OPERATION_TYPES = {\n      ADD_KEYPOINT: 'ADD_KEYPOINT',\n      MOVE_KEYPOINT: 'MOVE_KEYPOINT',\n      DELETE_KEYPOINT: 'DELETE_KEYPOINT',\n      EDIT_DIRECTION: 'EDIT_DIRECTION', // ğŸ”§ NEW: Direction-specific operation\n      CUSTOM_ANNOTATION_CREATE: 'CUSTOM_ANNOTATION_CREATE',\n      CUSTOM_ANNOTATION_UPDATE: 'CUSTOM_ANNOTATION_UPDATE',\n      CUSTOM_ANNOTATION_DELETE: 'CUSTOM_ANNOTATION_DELETE',\n      CUSTOM_TYPE_CREATE: 'CUSTOM_TYPE_CREATE'\n    };\n    \n    // Event listeners for UI feedback\n    this.eventListeners = new Map();\n    \n    console.log('ğŸ”„ RealTimeSyncManager initialized');\n  }\n\n  /**\n   * Enable or disable real-time synchronization\n   * @param {boolean} enabled - Whether to enable sync\n   */\n  setEnabled(enabled) {\n    this.isEnabled = Boolean(enabled);\n    console.log(`ğŸ”„ Real-time sync ${this.isEnabled ? 'enabled' : 'disabled'}`);\n    \n    // Emit event for UI updates\n    this.emit('syncToggled', { enabled: this.isEnabled });\n  }\n\n  /**\n   * Check if real-time sync is currently enabled\n   * @returns {boolean} True if sync is enabled\n   */\n  isRealTimeSyncEnabled() {\n    return this.isEnabled;\n  }\n\n  /**\n   * Check if sync operation is currently in progress\n   * @returns {boolean} True if syncing\n   */\n  isSyncInProgress() {\n    return this.isSyncing;\n  }\n\n  /**\n   * Add event listener for sync events\n   * @param {string} event - Event name\n   * @param {Function} listener - Event listener function\n   */\n  on(event, listener) {\n    if (!this.eventListeners.has(event)) {\n      this.eventListeners.set(event, []);\n    }\n    this.eventListeners.get(event).push(listener);\n  }\n\n  /**\n   * Remove event listener\n   * @param {string} event - Event name\n   * @param {Function} listener - Event listener function\n   */\n  off(event, listener) {\n    if (this.eventListeners.has(event)) {\n      const listeners = this.eventListeners.get(event);\n      const index = listeners.indexOf(listener);\n      if (index > -1) {\n        listeners.splice(index, 1);\n      }\n    }\n  }\n\n  /**\n   * Emit event to listeners\n   * @param {string} event - Event name\n   * @param {any} data - Event data\n   */\n  emit(event, data) {\n    if (this.eventListeners.has(event)) {\n      this.eventListeners.get(event).forEach(listener => {\n        try {\n          listener(data);\n        } catch (error) {\n          console.error(`Error in sync event listener for ${event}:`, error);\n        }\n      });\n    }\n  }\n\n  /**\n   * Get future images for the current plant and view angle\n   * @param {object} currentImage - Current image object\n   * @param {object} currentPlant - Current plant object\n   * @returns {Promise<Array>} Array of future images\n   */\n  async getFutureImages(currentImage, currentPlant) {\n    if (!currentImage || !currentPlant) {\n      console.warn('ğŸ”„ Cannot get future images: missing current image or plant');\n      return [];\n    }\n\n    try {\n      // Get all images for current plant and view angle\n      const allImages = await this.plantDataManager.getPlantImages(\n        currentPlant.id,\n        currentPlant.selectedViewAngle\n      );\n\n      if (!allImages || allImages.length === 0) {\n        return [];\n      }\n\n      // Get current image date for comparison\n      const currentDate = new Date(currentImage.dateTime);\n      const currentImageIndex = allImages.findIndex(img => img.id === currentImage.id);\n\n      // ğŸ”§ FIX: Context-aware sync logic to prevent wrong annotations\n      // Instead of syncing to all later dates, only sync to images that come \n      // after the current image in sequence AND have later dates\n      \n      const futureImages = [];\n      \n      // Only consider images after current image in the sequence\n      for (let i = currentImageIndex + 1; i < allImages.length; i++) {\n        const image = allImages[i];\n        const imgDate = new Date(image.dateTime);\n        \n        // Only include if it's actually a later date (maintain chronological requirement)\n        if (imgDate > currentDate) {\n          futureImages.push(image);\n        }\n      }\n\n      // Sort by date to ensure chronological order\n      futureImages.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));\n\n      console.log(`ğŸ”„ Found ${futureImages.length} future images for sync (from index ${currentImageIndex + 1})`);\n      return futureImages;\n\n    } catch (error) {\n      console.error('ğŸ”„ Error getting future images:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Sync keypoint addition to future images\n   * @param {object} keypoint - The keypoint that was added\n   * @param {object} currentImage - Current image context\n   * @param {object} currentPlant - Current plant context\n   * @returns {Promise<object>} Sync result\n   */\n  async syncKeypointAddition(keypoint, currentImage, currentPlant) {\n    if (!this.isEnabled) {\n      return { success: true, message: 'Sync disabled', synced: 0 };\n    }\n\n    console.log(`ğŸ”„ Starting keypoint addition sync for keypoint ${keypoint.id}`);\n    console.log(`ğŸ”„ Current image: ${currentImage.id}, Plant: ${currentPlant.id}, View: ${currentPlant.selectedViewAngle}`);\n\n    try {\n      const futureImages = await this.getFutureImages(currentImage, currentPlant);\n      \n      if (futureImages.length === 0) {\n        console.log(`ğŸ”„ No future images found for sync`);\n        return { success: true, message: 'No future images to sync', synced: 0 };\n      }\n\n      console.log(`ğŸ”„ Found ${futureImages.length} future images:`, futureImages.map(img => img.id));\n\n      let syncedCount = 0;\n      const errors = [];\n\n      // Process each future image sequentially to avoid conflicts\n      for (const image of futureImages) {\n        try {\n          console.log(`ğŸ”„ Syncing keypoint ${keypoint.id} to image ${image.id}...`);\n          await this.addKeypointToImage(keypoint, image);\n          syncedCount++;\n          console.log(`ğŸ”„ Successfully synced to image ${image.id}`);\n        } catch (error) {\n          console.error(`ğŸ”„ Error syncing to image ${image.id}:`, error);\n          errors.push({ imageId: image.id, error: error.message });\n        }\n      }\n\n      const result = {\n        success: errors.length === 0,\n        message: `Synced to ${syncedCount} future images`,\n        synced: syncedCount,\n        errors: errors.length > 0 ? errors : undefined\n      };\n\n      console.log(`ğŸ”„ Keypoint addition sync completed:`, result);\n      return result;\n\n    } catch (error) {\n      console.error('ğŸ”„ Error in keypoint addition sync:', error);\n      return { success: false, message: error.message, synced: 0 };\n    }\n  }\n\n  /**\n   * Sync keypoint movement to future images\n   * @param {object} keypoint - The keypoint that was moved\n   * @param {object} previousPosition - Previous position {x, y}\n   * @param {object} currentImage - Current image context\n   * @param {object} currentPlant - Current plant context\n   * @returns {Promise<object>} Sync result\n   */\n  async syncKeypointMovement(keypoint, previousPosition, currentImage, currentPlant) {\n    if (!this.isEnabled) {\n      return { success: true, message: 'Sync disabled', synced: 0 };\n    }\n\n    console.log(`ğŸ”„ Starting keypoint movement sync for keypoint ${keypoint.id}`);\n\n    try {\n      const futureImages = await this.getFutureImages(currentImage, currentPlant);\n      \n      if (futureImages.length === 0) {\n        return { success: true, message: 'No future images to sync', synced: 0 };\n      }\n\n      let syncedCount = 0;\n      const errors = [];\n\n      // Process each future image sequentially\n      for (const image of futureImages) {\n        try {\n          await this.moveKeypointInImage(keypoint, image);\n          syncedCount++;\n        } catch (error) {\n          console.error(`ğŸ”„ Error syncing movement to image ${image.id}:`, error);\n          errors.push({ imageId: image.id, error: error.message });\n        }\n      }\n\n      const result = {\n        success: errors.length === 0,\n        message: `Synced movement to ${syncedCount} future images`,\n        synced: syncedCount,\n        errors: errors.length > 0 ? errors : undefined\n      };\n\n      console.log(`ğŸ”„ Keypoint movement sync completed:`, result);\n      return result;\n\n    } catch (error) {\n      console.error('ğŸ”„ Error in keypoint movement sync:', error);\n      return { success: false, message: error.message, synced: 0 };\n    }\n  }\n\n  /**\n   * Sync keypoint deletion to future images\n   * @param {object} payload - Deletion payload containing keypoint and context\n   * @returns {Promise<object>} Sync result\n   */\n  async syncKeypointDeletion(payload) {\n    if (!this.isEnabled) {\n      return { success: true, message: 'Sync disabled', synced: 0 };\n    }\n\n    const { keypoint, currentImage, currentPlant } = payload;\n\n    console.log(`ğŸ”„ Starting keypoint deletion sync for keypoint ${keypoint.id}`);\n    console.log(`ğŸ”„ Current image: ${currentImage.id}, Plant: ${currentPlant.id}, View: ${currentPlant.selectedViewAngle}`);\n\n    try {\n      const futureImages = await this.getFutureImages(currentImage, currentPlant);\n      \n      if (futureImages.length === 0) {\n        console.log(`ğŸ”„ No future images found for deletion sync`);\n        return { success: true, message: 'No future images to sync', synced: 0 };\n      }\n\n      console.log(`ğŸ”„ Found ${futureImages.length} future images:`, futureImages.map(img => img.id));\n\n      let syncedCount = 0;\n      const errors = [];\n\n      // Process each future image sequentially to avoid conflicts\n      for (const image of futureImages) {\n        try {\n          console.log(`ğŸ”„ Syncing keypoint deletion to image ${image.id}...`);\n          await this.deleteKeypointFromImage(keypoint, image);\n          syncedCount++;\n          console.log(`ğŸ”„ Successfully synced deletion to image ${image.id}`);\n        } catch (error) {\n          console.error(`ğŸ”„ Error syncing deletion to image ${image.id}:`, error);\n          errors.push({ imageId: image.id, error: error.message });\n        }\n      }\n\n      const result = {\n        success: errors.length === 0,\n        message: `Synced deletion to ${syncedCount} future images`,\n        synced: syncedCount,\n        errors: errors.length > 0 ? errors : undefined\n      };\n\n      console.log(`ğŸ”„ Keypoint deletion sync completed:`, result);\n      return result;\n\n    } catch (error) {\n      console.error('ğŸ”„ Error in keypoint deletion sync:', error);\n      return { success: false, message: error.message, synced: 0 };\n    }\n  }\n\n  /**\n   * Add keypoint to a specific image\n   * @param {object} keypoint - Keypoint to add\n   * @param {object} targetImage - Target image\n   * @returns {Promise<void>}\n   */\n  async addKeypointToImage(keypoint, targetImage) {\n    // Get existing annotations for the target image\n    const existingData = await this.annotationStorageManager.getImageAnnotation(targetImage.id);\n    const existingAnnotations = existingData ? existingData.annotations : [];\n    \n    // ğŸ”§ FIX: Use order-based matching for consistent sync behavior\n    // This is crucial for real-time sync: sync by order + type, not by ID\n    const existingKeypoint = existingAnnotations.find(ann => {\n      const orderMatch = ann.order === keypoint.order;\n      const typeMatch = ann.annotationType === keypoint.annotationType;\n      \n      // For custom annotations, customTypeId must also match\n      const customTypeMatch = keypoint.annotationType === 'custom' \n        ? ann.customTypeId === keypoint.customTypeId\n        : true;\n      \n      return orderMatch && typeMatch && customTypeMatch;\n    });\n    \n    if (existingKeypoint) {\n      // Update existing keypoint position and all properties\n      existingKeypoint.x = keypoint.x;\n      existingKeypoint.y = keypoint.y;\n      existingKeypoint.direction = keypoint.direction;\n      existingKeypoint.directionType = keypoint.directionType;\n      existingKeypoint.directions = keypoint.directions; // ğŸ”§ NEW: Support multi-direction\n      existingKeypoint.maxDirections = keypoint.maxDirections; // ğŸ”§ NEW: Support multi-direction\n      existingKeypoint.timestamp = new Date().toISOString();\n      \n      // ğŸ”§ Enhanced Debug: Log annotation details\n      const typeDesc = keypoint.annotationType === 'custom' ? \n        `custom(${keypoint.customTypeId})` : 'regular';\n      console.log(`ğŸ”„ Updated existing ${typeDesc} keypoint order ${keypoint.order} in image ${targetImage.id}`);\n    } else {\n      // Add new keypoint\n      const newKeypoint = {\n        ...keypoint,\n        timestamp: new Date().toISOString() // Update timestamp for sync\n      };\n      existingAnnotations.push(newKeypoint);\n      \n      // ğŸ”§ Enhanced Debug: Log annotation details\n      const typeDesc = keypoint.annotationType === 'custom' ? \n        `custom(${keypoint.customTypeId})` : 'regular';\n      console.log(`ğŸ”„ Added new ${typeDesc} keypoint order ${keypoint.order} to image ${targetImage.id}`);\n    }\n\n    // Prepare complete annotation data object\n    const annotationData = {\n      imageId: targetImage.id,\n      annotations: existingAnnotations,\n      lastModified: new Date().toISOString()\n    };\n\n    // Save updated annotations\n    await this.annotationStorageManager.saveImageAnnotation(targetImage.id, annotationData);\n  }\n\n  /**\n   * Move keypoint in a specific image\n   * @param {object} keypoint - Keypoint with new position\n   * @param {object} targetImage - Target image\n   * @returns {Promise<void>}\n   */\n  async moveKeypointInImage(keypoint, targetImage) {\n    // Get existing annotations for the target image\n    const existingData = await this.annotationStorageManager.getImageAnnotation(targetImage.id);\n    const existingAnnotations = existingData ? existingData.annotations : [];\n    \n    // ğŸ”§ FIX: Use order-based matching for consistent sync behavior\n    // This is crucial for real-time sync: sync by order + type, not by ID\n    const existingKeypoint = existingAnnotations.find(ann => {\n      const orderMatch = ann.order === keypoint.order;\n      const typeMatch = ann.annotationType === keypoint.annotationType;\n      \n      // For custom annotations, customTypeId must also match\n      const customTypeMatch = keypoint.annotationType === 'custom' \n        ? ann.customTypeId === keypoint.customTypeId\n        : true;\n      \n      return orderMatch && typeMatch && customTypeMatch;\n    });\n    \n    if (existingKeypoint) {\n      // Update position and all properties\n      existingKeypoint.x = keypoint.x;\n      existingKeypoint.y = keypoint.y;\n      existingKeypoint.direction = keypoint.direction;\n      existingKeypoint.directionType = keypoint.directionType;\n      existingKeypoint.directions = keypoint.directions; // ğŸ”§ NEW: Support multi-direction\n      existingKeypoint.maxDirections = keypoint.maxDirections; // ğŸ”§ NEW: Support multi-direction\n      existingKeypoint.timestamp = new Date().toISOString();\n      \n      // ğŸ”§ Enhanced Debug: Log annotation details\n      const typeDesc = keypoint.annotationType === 'custom' ? \n        `custom(${keypoint.customTypeId})` : 'regular';\n      console.log(`ğŸ”„ Moved ${typeDesc} keypoint order ${keypoint.order} in image ${targetImage.id}`);\n    } else {\n      // Add new keypoint if it doesn't exist (order-based sync)\n      const newKeypoint = {\n        ...keypoint,\n        timestamp: new Date().toISOString()\n      };\n      existingAnnotations.push(newKeypoint);\n      \n      // ğŸ”§ Enhanced Debug: Log annotation details\n      const typeDesc = keypoint.annotationType === 'custom' ? \n        `custom(${keypoint.customTypeId})` : 'regular';\n      console.log(`ğŸ”„ Added new ${typeDesc} keypoint order ${keypoint.order} to image ${targetImage.id} (move operation)`);\n    }\n\n    // Prepare complete annotation data object\n    const annotationData = {\n      imageId: targetImage.id,\n      annotations: existingAnnotations,\n      lastModified: new Date().toISOString()\n    };\n\n    // Save updated annotations\n    await this.annotationStorageManager.saveImageAnnotation(targetImage.id, annotationData);\n  }\n\n  /**\n   * Delete keypoint from a specific image with strict matching criteria\n   * @param {object} keypoint - Keypoint to delete\n   * @param {object} targetImage - Target image\n   * @returns {Promise<void>}\n   */\n  async deleteKeypointFromImage(keypoint, targetImage) {\n    // Get existing annotations for the target image\n    const existingData = await this.annotationStorageManager.getImageAnnotation(targetImage.id);\n    const existingAnnotations = existingData ? existingData.annotations : [];\n    \n    if (existingAnnotations.length === 0) {\n      console.log(`ğŸ”„ No annotations found in image ${targetImage.id} - skipping deletion`);\n      return;\n    }\n\n    // Find matching keypoint using strict criteria:\n    // 1. order must match\n    // 2. annotationType must match\n    // 3. customTypeId must match (for custom annotations)\n    const matchingIndex = existingAnnotations.findIndex(ann => {\n      const orderMatch = ann.order === keypoint.order;\n      const typeMatch = ann.annotationType === keypoint.annotationType;\n      \n      // For custom annotations, customTypeId must also match\n      const customTypeMatch = keypoint.annotationType === 'custom' \n        ? ann.customTypeId === keypoint.customTypeId\n        : true;\n      \n      return orderMatch && typeMatch && customTypeMatch;\n    });\n    \n    if (matchingIndex !== -1) {\n      const removedKeypoint = existingAnnotations[matchingIndex];\n      existingAnnotations.splice(matchingIndex, 1);\n      \n      console.log(`ğŸ”„ Deleted keypoint from image ${targetImage.id}:`);\n      console.log(`  - Order: ${removedKeypoint.order}`);\n      console.log(`  - Type: ${removedKeypoint.annotationType}`);\n      console.log(`  - Custom Type ID: ${removedKeypoint.customTypeId || 'N/A'}`);\n      console.log(`  - ID: ${removedKeypoint.id}`);\n    } else {\n      console.log(`ğŸ”„ No matching keypoint found in image ${targetImage.id} for deletion:`);\n      console.log(`  - Looking for order: ${keypoint.order}`);\n      console.log(`  - Looking for type: ${keypoint.annotationType}`);\n      console.log(`  - Looking for custom type ID: ${keypoint.customTypeId || 'N/A'}`);\n      console.log(`  - Available annotations:`, existingAnnotations.map(ann => ({\n        order: ann.order,\n        type: ann.annotationType,\n        customTypeId: ann.customTypeId,\n        id: ann.id\n      })));\n      return;\n    }\n\n    // Prepare complete annotation data object\n    const annotationData = {\n      imageId: targetImage.id,\n      annotations: existingAnnotations,\n      lastModified: new Date().toISOString()\n    };\n\n    // Save updated annotations\n    await this.annotationStorageManager.saveImageAnnotation(targetImage.id, annotationData);\n  }\n\n  /**\n   * Queue a sync operation for processing\n   * @param {object} operation - Sync operation details\n   * @returns {Promise<void>}\n   */\n  async queueSyncOperation(operation) {\n    if (!this.isEnabled) {\n      return;\n    }\n\n    this.syncQueue.push(operation);\n    \n    // Process queue if not already processing\n    if (!this.isSyncing) {\n      await this.processSyncQueue();\n    }\n  }\n\n  /**\n   * Process queued sync operations sequentially\n   * @returns {Promise<void>}\n   */\n  async processSyncQueue() {\n    if (this.isSyncing || this.syncQueue.length === 0) {\n      return;\n    }\n\n    this.isSyncing = true;\n    this.emit('syncStarted', { queueLength: this.syncQueue.length });\n\n    try {\n      while (this.syncQueue.length > 0) {\n        const operation = this.syncQueue.shift();\n        \n        try {\n          await this.executeOperation(operation);\n        } catch (error) {\n          console.error('ğŸ”„ Error executing sync operation:', error);\n          this.emit('syncError', { operation, error });\n        }\n      }\n    } finally {\n      this.isSyncing = false;\n      this.emit('syncCompleted', {});\n    }\n  }\n\n  /**\n   * Execute a specific sync operation\n   * @param {object} operation - Operation to execute\n   * @returns {Promise<void>}\n   */\n  async executeOperation(operation) {\n    const { type, keypoint, currentImage, currentPlant, previousPosition, syncData } = operation;\n\n    switch (type) {\n      case this.OPERATION_TYPES.ADD_KEYPOINT:\n        return await this.syncKeypointAddition(keypoint, currentImage, currentPlant);\n      \n      case this.OPERATION_TYPES.MOVE_KEYPOINT:\n        return await this.syncKeypointMovement(keypoint, previousPosition, currentImage, currentPlant);\n      \n      case this.OPERATION_TYPES.DELETE_KEYPOINT:\n        // ğŸ”§ FIX: Properly handle keypoint deletion sync\n        return await this.syncKeypointDeletion(operation);\n      \n      case this.OPERATION_TYPES.EDIT_DIRECTION:\n        // ğŸ”§ NEW: Direction-specific sync operation\n        return await this.syncDirectionEdit(operation);\n      \n      case this.OPERATION_TYPES.CUSTOM_ANNOTATION_CREATE:\n        return await this.syncCustomAnnotationCreate(syncData);\n      \n      case this.OPERATION_TYPES.CUSTOM_ANNOTATION_UPDATE:\n        return await this.syncCustomAnnotationUpdate(syncData);\n      \n      case this.OPERATION_TYPES.CUSTOM_ANNOTATION_DELETE:\n        return await this.syncCustomAnnotationDelete(syncData);\n      \n      case this.OPERATION_TYPES.CUSTOM_TYPE_CREATE:\n        return await this.syncCustomTypeCreate(syncData);\n      \n      default:\n        console.warn(`ğŸ”„ Unknown sync operation type: ${type}`);\n    }\n  }\n\n  /**\n   * Sync direction edit to future images\n   * @param {object} operation - Direction edit operation\n   * @returns {Promise<object>} Sync result\n   */\n  async syncDirectionEdit(operation) {\n    if (!this.isEnabled) {\n      return { success: true, message: 'Sync disabled', synced: 0 };\n    }\n\n    const { keypoint, currentImage, currentPlant } = operation;\n\n    console.log(`ğŸ”„ Starting direction edit sync for keypoint order ${keypoint.order}`);\n    console.log(`ğŸ”„ Current image: ${currentImage.id}, Plant: ${currentPlant.id}, View: ${currentPlant.selectedViewAngle}`);\n\n    try {\n      const futureImages = await this.getFutureImages(currentImage, currentPlant);\n      \n      if (futureImages.length === 0) {\n        console.log(`ğŸ”„ No future images found for direction edit sync`);\n        return { success: true, message: 'No future images to sync', synced: 0 };\n      }\n\n      console.log(`ğŸ”„ Found ${futureImages.length} future images:`, futureImages.map(img => img.id));\n\n      let syncedCount = 0;\n      const errors = [];\n\n      // Process each future image sequentially to avoid conflicts\n      for (const image of futureImages) {\n        try {\n          console.log(`ğŸ”„ Syncing direction edit to image ${image.id}...`);\n          await this.editDirectionInImage(keypoint, image);\n          syncedCount++;\n          console.log(`ğŸ”„ Successfully synced direction edit to image ${image.id}`);\n        } catch (error) {\n          console.error(`ğŸ”„ Error syncing direction edit to image ${image.id}:`, error);\n          errors.push({ imageId: image.id, error: error.message });\n        }\n      }\n\n      const result = {\n        success: errors.length === 0,\n        message: `Synced direction edit to ${syncedCount} future images`,\n        synced: syncedCount,\n        errors: errors.length > 0 ? errors : undefined\n      };\n\n      console.log(`ğŸ”„ Direction edit sync completed:`, result);\n      return result;\n\n    } catch (error) {\n      console.error('ğŸ”„ Error in direction edit sync:', error);\n      return { success: false, message: error.message, synced: 0 };\n    }\n  }\n\n  /**\n   * Edit direction in a specific image\n   * @param {object} keypoint - Keypoint with updated direction\n   * @param {object} targetImage - Target image\n   * @returns {Promise<void>}\n   */\n  async editDirectionInImage(keypoint, targetImage) {\n    // Get existing annotations for the target image\n    const existingData = await this.annotationStorageManager.getImageAnnotation(targetImage.id);\n    const existingAnnotations = existingData ? existingData.annotations : [];\n    \n    // ğŸ”§ FIX: Use order-based matching for direction edits\n    const existingKeypoint = existingAnnotations.find(ann => {\n      const orderMatch = ann.order === keypoint.order;\n      const typeMatch = ann.annotationType === keypoint.annotationType;\n      \n      // For custom annotations, customTypeId must also match\n      const customTypeMatch = keypoint.annotationType === 'custom' \n        ? ann.customTypeId === keypoint.customTypeId\n        : true;\n      \n      return orderMatch && typeMatch && customTypeMatch;\n    });\n    \n    if (existingKeypoint) {\n      // Update only direction-related properties\n      existingKeypoint.direction = keypoint.direction;\n      existingKeypoint.directionType = keypoint.directionType;\n      existingKeypoint.directions = keypoint.directions; // ğŸ”§ NEW: Support multi-direction\n      existingKeypoint.maxDirections = keypoint.maxDirections; // ğŸ”§ NEW: Support multi-direction\n      existingKeypoint.timestamp = new Date().toISOString();\n      \n      // ğŸ”§ Enhanced Debug: Log direction edit details\n      const typeDesc = keypoint.annotationType === 'custom' ? \n        `custom(${keypoint.customTypeId})` : 'regular';\n      console.log(`ğŸ”„ Updated direction for ${typeDesc} keypoint order ${keypoint.order} in image ${targetImage.id}`);\n    } else {\n      // Add new keypoint if it doesn't exist (order-based sync)\n      const newKeypoint = {\n        ...keypoint,\n        timestamp: new Date().toISOString()\n      };\n      existingAnnotations.push(newKeypoint);\n      \n      // ğŸ”§ Enhanced Debug: Log annotation details\n      const typeDesc = keypoint.annotationType === 'custom' ? \n        `custom(${keypoint.customTypeId})` : 'regular';\n      console.log(`ğŸ”„ Added new ${typeDesc} keypoint order ${keypoint.order} to image ${targetImage.id} (direction edit operation)`);\n    }\n\n    // Prepare complete annotation data object\n    const annotationData = {\n      imageId: targetImage.id,\n      annotations: existingAnnotations,\n      lastModified: new Date().toISOString()\n    };\n\n    // Save updated annotations\n    await this.annotationStorageManager.saveImageAnnotation(targetImage.id, annotationData);\n  }\n  /**\n   * Sync custom annotation creation to future images\n   * @param {object} syncData - Custom annotation sync data\n   * @returns {Promise<object>} Sync result\n   */\n  async syncCustomAnnotationCreate(syncData) {\n    console.log('ğŸ”„ Starting custom annotation creation sync:', syncData);\n    \n    try {\n      // Extract context information\n      const { annotation, context } = syncData;\n      const { appState } = context;\n      \n      if (!appState?.currentImage || !appState?.currentPlant) {\n        console.warn('ğŸ”„ Missing app state for custom annotation sync');\n        return { success: false, message: 'Missing app state', synced: 0 };\n      }\n      \n      const futureImages = await this.getFutureImages(appState.currentImage, appState.currentPlant);\n      \n      if (futureImages.length === 0) {\n        console.log('ğŸ”„ No future images found for custom annotation sync');\n        return { success: true, message: 'No future images to sync', synced: 0 };\n      }\n      \n      let syncedCount = 0;\n      const errors = [];\n      \n      // Process each future image sequentially\n      for (const image of futureImages) {\n        try {\n          console.log(`ğŸ”„ Syncing custom annotation to image ${image.id}...`);\n          await this.addCustomAnnotationToImage(annotation, image);\n          syncedCount++;\n          console.log(`ğŸ”„ Successfully synced custom annotation to image ${image.id}`);\n        } catch (error) {\n          console.error(`ğŸ”„ Error syncing custom annotation to image ${image.id}:`, error);\n          errors.push({ imageId: image.id, error: error.message });\n        }\n      }\n      \n      const result = {\n        success: errors.length === 0,\n        message: `Synced custom annotation to ${syncedCount} future images`,\n        synced: syncedCount,\n        errors: errors.length > 0 ? errors : undefined\n      };\n      \n      console.log('ğŸ”„ Custom annotation creation sync completed:', result);\n      return result;\n      \n    } catch (error) {\n      console.error('ğŸ”„ Error in custom annotation creation sync:', error);\n      return { success: false, message: error.message, synced: 0 };\n    }\n  }\n\n  /**\n   * Sync custom annotation update to future images\n   * @param {object} syncData - Custom annotation sync data\n   * @returns {Promise<object>} Sync result\n   */\n  async syncCustomAnnotationUpdate(syncData) {\n    console.log('ğŸ”„ Starting custom annotation update sync:', syncData);\n    \n    try {\n      // Extract context information\n      const { annotation, context } = syncData;\n      const { appState } = context;\n      \n      if (!appState?.currentImage || !appState?.currentPlant) {\n        console.warn('ğŸ”„ Missing app state for custom annotation update sync');\n        return { success: false, message: 'Missing app state', synced: 0 };\n      }\n      \n      const futureImages = await this.getFutureImages(appState.currentImage, appState.currentPlant);\n      \n      if (futureImages.length === 0) {\n        return { success: true, message: 'No future images to sync', synced: 0 };\n      }\n      \n      let syncedCount = 0;\n      const errors = [];\n      \n      // Process each future image sequentially\n      for (const image of futureImages) {\n        try {\n          await this.updateCustomAnnotationInImage(annotation, image);\n          syncedCount++;\n        } catch (error) {\n          console.error(`ğŸ”„ Error updating custom annotation in image ${image.id}:`, error);\n          errors.push({ imageId: image.id, error: error.message });\n        }\n      }\n      \n      const result = {\n        success: errors.length === 0,\n        message: `Updated custom annotation in ${syncedCount} future images`,\n        synced: syncedCount,\n        errors: errors.length > 0 ? errors : undefined\n      };\n      \n      console.log('ğŸ”„ Custom annotation update sync completed:', result);\n      return result;\n      \n    } catch (error) {\n      console.error('ğŸ”„ Error in custom annotation update sync:', error);\n      return { success: false, message: error.message, synced: 0 };\n    }\n  }\n\n  /**\n   * Sync custom annotation deletion to future images\n   * @param {object} syncData - Custom annotation sync data\n   * @returns {Promise<object>} Sync result\n   */\n  async syncCustomAnnotationDelete(syncData) {\n    console.log('ğŸ”„ Starting custom annotation deletion sync:', syncData);\n    \n    try {\n      // Extract context information\n      const { annotation, context } = syncData;\n      const { appState } = context;\n      \n      if (!appState?.currentImage || !appState?.currentPlant) {\n        console.warn('ğŸ”„ Missing app state for custom annotation deletion sync');\n        return { success: false, message: 'Missing app state', synced: 0 };\n      }\n      \n      const futureImages = await this.getFutureImages(appState.currentImage, appState.currentPlant);\n      \n      if (futureImages.length === 0) {\n        return { success: true, message: 'No future images to sync', synced: 0 };\n      }\n      \n      let syncedCount = 0;\n      const errors = [];\n      \n      // Process each future image sequentially\n      for (const image of futureImages) {\n        try {\n          await this.deleteCustomAnnotationFromImage(annotation, image);\n          syncedCount++;\n        } catch (error) {\n          console.error(`ğŸ”„ Error deleting custom annotation from image ${image.id}:`, error);\n          errors.push({ imageId: image.id, error: error.message });\n        }\n      }\n      \n      const result = {\n        success: errors.length === 0,\n        message: `Deleted custom annotation from ${syncedCount} future images`,\n        synced: syncedCount,\n        errors: errors.length > 0 ? errors : undefined\n      };\n      \n      console.log('ğŸ”„ Custom annotation deletion sync completed:', result);\n      return result;\n      \n    } catch (error) {\n      console.error('ğŸ”„ Error in custom annotation deletion sync:', error);\n      return { success: false, message: error.message, synced: 0 };\n    }\n  }\n\n  /**\n   * Sync custom type creation to future images\n   * @param {object} syncData - Custom type sync data\n   * @returns {Promise<object>} Sync result\n   */\n  async syncCustomTypeCreate(syncData) {\n    console.log('ğŸ”„ Starting custom type creation sync:', syncData);\n    \n    // For custom type creation, we typically don't need to sync to future images\n    // since types are global and don't belong to specific images\n    // This is more of a metadata sync that could be handled separately\n    \n    console.log('ğŸ”„ Custom type creation sync - no image sync needed');\n    return { success: true, message: 'Custom type created (no image sync required)', synced: 0 };\n  }\n\n  /**\n   * Add custom annotation to a specific image\n   * @param {object} annotation - Custom annotation to add\n   * @param {object} targetImage - Target image\n   * @returns {Promise<void>}\n   */\n  async addCustomAnnotationToImage(annotation, targetImage) {\n    // Get existing annotations for the target image\n    const existingData = await this.annotationStorageManager.getImageAnnotation(targetImage.id);\n    const existingAnnotations = existingData ? existingData.annotations : [];\n    \n    // ğŸ”§ FIX: Use order-based matching for custom annotations (not ID-based)\n    // This is the core of real-time sync: sync by order + custom type, not by ID\n    const existingCustomAnnotation = existingAnnotations.find(ann => \n      ann.annotationType === 'custom' && \n      ann.customTypeId === annotation.customTypeId &&\n      ann.order === annotation.order\n    );\n    \n    if (existingCustomAnnotation) {\n      // Update existing custom annotation with same order and type\n      Object.assign(existingCustomAnnotation, annotation);\n      existingCustomAnnotation.timestamp = new Date().toISOString();\n      \n      console.log(`ğŸ”„ Updated existing custom annotation order ${annotation.order} type ${annotation.customTypeId} in image ${targetImage.id}`);\n    } else {\n      // ğŸ”§ FIX: Remove conflict detection - order-based sync is the intended behavior\n      // The previous conflict detection was preventing legitimate sync operations\n      // Real-time sync SHOULD create annotations with same order on future frames\n      \n      // Add new custom annotation\n      const newAnnotation = {\n        ...annotation,\n        timestamp: new Date().toISOString()\n      };\n      existingAnnotations.push(newAnnotation);\n      \n      console.log(`ğŸ”„ Added new custom annotation order ${annotation.order} type ${annotation.customTypeId} to image ${targetImage.id}`);\n    }\n\n    // Prepare complete annotation data object\n    const annotationData = {\n      imageId: targetImage.id,\n      annotations: existingAnnotations,\n      lastModified: new Date().toISOString()\n    };\n\n    // Save updated annotations\n    await this.annotationStorageManager.saveImageAnnotation(targetImage.id, annotationData);\n  }\n\n  /**\n   * Update custom annotation in a specific image\n   * @param {object} annotation - Custom annotation with updates\n   * @param {object} targetImage - Target image\n   * @returns {Promise<void>}\n   */\n  async updateCustomAnnotationInImage(annotation, targetImage) {\n    // Get existing annotations for the target image\n    const existingData = await this.annotationStorageManager.getImageAnnotation(targetImage.id);\n    const existingAnnotations = existingData ? existingData.annotations : [];\n    \n    // ğŸ”§ FIX: Use order-based matching for custom annotations (not ID-based)\n    // This is crucial for move operations - we need to match by order + type, not ID\n    const existingCustomAnnotation = existingAnnotations.find(ann => \n      ann.annotationType === 'custom' && \n      ann.customTypeId === annotation.customTypeId &&\n      ann.order === annotation.order\n    );\n    \n    if (existingCustomAnnotation) {\n      // Update existing custom annotation with same order and type\n      Object.assign(existingCustomAnnotation, annotation);\n      existingCustomAnnotation.timestamp = new Date().toISOString();\n      \n      console.log(`ğŸ”„ Updated custom annotation order ${annotation.order} type ${annotation.customTypeId} in image ${targetImage.id}`);\n    } else {\n      // Add new custom annotation if it doesn't exist (order-based sync)\n      const newAnnotation = {\n        ...annotation,\n        timestamp: new Date().toISOString()\n      };\n      existingAnnotations.push(newAnnotation);\n      \n      console.log(`ğŸ”„ Added new custom annotation order ${annotation.order} type ${annotation.customTypeId} to image ${targetImage.id} (update operation)`);\n    }\n\n    // Prepare complete annotation data object\n    const annotationData = {\n      imageId: targetImage.id,\n      annotations: existingAnnotations,\n      lastModified: new Date().toISOString()\n    };\n\n    // Save updated annotations\n    await this.annotationStorageManager.saveImageAnnotation(targetImage.id, annotationData);\n  }\n\n  /**\n   * Delete custom annotation from a specific image\n   * @param {object} annotation - Custom annotation to delete\n   * @param {object} targetImage - Target image\n   * @returns {Promise<void>}\n   */\n  async deleteCustomAnnotationFromImage(annotation, targetImage) {\n    // Get existing annotations for the target image\n    const existingData = await this.annotationStorageManager.getImageAnnotation(targetImage.id);\n    const existingAnnotations = existingData ? existingData.annotations : [];\n    \n    if (existingAnnotations.length === 0) {\n      console.log(`ğŸ”„ No annotations found in image ${targetImage.id} - skipping custom annotation deletion`);\n      return;\n    }\n\n    // ğŸ”§ FIX: Use order-based matching for custom annotations (not ID-based)\n    // This is crucial for delete operations - we need to match by order + type, not ID\n    const matchingIndex = existingAnnotations.findIndex(ann => \n      ann.annotationType === 'custom' && \n      ann.customTypeId === annotation.customTypeId &&\n      ann.order === annotation.order\n    );\n    \n    if (matchingIndex !== -1) {\n      const removedAnnotation = existingAnnotations[matchingIndex];\n      existingAnnotations.splice(matchingIndex, 1);\n      \n      console.log(`ğŸ”„ Deleted custom annotation order ${removedAnnotation.order} type ${removedAnnotation.customTypeId} from image ${targetImage.id}`);\n    } else {\n      console.log(`ğŸ”„ No matching custom annotation order ${annotation.order} type ${annotation.customTypeId} found in image ${targetImage.id} for deletion`);\n      return;\n    }\n\n    // Prepare complete annotation data object\n    const annotationData = {\n      imageId: targetImage.id,\n      annotations: existingAnnotations,\n      lastModified: new Date().toISOString()\n    };\n\n    // Save updated annotations\n    await this.annotationStorageManager.saveImageAnnotation(targetImage.id, annotationData);\n  }\n\n  /**\n   * Trigger sync for keypoint addition\n   * @param {object} keypoint - Added keypoint\n   * @param {object} currentImage - Current image context\n   * @param {object} currentPlant - Current plant context\n   * @returns {Promise<void>}\n   */\n  async triggerKeypointAddSync(keypoint, currentImage, currentPlant) {\n    if (!this.isEnabled) {\n      return;\n    }\n\n    const operation = {\n      type: this.OPERATION_TYPES.ADD_KEYPOINT,\n      keypoint,\n      currentImage,\n      currentPlant,\n      timestamp: new Date().toISOString()\n    };\n\n    await this.queueSyncOperation(operation);\n  }\n\n  /**\n   * Trigger sync for keypoint movement\n   * @param {object} keypoint - Moved keypoint\n   * @param {object} previousPosition - Previous position\n   * @param {object} currentImage - Current image context\n   * @param {object} currentPlant - Current plant context\n   * @returns {Promise<void>}\n   */\n  async triggerKeypointMoveSync(keypoint, previousPosition, currentImage, currentPlant) {\n    if (!this.isEnabled) {\n      return;\n    }\n\n    const operation = {\n      type: this.OPERATION_TYPES.MOVE_KEYPOINT,\n      keypoint,\n      previousPosition,\n      currentImage,\n      currentPlant,\n      timestamp: new Date().toISOString()\n    };\n\n    await this.queueSyncOperation(operation);\n  }\n\n  /**\n   * Trigger sync for keypoint deletion\n   * @param {object} keypoint - Deleted keypoint\n   * @param {object} currentImage - Current image context\n   * @param {object} currentPlant - Current plant context\n   * @returns {Promise<void>}\n   */\n  async triggerKeypointDeleteSync(keypoint, currentImage, currentPlant) {\n    if (!this.isEnabled) {\n      return;\n    }\n\n    const operation = {\n      type: this.OPERATION_TYPES.DELETE_KEYPOINT,\n      keypoint,\n      currentImage,\n      currentPlant,\n      timestamp: new Date().toISOString()\n    };\n\n    await this.queueSyncOperation(operation);\n  }\n\n  /**\n   * Trigger sync for direction edit\n   * @param {object} keypoint - Keypoint with updated direction\n   * @param {object} currentImage - Current image context\n   * @param {object} currentPlant - Current plant context\n   * @returns {Promise<void>}\n   */\n  async triggerDirectionEditSync(keypoint, currentImage, currentPlant) {\n    if (!this.isEnabled) {\n      return;\n    }\n\n    const operation = {\n      type: this.OPERATION_TYPES.EDIT_DIRECTION,\n      keypoint,\n      currentImage,\n      currentPlant,\n      timestamp: new Date().toISOString()\n    };\n\n    await this.queueSyncOperation(operation);\n  }\n\n  /**\n   * Trigger sync for custom annotation operations\n   * @param {object} syncData - Custom annotation sync data\n   * @returns {Promise<void>}\n   */\n  async triggerCustomAnnotationSync(syncData) {\n    if (!this.isEnabled) {\n      console.log('ğŸ”„ Custom annotation sync disabled, skipping');\n      return;\n    }\n\n    console.log('ğŸ”„ Processing custom annotation sync:', syncData);\n\n    const operation = {\n      type: syncData.type,\n      syncData,\n      timestamp: new Date().toISOString()\n    };\n\n    await this.queueSyncOperation(operation);\n  }\n\n  /**\n   * Get sync statistics\n   * @returns {object} Sync statistics\n   */\n  getSyncStats() {\n    return {\n      isEnabled: this.isEnabled,\n      isSyncing: this.isSyncing,\n      queueLength: this.syncQueue.length\n    };\n  }\n\n  /**\n   * Clear sync queue\n   */\n  clearSyncQueue() {\n    this.syncQueue = [];\n    console.log('ğŸ”„ Sync queue cleared');\n  }\n\n  /**\n   * Cleanup resources\n   */\n  destroy() {\n    this.clearSyncQueue();\n    this.eventListeners.clear();\n    this.isEnabled = false;\n    this.isSyncing = false;\n    console.log('ğŸ”„ RealTimeSyncManager destroyed');\n  }\n}\n\nexport default RealTimeSyncManager;","/**\n * è‡ªå®šä¹‰æ ‡æ³¨å·¥å…·æ æ§åˆ¶å™¨\n * \n * åŠŸèƒ½ï¼š\n * - ç®¡ç†å·¥å…·æ ä¸­çš„è‡ªå®šä¹‰æ ‡æ³¨æ§ä»¶\n * - æä¾›å¿«é€Ÿæ¨¡å¼åˆ‡æ¢åŠŸèƒ½\n * - æ˜¾ç¤ºå½“å‰æ¨¡å¼å’Œç±»å‹çŠ¶æ€\n * - ä¸CustomAnnotationManageré›†æˆ\n */\n\nexport class CustomAnnotationToolbarController {\n  constructor(customAnnotationManager, settingsController) {\n    this.customAnnotationManager = customAnnotationManager;\n    this.settingsController = settingsController;\n    \n    this.initializeElements();\n    this.bindEvents();\n    this.updateDisplay();\n    \n    console.log('CustomAnnotationToolbarController initialized');\n  }\n\n  /**\n   * åˆå§‹åŒ–DOMå…ƒç´ å¼•ç”¨\n   */\n  initializeElements() {\n    // Mode status indicators\n    this.customModeIndicator = document.getElementById('custom-mode-indicator');\n    this.customTypeIndicator = document.getElementById('custom-type-indicator');\n    \n    // Controls\n    this.toolbarCustomTypeSelect = document.getElementById('toolbar-custom-type-select');\n    // Removed mode buttons (selection-driven)\n    this.switchCustomModeBtn = null;\n    this.normalModeBtn = null;\n    this.customSettingsBtn = document.getElementById('custom-settings-btn');\n  }\n\n  /**\n   * ç»‘å®šäº‹ä»¶ç›‘å¬å™¨\n   */\n  bindEvents() {\n    // Custom type selector\n    this.toolbarCustomTypeSelect.addEventListener('change', () => {\n      this.onCustomTypeSelected();\n      const selectedTypeId = this.toolbarCustomTypeSelect.value;\n      if (selectedTypeId) {\n        try {\n          this.customAnnotationManager.setCustomAnnotationMode(selectedTypeId);\n          this.showModeChangeNotification('custom', selectedTypeId);\n        } catch (error) {\n          alert(`Error switching type: ${error.message}`);\n        }\n      } else {\n        this.customAnnotationManager.setNormalMode();\n        this.showModeChangeNotification('normal');\n      }\n    });\n    \n    // Selection-driven: selecting a type immediately activates it\n    \n    // Settings button\n    this.customSettingsBtn.addEventListener('click', () => {\n      this.openSettings();\n    });\n    \n    // Listen to CustomAnnotationManager events\n    this.customAnnotationManager.addEventListener('onModeChange', () => {\n      this.updateDisplay();\n    });\n    \n    // Listen to type creation/deletion events\n    this.customAnnotationManager.addEventListener('onTypeCreate', (data) => {\n      console.log('Toolbar controller received onTypeCreate event:', data);\n      this.refreshCustomTypeSelector();\n    });\n    \n    this.customAnnotationManager.addEventListener('onTypeUpdate', (data) => {\n      console.log('Toolbar controller received onTypeUpdate event:', data);\n      this.refreshCustomTypeSelector();\n    });\n    \n    this.customAnnotationManager.addEventListener('onTypeDelete', (data) => {\n      console.log('Toolbar controller received onTypeDelete event:', data);\n      this.refreshCustomTypeSelector();\n    });\n  }\n\n  /**\n   * åˆ·æ–°è‡ªå®šä¹‰ç±»å‹é€‰æ‹©å™¨\n   */\n  refreshCustomTypeSelector() {\n    console.log('Refreshing custom type selector...');\n    \n    const customTypes = this.customAnnotationManager.getAllCustomTypes();\n    console.log('Retrieved custom types:', customTypes);\n    \n    const currentSelection = this.toolbarCustomTypeSelect.value;\n    \n    // Clear existing options\n    this.toolbarCustomTypeSelect.innerHTML = '<option value=\"\">Select custom type...</option>';\n    \n    // Add custom types\n    customTypes.forEach(type => {\n      console.log('Adding type to selector:', type);\n      const option = document.createElement('option');\n      option.value = type.id;\n      option.textContent = `${type.name} (${type.type})`;\n      option.style.color = type.color;\n      this.toolbarCustomTypeSelect.appendChild(option);\n    });\n    \n    // Restore selection if still valid\n    if (currentSelection && customTypes.find(t => t.id === currentSelection)) {\n      this.toolbarCustomTypeSelect.value = currentSelection;\n    }\n    \n    console.log('Custom type selector updated. Total options:', this.toolbarCustomTypeSelect.options.length);\n    \n    this.updateButtonStates();\n  }\n\n  /**\n   * å¤„ç†è‡ªå®šä¹‰ç±»å‹é€‰æ‹©\n   */\n  onCustomTypeSelected() {\n    this.updateButtonStates();\n  }\n\n  /**\n   * åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡å¼\n   */\n  switchToCustomMode() {\n    const selectedTypeId = this.toolbarCustomTypeSelect.value;\n    if (!selectedTypeId) {\n      alert('Please select an annotation type first.');\n      return;\n    }\n    \n    try {\n      this.customAnnotationManager.setCustomAnnotationMode(selectedTypeId);\n      this.updateDisplay();\n      this.showModeChangeNotification('custom', selectedTypeId);\n    } catch (error) {\n      alert(`Error switching to custom mode: ${error.message}`);\n    }\n  }\n\n  /**\n   * åˆ‡æ¢åˆ°æ­£å¸¸æ¨¡å¼\n   */\n  switchToNormalMode() {\n    this.customAnnotationManager.setNormalMode();\n    this.updateDisplay();\n    this.showModeChangeNotification('normal');\n  }\n\n  /**\n   * æ‰“å¼€è®¾ç½®çª—å£\n   */\n  openSettings() {\n    this.settingsController.show();\n  }\n\n  /**\n   * æ›´æ–°æ˜¾ç¤ºçŠ¶æ€\n   */\n  updateDisplay() {\n    this.updateModeIndicators();\n    this.updateButtonStates();\n  }\n\n  /**\n   * æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨\n   */\n  updateModeIndicators() {\n    const currentMode = this.customAnnotationManager.currentMode;\n    const selectedType = this.customAnnotationManager.getCurrentCustomType();\n    \n    // Update mode indicator\n    if (currentMode === 'custom') {\n      this.customModeIndicator.textContent = 'Type';\n      this.customModeIndicator.style.color = '#059669';\n      this.customModeIndicator.style.fontWeight = '600';\n    } else {\n      this.customModeIndicator.textContent = 'Off';\n      this.customModeIndicator.style.color = 'var(--text-primary)';\n      this.customModeIndicator.style.fontWeight = '500';\n    }\n    \n    // Update type indicator\n    if (selectedType) {\n      this.customTypeIndicator.textContent = selectedType.name;\n      this.customTypeIndicator.style.color = selectedType.color;\n      this.customTypeIndicator.style.fontWeight = '600';\n      \n      // Add type badge\n      const typeBadge = selectedType.type === 'point' ? 'â—' : 'â–­';\n      this.customTypeIndicator.textContent = `${typeBadge} ${selectedType.name}`;\n    } else {\n      this.customTypeIndicator.textContent = 'None';\n      this.customTypeIndicator.style.color = 'var(--text-secondary)';\n      this.customTypeIndicator.style.fontWeight = '500';\n    }\n  }\n\n  /**\n   * æ›´æ–°æŒ‰é’®çŠ¶æ€\n   */\n  updateButtonStates() {\n    const currentMode = this.customAnnotationManager.currentMode;\n    const selectedTypeId = this.toolbarCustomTypeSelect.value;\n    const hasCustomTypes = this.customAnnotationManager.getAllCustomTypes().length > 0;\n    \n    // Always enable selector; selection applies immediately\n    this.toolbarCustomTypeSelect.disabled = false;\n\n    // Show/hide message based on availability\n    if (!hasCustomTypes) {\n      this.toolbarCustomTypeSelect.style.display = 'none';\n      // buttons removed\n      \n      // Show message to create types\n      this.showNoTypesMessage();\n    } else {\n      this.toolbarCustomTypeSelect.style.display = 'block';\n      this.hideNoTypesMessage();\n    }\n  }\n\n  /**\n   * æ˜¾ç¤ºæ— ç±»å‹æ¶ˆæ¯\n   */\n  showNoTypesMessage() {\n    let message = document.getElementById('no-custom-types-message');\n    if (!message) {\n      message = document.createElement('div');\n      message.id = 'no-custom-types-message';\n      message.style.cssText = `\n        padding: 8px;\n        background: var(--bg-secondary);\n        border: 1px dashed var(--border-color);\n        border-radius: 4px;\n        text-align: center;\n        font-size: 0.75rem;\n        color: var(--text-secondary);\n        margin-bottom: 10px;\n      `;\n      message.innerHTML = `\n        <div style=\"margin-bottom: 4px;\">No annotation types created</div>\n        <div style=\"font-size: 0.7rem;\">Click Annotation Type Setting to create types</div>\n      `;\n      \n      this.toolbarCustomTypeSelect.parentNode.appendChild(message);\n    }\n    message.style.display = 'block';\n  }\n\n  /**\n   * éšè—æ— ç±»å‹æ¶ˆæ¯\n   */\n  hideNoTypesMessage() {\n    const message = document.getElementById('no-custom-types-message');\n    if (message) {\n      message.style.display = 'none';\n    }\n  }\n\n  /**\n   * æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢é€šçŸ¥\n   */\n  showModeChangeNotification(mode, typeId = null) {\n    const notification = document.createElement('div');\n    notification.style.cssText = `\n      position: fixed;\n      top: 80px;\n      right: 20px;\n      background: var(--bg-primary);\n      border: 1px solid var(--border-color);\n      border-radius: 6px;\n      padding: 12px 16px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      z-index: 1000;\n      font-size: 0.875rem;\n      max-width: 300px;\n      animation: slideInRight 0.3s ease-out;\n    `;\n    \n    if (mode === 'custom') {\n      const customType = this.customAnnotationManager.getCustomType(typeId);\n      const typeIcon = customType.type === 'point' ? 'â—' : 'â–­';\n      notification.innerHTML = `\n        <div style=\"display: flex; align-items: center; gap: 8px; margin-bottom: 4px;\">\n          <span style=\"color: #059669; font-size: 1.2em;\">ğŸ¯</span>\n          <strong style=\"color: #059669;\">Custom Mode Active</strong>\n        </div>\n        <div style=\"color: var(--text-secondary); font-size: 0.8rem;\">\n          Type: <span style=\"color: ${customType.color}; font-weight: 600;\">${typeIcon} ${customType.name}</span>\n        </div>\n        <div style=\"color: var(--text-secondary); font-size: 0.75rem; margin-top: 4px;\">\n          ${customType.type === 'point' ? 'Click to place points' : 'Drag to draw regions'}\n        </div>\n      `;\n    } else {\n      notification.innerHTML = `\n        <div style=\"display: flex; align-items: center; gap: 8px;\">\n          <span style=\"color: var(--text-primary); font-size: 1.2em;\">âšª</span>\n          <strong style=\"color: var(--text-primary);\">Normal Mode</strong>\n        </div>\n        <div style=\"color: var(--text-secondary); font-size: 0.8rem;\">\n          Standard keypoint annotation\n        </div>\n      `;\n    }\n    \n    // Add animation styles if not already present\n    if (!document.getElementById('notification-animation-style')) {\n      const style = document.createElement('style');\n      style.id = 'notification-animation-style';\n      style.textContent = `\n        @keyframes slideInRight {\n          from {\n            transform: translateX(100%);\n            opacity: 0;\n          }\n          to {\n            transform: translateX(0);\n            opacity: 1;\n          }\n        }\n        @keyframes slideOutRight {\n          from {\n            transform: translateX(0);\n            opacity: 1;\n          }\n          to {\n            transform: translateX(100%);\n            opacity: 0;\n          }\n        }\n      `;\n      document.head.appendChild(style);\n    }\n    \n    document.body.appendChild(notification);\n    \n    // Auto-remove after 3 seconds\n    setTimeout(() => {\n      notification.style.animation = 'slideOutRight 0.3s ease-in';\n      setTimeout(() => {\n        if (notification.parentElement) {\n          notification.remove();\n        }\n      }, 300);\n    }, 3000);\n  }\n\n  /**\n   * åˆå§‹åŒ–å·¥å…·æ ï¼ˆåœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼‰\n   */\n  initialize() {\n    console.log('Initializing custom annotation toolbar controller...');\n    this.refreshCustomTypeSelector();\n    this.updateDisplay();\n  }\n\n  /**\n   * å¼ºåˆ¶åˆ·æ–°å·¥å…·æ çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•æˆ–æ‰‹åŠ¨åŒæ­¥ï¼‰\n   */\n  forceRefresh() {\n    console.log('Force refreshing toolbar controller...');\n    this.refreshCustomTypeSelector();\n    this.updateDisplay();\n  }\n\n  /**\n   * è·å–å½“å‰é€‰ä¸­çš„è‡ªå®šä¹‰ç±»å‹ID\n   */\n  getSelectedCustomTypeId() {\n    return this.toolbarCustomTypeSelect.value;\n  }\n\n  /**\n   * è®¾ç½®é€‰ä¸­çš„è‡ªå®šä¹‰ç±»å‹\n   */\n  setSelectedCustomType(typeId) {\n    this.toolbarCustomTypeSelect.value = typeId;\n    this.updateButtonStates();\n  }\n\n  /**\n   * æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„è‡ªå®šä¹‰ç±»å‹\n   */\n  hasCustomTypes() {\n    return this.customAnnotationManager.getAllCustomTypes().length > 0;\n  }\n\n  /**\n   * è·å–å·¥å…·æ çŠ¶æ€æ‘˜è¦\n   */\n  getStatusSummary() {\n    const currentMode = this.customAnnotationManager.currentMode;\n    const selectedType = this.customAnnotationManager.getCurrentCustomType();\n    const totalTypes = this.customAnnotationManager.getAllCustomTypes().length;\n    \n    return {\n      mode: currentMode,\n      selectedType: selectedType ? {\n        id: selectedType.id,\n        name: selectedType.name,\n        type: selectedType.type,\n        color: selectedType.color\n      } : null,\n      totalCustomTypes: totalTypes,\n      hasCustomTypes: totalTypes > 0\n    };\n  }\n}","/**\n * è‡ªå®šä¹‰æ ‡æ³¨è®¾ç½®çª—å£æ§åˆ¶å™¨\n * \n * åŠŸèƒ½ï¼š\n * - ç®¡ç†è‡ªå®šä¹‰æ ‡æ³¨ç±»å‹çš„åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤\n * - æä¾›æ¨¡å¼åˆ‡æ¢ç•Œé¢\n * - å¤„ç†å¯¼å…¥å¯¼å‡ºåŠŸèƒ½\n * - ä¸CustomAnnotationManageré›†æˆ\n */\n\nexport class CustomAnnotationSettingsController {\n  constructor(customAnnotationManager) {\n    this.customAnnotationManager = customAnnotationManager;\n    this.modal = null;\n    this.currentEditingTypeId = null;\n    this.currentTab = 'manage-types';\n    \n    this.initializeElements();\n    this.bindEvents();\n    \n    console.log('CustomAnnotationSettingsController initialized');\n  }\n\n  /**\n   * åˆå§‹åŒ–DOMå…ƒç´ å¼•ç”¨\n   */\n  initializeElements() {\n    this.modal = document.getElementById('custom-annotation-settings-modal');\n    this.closeBtn = document.getElementById('custom-annotation-settings-close');\n    \n    // Tab elements\n    this.tabButtons = document.querySelectorAll('.tab-button');\n    this.tabContents = document.querySelectorAll('.tab-content');\n    \n    // Manage Types tab elements\n    this.customTypesList = document.getElementById('custom-types-list');\n    this.noCustomTypesMessage = document.getElementById('no-custom-types');\n    this.addTypeBtn = document.getElementById('add-custom-type-btn');\n    this.typeFormSection = document.getElementById('type-form-section');\n    this.typeForm = document.getElementById('custom-type-form');\n    this.formTitle = document.getElementById('form-title');\n    this.formSubmitText = document.getElementById('form-submit-text');\n    this.cancelFormBtn = document.getElementById('cancel-form-btn');\n    \n    // Form inputs\n    this.typeNameInput = document.getElementById('type-name');\n    this.typeIdInput = document.getElementById('type-id');\n    this.typeTypeSelect = document.getElementById('type-type');\n    this.typeColorInput = document.getElementById('type-color');\n    this.typeColorTextInput = document.getElementById('type-color-text');\n    this.typeDescriptionInput = document.getElementById('type-description');\n    this.typeCategoryInput = document.getElementById('type-category');\n    // Default angle for keypoint types\n    this.typeDefaultAngleGroup = document.getElementById('type-default-angle-group');\n    this.typeDefaultAngleInput = document.getElementById('type-default-angle');\n    this.typeIsDirectionalInput = document.getElementById('type-is-directional');\n    this.associateTypeSelect = document.getElementById('associate-type-select');\n    \n    // Current Mode tab elements\n    this.currentModeValue = document.getElementById('current-mode-value');\n    this.currentTypeValue = document.getElementById('current-type-value');\n    this.switchToNormalBtn = document.getElementById('switch-to-normal-btn');\n    this.selectCustomTypeSelect = document.getElementById('select-custom-type');\n    this.switchToCustomBtn = document.getElementById('switch-to-custom-btn');\n    \n    // Export/Import tab elements\n    this.exportTypesCount = document.getElementById('export-types-count');\n    this.exportAnnotationsCount = document.getElementById('export-annotations-count');\n    this.exportCustomDataBtn = document.getElementById('export-custom-data-btn');\n    this.selectImportFileBtn = document.getElementById('select-import-file-btn');\n    this.importFileInput = document.getElementById('import-file-input');\n    this.importFileInfo = document.getElementById('import-file-info');\n    this.importFileName = document.getElementById('import-file-name');\n    this.importExecuteBtn = document.getElementById('import-execute-btn');\n    this.importResults = document.getElementById('import-results');\n    this.importResultsContent = document.getElementById('import-results-content');\n  }\n\n  /**\n   * ç»‘å®šäº‹ä»¶ç›‘å¬å™¨\n   */\n  bindEvents() {\n    // Modal close\n    this.closeBtn.addEventListener('click', () => this.hide());\n    this.modal.addEventListener('click', (e) => {\n      if (e.target === this.modal) this.hide();\n    });\n    \n    // Tab switching\n    this.tabButtons.forEach(button => {\n      button.addEventListener('click', () => {\n        const tabName = button.dataset.tab;\n        this.switchTab(tabName);\n      });\n    });\n    \n    // Manage Types tab events\n    this.addTypeBtn.addEventListener('click', () => this.showAddTypeForm());\n    this.cancelFormBtn.addEventListener('click', () => this.hideTypeForm());\n    this.typeForm.addEventListener('submit', (e) => this.handleFormSubmit(e));\n    \n    // Color input synchronization\n    this.typeColorInput.addEventListener('input', () => {\n      this.typeColorTextInput.value = this.typeColorInput.value;\n    });\n    this.typeColorTextInput.addEventListener('input', () => {\n      if (/^#[0-9A-Fa-f]{6}$/.test(this.typeColorTextInput.value)) {\n        this.typeColorInput.value = this.typeColorTextInput.value;\n      }\n    });\n    \n    // Type name to ID auto-generation\n    this.typeNameInput.addEventListener('input', () => {\n      if (!this.currentEditingTypeId) {\n        const id = this.generateIdFromName(this.typeNameInput.value);\n        this.typeIdInput.value = id;\n      }\n    });\n\n    // Populate association options when opening form or list refreshes\n    // (called from showAddTypeForm/editCustomType via helper)\n\n    // Show/hide default angle field when type changes\n    this.typeTypeSelect.addEventListener('change', () => this.updateAngleVisibility());\n    \n    // Current Type events: selection-driven, no buttons\n    if (this.switchToNormalBtn) {\n      this.switchToNormalBtn.style.display = 'none';\n    }\n    if (this.switchToCustomBtn) {\n      this.switchToCustomBtn.style.display = 'none';\n    }\n    this.selectCustomTypeSelect.addEventListener('change', () => {\n      const typeId = this.selectCustomTypeSelect.value;\n      if (typeId) {\n        this.customAnnotationManager.setCustomAnnotationMode(typeId);\n      } else {\n        this.customAnnotationManager.setNormalMode();\n      }\n      this.updateModeDisplay();\n    });\n    \n    // Export/Import tab events\n    this.exportCustomDataBtn.addEventListener('click', () => this.exportCustomData());\n    this.selectImportFileBtn.addEventListener('click', () => this.importFileInput.click());\n    this.importFileInput.addEventListener('change', () => this.handleFileSelection());\n    this.importExecuteBtn.addEventListener('click', () => this.executeImport());\n    \n    // Listen to CustomAnnotationManager events\n    this.customAnnotationManager.addEventListener('onModeChange', (data) => {\n      this.updateModeDisplay();\n    });\n  }\n\n  /**\n   * æ˜¾ç¤ºè®¾ç½®çª—å£\n   */\n  show() {\n    this.refreshAllData();\n    this.modal.style.display = 'flex';\n  }\n\n  /**\n   * éšè—è®¾ç½®çª—å£\n   */\n  hide() {\n    this.modal.style.display = 'none';\n    this.hideTypeForm();\n  }\n\n  /**\n   * åˆ‡æ¢é€‰é¡¹å¡\n   */\n  switchTab(tabName) {\n    this.currentTab = tabName;\n    \n    // Update tab buttons\n    this.tabButtons.forEach(button => {\n      if (button.dataset.tab === tabName) {\n        button.classList.add('active');\n      } else {\n        button.classList.remove('active');\n      }\n    });\n    \n    // Update tab contents\n    this.tabContents.forEach(content => {\n      if (content.id === `${tabName}-tab`) {\n        content.classList.add('active');\n      } else {\n        content.classList.remove('active');\n      }\n    });\n    \n    // Refresh data for the active tab\n    this.refreshTabData(tabName);\n  }\n\n  /**\n   * åˆ·æ–°æŒ‡å®šé€‰é¡¹å¡çš„æ•°æ®\n   */\n  refreshTabData(tabName) {\n    switch (tabName) {\n      case 'manage-types':\n        this.refreshCustomTypesList();\n        break;\n      case 'current-mode':\n        this.updateModeDisplay();\n        this.refreshCustomTypeSelector();\n        break;\n      case 'export-import':\n        this.updateExportStats();\n        break;\n    }\n  }\n\n  /**\n   * åˆ·æ–°æ‰€æœ‰æ•°æ®\n   */\n  refreshAllData() {\n    this.refreshCustomTypesList();\n    this.updateModeDisplay();\n    this.refreshCustomTypeSelector();\n    this.updateExportStats();\n  }\n\n  /**\n   * åˆ·æ–°è‡ªå®šä¹‰ç±»å‹åˆ—è¡¨\n   */\n  refreshCustomTypesList() {\n    const customTypes = this.customAnnotationManager.getAllCustomTypes();\n    \n    if (customTypes.length === 0) {\n      this.customTypesList.innerHTML = `\n        <div id=\"no-custom-types\" class=\"placeholder-message\" style=\"text-align: center; color: #6b7280; padding: 40px;\">\n          <div style=\"font-size: 48px; margin-bottom: 16px;\">ğŸ¯</div>\n          <h4 style=\"margin: 0 0 8px 0;\">No Custom Types Created</h4>\n          <p style=\"margin: 0;\">Create custom annotation types for special keypoints and regions</p>\n        </div>\n      `;\n    } else {\n      const typesList = customTypes.map(type => this.createTypeItemHTML(type)).join('');\n      this.customTypesList.innerHTML = typesList;\n      \n      // Bind action buttons\n      this.bindTypeActionButtons();\n\n      // Also refresh associate options if form is visible\n      if (this.typeFormSection && this.typeFormSection.style.display !== 'none' && this.associateTypeSelect) {\n        this.populateAssociateOptions(this.currentEditingTypeId);\n      }\n    }\n  }\n\n  /**\n   * å¡«å……å…³è”ç±»å‹ä¸‹æ‹‰ï¼ˆæ’é™¤è‡ªèº«ï¼‰\n   */\n  populateAssociateOptions(currentId) {\n    if (!this.associateTypeSelect) return;\n    const types = this.customAnnotationManager.getAllCustomTypes();\n    this.associateTypeSelect.innerHTML = '<option value=\"\">None</option>';\n    types.forEach(t => {\n      if (t.id === currentId) return;\n      const opt = document.createElement('option');\n      opt.value = t.id;\n      const label = t.type === 'point' ? 'keypoint' : (t.type === 'region' ? 'rectangle' : t.type);\n      opt.textContent = `${t.name} (${label})`;\n      this.associateTypeSelect.appendChild(opt);\n    });\n  }\n\n  /**\n   * åˆ›å»ºç±»å‹é¡¹HTML\n   */\n  createTypeItemHTML(type) {\n    const typeLabel = type.type === 'point' ? 'keypoint' : (type.type === 'region' ? 'rectangle' : type.type);\n    return `\n      <div class=\"custom-type-item\" data-type-id=\"${type.id}\">\n        <div class=\"custom-type-info\">\n          <div class=\"type-color-preview\" style=\"background-color: ${type.color};\"></div>\n          <div class=\"type-details\">\n            <div class=\"type-name\">${type.name}</div>\n            <div class=\"type-meta\">\n              <span class=\"type-badge ${type.type}\">${typeLabel}</span>\n              <span>ID: ${type.id}</span>\n              ${type.metadata?.category ? `<span>Category: ${type.metadata.category}</span>` : ''}\n            </div>\n          </div>\n        </div>\n        <div class=\"type-actions\">\n          <button class=\"type-action-btn edit\" data-action=\"edit\" data-type-id=\"${type.id}\">Edit</button>\n          <button class=\"type-action-btn delete\" data-action=\"delete\" data-type-id=\"${type.id}\">Delete</button>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * ç»‘å®šç±»å‹æ“ä½œæŒ‰é’®äº‹ä»¶\n   */\n  bindTypeActionButtons() {\n    const actionButtons = this.customTypesList.querySelectorAll('.type-action-btn');\n    actionButtons.forEach(button => {\n      button.addEventListener('click', () => {\n        const action = button.dataset.action;\n        const typeId = button.dataset.typeId;\n        \n        if (action === 'edit') {\n          this.editCustomType(typeId);\n        } else if (action === 'delete') {\n          this.deleteCustomType(typeId);\n        }\n      });\n    });\n  }\n\n  /**\n   * æ˜¾ç¤ºæ·»åŠ ç±»å‹è¡¨å•\n   */\n  showAddTypeForm() {\n    this.currentEditingTypeId = null;\n    this.formTitle.textContent = 'Add New Type';\n    this.formSubmitText.textContent = 'Create Type';\n    this.typeForm.reset();\n    this.typeColorInput.value = '#ff6b35';\n    this.typeColorTextInput.value = '#ff6b35';\n    if (this.typeDefaultAngleInput) {\n      this.typeDefaultAngleInput.value = '';\n    }\n    if (this.associateTypeSelect) {\n      this.populateAssociateOptions(null);\n      this.associateTypeSelect.value = '';\n    }\n    this.typeFormSection.style.display = 'block';\n    this.updateAngleVisibility();\n  }\n\n  /**\n   * ç¼–è¾‘è‡ªå®šä¹‰ç±»å‹\n   */\n  editCustomType(typeId) {\n    const type = this.customAnnotationManager.getCustomType(typeId);\n    if (!type) return;\n    \n    this.currentEditingTypeId = typeId;\n    this.formTitle.textContent = 'Edit Type';\n    this.formSubmitText.textContent = 'Update Type';\n    \n    // Fill form with existing data\n    this.typeNameInput.value = type.name;\n    this.typeIdInput.value = type.id;\n    this.typeTypeSelect.value = type.type;\n    this.typeColorInput.value = type.color;\n    this.typeColorTextInput.value = type.color;\n    this.typeDescriptionInput.value = type.description || '';\n    this.typeCategoryInput.value = type.metadata?.category || '';\n    if (this.typeDefaultAngleInput) {\n      const angle = type.metadata?.defaultAngle;\n      this.typeDefaultAngleInput.value = (angle ?? '').toString();\n    }\n    if (this.typeIsDirectionalInput) {\n      this.typeIsDirectionalInput.checked = !!type.metadata?.isDirectional;\n    }\n    if (this.associateTypeSelect) {\n      this.populateAssociateOptions(typeId);\n      this.associateTypeSelect.value = type.metadata?.associateTypeId || '';\n    }\n    \n    // Disable ID and geometry fields for editing\n    this.typeIdInput.disabled = true;\n    this.typeTypeSelect.disabled = true;\n    \n    this.typeFormSection.style.display = 'block';\n    this.updateAngleVisibility();\n  }\n\n  /**\n   * åˆ é™¤è‡ªå®šä¹‰ç±»å‹\n   */\n  deleteCustomType(typeId) {\n    const type = this.customAnnotationManager.getCustomType(typeId);\n    if (!type) return;\n    \n    if (confirm(`Are you sure you want to delete the custom type \"${type.name}\"? This will also delete all annotations of this type.`)) {\n      this.customAnnotationManager.deleteCustomType(typeId);\n      this.refreshCustomTypesList();\n      this.refreshCustomTypeSelector();\n    }\n  }\n\n  /**\n   * éšè—ç±»å‹è¡¨å•\n   */\n  hideTypeForm() {\n    this.typeFormSection.style.display = 'none';\n    this.currentEditingTypeId = null;\n    this.typeIdInput.disabled = false;\n    this.typeTypeSelect.disabled = false;\n  }\n\n  /**\n   * å¤„ç†è¡¨å•æäº¤\n   */\n  handleFormSubmit(e) {\n    e.preventDefault();\n    \n    const formData = new FormData(this.typeForm);\n    const typeData = {\n      id: formData.get('id'),\n      name: formData.get('name'),\n      type: formData.get('type'),\n      color: formData.get('color'),\n      description: formData.get('description'),\n      metadata: {\n        category: formData.get('category')\n      }\n    };\n\n    // Directional toggle\n    if (this.typeIsDirectionalInput && this.typeIsDirectionalInput.checked) {\n      typeData.metadata.isDirectional = true;\n    } else {\n      typeData.metadata.isDirectional = false;\n    }\n    // Association selection\n    if (this.associateTypeSelect && this.associateTypeSelect.value) {\n      typeData.metadata.associateTypeId = this.associateTypeSelect.value;\n    } else {\n      delete typeData.metadata.associateTypeId;\n    }\n\n    // Attach default angle for keypoint types\n    if (typeData.type === 'point') {\n      const rawAngle = (this.typeDefaultAngleInput?.value || '').trim();\n      if (rawAngle !== '') {\n        const parsed = parseFloat(rawAngle);\n        if (!Number.isNaN(parsed)) {\n          typeData.metadata.defaultAngle = parsed;\n        }\n      }\n    }\n    \n    try {\n      if (this.currentEditingTypeId) {\n        // Update existing type\n        // Do not allow changing geometry type on update\n        const { type, ...safeUpdate } = typeData;\n        this.customAnnotationManager.updateCustomType(this.currentEditingTypeId, safeUpdate);\n      } else {\n        // Create new type\n        this.customAnnotationManager.createCustomType(typeData);\n      }\n      \n      this.hideTypeForm();\n      this.refreshCustomTypesList();\n      this.refreshCustomTypeSelector();\n      \n    } catch (error) {\n      alert(`Error: ${error.message}`);\n    }\n  }\n\n  /**\n   * ä»åç§°ç”ŸæˆID\n   */\n  generateIdFromName(name) {\n    return name\n      .toLowerCase()\n      .replace(/[^a-z0-9\\u4e00-\\u9fff]/g, '-')\n      .replace(/-+/g, '-')\n      .replace(/^-|-$/g, '')\n      .substring(0, 50);\n  }\n\n  /**\n   * æ›´æ–°æ¨¡å¼æ˜¾ç¤º\n   */\n  updateModeDisplay() {\n    const currentMode = this.customAnnotationManager.currentMode;\n    const selectedType = this.customAnnotationManager.getCurrentCustomType();\n    \n    this.currentModeValue.textContent = currentMode === 'custom' ? 'Type' : 'Off';\n    this.currentTypeValue.textContent = selectedType ? selectedType.name : 'None';\n    \n    // Update button states\n    if (this.switchToNormalBtn) {\n      this.switchToNormalBtn.disabled = currentMode === 'normal';\n    }\n  }\n\n  /**\n   * åˆ·æ–°è‡ªå®šä¹‰ç±»å‹é€‰æ‹©å™¨\n   */\n  refreshCustomTypeSelector() {\n    const customTypes = this.customAnnotationManager.getAllCustomTypes();\n    \n    this.selectCustomTypeSelect.innerHTML = '<option value=\"\">Choose a type...</option>';\n    \n    customTypes.forEach(type => {\n      // å°†å†…ç½®ç±»å‹æ”¾åˆ°åˆ—è¡¨é¡¶éƒ¨\n      const option = document.createElement('option');\n      option.value = type.id;\n      const typeLabel = type.type === 'point' ? 'keypoint' : (type.type === 'region' ? 'rectangle' : type.type);\n      const prefix = type.metadata?.builtin ? 'â˜… ' : '';\n      option.textContent = `${prefix}${type.name} (${typeLabel})`;\n      this.selectCustomTypeSelect.appendChild(option);\n    });\n\n    // å¦‚æœåˆ—è¡¨å­˜åœ¨å†…ç½®ç±»å‹ï¼Œå°†å…¶ç§»åˆ°ç¬¬ä¸€é¡¹ä¹‹å\n    const options = Array.from(this.selectCustomTypeSelect.options);\n    const builtinIdx = options.findIndex(opt => opt.value === 'builtin-regular-keypoint');\n    if (builtinIdx > 1) {\n      const opt = options[builtinIdx];\n      this.selectCustomTypeSelect.remove(builtinIdx);\n      this.selectCustomTypeSelect.add(opt, 1);\n    }\n    \n    if (this.switchToCustomBtn) {\n      this.switchToCustomBtn.disabled = true;\n    }\n  }\n\n  /**\n   * åˆ‡æ¢åˆ°æ­£å¸¸æ¨¡å¼\n   */\n  switchToNormalMode() {\n    this.customAnnotationManager.setNormalMode();\n    this.updateModeDisplay();\n  }\n\n  /**\n   * åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡å¼\n   */\n  switchToCustomMode() {\n    const selectedTypeId = this.selectCustomTypeSelect.value;\n    if (!selectedTypeId) return;\n    \n    try {\n      this.customAnnotationManager.setCustomAnnotationMode(selectedTypeId);\n      this.updateModeDisplay();\n    } catch (error) {\n      alert(`Error: ${error.message}`);\n    }\n  }\n\n  /**\n   * æ ¹æ®é€‰æ‹©çš„ç±»å‹æ˜¾ç¤º/éšè—é»˜è®¤è§’åº¦å­—æ®µ\n   */\n  updateAngleVisibility() {\n    if (!this.typeDefaultAngleGroup) return;\n    const isPoint = this.typeTypeSelect.value === 'point';\n    this.typeDefaultAngleGroup.style.display = isPoint ? 'flex' : 'none';\n  }\n\n  /**\n   * æ›´æ–°å¯¼å‡ºç»Ÿè®¡\n   */\n  updateExportStats() {\n    const customTypes = this.customAnnotationManager.getAllCustomTypes();\n    const stats = this.customAnnotationManager.getStats();\n    \n    this.exportTypesCount.textContent = customTypes.length;\n    this.exportAnnotationsCount.textContent = stats.totalAnnotations;\n    \n    // ğŸ”§ NEW: æ·»åŠ å½“å‰å›¾åƒçš„æ ‡æ³¨ç»Ÿè®¡\n    const appState = window.PlantAnnotationTool?.appState;\n    const currentImageId = appState?.currentImage?.id;\n    \n    if (currentImageId) {\n      const imageStats = this.customAnnotationManager.getAnnotationStats(currentImageId);\n      this.updateCurrentImageStats(imageStats);\n    }\n  }\n\n  /**\n   * æ›´æ–°å½“å‰å›¾åƒçš„æ ‡æ³¨ç»Ÿè®¡æ˜¾ç¤º\n   * @param {Object} imageStats - å›¾åƒç»Ÿè®¡ä¿¡æ¯\n   */\n  updateCurrentImageStats(imageStats) {\n    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨å½“å‰å›¾åƒç»Ÿè®¡æ˜¾ç¤ºåŒºåŸŸ\n    let currentImageStatsDiv = document.getElementById('current-image-stats');\n    if (!currentImageStatsDiv) {\n      // åˆ›å»ºç»Ÿè®¡æ˜¾ç¤ºåŒºåŸŸ\n      currentImageStatsDiv = document.createElement('div');\n      currentImageStatsDiv.id = 'current-image-stats';\n      currentImageStatsDiv.style.cssText = `\n        margin-top: 16px;\n        padding: 12px;\n        background: #f8f9fa;\n        border-radius: 6px;\n        border: 1px solid #e5e7eb;\n      `;\n      \n      // å°†å…¶æ·»åŠ åˆ°å¯¼å‡ºç»Ÿè®¡åé¢\n      const exportSection = document.querySelector('.export-stats');\n      if (exportSection) {\n        exportSection.appendChild(currentImageStatsDiv);\n      }\n    }\n    \n    // æ›´æ–°ç»Ÿè®¡å†…å®¹\n    let statsHtml = `\n      <div style=\"font-weight: 600; margin-bottom: 8px; color: #374151;\">\n        ğŸ“Š Current Image Statistics\n      </div>\n      <div style=\"margin-bottom: 8px;\">\n        Total Annotations: <span style=\"font-weight: 600;\">${imageStats.total}</span>\n      </div>\n    `;\n    \n    if (imageStats.total > 0) {\n      statsHtml += `\n        <div style=\"margin-bottom: 8px;\">\n          Order Range: #${imageStats.orderRange.min} - #${imageStats.orderRange.max}\n        </div>\n      `;\n      \n      if (imageStats.gaps.length > 0) {\n        statsHtml += `\n          <div style=\"margin-bottom: 8px; color: #f59e0b;\">\n            âš ï¸ Missing Numbers: ${imageStats.gaps.join(', ')}\n          </div>\n        `;\n      }\n      \n      // æŒ‰ç±»å‹ç»Ÿè®¡\n      const typeStats = Object.entries(imageStats.byType).map(([typeId, info]) => {\n        return `\n          <div style=\"display: flex; align-items: center; gap: 8px; margin-bottom: 4px;\">\n            <div style=\"width: 12px; height: 12px; background: ${info.typeColor}; border-radius: 50%;\"></div>\n            <span>${info.typeName}: ${info.count}</span>\n          </div>\n        `;\n      }).join('');\n      \n      if (typeStats) {\n        statsHtml += `\n          <div style=\"margin-top: 12px;\">\n            <div style=\"font-weight: 600; margin-bottom: 6px; color: #374151;\">By Type:</div>\n            ${typeStats}\n          </div>\n        `;\n      }\n    }\n    \n    currentImageStatsDiv.innerHTML = statsHtml;\n  }\n\n  /**\n   * å¯¼å‡ºè‡ªå®šä¹‰æ•°æ®\n   */\n  exportCustomData() {\n    const exportData = this.customAnnotationManager.exportData();\n    const blob = new Blob([JSON.stringify(exportData, null, 2)], {\n      type: 'application/json'\n    });\n    \n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `custom_annotations_${new Date().toISOString().split('T')[0]}.json`;\n    \n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    \n    URL.revokeObjectURL(url);\n    \n    console.log('Custom annotation data exported');\n  }\n\n  /**\n   * å¤„ç†æ–‡ä»¶é€‰æ‹©\n   */\n  handleFileSelection() {\n    const file = this.importFileInput.files[0];\n    if (file) {\n      this.importFileName.textContent = file.name;\n      this.importFileInfo.style.display = 'flex';\n      this.importResults.style.display = 'none';\n    } else {\n      this.importFileInfo.style.display = 'none';\n    }\n  }\n\n  /**\n   * æ‰§è¡Œå¯¼å…¥\n   */\n  async executeImport() {\n    const file = this.importFileInput.files[0];\n    if (!file) return;\n    \n    try {\n      const text = await file.text();\n      const importData = JSON.parse(text);\n      \n      const result = this.customAnnotationManager.importData(importData);\n      \n      if (result.success) {\n        this.importResultsContent.innerHTML = `\n          <div style=\"color: #059669;\">\n            âœ… Import successful!<br>\n            Imported ${importData.customTypes?.length || 0} custom types and ${importData.customAnnotations?.length || 0} annotations.\n          </div>\n        `;\n        \n        // Refresh all data\n        this.refreshAllData();\n      } else {\n        this.importResultsContent.innerHTML = `\n          <div style=\"color: #dc2626;\">\n            âŒ Import failed: ${result.error}\n          </div>\n        `;\n      }\n      \n      this.importResults.style.display = 'block';\n      \n    } catch (error) {\n      this.importResultsContent.innerHTML = `\n        <div style=\"color: #dc2626;\">\n          âŒ Error reading file: ${error.message}\n        </div>\n      `;\n      this.importResults.style.display = 'block';\n    }\n  }\n}","/**\n * æ¤ç‰©å›¾åƒå…³é”®ç‚¹æ ‡æ³¨å·¥å…· - ä¸»åº”ç”¨å…¥å£\n * \n * åŠŸèƒ½ï¼š\n * - åº”ç”¨åˆå§‹åŒ–å’ŒåŠ è½½\n * - File System Access API æ”¯æŒæ£€æµ‹\n * - åŸºç¡€UIäº¤äº’ç»‘å®š\n * - æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥\n */\n\nimport { FileSystemManager } from './core/FileSystemManager.js';\nimport { PlantDataManager } from './core/PlantDataManager.js';\nimport { AnnotationTool } from './core/AnnotationTool.js';\nimport { BranchPointPreviewManager } from './core/BranchPointPreviewManager.js';\nimport { NoteManager } from './core/NoteManager.js';\nimport { NoteUI } from './core/NoteUI.js';\nimport { AnnotationManager } from './core/AnnotationManager.js';\nimport { BulkLoadingPerformanceMonitor } from './utils/BulkLoadingPerformanceMonitor.js';\nimport RealTimeSyncManager from './core/RealTimeSyncManager.js';\nimport { CustomAnnotationToolbarController } from './core/CustomAnnotationToolbarController.js';\nimport { CustomAnnotationSettingsController } from './core/CustomAnnotationSettingsController.js';\n\n// ğŸ”§ FIX: Global error handling to prevent uncaught promise errors\nwindow.addEventListener('unhandledrejection', (event) => {\n  console.error('ğŸš¨ Unhandled Promise Rejection:', event.reason);\n  \n  // Check if it's the common Chrome extension message channel error\n  if (event.reason && typeof event.reason === 'object' && \n      event.reason.message && event.reason.message.includes('message channel closed')) {\n    console.warn('Chrome extension message channel error detected - this is usually harmless');\n    event.preventDefault(); // Prevent the error from being logged to console\n    return;\n  }\n  \n  // Log other unhandled rejections but don't prevent them\n  console.error('Unhandled promise rejection details:', {\n    reason: event.reason,\n    promise: event.promise,\n    stack: event.reason?.stack\n  });\n});\n\n// ğŸ”§ FIX: Global error handler for uncaught exceptions\nwindow.addEventListener('error', (event) => {\n  console.error('ğŸš¨ Uncaught Error:', event.error);\n  \n  // Check for async listener errors specifically\n  if (event.error && event.error.message && \n      event.error.message.includes('asynchronous response')) {\n    console.warn('Async response listener error detected - likely Chrome extension related');\n    return;\n  }\n  \n  console.error('Global error details:', {\n    message: event.message,\n    filename: event.filename,\n    lineno: event.lineno,\n    colno: event.colno,\n    error: event.error\n  });\n});\n\n// DOMå…ƒç´ å¼•ç”¨\nlet app = null;\nlet loadingScreen = null;\nlet mainApp = null;\nlet errorModal = null;\n\n// ç®¡ç†å™¨å®ä¾‹\nlet plantDataManager = null;\nlet annotationTool = null;\nlet branchPointPreviewManager = null;\nlet noteManager = null;\nlet noteUI = null;\nlet annotationManager = null;\nlet realTimeSyncManager = null;\nlet performanceMonitor = null;\nlet currentDataset = null;\nlet customAnnotationToolbarController = null;\nlet customAnnotationSettingsController = null;\n\n// åº”ç”¨çŠ¶æ€\nconst appState = {\n  isInitialized: false,\n  hasBackendAccess: false,\n  currentDatasetPath: null,\n  plants: [],\n  currentPlant: null,\n  currentImage: null,\n  annotations: new Map(),\n  // ğŸ”§ NEW: Navigation state management to prevent race conditions\n  navigation: {\n    isNavigating: false,\n    lastNavigationTime: 0,\n    throttleDelay: 150 // Minimum time between navigation attempts (ms)\n  }\n};\n\n/**\n * åˆå§‹åŒ–è‡ªå®šä¹‰æ ‡æ³¨æ§åˆ¶å™¨\n */\nfunction initializeCustomAnnotationControllers() {\n  // é˜²æ­¢é‡å¤åˆå§‹åŒ–\n  if (customAnnotationSettingsController || customAnnotationToolbarController) {\n    console.log('Custom annotation controllers already initialized, skipping...');\n    return;\n  }\n  \n  if (!annotationTool || !annotationTool.customAnnotationManager) {\n    console.warn('CustomAnnotationManager not ready, retrying...');\n    setTimeout(() => {\n      initializeCustomAnnotationControllers();\n    }, 200);\n    return;\n  }\n  \n  try {\n    // åˆ›å»ºè®¾ç½®æ§åˆ¶å™¨ - ä¼ å…¥æ­£ç¡®çš„å‚æ•°\n    customAnnotationSettingsController = new CustomAnnotationSettingsController(annotationTool.customAnnotationManager);\n    \n    // åˆ›å»ºå·¥å…·æ æ§åˆ¶å™¨ï¼Œä¼ å…¥æ­£ç¡®çš„å‚æ•°\n    customAnnotationToolbarController = new CustomAnnotationToolbarController(\n      annotationTool.customAnnotationManager,\n      customAnnotationSettingsController\n    );\n    \n    // åˆå§‹åŒ–å·¥å…·æ æ§åˆ¶å™¨\n    customAnnotationToolbarController.initialize();\n    \n    // å…¨å±€å¼•ç”¨\n    window.PlantAnnotationTool.customAnnotationToolbarController = customAnnotationToolbarController;\n    window.PlantAnnotationTool.customAnnotationSettingsController = customAnnotationSettingsController;\n    \n    console.log('è‡ªå®šä¹‰æ ‡æ³¨æ§åˆ¶å™¨åˆå§‹åŒ–æˆåŠŸ');\n  } catch (error) {\n    console.error('è‡ªå®šä¹‰æ ‡æ³¨æ§åˆ¶å™¨åˆå§‹åŒ–å¤±è´¥:', error);\n  }\n}\n\n// è®¾ç½®å›è°ƒå‡½æ•°\nwindow.onCustomAnnotationSystemReady = initializeCustomAnnotationControllers;\n\n/**\n * åº”ç”¨åˆå§‹åŒ–\n */\nasync function initializeApp() {\n  console.log('åˆå§‹åŒ–æ¤ç‰©å›¾åƒå…³é”®ç‚¹æ ‡æ³¨å·¥å…·...');\n  \n  try {\n    // å…¨å±åŠ è½½è¿›åº¦ç®¡ç†\n    updateFullscreenLoading(10, 'Initializing managers...', 'Setting up core components');\n    \n    // è·å–DOMå…ƒç´ å¼•ç”¨\n    app = document.getElementById('app');\n    loadingScreen = document.getElementById('loading-screen');\n    mainApp = document.getElementById('main-app');\n    errorModal = document.getElementById('error-modal');\n    \n    updateFullscreenLoading(20, 'Creating data managers...', 'Initializing plant data manager');\n    \n    // åˆå§‹åŒ–ç®¡ç†å™¨\n    plantDataManager = new PlantDataManager();\n\n    // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œåˆå§‹åŒ–annotationStorageï¼Œç­‰åˆ°é€‰æ‹©æ•°æ®é›†æ—¶å†åˆå§‹åŒ–\n    \n    updateFullscreenLoading(30, 'Setting up window objects...', 'Making managers globally available');\n    \n    // ç«‹å³è®¾ç½®windowå¯¹è±¡ï¼Œç¡®ä¿å…¶ä»–æ¨¡å—å¯ä»¥è®¿é—®\n    window.PlantAnnotationTool = {\n      appState,\n      plantDataManager,\n      annotationTool: null, // ç¨åè®¾ç½®\n      showError,\n      hideError,\n      updateProgressInfo\n    };\n    \n    updateFullscreenLoading(40, 'Initializing annotation tool...', 'Setting up the annotation interface');\n    \n    // åˆå§‹åŒ–æ ‡æ³¨å·¥å…·\n    try {\n      console.log('[è°ƒè¯•] åœ¨initializeAppå¼€å§‹æ—¶åˆå§‹åŒ–AnnotationTool');\n      annotationTool = new AnnotationTool('annotation-canvas');\n      window.PlantAnnotationTool.annotationTool = annotationTool;\n    } catch (error) {\n      console.warn('AnnotationToolåˆå§‹åŒ–å»¶è¿Ÿ:', error.message);\n      // Canvaså¯èƒ½è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œç¨åå†è¯•\n    }\n    \n    updateFullscreenLoading(50, 'Setting up preview manager...', 'Initializing branch point preview functionality');\n    \n    // åˆå§‹åŒ–åˆ†æ”¯ç‚¹é¢„è§ˆç®¡ç†å™¨\n    try {\n      branchPointPreviewManager = new BranchPointPreviewManager();\n      branchPointPreviewManager.setPlantDataManager(plantDataManager);\n      window.PlantAnnotationTool.branchPointPreviewManager = branchPointPreviewManager;\n    } catch (error) {\n      console.warn('BranchPointPreviewManageråˆå§‹åŒ–å»¶è¿Ÿ:', error.message);\n    }\n    \n    updateFullscreenLoading(52, 'Setting up custom annotation system...', 'Initializing custom annotation controllers');\n    \n    // åˆå§‹åŒ–è‡ªå®šä¹‰æ ‡æ³¨ç³»ç»Ÿ - éœ€è¦ç­‰å¾…å¼‚æ­¥åŠ è½½å®Œæˆ\n    try {\n      // ç­‰å¾…annotation toolçš„è‡ªå®šä¹‰æ ‡æ³¨ç³»ç»Ÿå¼‚æ­¥åŠ è½½å®Œæˆ\n      setTimeout(() => {\n        initializeCustomAnnotationControllers();\n      }, 500); // ç»™åŠ¨æ€å¯¼å…¥ä¸€äº›æ—¶é—´æ¥å®Œæˆ\n      \n      console.log('è‡ªå®šä¹‰æ ‡æ³¨ç³»ç»Ÿåˆå§‹åŒ–å·²å¯åŠ¨');\n    } catch (error) {\n      console.warn('è‡ªå®šä¹‰æ ‡æ³¨ç³»ç»Ÿåˆå§‹åŒ–å»¶è¿Ÿ:', error.message);\n    }\n    \n    updateFullscreenLoading(55, 'Setting up note system...', 'Initializing note management functionality');\n    \n    // åˆå§‹åŒ–ç¬”è®°ç³»ç»Ÿ\n    try {\n      noteManager = new NoteManager(plantDataManager.fileSystemManager);\n      noteUI = new NoteUI(noteManager);\n      \n      // å¯åŠ¨è‡ªåŠ¨æ¸…ç†\n      noteManager.startAutoCleanup();\n      \n      window.PlantAnnotationTool.noteManager = noteManager;\n      window.PlantAnnotationTool.noteUI = noteUI;\n      console.log('ç¬”è®°ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');\n    } catch (error) {\n      console.warn('NoteManageråˆå§‹åŒ–å»¶è¿Ÿ:', error.message);\n    }\n    \n    updateFullscreenLoading(60, 'Setting up annotation manager...', 'Initializing bulk annotation loading system');\n    \n    // åˆå§‹åŒ–æ ‡æ³¨ç®¡ç†å™¨\n    try {\n      annotationManager = new AnnotationManager(plantDataManager.fileSystemManager);\n      \n      window.PlantAnnotationTool.annotationManager = annotationManager;\n      console.log('æ ‡æ³¨ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');\n    } catch (error) {\n      console.warn('AnnotationManageråˆå§‹åŒ–å»¶è¿Ÿ:', error.message);\n    }\n    \n    updateFullscreenLoading(63, 'Setting up real-time sync...', 'Initializing real-time synchronization manager');\n    \n    // åˆå§‹åŒ–å®æ—¶åŒæ­¥ç®¡ç†å™¨\n    try {\n      realTimeSyncManager = new RealTimeSyncManager(plantDataManager, plantDataManager.annotationStorage);\n      \n      window.PlantAnnotationTool.realTimeSyncManager = realTimeSyncManager;\n      console.log('ğŸ”„ å®æ—¶åŒæ­¥ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');\n    } catch (error) {\n      console.warn('ğŸ”„ RealTimeSyncManageråˆå§‹åŒ–å»¶è¿Ÿ:', error.message);\n    }\n    \n    updateFullscreenLoading(65, 'Setting up performance monitoring...', 'Initializing bulk loading performance tracking');\n    \n    // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§å™¨\n    try {\n      performanceMonitor = new BulkLoadingPerformanceMonitor();\n      \n      window.PlantAnnotationTool.performanceMonitor = performanceMonitor;\n      console.log('æ€§èƒ½ç›‘æ§å™¨åˆå§‹åŒ–æˆåŠŸ');\n    } catch (error) {\n      console.warn('æ€§èƒ½ç›‘æ§å™¨åˆå§‹åŒ–å»¶è¿Ÿ:', error.message);\n    }\n    \n    updateFullscreenLoading(70, 'Checking compatibility...', 'Verifying browser support and backend connection');\n    \n    // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§\n    await checkBrowserCompatibility();\n    \n    updateFullscreenLoading(70, 'Setting up interface...', 'Binding event listeners and UI components');\n    \n    // ç»‘å®šåŸºç¡€äº‹ä»¶ç›‘å¬å™¨\n    bindEventListeners();\n    \n    updateFullscreenLoading(80, 'Finalizing setup...', 'Completing initialization process');\n    \n    // æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹\n    await simulateLoading();\n    \n    // æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢\n    showMainApp();\n    \n    // ç¡®ä¿æ ‡æ³¨å·¥å…·å·²åˆå§‹åŒ–ï¼ˆé¿å…é‡å¤åˆå§‹åŒ–ï¼‰\n    if (!annotationTool) {\n      try {\n        console.log('[è°ƒè¯•] åœ¨initializeAppä¸­åˆå§‹åŒ–AnnotationTool');\n        annotationTool = new AnnotationTool('annotation-canvas');\n        window.PlantAnnotationTool.annotationTool = annotationTool;\n      } catch (error) {\n        console.error('æ— æ³•åˆå§‹åŒ–AnnotationTool:', error);\n      }\n    } else {\n      console.log('[è°ƒè¯•] AnnotationToolå·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');\n    }\n    \n    updateFullscreenLoading(90, 'Connecting to dataset...', 'Automatically connecting to plant dataset');\n    \n    // è‡ªåŠ¨è¿æ¥æ•°æ®é›†\n    setTimeout(async () => {\n      try {\n        await autoConnectDataset();\n      } catch (error) {\n        console.error('è‡ªåŠ¨è¿æ¥æ•°æ®é›†å¤±è´¥:', error);\n        hideFullscreenLoading();\n        showError('è‡ªåŠ¨è¿æ¥æ•°æ®é›†å¤±è´¥', error.message);\n      }\n    }, 500); // ç»™ç”¨æˆ·çœ‹åˆ°æœ€åçš„åŠ è½½è¿›åº¦\n    \n    appState.isInitialized = true;\n    console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');\n    \n  } catch (error) {\n    console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);\n    hideFullscreenLoading();\n    showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥', error.message);\n  }\n}\n\n/**\n * æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§\n */\nasync function checkBrowserCompatibility() {\n  console.log('æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§...');\n  \n  // æ£€æŸ¥åç«¯æœåŠ¡è¿æ¥\n  try {\n    const isConnected = await plantDataManager.fileSystemManager.checkConnection();\n    if (isConnected) {\n      await plantDataManager.fileSystemManager.initialize();\n      appState.hasBackendAccess = true;\n      console.log('âœ… åç«¯æœåŠ¡è¿æ¥æˆåŠŸ');\n    } else {\n      throw new Error('åç«¯æœåŠ¡ä¸å¯ç”¨');\n    }\n  } catch (error) {\n    appState.hasBackendAccess = false;\n    const errorMessage = error.message.includes('fetch') || error.message.includes('ERR_CONNECTION_REFUSED') ?\n      'åç«¯æœåŠ¡æœªå¯åŠ¨ï¼Œè¯·è¿è¡Œ ./start-backend.sh å¯åŠ¨æœåŠ¡å™¨' :\n      error.message;\n    console.warn('âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥:', errorMessage);\n  }\n  \n  // æ£€æŸ¥å…¶ä»–å¿…è¦çš„API\n  const requiredAPIs = [\n    { name: 'Canvas API', check: () => !!document.createElement('canvas').getContext },\n    { name: 'IndexedDB', check: () => !!window.indexedDB },\n    { name: 'Web Workers', check: () => !!window.Worker },\n    { name: 'Intersection Observer', check: () => !!window.IntersectionObserver }\n  ];\n  \n  const unsupportedAPIs = requiredAPIs.filter(api => !api.check());\n  \n  if (unsupportedAPIs.length > 0) {\n    const missingAPIs = unsupportedAPIs.map(api => api.name).join(', ');\n    throw new Error(`æµè§ˆå™¨ä¸æ”¯æŒä»¥ä¸‹å¿…è¦API: ${missingAPIs}`);\n  }\n  \n  console.log('âœ… æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡');\n}\n\n/**\n * ç»‘å®šäº‹ä»¶ç›‘å¬å™¨\n */\nfunction bindEventListeners() {\n  console.log('ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');\n  \n  // é€‰æ‹©æ•°æ®é›†æŒ‰é’®\n  const selectDatasetBtn = document.getElementById('select-dataset-btn');\n  if (selectDatasetBtn) {\n    selectDatasetBtn.addEventListener('click', handleSelectDataset);\n  }\n  \n  // é”™è¯¯æ¨¡æ€æ¡†å…³é—­æŒ‰é’®\n  const errorCloseBtn = document.getElementById('error-close-btn');\n  if (errorCloseBtn) {\n    errorCloseBtn.addEventListener('click', hideError);\n  }\n  \n  // è§†å›¾æ§åˆ¶æŒ‰é’®\n  const resetZoomBtn = document.getElementById('reset-zoom-btn');\n  if (resetZoomBtn) {\n    resetZoomBtn.addEventListener('click', () => {\n      if (annotationTool) {\n        annotationTool.resetView();\n      }\n    });\n  }\n  \n  const fitScreenBtn = document.getElementById('fit-screen-btn');\n  if (fitScreenBtn) {\n    fitScreenBtn.addEventListener('click', () => {\n      if (annotationTool) {\n        annotationTool.fitToScreen();\n      }\n    });\n  }\n  \n  // è§†è§’é€‰æ‹©æŒ‰é’®äº‹ä»¶å§”æ‰˜\n  document.addEventListener('click', (event) => {\n    if (event.target.classList.contains('btn-view-angle')) {\n      const viewAngle = event.target.dataset.viewAngle;\n      handleViewAngleSelect(viewAngle);\n    }\n  });\n  \n  // æ ‡æ³¨æ§åˆ¶æŒ‰é’®\n  const undoBtn = document.getElementById('undo-btn');\n  if (undoBtn) {\n    undoBtn.addEventListener('click', () => {\n      if (annotationTool) {\n        annotationTool.undo();\n      }\n    });\n  }\n  \n  const redoBtn = document.getElementById('redo-btn');\n  if (redoBtn) {\n    redoBtn.addEventListener('click', () => {\n      if (annotationTool) {\n        annotationTool.redo();\n      }\n    });\n  }\n  \n  const clearAllBtn = document.getElementById('clear-all-btn');\n  if (clearAllBtn) {\n    clearAllBtn.addEventListener('click', handleClearAllAnnotations);\n  }\n  \n  // ğŸ”§ NEW: SIFTåŒ¹é…æŒ‰é’®\n  const siftMatchBtn = document.getElementById('sift-match-btn');\n  if (siftMatchBtn) {\n    siftMatchBtn.addEventListener('click', handleSiftMatch);\n  }\n  \n  // åˆ†æ”¯ç‚¹é¢„è§ˆåˆ‡æ¢æŒ‰é’®\n  const togglePreviewBtn = document.getElementById('toggle-preview-btn');\n  if (togglePreviewBtn) {\n    togglePreviewBtn.addEventListener('click', () => {\n      if (branchPointPreviewManager) {\n        branchPointPreviewManager.toggleVisibility();\n      }\n    });\n  }\n\n\n  \n  // è‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©æŒ‰é’®\n  const autoDirectionBtn = document.getElementById('auto-direction-btn');\n  if (autoDirectionBtn) {\n    autoDirectionBtn.addEventListener('click', handleAutoDirectionSelection);\n  }\n\n  // ğŸ”§ NEW: Auto Direction Mode Selector (Longitudinal vs Cross-Sectional)\n  const autoDirectionModeSelector = document.getElementById('auto-direction-mode-selector');\n  if (autoDirectionModeSelector) {\n    autoDirectionModeSelector.addEventListener('change', handleAutoDirectionModeChange);\n  }\n  \n  // ğŸ”§ NEW: Auto Order Button\n  const autoOrderBtn = document.getElementById('auto-order-btn');\n  if (autoOrderBtn) {\n    autoOrderBtn.addEventListener('click', handleAutoOrderClick);\n  }\n\n  // é”å®šå€æ•°æ§ä»¶\n  const zoomLockCheckbox = document.getElementById('zoom-lock-checkbox');\n  const zoomLockValue = document.getElementById('zoom-lock-value');\n  if (zoomLockCheckbox && zoomLockValue) {\n    zoomLockCheckbox.addEventListener('change', handleZoomLockChange);\n    zoomLockValue.addEventListener('change', handleZoomLockValueChange);\n  }\n\n  // è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®æ§ä»¶\n  const autoMoveCheckbox = document.getElementById('auto-move-checkbox');\n  if (autoMoveCheckbox) {\n    autoMoveCheckbox.addEventListener('change', handleAutoMoveChange);\n  }\n\n  // ğŸ”„ å®æ—¶å˜æ›´åŒæ­¥æ§ä»¶\n  const realTimeChangeCheckbox = document.getElementById('real-time-change-checkbox');\n  if (realTimeChangeCheckbox) {\n    realTimeChangeCheckbox.addEventListener('change', handleRealTimeChangeChange);\n  }\n\n  // è·³è¿‡æ¤æ ªæ¨¡æ€æ¡†äº‹ä»¶\n  const skipModalClose = document.getElementById('skip-modal-close');\n  const skipCancelBtn = document.getElementById('skip-cancel-btn');\n  const skipConfirmBtn = document.getElementById('skip-confirm-btn');\n\n  if (skipModalClose) {\n    skipModalClose.addEventListener('click', hideSkipPlantModal);\n  }\n\n  if (skipCancelBtn) {\n    skipCancelBtn.addEventListener('click', hideSkipPlantModal);\n  }\n\n  if (skipConfirmBtn) {\n    skipConfirmBtn.addEventListener('click', confirmSkipPlant);\n  }\n\n  // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­\n  const skipModal = document.getElementById('skip-plant-modal');\n  if (skipModal) {\n    skipModal.addEventListener('click', (e) => {\n      if (e.target === skipModal) {\n        hideSkipPlantModal();\n      }\n    });\n  }\n\n  // çŠ¶æ€è¿‡æ»¤å™¨\n  const statusFilter = document.getElementById('status-filter');\n  if (statusFilter) {\n    statusFilter.addEventListener('change', handleStatusFilterChange);\n  }\n\n  // æ¤æ ªæœç´¢\n  const plantSearch = document.getElementById('plant-search');\n  if (plantSearch) {\n    plantSearch.addEventListener('input', handlePlantSearchInput);\n  }\n  \n  // æ ‡æ³¨æ“ä½œæŒ‰é’®\n  const saveAnnotationBtn = document.getElementById('save-annotation-btn');\n  if (saveAnnotationBtn) {\n    saveAnnotationBtn.addEventListener('click', handleSaveAnnotation);\n  }\n  \n  // ä¿å­˜æ ‡æ³¨æ¨¡æ€æ¡†äº‹ä»¶\n  const saveAnnotationCancelBtn = document.getElementById('save-annotation-cancel-btn');\n  if (saveAnnotationCancelBtn) {\n    saveAnnotationCancelBtn.addEventListener('click', hideSaveAnnotationModal);\n  }\n  \n  const saveAnnotationConfirmBtn = document.getElementById('save-annotation-confirm-btn');\n  if (saveAnnotationConfirmBtn) {\n    saveAnnotationConfirmBtn.addEventListener('click', () => {\n      const selectedMode = document.querySelector('input[name=\"save-mode\"]:checked');\n      if (selectedMode) {\n        const isManualAdjustment = selectedMode.value === 'current-only';\n        performSaveAnnotation(isManualAdjustment);\n      }\n    });\n  }\n  \n  const completePlantBtn = document.getElementById('complete-plant-btn');\n  if (completePlantBtn) {\n    completePlantBtn.addEventListener('click', handleCompletePlant);\n  }\n  \n  const exportDataBtn = document.getElementById('export-data-btn');\n  if (exportDataBtn) {\n    exportDataBtn.addEventListener('click', handleExportData);\n  }\n  \n  // ğŸ”§ NEW: Delete Plant Annotations button\n  const deletePlantAnnotationsBtn = document.getElementById('delete-plant-annotations-btn');\n  if (deletePlantAnnotationsBtn) {\n    deletePlantAnnotationsBtn.addEventListener('click', handleDeletePlantAnnotations);\n  }\n  \n  // ğŸ”§ NEW: Delete Plant Annotations modal events\n  const deleteModalClose = document.getElementById('delete-modal-close');\n  const deleteCancelBtn = document.getElementById('delete-cancel-btn');\n  const deleteConfirmBtn = document.getElementById('delete-confirm-btn');\n  const deleteConfirmationCheckbox = document.getElementById('delete-confirmation-checkbox');\n  \n  if (deleteModalClose) {\n    deleteModalClose.addEventListener('click', hideDeletePlantAnnotationsModal);\n  }\n  \n  if (deleteCancelBtn) {\n    deleteCancelBtn.addEventListener('click', hideDeletePlantAnnotationsModal);\n  }\n  \n  if (deleteConfirmBtn) {\n    deleteConfirmBtn.addEventListener('click', confirmDeletePlantAnnotations);\n  }\n  \n  if (deleteConfirmationCheckbox) {\n    deleteConfirmationCheckbox.addEventListener('change', handleDeleteConfirmationChange);\n  }\n  \n  // ğŸ”§ NEW: Delete modal background click close\n  const deleteModal = document.getElementById('delete-plant-annotations-modal');\n  if (deleteModal) {\n    deleteModal.addEventListener('click', (e) => {\n      if (e.target === deleteModal) {\n        hideDeletePlantAnnotationsModal();\n      }\n    });\n  }\n  \n  // é”®ç›˜å¿«æ·é”®\n  document.addEventListener('keydown', handleKeyboardShortcuts);\n  \n  // é˜²æ­¢å³é”®èœå•ï¼ˆåœ¨æ ‡æ³¨åŒºåŸŸï¼‰\n  const canvasContainer = document.getElementById('canvas-container');\n  if (canvasContainer) {\n    canvasContainer.addEventListener('contextmenu', (e) => e.preventDefault());\n  }\n  \n  // æ¤ç‰©æ›´æ–°äº‹ä»¶ç›‘å¬\n  document.addEventListener('plantUpdated', handlePlantUpdated);\n  \n  // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­äº‹ä»¶\n  const errorModal = document.getElementById('error-modal');\n  if (errorModal) {\n    errorModal.addEventListener('click', (e) => {\n      if (e.target === errorModal) {\n        hideError();\n      }\n    });\n  }\n  \n  const saveAnnotationModal = document.getElementById('save-annotation-modal');\n  if (saveAnnotationModal) {\n    saveAnnotationModal.addEventListener('click', (e) => {\n      if (e.target === saveAnnotationModal) {\n        hideSaveAnnotationModal();\n      }\n    });\n  }\n  \n  // ğŸ”§ NEW: Unskip Plant Modal Events\n  const unskipModalClose = document.getElementById('unskip-modal-close');\n  const unskipCancelBtn = document.getElementById('unskip-cancel-btn');\n  const unskipConfirmBtn = document.getElementById('unskip-confirm-btn');\n  \n  if (unskipModalClose) {\n    unskipModalClose.addEventListener('click', hideUnskipPlantModal);\n  }\n  \n  if (unskipCancelBtn) {\n    unskipCancelBtn.addEventListener('click', hideUnskipPlantModal);\n  }\n  \n  if (unskipConfirmBtn) {\n    unskipConfirmBtn.addEventListener('click', confirmUnskipPlant);\n  }\n  \n  // ğŸ”§ NEW: Uncomplete Plant Modal Events\n  const uncompleteModalClose = document.getElementById('uncomplete-modal-close');\n  const uncompleteCancelBtn = document.getElementById('uncomplete-cancel-btn');\n  const uncompleteConfirmBtn = document.getElementById('uncomplete-confirm-btn');\n  \n  if (uncompleteModalClose) {\n    uncompleteModalClose.addEventListener('click', hideUncompletePlantModal);\n  }\n  \n  if (uncompleteCancelBtn) {\n    uncompleteCancelBtn.addEventListener('click', hideUncompletePlantModal);\n  }\n  \n  if (uncompleteConfirmBtn) {\n    uncompleteConfirmBtn.addEventListener('click', confirmUncompletePlant);\n  }\n  \n  // ğŸ”§ NEW: Modal background click close events\n  const unskipModal = document.getElementById('unskip-plant-modal');\n  if (unskipModal) {\n    unskipModal.addEventListener('click', (e) => {\n      if (e.target === unskipModal) {\n        hideUnskipPlantModal();\n      }\n    });\n  }\n  \n  const uncompleteModal = document.getElementById('uncomplete-plant-modal');\n  if (uncompleteModal) {\n    uncompleteModal.addEventListener('click', (e) => {\n      if (e.target === uncompleteModal) {\n        hideUncompletePlantModal();\n      }\n    });\n  }\n  \n  console.log('âœ… äº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆ');\n}\n\n/**\n * å¤„ç†æ•°æ®é›†é€‰æ‹©\n */\nasync function handleSelectDataset() {\n  console.log('å¼€å§‹è¿æ¥æ•°æ®é›†...');\n  \n  // ç¡®ä¿plantDataManagerå·²åˆå§‹åŒ–\n  if (!plantDataManager) {\n    console.error('PlantDataManageræœªåˆå§‹åŒ–');\n    showError('ç³»ç»Ÿé”™è¯¯', 'æ•°æ®ç®¡ç†å™¨æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');\n    return;\n  }\n  \n  try {\n    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€\n    const selectBtn = document.getElementById('select-dataset-btn');\n    const originalText = selectBtn.textContent;\n    selectBtn.textContent = 'Connecting...';\n    selectBtn.disabled = true;\n    \n    // æ£€æŸ¥åç«¯è¿æ¥\n    updateProgressInfo('Connecting to backend...');\n    const datasetInfo = await plantDataManager.fileSystemManager.getDatasetInfo();\n    \n    if (!datasetInfo) {\n      throw new Error('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨');\n    }\n\n    console.log('è¿æ¥çš„æ•°æ®é›†:', datasetInfo.datasetPath);\n\n    // éªŒè¯ç›®å½•ç»“æ„\n    await validateDatasetStructure();\n\n    // ä½¿ç”¨PlantDataManageråŠ è½½æ•°æ®é›†\n    updateProgressInfo('Loading plants...');\n    const plants = await plantDataManager.loadDataset();\n    \n    // æ›´æ–°åº”ç”¨çŠ¶æ€\n    appState.currentDatasetPath = datasetInfo.datasetPath;\n    appState.plants = plants;\n    currentDataset = {\n      path: datasetInfo.datasetPath,\n      name: 'Brassica napus dataset',\n      plantCount: plants.length\n    };\n    \n    // æ›´æ–°UI\n    updateProgressInfo(`Loaded ${plants.length} plants`);\n    selectBtn.textContent = 'Reconnect Dataset';\n    \n    // æ˜¾ç¤ºæ¤ç‰©åˆ—è¡¨\n    renderPlantList(plants);\n    \n    // åˆå§‹æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º\n    updateProgressStats();\n    \n    console.log(`æˆåŠŸåŠ è½½æ•°æ®é›†: ${plants.length} ä¸ªæ¤ç‰©`);\n    \n  } catch (error) {\n    console.error('é€‰æ‹©æ•°æ®é›†å¤±è´¥:', error);\n    \n    showError('è¿æ¥æ•°æ®é›†å¤±è´¥', error.message);\n  } finally {\n    // æ¢å¤æŒ‰é’®çŠ¶æ€\n    const selectBtn = document.getElementById('select-dataset-btn');\n    selectBtn.textContent = appState.currentDatasetPath ? 'é‡æ–°è¿æ¥æ•°æ®é›†' : 'è¿æ¥æ•°æ®é›†';\n    selectBtn.disabled = false;\n  }\n}\n\n/**\n * éªŒè¯æ•°æ®é›†ç›®å½•ç»“æ„\n */\nasync function validateDatasetStructure() {\n  console.log('éªŒè¯æ•°æ®é›†ç»“æ„...');\n  \n  try {\n    // é€šè¿‡HTTPåç«¯è·å–æ¤ç‰©æ–‡ä»¶å¤¹åˆ—è¡¨\n    const plantDirectories = await plantDataManager.fileSystemManager.traversePlantDirectories();\n    \n    if (!plantDirectories || plantDirectories.length === 0) {\n      throw new Error('æ•°æ®é›†ä¸­æœªæ‰¾åˆ°æ¤ç‰©æ–‡ä»¶å¤¹ï¼ˆä»¥BRå¼€å¤´çš„æ–‡ä»¶å¤¹ï¼‰');\n    }\n    \n    // éªŒè¯è‡³å°‘ä¸€ä¸ªæ¤ç‰©æ–‡ä»¶å¤¹çš„ç»“æ„\n    const firstPlant = plantDirectories[0];\n    const imagesByView = await plantDataManager.fileSystemManager.readPlantImages(firstPlant.id);\n    \n    if (!imagesByView || Object.keys(imagesByView).length === 0) {\n      throw new Error(`æ¤ç‰©æ–‡ä»¶å¤¹ ${firstPlant.id} ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„è§†è§’ç›®å½•`);\n    }\n    \n    // æ£€æŸ¥æ˜¯å¦æœ‰sv-000è§†è§’\n    if (!imagesByView['sv-000'] || imagesByView['sv-000'].length === 0) {\n      throw new Error(`æ¤ç‰©æ–‡ä»¶å¤¹ ${firstPlant.id} ä¸­æœªæ‰¾åˆ° sv-000 è§†è§’å›¾åƒ`);\n    }\n    \n    console.log(`âœ… æ•°æ®é›†ç»“æ„éªŒè¯é€šè¿‡ï¼Œå‘ç° ${plantDirectories.length} ä¸ªæ¤ç‰©æ–‡ä»¶å¤¹`);\n    \n  } catch (error) {\n    console.error('æ•°æ®é›†ç»“æ„éªŒè¯å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * æ›´æ–°ç»Ÿè®¡è¿›åº¦æ¡æ˜¾ç¤º - ğŸ”§ ENHANCED: Plant-based progress instead of image-based\n */\nfunction updateProgressStats() {\n  if (!plantDataManager) {\n    hideProgressStats();\n    return;\n  }\n\n  const progressStats = plantDataManager.getProgress();\n\n  // è·å–DOMå…ƒç´ \n  const progressStatsElement = document.getElementById('progress-stats');\n  const completedImagesCount = document.getElementById('completed-images-count');\n  const totalImagesCount = document.getElementById('total-images-count');\n  const completionPercentage = document.getElementById('completion-percentage');\n  const completedPlantsCount = document.getElementById('completed-plants-count');\n  const totalPlantsCount = document.getElementById('total-plants-count');\n  const progressBarFill = document.getElementById('progress-bar-fill');\n\n  if (!progressStatsElement) return;\n\n  // æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ\n  progressStatsElement.style.display = 'block';\n\n  // ğŸ”§ FIX: Change from image count to plant count display\n  // Update completed plants count in the main progress display\n  if (completedImagesCount) {\n    const totalCompleted = progressStats.totalCompleted || (progressStats.completed + progressStats.skipped);\n    completedImagesCount.textContent = totalCompleted; // Now shows completed plants instead of images\n  }\n  \n  if (totalImagesCount) {\n    totalImagesCount.textContent = progressStats.total; // Now shows total plants instead of images\n  }\n\n  // æ›´æ–°å®Œæˆç™¾åˆ†æ¯”ï¼ˆåŸºäºæ¤æ ªå®Œæˆç‡ï¼‰\n  if (completionPercentage) {\n    completionPercentage.textContent = progressStats.completionRate + '%';\n  }\n\n  // æ›´æ–°æ¤æ ªæ•°é‡è¯¦ç»†ä¿¡æ¯ï¼ˆæ˜¾ç¤ºæ€»å®Œæˆæ•°ï¼ŒåŒ…æ‹¬è·³è¿‡çš„ï¼‰\n  if (completedPlantsCount) {\n    const totalCompleted = progressStats.totalCompleted || (progressStats.completed + progressStats.skipped);\n    const skippedText = progressStats.skipped > 0 ? ` (${progressStats.skipped} skipped)` : '';\n    completedPlantsCount.textContent = `${totalCompleted} plants finished ${skippedText}`;\n  }\n\n  if (totalPlantsCount) {\n    totalPlantsCount.textContent = `Total ${progressStats.total} plants`;\n  }\n\n  // æ›´æ–°è¿›åº¦æ¡ï¼ˆä½¿ç”¨æ¤æ ªå®Œæˆç‡ï¼ŒåŒ…å«è·³è¿‡çš„æ¤æ ªï¼‰\n  if (progressBarFill) {\n    const percentage = parseFloat(progressStats.completionRate) || 0;\n    progressBarFill.style.width = percentage + '%';\n    \n    // æ ¹æ®å®Œæˆåº¦æ”¹å˜è¿›åº¦æ¡é¢œè‰²\n    if (percentage >= 100) {\n      progressBarFill.style.background = 'linear-gradient(90deg, #059669 0%, #047857 100%)';\n    } else if (percentage >= 75) {\n      progressBarFill.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';\n    } else if (percentage >= 50) {\n      progressBarFill.style.background = 'linear-gradient(90deg, #34d399 0%, #10b981 100%)';\n    } else if (percentage >= 25) {\n      progressBarFill.style.background = 'linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%)';\n    } else {\n      progressBarFill.style.background = 'linear-gradient(90deg, #f87171 0%, #ef4444 100%)';\n    }\n  }\n\n  // ğŸ”§ FIX: Update console log to show plant-based progress\n  const totalCompleted = progressStats.totalCompleted || (progressStats.completed + progressStats.skipped);\n  console.log(`ç»Ÿè®¡æ›´æ–°: ${totalCompleted}/${progressStats.total} æ¤æ ª (${progressStats.completionRate}%)`);\n}\n\n/**\n * éšè—ç»Ÿè®¡è¿›åº¦æ¡\n */\nfunction hideProgressStats() {\n  const progressStatsElement = document.getElementById('progress-stats');\n  if (progressStatsElement) {\n    progressStatsElement.style.display = 'none';\n  }\n}\n\n/**\n * æ¸²æŸ“æ¤ç‰©åˆ—è¡¨\n */\nfunction renderPlantList(plants) {\n  const container = document.getElementById('plant-list-container');\n  if (!container) return;\n  \n  // æ¸…ç©ºç°æœ‰å†…å®¹\n  container.innerHTML = '';\n  \n  if (plants.length === 0) {\n    container.innerHTML = '<div class=\"no-data\">no data</div>';\n    return;\n  }\n  \n  // åˆ›å»ºæ¤ç‰©åˆ—è¡¨é¡¹\n  plants.forEach(plant => {\n    const plantItem = createPlantListItem(plant);\n    container.appendChild(plantItem);\n  });\n  \n  // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º\n  updateProgressStats();\n  \n  // ğŸ”§ OPTIMIZED: Auto-load note badges immediately upon plant list render\n  const updateBadgesInstantly = async () => {\n    console.log('[Badge Update] Starting automatic badge loading for all plants');\n    \n    // Wait for note system with more aggressive retry for better UX\n    let retryCount = 0;\n    const maxRetries = 15; // Increased retries\n    const retryDelay = 300; // Reduced delay for faster startup\n    \n    while (retryCount < maxRetries) {\n      if (window.PlantAnnotationTool?.noteManager && window.PlantAnnotationTool?.noteUI) {\n        try {\n          console.log('[Badge Update] Note system available, starting bulk badge update');\n          const startTime = performance.now();\n          \n          // Try to use pre-cached bulk data first (fastest option)\n          let bulkData = window.PlantAnnotationTool.noteManager.bulkNoteData;\n          \n          if (!bulkData) {\n            console.log('[Badge Update] No pre-cached data, fetching bulk notes for instant display...');\n            try {\n              bulkData = await window.PlantAnnotationTool.noteManager.getAllNotesInBulk();\n              console.log('[Badge Update] Bulk data fetched successfully');\n            } catch (bulkError) {\n              console.warn('[Badge Update] Bulk API failed, using optimized individual requests:', bulkError.message);\n              // Fall back to individual badge updates but with optimized approach\n              await window.PlantAnnotationTool.noteUI.updateAllPlantNoteBadges();\n              const endTime = performance.now();\n              console.log(`[Badge Update] Individual badge update completed in ${(endTime - startTime).toFixed(2)}ms`);\n              return;\n            }\n          }\n          \n          if (bulkData) {\n            // Use instant bulk badge update\n            await window.PlantAnnotationTool.noteUI.updateAllPlantNoteBadgesFromBulk(bulkData);\n            const endTime = performance.now();\n            console.log(`[Badge Update] INSTANT bulk badge update completed in ${(endTime - startTime).toFixed(2)}ms`);\n            console.log('[Badge Update] âœ… All plant note badges are now visible immediately');\n          } else {\n            // Ultimate fallback to individual updates\n            console.log('[Badge Update] Using fallback individual badge updates');\n            await window.PlantAnnotationTool.noteUI.updateAllPlantNoteBadges();\n            const endTime = performance.now();\n            console.log(`[Badge Update] Fallback badge update completed in ${(endTime - startTime).toFixed(2)}ms`);\n          }\n          \n          return; // Success, exit retry loop\n        } catch (error) {\n          console.error('[Badge Update] Badge update failed:', error);\n          retryCount++;\n          if (retryCount >= maxRetries) {\n            console.error('[Badge Update] Max retries reached, badge update failed permanently');\n            return;\n          }\n        }\n      } else {\n        console.log(`[Badge Update] Note system not ready, retry ${retryCount + 1}/${maxRetries}`);\n        retryCount++;\n      }\n      \n      // Wait before next retry\n      await new Promise(resolve => setTimeout(resolve, retryDelay));\n    }\n    \n    console.warn('[Badge Update] âŒ Note system initialization timeout, badges will load later');\n  };\n  \n  // Start badge update immediately, but don't block plant list rendering\n  setTimeout(updateBadgesInstantly, 100);\n  \n  console.log(`æ¸²æŸ“äº† ${plants.length} ä¸ªæ¤ç‰©åˆ—è¡¨é¡¹`);\n}\n\n/**\n * Create plant list item with note indicators\n */\nfunction createPlantListItem(plant) {\n  const item = document.createElement('div');\n  item.className = 'plant-item';\n  item.dataset.plantId = plant.id;\n  \n  // Status icon\n  const statusIcon = getStatusIcon(plant.status);\n  \n  // Image count info\n  const imageCountText = plant.imageCount > 0 ? \n    `${plant.imageCount} images` : \n    (plant.hasImages ? 'loading...' : 'no image');\n  \n  // View angle info\n  const viewAnglesText = plant.viewAngles.length > 0 ? \n    `view: ${plant.viewAngles.join(', ')}` :\n    'view: checking...';\n    \n  // Selected view info\n  const selectedViewText = plant.selectedViewAngle ? \n    `Chosen: ${plant.selectedViewAngle}` : '';\n  \n  // ğŸ”§ NEW: State-based button system for skip/unskip and complete/uncomplete\n  const isSkipped = plant.status === 'skipped';\n  const isCompleted = plant.status === 'completed';\n  \n  // ğŸ”§ FIX: Ensure CSS classes reflect current state\n  if (isSkipped) {\n    item.classList.add('skipped');\n  } else {\n    item.classList.remove('skipped');\n  }\n\n  // Skip reason display\n  const skipReasonHtml = isSkipped && plant.skipReason ?\n    `<div class=\"skip-reason\">skip reason: ${plant.skipReason}</div>` : '';\n\n  // ğŸ”§ NEW: Dynamic button generation based on plant state\n  let stateButtonsHtml = '';\n  \n  // Only Skip/Unskip button - Complete functionality is handled by main interface\n  if (isSkipped) {\n    stateButtonsHtml += `<button class=\"skip-button unskip-variant\" onclick=\"handleUnskipPlant('${plant.id}', event)\">Unskip</button>`;\n  } else {\n    stateButtonsHtml += `<button class=\"skip-button\" onclick=\"showSkipPlantModal('${plant.id}', event)\">Skip</button>`;\n  }\n\n  item.innerHTML = `\n    <div class=\"plant-item-content\">\n      <div class=\"plant-header\">\n        <div class=\"plant-status\">${statusIcon}</div>\n        <div class=\"plant-id\">${plant.id}</div>\n        <div class=\"right-box\">\n          <div class=\"plant-note-badge\" id=\"note-badge-${plant.id}\" style=\"display: none;\"></div>\n          <div class=\"state-buttons\">${stateButtonsHtml}</div>\n        </div>\n      </div>\n      <div class=\"plant-info\">\n        <div class=\"image-count\">${imageCountText}</div>\n        <div class=\"status-text\">${getStatusText(plant.status)}</div>\n      </div>\n      <div class=\"plant-view-info\">\n        <div class=\"view-angles\">${viewAnglesText}</div>\n        ${selectedViewText ? `<div class=\"selected-view\">${selectedViewText}</div>` : ''}\n      </div>\n      ${skipReasonHtml}\n    </div>\n  `;\n  \n  // Click event\n  item.addEventListener('click', () => handlePlantSelect(plant));\n  \n  // Note: Badge updates are handled by NoteUI.updateAllPlantNoteBadges()\n  // No individual loading needed here to avoid race conditions\n  \n  return item;\n}\n\n/**\n * Load and display image note count with refresh detection\n */\nasync function loadImageNoteCount(plantId, imageId) {\n  try {\n    // Check if note system is available\n    if (!window.PlantAnnotationTool || !window.PlantAnnotationTool.noteManager) {\n      console.warn(`[Thumbnail] Note system not available for ${imageId}`);\n      return;\n    }\n    \n    const noteManager = window.PlantAnnotationTool.noteManager;\n    console.log(`[Thumbnail] Loading note count for ${plantId}/${imageId}`);\n    \n    // ğŸ”§ FIX: Check if this is a forced refresh (no cache) scenario\n    const isDirectRefresh = arguments[2]; // Hidden parameter for direct refresh flag\n    let notes;\n    \n    if (isDirectRefresh) {\n      // Force direct API call without cache\n      console.log(`[Thumbnail] Using direct API for forced refresh of ${imageId}`);\n      try {\n        const response = await fetch(`${noteManager.baseUrl}/notes/image/${plantId}/${imageId}`);\n        if (response.ok) {\n          const result = await response.json();\n          notes = result.success ? (result.data || []) : [];\n        } else {\n          notes = [];\n        }\n      } catch (directError) {\n        console.warn(`[Thumbnail] Direct API failed, falling back to cache for ${imageId}:`, directError);\n        notes = await noteManager.getImageNotes(plantId, imageId);\n      }\n    } else {\n      // Normal cached operation\n      notes = await noteManager.getImageNotes(plantId, imageId);\n    }\n    \n    const noteCount = notes ? notes.length : 0;\n    console.log(`[Thumbnail] Found ${noteCount} notes for ${imageId}`);\n    \n    const badge = document.getElementById(`image-note-badge-${imageId}`);\n    if (badge) {\n      console.log(`[Thumbnail] Badge element found for ${imageId}`);\n      if (noteCount > 0) {\n        badge.innerHTML = `<span class=\"image-note-count\">ğŸ“ ${noteCount}</span>`;\n        badge.style.display = 'inline-block';\n        badge.className = 'image-note-badge';\n        console.log(`[Thumbnail] Badge updated with ${noteCount} notes for ${imageId}`);\n      } else {\n        // ğŸ”§ FIX: Clear badge when no notes exist\n        badge.innerHTML = '';\n        badge.style.display = 'none';\n        console.log(`[Thumbnail] Badge cleared for ${imageId} (no notes)`);\n      }\n      console.log(`[Thumbnail] Badge updated for ${imageId}: ${noteCount} notes`);\n    } else {\n      console.error(`[Thumbnail] Badge element NOT FOUND for ${imageId} (ID: image-note-badge-${imageId})`);\n    }\n  } catch (error) {\n    // Silently handle errors - note loading is not critical for UI\n    console.error(`[Thumbnail] Note loading failed for image ${imageId}:`, error.message);\n    \n    // ğŸ”§ FIX: Clear badge on error to prevent stale data\n    const badge = document.getElementById(`image-note-badge-${imageId}`);\n    if (badge) {\n      badge.innerHTML = '';\n      badge.style.display = 'none';\n      console.log(`[Thumbnail] Badge cleared on error for ${imageId}`);\n    }\n  }\n}\n\n// ğŸ”§ FIX: å°†åŠ è½½å›¾åƒç¬”è®°è®¡æ•°å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¾›NoteUIè°ƒç”¨\nwindow.loadImageNoteCount = loadImageNoteCount;\n\n// ğŸ”§ FIX: å°†å¯¼èˆªå‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¾›Auto OrderåŠŸèƒ½è°ƒç”¨\nwindow.navigateToNextImage = navigateToNextImage;\nwindow.navigateToPreviousImage = navigateToPreviousImage;\n\n/**\n * è·å–çŠ¶æ€å›¾æ ‡\n */\nfunction getStatusIcon(status) {\n  switch (status) {\n    case 'completed':\n      return 'âœ…';\n    case 'in-progress':\n      return 'ğŸ”„';\n    case 'skipped':\n      return 'â­ï¸';\n    case 'pending':\n    default:\n      return 'â­•';\n  }\n}\n\n/**\n * è·å–çŠ¶æ€æ–‡æœ¬\n */\nfunction getStatusText(status) {\n  switch (status) {\n    case 'completed':\n      return 'Finished';\n    case 'in-progress':\n      return 'In progress';\n    case 'skipped':\n      return 'Skipped';\n    case 'pending':\n    default:\n      return 'Not started';\n  }\n}\n\n/**\n * åˆå§‹åŒ–å·¥ä½œåŒºåˆ°ç©ºçŠ¶æ€\n */\nfunction initializeEmptyWorkspace() {\n  console.log('åˆå§‹åŒ–ç©ºå·¥ä½œåŒºçŠ¶æ€');\n  \n  // æ¸…ç©ºåº”ç”¨çŠ¶æ€\n  appState.currentPlant = null;\n  appState.currentImage = null;\n  \n  // æ¸…ç©ºå·¥ä½œåŒº\n  clearWorkspaceState();\n  \n  // ğŸ”§ FIX: Ensure branch point preview is reset in empty workspace state  \n  if (branchPointPreviewManager) {\n    branchPointPreviewManager.reset();\n    console.log('[EmptyWorkspace] Branch point preview reset - entering empty state');\n  }\n  \n  // éšè—è§†è§’é€‰æ‹©åŒºåŸŸ\n  const viewAngleSection = document.getElementById('view-angle-section');\n  if (viewAngleSection) {\n    viewAngleSection.style.display = 'none';\n  }\n  \n  // ğŸ”§ FIX: Clear image note button badge when initializing empty workspace\n  if (window.PlantAnnotationTool?.noteUI) {\n    window.PlantAnnotationTool.noteUI.updateImageNoteButton(null, null);\n    console.log('[EmptyWorkspace] Image note button badge cleared');\n  }\n  \n  // æ›´æ–°è¿›åº¦ä¿¡æ¯\n  updateProgressInfo('Please connect to dataset and select a plant');\n  \n  // ğŸ”§ NEW: Update delete button state when workspace is empty\n  updateDeletePlantAnnotationsButtonState();\n  \n  // ğŸ”§ NEW: Update complete plant button state when workspace is empty\n  updateCompletePlantButtonState();\n}\n\n/**\n * æ¸…ç©ºå·¥ä½œåŒºçŠ¶æ€\n */\nfunction clearWorkspaceState() {\n  console.log('æ¸…ç©ºå·¥ä½œåŒºçŠ¶æ€');\n  \n  // æ¸…ç©ºæ ‡æ³¨å·¥å…· - ä½¿ç”¨æ–°çš„clearImageæ–¹æ³•å®Œå…¨æ¸…ç©ºå›¾åƒ\n  if (annotationTool) {\n    annotationTool.clearImage(); // ğŸ”§ FIX: ä½¿ç”¨clearImageæ›¿ä»£resetViewï¼Œé˜²æ­¢æ˜¾ç¤ºæ®‹ç•™å›¾åƒ\n  }\n  \n  // ğŸ”§ FIX: Reset branch point preview when clearing workspace (no previous image context)\n  if (branchPointPreviewManager) {\n    branchPointPreviewManager.reset();\n    console.log('[Workspace] Branch point preview reset - no previous image context');\n  }\n  \n  // ğŸ”§ FIX: åœ¨æ¸…ç©ºå·¥ä½œåŒºåå†è®¾ç½® currentImage ä¸º nullï¼ˆé˜²æ­¢è‡ªåŠ¨ä¿å­˜å¼•ç”¨é”™è¯¯ï¼‰\n  appState.currentImage = null;\n  \n  // éšè—çŠ¶æ€æ˜¾ç¤º\n  hideAnnotationStatusDisplay();\n  \n  // æ¸…ç©ºç¼©ç•¥å›¾å®¹å™¨\n  const thumbnailContainer = document.getElementById('thumbnail-container');\n  if (thumbnailContainer) {\n    thumbnailContainer.innerHTML = '<div class=\"no-images\">Please choose view</div>';\n  }\n  \n  // é‡ç½®è§†è§’æŒ‰é’®\n  const viewAngleButtons = document.querySelectorAll('.btn-view-angle');\n  viewAngleButtons.forEach(button => {\n    button.classList.remove('selected');\n    button.disabled = true;\n  });\n  \n  // æ¸…ç©ºå½“å‰æ¤ç‰©æ ‡é¢˜\n  const titleElement = document.getElementById('current-plant-title');\n  if (titleElement && !appState.currentPlant) {\n    titleElement.textContent = 'Plant: Please select';\n  }\n  \n  // ğŸ”§ FIX: Clear image note button badge when no image is selected\n  if (window.PlantAnnotationTool?.noteUI) {\n    window.PlantAnnotationTool.noteUI.updateImageNoteButton(null, null);\n    console.log('[Workspace] Image note button badge cleared');\n  }\n}\n\n/**\n * å¤„ç†æ¤ç‰©é€‰æ‹©\n */\nasync function handlePlantSelect(plant) {\n  console.log('é€‰æ‹©æ¤ç‰©:', plant.id);\n  \n  // ç¡®ä¿plantDataManagerå·²åˆå§‹åŒ–\n  if (!plantDataManager) {\n    console.error('PlantDataManageræœªåˆå§‹åŒ–');\n    showError('ç³»ç»Ÿé”™è¯¯', 'æ•°æ®ç®¡ç†å™¨æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');\n    return;\n  }\n  \n  try {\n    // ğŸ”§ FIX: åœ¨åˆ‡æ¢æ¤ç‰©å‰å…ˆä¿å­˜å½“å‰å›¾åƒçš„æ ‡æ³¨ï¼ˆé˜²æ­¢æ ‡æ³¨ä¸¢å¤±ï¼‰\n    if (appState.currentImage && annotationTool) {\n      try {\n        const currentAnnotations = annotationTool.getAnnotationData();\n        if (currentAnnotations.keypoints.length > 0) {\n          console.log('æ¤ç‰©åˆ‡æ¢å‰è‡ªåŠ¨ä¿å­˜å½“å‰å›¾åƒæ ‡æ³¨:', appState.currentImage.id);\n          await plantDataManager.saveImageAnnotations(\n            appState.currentImage.id,\n            currentAnnotations.keypoints\n          );\n          console.log('æ¤ç‰©åˆ‡æ¢å‰æ ‡æ³¨ä¿å­˜æˆåŠŸ');\n          \n          // ğŸ”§ FIX: æ¤ç‰©åˆ‡æ¢å‰ä¿å­˜åç«‹å³åˆ·æ–°ç¼©ç•¥å›¾çŠ¶æ€\n          await refreshThumbnailAnnotationStatus(appState.currentImage.id);\n          console.log('æ¤ç‰©åˆ‡æ¢å‰ç¼©ç•¥å›¾çŠ¶æ€å·²åˆ·æ–°');\n        }\n      } catch (error) {\n        console.warn('æ¤ç‰©åˆ‡æ¢å‰è‡ªåŠ¨ä¿å­˜æ ‡æ³¨å¤±è´¥:', error);\n        // ä¸é˜»æ–­åˆ‡æ¢æµç¨‹ï¼Œä½†è®°å½•é”™è¯¯\n      }\n    }\n    \n    // æ¸…ç©ºå·¥ä½œåŒºçŠ¶æ€ - å½“åˆ‡æ¢æ¤ç‰©æ—¶\n    clearWorkspaceState();\n    \n    // æ›´æ–°å½“å‰æ¤ç‰©\n    appState.currentPlant = plant;\n    \n    // æ›´æ–°UI\n    updateCurrentPlantTitle(plant);\n    updatePlantItemSelection(plant.id);\n    \n    // åŠ è½½æ¤ç‰©å›¾åƒæ•°æ®ï¼ˆæ‰€æœ‰è§†è§’ï¼‰\n    updateProgressInfo(`Loading ${plant.id} image data...`);\n    const imagesByView = await plantDataManager.getPlantImages(plant.id);\n    \n    console.log(`æ¤ç‰© ${plant.id} å›¾åƒæ•°æ®:`, imagesByView);\n    \n    // æ›´æ–°ç¬”è®°ç³»ç»Ÿå½“å‰æ¤ç‰©\n    if (window.PlantAnnotationTool?.noteUI) {\n      window.PlantAnnotationTool.noteUI.setCurrentPlant(plant.id);\n    }\n\n    // é¢„åŠ è½½ç¬”è®°ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰\n    if (window.PlantAnnotationTool?.noteManager) {\n      // è·å–æ¤ç‰©çš„æ‰€æœ‰å›¾åƒIDè¿›è¡Œé¢„åŠ è½½\n      const allImageIds = Object.values(imagesByView).flat().map(img => img.id);\n      window.PlantAnnotationTool.noteManager.preloadNotes(plant.id, allImageIds.slice(0, 5)); // åªé¢„åŠ è½½å‰5ä¸ª\n    }\n    \n    // æ˜¾ç¤ºè§†è§’é€‰æ‹©ç•Œé¢\n    await showViewAngleSelection(plant, imagesByView);\n    \n    updateProgressInfo(`Loaded ${plant.id} - Total ${plant.imageCount} images`);\n    \n    // ğŸ”§ NEW: Update delete button state when plant is selected\n    updateDeletePlantAnnotationsButtonState();\n    \n    // ğŸ”§ NEW: Update complete plant button state when plant is selected\n    updateCompletePlantButtonState();\n    \n  } catch (error) {\n    console.error('é€‰æ‹©æ¤ç‰©å¤±è´¥:', error);\n    showError('åŠ è½½æ¤ç‰©æ•°æ®å¤±è´¥', error.message);\n  }\n}\n\n/**\n * æ˜¾ç¤ºè§†è§’é€‰æ‹©ç•Œé¢\n */\nasync function showViewAngleSelection(plant, imagesByView) {\n  const viewAngleSection = document.getElementById('view-angle-section');\n  const thumbnailContainer = document.getElementById('thumbnail-container');\n  const viewAngleInfo = document.getElementById('view-angle-info');\n  \n  if (!viewAngleSection || !thumbnailContainer || !viewAngleInfo) return;\n  \n  // æ˜¾ç¤ºè§†è§’é€‰æ‹©åŒºåŸŸ\n  viewAngleSection.style.display = 'block';\n  \n  // æ¸…ç©ºç¼©ç•¥å›¾\n  thumbnailContainer.innerHTML = '<div class=\"no-images\">Please choose view</div>';\n  \n  // æ›´æ–°è§†è§’ä¿¡æ¯\n  const availableViews = Object.keys(imagesByView).filter(view => imagesByView[view].length > 0);\n  viewAngleInfo.textContent = `available view: ${availableViews.length}`;\n  \n  // æ›´æ–°è§†è§’æŒ‰é’®çŠ¶æ€\n  const viewAngleButtons = document.querySelectorAll('.btn-view-angle');\n  viewAngleButtons.forEach(button => {\n    const viewAngle = button.dataset.viewAngle;\n    const hasImages = imagesByView[viewAngle] && imagesByView[viewAngle].length > 0;\n    \n    button.disabled = !hasImages;\n    button.classList.remove('selected');\n    \n    // æ›´æ–°æŒ‰é’®æ–‡æœ¬ï¼Œæ˜¾ç¤ºå›¾åƒæ•°é‡\n    const imageCount = hasImages ? imagesByView[viewAngle].length : 0;\n    const buttonText = button.textContent.split('(')[0].trim();\n    button.textContent = `${buttonText} (${imageCount})`;\n    \n    if (hasImages) {\n      button.title = `${viewAngle}: ${imageCount} images`;\n    } else {\n      button.title = `${viewAngle}: no image`;\n    }\n  });\n  \n  // å¦‚æœå·²ç»é€‰æ‹©äº†è§†è§’ï¼Œè‡ªåŠ¨é€‰ä¸­\n  if (plant.selectedViewAngle) {\n    const selectedButton = document.querySelector(`[data-view-angle=\"${plant.selectedViewAngle}\"]`);\n    if (selectedButton && !selectedButton.disabled) {\n      selectedButton.classList.add('selected');\n      // æ˜¾ç¤ºè¯¥è§†è§’çš„å›¾åƒ\n      await renderImageThumbnails(imagesByView[plant.selectedViewAngle] || []);\n    }\n  }\n}\n\n/**\n * å¤„ç†è§†è§’é€‰æ‹©\n */\nasync function handleViewAngleSelect(viewAngle) {\n  console.log('é€‰æ‹©è§†è§’:', viewAngle);\n  \n  if (!appState.currentPlant) {\n    showError('æ“ä½œå¤±è´¥', 'è¯·å…ˆé€‰æ‹©æ¤ç‰©');\n    return;\n  }\n  \n  try {\n    // æ›´æ–°è§†è§’æŒ‰é’®çŠ¶æ€\n    const viewAngleButtons = document.querySelectorAll('.btn-view-angle');\n    viewAngleButtons.forEach(button => {\n      button.classList.remove('selected');\n      if (button.dataset.viewAngle === viewAngle) {\n        button.classList.add('selected');\n      }\n    });\n    \n    // è®¾ç½®æ¤ç‰©çš„é€‰ä¸­è§†è§’\n    plantDataManager.setSelectedViewAngle(appState.currentPlant.id, viewAngle);\n    appState.currentPlant.selectedViewAngle = viewAngle;\n    \n    // è·å–è¯¥è§†è§’çš„å›¾åƒ\n    updateProgressInfo(`Loading ${viewAngle} image view...`);\n    const images = await plantDataManager.getPlantImages(appState.currentPlant.id, viewAngle);\n    \n    console.log(`${viewAngle} è§†è§’åŒ…å« ${images.length} å¼ å›¾åƒ`);\n\n    // æ˜¾ç¤ºå›¾åƒç¼©ç•¥å›¾\n    await renderImageThumbnails(images);\n    \n    // å¦‚æœæœ‰å›¾åƒï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€å¼ ï¼ˆé¦–æ¬¡åŠ è½½ï¼‰\n    if (images.length > 0) {\n      await handleImageSelect(images[0], false);\n    }\n    \n    updateProgressInfo(`å·²é€‰æ‹© ${viewAngle} è§†è§’ - ${images.length} å¼ å›¾åƒ`);\n    \n  } catch (error) {\n    console.error('é€‰æ‹©è§†è§’å¤±è´¥:', error);\n    showError('åŠ è½½è§†è§’æ•°æ®å¤±è´¥', error.message);\n  }\n}\n\n/**\n * æ›´æ–°å½“å‰æ¤ç‰©æ ‡é¢˜\n */\nfunction updateCurrentPlantTitle(plant) {\n  const titleElement = document.getElementById('current-plant-title');\n  if (titleElement) {\n    titleElement.textContent = `Plant: ${plant.id}`;\n  }\n}\n\n/**\n * æ›´æ–°æ¤ç‰©åˆ—è¡¨é¡¹é€‰ä¸­çŠ¶æ€\n */\nfunction updatePlantItemSelection(selectedPlantId) {\n  // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€\n  document.querySelectorAll('.plant-item').forEach(item => {\n    item.classList.remove('selected');\n  });\n  \n  // è®¾ç½®æ–°çš„é€‰ä¸­çŠ¶æ€\n  const selectedItem = document.querySelector(`[data-plant-id=\"${selectedPlantId}\"]`);\n  if (selectedItem) {\n    selectedItem.classList.add('selected');\n  }\n}\n\n/**\n * æ¸²æŸ“å›¾åƒç¼©ç•¥å›¾\n */\nasync function renderImageThumbnails(images) {\n  const container = document.getElementById('thumbnail-container');\n  if (!container) return;\n\n  // æ¸…ç©ºç°æœ‰å†…å®¹\n  container.innerHTML = '';\n\n  if (images.length === 0) {\n    container.innerHTML = '<div class=\"no-images\">è¯¥æ¤ç‰©æš‚æ— å›¾åƒ</div>';\n    return;\n  }\n\n  // åˆ›å»ºç¼©ç•¥å›¾ï¼ˆå¼‚æ­¥æ£€æŸ¥æ ‡æ³¨çŠ¶æ€ï¼‰\n  for (let i = 0; i < images.length; i++) {\n    const image = images[i];\n    const thumbnail = await createImageThumbnail(image, i === 0);\n    container.appendChild(thumbnail);\n  }\n\n  console.log(`æ¸²æŸ“äº† ${images.length} ä¸ªå›¾åƒç¼©ç•¥å›¾`);\n}\n\n/**\n * Create image thumbnail with note indicators\n */\nasync function createImageThumbnail(image, isFirst = false) {\n  const thumbnail = document.createElement('div');\n  thumbnail.className = 'image-thumbnail';\n  thumbnail.dataset.imageId = image.id;\n\n  if (isFirst) {\n    thumbnail.classList.add('selected');\n  }\n\n  // Check for annotations\n  let hasAnnotations = false;\n  let annotationCount = 0;\n\n  try {\n    if (plantDataManager) {\n      const annotations = await plantDataManager.getImageAnnotations(image.id);\n      if (annotations && annotations.length > 0) {\n        hasAnnotations = true;\n        annotationCount = annotations.length;\n        thumbnail.classList.add('has-annotations');\n      }\n    }\n  } catch (error) {\n    // Ignore errors, continue rendering\n  }\n\n  thumbnail.innerHTML = `\n    <div class=\"thumbnail-image\">\n      <img src=\"\" alt=\"${image.name}\" data-src=\"${image.id}\" />\n      <div class=\"thumbnail-loading\">Loading...</div>\n      ${hasAnnotations ? `<div class=\"annotation-badge\">${annotationCount}</div>` : ''}\n      <div class=\"image-note-badge\" id=\"image-note-badge-${image.id}\" style=\"display: none;\"></div>\n    </div>\n    <div class=\"thumbnail-info\">\n      <div class=\"image-time\">${image.timeString}</div>\n      ${hasAnnotations ? '<div class=\"annotation-status\">âœ“ Annotated</div>' : ''}\n    </div>\n  `;\n\n  // Click event (image switching)\n\n/**\n * åˆ·æ–°ç¼©ç•¥å›¾æ ‡æ³¨çŠ¶æ€ - ç”¨äºè‡ªåŠ¨ä¿å­˜åçš„UIåŒæ­¥\n */\nasync function refreshThumbnailAnnotationStatus(imageId) {\n  console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] å¼€å§‹åˆ·æ–°å›¾åƒ: ${imageId}`);\n  \n  const thumbnail = document.querySelector(`[data-image-id=\"${imageId}\"]`);\n  if (!thumbnail) {\n    console.warn(`[ç¼©ç•¥å›¾åˆ·æ–°] æ‰¾ä¸åˆ°å›¾åƒ ${imageId} çš„ç¼©ç•¥å›¾å…ƒç´ `);\n    return;\n  }\n  \n  try {\n    console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] æ­£åœ¨è·å–å›¾åƒ ${imageId} çš„æ ‡æ³¨æ•°æ®...`);\n    const annotations = await plantDataManager.getImageAnnotations(imageId);\n    const hasAnnotations = annotations && annotations.length > 0;\n    const annotationCount = annotations ? annotations.length : 0;\n    \n    console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] å›¾åƒ ${imageId} æ ‡æ³¨æ•°æ®: ${annotationCount} ä¸ªæ ‡æ³¨ç‚¹`);\n    \n    // æ›´æ–°ç¼©ç•¥å›¾ç±»\n    if (hasAnnotations) {\n      thumbnail.classList.add('has-annotations');\n      console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] æ·»åŠ äº† has-annotations ç±»`);\n    } else {\n      thumbnail.classList.remove('has-annotations');\n      console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] ç§»é™¤äº† has-annotations ç±»`);\n    }\n    \n    // æ›´æ–°æ ‡æ³¨å¾½ç« \n    let annotationBadge = thumbnail.querySelector('.annotation-badge');\n    if (hasAnnotations) {\n      if (!annotationBadge) {\n        annotationBadge = document.createElement('div');\n        annotationBadge.className = 'annotation-badge';\n        thumbnail.querySelector('.thumbnail-image').appendChild(annotationBadge);\n        console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] åˆ›å»ºäº†æ–°çš„æ ‡æ³¨å¾½ç« `);\n      }\n      annotationBadge.textContent = annotationCount;\n      console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] æ›´æ–°å¾½ç« æ•°é‡: ${annotationCount}`);\n    } else if (annotationBadge) {\n      annotationBadge.remove();\n      console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] ç§»é™¤äº†æ ‡æ³¨å¾½ç« `);\n    }\n    \n    // æ›´æ–°æ ‡æ³¨çŠ¶æ€æ–‡æœ¬\n    let statusElement = thumbnail.querySelector('.annotation-status');\n    if (hasAnnotations) {\n      if (!statusElement) {\n        statusElement = document.createElement('div');\n        statusElement.className = 'annotation-status';\n        statusElement.textContent = 'âœ“ Annotated';\n        thumbnail.querySelector('.thumbnail-info').appendChild(statusElement);\n        console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] åˆ›å»ºäº† 'âœ“ Annotated' çŠ¶æ€`);\n      }\n    } else if (statusElement) {\n      statusElement.remove();\n      console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] ç§»é™¤äº† 'âœ“ Annotated' çŠ¶æ€`);\n    }\n    \n    console.log(`[ç¼©ç•¥å›¾åˆ·æ–°] å®Œæˆåˆ·æ–°å›¾åƒ ${imageId}`);\n    \n  } catch (error) {\n    console.error(`[ç¼©ç•¥å›¾åˆ·æ–°] åˆ·æ–°å¤±è´¥:`, error);\n  }\n}\n\n// ğŸ”§ FIX: å°†åˆ·æ–°å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¾›AnnotationToolè°ƒç”¨\nwindow.refreshThumbnailAnnotationStatus = refreshThumbnailAnnotationStatus;\n  thumbnail.addEventListener('click', () => handleImageSelect(image, true));\n\n  // Async load image\n  loadThumbnailImage(thumbnail, image);\n  \n  // Async load note count\n  if (appState.currentPlant) {\n    loadImageNoteCount(appState.currentPlant.id, image.id);\n  }\n\n  return thumbnail;\n}\n\n/**\n * å¼‚æ­¥åŠ è½½ç¼©ç•¥å›¾å›¾åƒ\n */\nasync function loadThumbnailImage(thumbnailElement, imageData) {\n  try {\n    const imgElement = thumbnailElement.querySelector('img');\n    const loadingElement = thumbnailElement.querySelector('.thumbnail-loading');\n    \n    // æ£€æŸ¥plantDataManageræ˜¯å¦å·²åˆå§‹åŒ–\n    if (!plantDataManager || !plantDataManager.fileSystemManager) {\n      console.error('PlantDataManageræˆ–FileSystemManageræœªåˆå§‹åŒ–');\n      loadingElement.textContent = 'åˆå§‹åŒ–é”™è¯¯';\n      loadingElement.style.color = '#dc2626';\n      return;\n    }\n    \n    // åˆ›å»ºå›¾åƒURL\n    const imageURL = await plantDataManager.fileSystemManager.createImageURL(imageData);\n    \n    // åŠ è½½å›¾åƒ\n    imgElement.onload = () => {\n      loadingElement.style.display = 'none';\n      imgElement.style.display = 'block';\n    };\n    \n    imgElement.onerror = () => {\n      loadingElement.textContent = 'åŠ è½½å¤±è´¥';\n      loadingElement.style.color = '#dc2626';\n    };\n    \n    imgElement.src = imageURL;\n    \n  } catch (error) {\n    console.error('åŠ è½½ç¼©ç•¥å›¾å¤±è´¥:', error);\n    const loadingElement = thumbnailElement.querySelector('.thumbnail-loading');\n    loadingElement.textContent = 'åŠ è½½å¤±è´¥';\n    loadingElement.style.color = '#dc2626';\n  }\n}\n\n/**\n * å¤„ç†å›¾åƒé€‰æ‹©\n */\nasync function handleImageSelect(image, isImageSwitch = true) {\n  // ğŸ”§ FIX: Prevent race conditions during rapid navigation\n  if (appState.navigation.isNavigating) {\n    console.log(`[Navigation] Blocked concurrent navigation to ${image.name} - already navigating`);\n    return;\n  }\n\n  // ğŸ”§ FIX: Throttle rapid navigation attempts with user feedback\n  const now = Date.now();\n  if (now - appState.navigation.lastNavigationTime < appState.navigation.throttleDelay) {\n    console.log(`[Navigation] Throttled navigation to ${image.name} - too fast (${now - appState.navigation.lastNavigationTime}ms since last)`);\n    // ğŸ”§ NEW: Optional visual feedback for throttled navigation\n    if (window.updateProgressInfo) {\n      const remaining = appState.navigation.throttleDelay - (now - appState.navigation.lastNavigationTime);\n      window.updateProgressInfo(`Navigation throttled - please wait ${remaining}ms`);\n      // Clear the message after a short delay\n      setTimeout(() => {\n        if (window.updateProgressInfo) {\n          window.updateProgressInfo('Ready for navigation');\n        }\n      }, remaining + 100);\n    }\n    return;\n  }\n\n  // Lock navigation\n  appState.navigation.isNavigating = true;\n  appState.navigation.lastNavigationTime = now;\n\n  try {\n    console.log('é€‰æ‹©å›¾åƒ:', image.name);\n    \n    // ä¿å­˜å½“å‰å›¾åƒçš„æ ‡æ³¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰\n    if (appState.currentImage && annotationTool) {\n      try {\n        // ğŸ”§ FIX: Store the image ID to prevent race condition corruption\n        const imageToSave = appState.currentImage.id;\n        const currentAnnotations = annotationTool.getAnnotationData();\n        if (currentAnnotations.keypoints.length > 0) {\n          console.log(`[Auto-save] Saving ${currentAnnotations.keypoints.length} annotations for ${imageToSave}`);\n          await plantDataManager.saveImageAnnotations(\n            imageToSave,\n            currentAnnotations.keypoints\n          );\n          console.log(`[Auto-save] Successfully saved annotations for ${imageToSave}`);\n          \n          // ğŸ”§ FIX: è‡ªåŠ¨ä¿å­˜åç«‹å³åˆ·æ–°ç¼©ç•¥å›¾çŠ¶æ€\n          await refreshThumbnailAnnotationStatus(imageToSave);\n          console.log(`[Auto-save] Thumbnail status refreshed for ${imageToSave}`);\n        }\n      } catch (error) {\n        console.warn(`[Auto-save] Failed to save annotations for ${appState.currentImage?.id}:`, error);\n      }\n    }\n    \n    // æ£€æµ‹æ˜¯å¦ä¸ºè¯¥æ¤ç‰©çš„é¦–å¼ å›¾åƒåŠ è½½\n    const isFirstImageForPlant = !appState.currentImage || \n                                (appState.currentPlant && appState.currentImage && \n                                 !appState.currentImage.id.startsWith(appState.currentPlant.id));\n    \n    // æ›´æ–°åº”ç”¨çŠ¶æ€\n    appState.currentImage = image;\n    \n    // æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€\n    updateImageThumbnailSelection(image.id);\n    \n    // æ›´æ–°ç¬”è®°ç³»ç»Ÿå½“å‰å›¾åƒ\n    if (window.PlantAnnotationTool?.noteUI) {\n      window.PlantAnnotationTool.noteUI.setCurrentImage(image.id);\n    }\n    \n    // è®¾ç½®æ¤ç‰©çš„é€‰ä¸­å›¾åƒï¼ˆé‡è¦ï¼šè¿™é‡Œæ¢å¤äº†åŸæ¥çš„é€»è¾‘ï¼‰\n    if (appState.currentPlant) {\n      plantDataManager.setSelectedImage(appState.currentPlant.id, image);\n    }\n    \n    // åŠ è½½å›¾åƒåˆ°æ ‡æ³¨å·¥å…·\n    if (annotationTool) {\n      // å¼ºåˆ¶åˆ·æ–°Canvaså°ºå¯¸ï¼Œç¡®ä¿æ­£ç¡®è®¡ç®—\n      annotationTool.resizeCanvas();\n\n      // è·å–é”å®šå€æ•°è®¾ç½®å’Œè‡ªåŠ¨åˆ‡æ¢è®¾ç½®\n      const zoomSettings = getZoomLockSettings();\n      const autoMoveSettings = getAutoMoveSettings();\n\n      // å†³å®šæ˜¯å¦ä¿æŒè§†å›¾çŠ¶æ€ï¼šåªæœ‰åœ¨éé¦–å¼ å›¾åƒä¸”æ˜¯å›¾åƒåˆ‡æ¢æ—¶æ‰ä¿æŒ\n      const shouldPreserveView = isImageSwitch && !isFirstImageForPlant;\n      console.log(`[è°ƒè¯•] isImageSwitch: ${isImageSwitch}, isFirstImageForPlant: ${isFirstImageForPlant}, shouldPreserveView: ${shouldPreserveView}`);\n      \n      await annotationTool.loadImage(image, shouldPreserveView);\n\n      // æ›´æ–°SIFTæŒ‰é’®çŠ¶æ€\n      updateSiftButtonState();\n\n      // åº”ç”¨é”å®šå€æ•°è®¾ç½®æˆ–ç¡®ä¿é¦–å¼ å›¾åƒé€‚åˆå±å¹•\n      if (isFirstImageForPlant) {\n        // é¦–å¼ å›¾åƒå§‹ç»ˆé€‚åˆå±å¹•\n        console.log('é¦–å¼ å›¾åƒï¼šé‡ç½®è§†å›¾åˆ°é€‚åˆå±å¹•');\n        setTimeout(() => {\n          annotationTool.fitToScreen();\n        }, 100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿å›¾åƒåŠ è½½å®Œæˆ\n      } else if (isImageSwitch && zoomSettings.isLocked) {\n        // å›¾ç‰‡åˆ‡æ¢ä¸”å¯ç”¨äº†é”å®šå€æ•°\n        annotationTool.setZoom(zoomSettings.lockValue);\n        console.log(`å›¾ç‰‡åˆ‡æ¢ï¼šåº”ç”¨é”å®šå€æ•° ${zoomSettings.lockValue}x`);\n      } else if (isImageSwitch) {\n        console.log('å›¾ç‰‡åˆ‡æ¢ï¼šä¿æŒå½“å‰ç¼©æ”¾å’Œè§†å›¾çŠ¶æ€');\n      } else {\n        console.log('å…¶ä»–æƒ…å†µï¼šé‡ç½®è§†å›¾åˆ°é€‚åˆå±å¹•');\n        annotationTool.fitToScreen();\n      }\n      \n      // åŠ è½½å·²æœ‰çš„æ ‡æ³¨æ•°æ®\n      try {\n        console.log(`[æ ‡æ³¨] å¼€å§‹åŠ è½½å›¾åƒæ ‡æ³¨: ${image.id}`);\n        const existingAnnotations = await plantDataManager.getImageAnnotations(image.id);\n        if (existingAnnotations && existingAnnotations.length > 0) {\n          annotationTool.loadAnnotationData({ keypoints: existingAnnotations });\n          console.log(`[æ ‡æ³¨] åŠ è½½äº† ${existingAnnotations.length} ä¸ªå·²æœ‰æ ‡æ³¨ç‚¹`);\n          \n          // ğŸ”§ FIX: åŒæ­¥è‡ªå®šä¹‰æ ‡æ³¨åˆ°CustomAnnotationManagerå†…éƒ¨çŠ¶æ€\n          if (annotationTool.customAnnotationManager) {\n            const customAnnotations = existingAnnotations.filter(ann => ann.annotationType === 'custom');\n            if (customAnnotations.length > 0) {\n              console.log(`[è‡ªå®šä¹‰æ ‡æ³¨] å‘ç° ${customAnnotations.length} ä¸ªè‡ªå®šä¹‰æ ‡æ³¨ï¼ŒåŒæ­¥åˆ°CustomAnnotationManager`);\n              annotationTool.customAnnotationManager.syncAnnotationsFromKeypoints(image.id, customAnnotations);\n            }\n          }\n\n          // ğŸ”§ FIX: åªæœ‰åœ¨å¼€å¯è‡ªåŠ¨ç§»åŠ¨æ—¶æ‰ç§»åŠ¨è§†è§’åˆ°æœ€é«˜æ ‡è®°ç‚¹\n          if (annotationTool.state.autoMoveToExpectedPosition) {\n            setTimeout(() => {\n              annotationTool.moveToHighestKeypoint();\n              console.log('[è‡ªåŠ¨ç§»åŠ¨] ç§»åŠ¨è§†è§’åˆ°æœ€é«˜æ ‡è®°ç‚¹ï¼ˆauto-moveå·²å¼€å¯ï¼‰');\n            }, 100); // ç¨å¾®å»¶è¿Ÿç¡®ä¿æ¸²æŸ“å®Œæˆ\n          } else {\n            console.log('[è‡ªåŠ¨ç§»åŠ¨] è·³è¿‡ç§»åŠ¨åˆ°æœ€é«˜æ ‡è®°ç‚¹ï¼ˆauto-moveå·²å…³é—­ï¼‰');\n          }\n        } else {\n          // å¦‚æœæ²¡æœ‰å·²æœ‰æ ‡æ³¨ï¼Œæ¸…ç©ºæ ‡æ³¨å·¥å…·\n          annotationTool.clearKeypoints();\n          console.log(`[æ ‡æ³¨] å›¾åƒ ${image.id} æ— æ ‡æ³¨æ•°æ®`);\n        }\n      } catch (error) {\n        console.warn('[æ ‡æ³¨] åŠ è½½æ ‡æ³¨æ•°æ®å¤±è´¥:', error);\n        annotationTool.clearKeypoints();\n      }\n    } else {\n      console.error('AnnotationToolæœªåˆå§‹åŒ–');\n      showError('æ ‡æ³¨å·¥å…·é”™è¯¯', 'æ ‡æ³¨å·¥å…·æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');\n    }\n    \n    // æ›´æ–°åˆ†æ”¯ç‚¹é¢„è§ˆ\n    if (branchPointPreviewManager && appState.currentPlant) {\n      try {\n        const images = await plantDataManager.getPlantImages(\n          appState.currentPlant.id, \n          appState.currentPlant.selectedViewAngle\n        );\n        const imageIndex = images.findIndex(img => img.id === image.id);\n        const currentKeypointCount = annotationTool ? annotationTool.keypoints.length : 0;\n        \n        await branchPointPreviewManager.updateContext(\n          appState.currentPlant.id,\n          appState.currentPlant.selectedViewAngle,\n          imageIndex,\n          currentKeypointCount\n        );\n      } catch (error) {\n        console.warn('æ›´æ–°åˆ†æ”¯ç‚¹é¢„è§ˆå¤±è´¥:', error);\n      }\n    }\n    \n    // æ›´æ–°æ ‡æ³¨çŠ¶æ€æ˜¾ç¤º\n    await updateAnnotationStatusDisplay();\n\n    // è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®ï¼ˆå¦‚æœå¼€å¯ï¼‰\n    if (annotationTool) {\n      setTimeout(() => {\n        annotationTool.moveToExpectedPosition(isImageSwitch);\n      }, 100); // ç¨å¾®å»¶è¿Ÿç¡®ä¿æ¸²æŸ“å®Œæˆ\n    }\n\n    console.log('å›¾åƒé€‰æ‹©å®Œæˆ');\n    \n  } catch (error) {\n    console.error('å›¾åƒé€‰æ‹©å¤±è´¥:', error);\n    showError('å›¾åƒåŠ è½½å¤±è´¥', error.message);\n  } finally {\n    // ğŸ”§ FIX: Always unlock navigation to prevent permanent locks\n    appState.navigation.isNavigating = false;\n    console.log(`[Navigation] Navigation unlocked after processing ${image.name}`);\n  }\n}\n\n/**\n * æ›´æ–°ç¼©ç•¥å›¾é€‰æ‹©çŠ¶æ€å¹¶æ»šåŠ¨åˆ°å¯¹åº”ä½ç½®\n */\nfunction updateImageThumbnailSelection(selectedImageId) {\n  // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€\n  document.querySelectorAll('.image-thumbnail').forEach(thumb => {\n    thumb.classList.remove('selected');\n  });\n  \n  // è®¾ç½®æ–°çš„é€‰ä¸­çŠ¶æ€\n  const selectedThumb = document.querySelector(`[data-image-id=\"${selectedImageId}\"]`);\n  if (selectedThumb) {\n    selectedThumb.classList.add('selected');\n    \n    // æ»šåŠ¨åˆ°é€‰ä¸­çš„ç¼©ç•¥å›¾\n    scrollToThumbnail(selectedThumb);\n  }\n}\n\n/**\n * æ»šåŠ¨åˆ°æŒ‡å®šçš„ç¼©ç•¥å›¾ï¼Œä½¿å…¶åœ¨è§†å›¾å‚ç›´ä¸­å¤®\n */\nfunction scrollToThumbnail(thumbnailElement) {\n  const container = document.getElementById('thumbnail-container');\n  if (!container || !thumbnailElement) return;\n  \n  try {\n    // è·å–å®¹å™¨å’Œç¼©ç•¥å›¾çš„å°ºå¯¸ä¿¡æ¯\n    const containerRect = container.getBoundingClientRect();\n    const thumbnailRect = thumbnailElement.getBoundingClientRect();\n    \n    // è®¡ç®—éœ€è¦æ»šåŠ¨çš„è·ç¦»ï¼Œä½¿ç¼©ç•¥å›¾åœ¨å®¹å™¨å‚ç›´ä¸­å¤®\n    const containerScrollTop = container.scrollTop;\n    const thumbnailOffsetTop = thumbnailElement.offsetTop;\n    const containerHeight = containerRect.height;\n    const thumbnailHeight = thumbnailRect.height;\n    \n    // è®¡ç®—ç›®æ ‡æ»šåŠ¨ä½ç½®ï¼šç¼©ç•¥å›¾ä¸­å¿ƒå¯¹é½åˆ°å®¹å™¨ä¸­å¿ƒ\n    const targetScrollTop = thumbnailOffsetTop - (containerHeight / 2) + (thumbnailHeight / 2);\n    \n    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®\n    container.scrollTo({\n      top: targetScrollTop,\n      behavior: 'smooth'\n    });\n    \n    console.log(`æ»šåŠ¨åˆ°ç¼©ç•¥å›¾: ${thumbnailElement.dataset.imageId}`);\n    \n  } catch (error) {\n    console.warn('æ»šåŠ¨åˆ°ç¼©ç•¥å›¾å¤±è´¥:', error);\n  }\n}\n\n/**\n * æ›´æ–°æ ‡æ³¨çŠ¶æ€æ˜¾ç¤º\n */\nasync function updateAnnotationStatusDisplay() {\n  if (!appState.currentPlant || !appState.currentImage) {\n    hideAnnotationStatusDisplay();\n    return;\n  }\n\n  const statusSection = document.getElementById('annotation-status-section');\n  const currentImageIndex = document.getElementById('current-image-index');\n  const annotationSource = document.getElementById('annotation-source');\n  const timeSeriesStats = document.getElementById('time-series-stats');\n  const manualAdjustmentNotice = document.getElementById('manual-adjustment-notice');\n\n  if (!statusSection) return;\n\n  // æ˜¾ç¤ºçŠ¶æ€åŒºåŸŸ\n  statusSection.style.display = 'block';\n\n  try {\n    // è·å–å½“å‰è§†è§’çš„æ‰€æœ‰å›¾åƒ\n    const images = await plantDataManager.getPlantImages(\n      appState.currentPlant.id, \n      appState.currentPlant.selectedViewAngle\n    );\n    \n    const currentIndex = images.findIndex(img => img.id === appState.currentImage.id);\n    \n    // æ›´æ–°å½“å‰å›¾åƒç´¢å¼•\n    currentImageIndex.textContent = currentIndex >= 0 ? \n      `${currentIndex + 1} / ${images.length}` : \n      '- / -';\n\n    // æ£€æŸ¥å½“å‰å›¾åƒæ˜¯å¦æœ‰æ ‡æ³¨\n    const savedAnnotations = await plantDataManager.getImageAnnotations(appState.currentImage.id);\n    const hasAnnotations = savedAnnotations && savedAnnotations.length > 0;\n\n    // æ›´æ–°æ ‡æ³¨æ¥æº\n    if (hasAnnotations) {\n      annotationSource.textContent = 'Document';\n    } else {\n      annotationSource.textContent = 'No annotation';\n    }\n\n    // è®¡ç®—è§†è§’ç»Ÿè®¡\n    let annotatedCount = 0;\n    for (const image of images) {\n      const imageAnnotations = await plantDataManager.getImageAnnotations(image.id);\n      if (imageAnnotations && imageAnnotations.length > 0) {\n        annotatedCount++;\n      }\n    }\n    \n    const coverage = images.length > 0 ? Math.round((annotatedCount / images.length) * 100) : 0;\n    timeSeriesStats.textContent = `${annotatedCount}/${images.length} (${coverage}%)`;\n\n    // éšè—å¾®è°ƒæ¨¡å¼é€šçŸ¥ï¼ˆæ–°æ–¹æ¡ˆä¸éœ€è¦ï¼‰\n    manualAdjustmentNotice.style.display = 'none';\n    \n  } catch (error) {\n    console.error('æ›´æ–°æ ‡æ³¨çŠ¶æ€æ˜¾ç¤ºå¤±è´¥:', error);\n    hideAnnotationStatusDisplay();\n  }\n}\n\n/**\n * éšè—æ ‡æ³¨çŠ¶æ€æ˜¾ç¤º\n */\nfunction hideAnnotationStatusDisplay() {\n  const statusSection = document.getElementById('annotation-status-section');\n  const manualAdjustmentNotice = document.getElementById('manual-adjustment-notice');\n\n  if (statusSection) statusSection.style.display = 'none';\n  if (manualAdjustmentNotice) manualAdjustmentNotice.style.display = 'none';\n}\n\n/**\n * å¤„ç†ä¿å­˜æ ‡æ³¨ - æ˜¾ç¤ºæ¨¡æ€æ¡†\n */\nasync function handleSaveAnnotation() {\n  if (!annotationTool || !appState.currentPlant) {\n    showError('ä¿å­˜å¤±è´¥', 'è¯·å…ˆé€‰æ‹©æ¤ç‰©å’Œå›¾åƒ');\n    return;\n  }\n  \n  const annotationData = annotationTool.getAnnotationData();\n  \n  if (annotationData.keypoints.length === 0) {\n    showError('ä¿å­˜å¤±è´¥', 'è¯·å…ˆæ·»åŠ æ ‡æ³¨ç‚¹');\n    return;\n  }\n  \n  // æ˜¾ç¤ºä¿å­˜ç¡®è®¤æ¨¡æ€æ¡†\n  showSaveAnnotationModal();\n}\n\n/**\n * æ˜¾ç¤ºä¿å­˜æ ‡æ³¨æ¨¡æ€æ¡†\n */\nfunction showSaveAnnotationModal() {\n  const modal = document.getElementById('save-annotation-modal');\n  if (modal) {\n    modal.style.display = 'flex';\n  }\n}\n\n/**\n * éšè—ä¿å­˜æ ‡æ³¨æ¨¡æ€æ¡†\n */\nfunction hideSaveAnnotationModal() {\n  const modal = document.getElementById('save-annotation-modal');\n  if (modal) {\n    modal.style.display = 'none';\n  }\n}\n\n/**\n * æ‰§è¡Œå®é™…çš„ä¿å­˜æ“ä½œ\n */\nasync function performSaveAnnotation(isManualAdjustment) {\n  if (!annotationTool || !appState.currentPlant) {\n    showError('ä¿å­˜å¤±è´¥', 'è¯·å…ˆé€‰æ‹©æ¤ç‰©å’Œå›¾åƒ');\n    return;\n  }\n  \n  try {\n    const annotationData = annotationTool.getAnnotationData();\n    \n    if (annotationData.keypoints.length === 0) {\n      showError('ä¿å­˜å¤±è´¥', 'è¯·å…ˆæ·»åŠ æ ‡æ³¨ç‚¹');\n      return;\n    }\n    \n    // è·å–æ–¹å‘ä¿å­˜æ¨¡å¼\n    const directionSaveMode = document.querySelector('input[name=\"direction-save-mode\"]:checked');\n    const saveDirectionsOnly = directionSaveMode && directionSaveMode.value === 'directions-only';\n    \n    // ä¿å­˜æ ‡æ³¨æ•°æ®\n    const saveResult = await plantDataManager.savePlantAnnotations(\n      appState.currentPlant.id, \n      annotationData.keypoints, \n      isManualAdjustment,\n      { saveDirectionsOnly } // ä¼ é€’æ–¹å‘ä¿å­˜é€‰é¡¹\n    );\n    \n    updateProgressInfo(saveResult.message || `å·²ä¿å­˜ ${annotationData.keypoints.length} ä¸ªæ ‡æ³¨ç‚¹`);\n    \n    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º\n    updateAnnotationStatusDisplay();\n    \n    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º\n    updateProgressStats();\n    \n    // æ›´æ–°åˆ†æ”¯ç‚¹é¢„è§ˆï¼ˆé‡æ–°è®¡ç®—æ ‡æ³¨ç‚¹æ•°é‡ï¼‰\n    if (branchPointPreviewManager && appState.currentPlant && appState.currentImage) {\n      const images = await plantDataManager.getPlantImages(\n        appState.currentPlant.id, \n        appState.currentPlant.selectedViewAngle\n      );\n      const imageIndex = images.findIndex(img => img.id === appState.currentImage.id);\n      const currentAnnotations = await plantDataManager.getImageAnnotations(appState.currentImage.id);\n      const currentKeypointCount = currentAnnotations ? currentAnnotations.length : 0;\n      \n      await branchPointPreviewManager.updateContext(\n        appState.currentPlant.id,\n        appState.currentPlant.selectedViewAngle,\n        imageIndex,\n        currentKeypointCount\n      );\n    }\n    \n    console.log('æ ‡æ³¨æ•°æ®å·²ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨');\n    \n    // ğŸ”§ FIX: ç«‹å³åˆ·æ–°å½“å‰å›¾åƒçš„ç¼©ç•¥å›¾æ ‡æ³¨çŠ¶æ€\n    if (appState.currentImage) {\n      await refreshThumbnailAnnotationStatus(appState.currentImage.id);\n      console.log('ç¼©ç•¥å›¾æ ‡æ³¨çŠ¶æ€å·²åˆ·æ–°');\n    }\n    \n    // ğŸ”§ FIX: å¦‚æœæ˜¯ä¼ æ’­ä¿å­˜ï¼Œåˆ·æ–°æ‰€æœ‰å—å½±å“çš„ç¼©ç•¥å›¾\n    if (!isManualAdjustment && saveResult.affectedImages && saveResult.affectedImages.length > 0) {\n      console.log(`åˆ·æ–° ${saveResult.affectedImages.length} ä¸ªå—å½±å“å›¾åƒçš„ç¼©ç•¥å›¾çŠ¶æ€`);\n      for (const imageId of saveResult.affectedImages) {\n        await refreshThumbnailAnnotationStatus(imageId);\n      }\n    }\n    \n    // ğŸ”§ FIX: åˆ·æ–°æ¤ç‰©ç¬”è®°å¾½ç« ï¼ˆæ ‡æ³¨å¯èƒ½å½±å“ç¬”è®°ç»Ÿè®¡ï¼‰\n    if (window.PlantAnnotationTool?.noteUI && appState.currentPlant) {\n      await window.PlantAnnotationTool.noteUI.updatePlantNoteBadge(appState.currentPlant.id);\n      console.log('æ¤ç‰©ç¬”è®°å¾½ç« å·²åˆ·æ–°');\n    }\n    \n    // éšè—æ¨¡æ€æ¡†\n    hideSaveAnnotationModal();\n    \n  } catch (error) {\n    console.error('ä¿å­˜æ ‡æ³¨å¤±è´¥:', error);\n    showError('ä¿å­˜å¤±è´¥', `ä¿å­˜æ ‡æ³¨æ•°æ®æ—¶å‡ºé”™: ${error.message}`);\n  }\n}\n\n/**\n * ğŸ”§ NEW: å¤„ç†å®Œæˆ/æ’¤é”€å®Œæˆæ¤ç‰© (ç»Ÿä¸€å¤„ç†å‡½æ•°)\n */\nfunction handleCompletePlant() {\n  if (!appState.currentPlant) {\n    showError('æ“ä½œå¤±è´¥', 'è¯·å…ˆé€‰æ‹©æ¤ç‰©');\n    return;\n  }\n  \n  const plant = appState.currentPlant;\n  \n  // æ ¹æ®å½“å‰çŠ¶æ€å†³å®šæ“ä½œ\n  if (plant.status === 'completed') {\n    // å¦‚æœå·²å®Œæˆï¼Œåˆ™æ’¤é”€å®Œæˆ\n    showUncompletePlantModal(plant.id);\n  } else {\n    // å¦‚æœæœªå®Œæˆï¼Œåˆ™å®Œæˆæ¤ç‰©\n    if (plant.status === 'skipped') {\n      showError('æ“ä½œé”™è¯¯', 'æ— æ³•å®Œæˆå·²è·³è¿‡çš„æ¤æ ªï¼Œè¯·å…ˆæ’¤é”€è·³è¿‡');\n      return;\n    }\n    \n    const confirmMessage = `ç¡®å®šè¦æ ‡è®°æ¤æ ª \"${plant.id}\" ä¸ºå·²å®Œæˆå—ï¼Ÿ`;\n    \n    if (!confirm(confirmMessage)) {\n      return;\n    }\n    \n    try {\n      // æ ‡è®°æ¤ç‰©ä¸ºå·²å®Œæˆ\n      plantDataManager.updatePlantStatus(plant.id, 'completed');\n      plant.status = 'completed';\n      \n      // é‡æ–°æ¸²æŸ“æ¤æ ªåˆ—è¡¨é¡¹\n      const plantItem = document.querySelector(`[data-plant-id=\"${plant.id}\"]`);\n      if (plantItem) {\n        const newItem = createPlantListItem(plant);\n        plantItem.parentNode.replaceChild(newItem, plantItem);\n        \n        // ğŸ”§ FIX: Update note badge for the re-rendered plant item\n        if (window.PlantAnnotationTool?.noteUI) {\n          setTimeout(() => {\n            window.PlantAnnotationTool.noteUI.updatePlantNoteBadge(plant.id);\n          }, 100);\n        }\n      }\n      \n      // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º\n      updateProgressStats();\n      \n      // æ›´æ–°æŒ‰é’®çŠ¶æ€\n      updateCompletePlantButtonState();\n      \n      showSuccess('å®ŒæˆæˆåŠŸ', `æ¤æ ª ${plant.id} å·²æ ‡è®°ä¸ºå®Œæˆ`);\n      \n      // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„æ¤ç‰©\n      const nextPlant = plantDataManager.getNextPendingPlant(plant.id);\n      \n      if (nextPlant) {\n        // è¯¢é—®æ˜¯å¦è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæ¤ç‰©\n        const shouldNavigate = confirm(`æ¤æ ª ${plant.id} å·²å®Œæˆï¼\\n\\næ˜¯å¦è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„æ¤æ ª ${nextPlant.id}ï¼Ÿ`);\n        if (shouldNavigate) {\n          handlePlantSelect(nextPlant);\n          updateProgressInfo(`å·²å®Œæˆ ${plant.id}ï¼Œè·³è½¬åˆ° ${nextPlant.id}`);\n        }\n      } else {\n        updateProgressInfo('æ­å–œï¼æ‰€æœ‰æ¤ç‰©éƒ½å·²å®Œæˆæ ‡æ³¨');\n      }\n      \n    } catch (error) {\n      console.error('å®Œæˆæ¤ç‰©å¤±è´¥:', error);\n      showError('æ“ä½œå¤±è´¥', error.message);\n    }\n  }\n}\n\n/**\n * å¤„ç†å¯¼å‡ºæ•°æ®\n */\nasync function handleExportData() {\n  if (!plantDataManager) {\n    showError('å¯¼å‡ºå¤±è´¥', 'è¯·å…ˆåŠ è½½æ•°æ®é›†');\n    return;\n  }\n  \n  try {\n    // æ˜¾ç¤ºå¯¼å‡ºæ ¼å¼é€‰æ‹©\n    await showExportOptionsModal();\n    \n  } catch (error) {\n    console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);\n    showError('å¯¼å‡ºå¤±è´¥', error.message);\n  }\n}\n\n/**\n * æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡†\n */\nasync function showExportOptionsModal() {\n  // Create modal HTML\n  const modalHTML = `\n    <div id=\"export-modal\" class=\"modal\" style=\"display: flex;\">\n      <div class=\"modal-content\" style=\"max-width: 600px; max-height: 90vh; overflow-y: auto;\">\n        <h3>Export Annotation Data</h3>\n\n        <!-- Statistics Area -->\n        <div id=\"export-stats\" style=\"background: #f9fafb; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 14px;\">\n          <div style=\"font-weight: 600; margin-bottom: 10px;\">Data Statistics:</div>\n          <div id=\"stats-content\">Loading...</div>\n        </div>\n\n        <!-- Preview Area -->\n        <div style=\"margin: 20px 0;\">\n          <div style=\"display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;\">\n            <h4 style=\"margin: 0;\">Export Data Preview</h4>\n            <button id=\"refresh-preview-btn\" class=\"btn btn-secondary\" style=\"padding: 5px 15px; font-size: 14px;\">Refresh Preview</button>\n          </div>\n          <div id=\"export-preview\" style=\"background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto;\">\n            Generating preview...\n          </div>\n        </div>\n\n        <div style=\"display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;\">\n          <button id=\"export-cancel-btn\" class=\"btn btn-secondary\">Cancel</button>\n          <button id=\"export-confirm-btn\" class=\"btn btn-primary\">Confirm Export</button>\n        </div>\n      </div>\n    </div>\n  `;\n  \n  // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†\n  const existingModal = document.getElementById('export-modal');\n  if (existingModal) {\n    existingModal.remove();\n  }\n  \n  // æ·»åŠ åˆ°body\n  document.body.insertAdjacentHTML('beforeend', modalHTML);\n  \n  // è·å–ç»Ÿè®¡ä¿¡æ¯å¹¶æ˜¾ç¤º\n  await updateExportStats();\n\n  // ç”Ÿæˆå¯¼å‡ºé¢„è§ˆ\n  await generateExportPreview();\n\n  // ç»‘å®šäº‹ä»¶\n  document.getElementById('export-cancel-btn').addEventListener('click', () => {\n    document.getElementById('export-modal').remove();\n  });\n\n  document.getElementById('export-confirm-btn').addEventListener('click', async () => {\n    document.getElementById('export-modal').remove();\n    await performExport();\n  });\n\n  document.getElementById('refresh-preview-btn').addEventListener('click', async () => {\n    await generateExportPreview();\n  });\n}\n\n/**\n * æ›´æ–°å¯¼å‡ºç»Ÿè®¡ä¿¡æ¯\n */\nasync function updateExportStats() {\n  const statsContent = document.getElementById('stats-content');\n  if (!statsContent) return;\n\n  try {\n    // ç›´æ¥ä»æ–‡ä»¶ç³»ç»Ÿè·å–æ ‡æ³¨æ•°æ®ç»Ÿè®¡\n    const exportData = await getDirectExportData();\n    const stats = calculateExportStats(exportData);\n\n    const html = `\n      <div>ğŸ“Š Annotated Images: <strong>${stats.annotatedImages}</strong></div>\n      <div>ğŸ¯ Total Keypoints: <strong>${stats.totalKeypoints}</strong></div>\n      <div>ğŸ“ˆ Average per Image: <strong>${stats.averageKeypointsPerImage}</strong> keypoints</div>\n      <div style=\"margin-top: 10px; color: #059669;\">âœ… Pure annotation data, ready for data analysis</div>\n      <div style=\"color: #059669;\">âœ… Includes all annotated images and skipped plant information</div>\n    `;\n\n    statsContent.innerHTML = html;\n  } catch (error) {\n    console.error('Failed to get export statistics:', error);\n    statsContent.innerHTML = '<div style=\"color: #dc2626;\">Failed to load statistics, please check console</div>';\n  }\n}\n\n/**\n * æ‰§è¡Œå¯¼å‡º\n */\nasync function performExport() {\n  try {\n    // è·å–çº¯å‡€çš„æ ‡æ³¨æ•°æ®\n    const exportData = await getDirectExportData();\n    const stats = calculateExportStats(exportData);\n\n    if (stats.annotatedImages === 0) {\n      showError('Export Failed', 'No annotation data available for export');\n      return;\n    }\n\n    // åˆ›å»ºå¯¼å‡ºæ•°æ®ç»“æ„\n    const finalExportData = {\n      exportTime: new Date().toISOString(),\n      version: '3.0',\n      format: 'pure_annotations',\n      description: 'Pure annotation data, including image annotations and skipped plant information',\n      stats: {\n        annotatedImages: stats.annotatedImages,\n        totalKeypoints: stats.totalKeypoints,\n        averageKeypointsPerImage: stats.averageKeypointsPerImage,\n        skippedPlants: stats.skippedPlants\n      },\n      annotations: exportData.annotations,\n      skippedPlants: exportData.skippedPlants\n    };\n\n    // ä¸‹è½½æ–‡ä»¶\n    const blob = new Blob([JSON.stringify(finalExportData, null, 2)], {\n      type: 'application/json'\n    });\n\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `annotations_${new Date().toISOString().split('T')[0]}.json`;\n\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n\n    URL.revokeObjectURL(url);\n\n    const message = `Exported annotation data for ${stats.annotatedImages} images with ${stats.totalKeypoints} keypoints`;\n    updateProgressInfo(message);\n    console.log('Annotation data exported', finalExportData);\n\n  } catch (error) {\n    console.error('Failed to export data:', error);\n    showError('Export Failed', error.message);\n  }\n}\n\n/**\n * ç›´æ¥ä»æ–‡ä»¶ç³»ç»Ÿè·å–å¯¼å‡ºæ•°æ®\n */\nasync function getDirectExportData() {\n  const exportData = {\n    annotations: {},\n    skippedPlants: {}\n  };\n\n  if (!plantDataManager || !plantDataManager.annotationStorage) {\n    throw new Error('æ•°æ®ç®¡ç†å™¨æœªåˆå§‹åŒ–');\n  }\n\n  const annotationStorage = plantDataManager.annotationStorage;\n\n  // è·å–æ‰€æœ‰æ ‡æ³¨æ–‡ä»¶\n  if (annotationStorage.useFileSystem && annotationStorage.fileSystemManager) {\n    const annotationsHandle = annotationStorage.fileSystemManager.getAnnotationsDirectory();\n    if (!annotationsHandle) {\n      throw new Error('æ— æ³•è®¿é—®æ ‡æ³¨ç›®å½•');\n    }\n\n    // æ‰«ææ‰€æœ‰æ–‡ä»¶\n    for await (const [name, handle] of annotationsHandle.entries()) {\n      if (handle.kind === 'file' && name.endsWith('.json')) {\n        try {\n          const file = await handle.getFile();\n          const content = await file.text();\n          const data = JSON.parse(content);\n\n          if (name.endsWith('_skip_info.json')) {\n            // è·³è¿‡ä¿¡æ¯æ–‡ä»¶\n            const plantId = name.replace('_skip_info.json', '');\n            exportData.skippedPlants[plantId] = {\n              plantId: data.plantId,\n              skipReason: data.skipReason,\n              skipDate: data.skipDate,\n              status: data.status\n            };\n          } else {\n            // æ ‡æ³¨æ–‡ä»¶\n            const imageId = name.replace('.json', '');\n            if (data.annotations && data.annotations.length > 0) {\n              // å¦‚æœæ²¡æœ‰plantIdï¼Œå°è¯•ä»imageIdæ¨æ–­\n              const plantId = data.plantId || inferPlantIdFromImageId(imageId);\n\n              exportData.annotations[imageId] = {\n                imageId: data.imageId || imageId,\n                plantId: plantId,\n                annotations: data.annotations,\n                timestamp: data.timestamp,\n                version: data.version\n              };\n            }\n          }\n        } catch (error) {\n          console.warn(`è¯»å–æ–‡ä»¶å¤±è´¥ (${name}):`, error);\n        }\n      }\n    }\n  } else {\n    // ä»å†…å­˜ä¸­è·å–æ•°æ®ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰\n    for (const [plantId, annotationData] of annotationStorage.annotations) {\n      if (annotationData.status === 'skipped') {\n        exportData.skippedPlants[plantId] = {\n          plantId,\n          skipReason: annotationData.skipReason,\n          skipDate: annotationData.skipDate,\n          status: annotationData.status\n        };\n      }\n    }\n\n    // è·å–å›¾åƒæ ‡æ³¨æ•°æ®\n    for (const [imageId, annotationData] of annotationStorage.imageAnnotations) {\n      if (annotationData.annotations && annotationData.annotations.length > 0) {\n        exportData.annotations[imageId] = {\n          imageId,\n          plantId: annotationData.plantId,\n          annotations: annotationData.annotations,\n          timestamp: annotationData.timestamp,\n          version: annotationData.version\n        };\n      }\n    }\n  }\n\n  return exportData;\n}\n\n/**\n * è®¡ç®—å¯¼å‡ºæ•°æ®ç»Ÿè®¡\n */\nfunction calculateExportStats(exportData) {\n  const annotatedImages = Object.keys(exportData.annotations).length;\n  const skippedPlants = Object.keys(exportData.skippedPlants).length;\n\n  let totalKeypoints = 0;\n  for (const imageData of Object.values(exportData.annotations)) {\n    totalKeypoints += imageData.annotations.length;\n  }\n\n  const averageKeypointsPerImage = annotatedImages > 0 ?\n    (totalKeypoints / annotatedImages).toFixed(1) : '0';\n\n  return {\n    annotatedImages,\n    totalKeypoints,\n    averageKeypointsPerImage,\n    skippedPlants\n  };\n}\n\n/**\n * å¤„ç†æ¤ç‰©æ›´æ–°äº‹ä»¶\n */\nfunction handlePlantUpdated(event) {\n  const { plant } = event.detail;\n  \n  // æ›´æ–°åˆ—è¡¨ä¸­çš„æ¤ç‰©é¡¹\n  const plantItem = document.querySelector(`[data-plant-id=\"${plant.id}\"]`);\n  if (plantItem) {\n    // æ›´æ–°çŠ¶æ€å›¾æ ‡\n    const statusElement = plantItem.querySelector('.plant-status');\n    if (statusElement) {\n      statusElement.textContent = getStatusIcon(plant.status);\n    }\n    \n    // æ›´æ–°çŠ¶æ€æ–‡æœ¬\n    const statusTextElement = plantItem.querySelector('.status-text');\n    if (statusTextElement) {\n      statusTextElement.textContent = getStatusText(plant.status);\n    }\n    \n    // æ›´æ–°å›¾åƒæ•°é‡\n    const imageCountElement = plantItem.querySelector('.image-count');\n    if (imageCountElement && plant.imageCount > 0) {\n      imageCountElement.textContent = `${plant.imageCount} images`;\n    }\n    \n    // æ›´æ–°è§†è§’ä¿¡æ¯\n    const viewAnglesElement = plantItem.querySelector('.view-angles');\n    if (viewAnglesElement) {\n      const viewAnglesText = plant.viewAngles.length > 0 ? \n        `view: ${plant.viewAngles.join(', ')}` :\n        'view: detecting...';\n      viewAnglesElement.textContent = viewAnglesText;\n    }\n    \n    // æ›´æ–°é€‰ä¸­è§†è§’ä¿¡æ¯\n    const plantViewInfo = plantItem.querySelector('.plant-view-info');\n    if (plantViewInfo) {\n      let selectedViewElement = plantViewInfo.querySelector('.selected-view');\n      if (plant.selectedViewAngle) {\n        if (!selectedViewElement) {\n          selectedViewElement = document.createElement('div');\n          selectedViewElement.className = 'selected-view';\n          plantViewInfo.appendChild(selectedViewElement);\n        }\n        selectedViewElement.textContent = `Choosed: ${plant.selectedViewAngle}`;\n      } else if (selectedViewElement) {\n        selectedViewElement.remove();\n      }\n    }\n  }\n  \n  // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º\n  updateProgressStats();\n  \n  // æ›´æ–°æ—§çš„è¿›åº¦ä¿¡æ¯\n  const progress = plantDataManager.getProgress();\n  updateProgressInfo(`Progress: ${progress.completed}/${progress.total} (${progress.completionRate}%)`);\n}\n\n/**\n * é”®ç›˜å¿«æ·é”®å¤„ç†\n */\nfunction handleKeyboardShortcuts(event) {\n  // å…¨å±€å¿«æ·é”®\n  if (event.ctrlKey || event.metaKey) {\n    switch (event.key) {\n      case 'o':\n        event.preventDefault();\n        handleSelectDataset();\n        break;\n      case 's':\n        event.preventDefault();\n        handleSaveAnnotation();\n        break;\n    }\n  }\n  \n  // ğŸ”§ NEW: SIFTåŒ¹é…å¿«æ·é”® (Shift+S)\n  if (event.shiftKey && event.key.toLowerCase() === 's') {\n    event.preventDefault();\n    // æ£€æŸ¥å½“å‰é€‰ä¸­çš„AnnotationTypeæ˜¯å¦ä¸ºbuiltin\n    if (annotationTool) {\n      let isBuiltinSelected = false;\n      if (annotationTool.customAnnotationManager) {\n        const currentMode = annotationTool.customAnnotationManager.currentMode;\n        const selectedTypeId = annotationTool.customAnnotationManager.selectedCustomType;\n        isBuiltinSelected = (currentMode === 'custom' && selectedTypeId === 'builtin-regular-keypoint');\n      }\n      if (!isBuiltinSelected) {\n        showError('SIFTåŒ¹é…ä¸å¯ç”¨', 'SIFTåŒ¹é…ä»…æ”¯æŒRegular (Builtin)æ ‡æ³¨ï¼Œè¯·å…ˆé€‰æ‹©è¯¥ç±»å‹');\n        return;\n      }\n    }\n    handleSiftMatch();\n    return;\n  }\n  \n  // åº”ç”¨å¿«æ·é”®ï¼ˆä»…åœ¨ä¸»åº”ç”¨æ˜¾ç¤ºæ—¶ï¼‰\n  if (mainApp && mainApp.style.display !== 'none') {\n    switch (event.key) {\n      case 'Enter':\n        event.preventDefault();\n        // ğŸ”§ NEW: Auto Orderæ¨¡å¼ä¸‹çš„Enteré”®å¤„ç†\n        if (annotationTool && annotationTool.state.isAutoOrderMode) {\n          annotationTool.advanceToNextOrderNumber(); // è®©å®ƒå¼‚æ­¥æ‰§è¡Œ\n        } else {\n          handleCompletePlant();\n        }\n        break;\n      case 'ArrowLeft':\n        event.preventDefault();\n        // ğŸ”§ FIX: Add navigation state feedback\n        if (appState.navigation.isNavigating) {\n          console.log('[Navigation] Previous image blocked - navigation in progress');\n        } else {\n          navigateToPreviousImage();\n        }\n        break;\n      case 'ArrowRight':\n        event.preventDefault();\n        // ğŸ”§ FIX: Add navigation state feedback\n        if (appState.navigation.isNavigating) {\n          console.log('[Navigation] Next image blocked - navigation in progress');\n        } else {\n          navigateToNextImage();\n        }\n        break;\n    }\n  }\n}\n\n/**\n * æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹\n */\nasync function simulateLoading() {\n  const loadingTexts = [\n    'æ­£åœ¨åˆå§‹åŒ–æ ‡æ³¨å·¥å…·...',\n    'æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§...',\n    'åŠ è½½ç»„ä»¶æ¨¡å—...',\n    'å‡†å¤‡ç”¨æˆ·ç•Œé¢...'\n  ];\n  \n  const loadingP = loadingScreen.querySelector('p');\n  \n  for (const text of loadingTexts) {\n    loadingP.textContent = text;\n    await new Promise(resolve => setTimeout(resolve, 300));\n  }\n}\n\n/**\n * æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢\n */\nfunction showMainApp() {\n  loadingScreen.style.display = 'none';\n  mainApp.style.display = 'flex';\n  \n  // ç¡®ä¿ç•Œé¢å®Œå…¨æ¸²æŸ“åå†æ£€æŸ¥å’Œåˆå§‹åŒ–AnnotationTool\n  setTimeout(() => {\n    if (!annotationTool) {\n      try {\n        console.log('[è°ƒè¯•] åœ¨showMainAppä¸­å»¶è¿Ÿåˆå§‹åŒ–AnnotationTool');\n        annotationTool = new AnnotationTool('annotation-canvas');\n        window.PlantAnnotationTool.annotationTool = annotationTool;\n        console.log('AnnotationToolå»¶è¿Ÿåˆå§‹åŒ–å®Œæˆ');\n      } catch (error) {\n        console.error('å»¶è¿Ÿåˆå§‹åŒ–AnnotationToolå¤±è´¥:', error);\n      }\n    } else {\n      console.log('[è°ƒè¯•] AnnotationToolå·²å­˜åœ¨ï¼Œè·³è¿‡å»¶è¿Ÿåˆå§‹åŒ–ï¼Œè°ƒæ•´Canvaså°ºå¯¸');\n      // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œå¼ºåˆ¶é‡æ–°è°ƒæ•´Canvaså°ºå¯¸\n      annotationTool.resizeCanvas();\n    }\n    \n    // ç¡®ä¿åˆ†æ”¯ç‚¹é¢„è§ˆç®¡ç†å™¨å·²åˆå§‹åŒ–\n    if (!branchPointPreviewManager) {\n      try {\n        branchPointPreviewManager = new BranchPointPreviewManager();\n        branchPointPreviewManager.setPlantDataManager(plantDataManager);\n        window.PlantAnnotationTool.branchPointPreviewManager = branchPointPreviewManager;\n        console.log('BranchPointPreviewManagerå»¶è¿Ÿåˆå§‹åŒ–å®Œæˆ');\n      } catch (error) {\n        console.error('å»¶è¿Ÿåˆå§‹åŒ–BranchPointPreviewManagerå¤±è´¥:', error);\n      }\n    }\n  }, 300);\n}\n\n/**\n * æ›´æ–°è¿›åº¦ä¿¡æ¯\n */\nfunction updateProgressInfo(text) {\n  const progressText = document.getElementById('progress-text');\n  if (progressText) {\n    progressText.textContent = text;\n  }\n}\n\n/**\n * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯\n */\nfunction showError(title, message) {\n  const errorMessage = document.getElementById('error-message');\n  if (errorMessage && errorModal) {\n    errorMessage.textContent = message;\n    errorModal.style.display = 'flex';\n  }\n  console.error(`${title}: ${message}`);\n}\n\n/**\n * éšè—é”™è¯¯ä¿¡æ¯\n */\nfunction hideError() {\n  if (errorModal) {\n    errorModal.style.display = 'none';\n  }\n}\n\n/**\n * æ˜¾ç¤ºæˆåŠŸä¿¡æ¯\n */\nfunction showSuccess(title, message) {\n  // ä½¿ç”¨updateProgressInfoæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯\n  updateProgressInfo(`âœ… ${title}: ${message}`);\n  console.log(`${title}: ${message}`);\n}\n\n/**\n * åº”ç”¨å…¥å£ç‚¹\n */\ndocument.addEventListener('DOMContentLoaded', () => {\n  console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨...');\n  initializeApp();\n});\n\n// å¼€å‘ç¯å¢ƒè°ƒè¯•\nif (import.meta.env?.DEV) {\n  window.DEBUG_APP_STATE = appState;\n  window.DEBUG_PLANT_MANAGER = () => window.PlantAnnotationTool?.plantDataManager;\n  window.DEBUG_ANNOTATION_TOOL = () => window.PlantAnnotationTool?.annotationTool;\n  \n  // æ·»åŠ æ—¶é—´åºåˆ—å¯¼å‡ºè°ƒè¯•åŠŸèƒ½\n  window.DEBUG_TIME_SERIES_EXPORT = async () => {\n    const plantManager = window.PlantAnnotationTool?.plantDataManager;\n    if (plantManager) {\n      return await plantManager.debugTimeSeriesExport();\n    } else {\n      console.error('PlantDataManageræœªåˆå§‹åŒ–');\n      return null;\n    }\n  };\n  \n  // æ·»åŠ ç«‹å³å¯¼å‡ºçº¯å‡€æ•°æ®çš„è°ƒè¯•åŠŸèƒ½\n  window.DEBUG_EXPORT_PURE = async () => {\n    const plantManager = window.PlantAnnotationTool?.plantDataManager;\n    if (plantManager) {\n      const pureData = await plantManager.exportPureImageAnnotations();\n      console.log('è°ƒè¯•ï¼šçº¯å‡€å¯¼å‡ºæ•°æ®', pureData);\n      return pureData;\n    } else {\n      console.error('PlantDataManageræœªåˆå§‹åŒ–');\n      return null;\n    }\n  };\n  \n  // ä¸´æ—¶ä¿®å¤è„šæœ¬ï¼šä¸ºä¼ ç»Ÿæ ‡æ³¨æ•°æ®æ·»åŠ åºå·å­—æ®µ\n  window.fixLegacyDataOrder = async function() {\n    console.log('=== å¼€å§‹ä¿®å¤ä¼ ç»Ÿæ•°æ®çš„åºå·å­—æ®µ ===');\n    \n    try {\n      // è·å–æ¤ç‰©æ•°æ®ç®¡ç†å™¨å’Œå­˜å‚¨ç®¡ç†å™¨\n      const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n      if (!plantDataManager) {\n        throw new Error('æ¤ç‰©æ•°æ®ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆåŠ è½½æ•°æ®é›†');\n      }\n      \n      const annotationStorage = plantDataManager.annotationStorage;\n      if (!annotationStorage) {\n        throw new Error('æ ‡æ³¨å­˜å‚¨ç®¡ç†å™¨æœªæ‰¾åˆ°');\n      }\n      \n      console.log('æ­£åœ¨æ‰«æå›¾åƒæ ‡æ³¨æ•°æ®...');\n      \n      let processedImages = 0;\n      let fixedAnnotations = 0;\n      let totalAnnotations = 0;\n      \n      // å¤„ç†imageAnnotationsä¸­çš„æ•°æ®\n      for (const [imageId, annotationData] of annotationStorage.imageAnnotations) {\n        if (annotationData.annotations && annotationData.annotations.length > 0) {\n          processedImages++;\n          \n          let hasOrderIssues = false;\n          const annotations = annotationData.annotations;\n          totalAnnotations += annotations.length;\n          \n          // æ£€æŸ¥æ˜¯å¦æœ‰æ ‡æ³¨ç‚¹æ²¡æœ‰åºå·\n          for (let i = 0; i < annotations.length; i++) {\n            if (typeof annotations[i].order !== 'number' || annotations[i].order <= 0) {\n              hasOrderIssues = true;\n              break;\n            }\n          }\n          \n          // æ£€æŸ¥åºå·æ˜¯å¦é‡å¤æˆ–ä¸è¿ç»­\n          if (!hasOrderIssues) {\n            const orders = annotations.map(kp => kp.order).sort((a, b) => a - b);\n            for (let i = 0; i < orders.length; i++) {\n              if (orders[i] !== i + 1) {\n                hasOrderIssues = true;\n                break;\n              }\n            }\n          }\n          \n          // å¦‚æœæœ‰é—®é¢˜ï¼Œä¿®å¤åºå·\n          if (hasOrderIssues) {\n            console.log(`ä¿®å¤å›¾åƒ ${imageId} çš„ ${annotations.length} ä¸ªæ ‡æ³¨ç‚¹çš„åºå·...`);\n            \n            // æŒ‰ç…§åŸæœ‰é¡ºåºåˆ†é…åºå·ï¼ˆä¿æŒä¼ ç»Ÿæ•°æ®çš„é¡ºåºä¸å˜ï¼‰\n            for (let i = 0; i < annotations.length; i++) {\n              annotations[i].order = i + 1;\n            }\n            \n            fixedAnnotations += annotations.length;\n            \n            // é‡æ–°ä¿å­˜åˆ°å­˜å‚¨\n            await annotationStorage.saveImageAnnotation(imageId, annotationData);\n            \n            console.log(`âœ“ å·²ä¿®å¤å›¾åƒ ${imageId}ï¼šåˆ†é…åºå· 1-${annotations.length}`);\n          }\n        }\n      }\n      \n      // å¤„ç†æ¤ç‰©æ ‡æ³¨æ•°æ®ä¸­çš„annotationså­—æ®µ\n      console.log('æ­£åœ¨æ‰«ææ¤ç‰©æ ‡æ³¨æ•°æ®...');\n      \n      let processedPlants = 0;\n      let fixedPlantAnnotations = 0;\n      \n      for (const [plantId, plantData] of annotationStorage.annotations) {\n        if (plantData.annotations && plantData.annotations.length > 0) {\n          processedPlants++;\n          \n          let hasOrderIssues = false;\n          const annotations = plantData.annotations;\n          \n          // æ£€æŸ¥æ˜¯å¦æœ‰æ ‡æ³¨ç‚¹æ²¡æœ‰åºå·\n          for (let i = 0; i < annotations.length; i++) {\n            if (typeof annotations[i].order !== 'number' || annotations[i].order <= 0) {\n              hasOrderIssues = true;\n              break;\n            }\n          }\n          \n          // æ£€æŸ¥åºå·æ˜¯å¦é‡å¤æˆ–ä¸è¿ç»­\n          if (!hasOrderIssues) {\n            const orders = annotations.map(kp => kp.order).sort((a, b) => a - b);\n            for (let i = 0; i < orders.length; i++) {\n              if (orders[i] !== i + 1) {\n                hasOrderIssues = true;\n                break;\n              }\n            }\n          }\n          \n          // å¦‚æœæœ‰é—®é¢˜ï¼Œä¿®å¤åºå·\n          if (hasOrderIssues) {\n            console.log(`ä¿®å¤æ¤ç‰© ${plantId} çš„ ${annotations.length} ä¸ªæ ‡æ³¨ç‚¹çš„åºå·...`);\n            \n            // æŒ‰ç…§åŸæœ‰é¡ºåºåˆ†é…åºå·\n            for (let i = 0; i < annotations.length; i++) {\n              annotations[i].order = i + 1;\n            }\n            \n            fixedPlantAnnotations += annotations.length;\n            \n            console.log(`âœ“ å·²ä¿®å¤æ¤ç‰© ${plantId}ï¼šåˆ†é…åºå· 1-${annotations.length}`);\n          }\n        }\n      }\n      \n      // ä¿å­˜æ‰€æœ‰ä¿®æ”¹åˆ°æœåŠ¡å™¨\n      if (fixedAnnotations > 0 || fixedPlantAnnotations > 0) {\n        console.log('æ­£åœ¨ä¿å­˜ä¿®å¤çš„æ•°æ®åˆ°æœåŠ¡å™¨...');\n        await annotationStorage.saveAnnotationsToServer();\n        console.log('âœ“ æ‰€æœ‰ä¿®å¤çš„æ•°æ®å·²ä¿å­˜');\n      }\n      \n      // è¾“å‡ºä¿®å¤ç»“æœ\n      console.log('=== ä¿®å¤å®Œæˆ ===');\n      console.log(`æ‰«æäº† ${processedImages} å¼ å›¾åƒçš„æ ‡æ³¨æ•°æ®`);\n      console.log(`æ‰«æäº† ${processedPlants} ä¸ªæ¤ç‰©çš„æ ‡æ³¨æ•°æ®`);\n      console.log(`æ€»è®¡ ${totalAnnotations} ä¸ªæ ‡æ³¨ç‚¹`);\n      console.log(`ä¿®å¤äº† ${fixedAnnotations} ä¸ªå›¾åƒæ ‡æ³¨ç‚¹çš„åºå·`);\n      console.log(`ä¿®å¤äº† ${fixedPlantAnnotations} ä¸ªæ¤ç‰©æ ‡æ³¨ç‚¹çš„åºå·`);\n      \n      if (fixedAnnotations === 0 && fixedPlantAnnotations === 0) {\n        console.log('âœ… æ‰€æœ‰æ•°æ®çš„åºå·éƒ½æ˜¯æ­£ç¡®çš„ï¼Œæ— éœ€ä¿®å¤');\n      } else {\n        console.log(`âœ… å·²æˆåŠŸä¿®å¤ ${fixedAnnotations + fixedPlantAnnotations} ä¸ªæ ‡æ³¨ç‚¹çš„åºå·`);\n      }\n      \n      // å»ºè®®ç”¨æˆ·é‡æ–°åŠ è½½é¡µé¢ä»¥ç¡®ä¿æ•°æ®ç”Ÿæ•ˆ\n      if (fixedAnnotations > 0 || fixedPlantAnnotations > 0) {\n        console.log('ğŸ’¡ å»ºè®®é‡æ–°åŠ è½½é¡µé¢ä»¥ç¡®ä¿ä¿®å¤çš„æ•°æ®å®Œå…¨ç”Ÿæ•ˆ');\n      }\n      \n      return {\n        success: true,\n        processedImages,\n        processedPlants,\n        totalAnnotations,\n        fixedAnnotations,\n        fixedPlantAnnotations,\n        totalFixed: fixedAnnotations + fixedPlantAnnotations\n      };\n      \n    } catch (error) {\n      console.error('ä¿®å¤ä¼ ç»Ÿæ•°æ®å¤±è´¥:', error);\n      console.log('âŒ ä¿®å¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è¾“å‡º');\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  };\n  \n  // è°ƒè¯•æ ‡æ³¨æ–‡ä»¶è¯»å–\n  window.DEBUG_ANNOTATION_FILE = async (imageId) => {\n    if (plantDataManager && plantDataManager.fileSystemManager) {\n      try {\n        console.log(`[è°ƒè¯•] å°è¯•è¯»å–æ ‡æ³¨æ–‡ä»¶: ${imageId}`);\n        const data = await plantDataManager.fileSystemManager.loadAnnotationFile(imageId);\n        console.log(`[è°ƒè¯•] æ ‡æ³¨æ–‡ä»¶å†…å®¹:`, data);\n        return data;\n      } catch (error) {\n        console.error(`[è°ƒè¯•] è¯»å–å¤±è´¥:`, error);\n        return null;\n      }\n    }\n    return null;\n  };\n\n  // è°ƒè¯•ï¼šæŸ¥æ‰¾æœ‰æ ‡æ³¨æ•°æ®çš„æ–‡ä»¶\n  window.DEBUG_FIND_ANNOTATED_FILES = async (maxCheck = 10) => {\n    if (plantDataManager && plantDataManager.fileSystemManager) {\n      try {\n        const allFiles = await plantDataManager.fileSystemManager.getAllAnnotationFiles();\n        console.log(`[è°ƒè¯•] æ€»å…± ${allFiles.length} ä¸ªæ ‡æ³¨æ–‡ä»¶ï¼Œæ£€æŸ¥å‰ ${maxCheck} ä¸ª...`);\n\n        const annotatedFiles = [];\n        for (let i = 0; i < Math.min(maxCheck, allFiles.length); i++) {\n          const imageId = allFiles[i];\n          const data = await plantDataManager.fileSystemManager.loadAnnotationFile(imageId);\n          if (data && data.annotations && data.annotations.length > 0) {\n            annotatedFiles.push({\n              imageId,\n              annotationCount: data.annotations.length,\n              data\n            });\n            console.log(`[è°ƒè¯•] æ‰¾åˆ°æœ‰æ ‡æ³¨çš„æ–‡ä»¶: ${imageId} (${data.annotations.length} ä¸ªæ ‡æ³¨ç‚¹)`);\n          }\n        }\n\n        console.log(`[è°ƒè¯•] æ£€æŸ¥å®Œæˆï¼Œæ‰¾åˆ° ${annotatedFiles.length} ä¸ªæœ‰æ ‡æ³¨æ•°æ®çš„æ–‡ä»¶`);\n        return annotatedFiles;\n      } catch (error) {\n        console.error(`[è°ƒè¯•] æŸ¥æ‰¾å¤±è´¥:`, error);\n        return [];\n      }\n    }\n    return [];\n  };\n\n  console.log('å¼€å‘æ¨¡å¼ï¼šè°ƒè¯•å¯¹è±¡å·²ç»‘å®šåˆ°window');\n  console.log('å¯ç”¨è°ƒè¯•æ–¹æ³•:');\n  console.log('- DEBUG_TIME_SERIES_EXPORT() - æ£€æŸ¥æ—¶é—´åºåˆ—å¯¼å‡ºçŠ¶æ€');\n  console.log('- DEBUG_EXPORT_PURE() - æ£€æŸ¥çº¯å‡€å¯¼å‡ºæ•°æ®');\n  console.log('- DEBUG_ANNOTATION_FILE(imageId) - è°ƒè¯•æ ‡æ³¨æ–‡ä»¶è¯»å–');\n  console.log('- DEBUG_FIND_ANNOTATED_FILES(maxCheck) - æŸ¥æ‰¾æœ‰æ ‡æ³¨æ•°æ®çš„æ–‡ä»¶');\n  console.log('- fixLegacyDataOrder() - ä¿®å¤ä¼ ç»Ÿæ•°æ®çš„åºå·å­—æ®µ');\n  console.log('- MIGRATE_PLANT_STATUS() - ğŸ”§ NEW: è¿ç§»æ¤ç‰©å®ŒæˆçŠ¶æ€æ•°æ®');\n  \n  // ğŸ”§ NEW: Migration script for plant completion status\n  window.MIGRATE_PLANT_STATUS = async function() {\n    console.log('=== å¼€å§‹è¿ç§»æ¤ç‰©å®ŒæˆçŠ¶æ€æ•°æ® ===');\n    \n    try {\n      const plantDataManager = window.PlantAnnotationTool?.plantDataManager;\n      if (!plantDataManager) {\n        throw new Error('PlantDataManageræœªåˆå§‹åŒ–ï¼Œè¯·å…ˆåŠ è½½æ•°æ®é›†');\n      }\n      \n      console.log('æ­£åœ¨æ‰«ææ‰€æœ‰æ¤ç‰©çŠ¶æ€...');\n      \n      const plants = plantDataManager.getPlantList();\n      let migratedCount = 0;\n      let alreadyCorrectCount = 0;\n      \n      for (const plant of plants) {\n        const plantId = plant.id;\n        console.log(`æ£€æŸ¥æ¤ç‰© ${plantId}ï¼Œå½“å‰çŠ¶æ€: ${plant.status}`);\n        \n        // Skip already skipped plants\n        if (plant.status === 'skipped') {\n          console.log(`${plantId}: ä¿æŒè·³è¿‡çŠ¶æ€`);\n          alreadyCorrectCount++;\n          continue;\n        }\n        \n        // Check if plant has annotations\n        let hasAnnotations = false;\n        try {\n          const annotations = plantDataManager.getPlantAnnotations(plantId);\n          hasAnnotations = annotations && annotations.length > 0;\n        } catch (error) {\n          console.warn(`æ— æ³•æ£€æŸ¥ ${plantId} çš„æ ‡æ³¨:`, error);\n        }\n        \n        let newStatus;\n        if (hasAnnotations && plant.status === 'completed') {\n          // ğŸ”§ MIGRATION LOGIC: Plants with annotations that were auto-marked as completed\n          // should be set to 'completed' to maintain existing user expectations\n          newStatus = 'completed';\n          console.log(`${plantId}: æœ‰æ ‡æ³¨ä¸”å·²æ ‡è®°å®Œæˆ â†’ ä¿æŒ completed çŠ¶æ€ (è¿ç§»å…¼å®¹)`);\n          alreadyCorrectCount++;\n        } else if (hasAnnotations && plant.status !== 'completed') {\n          // Plants with annotations but not explicitly completed should be in-progress\n          newStatus = 'in-progress';\n          plantDataManager.updatePlantStatus(plantId, newStatus);\n          console.log(`${plantId}: æœ‰æ ‡æ³¨ä½†æœªæ˜ç¡®å®Œæˆ â†’ è®¾ç½®ä¸º in-progress`);\n          migratedCount++;\n        } else if (!hasAnnotations) {\n          // Plants without annotations should be pending\n          newStatus = 'pending';\n          if (plant.status !== 'pending') {\n            plantDataManager.updatePlantStatus(plantId, newStatus);\n            console.log(`${plantId}: æ— æ ‡æ³¨ â†’ è®¾ç½®ä¸º pending`);\n            migratedCount++;\n          } else {\n            alreadyCorrectCount++;\n          }\n        } else {\n          alreadyCorrectCount++;\n        }\n      }\n      \n      console.log('=== è¿ç§»å®Œæˆ ===');\n      console.log(`æ€»è®¡æ‰«æ ${plants.length} ä¸ªæ¤ç‰©`);\n      console.log(`è¿ç§»äº† ${migratedCount} ä¸ªæ¤ç‰©çš„çŠ¶æ€`);\n      console.log(`${alreadyCorrectCount} ä¸ªæ¤ç‰©çŠ¶æ€å·²æ­£ç¡®`);\n      \n      // Refresh UI to show updated status\n      if (renderPlantList && typeof renderPlantList === 'function') {\n        renderPlantList(plants);\n        console.log('UIå·²åˆ·æ–°ä»¥æ˜¾ç¤ºæ–°çŠ¶æ€');\n      }\n      \n      if (updateProgressStats && typeof updateProgressStats === 'function') {\n        updateProgressStats();\n        console.log('è¿›åº¦ç»Ÿè®¡å·²æ›´æ–°');\n      }\n      \n      console.log('ğŸ’¡ ç°åœ¨ï¼Œåªæœ‰ç‚¹å‡» \"Complete Plant\" æŒ‰é’®çš„æ¤ç‰©æ‰ä¼šæ ‡è®°ä¸º completed');\n      console.log('ğŸ’¡ æœ‰æ ‡æ³¨ä½†æœªç‚¹å‡»å®ŒæˆæŒ‰é’®çš„æ¤ç‰©æ˜¾ç¤ºä¸º in-progress');\n      \n      return {\n        success: true,\n        totalPlants: plants.length,\n        migratedCount,\n        alreadyCorrectCount\n      };\n      \n    } catch (error) {\n      console.error('è¿ç§»æ¤ç‰©çŠ¶æ€å¤±è´¥:', error);\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  };\n}\n\n/**\n * ç”Ÿæˆå¯¼å‡ºæ•°æ®é¢„è§ˆ\n */\nasync function generateExportPreview() {\n  const previewContainer = document.getElementById('export-preview');\n  if (!previewContainer) return;\n\n  try {\n    previewContainer.innerHTML = 'æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...';\n\n    // è·å–å¯¼å‡ºæ•°æ®\n    const exportData = await getDirectExportData();\n\n    if (Object.keys(exportData.annotations).length === 0 && Object.keys(exportData.skippedPlants).length === 0) {\n      previewContainer.innerHTML = '<div style=\"color: #6b7280; text-align: center; padding: 20px;\">No annotation data available</div>';\n      return;\n    }\n\n    // ç”Ÿæˆé¢„è§ˆHTML\n    const previewHTML = generateSimplePreviewHTML(exportData);\n    previewContainer.innerHTML = previewHTML;\n\n    // ç»‘å®šå±•å¼€/æŠ˜å äº‹ä»¶\n    bindPreviewEvents();\n\n  } catch (error) {\n    console.error('Failed to generate export preview:', error);\n    previewContainer.innerHTML = '<div style=\"color: #dc2626;\">Failed to generate preview, please check console</div>';\n  }\n}\n\n/**\n * ä»å›¾åƒIDæ¨æ–­æ¤æ ªID\n */\nfunction inferPlantIdFromImageId(imageId) {\n  // å›¾åƒIDæ ¼å¼é€šå¸¸æ˜¯: BR017-028122_sv-000_BR017-028122-2018-07-04_00_VIS_sv_000-0-0-0.png\n  // æ¤æ ªIDé€šå¸¸æ˜¯: BR017-028122\n\n  if (imageId.includes('_')) {\n    const parts = imageId.split('_');\n    if (parts.length > 0) {\n      // å–ç¬¬ä¸€éƒ¨åˆ†ä½œä¸ºæ¤æ ªID\n      return parts[0];\n    }\n  }\n\n  // å¦‚æœæ— æ³•è§£æï¼Œå°è¯•ä»æ–‡ä»¶åä¸­æå–\n  if (imageId.includes('-')) {\n    const parts = imageId.split('-');\n    if (parts.length >= 2) {\n      // ç»„åˆå‰ä¸¤éƒ¨åˆ†ä½œä¸ºæ¤æ ªID (å¦‚ BR017-028122)\n      return `${parts[0]}-${parts[1]}`;\n    }\n  }\n\n  // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šè¿”å›åŸå§‹imageIdçš„å‰ç¼€\n  return imageId.split('.')[0].split('_')[0];\n}\n\n/**\n * ç”Ÿæˆç®€åŒ–çš„é¢„è§ˆHTML\n */\nfunction generateSimplePreviewHTML(exportData) {\n  let html = '';\n\n  // Display annotation data\n  const annotationCount = Object.keys(exportData.annotations).length;\n  if (annotationCount > 0) {\n    html += `\n      <div style=\"margin-bottom: 20px;\">\n        <div style=\"font-weight: 600; margin-bottom: 10px; color: #374151;\">\n          ğŸ“Š Annotation Data (${annotationCount} images)\n        </div>\n        <div style=\"max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px;\">\n    `;\n\n    // æ˜¾ç¤ºå‰10ä¸ªæ ‡æ³¨æ•°æ®ä½œä¸ºé¢„è§ˆ\n    const imageIds = Object.keys(exportData.annotations).slice(0, 10);\n    for (const imageId of imageIds) {\n      const data = exportData.annotations[imageId];\n      // å¦‚æœæ²¡æœ‰plantIdï¼Œå°è¯•ä»imageIdæ¨æ–­\n      const plantId = data.plantId || inferPlantIdFromImageId(imageId);\n\n      html += `\n        <div style=\"margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 13px;\">\n          <div style=\"font-weight: 500;\">${imageId}</div>\n          <div style=\"color: #6b7280;\">\n            Plant: ${plantId} |\n            Keypoints: ${data.annotations.length} |\n            Time: ${data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A'}\n          </div>\n        </div>\n      `;\n    }\n\n    if (annotationCount > 10) {\n      html += `<div style=\"text-align: center; color: #6b7280; margin-top: 10px;\">... ${annotationCount - 10} more images</div>`;\n    }\n\n    html += '</div></div>';\n  }\n\n  // Display skipped plants\n  const skippedCount = Object.keys(exportData.skippedPlants).length;\n  if (skippedCount > 0) {\n    html += `\n      <div style=\"margin-bottom: 20px;\">\n        <div style=\"font-weight: 600; margin-bottom: 10px; color: #374151;\">\n          â­ï¸ Skipped Plants (${skippedCount})\n        </div>\n        <div style=\"max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px;\">\n    `;\n\n    for (const [plantId, data] of Object.entries(exportData.skippedPlants)) {\n      html += `\n        <div style=\"margin-bottom: 8px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 13px;\">\n          <div style=\"font-weight: 500;\">${plantId}</div>\n          <div style=\"color: #92400e;\">\n            Reason: ${data.skipReason} |\n            Time: ${data.skipDate ? new Date(data.skipDate).toLocaleString() : 'N/A'}\n          </div>\n        </div>\n      `;\n    }\n\n    html += '</div></div>';\n  }\n\n  if (html === '') {\n    html = '<div style=\"color: #6b7280; text-align: center; padding: 20px;\">No data available</div>';\n  }\n\n  return html;\n}\n\n/**\n * æŒ‰æ¤æ ªå’Œè§†è§’åˆ†ç»„å›¾åƒæ•°æ®\n */\nfunction groupImagesByPlantAndView(imageData) {\n  const groupedData = {};\n  \n  for (const [imageId, annotations] of Object.entries(imageData)) {\n    // è§£æå›¾åƒIDè·å–æ¤æ ªå’Œè§†è§’ä¿¡æ¯\n    const parts = imageId.split('_');\n    if (parts.length >= 2) {\n      const plantId = parts[0]; // BR017-028111\n      const viewAngle = parts[1]; // sv-000\n      \n      if (!groupedData[plantId]) {\n        groupedData[plantId] = {};\n      }\n      \n      if (!groupedData[plantId][viewAngle]) {\n        groupedData[plantId][viewAngle] = [];\n      }\n      \n      groupedData[plantId][viewAngle].push({\n        imageId,\n        annotations,\n        imageName: imageId,\n        keypointCount: annotations.length\n      });\n    }\n  }\n  \n  // æŒ‰æ—¶é—´æ’åºæ¯ä¸ªè§†è§’çš„å›¾åƒ\n  for (const plantId of Object.keys(groupedData)) {\n    for (const viewAngle of Object.keys(groupedData[plantId])) {\n      groupedData[plantId][viewAngle].sort((a, b) => {\n        return a.imageId.localeCompare(b.imageId);\n      });\n    }\n  }\n  \n  return groupedData;\n}\n\n/**\n * ç”Ÿæˆé¢„è§ˆHTML\n */\nasync function generatePreviewHTML(groupedData) {\n  const plantIds = Object.keys(groupedData).sort();\n  \n  if (plantIds.length === 0) {\n    return '<div style=\"color: #6b7280; text-align: center; padding: 20px;\">æš‚æ— æ•°æ®</div>';\n  }\n  \n  let html = `\n    <div style=\"margin-bottom: 15px; font-weight: 600; color: #374151;\">\n      å…± ${plantIds.length} ä¸ªæ¤æ ªå‚ä¸å¯¼å‡º\n    </div>\n  `;\n  \n  for (const plantId of plantIds) {\n    const plantData = groupedData[plantId];\n    const viewAngles = Object.keys(plantData);\n    const totalImages = Object.values(plantData).reduce((sum, images) => sum + images.length, 0);\n    const totalKeypoints = Object.values(plantData).reduce((sum, images) => \n      sum + images.reduce((imgSum, img) => imgSum + img.keypointCount, 0), 0\n    );\n    \n    html += `\n      <div class=\"preview-plant\" style=\"border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 15px; overflow: hidden;\">\n        <div class=\"preview-plant-header\" style=\"background: #f3f4f6; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;\"\n             onclick=\"togglePlantPreview('${plantId}')\">\n          <div>\n            <span style=\"font-weight: 600; color: #1f2937;\">ğŸŒ± ${plantId}</span>\n            <span style=\"color: #6b7280; margin-left: 10px;\">\n              ${viewAngles.length} views â€¢ ${totalImages} images â€¢ ${totalKeypoints} ä¸ªæ ‡æ³¨ç‚¹\n            </span>\n          </div>\n          <span class=\"preview-toggle\" style=\"color: #6b7280;\">â–¼</span>\n        </div>\n        <div class=\"preview-plant-content\" id=\"preview-${plantId}\" style=\"display: none;\">\n          ${generateViewAnglesHTML(plantId, plantData)}\n        </div>\n      </div>\n    `;\n  }\n  \n  return html;\n}\n\n/**\n * ç”Ÿæˆè§†è§’HTML\n */\nfunction generateViewAnglesHTML(plantId, plantData) {\n  let html = '';\n  \n  for (const [viewAngle, images] of Object.entries(plantData)) {\n    const totalKeypoints = images.reduce((sum, img) => sum + img.keypointCount, 0);\n    \n    html += `\n      <div class=\"preview-view-angle\" style=\"border-top: 1px solid #e5e7eb;\">\n        <div class=\"preview-view-header\" style=\"background: #fafafa; padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;\"\n             onclick=\"toggleViewPreview('${plantId}', '${viewAngle}')\">\n          <div>\n            <span style=\"font-weight: 500; color: #374151;\">ğŸ“· ${viewAngle}</span>\n            <span style=\"color: #6b7280; margin-left: 10px;\">\n              ${images.length} images â€¢ ${totalKeypoints} annotations\n            </span>\n          </div>\n          <span class=\"preview-toggle\" style=\"color: #6b7280;\">â–¶</span>\n        </div>\n        <div class=\"preview-view-content\" id=\"preview-${plantId}-${viewAngle}\" style=\"display: none; padding: 10px 15px;\">\n          ${generateImagesHTML(images)}\n        </div>\n      </div>\n    `;\n  }\n  \n  return html;\n}\n\n/**\n * ç”Ÿæˆå›¾åƒHTML\n */\nfunction generateImagesHTML(images) {\n  let html = '<div style=\"display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;\">';\n  \n  for (const image of images) {\n    // æ­£ç¡®æå–æ–‡ä»¶å - ä»å®Œæ•´çš„imageIdä¸­æå–æœ€åçš„æ–‡ä»¶åéƒ¨åˆ†\n    const fileName = extractDisplayFileName(image.imageName);\n    \n    html += `\n      <div class=\"preview-image\" style=\"border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);\">\n        <div style=\"margin-bottom: 10px;\">\n          <div style=\"font-weight: 500; color: #374151; font-size: 14px; word-break: break-all;\" title=\"${image.imageName}\">\n            ğŸ“„ ${fileName}\n          </div>\n          <div style=\"color: #6b7280; font-size: 12px; margin-top: 4px;\">\n            ${image.keypointCount} ä¸ªæ ‡æ³¨ç‚¹\n          </div>\n        </div>\n        \n        <div class=\"preview-annotations\" style=\"background: #f8fafc; border-radius: 6px; padding: 10px;\">\n          <div style=\"font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 8px;\">æ ‡æ³¨ç‚¹é¢„è§ˆ:</div>\n          <div class=\"annotation-preview-container\" style=\"position: relative; width: 100%; height: 200px; border: 1px solid #d1d5db; border-radius: 4px; overflow: hidden; background: #f9fafb;\">\n            <canvas \n              class=\"annotation-preview-canvas\" \n              data-image-id=\"${image.imageId}\"\n              data-annotations='${JSON.stringify(image.annotations)}'\n              style=\"width: 100%; height: 100%; cursor: pointer;\"\n              title=\"ç‚¹å‡»æŸ¥çœ‹å¤§å›¾\"\n              onclick=\"showImageDetail('${image.imageId}')\"\n            ></canvas>\n            <div class=\"preview-loading\" style=\"position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #6b7280; font-size: 12px;\">\n              åŠ è½½ä¸­...\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n  \n  html += '</div>';\n  return html;\n}\n\n/**\n * æ­£ç¡®æå–æ˜¾ç¤ºç”¨çš„æ–‡ä»¶å\n */\nfunction extractDisplayFileName(imageName) {\n  // ä»imageIdä¸­æå–æœ‰æ„ä¹‰çš„éƒ¨åˆ†\n  // ä¾‹å¦‚: BR017-028111_sv-000_BR017-028111-2018-07-09_00_VIS_sv_000-0-0-0.png\n  // æå–: BR017-028111-2018-07-09_00_VIS_sv_000-0-0-0.png\n  \n  const parts = imageName.split('_');\n  if (parts.length >= 3) {\n    // ä»ç¬¬ä¸‰éƒ¨åˆ†å¼€å§‹æ˜¯æœ‰æ„ä¹‰çš„æ–‡ä»¶åä¿¡æ¯\n    return parts.slice(2).join('_');\n  }\n  \n  // å¦‚æœæ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œè¿”å›åŸå§‹åç§°\n  return imageName;\n}\n\n/**\n * ç»‘å®šé¢„è§ˆäº‹ä»¶\n */\nfunction bindPreviewEvents() {\n  // æ¤æ ªå±•å¼€/æŠ˜å äº‹ä»¶é€šè¿‡onclickå±æ€§ç»‘å®š\n  window.togglePlantPreview = function(plantId) {\n    const content = document.getElementById(`preview-${plantId}`);\n    const toggle = content.parentElement.querySelector('.preview-plant-header .preview-toggle');\n    \n    if (content.style.display === 'none') {\n      content.style.display = 'block';\n      toggle.textContent = 'â–²';\n      // å±•å¼€æ—¶æ¸²æŸ“canvas\n      setTimeout(() => renderPreviewCanvases(content), 100);\n    } else {\n      content.style.display = 'none';\n      toggle.textContent = 'â–¼';\n    }\n  };\n  \n  // è§†è§’å±•å¼€/æŠ˜å äº‹ä»¶\n  window.toggleViewPreview = function(plantId, viewAngle) {\n    const content = document.getElementById(`preview-${plantId}-${viewAngle}`);\n    const toggle = content.parentElement.querySelector('.preview-view-header .preview-toggle');\n    \n    if (content.style.display === 'none') {\n      content.style.display = 'block';\n      toggle.textContent = 'â–¼';\n      // å±•å¼€æ—¶æ¸²æŸ“canvas\n      setTimeout(() => renderPreviewCanvases(content), 100);\n    } else {\n      content.style.display = 'none';\n      toggle.textContent = 'â–¶';\n    }\n  };\n  \n  // æ˜¾ç¤ºå›¾åƒè¯¦æƒ…\n  window.showImageDetail = function(imageId) {\n    showImageDetailModal(imageId);\n  };\n  \n  // æ¸²æŸ“æ‰€æœ‰å¯è§çš„canvas\n  setTimeout(() => {\n    const allCanvases = document.querySelectorAll('.annotation-preview-canvas');\n    allCanvases.forEach(canvas => {\n      if (isElementVisible(canvas)) {\n        renderAnnotationPreview(canvas);\n      }\n    });\n  }, 500);\n}\n\n/**\n * æ¸²æŸ“é¢„è§ˆåŒºåŸŸå†…çš„æ‰€æœ‰canvas\n */\nfunction renderPreviewCanvases(container) {\n  const canvases = container.querySelectorAll('.annotation-preview-canvas');\n  canvases.forEach(canvas => {\n    if (isElementVisible(canvas)) {\n      renderAnnotationPreview(canvas);\n    }\n  });\n}\n\n/**\n * æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§\n */\nfunction isElementVisible(element) {\n  const rect = element.getBoundingClientRect();\n  return rect.width > 0 && rect.height > 0;\n}\n\n/**\n * æ¸²æŸ“å•ä¸ªæ ‡æ³¨é¢„è§ˆcanvas\n */\nasync function renderAnnotationPreview(canvas) {\n  try {\n    const imageId = canvas.dataset.imageId;\n    const annotations = JSON.parse(canvas.dataset.annotations);\n    const loadingElement = canvas.parentElement.querySelector('.preview-loading');\n    \n    // æ£€æŸ¥æ˜¯å¦å·²ç»æ¸²æŸ“è¿‡\n    if (canvas.dataset.rendered === 'true') {\n      return;\n    }\n    \n    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€\n    if (loadingElement) {\n      loadingElement.style.display = 'block';\n      loadingElement.textContent = 'åŠ è½½å›¾åƒ...';\n    }\n    \n    // è·å–å›¾åƒæ•°æ®\n    const imageData = await getImageDataFromId(imageId);\n    if (!imageData) {\n      throw new Error('æ— æ³•è·å–å›¾åƒæ•°æ®');\n    }\n    \n    // åŠ è½½å›¾åƒ\n    const image = new Image();\n    image.crossOrigin = 'anonymous';\n    \n    await new Promise((resolve, reject) => {\n      image.onload = () => resolve();\n      image.onerror = () => reject(new Error('å›¾åƒåŠ è½½å¤±è´¥'));\n      image.src = imageData.url;\n    });\n    \n    // è®¾ç½®canvaså°ºå¯¸\n    const container = canvas.parentElement;\n    const containerRect = container.getBoundingClientRect();\n    const targetWidth = containerRect.width - 2; // å‡å»è¾¹æ¡†\n    const targetHeight = containerRect.height - 2;\n    \n    canvas.width = targetWidth * window.devicePixelRatio;\n    canvas.height = targetHeight * window.devicePixelRatio;\n    canvas.style.width = targetWidth + 'px';\n    canvas.style.height = targetHeight + 'px';\n    \n    const ctx = canvas.getContext('2d');\n    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\n    \n    // è®¡ç®—å›¾åƒé€‚åº”å®¹å™¨çš„å°ºå¯¸\n    const imgAspect = image.width / image.height;\n    const containerAspect = targetWidth / targetHeight;\n    \n    let drawWidth, drawHeight, offsetX, offsetY;\n    \n    if (imgAspect > containerAspect) {\n      // å›¾åƒè¾ƒå®½ï¼Œä»¥å®½åº¦ä¸ºå‡†\n      drawWidth = targetWidth;\n      drawHeight = targetWidth / imgAspect;\n      offsetX = 0;\n      offsetY = (targetHeight - drawHeight) / 2;\n    } else {\n      // å›¾åƒè¾ƒé«˜ï¼Œä»¥é«˜åº¦ä¸ºå‡†\n      drawHeight = targetHeight;\n      drawWidth = targetHeight * imgAspect;\n      offsetX = (targetWidth - drawWidth) / 2;\n      offsetY = 0;\n    }\n    \n    // ç»˜åˆ¶å›¾åƒ\n    ctx.clearRect(0, 0, targetWidth, targetHeight);\n    ctx.drawImage(image, offsetX, offsetY, drawWidth, drawHeight);\n    \n    // ç»˜åˆ¶æ ‡æ³¨ç‚¹\n    if (annotations && annotations.length > 0) {\n      // è®¡ç®—æ ‡æ³¨ç‚¹åœ¨canvasä¸­çš„ä½ç½®\n      const scaleX = drawWidth / image.width;\n      const scaleY = drawHeight / image.height;\n      \n      annotations.forEach((annotation, index) => {\n        const x = annotation.x * scaleX + offsetX;\n        const y = annotation.y * scaleY + offsetY;\n        \n        // ç»˜åˆ¶æ ‡æ³¨ç‚¹\n        ctx.fillStyle = '#ef4444';\n        ctx.strokeStyle = '#ffffff';\n        ctx.lineWidth = 2;\n        \n        ctx.beginPath();\n        ctx.arc(x, y, 6, 0, 2 * Math.PI);\n        ctx.fill();\n        ctx.stroke();\n        \n        // ç»˜åˆ¶æ ‡æ³¨ç‚¹ç¼–å·\n        ctx.fillStyle = '#ffffff';\n        ctx.font = 'bold 10px Arial';\n        ctx.textAlign = 'center';\n        ctx.textBaseline = 'middle';\n        ctx.fillText((index + 1).toString(), x, y);\n      });\n    }\n    \n    // éšè—åŠ è½½çŠ¶æ€\n    if (loadingElement) {\n      loadingElement.style.display = 'none';\n    }\n    \n    // æ ‡è®°ä¸ºå·²æ¸²æŸ“\n    canvas.dataset.rendered = 'true';\n    \n  } catch (error) {\n    console.error('æ¸²æŸ“æ ‡æ³¨é¢„è§ˆå¤±è´¥:', error);\n    const loadingElement = canvas.parentElement.querySelector('.preview-loading');\n    if (loadingElement) {\n      loadingElement.textContent = 'åŠ è½½å¤±è´¥';\n      loadingElement.style.color = '#dc2626';\n    }\n  }\n}\n\n/**\n * ä»å›¾åƒIDè·å–å›¾åƒæ•°æ®\n */\nasync function getImageDataFromId(imageId) {\n  try {\n    // ä»imageIdä¸­è§£ææ¤æ ªID\n    const parts = imageId.split('_');\n    if (parts.length < 2) {\n      throw new Error('æ— æ•ˆçš„å›¾åƒIDæ ¼å¼');\n    }\n    \n    const plantId = parts[0];\n    const viewAngle = parts[1];\n    \n    // è·å–æ¤æ ªçš„å›¾åƒæ•°æ®\n    if (!plantDataManager) {\n      throw new Error('PlantDataManageræœªåˆå§‹åŒ–');\n    }\n    \n    const images = await plantDataManager.getPlantImages(plantId, viewAngle);\n    const targetImage = images.find(img => img.id === imageId);\n    \n    if (!targetImage) {\n      throw new Error(`æœªæ‰¾åˆ°å›¾åƒ: ${imageId}`);\n    }\n    \n    // åˆ›å»ºå›¾åƒURL\n    const imageURL = await plantDataManager.fileSystemManager.createImageURL(targetImage);\n    \n    return {\n      url: imageURL,\n      data: targetImage\n    };\n    \n  } catch (error) {\n    console.error('è·å–å›¾åƒæ•°æ®å¤±è´¥:', error);\n    return null;\n  }\n}\n\n/**\n * æ˜¾ç¤ºå›¾åƒè¯¦æƒ…æ¨¡æ€æ¡†\n */\nfunction showImageDetailModal(imageId) {\n  // åˆ›å»ºè¯¦æƒ…æ¨¡æ€æ¡† - ç®€å•å®ç°ï¼Œæ˜¾ç¤ºåŸå›¾å’Œæ ‡æ³¨ç‚¹\n  const modalHTML = `\n    <div id=\"image-detail-modal\" class=\"modal\" style=\"display: flex; z-index: 2000;\">\n      <div class=\"modal-content\" style=\"max-width: 90vw; max-height: 90vh; padding: 20px;\">\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;\">\n          <h3 style=\"margin: 0;\">å›¾åƒè¯¦æƒ…</h3>\n          <button onclick=\"closeImageDetailModal()\" class=\"modal-close\"></button>\n        </div>\n        <div style=\"text-align: center;\">\n          <div style=\"font-size: 14px; color: #6b7280; margin-bottom: 10px; word-break: break-all;\">\n            ${imageId}\n          </div>\n          <div style=\"max-width: 100%; max-height: 70vh; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px;\">\n            <canvas id=\"detail-canvas\" style=\"max-width: 100%; height: auto;\"></canvas>\n          </div>\n        </div>\n      </div>\n    </div>\n  `;\n  \n  // ç§»é™¤å·²å­˜åœ¨çš„è¯¦æƒ…æ¨¡æ€æ¡†\n  const existingModal = document.getElementById('image-detail-modal');\n  if (existingModal) {\n    existingModal.remove();\n  }\n  \n  // æ·»åŠ åˆ°body\n  document.body.insertAdjacentHTML('beforeend', modalHTML);\n  \n  // æ¸²æŸ“å¤§å›¾\n  renderImageDetail(imageId);\n  \n  // ç»‘å®šå…³é—­äº‹ä»¶\n  window.closeImageDetailModal = function() {\n    const modal = document.getElementById('image-detail-modal');\n    if (modal) {\n      modal.remove();\n    }\n  };\n}\n\n/**\n * æ¸²æŸ“å›¾åƒè¯¦æƒ…\n */\nasync function renderImageDetail(imageId) {\n  const canvas = document.getElementById('detail-canvas');\n  if (!canvas) return;\n  \n  try {\n    // è·å–æ ‡æ³¨æ•°æ®\n    const previewCanvas = document.querySelector(`[data-image-id=\"${imageId}\"]`);\n    const annotations = previewCanvas ? JSON.parse(previewCanvas.dataset.annotations) : [];\n    \n    // è·å–å›¾åƒæ•°æ®\n    const imageData = await getImageDataFromId(imageId);\n    if (!imageData) {\n      throw new Error('æ— æ³•è·å–å›¾åƒæ•°æ®');\n    }\n    \n    // åŠ è½½å›¾åƒ\n    const image = new Image();\n    image.crossOrigin = 'anonymous';\n    \n    await new Promise((resolve, reject) => {\n      image.onload = () => resolve();\n      image.onerror = () => reject(new Error('å›¾åƒåŠ è½½å¤±è´¥'));\n      image.src = imageData.url;\n    });\n    \n    // è®¾ç½®canvaså°ºå¯¸ï¼ˆä¿æŒåŸå›¾æ¯”ä¾‹ï¼Œä½†é™åˆ¶æœ€å¤§å°ºå¯¸ï¼‰\n    const maxWidth = 800;\n    const maxHeight = 600;\n    \n    let drawWidth = image.width;\n    let drawHeight = image.height;\n    \n    if (drawWidth > maxWidth || drawHeight > maxHeight) {\n      const scale = Math.min(maxWidth / drawWidth, maxHeight / drawHeight);\n      drawWidth *= scale;\n      drawHeight *= scale;\n    }\n    \n    canvas.width = drawWidth;\n    canvas.height = drawHeight;\n    \n    const ctx = canvas.getContext('2d');\n    \n    // ç»˜åˆ¶å›¾åƒ\n    ctx.drawImage(image, 0, 0, drawWidth, drawHeight);\n    \n    // ç»˜åˆ¶æ ‡æ³¨ç‚¹\n    if (annotations && annotations.length > 0) {\n      const scaleX = drawWidth / image.width;\n      const scaleY = drawHeight / image.height;\n      \n      annotations.forEach((annotation, index) => {\n        const x = annotation.x * scaleX;\n        const y = annotation.y * scaleY;\n        \n        // ç»˜åˆ¶æ ‡æ³¨ç‚¹\n        ctx.fillStyle = '#ef4444';\n        ctx.strokeStyle = '#ffffff';\n        ctx.lineWidth = 3;\n        \n        ctx.beginPath();\n        ctx.arc(x, y, 8, 0, 2 * Math.PI);\n        ctx.fill();\n        ctx.stroke();\n        \n        // ç»˜åˆ¶æ ‡æ³¨ç‚¹ç¼–å·\n        ctx.fillStyle = '#ffffff';\n        ctx.font = 'bold 14px Arial';\n        ctx.textAlign = 'center';\n        ctx.textBaseline = 'middle';\n        ctx.fillText((index + 1).toString(), x, y);\n      });\n    }\n    \n  } catch (error) {\n    console.error('æ¸²æŸ“å›¾åƒè¯¦æƒ…å¤±è´¥:', error);\n    canvas.parentElement.innerHTML = '<div style=\"color: #dc2626; padding: 20px;\">å›¾åƒåŠ è½½å¤±è´¥</div>';\n  }\n}\n\n// å…¨å±€å‡½æ•°ï¼šåˆ‡æ¢åˆ†æ”¯ç‚¹é¢„è§ˆ\nwindow.toggleBranchPointPreview = function(show = null) {\n  if (branchPointPreviewManager) {\n    branchPointPreviewManager.toggleVisibility(show);\n  }\n};\n\n/**\n * å¯¼èˆªåˆ°ä¸Šä¸€å¼ å›¾ç‰‡\n */\nasync function navigateToPreviousImage() {\n  // ğŸ”§ FIX: Additional navigation lock check\n  if (appState.navigation.isNavigating) {\n    console.log('[Navigation] navigateToPreviousImage blocked - already navigating');\n    return;\n  }\n\n  if (!appState.currentPlant || !appState.currentImage) {\n    console.log('æ²¡æœ‰å½“å‰æ¤ç‰©æˆ–å›¾åƒï¼Œæ— æ³•å¯¼èˆª');\n    return;\n  }\n  \n  try {\n    // è·å–å½“å‰è§†è§’çš„æ‰€æœ‰å›¾åƒ\n    const images = await plantDataManager.getPlantImages(\n      appState.currentPlant.id, \n      appState.currentPlant.selectedViewAngle\n    );\n    \n    if (images.length <= 1) {\n      console.log('åªæœ‰ä¸€å¼ å›¾åƒï¼Œæ— æ³•å¯¼èˆªåˆ°ä¸Šä¸€å¼ ');\n      return;\n    }\n    \n    // æ‰¾åˆ°å½“å‰å›¾åƒçš„ç´¢å¼•\n    const currentIndex = images.findIndex(img => img.id === appState.currentImage.id);\n    \n    if (currentIndex === -1) {\n      console.warn('æœªæ‰¾åˆ°å½“å‰å›¾åƒåœ¨åˆ—è¡¨ä¸­çš„ä½ç½®');\n      return;\n    }\n    \n    // è®¡ç®—ä¸Šä¸€å¼ å›¾åƒçš„ç´¢å¼•ï¼ˆå¾ªç¯åˆ°æœ€åä¸€å¼ ï¼‰\n    const previousIndex = currentIndex === 0 ? images.length - 1 : currentIndex - 1;\n    const previousImage = images[previousIndex];\n    \n    console.log(`å¯¼èˆªï¼šä»ç¬¬${currentIndex + 1}å¼ åˆ‡æ¢åˆ°ç¬¬${previousIndex + 1}å¼ `);\n    \n    // åˆ‡æ¢åˆ°ä¸Šä¸€å¼ å›¾åƒ\n    await handleImageSelect(previousImage, true);\n    \n  } catch (error) {\n    console.error('å¯¼èˆªåˆ°ä¸Šä¸€å¼ å›¾åƒå¤±è´¥:', error);\n    showError('å›¾åƒå¯¼èˆªå¤±è´¥', error.message);\n  }\n}\n\n/**\n * å¯¼èˆªåˆ°ä¸‹ä¸€å¼ å›¾ç‰‡\n * @param {boolean} autoMode - æ˜¯å¦ä¸ºè‡ªåŠ¨åŒ–æ¨¡å¼ï¼ˆä¸å¾ªç¯å›ç¬¬ä¸€å¼ ï¼‰\n * @returns {boolean} æ˜¯å¦æˆåŠŸåˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡\n */\nasync function navigateToNextImage(autoMode = false) {\n  // ğŸ”§ FIX: Additional navigation lock check\n  if (appState.navigation.isNavigating) {\n    console.log('[Navigation] navigateToNextImage blocked - already navigating');\n    return false;\n  }\n\n  if (!appState.currentPlant || !appState.currentImage) {\n    console.log('æ²¡æœ‰å½“å‰æ¤ç‰©æˆ–å›¾åƒï¼Œæ— æ³•å¯¼èˆª');\n    return false;\n  }\n\n  try {\n    // è·å–å½“å‰è§†è§’çš„æ‰€æœ‰å›¾åƒ\n    const images = await plantDataManager.getPlantImages(\n      appState.currentPlant.id,\n      appState.currentPlant.selectedViewAngle\n    );\n\n    if (images.length <= 1) {\n      console.log('åªæœ‰ä¸€å¼ å›¾åƒï¼Œæ— æ³•å¯¼èˆªåˆ°ä¸‹ä¸€å¼ ');\n      return false;\n    }\n\n    // æ‰¾åˆ°å½“å‰å›¾åƒçš„ç´¢å¼•\n    const currentIndex = images.findIndex(img => img.id === appState.currentImage.id);\n\n    if (currentIndex === -1) {\n      console.warn('æœªæ‰¾åˆ°å½“å‰å›¾åƒåœ¨åˆ—è¡¨ä¸­çš„ä½ç½®');\n      return false;\n    }\n\n    // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æœ€åä¸€å¼ \n    if (currentIndex === images.length - 1) {\n      if (autoMode) {\n        console.log('è‡ªåŠ¨åŒ–æ¨¡å¼ï¼šå·²ç»æ˜¯æœ€åä¸€å¼ å›¾ç‰‡ï¼Œä¸å¾ªç¯');\n        return false;\n      }\n      // éè‡ªåŠ¨åŒ–æ¨¡å¼ï¼šå¾ªç¯åˆ°ç¬¬ä¸€å¼ \n    }\n\n    // è®¡ç®—ä¸‹ä¸€å¼ å›¾åƒçš„ç´¢å¼•\n    const nextIndex = currentIndex === images.length - 1 ? 0 : currentIndex + 1;\n    const nextImage = images[nextIndex];\n\n    console.log(`å¯¼èˆªï¼šä»ç¬¬${currentIndex + 1}å¼ åˆ‡æ¢åˆ°ç¬¬${nextIndex + 1}å¼ `);\n\n    // åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾åƒ\n    await handleImageSelect(nextImage, true);\n    return true;\n\n  } catch (error) {\n    console.error('å¯¼èˆªåˆ°ä¸‹ä¸€å¼ å›¾åƒå¤±è´¥:', error);\n    showError('å›¾åƒå¯¼èˆªå¤±è´¥', error.message);\n    return false;\n  }\n}\n\n/**\n * å¤„ç†è‡ªåŠ¨åŒ–æ–¹å‘é€‰æ‹©ï¼ˆä¼ ç»Ÿæ ‡æ³¨å‡çº§ï¼‰\n */\nfunction handleAutoDirectionSelection() {\n  if (!annotationTool) {\n    showError('åŠŸèƒ½ä¸å¯ç”¨', 'æ ‡æ³¨å·¥å…·æœªåˆå§‹åŒ–');\n    return;\n  }\n\n  // æ£€æŸ¥æ˜¯å¦æœ‰æ ‡æ³¨ç‚¹\n  if (!annotationTool.keypoints || annotationTool.keypoints.length === 0) {\n    showError('ä¼ ç»Ÿæ ‡æ³¨å‡çº§', 'å½“å‰å›¾åƒæ²¡æœ‰æ ‡æ³¨ç‚¹ï¼Œè¯·å…ˆæ·»åŠ æ ‡æ³¨ç‚¹');\n    return;\n  }\n\n  // é¢å¤–æ£€æŸ¥ï¼šè‹¥å½“å‰ç±»å‹å­˜åœ¨ä¸”ä¸æ”¯æŒæ–¹å‘ï¼Œæç¤ºå¹¶é€€å‡º\n  const currentType = window.PlantAnnotationTool?.annotationTool?.customAnnotationManager?.getCurrentCustomType?.();\n  if (currentType && currentType.metadata && currentType.metadata.isDirectional === false) {\n    showError('Auto Direction Disabled', 'å½“å‰é€‰æ‹©çš„ç±»å‹æœªå¯ç”¨æ–¹å‘åŠŸèƒ½');\n    return;\n  }\n\n  // ğŸ”§ FIX: Read mode from UI selector before starting auto direction mode\n  const modeSelector = document.getElementById('auto-direction-mode-selector');\n  if (modeSelector && modeSelector.value) {\n    console.log(`[è°ƒè¯•] ä»UIé€‰æ‹©å™¨è¯»å–æ¨¡å¼: ${modeSelector.value}`);\n    annotationTool.autoDirectionMode = modeSelector.value;\n  } else {\n    // Fallback to longitudinal if no selection\n    console.log('[è°ƒè¯•] UIé€‰æ‹©å™¨æ— å€¼ï¼Œä½¿ç”¨é»˜è®¤longitudinalæ¨¡å¼');\n    annotationTool.autoDirectionMode = 'longitudinal';\n    if (modeSelector) {\n      modeSelector.value = 'longitudinal';\n    }\n  }\n\n  // å¯åŠ¨è‡ªåŠ¨åŒ–æ–¹å‘å‡çº§æ¨¡å¼\n  const success = annotationTool.startAutoDirectionMode();\n\n  if (!success) {\n    // startAutoDirectionMode å†…éƒ¨å·²ç»æ˜¾ç¤ºäº†æç¤ºä¿¡æ¯\n    return;\n  }\n\n  // æ›´æ–°æŒ‰é’®çŠ¶æ€\n  const autoDirectionBtn = document.getElementById('auto-direction-btn');\n  if (autoDirectionBtn) {\n    console.log('[è°ƒè¯•] æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºè‡ªåŠ¨æ¨¡å¼');\n\n    // å…ˆç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨\n    autoDirectionBtn.removeEventListener('click', handleAutoDirectionSelection);\n\n    // æ›´æ–°æŒ‰é’®å¤–è§‚\n    autoDirectionBtn.textContent = 'Exit Auto Mode';\n    autoDirectionBtn.classList.add('active');\n\n    // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°\n    const pauseHandler = () => {\n      console.log('[è°ƒè¯•] è‡ªåŠ¨åŒ–æŒ‰é’®è¢«ç‚¹å‡»ï¼Œæš‚åœæ¨¡å¼');\n      annotationTool.pauseAutoDirectionMode();\n    };\n\n    // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨\n    autoDirectionBtn.addEventListener('click', pauseHandler);\n\n    // ä¿å­˜å¤„ç†å‡½æ•°å¼•ç”¨ï¼Œä»¥ä¾¿åç»­ç§»é™¤\n    autoDirectionBtn._pauseHandler = pauseHandler;\n  }\n\n  updateProgressInfo('ä¼ ç»Ÿæ ‡æ³¨å‡çº§æ¨¡å¼å·²å¯åŠ¨ã€‚ç§»åŠ¨é¼ æ ‡é€‰æ‹©æ–¹å‘ï¼Œå·¦é”®ç¡®è®¤ï¼Œå³é”®æš‚åœã€‚');\n}\n\n/**\n * é‡ç½®è‡ªåŠ¨æ–¹å‘é€‰æ‹©æŒ‰é’®çŠ¶æ€\n */\nfunction resetAutoDirectionButton() {\n  const autoDirectionBtn = document.getElementById('auto-direction-btn');\n  if (autoDirectionBtn) {\n    console.log('[è°ƒè¯•] é‡ç½®è‡ªåŠ¨æ–¹å‘æŒ‰é’®çŠ¶æ€');\n\n    // ç§»é™¤æš‚åœå¤„ç†å‡½æ•°\n    if (autoDirectionBtn._pauseHandler) {\n      autoDirectionBtn.removeEventListener('click', autoDirectionBtn._pauseHandler);\n      autoDirectionBtn._pauseHandler = null;\n    }\n\n    // æ¢å¤æŒ‰é’®å¤–è§‚\n    autoDirectionBtn.textContent = 'Auto Direction';\n    autoDirectionBtn.classList.remove('active');\n\n    // é‡æ–°æ·»åŠ åŸå§‹äº‹ä»¶ç›‘å¬å™¨\n    autoDirectionBtn.addEventListener('click', handleAutoDirectionSelection);\n    \n    console.log('[è°ƒè¯•] è‡ªåŠ¨æ–¹å‘æŒ‰é’®å·²é‡ç½®ä¸ºåˆå§‹çŠ¶æ€');\n  }\n}\n\n// å°†é‡ç½®å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¾›AnnotationToolè°ƒç”¨\nwindow.resetAutoDirectionButton = resetAutoDirectionButton;\n\n/**\n * æ˜¾ç¤ºè·³è¿‡æ¤æ ªæ¨¡æ€æ¡†\n */\nfunction showSkipPlantModal(plantId, event) {\n  // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ¤æ ªé€‰æ‹©\n  if (event) {\n    event.stopPropagation();\n  }\n\n  const plant = appState.plants.find(p => p.id === plantId);\n  if (!plant) {\n    showError('é”™è¯¯', 'æœªæ‰¾åˆ°æŒ‡å®šçš„æ¤æ ª');\n    return;\n  }\n\n  // è®¾ç½®æ¤æ ªåç§°\n  const plantNameElement = document.getElementById('skip-plant-name');\n  if (plantNameElement) {\n    plantNameElement.textContent = plant.id;\n  }\n\n  // æ¸…ç©ºä¹‹å‰çš„è¾“å…¥\n  const reasonTextarea = document.getElementById('skip-reason');\n  if (reasonTextarea) {\n    reasonTextarea.value = '';\n  }\n\n  // æ˜¾ç¤ºæ¨¡æ€æ¡†\n  const modal = document.getElementById('skip-plant-modal');\n  if (modal) {\n    modal.style.display = 'flex';\n    modal.dataset.plantId = plantId;\n\n    // èšç„¦åˆ°æ–‡æœ¬æ¡†\n    setTimeout(() => {\n      if (reasonTextarea) {\n        reasonTextarea.focus();\n      }\n    }, 100);\n  }\n}\n\n/**\n * éšè—è·³è¿‡æ¤æ ªæ¨¡æ€æ¡†\n */\nfunction hideSkipPlantModal() {\n  const modal = document.getElementById('skip-plant-modal');\n  if (modal) {\n    modal.style.display = 'none';\n    modal.dataset.plantId = '';\n  }\n}\n\n/**\n * ç¡®è®¤è·³è¿‡æ¤æ ª\n */\nasync function confirmSkipPlant() {\n  const modal = document.getElementById('skip-plant-modal');\n  const plantId = modal?.dataset.plantId;\n  const reasonTextarea = document.getElementById('skip-reason');\n  const reason = reasonTextarea?.value.trim();\n\n  if (!plantId) {\n    showError('é”™è¯¯', 'æœªæ‰¾åˆ°è¦è·³è¿‡çš„æ¤æ ª');\n    return;\n  }\n\n  if (!reason) {\n    showError('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥è·³è¿‡åŸå› ');\n    reasonTextarea?.focus();\n    return;\n  }\n\n  try {\n    // æ›´æ–°æ¤æ ªçŠ¶æ€\n    await plantDataManager.skipPlant(plantId, reason);\n\n    // æ›´æ–°UI\n    const plant = appState.plants.find(p => p.id === plantId);\n    if (plant) {\n      plant.status = 'skipped';\n      plant.skipReason = reason;\n      plant.skipDate = new Date().toISOString();\n\n      // é‡æ–°æ¸²æŸ“æ¤æ ªåˆ—è¡¨é¡¹\n      const plantItem = document.querySelector(`[data-plant-id=\"${plantId}\"]`);\n      if (plantItem) {\n        const newItem = createPlantListItem(plant);\n        plantItem.parentNode.replaceChild(newItem, plantItem);\n        \n        // ğŸ”§ FIX: Update note badge for the re-rendered plant item\n        if (window.PlantAnnotationTool?.noteUI) {\n          setTimeout(() => {\n            window.PlantAnnotationTool.noteUI.updatePlantNoteBadge(plantId);\n          }, 100);\n        }\n      }\n\n      // æ›´æ–°ç»Ÿè®¡\n      updateProgressStats();\n\n      // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¢«è·³è¿‡çš„æ¤æ ªï¼Œæ¸…é™¤é€‰æ‹©\n      if (appState.currentPlant?.id === plantId) {\n        console.log('å½“å‰æ¤æ ªè¢«è·³è¿‡ï¼Œåˆå§‹åŒ–ç©ºå·¥ä½œåŒº');\n        initializeEmptyWorkspace();\n      }\n    }\n\n    hideSkipPlantModal();\n    showSuccess('è·³è¿‡æˆåŠŸ', `æ¤æ ª ${plantId} å·²æ ‡è®°ä¸ºè·³è¿‡`);\n\n  } catch (error) {\n    console.error('è·³è¿‡æ¤æ ªå¤±è´¥:', error);\n    showError('è·³è¿‡å¤±è´¥', error.message);\n  }\n}\n\n/**\n * ğŸ”§ NEW: å¤„ç†æ’¤é”€è·³è¿‡æ¤æ ª - æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†\n */\nasync function handleUnskipPlant(plantId, event) {\n  // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ¤æ ªé€‰æ‹©\n  if (event) {\n    event.stopPropagation();\n  }\n\n  const plant = appState.plants.find(p => p.id === plantId);\n  if (!plant) {\n    showError('é”™è¯¯', 'æœªæ‰¾åˆ°æŒ‡å®šçš„æ¤æ ª');\n    return;\n  }\n\n  if (plant.status !== 'skipped') {\n    showError('æ“ä½œé”™è¯¯', 'æ¤æ ªå½“å‰çŠ¶æ€ä¸æ˜¯è·³è¿‡çŠ¶æ€');\n    return;\n  }\n\n  // æ˜¾ç¤ºæ’¤é”€è·³è¿‡ç¡®è®¤æ¨¡æ€æ¡†\n  showUnskipPlantModal(plantId, plant.skipReason);\n}\n\n/**\n * ğŸ”§ NEW: å¤„ç†æ’¤é”€å®Œæˆæ¤æ ª - æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†\n */\nasync function handleUncompletePlant(plantId, event) {\n  // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ¤æ ªé€‰æ‹©\n  if (event) {\n    event.stopPropagation();\n  }\n\n  const plant = appState.plants.find(p => p.id === plantId);\n  if (!plant) {\n    showError('é”™è¯¯', 'æœªæ‰¾åˆ°æŒ‡å®šçš„æ¤æ ª');\n    return;\n  }\n\n  if (plant.status !== 'completed') {\n    showError('æ“ä½œé”™è¯¯', 'æ¤æ ªå½“å‰çŠ¶æ€ä¸æ˜¯å·²å®ŒæˆçŠ¶æ€');\n    return;\n  }\n\n  // æ˜¾ç¤ºæ’¤é”€å®Œæˆç¡®è®¤æ¨¡æ€æ¡†\n  showUncompletePlantModal(plantId);\n}\n\n/**\n * å¤„ç†çŠ¶æ€è¿‡æ»¤å™¨å˜åŒ–\n */\nfunction handleStatusFilterChange() {\n  const statusFilter = document.getElementById('status-filter');\n  const searchInput = document.getElementById('plant-search');\n\n  if (!statusFilter || !plantDataManager) return;\n\n  const selectedStatus = statusFilter.value;\n  const searchQuery = searchInput?.value.trim() || '';\n\n  // åº”ç”¨è¿‡æ»¤\n  applyPlantsFilter(selectedStatus, searchQuery);\n}\n\n/**\n * å¤„ç†æ¤æ ªæœç´¢è¾“å…¥\n */\nfunction handlePlantSearchInput() {\n  const statusFilter = document.getElementById('status-filter');\n  const searchInput = document.getElementById('plant-search');\n\n  if (!searchInput || !plantDataManager) return;\n\n  const searchQuery = searchInput.value.trim();\n  const selectedStatus = statusFilter?.value || 'all';\n\n  // åº”ç”¨è¿‡æ»¤\n  applyPlantsFilter(selectedStatus, searchQuery);\n}\n\n/**\n * åº”ç”¨æ¤æ ªè¿‡æ»¤\n */\nfunction applyPlantsFilter(status, searchQuery) {\n  if (!plantDataManager) return;\n\n  let filteredPlants = plantDataManager.filterPlantsByStatus(status);\n\n  // å¦‚æœæœ‰æœç´¢æŸ¥è¯¢ï¼Œè¿›ä¸€æ­¥è¿‡æ»¤\n  if (searchQuery) {\n    const lowerQuery = searchQuery.toLowerCase();\n    filteredPlants = filteredPlants.filter(plant =>\n      plant.id.toLowerCase().includes(lowerQuery) ||\n      plant.name.toLowerCase().includes(lowerQuery)\n    );\n  }\n\n  // é‡æ–°æ¸²æŸ“æ¤æ ªåˆ—è¡¨\n  renderPlantList(filteredPlants);\n\n  console.log(`è¿‡æ»¤ç»“æœ: çŠ¶æ€=${status}, æœç´¢=\"${searchQuery}\", ç»“æœ=${filteredPlants.length}ä¸ªæ¤æ ª`);\n}\n\n/**\n * ğŸ”§ NEW: æ˜¾ç¤ºæ’¤é”€è·³è¿‡æ¤æ ªæ¨¡æ€æ¡†\n */\nfunction showUnskipPlantModal(plantId, skipReason) {\n  const modal = document.getElementById('unskip-plant-modal');\n  const plantIdElement = document.getElementById('unskip-plant-id');\n  const skipReasonElement = document.getElementById('unskip-skip-reason');\n  const newStatusElement = document.getElementById('unskip-new-status');\n  \n  if (!modal) {\n    console.error('Unskip plant modal not found');\n    return;\n  }\n\n  // è®¾ç½®æ¤æ ªä¿¡æ¯\n  if (plantIdElement) {\n    plantIdElement.textContent = plantId;\n  }\n  \n  if (skipReasonElement) {\n    skipReasonElement.textContent = skipReason || 'æ— ';\n  }\n\n  // ğŸ”§ FIX: Set the new status that will be applied\n  if (newStatusElement) {\n    newStatusElement.textContent = 'Pending (will be determined by annotations)';\n  }\n\n  // æ˜¾ç¤ºæ¨¡æ€æ¡†\n  modal.style.display = 'flex';\n  modal.dataset.plantId = plantId;\n}\n\n/**\n * ğŸ”§ NEW: éšè—æ’¤é”€è·³è¿‡æ¤æ ªæ¨¡æ€æ¡†\n */\nfunction hideUnskipPlantModal() {\n  const modal = document.getElementById('unskip-plant-modal');\n  if (modal) {\n    modal.style.display = 'none';\n    modal.dataset.plantId = '';\n  }\n}\n\n/**\n * ğŸ”§ NEW: ç¡®è®¤æ’¤é”€è·³è¿‡æ¤æ ª\n */\nasync function confirmUnskipPlant() {\n  const modal = document.getElementById('unskip-plant-modal');\n  const plantId = modal?.dataset.plantId;\n\n  if (!plantId) {\n    showError('é”™è¯¯', 'æœªæ‰¾åˆ°è¦æ’¤é”€è·³è¿‡çš„æ¤æ ª');\n    return;\n  }\n\n  try {\n    // è°ƒç”¨PlantDataManagerçš„æ’¤é”€è·³è¿‡æ–¹æ³•\n    await plantDataManager.unskipPlant(plantId);\n    console.log(`[Debug] åç«¯unskipæ“ä½œå®Œæˆï¼Œæ¤ç‰©ID: ${plantId}`);\n\n    // æ›´æ–°æœ¬åœ°æ¤æ ªå¯¹è±¡\n    const plant = appState.plants.find(p => p.id === plantId);\n    if (plant) {\n      console.log(`[Debug] æ›´æ–°å‰æ¤ç‰©çŠ¶æ€: ${plant.status}, skipReason: ${plant.skipReason}`);\n      \n      const annotations = await plantDataManager.getPlantAnnotations(plantId);\n      plant.status = (annotations && annotations.length > 0) ? 'in-progress' : 'pending';\n      delete plant.skipReason;\n      delete plant.skipDate;\n      \n      console.log(`[Debug] æ›´æ–°åæ¤ç‰©çŠ¶æ€: ${plant.status}, skipReason: ${plant.skipReason}`);\n\n      // é‡æ–°æ¸²æŸ“æ¤æ ªåˆ—è¡¨é¡¹\n      const plantItem = document.querySelector(`[data-plant-id=\"${plantId}\"]`);\n      if (plantItem) {\n        const newItem = createPlantListItem(plant);\n        plantItem.parentNode.replaceChild(newItem, plantItem);\n        console.log(`[Debug] æ¤ç‰©åˆ—è¡¨é¡¹å·²é‡æ–°æ¸²æŸ“: ${plantId}`);\n        \n        // ğŸ”§ FIX: Update note badge for the re-rendered plant item\n        if (window.PlantAnnotationTool?.noteUI) {\n          setTimeout(() => {\n            window.PlantAnnotationTool.noteUI.updatePlantNoteBadge(plantId);\n          }, 100);\n        }\n      }\n\n      // æ›´æ–°ç»Ÿè®¡\n      updateProgressStats();\n      \n      // ğŸ”§ NEW: Update complete plant button state after uncomplete\n      updateCompletePlantButtonState();\n    }\n\n    hideUnskipPlantModal();\n    showSuccess('æ’¤é”€æˆåŠŸ', `æ¤æ ª ${plantId} å·²æ¢å¤åˆ°æ­£å¸¸çŠ¶æ€`);\n\n  } catch (error) {\n    console.error('æ’¤é”€è·³è¿‡æ¤æ ªå¤±è´¥:', error);\n    showError('æ’¤é”€å¤±è´¥', error.message);\n  }\n}\n\n/**\n * ğŸ”§ NEW: æ˜¾ç¤ºæ’¤é”€å®Œæˆæ¤æ ªæ¨¡æ€æ¡†\n */\nfunction showUncompletePlantModal(plantId) {\n  const modal = document.getElementById('uncomplete-plant-modal');\n  const plantIdElement = document.getElementById('uncomplete-plant-id');\n  \n  if (!modal) {\n    console.error('Uncomplete plant modal not found');\n    return;\n  }\n\n  // è®¾ç½®æ¤æ ªä¿¡æ¯\n  if (plantIdElement) {\n    plantIdElement.textContent = plantId;\n  }\n\n  // æ˜¾ç¤ºæ¨¡æ€æ¡†\n  modal.style.display = 'flex';\n  modal.dataset.plantId = plantId;\n}\n\n/**\n * ğŸ”§ NEW: éšè—æ’¤é”€å®Œæˆæ¤æ ªæ¨¡æ€æ¡†\n */\nfunction hideUncompletePlantModal() {\n  const modal = document.getElementById('uncomplete-plant-modal');\n  if (modal) {\n    modal.style.display = 'none';\n    modal.dataset.plantId = '';\n  }\n}\n\n/**\n * ğŸ”§ NEW: ç¡®è®¤æ’¤é”€å®Œæˆæ¤æ ª\n */\nasync function confirmUncompletePlant() {\n  const modal = document.getElementById('uncomplete-plant-modal');\n  const plantId = modal?.dataset.plantId;\n\n  if (!plantId) {\n    showError('é”™è¯¯', 'æœªæ‰¾åˆ°è¦æ’¤é”€å®Œæˆçš„æ¤æ ª');\n    return;\n  }\n\n  try {\n    // è°ƒç”¨PlantDataManagerçš„æ’¤é”€å®Œæˆæ–¹æ³•\n    await plantDataManager.uncompletePlant(plantId);\n\n    // æ›´æ–°æœ¬åœ°æ¤æ ªå¯¹è±¡\n    const plant = appState.plants.find(p => p.id === plantId);\n    if (plant) {\n      const annotations = await plantDataManager.getPlantAnnotations(plantId);\n      plant.status = (annotations && annotations.length > 0) ? 'in-progress' : 'pending';\n\n      // é‡æ–°æ¸²æŸ“æ¤æ ªåˆ—è¡¨é¡¹\n      const plantItem = document.querySelector(`[data-plant-id=\"${plantId}\"]`);\n      if (plantItem) {\n        const newItem = createPlantListItem(plant);\n        plantItem.parentNode.replaceChild(newItem, plantItem);\n        \n        // ğŸ”§ FIX: Update note badge for the re-rendered plant item\n        if (window.PlantAnnotationTool?.noteUI) {\n          setTimeout(() => {\n            window.PlantAnnotationTool.noteUI.updatePlantNoteBadge(plantId);\n          }, 100);\n        }\n      }\n\n      // æ›´æ–°ç»Ÿè®¡\n      updateProgressStats();\n      \n      // ğŸ”§ NEW: Update complete plant button state after uncomplete\n      updateCompletePlantButtonState();\n    }\n\n    hideUncompletePlantModal();\n    showSuccess('æ’¤é”€æˆåŠŸ', `æ¤æ ª ${plantId} å·²æ¢å¤åˆ°è¿›è¡Œä¸­çŠ¶æ€`);\n\n  } catch (error) {\n    console.error('æ’¤é”€å®Œæˆæ¤æ ªå¤±è´¥:', error);\n    showError('æ’¤é”€å¤±è´¥', error.message);\n  }\n}\n\n// å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€å¯¹è±¡ï¼Œä»¥ä¾¿AnnotationToolå¯ä»¥è®¿é—®\nwindow.handleAutoDirectionSelection = handleAutoDirectionSelection;\nwindow.navigateToNextImage = navigateToNextImage;\nwindow.showSkipPlantModal = showSkipPlantModal;\n\n// ğŸ”§ NEW: Global functions for state reversal operations\nwindow.handleUnskipPlant = handleUnskipPlant;\n\n// ğŸ”§ FIX: Expose handleImageSelect for cross-sectional mode support\nwindow.handleImageSelect = handleImageSelect;\n\n/**\n * å¤„ç†é”å®šå€æ•°å¼€å…³å˜åŒ–\n */\nfunction handleZoomLockChange() {\n  const zoomLockCheckbox = document.getElementById('zoom-lock-checkbox');\n  const zoomLockValue = document.getElementById('zoom-lock-value');\n\n  if (zoomLockCheckbox && zoomLockValue) {\n    const isLocked = zoomLockCheckbox.checked;\n    zoomLockValue.disabled = !isLocked;\n\n    console.log(`ç¼©æ”¾é”å®š: ${isLocked ? 'å¼€å¯' : 'å…³é—­'}`);\n\n    if (isLocked) {\n      const lockValue = parseFloat(zoomLockValue.value);\n      console.log(`é”å®šå€æ•°è®¾ç½®ä¸º: ${lockValue}x`);\n    }\n  }\n}\n\n/**\n * å¤„ç†é”å®šå€æ•°å€¼å˜åŒ–\n */\nfunction handleZoomLockValueChange() {\n  const zoomLockValue = document.getElementById('zoom-lock-value');\n  if (zoomLockValue) {\n    const lockValue = parseFloat(zoomLockValue.value);\n    console.log(`é”å®šå€æ•°æ›´æ–°ä¸º: ${lockValue}x`);\n  }\n}\n\n/**\n * å¤„ç†è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®å¼€å…³å˜åŒ–\n */\nfunction handleAutoMoveChange() {\n  const autoMoveCheckbox = document.getElementById('auto-move-checkbox');\n\n  if (autoMoveCheckbox) {\n    const isEnabled = autoMoveCheckbox.checked;\n    console.log(`è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„æœŸä½ç½®: ${isEnabled ? 'å¼€å¯' : 'å…³é—­'}`);\n\n    // é€šçŸ¥AnnotationToolæ›´æ–°è®¾ç½®\n    if (annotationTool && typeof annotationTool.setAutoMoveToExpectedPosition === 'function') {\n      annotationTool.setAutoMoveToExpectedPosition(isEnabled);\n    }\n  }\n}\n\n/**\n * ğŸ”„ å¤„ç†å®æ—¶å˜æ›´åŒæ­¥å¼€å…³å˜åŒ–\n */\nfunction handleRealTimeChangeChange() {\n  const realTimeChangeCheckbox = document.getElementById('real-time-change-checkbox');\n  \n  if (realTimeChangeCheckbox) {\n    const isEnabled = realTimeChangeCheckbox.checked;\n    console.log(`ğŸ”„ å®æ—¶å˜æ›´åŒæ­¥: ${isEnabled ? 'å¼€å¯' : 'å…³é—­'}`);\n    \n    // é€šçŸ¥RealTimeSyncManageræ›´æ–°è®¾ç½®\n    if (realTimeSyncManager && typeof realTimeSyncManager.setEnabled === 'function') {\n      realTimeSyncManager.setEnabled(isEnabled);\n    }\n    \n    // ç«‹å³æ›´æ–°è¿›åº¦ä¿¡æ¯ä»¥åæ˜ çŠ¶æ€å˜åŒ–\n    updateProgressInfo(`å®æ—¶å˜æ›´åŒæ­¥å·²${isEnabled ? 'å¼€å¯' : 'å…³é—­'}`);\n  }\n}\n\n/**\n * ğŸ”§ NEW: Handle auto direction mode change (Longitudinal vs Cross-Sectional)\n */\nfunction handleAutoDirectionModeChange() {\n  const autoDirectionModeSelector = document.getElementById('auto-direction-mode-selector');\n  \n  if (autoDirectionModeSelector) {\n    const selectedMode = autoDirectionModeSelector.value;\n    console.log(`Auto direction mode changed to: ${selectedMode}`);\n    \n    // Notify AnnotationTool about the mode change\n    if (annotationTool && typeof annotationTool.setAutoDirectionMode === 'function') {\n      annotationTool.setAutoDirectionMode(selectedMode);\n    }\n    \n    // Update progress info to reflect the change\n    const modeText = selectedMode === 'cross-sectional' ? 'Vertical Mode (Order by Order)' : 'Horizontal Mode (Image by Image)';\n    updateProgressInfo(`Auto direction mode set to: ${modeText}`);\n    \n    // Update UI classes for visual feedback\n    const autoDirectionBtn = document.getElementById('auto-direction-btn');\n    if (autoDirectionBtn) {\n      autoDirectionBtn.classList.remove('longitudinal-mode', 'cross-sectional-mode');\n      autoDirectionBtn.classList.add(`${selectedMode}-mode`);\n    }\n  }\n}\n\n/**\n * ğŸ”§ NEW: Handle auto order button click\n */\nfunction handleAutoOrderClick() {\n  if (!annotationTool) {\n    showError('è‡ªåŠ¨æ’åºå¤±è´¥', 'æ ‡æ³¨å·¥å…·æœªåˆå§‹åŒ–');\n    return;\n  }\n  \n  // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†annotation type\n  if (!annotationTool.customAnnotationManager || !annotationTool.customAnnotationManager.isInCustomMode()) {\n    showError('è‡ªåŠ¨æ’åºä¸å¯ç”¨', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ ‡æ³¨ç±»å‹');\n    return;\n  }\n  \n  const currentType = annotationTool.customAnnotationManager.getCurrentCustomType();\n  if (!currentType) {\n    showError('è‡ªåŠ¨æ’åºä¸å¯ç”¨', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ ‡æ³¨ç±»å‹');\n    return;\n  }\n  \n  // å¯åŠ¨æˆ–åœæ­¢auto orderæ¨¡å¼\n  if (annotationTool.state.isAutoOrderMode) {\n    annotationTool.stopAutoOrderMode();\n  } else {\n    annotationTool.startAutoOrderMode(currentType.id);\n  }\n}\n\n/**\n * è·å–è‡ªåŠ¨åˆ‡æ¢è®¾ç½®\n */\nfunction getAutoMoveSettings() {\n  const autoMoveCheckbox = document.getElementById('auto-move-checkbox');\n  return {\n    isEnabled: autoMoveCheckbox ? autoMoveCheckbox.checked : false\n  };\n}\n\n/**\n * è·å–é”å®šå€æ•°è®¾ç½®\n */\nfunction getZoomLockSettings() {\n  const zoomLockCheckbox = document.getElementById('zoom-lock-checkbox');\n  const zoomLockValue = document.getElementById('zoom-lock-value');\n\n  if (zoomLockCheckbox && zoomLockValue) {\n    return {\n      isLocked: zoomLockCheckbox.checked,\n      lockValue: parseFloat(zoomLockValue.value) || 2.5\n    };\n  }\n\n  return { isLocked: false, lockValue: 2.5 };\n}\n\n/**\n * æ›´æ–°å…¨å±åŠ è½½è¿›åº¦\n */\nfunction updateFullscreenLoading(progress, subtitle, details) {\n  const progressFill = document.getElementById('progress-fill');\n  const progressText = document.getElementById('progress-text');\n  const loadingSubtitle = document.getElementById('loading-subtitle');\n  const loadingDetails = document.getElementById('loading-details');\n  \n  if (progressFill) {\n    progressFill.style.width = `${progress}%`;\n  }\n  \n  if (progressText) {\n    progressText.textContent = `${progress}%`;\n  }\n  \n  if (loadingSubtitle) {\n    loadingSubtitle.textContent = subtitle;\n  }\n  \n  if (loadingDetails) {\n    loadingDetails.textContent = details;\n  }\n}\n\n/**\n * éšè—å…¨å±åŠ è½½æŒ‡ç¤ºå™¨\n */\nfunction hideFullscreenLoading() {\n  const fullscreenLoading = document.getElementById('fullscreen-loading');\n  if (fullscreenLoading) {\n    fullscreenLoading.style.display = 'none';\n  }\n}\n\n/**\n * è‡ªåŠ¨è¿æ¥æ•°æ®é›† - å®Œæ•´æ‰¹é‡åŠ è½½ç‰ˆæœ¬ (å¸¦æ€§èƒ½ç›‘æ§)\n */\nasync function autoConnectDataset() {\n  console.log('å¼€å§‹è‡ªåŠ¨è¿æ¥æ•°æ®é›† - å®Œæ•´æ‰¹é‡åŠ è½½æ¨¡å¼...');\n  \n  // ğŸ”§ PERFORMANCE: å¼€å§‹æ€§èƒ½ç›‘æ§\n  if (performanceMonitor) {\n    performanceMonitor.startMonitoring();\n    performanceMonitor.addCheckpoint('å¼€å§‹æ•°æ®é›†è¿æ¥');\n  }\n  \n  try {\n    updateFullscreenLoading(5, 'Connecting to backend...', 'Establishing connection to the dataset service');\n    \n    // æ£€æŸ¥åç«¯è¿æ¥\n    let datasetInfo;\n    try {\n      datasetInfo = await plantDataManager.fileSystemManager.getDatasetInfo();\n      performanceMonitor?.addCheckpoint('åç«¯è¿æ¥æˆåŠŸ');\n    } catch (connectionError) {\n      performanceMonitor?.recordError(connectionError, 'åç«¯è¿æ¥å¤±è´¥');\n      throw new ConnectionError(\n        'æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡',\n        'è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ã€‚è¿è¡Œ ./start-backend.sh å¯åŠ¨æœåŠ¡å™¨',\n        {\n          originalError: connectionError,\n          serverUrl: 'http://localhost:3003',\n          suggestion: 'å°è¯•è¿è¡Œ: ./start-backend.sh'\n        }\n      );\n    }\n    \n    if (!datasetInfo) {\n      const error = new Error('åç«¯æœåŠ¡å“åº”å¼‚å¸¸ï¼šæ•°æ®é›†ä¿¡æ¯ä¸ºç©º');\n      performanceMonitor?.recordError(error, 'æ•°æ®é›†ä¿¡æ¯éªŒè¯');\n      throw error;\n    }\n\n    console.log('è¿æ¥çš„æ•°æ®é›†:', datasetInfo.datasetPath);\n\n    updateFullscreenLoading(15, 'Validating dataset structure...', 'Checking plant directories and structure');\n\n    // éªŒè¯ç›®å½•ç»“æ„\n    await validateDatasetStructure();\n    performanceMonitor?.addCheckpoint('ç›®å½•ç»“æ„éªŒè¯å®Œæˆ');\n\n    updateFullscreenLoading(25, 'Loading plant data...', 'Scanning plant directories and loading basic info');\n\n    // ä½¿ç”¨PlantDataManageråŠ è½½æ•°æ®é›†\n    const plants = await plantDataManager.loadDataset();\n    performanceMonitor?.recordDataLoaded('plants', plants.length);\n    \n    // æ›´æ–°åº”ç”¨çŠ¶æ€\n    appState.currentDatasetPath = datasetInfo.datasetPath;\n    appState.plants = plants;\n    currentDataset = {\n      path: datasetInfo.datasetPath,\n      name: 'Brassica napus dataset',\n      plantCount: plants.length\n    };\n    \n    console.log(`æ¤ç‰©æ•°æ®åŠ è½½å®Œæˆ: ${plants.length} ä¸ªæ¤ç‰©`);\n\n    // ğŸ”§ PERFORMANCE OPTIMIZATION: å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ç±»å‹\n    updateFullscreenLoading(40, 'Loading all data types...', 'Bulk loading annotations, notes, and statistics');\n    performanceMonitor?.addCheckpoint('å¼€å§‹å¹¶è¡Œæ•°æ®åŠ è½½');\n\n    const loadingTasks = [];\n    const loadingResults = {\n      annotations: null,\n      notes: null,\n      annotationsLoaded: false,\n      notesLoaded: false,\n      errors: []\n    };\n\n    // ä»»åŠ¡1: æ‰¹é‡åŠ è½½æ ‡æ³¨æ•°æ®\n    if (window.PlantAnnotationTool?.annotationManager) {\n      loadingTasks.push(\n        window.PlantAnnotationTool.annotationManager.getAllAnnotationsInBulk()\n          .then(bulkAnnotations => {\n            if (bulkAnnotations) {\n              loadingResults.annotations = bulkAnnotations;\n              loadingResults.annotationsLoaded = true;\n              performanceMonitor?.recordNetworkRequest('annotations', true);\n              performanceMonitor?.recordDataLoaded('annotations', \n                Object.keys(bulkAnnotations.plantAnnotations || {}).length + \n                Object.keys(bulkAnnotations.imageAnnotations || {}).length\n              );\n              console.log('[æ‰¹é‡åŠ è½½] æ ‡æ³¨æ•°æ®åŠ è½½æˆåŠŸ');\n              updateFullscreenLoading(60, 'Annotations loaded successfully...', 'Processing bulk annotation data');\n            } else {\n              console.log('[æ‰¹é‡åŠ è½½] æ ‡æ³¨æ‰¹é‡APIä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æ‡’åŠ è½½æ¨¡å¼');\n              performanceMonitor?.recordFallback('æ ‡æ³¨æ‰¹é‡APIä¸å¯ç”¨');\n            }\n          })\n          .catch(error => {\n            console.warn('[æ‰¹é‡åŠ è½½] æ ‡æ³¨æ•°æ®åŠ è½½å¤±è´¥:', error.message);\n            performanceMonitor?.recordError(error, 'æ ‡æ³¨æ•°æ®æ‰¹é‡åŠ è½½');\n            loadingResults.errors.push(`æ ‡æ³¨åŠ è½½å¤±è´¥: ${error.message}`);\n          })\n      );\n    }\n\n    // ä»»åŠ¡2: æ‰¹é‡åŠ è½½ç¬”è®°æ•°æ®\n    if (window.PlantAnnotationTool?.noteManager) {\n      loadingTasks.push(\n        window.PlantAnnotationTool.noteManager.getAllNotesInBulk()\n          .then(bulkNotes => {\n            if (bulkNotes) {\n              loadingResults.notes = bulkNotes;\n              loadingResults.notesLoaded = true;\n              performanceMonitor?.recordNetworkRequest('notes', true);\n              performanceMonitor?.recordDataLoaded('notes',\n                Object.keys(bulkNotes.plantNotes || {}).length +\n                Object.keys(bulkNotes.imageNotes || {}).length\n              );\n              console.log('[æ‰¹é‡åŠ è½½] ç¬”è®°æ•°æ®åŠ è½½æˆåŠŸ');\n              updateFullscreenLoading(80, 'Notes loaded successfully...', 'Processing bulk note data');\n            } else {\n              console.log('[æ‰¹é‡åŠ è½½] ç¬”è®°æ‰¹é‡APIä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æ‡’åŠ è½½æ¨¡å¼');\n              performanceMonitor?.recordFallback('ç¬”è®°æ‰¹é‡APIä¸å¯ç”¨');\n            }\n          })\n          .catch(error => {\n            console.warn('[æ‰¹é‡åŠ è½½] ç¬”è®°æ•°æ®åŠ è½½å¤±è´¥:', error.message);\n            performanceMonitor?.recordError(error, 'ç¬”è®°æ•°æ®æ‰¹é‡åŠ è½½');\n            loadingResults.errors.push(`ç¬”è®°åŠ è½½å¤±è´¥: ${error.message}`);\n          })\n      );\n    }\n\n    // ç­‰å¾…æ‰€æœ‰åŠ è½½ä»»åŠ¡å®Œæˆ\n    await Promise.allSettled(loadingTasks);\n    performanceMonitor?.addCheckpoint('å¹¶è¡Œæ•°æ®åŠ è½½å®Œæˆ');\n\n    updateFullscreenLoading(90, 'Processing loaded data...', 'Updating caches and preparing UI components');\n\n    // ç”Ÿæˆæœ€ç»ˆçŠ¶æ€æ¶ˆæ¯\n    const loadedComponents = [];\n    if (loadingResults.annotationsLoaded) {\n      const annotationStats = loadingResults.annotations.statistics || {};\n      const totalAnnotations = annotationStats.totalAnnotations || 0;\n      loadedComponents.push(`${totalAnnotations} annotations`);\n    }\n    if (loadingResults.notesLoaded) {\n      const noteStats = loadingResults.notes.statistics || {};\n      const totalNotes = noteStats.totalNotes || 0;\n      loadedComponents.push(`${totalNotes} notes`);\n    }\n\n    const loadedMessage = loadedComponents.length > 0 \n      ? `All data loaded: ${plants.length} plants, ${loadedComponents.join(', ')}`\n      : `Dataset loaded: ${plants.length} plants (bulk APIs not available)`;\n\n    updateFullscreenLoading(95, 'Finalizing initialization...', loadedMessage);\n\n    // ğŸ”§ PERFORMANCE: é¢„å¡«å……ç¼“å­˜ä»¥è·å¾—å³æ—¶å¾½ç« æ›´æ–°\n    if (loadingResults.notesLoaded && window.PlantAnnotationTool?.noteUI) {\n      try {\n        await window.PlantAnnotationTool.noteUI.updateAllPlantNoteBadgesFromBulk(loadingResults.notes);\n        performanceMonitor?.addCheckpoint('ç¬”è®°å¾½ç« é¢„å¡«å……å®Œæˆ');\n        console.log('[æ‰¹é‡åŠ è½½] ç¬”è®°å¾½ç« é¢„å¡«å……å®Œæˆ');\n      } catch (error) {\n        console.warn('[æ‰¹é‡åŠ è½½] ç¬”è®°å¾½ç« é¢„å¡«å……å¤±è´¥:', error.message);\n        performanceMonitor?.recordError(error, 'ç¬”è®°å¾½ç« é¢„å¡«å……');\n      }\n    }\n\n    updateFullscreenLoading(100, 'Initialization complete!', 'All systems ready - entering main application');\n    \n    // ğŸ”§ WAIT FOR COMPLETE LOADING: åªæœ‰åœ¨æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆåæ‰è¿›å…¥ä¸»åº”ç”¨\n    console.log(`[å®Œæ•´åŠ è½½] æ•°æ®åŠ è½½å®Œæˆ - æ ‡æ³¨: ${loadingResults.annotationsLoaded}, ç¬”è®°: ${loadingResults.notesLoaded}`);\n    \n    if (loadingResults.errors.length > 0) {\n      console.warn('[å®Œæ•´åŠ è½½] éƒ¨åˆ†æ•°æ®åŠ è½½å¤±è´¥:', loadingResults.errors);\n    }\n\n    // ğŸ”§ PERFORMANCE: ç»“æŸæ€§èƒ½ç›‘æ§å¹¶ç”ŸæˆæŠ¥å‘Š\n    let performanceReport = null;\n    if (performanceMonitor) {\n      performanceReport = performanceMonitor.endMonitoring();\n      console.log('ğŸš€ [æ€§èƒ½æŠ¥å‘Š] æ‰¹é‡åŠ è½½æ€§èƒ½:', performanceReport);\n      \n      // å°†æ€§èƒ½æŠ¥å‘Šå­˜å‚¨åˆ°å…¨å±€å¯¹è±¡ä¸­ä»¥ä¾¿è°ƒè¯•\n      window.PlantAnnotationTool.lastPerformanceReport = performanceReport;\n    }\n\n    // çŸ­æš‚æ˜¾ç¤ºæˆåŠŸçŠ¶æ€ï¼Œç„¶åè¿›å…¥ä¸»åº”ç”¨\n    setTimeout(() => {\n      hideFullscreenLoading();\n      \n      // æ˜¾ç¤ºæ¤ç‰©åˆ—è¡¨\n      renderPlantList(plants);\n      \n      // åˆå§‹æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º\n      updateProgressStats();\n      \n      // æ›´æ–°è¿›åº¦ä¿¡æ¯\n      updateProgressInfo(loadedMessage);\n      \n      // æ˜¾ç¤ºæ€§èƒ½ä¿¡æ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰\n      if (performanceReport && performanceReport.performanceGrade) {\n        const gradeMsg = `æ€§èƒ½è¯„çº§: ${performanceReport.performanceGrade} (${performanceReport.summary.totalLoadingTime})`;\n        console.log(`[å®Œæ•´åŠ è½½] ${gradeMsg}`);\n      }\n      \n      console.log(`[å®Œæ•´åŠ è½½] åº”ç”¨å¯åŠ¨å®Œæˆ: ${plants.length} ä¸ªæ¤ç‰©, æ ‡æ³¨å·²åŠ è½½: ${loadingResults.annotationsLoaded}, ç¬”è®°å·²åŠ è½½: ${loadingResults.notesLoaded}`);\n    }, 1500); // ç¨é•¿çš„å»¶è¿Ÿä»¥æ˜¾ç¤ºå®ŒæˆçŠ¶æ€\n    \n  } catch (error) {\n    console.error('è‡ªåŠ¨è¿æ¥æ•°æ®é›†å¤±è´¥:', error);\n    \n    // è®°å½•é”™è¯¯åˆ°æ€§èƒ½ç›‘æ§\n    performanceMonitor?.recordError(error, 'æ•°æ®é›†è¿æ¥å¤±è´¥');\n    performanceMonitor?.endMonitoring();\n    \n    if (error instanceof ConnectionError) {\n      hideFullscreenLoading();\n      showConnectionError(error);\n    } else {\n      hideFullscreenLoading();\n      showError('æ•°æ®é›†è¿æ¥å¤±è´¥', `${error.message}\\n\\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡çŠ¶æ€`);\n    }\n    \n    throw error;\n  }\n}\n\n/**\n * è‡ªå®šä¹‰è¿æ¥é”™è¯¯ç±»\n */\nclass ConnectionError extends Error {\n  constructor(title, message, details = {}) {\n    super(message);\n    this.name = 'ConnectionError';\n    this.title = title;\n    this.details = details;\n  }\n}\n\n/**\n * æ˜¾ç¤ºè¿æ¥é”™è¯¯çš„ä¸“é—¨å¤„ç†\n */\nfunction showConnectionError(error) {\n  const errorMessage = `${error.title}\\n\\n${error.message}`;\n  const detailMessage = error.details.suggestion ? \n    `\\n\\nå»ºè®®è§£å†³æ–¹æ¡ˆï¼š\\n${error.details.suggestion}` : '';\n  \n  showError(\n    'åç«¯æœåŠ¡è¿æ¥å¤±è´¥', \n    errorMessage + detailMessage + '\\n\\næœåŠ¡å™¨åœ°å€: ' + (error.details.serverUrl || 'http://localhost:3003')\n  );\n  \n  // æ·»åŠ é‡è¯•æŒ‰é’®åˆ°é”™è¯¯æ¨¡æ€æ¡†\n  addRetryButton();\n}\n\n/**\n * æ·»åŠ é‡è¯•æŒ‰é’®åˆ°é”™è¯¯æ¨¡æ€æ¡†\n */\nfunction addRetryButton() {\n  const errorModal = document.getElementById('error-modal');\n  if (!errorModal) return;\n  \n  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é‡è¯•æŒ‰é’®\n  if (errorModal.querySelector('.retry-button')) return;\n  \n  const retryButton = document.createElement('button');\n  retryButton.textContent = 'é‡è¯•è¿æ¥';\n  retryButton.className = 'retry-button';\n  retryButton.style.cssText = `\n    margin-left: 10px;\n    padding: 8px 16px;\n    background-color: #007bff;\n    color: white;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n  `;\n  \n  retryButton.onclick = async () => {\n    errorModal.style.display = 'none';\n    showFullscreenLoading();\n    \n    try {\n      await autoConnectDataset();\n    } catch (retryError) {\n      console.error('é‡è¯•å¤±è´¥:', retryError);\n    }\n  };\n  \n  // æ·»åŠ åˆ°é”™è¯¯æ¨¡æ€æ¡†çš„æŒ‰é’®åŒºåŸŸ\n  const buttonArea = errorModal.querySelector('.error-buttons') || errorModal;\n  buttonArea.appendChild(retryButton);\n}\n\n// ğŸ”§ NEW: Delete Plant Annotations Functionality\n\n/**\n * ğŸ”§ NEW: Setup deletion scope options in the modal\n */\nasync function setupDeletionScopeOptions(plantId) {\n  const modal = document.getElementById('delete-plant-annotations-modal');\n  const futureImagesInfo = document.getElementById('future-images-info');\n  const futureImagesCount = document.getElementById('future-images-count');\n  \n  // Reset deletion scope to default\n  const plantAllOption = modal.querySelector('input[name=\"deletion-scope\"][value=\"plant-all\"]');\n  if (plantAllOption) {\n    plantAllOption.checked = true;\n  }\n  \n  // Hide future images info initially\n  if (futureImagesInfo) {\n    futureImagesInfo.style.display = 'none';\n  }\n  \n  // Check if there's a current image context for spreading deletion\n  if (appState.currentImage && appState.currentPlant && appState.currentPlant.id === plantId) {\n    try {\n      // Get future images for spreading deletion\n      const futureImages = await getFutureImagesForClearing();\n      const futureCount = futureImages ? futureImages.length : 0;\n      \n      if (futureCount > 0) {\n        // Show future images info\n        if (futureImagesInfo && futureImagesCount) {\n          futureImagesCount.textContent = futureCount;\n          futureImagesInfo.style.display = 'block';\n        }\n        \n        // Enable current+future option\n        const currentFutureOption = modal.querySelector('input[name=\"deletion-scope\"][value=\"current-and-future\"]');\n        if (currentFutureOption) {\n          currentFutureOption.disabled = false;\n          currentFutureOption.parentElement.style.opacity = '1';\n        }\n        \n        // Enable current-only option\n        const currentOnlyOption = modal.querySelector('input[name=\"deletion-scope\"][value=\"current-only\"]');\n        if (currentOnlyOption) {\n          currentOnlyOption.disabled = false;\n          currentOnlyOption.parentElement.style.opacity = '1';\n        }\n      } else {\n        // Disable current+future option if no future images\n        disableScopeOption('current-and-future', 'No future images available');\n        disableScopeOption('current-only', 'Current image only (basic clear)');\n      }\n    } catch (error) {\n      console.warn('Failed to check future images for deletion scope:', error);\n      disableScopeOption('current-and-future', 'Cannot determine future images');\n      disableScopeOption('current-only', 'Current image context unavailable');\n    }\n  } else {\n    // No current image context - disable spreading options\n    disableScopeOption('current-and-future', 'No current image selected');\n    disableScopeOption('current-only', 'No current image selected');\n  }\n  \n  // Add event listener for scope changes\n  const scopeOptions = modal.querySelectorAll('input[name=\"deletion-scope\"]');\n  scopeOptions.forEach(option => {\n    option.addEventListener('change', handleDeletionScopeChange);\n  });\n}\n\n/**\n * ğŸ”§ NEW: Disable a deletion scope option with reason\n */\nfunction disableScopeOption(value, reason) {\n  const modal = document.getElementById('delete-plant-annotations-modal');\n  const option = modal.querySelector(`input[name=\"deletion-scope\"][value=\"${value}\"]`);\n  if (option) {\n    option.disabled = true;\n    option.parentElement.style.opacity = '0.5';\n    option.parentElement.title = reason;\n  }\n}\n\n/**\n * ğŸ”§ NEW: Handle deletion scope change\n */\nfunction handleDeletionScopeChange() {\n  const selectedScope = document.querySelector('input[name=\"deletion-scope\"]:checked');\n  const confirmCheckbox = document.getElementById('delete-confirmation-checkbox');\n  const confirmButton = document.getElementById('delete-confirm-btn');\n  \n  if (selectedScope) {\n    const scope = selectedScope.value;\n    \n    // Update confirmation text based on scope\n    const confirmText = confirmCheckbox.parentElement.querySelector('span');\n    if (confirmText) {\n      switch (scope) {\n        case 'plant-all':\n          confirmText.textContent = 'I understand that this action is irreversible and will delete all annotation data for this plant';\n          break;\n        case 'current-and-future':\n          confirmText.textContent = 'I understand that this action is irreversible and will delete current and future annotations';\n          break;\n        case 'current-only':\n          confirmText.textContent = 'I understand that this action is irreversible and will delete the current image annotations';\n          break;\n      }\n    }\n    \n    // Update button text based on scope\n    if (confirmButton) {\n      switch (scope) {\n        case 'plant-all':\n          confirmButton.textContent = 'ğŸ—‘ï¸ Delete All Plant Annotations';\n          break;\n        case 'current-and-future':\n          confirmButton.textContent = 'âš¡ Delete Current + Future';\n          break;\n        case 'current-only':\n          confirmButton.textContent = 'ğŸ—‘ï¸ Delete Current Image';\n          break;\n      }\n    }\n  }\n}\n\n/**\n * Handle delete plant annotations button click\n */\nasync function handleDeletePlantAnnotations() {\n  if (!appState.currentPlant) {\n    showError('åˆ é™¤å¤±è´¥', 'è¯·å…ˆé€‰æ‹©æ¤ç‰©');\n    return;\n  }\n  \n  console.log(`[Delete Plant] å¼€å§‹åˆ é™¤æ¤ç‰© ${appState.currentPlant.id} çš„æ ‡æ³¨`);\n  \n  // Show the confirmation modal and load statistics\n  await showDeletePlantAnnotationsModal(appState.currentPlant.id);\n}\n\n/**\n * Show delete plant annotations modal with statistics\n */\nasync function showDeletePlantAnnotationsModal(plantId) {\n  const modal = document.getElementById('delete-plant-annotations-modal');\n  const plantIdElement = document.getElementById('delete-plant-id');\n  const statsLoading = document.getElementById('stats-loading');\n  const statsContent = document.getElementById('stats-content');\n  const confirmCheckbox = document.getElementById('delete-confirmation-checkbox');\n  const confirmButton = document.getElementById('delete-confirm-btn');\n  \n  if (!modal) return;\n  \n  // Reset modal state\n  plantIdElement.textContent = plantId;\n  statsLoading.style.display = 'block';\n  statsContent.style.display = 'none';\n  confirmCheckbox.checked = false;\n  confirmButton.disabled = true;\n  \n  // ğŸ”§ NEW: Setup deletion scope options\n  setupDeletionScopeOptions(plantId);\n  \n  // Show modal\n  modal.style.display = 'flex';\n  \n  try {\n    // Load plant annotation statistics\n    console.log(`[Delete Plant] åŠ è½½æ¤ç‰© ${plantId} çš„ç»Ÿè®¡ä¿¡æ¯`);\n    const response = await fetch(`http://localhost:3003/api/annotations/plant/${plantId}/stats`);\n    const result = await response.json();\n    \n    if (result.success) {\n      // Update statistics display\n      document.getElementById('annotation-files-count').textContent = result.statistics.annotationFiles;\n      document.getElementById('annotation-points-count').textContent = result.statistics.totalAnnotationPoints;\n      document.getElementById('related-files-count').textContent = result.statistics.relatedFiles;\n      document.getElementById('total-files-count').textContent = result.statistics.totalFiles;\n      \n      // Show statistics\n      statsLoading.style.display = 'none';\n      statsContent.style.display = 'block';\n      \n      console.log(`[Delete Plant] ç»Ÿè®¡åŠ è½½å®Œæˆ: ${result.statistics.totalFiles} ä¸ªæ–‡ä»¶, ${result.statistics.totalAnnotationPoints} ä¸ªæ ‡æ³¨ç‚¹`);\n      \n      // Store statistics for later use\n      modal.dataset.plantStats = JSON.stringify(result.statistics);\n    } else {\n      throw new Error(result.error || 'è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');\n    }\n  } catch (error) {\n    console.error(`[Delete Plant] åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:`, error);\n    statsLoading.innerHTML = `<span style=\"color: #dc2626;\">âŒ åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${error.message}</span>`;\n  }\n}\n\n/**\n * Hide delete plant annotations modal\n */\nfunction hideDeletePlantAnnotationsModal() {\n  const modal = document.getElementById('delete-plant-annotations-modal');\n  if (modal) {\n    modal.style.display = 'none';\n    \n    // Reset modal state\n    const confirmCheckbox = document.getElementById('delete-confirmation-checkbox');\n    const confirmButton = document.getElementById('delete-confirm-btn');\n    if (confirmCheckbox) confirmCheckbox.checked = false;\n    if (confirmButton) {\n      confirmButton.disabled = true;\n      // ğŸ”§ FIX: Also restore button text to default when hiding modal\n      confirmButton.textContent = 'ğŸ—‘ï¸ Delete All Annotations';\n    }\n  }\n}\n\n/**\n * Handle confirmation checkbox change\n */\nfunction handleDeleteConfirmationChange() {\n  const confirmCheckbox = document.getElementById('delete-confirmation-checkbox');\n  const confirmButton = document.getElementById('delete-confirm-btn');\n  \n  if (confirmCheckbox && confirmButton) {\n    confirmButton.disabled = !confirmCheckbox.checked;\n  }\n}\n\n/**\n * Confirm and execute plant annotations deletion\n */\nasync function confirmDeletePlantAnnotations() {\n  if (!appState.currentPlant) {\n    showError('åˆ é™¤å¤±è´¥', 'æœªé€‰æ‹©æ¤ç‰©');\n    return;\n  }\n  \n  const plantId = appState.currentPlant.id;\n  const modal = document.getElementById('delete-plant-annotations-modal');\n  const confirmButton = document.getElementById('delete-confirm-btn');\n  \n  if (!modal || !confirmButton) return;\n  \n  // ğŸ”§ NEW: Get selected deletion scope\n  const selectedScope = modal.querySelector('input[name=\"deletion-scope\"]:checked');\n  const deletionScope = selectedScope ? selectedScope.value : 'plant-all';\n  \n  try {\n    // Show loading state\n    const originalText = confirmButton.textContent;\n    confirmButton.textContent = 'â³ Deleting...';\n    confirmButton.disabled = true;\n    \n    console.log(`[Delete Plant] å¼€å§‹åˆ é™¤æ¤ç‰© ${plantId} çš„æ ‡æ³¨ï¼ŒèŒƒå›´: ${deletionScope}`);\n    \n    let result;\n    \n    switch (deletionScope) {\n      case 'plant-all':\n        // Execute full plant deletion via API\n        result = await executeFullPlantDeletion(plantId);\n        break;\n        \n      case 'current-and-future':\n        // Execute spreading deletion\n        result = await executeSpreadingDeletion(plantId);\n        break;\n        \n      case 'current-only':\n        // Execute current image only deletion\n        result = await executeCurrentImageDeletion(plantId);\n        break;\n        \n      default:\n        throw new Error(`Unknown deletion scope: ${deletionScope}`);\n    }\n    \n    if (result.success) {\n      console.log(`[Delete Plant] åˆ é™¤æˆåŠŸ:`, result.statistics);\n      \n      // ğŸ”§ FIX: Restore button text before hiding modal\n      confirmButton.textContent = originalText;\n      \n      // Hide modal\n      hideDeletePlantAnnotationsModal();\n      \n      // Show success message with statistics\n      const stats = result.statistics;\n      const successMessage = createSuccessMessage(plantId, deletionScope, stats);\n      showSuccess('åˆ é™¤æˆåŠŸ', successMessage);\n      \n      // Update progress and UI\n      updateProgressInfo(`æ¤ç‰© ${plantId} çš„æ ‡æ³¨æ•°æ®å·²åˆ é™¤ (${deletionScope})`);\n      \n      // Handle UI updates based on deletion scope\n      await handlePostDeletionUpdates(plantId, deletionScope);\n      \n    } else {\n      throw new Error(result.error || 'åˆ é™¤æ“ä½œå¤±è´¥');\n    }\n    \n  } catch (error) {\n    console.error(`[Delete Plant] åˆ é™¤æ¤ç‰© ${plantId} å¤±è´¥:`, error);\n    \n    // Restore button state\n    confirmButton.textContent = originalText;\n    confirmButton.disabled = false;\n    \n    showError('åˆ é™¤å¤±è´¥', `åˆ é™¤æ¤ç‰© ${plantId} çš„æ ‡æ³¨æ•°æ®æ—¶å‡ºé”™: ${error.message}`);\n  }\n}\n\n/**\n * ğŸ”§ NEW: Execute full plant deletion via API\n */\nasync function executeFullPlantDeletion(plantId) {\n  const response = await fetch(`http://localhost:3003/api/annotations/plant/${plantId}`, {\n    method: 'DELETE',\n    headers: {\n      'Content-Type': 'application/json'\n    }\n  });\n  \n  return await response.json();\n}\n\n/**\n * ğŸ”§ NEW: Execute spreading deletion (current + future images)\n */\nasync function executeSpreadingDeletion(plantId) {\n  if (!appState.currentImage || !appState.currentPlant) {\n    throw new Error('No current image context for spreading deletion');\n  }\n  \n  try {\n    // Get future images\n    const futureImages = await getFutureImagesForClearing();\n    const allImages = [appState.currentImage, ...futureImages];\n    \n    let deletedCount = 0;\n    let errors = [];\n    \n    // Delete annotations for each image\n    for (const image of allImages) {\n      try {\n        // ğŸ”§ FIX: For current image, clear workspace FIRST to prevent auto-save interference\n        if (image.id === appState.currentImage.id && annotationTool) {\n          console.log(`[Spreading Delete] Clearing current image workspace: ${image.id}`);\n          annotationTool.clearKeypoints();\n          \n          // Update annotation status display immediately to reflect cleared state\n          if (typeof updateAnnotationStatusDisplay === 'function') {\n            setTimeout(updateAnnotationStatusDisplay, 100);\n          }\n        }\n        \n        // Clear annotation storage for this image\n        await clearAnnotationsForImage(image.id);\n        \n        deletedCount++;\n        updateProgressInfo(`å·²æ¸…é™¤ ${deletedCount}/${allImages.length} ä¸ªå›¾åƒ...`);\n      } catch (error) {\n        console.error(`Failed to clear image ${image.id}:`, error);\n        errors.push(`${image.id}: ${error.message}`);\n      }\n    }\n    \n    // Update thumbnails\n    if (window.refreshThumbnailAnnotationStatus) {\n      for (const image of allImages) {\n        await window.refreshThumbnailAnnotationStatus(image.id);\n      }\n    }\n    \n    return {\n      success: true,\n      statistics: {\n        totalFilesDeleted: deletedCount,\n        totalFilesProcessed: allImages.length,\n        annotationFilesDeleted: deletedCount,\n        relatedFilesDeleted: 0,\n        backupPath: 'N/A (in-memory operation)',\n        errors: errors\n      }\n    };\n    \n  } catch (error) {\n    console.error('Spreading deletion failed:', error);\n    return {\n      success: false,\n      error: error.message\n    };\n  }\n}\n\n/**\n * ğŸ”§ NEW: Execute current image only deletion\n */\nasync function executeCurrentImageDeletion(plantId) {\n  if (!appState.currentImage) {\n    throw new Error('No current image selected');\n  }\n  \n  try {\n    await clearAnnotationsForImage(appState.currentImage.id);\n    \n    // Update thumbnail\n    if (window.refreshThumbnailAnnotationStatus) {\n      await window.refreshThumbnailAnnotationStatus(appState.currentImage.id);\n    }\n    \n    // Clear from annotation tool\n    if (annotationTool) {\n      annotationTool.clearKeypoints();\n    }\n    \n    return {\n      success: true,\n      statistics: {\n        totalFilesDeleted: 1,\n        totalFilesProcessed: 1,\n        annotationFilesDeleted: 1,\n        relatedFilesDeleted: 0,\n        backupPath: 'N/A (single image operation)'\n      }\n    };\n    \n  } catch (error) {\n    console.error('Current image deletion failed:', error);\n    return {\n      success: false,\n      error: error.message\n    };\n  }\n}\n\n/**\n * ğŸ”§ NEW: Create success message based on deletion scope\n */\nfunction createSuccessMessage(plantId, deletionScope, stats) {\n  let message = `æ¤ç‰© ${plantId} çš„æ ‡æ³¨æ•°æ®åˆ é™¤å®Œæˆ\\n\\n`;\n  \n  switch (deletionScope) {\n    case 'plant-all':\n      message += `åˆ é™¤æ–‡ä»¶: ${stats.totalFilesDeleted}/${stats.totalFilesProcessed}\\n`;\n      message += `æ ‡æ³¨æ–‡ä»¶: ${stats.annotationFilesDeleted}\\n`;\n      message += `ç›¸å…³æ–‡ä»¶: ${stats.relatedFilesDeleted}\\n`;\n      if (stats.backupPath) {\n        message += `å¤‡ä»½å·²åˆ›å»º: ${stats.backupPath}`;\n      }\n      break;\n      \n    case 'current-and-future':\n      message += `ä¼ æ’­åˆ é™¤å®Œæˆ\\n`;\n      message += `å¤„ç†å›¾åƒ: ${stats.totalFilesDeleted}/${stats.totalFilesProcessed}\\n`;\n      if (stats.errors && stats.errors.length > 0) {\n        message += `é”™è¯¯: ${stats.errors.length} ä¸ªå›¾åƒåˆ é™¤å¤±è´¥`;\n      }\n      break;\n      \n    case 'current-only':\n      message += `å½“å‰å›¾åƒæ ‡æ³¨å·²æ¸…é™¤\\n`;\n      message += `å›¾åƒID: ${appState.currentImage?.id || 'unknown'}`;\n      break;\n  }\n  \n  return message;\n}\n\n/**\n * ğŸ”§ NEW: Handle post-deletion UI updates based on scope\n */\nasync function handlePostDeletionUpdates(plantId, deletionScope) {\n  switch (deletionScope) {\n    case 'plant-all':\n      // Clear current workspace if this was the current plant\n      if (appState.currentPlant && appState.currentPlant.id === plantId) {\n        initializeEmptyWorkspace();\n        \n        // Update plant status in the list\n        const plant = appState.plants.find(p => p.id === plantId);\n        if (plant) {\n          plant.status = 'pending'; // Reset to pending after deletion\n          \n          // Re-render the plant list item\n          const plantItem = document.querySelector(`[data-plant-id=\"${plantId}\"]`);\n          if (plantItem) {\n            const newItem = createPlantListItem(plant);\n            plantItem.parentNode.replaceChild(newItem, plantItem);\n          }\n        }\n      }\n      break;\n      \n    case 'current-and-future':\n    case 'current-only':\n      // Update annotation status display\n      if (typeof updateAnnotationStatusDisplay === 'function') {\n        await updateAnnotationStatusDisplay();\n      }\n      break;\n  }\n  \n  // Update statistics for all deletion scopes\n  if (typeof updateProgressStats === 'function') {\n    updateProgressStats();\n  }\n  \n  // Refresh note badges (since annotations are deleted, notes might be affected)\n  if (window.PlantAnnotationTool?.noteUI) {\n    await window.PlantAnnotationTool.noteUI.updateAllPlantNoteBadges();\n  }\n}\n\n/**\n * ğŸ”§ NEW: Update complete plant button state based on current plant selection\n */\nfunction updateCompletePlantButtonState() {\n  const completeButton = document.getElementById('complete-plant-btn');\n  if (!completeButton) return;\n  \n  if (appState.currentPlant) {\n    const plant = appState.currentPlant;\n    \n    if (plant.status === 'completed') {\n      // Show as uncomplete button\n      completeButton.textContent = 'Uncomplete Plant';\n      completeButton.className = 'btn btn-warning';\n      completeButton.title = `æ’¤é”€å®Œæˆæ¤æ ª ${plant.id}`;\n      completeButton.disabled = false;\n    } else if (plant.status === 'skipped') {\n      // Disable for skipped plants\n      completeButton.textContent = 'Complete Plant';\n      completeButton.className = 'btn btn-success';\n      completeButton.title = 'æ— æ³•å®Œæˆå·²è·³è¿‡çš„æ¤æ ªï¼Œè¯·å…ˆæ’¤é”€è·³è¿‡';\n      completeButton.disabled = true;\n    } else {\n      // Show as complete button (pending/in-progress)\n      completeButton.textContent = 'Complete Plant';\n      completeButton.className = 'btn btn-success';\n      completeButton.title = `æ ‡è®°æ¤æ ª ${plant.id} ä¸ºå®Œæˆ`;\n      completeButton.disabled = false;\n    }\n  } else {\n    // No plant selected\n    completeButton.textContent = 'Complete Plant';\n    completeButton.className = 'btn btn-success';\n    completeButton.title = 'è¯·å…ˆé€‰æ‹©æ¤ç‰©';\n    completeButton.disabled = true;\n  }\n}\n\n/**\n * Update delete button state based on current plant selection\n */\nfunction updateDeletePlantAnnotationsButtonState() {\n  const deleteButton = document.getElementById('delete-plant-annotations-btn');\n  if (!deleteButton) return;\n  \n  if (appState.currentPlant) {\n    deleteButton.disabled = false;\n    deleteButton.title = `åˆ é™¤æ¤ç‰© ${appState.currentPlant.id} çš„æ‰€æœ‰æ ‡æ³¨æ•°æ®`;\n  } else {\n    deleteButton.disabled = true;\n    deleteButton.title = 'è¯·å…ˆé€‰æ‹©æ¤ç‰©';\n  }\n}\n\n// å°†åˆ é™¤æŒ‰é’®çŠ¶æ€æ›´æ–°å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¾›å…¶ä»–æ¨¡å—è°ƒç”¨\nwindow.updateDeletePlantAnnotationsButtonState = updateDeletePlantAnnotationsButtonState;\n\n/**\n * ğŸ”§ SIMPLIFIED: Handle clear all annotations - simple current image only\n */\nasync function handleClearAllAnnotations() {\n  if (!annotationTool) {\n    showError('æ¸…é™¤å¤±è´¥', 'æ ‡æ³¨å·¥å…·æœªåˆå§‹åŒ–');\n    return;\n  }\n  \n  const currentAnnotations = annotationTool.getAnnotationData();\n  if (currentAnnotations.keypoints.length === 0) {\n    showError('æ¸…é™¤å¤±è´¥', 'å½“å‰å›¾åƒæ²¡æœ‰æ ‡æ³¨ç‚¹');\n    return;\n  }\n  \n  // Simple confirmation dialog without spreading options\n  const message = `ç¡®å®šè¦æ¸…é™¤å½“å‰å›¾åƒçš„ ${currentAnnotations.keypoints.length} ä¸ªæ ‡æ³¨ç‚¹å—ï¼Ÿ`;\n  \n  if (confirm(message)) {\n    // Clear current image only\n    annotationTool.clearKeypoints();\n    updateProgressInfo('å·²æ¸…é™¤å½“å‰å›¾åƒçš„æ ‡æ³¨');\n    \n    // Update thumbnail status\n    if (window.refreshThumbnailAnnotationStatus && appState.currentImage) {\n      await window.refreshThumbnailAnnotationStatus(appState.currentImage.id);\n    }\n    \n    // Update annotation status display\n    if (typeof updateAnnotationStatusDisplay === 'function') {\n      updateAnnotationStatusDisplay();\n    }\n  }\n}\n\n/**\n * ğŸ”§ NEW: Handle SIFT matching\n */\nasync function handleSiftMatch() {\n  if (!annotationTool) {\n    showError('SIFTåŒ¹é…å¤±è´¥', 'æ ‡æ³¨å·¥å…·æœªåˆå§‹åŒ–');\n    return;\n  }\n  \n  if (!appState.currentPlant) {\n    showError('SIFTåŒ¹é…å¤±è´¥', 'è¯·å…ˆé€‰æ‹©æ¤ç‰©');\n    return;\n  }\n  \n  // æ£€æŸ¥å½“å‰é€‰ä¸­çš„AnnotationTypeæ˜¯å¦ä¸ºbuiltin\n  let isBuiltinSelected = false;\n  if (annotationTool.customAnnotationManager) {\n    const currentMode = annotationTool.customAnnotationManager.currentMode;\n    const selectedTypeId = annotationTool.customAnnotationManager.selectedCustomType;\n    isBuiltinSelected = (currentMode === 'custom' && selectedTypeId === 'builtin-regular-keypoint');\n  }\n  \n  if (!isBuiltinSelected) {\n    showError('SIFTåŒ¹é…ä¸å¯ç”¨', 'SIFTåŒ¹é…ä»…æ”¯æŒRegular (Builtin)æ ‡æ³¨ï¼Œè¯·å…ˆé€‰æ‹©è¯¥ç±»å‹');\n    return;\n  }\n  \n  // ç¦ç”¨SIFTæŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»\n  const siftBtn = document.getElementById('sift-match-btn');\n  if (siftBtn) {\n    siftBtn.disabled = true;\n    siftBtn.textContent = 'â³';\n  }\n  \n  try {\n    console.log('[SIFT] å¼€å§‹æ‰§è¡ŒSIFTåŒ¹é…');\n    \n    // è°ƒç”¨AnnotationToolçš„SIFTåŒ¹é…åŠŸèƒ½\n    await annotationTool.performSiftMatching();\n    \n  } catch (error) {\n    console.error('[SIFT] åŒ¹é…å¤±è´¥:', error);\n    showError('SIFTåŒ¹é…å¤±è´¥', error.message || 'æ‰§è¡ŒSIFTåŒ¹é…æ—¶å‘ç”Ÿé”™è¯¯');\n  } finally {\n    // æ¢å¤SIFTæŒ‰é’®çŠ¶æ€\n    if (siftBtn) {\n      siftBtn.disabled = false;\n      siftBtn.textContent = 'ğŸ”';\n    }\n  }\n}\n\n/**\n * æ›´æ–°SIFTæŒ‰é’®çŠ¶æ€\n */\nfunction updateSiftButtonState() {\n  const siftBtn = document.getElementById('sift-match-btn');\n  if (!siftBtn || !annotationTool) return;\n  \n  // æ£€æŸ¥å½“å‰é€‰ä¸­çš„AnnotationTypeæ˜¯å¦ä¸ºbuiltin\n  let isBuiltinSelected = false;\n  if (annotationTool.customAnnotationManager) {\n    const currentMode = annotationTool.customAnnotationManager.currentMode;\n    const selectedTypeId = annotationTool.customAnnotationManager.selectedCustomType;\n    isBuiltinSelected = (currentMode === 'custom' && selectedTypeId === 'builtin-regular-keypoint');\n  }\n  \n  // æ›´æ–°æŒ‰é’®çŠ¶æ€\n  siftBtn.disabled = !isBuiltinSelected;\n  siftBtn.style.opacity = isBuiltinSelected ? '1' : '0.5';\n  siftBtn.style.cursor = isBuiltinSelected ? 'pointer' : 'not-allowed';\n  siftBtn.title = isBuiltinSelected ? \n    'SIFTå¿«æ·åŒ¹é… (Shift+S)' : \n    'SIFTåŒ¹é…ä»…æ”¯æŒRegular (Builtin)æ ‡æ³¨ï¼Œè¯·å…ˆé€‰æ‹©è¯¥ç±»å‹';\n}\n\n// æš´éœ²åˆ°windowå¯¹è±¡ä¾›å…¶ä»–æ¨¡å—è°ƒç”¨\nwindow.updateSiftButtonState = updateSiftButtonState;\n\n/**\n * ğŸ”§ REMOVED: Handle spreading clear (Shift+Click) \n * This functionality has been moved to delete-plant-annotations-btn\n * to avoid duplication and user confusion.\n */\n// async function handleSpreadingClear() { ... } - REMOVED\n\n/**\n * ğŸ”§ NEW: Get future images for clearing (simplified version)\n */\nasync function getFutureImagesForClearing() {\n  if (!appState.currentImage || !appState.currentPlant || !plantDataManager) {\n    return [];\n  }\n  \n  try {\n    // Get all images for current plant and view angle\n    const allImages = await plantDataManager.getPlantImages(\n      appState.currentPlant.id, \n      appState.currentPlant.selectedViewAngle\n    );\n    \n    if (!allImages || allImages.length === 0) {\n      return [];\n    }\n    \n    // Find current image index\n    const currentImageIndex = allImages.findIndex(img => img.id === appState.currentImage.id);\n    if (currentImageIndex === -1) {\n      return [];\n    }\n    \n    // Get current image date for comparison\n    const currentImage = allImages[currentImageIndex];\n    const currentDate = new Date(currentImage.dateTime);\n    \n    // Filter future images (images with later dates)\n    const futureImages = allImages.filter(img => {\n      const imgDate = new Date(img.dateTime);\n      return imgDate > currentDate;\n    });\n    \n    // Sort by date\n    futureImages.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));\n    \n    return futureImages;\n    \n  } catch (error) {\n    console.error('Failed to get future images:', error);\n    return [];\n  }\n}\n\n/**\n * ğŸ”§ NEW: Clear annotations for a specific image\n */\nasync function clearAnnotationsForImage(imageId) {\n  if (!plantDataManager) {\n    throw new Error('PlantDataManager not available');\n  }\n  \n  try {\n    // Save empty annotations (effectively clearing them)\n    await plantDataManager.saveImageAnnotations(imageId, []);\n    console.log(`Cleared annotations for image: ${imageId}`);\n  } catch (error) {\n    console.error(`Failed to clear annotations for image ${imageId}:`, error);\n    throw error;\n  }\n}\n\n/**\n * ğŸ”§ NEW: Perform clear operation with optional spreading\n */\nasync function performClearOperation(options) {\n  if (!annotationTool || !appState.currentImage || !appState.currentPlant) {\n    showError('æ¸…é™¤å¤±è´¥', 'åº”ç”¨çŠ¶æ€æ— æ•ˆ');\n    return;\n  }\n  \n  const { clearScope, clearAllPoints, clearAnnotationsOnly } = options;\n  \n  try {\n    // Always clear current image first\n    console.log('Clearing annotations for current image:', appState.currentImage.id);\n    \n    if (clearAllPoints) {\n      annotationTool.clearKeypoints();\n    } else if (clearAnnotationsOnly) {\n      // Clear only annotations but preserve UI state\n      annotationTool.clearKeypointsWithoutSave();\n    }\n    \n    let processedImages = 1; // Current image\n    let affectedImages = [appState.currentImage.id];\n    \n    // If spreading deletion is requested\n    if (clearScope === 'current-and-future' && annotationSpreadingManager) {\n      // Show progress modal\n      const progressModalId = spreadingModalManager.showSpreadProgress({\n        operationId: `clear-spread-${Date.now()}`,\n        totalImages: 0, // Will be updated\n        onCancel: () => {\n          console.log('User cancelled clear spreading operation');\n        }\n      });\n      \n      try {\n        // Get future images\n        const futureImages = await annotationSpreadingManager.getFutureImages(\n          appState.currentImage.id,\n          appState.currentPlant.id,\n          appState.currentPlant.selectedViewAngle\n        );\n        \n        if (futureImages.length > 0) {\n          // Update progress modal with actual count\n          spreadingModalManager.updateSpreadProgress(progressModalId, {\n            completed: 1,\n            total: futureImages.length + 1,\n            status: 'Clearing future images...'\n          });\n          \n          // Perform spreading deletion\n          const result = await annotationSpreadingManager.spreadDeletionToFuture(\n            appState.currentImage.id,\n            appState.currentPlant.id,\n            appState.currentPlant.selectedViewAngle,\n            {\n              clearAllPoints,\n              clearAnnotationsOnly,\n              batchSize: spreadingConfigManager?.getConfigValue('spreadBehavior.batchSize') || 10,\n              onProgress: (progress) => {\n                spreadingModalManager.updateSpreadProgress(progressModalId, {\n                  ...progress,\n                  completed: progress.completed + 1, // +1 for current image already processed\n                  total: futureImages.length + 1\n                });\n              }\n            }\n          );\n          \n          processedImages += result.processedImages || 0;\n          affectedImages = affectedImages.concat(result.affectedImages || []);\n        }\n        \n        // Close progress modal\n        spreadingModalManager.closeModal(progressModalId);\n        \n      } catch (error) {\n        console.error('Spreading deletion failed:', error);\n        spreadingModalManager.closeModal(progressModalId);\n        spreadingModalManager.showError(\n          'Spreading Deletion Failed',\n          `Failed to clear annotations from future images: ${error.message}`\n        );\n      }\n    }\n    \n    // Show success message\n    const message = clearScope === 'current-and-future' \n      ? `æˆåŠŸæ¸…é™¤ ${processedImages} ä¸ªå›¾åƒçš„æ ‡æ³¨`\n      : 'æˆåŠŸæ¸…é™¤å½“å‰å›¾åƒçš„æ ‡æ³¨';\n    \n    updateProgressInfo(message);\n    \n    // Refresh thumbnails for affected images\n    if (affectedImages.length > 0) {\n      for (const imageId of affectedImages) {\n        await refreshThumbnailAnnotationStatus(imageId);\n      }\n    }\n    \n    // Update statistics\n    updateProgressStats();\n    \n    // Update annotation status display\n    updateAnnotationStatusDisplay();\n    \n    console.log(`Clear operation completed. Processed ${processedImages} images.`);\n    \n    // Show success modal for spreading operations\n    if (clearScope === 'current-and-future' && processedImages > 1) {\n      spreadingModalManager.showSuccess(\n        'Clear Complete',\n        `Successfully cleared annotations from ${processedImages} images in the time series.`\n      );\n    }\n    \n  } catch (error) {\n    console.error('Clear operation failed:', error);\n    showError('æ¸…é™¤å¤±è´¥', `æ¸…é™¤æ ‡æ³¨æ—¶å‡ºé”™: ${error.message}`);\n  }\n}"],"names":["HttpFileSystemManager","constructor","this","baseUrl","datasetPath","isInitialized","maxRetries","retryDelay","connectionTimeout","lastConnectionCheck","connectionCheckInterval","initialize","withRetry","async","controller","AbortController","timeoutId","setTimeout","abort","response","fetch","signal","headers","clearTimeout","ok","Error","status","statusText","json","success","Date","now","console","log","error","name","isSupported","operation","operationName","lastError","attempt","delay","isConnectionError","warn","message","includes","ms","Promise","resolve","checkConnection","isConnected","getDatasetInfo","ensureConnection","result","data","traversePlantDirectories","length","readPlantImages","plantId","encodeURIComponent","imagesByView","totalImages","Object","values","reduce","total","images","getImageUrl","viewAngle","imageName","createImageURL","imageData","parts","id","split","slice","join","imageUrl","saveAnnotationFile","imageId","annotationData","method","body","JSON","stringify","loadAnnotationFile","annotations","getAllAnnotationFiles","deleteAnnotationFile","getDirectoryStats","dirPath","url","isImageFile","filename","ext","toLowerCase","substring","lastIndexOf","parseImageDateTime","match","dateStr","hourStr","formatImageTime","date","getFullYear","getMonth","getDate","getAllSkipInfo","getSkipInfo","saveSkipInfo","skipData","deleteSkipInfo","getPlantStatus","savePlantStatus","lastModified","toISOString","deletePlantStatus","cleanup","getAnnotationsDirectory","exists","ensureAnnotationsDirectory","AnnotationStorageManager","apiBaseUrl","Map","imageAnnotations","fileSystemManager","useFileSystem","setFileSystemManager","annotationsHandle","scanAnnotationFiles","loadAnnotationsFromServer","loadImageAnnotationsFromServer","serverError","loadFromLocalStorage","loadImageAnnotationsFromLocalStorage","entries","set","size","saveAnnotationsToServer","exportData","saveTime","totalPlants","saveToLocalStorage","localStorage","setItem","backup","getItem","parse","has","savePlantAnnotations","plantInfo","selectedImage","selectedImagePath","selectedViewAngle","imageDateTime","dateTime","keypointCount","timeSeriesData","isTimeSeriesEnabled","plantViewAngles","selectedViewAngleHistory","timeSeriesMetadata","getPlantAnnotations","get","getAnnotatedPlantIds","Array","from","keys","skipInfo","createdAt","skipReason","skipDate","apiError","fileName","fileHandle","getFileHandle","create","writable","createWritable","write","close","fsError","removeSkipInfo","delete","removeEntry","removeError","statusData","timestamp","loadPlantStatus","existingData","skipError","file","getFile","content","text","localData","parsed","localError","hasAnnotations","deletePlantAnnotations","getAnnotationStats","annotatedCount","completedCount","filter","annotated","completed","pending","completionRate","toFixed","exportAllAnnotations","exportTime","version","exportedAt","downloadAnnotationsAsJSON","blob","Blob","type","URL","createObjectURL","a","document","createElement","href","download","appendChild","click","removeChild","revokeObjectURL","exportPureImageAnnotations","pureImageAnnotations","map","annotation","x","y","direction","order","downloadPureImageAnnotationsAsJSON","pureAnnotations","stats","getPureAnnotationsStats","format","description","annotatedImages","totalKeypoints","averageKeypointsPerImage","setTimeSeriesManager","timeSeriesManager","clearAllAnnotations","clear","getSummary","summary","totalAnnotations","completedPlants","restoreTimeSeriesData","restorePlantTimeSeriesData","timeSequences","timeSeriesAnnotations","imageIds","item","viewAnnotations","metadata","isManualAdjustment","inheritedFrom","adjustmentKey","manualAdjustments","Set","add","getPlantViewAngleHistory","getPlantAnnotationSummary","availableViewAngles","currentImageInfo","timeSeriesStats","saveImageAnnotation","saveImageAnnotationToFileSystem","saveImageAnnotationsToLocalStorage","getImageAnnotation","exportAllImageAnnotations","getImageAnnotationStats","loadAnnotationsFromFileSystem","loadedCount","deleteImageAnnotationFromFileSystem","scanSkipInfoFiles","skipInfoData","skipFileCount","handle","kind","endsWith","TimeSeriesAnnotationManager","initializePlantTimeSeries","sort","b","img","firstImageId","lastImageId","saveAnnotations","plantAnnotations","timeSequence","currentImageIndex","indexOf","propagateAnnotations","savedImageId","propagatedCount","getPropagationCount","isFirstAnnotation","sourceImageId","sourceImageIndex","i","targetImageId","deepCloneAnnotations","getAnnotations","getAnnotationMetadata","imageIndex","isFirstImage","isLastImage","fromIndex","count","manual","inherited","coverage","clearPlantAnnotations","exportTimeSeriesData","push","allImageAnnotations","plantData","exportPlantImageAnnotations","plantImageAnnotations","getExportStats","plantStats","plantImages","plantAnnotatedImages","plantKeypoints","getDebugStatus","plantsCount","totalSequences","totalAnnotatedImages","plantDetails","plantDetail","viewAnglesCount","viewAngles","exportAllTimeSeriesDataDebug","debugData","managedPlants","allData","annotationCount","PlantDataManager","annotationStorage","plants","annotationStatus","loadingPlants","loadDataset","plantFolders","plantFolder","plant","createPlantData","restoreAnnotationStatus","localeCompare","restoreAnnotationStatusFromFileSystem","annotatedPlantIds","bulkAnnotationData","window","PlantAnnotationTool","annotationManager","getAllAnnotationsInBulk","restoreStatusFromBulkData","restoreStatusFromIndividualFiles","bulkData","startTime","performance","imageAnnotationsMap","plantAnnotationsMap","viewAngleStats","viewAnnotationCount","image","persistedStatus","endTime","allAnnotationFiles","annotationFileSet","path","imageCount","hasImages","loadedAt","loadPlantImageCount","view","emitPlantUpdated","getPlantList","getPlant","getPlantImages","checkLoading","updatePlantStatus","then","catch","skipPlant","reason","unskipPlant","newStatus","uncompletePlant","setSelectedViewAngle","setSelectedImage","initializeTimeSeriesIfNeeded","seriesInfo","options","currentImageId","findIndex","savedCount","saveAnnotationToFile","directionInfo","saveDirectionsOnly","finalAnnotations","mergeDirectionData","existingAnnotations","newAnnotations","merged","forEach","newAnnotation","existingIndex","existing","directionType","saveImageAnnotations","currentPlantId","appState","currentPlant","getCurrentPlantIdFromImage","getImageAnnotations","getCurrentImageAnnotationMetadata","getPlantTimeSeriesStats","shouldShowManualAdjustmentMode","getNextPendingPlant","find","currentIndex","getDetailedImageStats","completedImages","plantImageCount","plantStat","isCompleted","plantCompletionRate","pendingImages","getImageStats","detailed","getProgress","persistentStats","inProgress","skipped","totalCompleted","imageStats","Math","max","persistent","searchPlants","query","lowerQuery","filterPlantsByStatus","event","CustomEvent","detail","dispatchEvent","pureFormat","timeSeriesFormat","recommendation","debugTimeSeriesExport","timeSeriesStatus","storageAnnotations","comparison","timeSeriesManagerImages","pureExportImages","storageManagerPlants","storageData","saveAnnotationStatus","storageKey","savedData","savedAt","loadAnnotationStatus","saved","ensureAnnotationOrders","annotationsByType","annotationType","customTypeId","typeKey","totalFixed","typeAnnotations","hasOrderIssues","orders","kp","AnnotationTool","canvasId","canvas","getElementById","ctx","getContext","minZoom","maxZoom","zoomSpeed","baseKeypointRadius","minKeypointRadius","maxKeypointRadius","keypointScaleFactor","keypointLeftColor","keypointRightColor","keypointHoverColor","keypointSelectedColor","keypointBorderColor","keypointBorderWidth","labelThresholdScale","tinyThresholdScale","labelOffset","directionThreshold","directionArrowLength","state","scale","translateX","translateY","isDragging","isPanning","lastPanPoint","isDirectionDragging","dragStartPoint","currentDragPoint","previewKeypoint","selectedKeypoint","isDirectionSelectionMode","directionSelectionPoint","isAutoDirectionMode","autoDirectionIndex","autoDirectionKeypoints","isDirectionCountMode","currentDirectionCount","directionsSet","autoMoveToExpectedPosition","isCustomRegionDragging","customRegionStartPoint","customRegionCurrentPoint","isAutoOrderMode","autoOrderTypeId","autoOrderCurrentOrder","autoOrderImages","autoOrderCurrentImageIndex","isUnorderedMode","currentImage","imageElement","imageLoaded","keypoints","hoveredKeypoint","draggedKeypoint","history","historyIndex","maxHistorySize","customAnnotationManager","customAnnotationRenderer","customAnnotationDragState","draggedAnnotation","startPosition","imageSwitchLock","isLocked","currentLoadingImageId","lockStartTime","autoDirectionMode","crossSectionalState","crossSectionalMap","bindEvents","initializeCanvas","initializeCustomAnnotationSystem","initializeAutoDirectionModeFromUI","modeSelector","value","resizeState","isResizing","lastResizeTime","debounceTimeout","dimensionsHistory","resizeCanvasWithRetry","style","cursor","addEventListener","debouncedResize","retryCount","rect","parentElement","getBoundingClientRect","width","height","render","resizeCanvas","debug","currentDimensions","recent","d","shift","fittingToScreen","safeFitToScreen","e","handleMouseDown","handleMouseMove","handleMouseUp","handleContextMenu","handleWheel","passive","handleKeyDown","handleKeyUp","preventDefault","loadImage","preserveView","setImageSwitchLock","interruptAllDirectionModes","plantDataManager","imageURL","Image","crossOrigin","reject","onload","onerror","src","fitToScreen","canvasWidth","canvasHeight","imageWidth","imageHeight","scaleX","scaleY","min","newScale","scaleChange","abs","updateZoomInfo","resetView","clearImage","clearKeypointsWithoutSave","clearKeypointLabels","clearRect","save","translate","drawImage","restore","calibrationPreviewState","isActive","renderCalibrationPreview","renderKeypoints","renderCustomAnnotations","renderPlaceholder","centerX","centerY","fillStyle","fillRect","font","textAlign","fillText","displayStrategy","getKeypointDisplayStrategy","keypoint","index","screenPos","imageToScreen","renderCustomKeypoint","fallback","previewPos","fillColor","globalAlpha","renderSingleKeypoint","renderDragIndicator","renderCustomRegionPreview","renderDirectionSelectionGuide","updateZoomIndicator","updateAnnotationSizeInfo","renderRegularKeypoint","isHovered","displayOrder","ensureMultiDirectionSupport","directions","renderMultipleDirections","renderDirectionIndicator","customType","getCustomType","isSelected","alpha","strokeWidth","borderWidth","renderCustomRegion","renderCustomPoint","selectedAnnotation","radius","beginPath","arc","PI","color","fill","strokeStyle","lineWidth","stroke","showInternalLabel","undefined","fontSize","textBaseline","toString","showExternalLabel","renderCustomPointLabel","isDirectional","renderParentLinkIfAny","bottomRightScreen","screenWidth","screenHeight","strokeRect","renderCustomRegionLabel","centerKeypoint","centerImageX","centerImageY","renderRegionResizeHandles","handleSize","half","corners","edges","pt","getRegionHandleAt","mousePos","topLeft","bottomRight","hit","originX","originY","parentAnnotationType","parentAnnotationId","parentTypeId","parentOrder","parent","fromX","fromY","toX","toY","to","setLineDash","moveTo","lineTo","labelY","labelText","textWidth","measureText","padding","startScreenPos","currentScreenPos","getCurrentCustomType","left","top","sizeText","round","label","strategy","createExternalLabel","showMinimalMode","createTooltip","startX","startY","currentX","currentY","deltaX","sqrt","midX","midY","imageX","imageY","screenToImage","screenX","screenY","getMousePos","clientX","clientY","getVisibleImageBounds","imageLeft","imageTop","visibleBounds","right","bottom","imageRight","imageBottom","random","imageSize","canvasSize","isPointInVisibleImage","bounds","isImageCoordinateValid","canCreateAnnotationAt","imagePos","canAnnotateAtSilent","debugBoundsAt","inVisibleArea","validCoords","finalResult","button","target","tagName","isTrusted","eventPhase","bubbles","cancelable","stackTrace","stack","shiftKey","metaKey","ctrlKey","clickedCustomAnnotation","getCustomAnnotationAt","isRegion","handleCustomAnnotationClick","startCustomAnnotationDrag","setCustomAnnotationMode","setSelectedAnnotation","clickedKeypoint","getKeypointAt","handleDirectionSelection","showError","isInCustomMode","handleCustomAnnotationMode","blankAreaClickStart","mouseDownTime","wasDraggedDuringSession","isSelectingParent","parentSelectionForType","childTypeId","childType","associateTypeId","selectedChild","bindParentForOrderAcrossImages","showSuccess","clearAllSelections","expectedParentType","disableParentSelectionMode","isSameKeypoint","pauseAutoDirectionMode","cancelDirectionSelection","handleMiddleMouseButton","deltaY","notifyDraggedKeypointPreview","updateCustomAnnotationDrag","pow","startDirectionAnnotation","updateDirectionDragging","updateCustomRegionDrag","directionCursor","keypointScreen","hoveredCustomAnnotation","setHoveredAnnotation","newCursor","startPos","distance","currentTime","timeSinceMouseDown","wasDragged","selectKeypointForDirection","saveState","autoSaveCurrentImage","triggerRealTimeSync","restoreNormalPreview","currentType","addKeypointWithDirection","createNoDirectionKeypoint","finishCustomAnnotationDrag","finishDirectionAnnotation","finishCustomRegionDrag","defaultAngle","addCustomPointAnnotation","startUnifiedCustomRegionDrag","selectKeypoint","currentDirection","notifySelectedKeypointPreview","getIsDirectionalForKeypoint","handleKeypointClick","currentSelectedKeypoint","angle","atan2","normalizedAngle","clickData","keypointBefore","maxDirections","clickPosition","addDirectionToKeypoint","showMultiDirectionProgress","finishMultiDirectionSetting","oldDirection","directionClick","keypointId","newDirection","keypointAfter","handleCrossSectionalDirectionSet","selectNextAutoDirectionKeypoint","justCreatedNewPoint","moveToNextExpectedPosition","processCurrentCrossSectionalPoint","processedCount","totalCount","completeCrossSectionalMode","advanceCrossSectionalProgress","advanceError","exitAutoDirectionMode","forceExit","wasInDirectionMode","isAutoMode","startAutoDirectionMode","t","startCrossSectionalMode","resetAutoDirectionButton","startLongitudinalMode","buildCrossSectionalMap","showInfo","initializeCrossSectionalState","updateAutoDirectionModeUI","currentPoint","getCurrentCrossSectionalPoint","switchToImageForCrossSectional","updateCrossSectionalProgressUI","availableOrders","needDirectionKeypoints","isLegacy","isNoDirection","selectKeypointWithZoom","isDirectionMode","currentScale","targetScale","constrainView","scaleAction","showKeypointFocusHint","bind","pulseCount","pulse","maxTranslateX","minTranslateX","maxTranslateY","minTranslateY","totalUpgraded","tryAutoSwitchToNextImage","nextKeypoint","progress","showAutoModeCompletionHint","hint","className","textContent","cssText","head","canvasContainer","remove","setAutoDirectionMode","mode","autoDirectionBtn","classList","modeText","allImages","directionlessAnnotations","ann","imageAnnotationPairs","getAvailableOrderNumbers","getImagesWithOrder","currentOrder","getAllCrossSectionalPoints","allPoints","imagesWithCurrentOrder","allAnnotations","nextImageData","currentOrderIndex","nextOrder","nextOrderImages","targetImage","handleImageSelect","waitForImageLoad","loadedAnnotation","maxWaitTime","duration","updateProgressInfo","progressIndicator","progressCurrent","progressTotal","progressFill","progressModeInfo","display","progressPercentage","getAutoDirectionProgress","percentage","totalOrders","userModePreference","startAutoOrderMode","typeId","unorderedAnnotations","getAllUnorderedAnnotationsOfType","navigateToFirstImageWithType","imageGroups","groupAnnotationsByImage","updateAutoOrderButton","updateAutoOrderStatus","getTypeName","navigateToImageWithBuiltinOrder","stopAutoOrderMode","handleAutoOrderAnnotationClick","saveCurrentImageAnnotations","syncOrderAcrossImages","proceedToNextOrder","navigateToNextImageInAutoOrder","skipCurrentImageInAutoOrder","navigateToNextUnorderedImage","branchPointPreviewManager","showSpecificOrderPreview","removeCustomAnnotation","removeKeypoint","clearSelection","handleScrollWheel","zoomFactor","zoomAt","factor","key","activeElement","setZoom","redo","undo","selected","associateId","enableParentSelectionMode","parentTypeName","zoomElement","threshold","addKeypoint","findNextAvailableOrderForType","findNextAvailableOrder","normalizedDirection","syncBranchPointPreview","typeDesc","directionDesc","addCustomRegionAnnotation","customTypes","setCustomTypes","handleUnifiedCustomAnnotationMode","customRegionTypeId","finishUnifiedCustomRegionDrag","resetCustomRegionDrag","endPos","startScreen","currentScreen","sameTypeKeypoints","existingOrders","regularKeypoints","removed","splice","clearKeypoints","reorderKeypoints","getAnnotationData","imageInfo","viewState","loadAnnotationData","ensureKeypointOrders","typeHasIssues","destroy","startsWith","resetDirectionDragging","actualRadius","textBasedRadius","maxRadiusForLargeScale","directionFontSize","container","labelElement","dataset","containerRect","offsetX","offsetY","labelOffsetY","existingTooltip","querySelector","tooltip","directionText","coordinateText","innerHTML","querySelectorAll","indicator","sizeInfo","currentKeypointCount","updateContext","validateCurrentImageConsistency","expectedImageId","isConsistent","refreshFunction","refreshThumbnailAnnotationStatus","refreshError","operationType","previousPosition","realTimeSyncManager","isRealTimeSyncEnabled","keypointInfo","isCustom","createSyncData","context","triggerCustomAnnotationSync","updateSyncData","positionChange","deleteSyncData","triggerKeypointAddSync","triggerKeypointMoveSync","triggerKeypointDeleteSync","triggerDirectionEditSync","angleDegrees","renderDirectionArrow","angleRadians","arrowLength","endX","cos","endY","sin","lineCap","headAngle1","headAngle2","textX","textY","textHeight","guideX","guideY","angleText","upgradeLegacyDirections","upgraded","setAutoMoveToExpectedPosition","enabled","getTargetScale","getZoomLockSettings","zoomSettings","lockValue","moveToHighestKeypoint","highestKeypoint","highest","current","moveToExpectedPosition","isImageSwitch","handleImageSwitchAutoMove","newImageAnnotations","moveToPosition1","some","moveToAnnotationsCenter","position1","getExpectedPosition","sumX","sumY","centerX_img","centerY_img","expectedPosition","navigateToNextImage","restartAutoDirectionMode","rightArrowEvent","stopPropagation","_pauseHandler","removeEventListener","handleAutoDirectionSelection","remaining","startDrag","updateDrag","finishDrag","moved","saveToStorage","triggerEvent","triggerCustomAnnotationUpdateSync","getAppState","cancelCustomAnnotationDrag","cancelDrag","childOrder","syncCount","skipCount","child","CustomAnnotationManager","__vitePreload","module","import","setRealTimeSyncManager","updateSiftButtonState","CustomAnnotationRenderer","customAnnotationSystemReady","onCustomAnnotationSystemReady","customAnnotation","startCustomRegionDrag","currentCustomType","getCustomAnnotationManager","getCustomAnnotationRenderer","candidate","exitDirectionCountMode","enterDirectionCountMode","showDirectionCountPrompt","hideDirectionCountPrompt","startMultiDirectionSetting","newCount","updateDirectionCountDisplay","prompt","actualDirections","progressPrompt","hideMultiDirectionProgress","removeDirectionFromKeypoint","removedDirection","isComplete","interruptDirectionCountMode","interruptMultiDirectionSetting","canHaveMultipleDirections","enhanceDirectionData","clickX","clickY","enhanceMultiDirectionData","clickDataArray","enhancedDirections","handleDirectionSelectionClick","screenCoords","getEventCoordinates","imageCoords","validateDirectionClick","calculateAngleFromClick","isClickWithinImageBounds","isClickWithinCanvasBounds","handleMultiDirectionClick","serializeAnnotationData","deserializeAnnotationData","performSiftMatching","validation","validateMatchingPreconditions","isValid","errors","showSiftError","currentAnnotations","allPreviousAnnotations","getPreviousFrameAnnotations","previousAnnotations","currentImageData","getCurrentImageData","previousImageData","getPreviousImageData","SiftMatcher","siftMatcher","calibratedAnnotations","calibrateAnnotations","quality","calculateMatchingQuality","åŸå§‹æ ‡æ³¨","æ ¡å‡†æ ‡æ³¨","å¹³å‡ç½®ä¿¡åº¦","averageConfidence","å¹³å‡åç§»","averageOffset","æˆåŠŸåŒ¹é…","successfulMatches","showCalibrationPreview","hasPreviousFrame","hasCurrentImage","hasPreviousImage","hasCurrentAnnotations","hasPreviousAnnotations","hasPreviousFrameAnnotations","getPreviousFrameId","previousFrameId","complete","tempCanvas","tempCtx","getImageData","previousImage","originalAnnotations","showOriginal","showCalibrated","showArrows","showNonBlockingNotification","bindCalibrationKeyboardEvents","notification","qualityScore","acceptBtn","rejectBtn","applyCalibrationResults","cancelCalibration","calibrationNotification","notificationTimeout","calibrationKeyboardHandler","toggleCalibrationPreview","cleanupCalibrationPreview","autoSave","showSiftSuccess","showSiftInfo","title","alert","createMatchingVisualizations","visualizations","calibrationData","originalX","originalY","offset","renderCalibrationPoint","originalPos","calibratedPos","renderCalibrationArrow","x1","y1","x2","y2","dx","dy","headAngle","hasOrder","hasOwnProperty","isTargetType","groups","btn","btnFound","statusElement","statusFound","fontWeight","navigateToImageForAutoOrder","completeAutoOrder","typeName","getCurrentPlant","currentViewAngle","getCurrentViewAngle","getAllImagesForPlantAndView","getAnnotationsForImage","updated","areAnnotationsSimilarPosition","saveAnnotationsForImage","ann1","ann2","shouldSwitchToNextImageInAutoOrder","currentTypeId","advanceToNextOrderNumber","navigateToFirstImageOfCurrentType","navigateToAbsoluteFirst","thumbnailContainer","thumbnails","thumbnail","getAttribute","checkImageHasType","attempts","goToPrevious","navigateToPreviousImage","navigateToFirstImageWithUnorderedAnnotations","navigateToBeginningThenFindUnordered","findFirstUnorderedFromCurrent","searchAndNavigateToBuiltinOrder","checkImageHasBuiltinOrder","annotationError","navigateToBeginningThenFindBuiltinOrder","findBuiltinOrderFromCurrent","BranchPointPreviewManager","previewWindow","previewCanvas","previewCtx","previewTitle","previewLoading","noPreview","zoomSlider","zoomValue","isVisible","dragStartX","dragStartY","windowStartX","windowStartY","zoomLevel","isShowingSpecificOrder","specificTargetOrder","cachedImageElement","initializeElements","updateCanvasSize","resizeObserver","ResizeObserver","renderPreview","observe","bindZoomControls","bindDragEvents","renderCachedPreview","getNextOrderToAnnotate","targetAnnotation","showNoPreview","baseCropSize","cropSize","cropX","cropY","actualCropWidth","actualCropHeight","pointX","pointY","renderLocalizedAnnotation","otherX","otherY","renderZoomInfo","header","drag","endDrag","userSelect","newX","newY","maxX","innerWidth","offsetWidth","maxY","innerHeight","offsetHeight","constrainedX","constrainedY","setPlantDataManager","toggleVisibility","show","updatePreview","showLoading","getPreviousImage","updatePreviewTitle","timeString","annotationTool","fallbackOrder","previewMessage","hideLoading","hideNoPreview","File","handleError","isTarget","annotationWidth","annotationHeight","rectWidth","rectHeight","rectX","rectY","headLength","zoomText","highlightCorrespondingPoints","targetOrder","sourceImage","reset","getStatus","hasPreviousData","parseFloat","updateSpecificPreviewTitle","renderSpecificOrderPreview","renderDraggedAnnotation","NoteManager","httpFileSystemManager","httpManager","notes","cacheTimestamps","cacheExpiration","requestQueue","noteCounts","bulkNoteData","bulkDataTimestamp","performanceMetrics","requestCount","bulkRequestCount","cacheHits","networkTime","addPlantNote","noteData","clearCache","noteId","addImageNote","getPlantNotes","cacheKey","isBulkDataExpired","plantNotes","isCacheExpired","emptyResult","setCache","fetchError","getImageNotes","imageNotes","updateNote","updates","deleteNote","getNote","searchNotes","filters","searchParams","URLSearchParams","append","noteType","author","searchUrl","getStats","invalidateCache","plantKey","imageKey","getCacheStats","cacheSize","cacheKeys","validateNoteData","trim","tags","isArray","formatNoteForDisplay","note","formattedTimestamp","toLocaleString","formattedLastModified","shortContent","tagsText","cleanupTimer","clearInterval","startAutoCleanup","setInterval","cleanupExpiredCache","withRequestDeduplication","requestFn","requestPromise","getNoteCount","countKey","loadNotesAsync","preloadNotes","promises","allSettled","getAllNotesInBulk","statistics","updateIndividualCacheFromBulk","plantCount","getQuickNoteStats","plantNotesCount","imageNotesCount","getPerformanceMetrics","hasBulkData","bulkDataAge","averageRequestTime","resetPerformanceMetrics","refreshBulkData","expiredKeys","NoteUI","noteManager","currentNote","isEditMode","initializeUI","createNoteModal","createNoteListModal","setupEventListeners","createNoteButtons","injectNoteStyles","updateAllPlantNoteBadges","modal","createPlantNoteButton","createImageNoteButton","toolbarSection","createFallbackPlantNoteContainer","existingBtn","noteContainer","noteBtn","annotationControls","createFallbackImageNoteContainer","setupModalEventListeners","setupButtonEventListeners","setupInputEventListeners","noteModalClose","closeNoteModal","noteCancelBtn","noteSaveBtn","saveNote","noteListModalClose","closeNoteListModal","addNoteBtn","showNoteModal","noteSearchBtn","noteSearch","plantNoteBtn","showPlantNotes","imageNoteBtn","showImageNotes","noteTitle","updateCharCounter","noteContent","showUserError","loadNoteList","globalAppState","fallbackPlantId","fallbackImageId","effectivePlantId","effectiveImageId","listContainer","renderNoteList","html","renderNoteItems","bindNoteActionEvents","noteScope","formattedNote","scopeIndicator","escapeHtml","getNoteTypeText","tag","editNote","styleId","backwardPropagationGroup","isNewImageNote","checkbox","checked","titleInput","focus","getLaterDatedImages","laterImages","applyNoteToMultipleImages","targetImages","results","failed","backwardPropagationCheckbox","enableBackwardPropagation","propagationResults","listModal","updatePlantNoteBadge","updatePlantNoteButton","directUpdateThumbnailBadge","updateImageNoteButton","confirm","errorMessage","typeFilter","matchesQuery","matchesType","inputId","counterId","maxLength","input","counter","currentLength","setCurrentPlant","plantNoteContainer","setCurrentImage","refreshThumbnailNoteBadge","imageNoteContainer","shouldShow","contains","plantNoteCountElement","bulkStats","actualCount","validationError","plantError","imageNoteCountElement","loadImageNoteCount","totalNotes","updateBadgeWithStats","validationResults","actualTotal","totalImageNotes","p","viewError","imagePromises","badge","badgeText","visibility","opacity","updateAllPlantNoteBadgesFromBulk","plantItems","quickStats","metrics","general","observation","div","noteCount","fallbackError","element","AnnotationManager","replace","calculateTotalAnnotations","getSinglePlantAnnotations","getSingleImageAnnotations","getQuickAnnotationStats","imageAnnotationCount","BulkLoadingPerformanceMonitor","loadingStartTime","loadingEndTime","totalLoadingTime","plantsLoaded","annotationsLoaded","notesLoaded","networkRequests","bulkRequests","individualRequests","totalDataTransferred","cacheMisses","fallbacksUsed","timeToFirstInteraction","timeToFullyLoaded","isMonitoring","checkpoints","startMonitoring","addCheckpoint","details","checkpoint","relativeTime","recordDataLoaded","dataSize","recordNetworkRequest","isBulk","recordCacheHit","recordCacheMiss","recordError","recordFallback","totalFallbacks","endMonitoring","report","generatePerformanceReport","cacheHitRate","bulkRequestRatio","dataLoaded","dataTransferred","networkPerformance","totalRequests","averageRequestSize","cachePerformance","hits","misses","hitRate","reliability","errorDetails","timeline","performanceGrade","calculatePerformanceGrade","optimizationSuggestions","generateOptimizationSuggestions","score","requestEfficiency","suggestions","category","suggestion","priority","impact","exportMetrics","RealTimeSyncManager","annotationStorageManager","isEnabled","isSyncing","syncQueue","OPERATION_TYPES","ADD_KEYPOINT","MOVE_KEYPOINT","DELETE_KEYPOINT","EDIT_DIRECTION","CUSTOM_ANNOTATION_CREATE","CUSTOM_ANNOTATION_UPDATE","CUSTOM_ANNOTATION_DELETE","CUSTOM_TYPE_CREATE","eventListeners","setEnabled","Boolean","emit","isSyncInProgress","on","listener","off","listeners","getFutureImages","currentDate","futureImages","syncKeypointAddition","synced","syncedCount","addKeypointToImage","syncKeypointMovement","moveKeypointInImage","syncKeypointDeletion","payload","deleteKeypointFromImage","existingKeypoint","orderMatch","typeMatch","customTypeMatch","newKeypoint","matchingIndex","removedKeypoint","queueSyncOperation","processSyncQueue","queueLength","executeOperation","syncData","syncDirectionEdit","syncCustomAnnotationCreate","syncCustomAnnotationUpdate","syncCustomAnnotationDelete","syncCustomTypeCreate","editDirectionInImage","addCustomAnnotationToImage","updateCustomAnnotationInImage","deleteCustomAnnotationFromImage","existingCustomAnnotation","assign","removedAnnotation","getSyncStats","clearSyncQueue","CustomAnnotationToolbarController","settingsController","updateDisplay","customModeIndicator","customTypeIndicator","toolbarCustomTypeSelect","switchCustomModeBtn","normalModeBtn","customSettingsBtn","onCustomTypeSelected","selectedTypeId","showModeChangeNotification","setNormalMode","openSettings","refreshCustomTypeSelector","getAllCustomTypes","currentSelection","option","updateButtonStates","switchToCustomMode","switchToNormalMode","updateModeIndicators","currentMode","selectedType","typeBadge","hasCustomTypes","disabled","hideNoTypesMessage","showNoTypesMessage","parentNode","typeIcon","animation","forceRefresh","getSelectedCustomTypeId","setSelectedCustomType","getStatusSummary","totalTypes","totalCustomTypes","CustomAnnotationSettingsController","currentEditingTypeId","currentTab","closeBtn","tabButtons","tabContents","customTypesList","noCustomTypesMessage","addTypeBtn","typeFormSection","typeForm","formTitle","formSubmitText","cancelFormBtn","typeNameInput","typeIdInput","typeTypeSelect","typeColorInput","typeColorTextInput","typeDescriptionInput","typeCategoryInput","typeDefaultAngleGroup","typeDefaultAngleInput","typeIsDirectionalInput","associateTypeSelect","currentModeValue","currentTypeValue","switchToNormalBtn","selectCustomTypeSelect","switchToCustomBtn","exportTypesCount","exportAnnotationsCount","exportCustomDataBtn","selectImportFileBtn","importFileInput","importFileInfo","importFileName","importExecuteBtn","importResults","importResultsContent","hide","tabName","tab","switchTab","showAddTypeForm","hideTypeForm","handleFormSubmit","test","generateIdFromName","updateAngleVisibility","updateModeDisplay","exportCustomData","handleFileSelection","executeImport","refreshAllData","refreshTabData","refreshCustomTypesList","updateExportStats","typesList","createTypeItemHTML","bindTypeActionButtons","populateAssociateOptions","currentId","types","opt","typeLabel","action","editCustomType","deleteCustomType","formData","FormData","typeData","rawAngle","Number","isNaN","safeUpdate","updateCustomType","createCustomType","prefix","builtin","builtinIdx","isPoint","updateCurrentImageStats","currentImageStatsDiv","exportSection","statsHtml","orderRange","gaps","typeStats","byType","info","typeColor","files","importData","customAnnotations","promise","lineno","colno","app","loadingScreen","mainApp","errorModal","noteUI","performanceMonitor","currentDataset","customAnnotationToolbarController","customAnnotationSettingsController","hasBackendAccess","currentDatasetPath","navigation","isNavigating","lastNavigationTime","throttleDelay","initializeCustomAnnotationControllers","initializeApp","updateFullscreenLoading","hideError","unsupportedAPIs","check","indexedDB","Worker","IntersectionObserver","api","missingAPIs","checkBrowserCompatibility","selectDatasetBtn","handleSelectDataset","errorCloseBtn","resetZoomBtn","fitScreenBtn","renderImageThumbnails","handleViewAngleSelect","undoBtn","redoBtn","clearAllBtn","handleClearAllAnnotations","siftMatchBtn","handleSiftMatch","togglePreviewBtn","autoDirectionModeSelector","handleAutoDirectionModeChange","autoOrderBtn","handleAutoOrderClick","zoomLockCheckbox","zoomLockValue","handleZoomLockChange","handleZoomLockValueChange","autoMoveCheckbox","handleAutoMoveChange","realTimeChangeCheckbox","handleRealTimeChangeChange","skipModalClose","skipCancelBtn","skipConfirmBtn","hideSkipPlantModal","confirmSkipPlant","skipModal","statusFilter","handleStatusFilterChange","plantSearch","handlePlantSearchInput","saveAnnotationBtn","handleSaveAnnotation","saveAnnotationCancelBtn","hideSaveAnnotationModal","saveAnnotationConfirmBtn","selectedMode","directionSaveMode","saveResult","updateAnnotationStatusDisplay","updateProgressStats","affectedImages","performSaveAnnotation","completePlantBtn","handleCompletePlant","exportDataBtn","handleExportData","deletePlantAnnotationsBtn","handleDeletePlantAnnotations","deleteModalClose","deleteCancelBtn","deleteConfirmBtn","deleteConfirmationCheckbox","hideDeletePlantAnnotationsModal","confirmDeletePlantAnnotations","handleDeleteConfirmationChange","deleteModal","handleKeyboardShortcuts","handlePlantUpdated","saveAnnotationModal","unskipModalClose","unskipCancelBtn","unskipConfirmBtn","hideUnskipPlantModal","confirmUnskipPlant","uncompleteModalClose","uncompleteCancelBtn","uncompleteConfirmBtn","hideUncompletePlantModal","confirmUncompletePlant","unskipModal","uncompleteModal","bindEventListeners","loadingTexts","loadingP","simulateLoading","autoConnectDataset","hideFullscreenLoading","selectBtn","datasetInfo","validateDatasetStructure","renderPlantList","plantDirectories","firstPlant","progressStatsElement","hideProgressStats","progressStats","completedImagesCount","totalImagesCount","completionPercentage","completedPlantsCount","totalPlantsCount","progressBarFill","skippedText","background","plantItem","createPlantListItem","bulkError","statusIcon","getStatusIcon","imageCountText","viewAnglesText","selectedViewText","isSkipped","skipReasonHtml","stateButtonsHtml","getStatusText","handlePlantSelect","arguments","directError","initializeEmptyWorkspace","clearWorkspaceState","viewAngleSection","updateDeletePlantAnnotationsButtonState","updateCompletePlantButtonState","hideAnnotationStatusDisplay","titleElement","updateCurrentPlantTitle","selectedPlantId","selectedItem","updatePlantItemSelection","allImageIds","flat","viewAngleInfo","availableViews","buttonText","selectedButton","showViewAngleSelection","createImageThumbnail","isFirst","annotationBadge","thumbnailElement","imgElement","loadingElement","loadThumbnailImage","imageToSave","isFirstImageForPlant","selectedImageId","thumb","selectedThumb","thumbnailRect","thumbnailOffsetTop","scrollTop","offsetTop","containerHeight","targetScrollTop","scrollTo","behavior","scrollToThumbnail","updateImageThumbnailSelection","shouldPreserveView","getAutoMoveSettings","syncAnnotationsFromKeypoints","statusSection","annotationSource","manualAdjustmentNotice","savedAnnotations","showSaveAnnotationModal","plantIdElement","showUncompletePlantModal","confirmMessage","newItem","replaceChild","nextPlant","modalHTML","existingModal","insertAdjacentHTML","statsContent","calculateExportStats","getDirectExportData","generateExportPreview","finalExportData","skippedPlants","performExport","showExportOptionsModal","inferPlantIdFromImageId","statusTextElement","imageCountElement","viewAnglesElement","plantViewInfo","selectedViewElement","isBuiltinSelected","selectedCustomType","progressText","previewContainer","previewHTML","skippedCount","generateSimplePreviewHTML","togglePlantPreview","toggle","renderPreviewCanvases","toggleViewPreview","showImageDetail","getImageDataFromId","maxWidth","maxHeight","drawWidth","drawHeight","renderImageDetail","closeImageDetailModal","showImageDetailModal","isElementVisible","renderAnnotationPreview","rendered","targetWidth","targetHeight","devicePixelRatio","imgAspect","previousIndex","autoMode","nextIndex","nextImage","pauseHandler","reasonTextarea","searchInput","applyPlantsFilter","searchQuery","filteredPlants","subtitle","loadingSubtitle","loadingDetails","fullscreenLoading","connectionError","ConnectionError","originalError","serverUrl","loadingTasks","loadingResults","bulkAnnotations","bulkNotes","loadedComponents","loadedMessage","performanceReport","lastPerformanceReport","gradeMsg","detailMessage","retryButton","onclick","showFullscreenLoading","retryError","addRetryButton","showConnectionError","toggleBranchPointPreview","showSkipPlantModal","plantNameElement","handleUnskipPlant","skipReasonElement","newStatusElement","showUnskipPlantModal","super","disableScopeOption","handleDeletionScopeChange","selectedScope","confirmCheckbox","confirmButton","scope","confirmText","statsLoading","futureImagesInfo","futureImagesCount","plantAllOption","getFutureImagesForClearing","futureCount","currentFutureOption","currentOnlyOption","setupDeletionScopeOptions","annotationFiles","totalAnnotationPoints","relatedFiles","totalFiles","showDeletePlantAnnotationsModal","deletionScope","originalText","executeFullPlantDeletion","deletedCount","clearAnnotationsForImage","totalFilesDeleted","totalFilesProcessed","annotationFilesDeleted","relatedFilesDeleted","backupPath","executeSpreadingDeletion","executeCurrentImageDeletion","successMessage","createSuccessMessage","handlePostDeletionUpdates","completeButton","deleteButton","siftBtn"],"mappings":"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"}